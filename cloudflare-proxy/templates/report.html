<!--
================================================================================
MVP SURFACE - Focus Group Critical
================================================================================
Page: SharedReport.html
Purpose: Shareable analytics dashboard for stakeholders and sponsors
Status: LOCKED for MVP v1.0

SCHEMA CONTRACT: /schemas/shared-analytics.schema.json (v1.1 frozen)

═══════════════════════════════════════════════════════════════════════════════
READS FROM SHAREDANALYTICS SCHEMA (via api_getSharedAnalytics):
═══════════════════════════════════════════════════════════════════════════════
  Root (MVP Required):
    - lastUpdatedISO           → Last updated timestamp display
    - summary                  → Key metrics cards
    - surfaces[]               → Surface performance table

  Root (MVP Optional):
    - sponsors[]               → Sponsor performance table
    - events[]                 → Event performance table (if present)
    - topSponsors[]            → Top Sponsors highlight card

  Summary Fields (MVP Required):
    - summary.totalImpressions → "Total Impressions" metric card
    - summary.totalClicks      → "Total Clicks" metric card
    - summary.totalQrScans     → "QR Scans" metric card
    - summary.totalSignups     → "Signups" metric card
    - summary.uniqueEvents     → "Active Events" metric card
    - summary.uniqueSponsors   → "Active Sponsors" metric card

  SurfaceMetrics[] (MVP Required):
    - surface.id               → Surface identifier
    - surface.label            → Display name
    - surface.impressions      → Table column
    - surface.clicks           → Table column
    - surface.qrScans          → Table column
    - surface.engagementRate   → Badge (derived if missing)

  SponsorMetrics[] (MVP Optional):
    - sponsor.id               → Row key
    - sponsor.name             → Display name
    - sponsor.impressions      → Table column
    - sponsor.clicks           → Table column
    - sponsor.ctr              → CTR badge

  EventMetrics[] (MVP Optional):
    - event.id                 → Row key
    - event.name               → Display name + rank badge
    - event.impressions        → Table column + Top callout
    - event.clicks             → Table column
    - event.signupsCount       → Signups column (from Form/Sheet)
    - event.ctr                → CTR badge + Top callout

═══════════════════════════════════════════════════════════════════════════════
SECTION GATES (schema-backed visibility):
═══════════════════════════════════════════════════════════════════════════════
  Sponsor Funnel:     Always shown (summary is required) → renderSponsorFunnelCard()
                      Shows empty state if no data (Story 11)
  Metrics Grid:       Always shown (summary is required)
  Surface Table:      Always shown (surfaces[] is required)
  Sponsor Table:      if (sponsors?.length) → renderSponsorPerformance()
  Event Table:        if (events?.length) → renderEventPerformance()
  Top Callouts:       if (events?.length || sponsors?.length) → renderTopCallouts()
  Top Sponsors Card:  if (topSponsors?.length) → renderTopSponsorsCard()

  NO freelancing: JS only accesses fields defined in shared-analytics.schema.json

API ENDPOINTS (3 MVP canonical - Story 6):
  - api_getSharedAnalytics({ brandId }) → SharedAnalytics
  - api_getSponsorAnalytics({ brandId, sponsorId, eventId? }) → SharedAnalytics (scoped)
  - api_getSponsorReportQr({ sponsorId, brandId? }) → { url, qrB64, verified }

V2-ONLY ENDPOINTS (not called - features removed from MVP surface):
  - api_getPortfolioAnalyticsV2 - Multi-event portfolio mode
  - api_exportSharedReport - Export feature

DO NOT modify contracts without updating:
  - /schemas/shared-analytics.schema.json (source of truth)
  - NUSDK.html (API client)
================================================================================
-->
<!DOCTYPE html>
<!--
  Template: Report
  Bundled: 2025-12-08T18:54:03.592Z
  Hash: 1def3a1b
  Source: GAS templates (src/mvp/)
  Generator: scripts/bundle-worker-templates.js

  Variables (replaced at runtime):
  - <?= appTitle ?> - Page title
  - <?= brandId ?> - Brand identifier
  - <?= scope ?> - Scope (events, leagues, etc.)
  - <?= execUrl ?> - API endpoint URL
-->

<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> · Shared Analytics</title>
  <header class="site-header">
  <div class="header-content">
    <div class="logo">
      <img src="" alt="" class="header-logo" id="headerLogo">
    </div>
    <div class="header-title">
      <h1 id="headerTitle"></h1>
      <span class="build-info" id="headerBuild"></span>
    </div>
  </div>
</header>

  <script>
// Initialize header with template-injected values
// This script must be included in the main template, not via include()
// so that the template tags below are properly evaluated
(function() {
  const appTitle = '<?= appTitle ?>';
  const buildId = '<?= ZEB.BUILD_ID ?>';
  const brandId = '<?= brand?.id || "root" ?>';
  const logoUrl = '<?= brand?.logoUrl || "" ?>';

  // Populate header elements
  const titleEl = document.getElementById('headerTitle');
  const buildEl = document.getElementById('headerBuild');
  const logoEl = document.getElementById('headerLogo');

  if (titleEl) titleEl.textContent = appTitle;
  // Display both build ID and brand ID for canonical status reference
  if (buildEl) buildEl.textContent = 'Build: ' + buildId + ' · Brand: ' + brandId;
  if (logoEl) {
    if (logoUrl && logoUrl.startsWith('http')) {
      // Only set logo if we have a valid HTTP/HTTPS URL
      logoEl.src = logoUrl;
      logoEl.alt = appTitle;
      logoEl.style.display = '';
    } else {
      // Hide logo if no valid URL is provided
      logoEl.style.display = 'none';
    }
  }
})();
</script>

  <!--
═══════════════════════════════════════════════════════════════════════════════
NUSDK v2.0 - Fetch-Based NU SDK for Google Apps Script
═══════════════════════════════════════════════════════════════════════════════

RESPONSIBILITY: This file provides the RPC client for frontend→backend calls ONLY.
It does NOT implement business logic - that belongs in Code.gs.

WINDOW ADDITIONS:
- window.NU        - Main SDK object
- window.__NU_LOGS__ - Rolling log buffer for diagnostics
- window.NU_DIAG   - Diagnostic helper for Test.html

TRANSPORT: Fetch-based (/api/<path>) with google.script.run fallback

LOGGING LEVELS:
- Staging: 'debug' (all logs)
- Production: 'error' (errors only)

RESPONSE ENVELOPE CONTRACT (all API endpoints follow this pattern):

SUCCESS:
{
  ok: true,
  etag?: string,           // Optional cache tag for SWR
  notModified?: boolean,   // True if content unchanged (304 equivalent)
  value: { ... }           // Endpoint-specific payload per ApiSchemas.gs
}

ERROR:
{
  ok: false,
  code: "BAD_INPUT" | "NOT_FOUND" | "RATE_LIMITED" | "INTERNAL" | "UNAUTHORIZED",
  message: "Human-readable error description"
}

USAGE:
  const res = await NU.rpc('events/list', { brandId });
  if (!res.ok) {
    console.error(res.code, res.message);
    return;
  }
  const { events } = res.value;

See ApiSchemas.gs for full endpoint inventory and schemas.
═══════════════════════════════════════════════════════════════════════════════
-->
<script>
// =============================================================================
// Rolling Log Buffer - Global diagnostic storage
// =============================================================================
window.__NU_LOGS__ = [];

// =============================================================================
// NU SDK - Main SDK Object
// =============================================================================
window.NU = {
  /**
   * SDK Version
   */
  VERSION: '2.0.0',

  /**
   * Configuration
   * @private
   */
  _config: {
    logLevel: 'debug', // 'debug' | 'error' | 'none' - auto-detected from environment
    maxLogs: 100,      // Max entries in rolling log buffer
    apiBase: '/api',   // Base path for API endpoints
    dedupeWindow: 5000 // Error deduplication window (ms)
  },

  /**
   * Log level constants
   * @private
   */
  _LOG_LEVELS: Object.freeze({ none: 0, error: 1, debug: 2 }),

  /**
   * Pending requests for flush tracking
   * @private
   */
  _pending: [],

  /**
   * Error deduplication tracking
   * @private
   */
  _errorDedupeMap: new Map(),

  /**
   * Initialize SDK - auto-detect environment and set log level
   * @private
   */
  _init() {
    // Auto-detect environment from hostname
    // SECURITY: Use exact match or suffix match to prevent subdomain spoofing
    // e.g., "fake-eventangle.com" should NOT match as production
    const hostname = window.location?.hostname || '';

    // Helper for safe domain suffix check
    const isDomain = (host, domain) =>
      host === domain || host.endsWith('.' + domain);

    const isStaging = isDomain(hostname, 'stg.eventangle.com') ||
                      hostname === 'localhost' ||
                      hostname === '127.0.0.1';
    const isProduction = isDomain(hostname, 'eventangle.com') && !isStaging;

    // Set log level based on environment
    if (isProduction) {
      NU._config.logLevel = 'error';
    } else {
      NU._config.logLevel = 'debug';
    }

    NU._log('debug', 'init', {
      version: NU.VERSION,
      logLevel: NU._config.logLevel,
      hostname,
      isStaging,
      isProduction
    });
  },

  /**
   * Internal logging with rolling buffer
   * Logs to both __NU_LOGS__ buffer and console (based on log level)
   *
   * @param {string} level - 'debug' | 'error'
   * @param {string} type - Log type: 'start' | 'ok' | 'network_fail' | 'http_fail' | 'json_fail' | 'error'
   * @param {object} data - Log data
   * @private
   */
  _log(level, type, data = {}) {
    const entry = {
      timestamp: new Date().toISOString(),
      level,
      type,
      ...data
    };

    // Add timing if startTime provided
    if (data.startTime) {
      entry.durationMs = Date.now() - data.startTime;
      delete entry.startTime;
    }

    // Add to rolling buffer
    window.__NU_LOGS__.push(entry);
    if (window.__NU_LOGS__.length > NU._config.maxLogs) {
      window.__NU_LOGS__.shift();
    }

    // Console output based on log level
    const currentLevel = NU._LOG_LEVELS[NU._config.logLevel] || 0;
    const entryLevel = NU._LOG_LEVELS[level] || 0;

    if (entryLevel <= currentLevel) {
      const prefix = '[NUSDK]';
      const logData = { ...entry };
      delete logData.timestamp;
      delete logData.level;

      if (level === 'error') {
        console.error(prefix, type, JSON.stringify(logData));
      } else {
        console.debug(prefix, type, JSON.stringify(logData));
      }
    }
  },

  /**
   * Check for duplicate error (deduplication within time window)
   * @private
   */
  _isDuplicateError(path, code) {
    const key = `${path}:${code}`;
    const now = Date.now();
    const lastTime = NU._errorDedupeMap.get(key);

    if (lastTime && (now - lastTime) < NU._config.dedupeWindow) {
      return true;
    }

    NU._errorDedupeMap.set(key, now);

    // Clean old entries periodically
    if (NU._errorDedupeMap.size > 100) {
      for (const [k, t] of NU._errorDedupeMap.entries()) {
        if (now - t > NU._config.dedupeWindow) {
          NU._errorDedupeMap.delete(k);
        }
      }
    }

    return false;
  },

  /**
   * Make an RPC call to the backend
   *
   * Uses fetch('/api/<path>') when available (Cloudflare Worker proxy),
   * falls back to google.script.run for direct GAS serving.
   *
   * @param {string} path - API path (e.g., 'events/list', 'getPublicBundle')
   * @param {object} payload - Request parameters
   * @returns {Promise<{ok: boolean, value?: any, code?: string, message?: string}>}
   */
  async rpc(path, payload = {}) {
    const startTime = Date.now();
    const requestId = Math.random().toString(36).slice(2, 10);

    // Log request start
    NU._log('debug', 'start', { path, requestId, payloadKeys: Object.keys(payload) });

    // Track pending request
    const pendingEntry = { path, requestId, startTime };
    NU._pending.push(pendingEntry);

    try {
      // Build API URL - support both path formats:
      // - 'events/list' -> '/api/events/list'
      // - 'api_getPublicBundle' -> '/api/rpc' with method in body (legacy)
      const isLegacyMethod = path.startsWith('api_');
      const url = isLegacyMethod
        ? `${NU._config.apiBase}/rpc`
        : `${NU._config.apiBase}/${path}`;

      const body = isLegacyMethod
        ? JSON.stringify({ method: path, payload })
        : JSON.stringify(payload);

      // Make fetch request
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-Request-Id': requestId
        },
        body,
        credentials: 'same-origin'
      });

      // Handle HTTP errors
      if (!response.ok) {
        let errorData;
        try {
          errorData = await response.json();
        } catch {
          errorData = { ok: false, code: 'INTERNAL', message: `HTTP ${response.status}` };
        }

        NU._log('error', 'http_fail', {
          path,
          requestId,
          status: response.status,
          code: errorData.code,
          startTime
        });

        return errorData;
      }

      // Parse JSON response
      let data;
      try {
        data = await response.json();
      } catch (jsonError) {
        NU._log('error', 'json_fail', {
          path,
          requestId,
          error: jsonError.message,
          startTime
        });
        return { ok: false, code: 'INTERNAL', message: 'Invalid JSON response' };
      }

      // Log success with timing
      NU._log('debug', 'ok', {
        path,
        requestId,
        hasValue: !!data?.value,
        startTime
      });

      return data;

    } catch (fetchError) {
      // Network error - try google.script.run fallback
      NU._log('debug', 'network_fail', {
        path,
        requestId,
        error: fetchError.message,
        fallback: 'google.script.run',
        startTime: startTime
      });

      // For legacy methods, try google.script.run
      if (path.startsWith('api_') || path.includes('/')) {
        return NU._fallbackToGAS(path, payload, requestId, startTime);
      }

      // Non-legacy path with no GAS fallback
      NU._log('error', 'network_fail', {
        path,
        requestId,
        error: fetchError.message,
        startTime
      });
      return {
        ok: false,
        code: 'NETWORK_ERROR',
        message: 'Cannot connect to backend. Check your connection.'
      };

    } finally {
      // Remove from pending
      const idx = NU._pending.indexOf(pendingEntry);
      if (idx > -1) NU._pending.splice(idx, 1);
    }
  },

  /**
   * Fallback to google.script.run for direct GAS serving
   * @private
   */
  _fallbackToGAS(path, payload, requestId, startTime) {
    return new Promise((resolve) => {
      // Check if google.script.run is available
      if (!window.google?.script?.run) {
        NU._log('error', 'network_fail', {
          path,
          requestId,
          error: 'Neither fetch nor google.script.run available',
          startTime
        });
        resolve({
          ok: false,
          code: 'NETWORK_ERROR',
          message: 'Cannot connect to backend. Check your connection.'
        });
        return;
      }

      // Convert path to method name for GAS
      // 'events/list' -> 'api_list' (if needed)
      // 'api_getPublicBundle' -> 'api_getPublicBundle' (as-is)
      const method = path.startsWith('api_') ? path : `api_${path.replace('/', '_')}`;

      try {
        google.script.run
          .withSuccessHandler(res => {
            NU._log('debug', 'ok', {
              path,
              requestId,
              transport: 'google.script.run',
              hasValue: !!res?.value,
              startTime
            });
            resolve(res);
          })
          .withFailureHandler(err => {
            NU._log('error', 'error', {
              path,
              requestId,
              transport: 'google.script.run',
              error: String(err),
              startTime
            });
            resolve({ ok: false, code: 'INTERNAL', message: String(err) });
          })
          [method](payload);
      } catch (e) {
        NU._log('error', 'error', {
          path,
          requestId,
          error: e.message,
          startTime
        });
        resolve({ ok: false, code: 'INTERNAL', message: String(e) });
      }
    });
  },

  /**
   * Flush all pending requests
   * Waits for all in-flight requests to complete
   *
   * @returns {Promise<void>}
   */
  async flush() {
    if (NU._pending.length === 0) {
      NU._log('debug', 'flush', { message: 'No pending requests' });
      return;
    }

    NU._log('debug', 'flush', { pendingCount: NU._pending.length });

    // Wait for all pending requests (with timeout)
    const timeout = 5000;
    const startTime = Date.now();

    while (NU._pending.length > 0 && (Date.now() - startTime) < timeout) {
      await new Promise(r => setTimeout(r, 100));
    }

    if (NU._pending.length > 0) {
      NU._log('error', 'flush', {
        message: 'Timeout waiting for pending requests',
        remaining: NU._pending.length
      });
    } else {
      NU._log('debug', 'flush', { message: 'All requests completed' });
    }
  },

  /**
   * Stale-while-revalidate pattern for cached data
   * Returns cached data immediately, then fetches fresh data
   *
   * @param {string} path - API path
   * @param {object} payload - Request parameters
   * @param {object} options - { staleMs, onUpdate }
   */
  swr(path, payload, { staleMs = 120000, onUpdate } = {}) {
    const key = `swr:${path}:${JSON.stringify(payload || {})}`;
    const cached = JSON.parse(localStorage.getItem(key) || '{}');

    if (cached.data) {
      setTimeout(() => onUpdate && onUpdate(cached.data), 0);
    }

    NU.rpc(path, { ...(payload || {}), ifNoneMatch: cached.etag }).then(res => {
      if (res?.notModified) return;
      if (res?.ok && res.value) {
        localStorage.setItem(key, JSON.stringify({
          etag: res.etag,
          data: res.value,
          t: Date.now()
        }));
        onUpdate && onUpdate(res.value);
      }
    });
  },

  /**
   * Escapes HTML special characters to prevent XSS
   *
   * @param {string} s - String to escape
   * @returns {string} HTML-safe string
   */
  esc(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[m]));
  },

  /**
   * Safe RPC wrapper with graceful error handling for UI display
   * Normalizes all error types to a consistent format for StateRenderer
   *
   * @param {string} path - API path
   * @param {object} payload - Request parameters
   * @param {object} options - { onError, silent }
   * @returns {Promise<{ok: boolean, value?: any, code?: string, message?: string}>}
   */
  async safeRpc(path, payload, options = {}) {
    const { onError, silent = false } = options;

    try {
      const res = await NU.rpc(path, payload);

      // Handle backend error responses (ok: false)
      if (!res.ok) {
        const errorInfo = {
          ok: false,
          code: res.code || 'UNKNOWN',
          message: res.message || 'An unexpected error occurred',
          corrId: res.corrId
        };

        // Log error (with deduplication)
        if (!silent && !NU._isDuplicateError(path, errorInfo.code)) {
          NU._log('error', 'error', {
            path,
            code: errorInfo.code,
            message: errorInfo.message,
            corrId: errorInfo.corrId
          });
        }

        if (onError) onError(errorInfo);
        return errorInfo;
      }

      return res;

    } catch (e) {
      // Handle network/runtime errors
      const errorInfo = {
        ok: false,
        code: 'NETWORK_ERROR',
        message: 'We\'re having trouble connecting. Please check your connection and try again.'
      };

      if (!silent && !NU._isDuplicateError(path, 'NETWORK_ERROR')) {
        NU._log('error', 'network_fail', {
          path,
          error: e?.message || errorInfo.message
        });
      }

      if (onError) onError(errorInfo);
      return errorInfo;
    }
  },

  /**
   * Fire-and-forget analytics logging that NEVER throws or blocks UI
   *
   * @param {string} path - Analytics API path
   * @param {object} payload - Analytics data
   * @returns {void}
   */
  safeAnalytics(path, payload) {
    // Fire and forget - don't await, don't block
    (async () => {
      try {
        const url = path.startsWith('api_')
          ? `${NU._config.apiBase}/rpc`
          : `${NU._config.apiBase}/${path}`;

        const body = path.startsWith('api_')
          ? JSON.stringify({ method: path, payload })
          : JSON.stringify(payload);

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body,
          credentials: 'same-origin'
        });

        if (!response.ok) {
          NU._log('debug', 'analytics_fail', { path, status: response.status });
        }

      } catch (fetchError) {
        // Fallback to google.script.run
        try {
          if (!window.google?.script?.run) {
            NU._log('debug', 'analytics_skip', { path, reason: 'no backend' });
            return;
          }

          const method = path.startsWith('api_') ? path : `api_${path.replace('/', '_')}`;
          google.script.run
            .withSuccessHandler(() => {})
            .withFailureHandler(() => {})
            [method](payload);

        } catch {
          // Silently ignore analytics failures
        }
      }
    })();
  },

  /**
   * Safe analytics batch logger
   *
   * @param {Array} items - Array of analytics items
   */
  safeLogEvents(items) {
    if (!items?.length) return;
    NU.safeAnalytics('api_logEvents', { items });
  },

  /**
   * Safe external click logger
   *
   * @param {object} params - { eventId, sponsorId, surface, linkType?, ua? }
   */
  safeLogClick(params) {
    NU.safeAnalytics('api_logExternalClick', {
      ...params,
      ua: params.ua || navigator.userAgent
    });
  },

  /**
   * Set log level manually
   *
   * @param {'debug' | 'error' | 'none'} level - Log level
   */
  setLogLevel(level) {
    if (NU._LOG_LEVELS.hasOwnProperty(level)) {
      NU._config.logLevel = level;
      NU._log('debug', 'config', { logLevel: level });
    }
  },

  /**
   * Get current configuration (for diagnostics)
   *
   * @returns {object} Current SDK configuration
   */
  getConfig() {
    return { ...NU._config, version: NU.VERSION };
  }
};

// =============================================================================
// NU_DIAG - Diagnostic Helper for Test.html
// =============================================================================
window.NU_DIAG = {
  /**
   * Get all logs from the rolling buffer
   *
   * @param {object} options - { type?, level?, limit? }
   * @returns {Array} Filtered log entries
   */
  getLogs(options = {}) {
    const { type, level, limit = 100 } = options;
    let logs = [...window.__NU_LOGS__];

    if (type) {
      logs = logs.filter(l => l.type === type);
    }
    if (level) {
      logs = logs.filter(l => l.level === level);
    }

    return logs.slice(-limit);
  },

  /**
   * Clear all logs from the buffer
   */
  clearLogs() {
    window.__NU_LOGS__.length = 0;
    console.debug('[NU_DIAG] Logs cleared');
  },

  /**
   * Get statistics about logged requests
   *
   * @returns {object} Statistics object
   */
  getStats() {
    const logs = window.__NU_LOGS__;
    const stats = {
      totalLogs: logs.length,
      byType: {},
      byLevel: {},
      errors: [],
      avgDurationMs: 0
    };

    let totalDuration = 0;
    let durationCount = 0;

    logs.forEach(log => {
      // Count by type
      stats.byType[log.type] = (stats.byType[log.type] || 0) + 1;

      // Count by level
      stats.byLevel[log.level] = (stats.byLevel[log.level] || 0) + 1;

      // Track errors
      if (log.level === 'error') {
        stats.errors.push({
          timestamp: log.timestamp,
          type: log.type,
          path: log.path,
          code: log.code,
          error: log.error
        });
      }

      // Track durations
      if (log.durationMs) {
        totalDuration += log.durationMs;
        durationCount++;
      }
    });

    stats.avgDurationMs = durationCount > 0
      ? Math.round(totalDuration / durationCount)
      : 0;

    return stats;
  },

  /**
   * Test an RPC call and return detailed diagnostics
   *
   * @param {string} path - API path to test
   * @param {object} payload - Request payload
   * @returns {Promise<object>} Test result with timing and diagnostics
   */
  async testRpc(path, payload = {}) {
    const startTime = Date.now();
    const logsBefore = window.__NU_LOGS__.length;

    console.group(`[NU_DIAG] Testing RPC: ${path}`);
    console.debug('Payload:', payload);

    try {
      const result = await NU.rpc(path, payload);
      const endTime = Date.now();
      const newLogs = window.__NU_LOGS__.slice(logsBefore);

      const diagnostic = {
        success: result.ok,
        path,
        payload,
        result,
        durationMs: endTime - startTime,
        logs: newLogs,
        timestamp: new Date().toISOString()
      };

      console.debug('Result:', result);
      console.debug('Duration:', diagnostic.durationMs, 'ms');
      console.debug('Logs generated:', newLogs.length);
      console.groupEnd();

      return diagnostic;

    } catch (error) {
      const endTime = Date.now();
      const newLogs = window.__NU_LOGS__.slice(logsBefore);

      const diagnostic = {
        success: false,
        path,
        payload,
        error: error.message,
        durationMs: endTime - startTime,
        logs: newLogs,
        timestamp: new Date().toISOString()
      };

      console.error('Error:', error);
      console.groupEnd();

      return diagnostic;
    }
  },

  /**
   * Run a quick health check
   *
   * @returns {Promise<object>} Health check results
   */
  async healthCheck() {
    console.group('[NU_DIAG] Health Check');

    const health = {
      sdk: {
        version: NU.VERSION,
        config: NU.getConfig(),
        pendingRequests: NU._pending.length
      },
      logs: {
        count: window.__NU_LOGS__.length,
        maxSize: NU._config.maxLogs
      },
      environment: {
        hostname: window.location?.hostname,
        protocol: window.location?.protocol,
        hasGoogleScript: !!window.google?.script?.run
      },
      timestamp: new Date().toISOString()
    };

    // Test connectivity with a simple ping
    try {
      const pingStart = Date.now();
      const pingResult = await NU.rpc('status', {});
      health.connectivity = {
        ok: pingResult.ok,
        durationMs: Date.now() - pingStart,
        response: pingResult.ok ? 'connected' : pingResult.code
      };
    } catch (e) {
      health.connectivity = {
        ok: false,
        error: e.message
      };
    }

    console.debug('Health:', health);
    console.groupEnd();

    return health;
  },

  /**
   * Export logs as JSON for debugging
   *
   * @returns {string} JSON string of all logs
   */
  exportLogs() {
    const exportData = {
      sdk: {
        version: NU.VERSION,
        config: NU.getConfig()
      },
      stats: NU_DIAG.getStats(),
      logs: window.__NU_LOGS__,
      exportedAt: new Date().toISOString()
    };

    return JSON.stringify(exportData, null, 2);
  },

  /**
   * Print a summary to console
   */
  printSummary() {
    const stats = NU_DIAG.getStats();
    console.group('[NU_DIAG] Summary');
    console.log('SDK Version:', NU.VERSION);
    console.log('Log Level:', NU._config.logLevel);
    console.log('Total Logs:', stats.totalLogs);
    console.log('By Type:', stats.byType);
    console.log('By Level:', stats.byLevel);
    console.log('Avg Duration:', stats.avgDurationMs, 'ms');
    if (stats.errors.length > 0) {
      console.warn('Recent Errors:', stats.errors.slice(-5));
    }
    console.groupEnd();
  }
};

// =============================================================================
// Auto-initialize SDK
// =============================================================================
NU._init();
</script>

  <style>
  /* ===== Zeventbook Design Tokens ===== */
  /*
    This file defines the design system foundation using CSS custom properties (variables).
    These tokens ensure consistent branding across Admin, Poster, Display, and Public pages.

    Usage: Include this file BEFORE Styles.html in all templates.
    Reference tokens using var(--token-name) in any CSS.
  */

  :root {
    /* ========== Color Palette ========== */

    /* Primary Brand Colors */
    --color-primary: #2563eb;           /* Main brand blue */
    --color-primary-dark: #1d4ed8;      /* Darker blue for hover states */
    --color-primary-light: #3b82f6;     /* Lighter blue for accents */
    --color-primary-bg: #eff6ff;        /* Light blue for selected backgrounds */
    --color-primary-pale: #dbeafe;      /* Very light blue for backgrounds */

    /* Semantic Colors */
    --color-success: #10b981;           /* Green for success states */
    --color-success-dark: #059669;      /* Darker green for hover */
    --color-success-light: #34d399;     /* Lighter green for accents */
    --color-success-bg: #dcfce7;        /* Light green for backgrounds */
    --color-success-pale: #d1fae5;      /* Very light green background */

    --color-danger: #ef4444;            /* Red for errors/warnings */
    --color-danger-dark: #dc2626;       /* Darker red for hover */
    --color-danger-pale: #fce7f3;       /* Light red background */

    --color-warning: #f59e0b;           /* Orange for warnings */
    --color-warning-dark: #d97706;      /* Darker orange for hover */
    --color-warning-darker: #78350f;    /* Darkest orange for text */
    --color-warning-light: #fbbf24;     /* Lighter orange for accents */
    --color-warning-bg: #fef3c7;        /* Light orange background */
    --color-warning-pale: #fed7aa;      /* Very light orange background */

    /* Neutral Palette (Slate) */
    --color-gray-50: #f8fafc;           /* Lightest gray - body background */
    --color-gray-100: #f1f5f9;          /* Light gray - hover backgrounds */
    --color-gray-200: #e2e8f0;          /* Border color, dividers */
    --color-gray-300: #cbd5e1;          /* Disabled states */
    --color-gray-400: #94a3b8;          /* Muted text */
    --color-gray-500: #64748b;          /* Secondary text */
    --color-gray-600: #475569;          /* Primary text */
    --color-gray-700: #334155;          /* Dark text */
    --color-gray-800: #1e293b;          /* Headings */
    --color-gray-900: #0f172a;          /* Darkest text */

    /* Sponsor Tier Colors */
    --color-sponsor-gold-bg: #fef3c7;   /* Gold sponsor background */
    --color-sponsor-gold-text: #92400e; /* Gold sponsor text */
    --color-sponsor-silver-bg: #e5e7eb; /* Silver sponsor background */
    --color-sponsor-silver-text: #374151; /* Silver sponsor text */
    --color-sponsor-bronze-bg: #fed7aa; /* Bronze sponsor background */
    --color-sponsor-bronze-text: #9a3412; /* Bronze sponsor text */

    /* Gradient Backgrounds (for stat cards) */
    --gradient-purple: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-blue: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    --gradient-green: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --gradient-orange: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    --gradient-red: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    --gradient-sponsor-bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);

    /* ========== Typography ========== */

    /* Font Families */
    --font-family-base: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    --font-family-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;

    /* Font Sizes */
    --font-size-xs: 0.75rem;    /* 12px */
    --font-size-sm: 0.875rem;   /* 14px */
    --font-size-base: 1rem;     /* 16px */
    --font-size-lg: 1.125rem;   /* 18px */
    --font-size-xl: 1.25rem;    /* 20px */
    --font-size-2xl: 1.5rem;    /* 24px */
    --font-size-3xl: 1.875rem;  /* 30px */
    --font-size-4xl: 2.25rem;   /* 36px */
    --font-size-5xl: 3rem;      /* 48px */

    /* Font Weights */
    --font-weight-normal: 400;
    --font-weight-medium: 500;
    --font-weight-semibold: 600;
    --font-weight-bold: 700;

    /* Line Heights */
    --line-height-tight: 1.2;
    --line-height-base: 1.6;
    --line-height-relaxed: 1.8;

    /* Letter Spacing */
    --letter-spacing-tight: -0.025em;
    --letter-spacing-normal: 0;
    --letter-spacing-wide: 0.025em;
    --letter-spacing-wider: 0.05em;

    /* ========== Spacing Scale ========== */

    --space-0: 0;
    --space-1: 0.25rem;   /* 4px */
    --space-2: 0.5rem;    /* 8px */
    --space-3: 0.75rem;   /* 12px */
    --space-4: 1rem;      /* 16px */
    --space-5: 1.25rem;   /* 20px */
    --space-6: 1.5rem;    /* 24px */
    --space-8: 2rem;      /* 32px */
    --space-10: 2.5rem;   /* 40px */
    --space-12: 3rem;     /* 48px */
    --space-16: 4rem;     /* 64px */
    --space-20: 5rem;     /* 80px */

    /* ========== Border Radius ========== */

    --radius-sm: 6px;     /* Small radius for inputs */
    --radius-base: 8px;   /* Base radius for buttons */
    --radius-md: 12px;    /* Medium radius for cards */
    --radius-lg: 16px;    /* Large radius for containers */
    --radius-full: 9999px; /* Full radius for pills/badges */

    /* ========== Shadows ========== */

    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-base: 0 1px 3px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
    --shadow-primary: 0 4px 12px rgba(37, 99, 235, 0.3);
    --shadow-primary-sm: 0 0 0 3px rgba(37, 99, 235, 0.1);
    --shadow-primary-alpha: rgba(37, 99, 235, 0.1);
    --focus-ring-color-alpha: rgba(37, 99, 235, 0.1);

    /* ========== Transitions ========== */

    --transition-fast: 0.15s ease;
    --transition-base: 0.2s ease;
    --transition-slow: 0.3s ease;

    /* ========== Layout ========== */

    --container-max-width: 1200px;
    --content-max-width: 800px;

    /* Grid Breakpoints (for reference in media queries) */
    --breakpoint-sm: 640px;
    --breakpoint-md: 768px;
    --breakpoint-lg: 1024px;
    --breakpoint-xl: 1440px;

    /* Touch Target Sizes (WCAG AAA) */
    --touch-target-min: 44px;
    --touch-target-comfortable: 48px;

    /* Card Padding (responsive 24/20/16 pattern) */
    --card-padding: 24px;         /* Desktop default */
    --card-padding-tablet: 20px;  /* Tablet */
    --card-padding-mobile: 16px;  /* Mobile */

    /* ========== Mobile-First Responsive Tokens ========== */

    /* Overflow prevention */
    --overflow-wrap: break-word;
    --word-break: break-word;

    /* Mobile container padding */
    --container-padding-mobile: 12px;
    --container-padding-tablet: 16px;
    --container-padding-desktop: 20px;

    /* Minimum readable font sizes */
    --font-size-mobile-min: 16px; /* Prevents iOS zoom on focus */
    --line-height-mobile: 1.5;

    /* Thumb-friendly spacing */
    --tap-spacing: 12px;          /* Minimum gap between tappable elements */

    /* Mobile-specific shadows (lighter for performance) */
    --shadow-mobile: 0 1px 2px rgba(0, 0, 0, 0.08);

    /* Safe bottom padding for fixed action buttons */
    --safe-bottom-padding: 80px;

    /* ========== Z-Index Scale ========== */

    --z-index-base: 1;
    --z-index-dropdown: 10;
    --z-index-sticky: 100;
    --z-index-modal: 1000;
    --z-index-overlay: 9999;

    /* ========== Surface-Specific Tokens ========== */

    /* Sponsor Logo Sizing (unified across surfaces) */
    --sponsor-logo-height: 60px;           /* Standard height for most surfaces */
    --sponsor-logo-height-sm: 40px;        /* Compact banners, mobile (640px and below) */
    --sponsor-logo-height-xs: 32px;        /* Very small mobile (375px and below) */
    --sponsor-logo-height-lg: 80px;        /* Large displays */
    --sponsor-logo-height-tv: 120px;       /* TV mode (10-foot viewing) */
    --sponsor-logo-max-width-mobile: 160px; /* Max width on mobile to prevent overflow */
    --sponsor-logo-gap-mobile: 10px;       /* Reduced gap on mobile */
    --sponsor-logo-max-width: 220px;       /* Max width to prevent overflow */
    --sponsor-logo-gap: 16px;              /* Gap between logos */

    /* Poster */
    --poster-border-width: 3px;
    --poster-qr-max-width: 250px;
    --poster-sponsor-logo-height: 70px;    /* Slightly larger for print */

    /* D-AUDIT: Print Safety Margins */
    /* Consumer printers typically need 0.5-1in unprintable margins */
    --print-margin-safe: 0.75in;        /* Safe margin for most printers */
    --print-margin-min: 0.5in;          /* Minimum margin for edge printers */
    --print-padding-inner: 0.25in;      /* Inner content padding */

    /* Display (TV/Kiosk) */
    --display-overlay-opacity: 0.95;
    --display-carousel-duration: 5s;
    --display-sponsor-logo-height-top: 72px;
    --display-sponsor-logo-height-side: 64px;

    /* TV Mode Colors (dark theme for 10ft viewing) */
    --color-tv-bg: #111111;
    --color-tv-bg-elevated: #1a1a1a;
    --color-tv-bg-card: #1f1f1f;
    --color-tv-border: #2a2a2a;
    --color-tv-border-hover: #3a3a3a;
    --color-tv-text: #eeeeee;
    --color-tv-text-muted: #aaaaaa;
    --color-tv-accent: #3b82f6;

    /* D-AUDIT: TV Mode Font Sizing (10ft viewing distance) */
    /* Minimum readable sizes for TV displays at 10-12ft viewing distance */
    --tv-font-size-min: 1rem;           /* 16px minimum for any text */
    --tv-font-size-label: 0.875rem;     /* 14px for labels (uppercase helps legibility) */
    --tv-font-size-body: 1.125rem;      /* 18px for body text */
    --tv-font-size-heading: 1.5rem;     /* 24px for headings */
    --tv-font-size-title: 2rem;         /* 32px for titles */

    /* Public Page */
    --public-hero-min-height: 300px;
    --public-card-hover-lift: -2px;

    /* Admin */
    --admin-sidebar-width: 250px;
    --admin-header-height: 64px;

    /* ========== Animation Durations ========== */

    --animation-spin: 1s;
    --animation-fade: 0.3s;
    --animation-slide: 0.4s;
  }

  /* ========== Dark Mode Tokens (Optional Future Enhancement) ========== */

  @media (prefers-color-scheme: dark) {
    :root {
      /* Currently not implemented, but tokens are ready for dark mode support */
      /* Uncomment and customize when ready to support dark mode:

      --color-gray-50: #0f172a;
      --color-gray-100: #1e293b;
      --color-gray-200: #334155;
      --color-gray-800: #f1f5f9;
      --color-gray-900: #f8fafc;

      */
    }
  }

  /* ========== Accessibility Tokens ========== */

  :root {
    /* Minimum contrast ratios (WCAG AA) */
    --contrast-min-normal: 4.5;   /* For normal text */
    --contrast-min-large: 3;      /* For large text (18px+) */

    /* Focus indicators */
    --focus-ring-width: 3px;
    --focus-ring-color: var(--color-primary);
    --focus-ring-offset: 2px;

    /* Reduced motion support */
    --animation-duration-default: var(--transition-base);
  }

  @media (prefers-reduced-motion: reduce) {
    :root {
      --animation-duration-default: 0.01ms;
      --transition-fast: 0.01ms;
      --transition-base: 0.01ms;
      --transition-slow: 0.01ms;
    }
  }
</style>

  <style>
  /* ===== Zeventbook Global Styles ===== */

  /* Reset & Base */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  /* Mobile-First: Prevent horizontal scroll globally */
  html, body {
    overflow-x: hidden;
    max-width: 100vw;
  }

  body {
    font-family: var(--font-family-base, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif);
    line-height: var(--line-height-base, 1.6);
    color: var(--color-gray-800, #1e293b);
    background: var(--color-gray-50, #f8fafc);
    /* Safe area support for notched devices (iPhone X+) */
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    /* Mobile-first: prevent text overflow */
    word-wrap: break-word;
    overflow-wrap: break-word;
    -webkit-text-size-adjust: 100%;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    /* Additional safe area padding on mobile */
    padding-left: max(20px, env(safe-area-inset-left));
    padding-right: max(20px, env(safe-area-inset-right));
  }

  /* Header */
  .site-header {
    background: white;
    border-bottom: 2px solid var(--color-primary, #2563eb);
    padding: 16px 0;
    margin-bottom: 24px;
    box-shadow: var(--shadow-sm, 0 2px 4px rgba(0,0,0,0.05));
  }

  .header-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .header-logo {
    max-height: var(--sponsor-logo-height, 60px);
    width: auto;
  }

  /* TS-002: Using design token instead of hardcoded 1.8rem */
  .header-title h1 {
    color: var(--color-primary, #2563eb);
    font-size: 1.8rem;
    margin-bottom: 4px;
  }

  .build-info {
    color: var(--color-gray-500, #64748b);
    font-size: 0.85rem;
  }

  /* Cards - Standardized padding: 24px desktop / 20px tablet / 16px mobile */
  .card {
    background: white;
    border-radius: var(--radius-md, 12px);
    padding: var(--card-padding, 24px);
    margin-bottom: var(--space-6, 24px);
    box-shadow: var(--shadow-base, 0 1px 3px rgba(0,0,0,0.1));
    border-left: 4px solid var(--color-primary, #2563eb);
  }

  .card h2 {
    margin-bottom: 16px;
    color: var(--color-gray-800, #1e293b);
    font-size: 1.5rem;
    border-bottom: 2px solid var(--color-gray-200, #e2e8f0);
    padding-bottom: 8px;
  }

  /* Section separators for better information density */
  /* CR-001: Merged duplicate .card h3 rules into single coherent block */
  .card h3 {
    margin-top: 28px;
    margin-bottom: 16px;
    padding-top: 20px;
    border-top: 1px solid var(--color-gray-100, #f1f5f9);
  }

  .card h3:first-of-type {
    margin-top: var(--space-5, 20px);
    padding-top: 0;
    border-top: none;
  }

  .card h3 {
    margin-top: 20px;
    margin-bottom: 12px;
    color: var(--color-gray-600, #475569);
    font-size: 1.2rem;
  }

  .card h4 {
    margin-top: 16px;
    margin-bottom: 8px;
    color: var(--color-gray-500, #64748b);
    font-size: 1rem;
  }

  /* Forms */
  .form-group {
    margin-bottom: 20px;
  }

  /* Form rows - Mobile-first with better density */
  .form-row {
    display: grid;
    grid-template-columns: 1fr; /* Mobile: single column for clarity */
    gap: 20px; /* More breathing room */
    margin-bottom: 20px;
  }

  /* Tablet and up: side-by-side fields */
  @media (min-width: 640px) {
    .form-row {
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
  }

  label {
    display: block;
    margin-bottom: 6px;
    color: var(--color-gray-600, #475569);
    font-weight: 500;
    font-size: 14px;
  }

  input[type="text"],
  input[type="email"],
  input[type="tel"],
  input[type="url"],
  input[type="date"],
  input[type="time"],
  input[type="number"],
  select,
  textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--color-gray-200, #e2e8f0);
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
    transition: border-color 0.2s, box-shadow 0.2s;
    min-height: 44px; /* WCAG 2.5.5 touch target minimum */
  }

  /* Disabled input states - accessibility enhancement */
  input:disabled,
  select:disabled,
  textarea:disabled {
    background-color: var(--color-gray-50, #f8fafc);
    color: var(--color-gray-400, #94a3b8);
    cursor: not-allowed;
    opacity: 0.65;
    border-color: var(--color-gray-300, #cbd5e1);
  }

  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--color-primary, #2563eb);
    box-shadow: 0 0 0 3px var(--focus-ring-color-alpha, rgba(37, 99, 235, 0.1));
  }

  textarea {
    min-height: 80px;
    resize: vertical;
  }

  /* Buttons - Mobile-first, thumb-friendly 44px minimum tap target */
  .btn-primary {
    background: var(--color-primary, #2563eb);
    color: white;
    padding: 14px 28px;
    border: none;
    border-radius: var(--radius-base, 8px);
    font-size: var(--font-size-base, 16px);
    font-weight: var(--font-weight-semibold, 600);
    cursor: pointer;
    transition: all var(--transition-base, 0.2s ease);
    display: inline-block;
    text-decoration: none;
    min-height: var(--touch-target-min, 44px);
    line-height: 1.2;
    text-align: center;
  }

  .btn-primary:hover {
    background: var(--color-primary-dark, #1d4ed8);
    transform: translateY(-1px);
    box-shadow: var(--shadow-primary, 0 4px 12px rgba(37, 99, 235, 0.3));
  }

  .btn-primary:active {
    transform: translateY(0);
  }

  .btn-secondary {
    background: white;
    color: var(--color-gray-600, #475569);
    padding: 12px 24px;
    border: 2px solid var(--color-gray-200, #e2e8f0);
    border-radius: var(--radius-base, 8px);
    font-size: var(--font-size-base, 15px);
    font-weight: var(--font-weight-medium, 500);
    cursor: pointer;
    transition: all var(--transition-base, 0.2s ease);
    display: inline-block;
    text-decoration: none;
    min-height: var(--touch-target-min, 44px);
    line-height: 1.2;
    text-align: center;
  }

  .btn-secondary:hover {
    background: var(--color-gray-50, #f8fafc);
    border-color: var(--color-primary, #2563eb);
    color: var(--color-primary, #2563eb);
  }

  .btn-success {
    background: var(--color-success, #10b981);
    color: white;
    padding: 14px 28px;
    border: none;
    border-radius: var(--radius-base, 8px);
    font-size: var(--font-size-base, 16px);
    font-weight: var(--font-weight-semibold, 600);
    cursor: pointer;
    transition: all var(--transition-base, 0.2s ease);
    min-height: var(--touch-target-min, 44px);
  }

  .btn-success:hover {
    background: var(--color-success-dark, #059669);
  }

  .btn-danger {
    background: var(--color-danger, #ef4444);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: var(--radius-base, 8px);
    font-size: var(--font-size-base, 15px);
    font-weight: var(--font-weight-medium, 500);
    cursor: pointer;
    transition: all var(--transition-base, 0.2s ease);
    min-height: var(--touch-target-min, 44px);
  }

  .btn-danger:hover {
    background: var(--color-danger-dark, #dc2626);
  }

  /* Disabled button states - accessibility enhancement */
  .btn-primary:disabled,
  .btn-secondary:disabled,
  .btn-success:disabled,
  .btn-danger:disabled,
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
    transform: none;
    box-shadow: none;
  }

  .btn-primary:disabled {
    background-color: var(--color-gray-300, #cbd5e1);
  }

  .btn-secondary:disabled {
    background-color: var(--color-gray-100, #f1f5f9);
    border-color: var(--color-gray-300, #cbd5e1);
    color: var(--color-gray-400, #94a3b8);
  }

  .button-group {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    flex-wrap: wrap;
  }

  /* Mobile: Stack buttons vertically with full width */
  @media (max-width: 640px) {
    .button-group {
      flex-direction: column;
      gap: 12px;
    }

    .button-group .btn-primary,
    .button-group .btn-secondary,
    .button-group .btn-success,
    .button-group .btn-danger {
      width: 100%;
      text-align: center;
    }
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: var(--space-6, 24px);
    border-bottom: 2px solid var(--color-gray-200, #e2e8f0);
  }

  .tab-button {
    padding: 12px 24px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    font-size: var(--font-size-base, 15px);
    font-weight: var(--font-weight-medium, 500);
    color: var(--color-gray-500, #64748b);
    cursor: pointer;
    transition: all var(--transition-base, 0.2s);
    margin-bottom: -2px;
  }

  .tab-button:hover {
    color: var(--color-primary, #2563eb);
    background: var(--color-gray-100, #f1f5f9);
  }

  .tab-button.active {
    color: var(--color-primary, #2563eb);
    border-bottom-color: var(--color-primary, #2563eb);
    background: white;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Grids - Mobile-first responsive layout */
  .events-grid {
    display: grid;
    grid-template-columns: 1fr; /* Mobile: single column */
    gap: 16px;
    margin-top: 20px;
  }

  /* Tablet: 2 columns */
  @media (min-width: 640px) {
    .events-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
  }

  /* Desktop: 3 columns */
  @media (min-width: 1024px) {
    .events-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
    }
  }

  /* Large desktop: 4 columns */
  @media (min-width: 1440px) {
    .events-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .event-card {
    background: var(--color-gray-50, #f8fafc);
    border: 1px solid var(--color-gray-200, #e2e8f0);
    border-left: 3px solid var(--color-gray-500, #64748b); /* Subtle left accent for visual hierarchy */
    border-radius: var(--radius-md, 12px);
    padding: var(--card-padding-tablet, 20px);
    transition: all var(--transition-base, 0.2s);
  }

  .event-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md, 0 4px 12px rgba(0,0,0,0.1));
    border-left-color: var(--color-primary, #2563eb); /* Blue accent on hover */
    background: white;
  }

  .event-card h3 {
    margin: 0 0 12px 0;
    color: var(--color-gray-800, #1e293b);
    font-size: 1.1rem;
  }

  .event-card h4 {
    margin: 0 0 8px 0;
    color: var(--color-gray-600, #475569);
    font-size: 1rem;
  }

  .event-card p {
    color: var(--color-gray-500, #64748b);
    margin-bottom: 8px;
    font-size: var(--font-size-sm, 14px);
  }

  .event-card small {
    color: var(--color-gray-400, #94a3b8);
    font-size: var(--font-size-xs, 12px);
  }

  /* QR Codes */
  .qr-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 24px;
    margin: 24px 0;
  }

  .qr-code {
    text-align: center;
    padding: var(--card-padding-tablet, 20px);
    background: var(--color-gray-50, #f8fafc);
    border-radius: var(--radius-md, 12px);
    border: 2px solid var(--color-gray-200, #e2e8f0);
  }

  .qr-code h3 {
    margin: 0 0 8px 0;
    color: var(--color-gray-800, #1e293b);
    font-size: 1rem;
  }

  .qr-code h4 {
    margin: 0 0 12px 0;
    color: var(--color-gray-600, #475569);
    font-size: 0.9rem;
  }

  .qr-code img {
    width: 100%;
    max-width: 250px;
    height: auto;
    margin: 12px auto;
    display: block;
  }

  .qr-code p {
    margin-top: 12px;
    color: var(--color-gray-500, #64748b);
    font-size: var(--font-size-sm, 13px);
    word-break: break-all;
  }

  /* Loading Overlay */
  .loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.95);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }

  .spinner {
    border: 4px solid var(--color-gray-200, #e2e8f0);
    border-top: 4px solid var(--color-primary, #2563eb);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .loading-overlay p {
    margin-top: 16px;
    color: var(--color-gray-500, #64748b);
    font-weight: var(--font-weight-medium, 500);
  }

  /* Utilities */
  .muted {
    color: var(--color-gray-400, #94a3b8);
    font-size: 0.9em;
  }

  .text-center {
    text-align: center;
  }

  .mt-1 { margin-top: 8px; }
  .mt-2 { margin-top: 16px; }
  .mt-3 { margin-top: 24px; }
  .mb-1 { margin-bottom: 8px; }
  .mb-2 { margin-bottom: 16px; }
  .mb-3 { margin-bottom: 24px; }

  /* Sponsor Badges */
  .sponsor-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .sponsor-badge.gold {
    background: #fef3c7;
    color: #92400e;
  }

  .sponsor-badge.silver {
    background: #e5e7eb;
    color: #374151;
  }

  .sponsor-badge.bronze {
    background: #fed7aa;
    color: #9a3412;
  }

  /* Data Visualization Components */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin: 24px 0;
  }

  .stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: var(--space-6, 24px); /* D-AUDIT: Using design token for consistent rhythm */
    border-radius: var(--radius-md, 12px); /* D-AUDIT: Using design token for consistency */
    text-align: center;
    box-shadow: var(--shadow-md, 0 4px 12px rgba(0,0,0,0.1));
    transition: transform var(--transition-base, 0.2s ease);
  }

  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  }

  .stat-card.blue {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  }

  .stat-card.green {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  }

  .stat-card.purple {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  }

  .stat-card.orange {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  }

  .stat-card.red {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  }

  .stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 8px;
  }

  .stat-label {
    font-size: var(--font-size-sm, 0.875rem); /* D-AUDIT: Aligned to type scale from 0.9rem */
    opacity: 0.95;
    font-weight: var(--font-weight-medium, 500);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide, 0.025em);
  }

  .stat-trend {
    margin-top: var(--space-2, 8px);
    font-size: var(--font-size-sm, 0.875rem); /* D-AUDIT: Aligned to type scale from 0.85rem */
    opacity: 0.9;
  }

  .stat-trend.up::before {
    content: '↑ ';
  }

  .stat-trend.down::before {
    content: '↓ ';
  }

  /* Progress Bars */
  .progress-bar {
    width: 100%;
    height: 8px;
    background: var(--color-gray-200, #e2e8f0);
    border-radius: var(--radius-sm, 4px);
    overflow: hidden;
    margin: 12px 0;
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary, #2563eb) 0%, var(--color-primary-light, #3b82f6) 100%);
    border-radius: var(--radius-sm, 4px);
    transition: width 0.3s ease;
  }

  .progress-bar-fill.green {
    background: linear-gradient(90deg, var(--color-success, #10b981) 0%, var(--color-success-light, #34d399) 100%);
  }

  .progress-bar-fill.orange {
    background: linear-gradient(90deg, var(--color-warning, #f59e0b) 0%, var(--color-warning-light, #fbbf24) 100%);
  }

  /* Phase Indicators */
  .phase-indicator {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .phase-indicator.pre-event {
    background: #dbeafe;
    color: #1e40af;
  }

  .phase-indicator.event-day {
    background: #d1fae5;
    color: #065f46;
  }

  .phase-indicator.post-event {
    background: #fce7f3;
    color: #9f1239;
  }

  .phase-indicator::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
  }

  /* Metric Cards */
  .metric-card {
    background: white;
    border: 2px solid var(--color-gray-200, #e2e8f0);
    border-radius: var(--radius-md, 12px);
    padding: var(--card-padding-tablet, 20px);
    transition: all var(--transition-base, 0.2s ease);
  }

  .metric-card:hover {
    border-color: var(--color-primary, #2563eb);
    box-shadow: 0 4px 12px var(--shadow-primary-alpha, rgba(37, 99, 235, 0.1));
  }

  .metric-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .metric-title {
    font-size: 0.9rem;
    color: var(--color-gray-500, #64748b);
    font-weight: var(--font-weight-medium, 500);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide, 0.025em);
  }

  .metric-value {
    font-size: 2rem;
    font-weight: var(--font-weight-bold, 700);
    color: var(--color-gray-800, #1e293b);
    line-height: 1;
  }

  .metric-subtitle {
    margin-top: 8px;
    font-size: 0.85rem;
    color: var(--color-gray-400, #94a3b8);
  }

  /* Status Badges */
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }

  .status-badge.active {
    background: #d1fae5;
    color: #065f46;
  }

  .status-badge.upcoming {
    background: #dbeafe;
    color: #1e40af;
  }

  .status-badge.ended {
    background: #f1f5f9;
    color: #475569;
  }

  .status-badge::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
  }

  /* Mobile Touch Optimizations */
  @media (max-width: 768px) {
    /* Increase tap targets for mobile */
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="url"],
    input[type="date"],
    input[type="time"],
    input[type="number"],
    select {
      min-height: 44px;
      font-size: 16px; /* Prevents iOS zoom on focus */
    }

    /* Bottom-aligned sticky action buttons for one-handed use */
    .sticky-bottom-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 12px 16px;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
      z-index: 100;
      border-top: 1px solid var(--color-gray-200, #e2e8f0);
    }

    .sticky-bottom-actions .btn-primary,
    .sticky-bottom-actions .btn-secondary {
      width: 100%;
      margin-bottom: 8px;
    }

    .sticky-bottom-actions .btn-primary:last-child,
    .sticky-bottom-actions .btn-secondary:last-child {
      margin-bottom: 0;
    }
  }

  /* Enhanced Sponsor Banners */
  .sponsor-banner {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
    justify-content: center;
    padding: 20px;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 12px;
    margin: 24px 0;
  }

  .sponsor-logo {
    max-height: var(--sponsor-logo-height, 60px);
    width: auto;
    object-fit: contain;
    transition: transform var(--transition-base, 0.2s ease);
    cursor: pointer;
  }

  .sponsor-logo:hover {
    transform: scale(1.1);
  }

  .sponsor-banner.compact .sponsor-logo {
    max-height: 40px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .container {
      padding: 12px;
      /* Respect safe areas on mobile */
      padding-left: max(12px, env(safe-area-inset-left));
      padding-right: max(12px, env(safe-area-inset-right));
    }

    .card {
      padding: 16px; /* Reduced padding on mobile for better information density */
      border-radius: 8px; /* Slightly smaller border radius */
      margin-bottom: 16px;
    }

    .card h2 {
      font-size: 1.25rem; /* Slightly smaller headings on mobile */
    }

    .header-title h1 {
      font-size: 1.5rem;
    }

    .header-logo {
      max-height: 48px;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .events-grid {
      grid-template-columns: 1fr;
    }

    .qr-grid {
      grid-template-columns: 1fr;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .stat-value {
      font-size: 2rem;
    }

    .metric-value {
      font-size: 1.75rem;
    }

    .tabs {
      overflow-x: auto;
    }

    .tab-button {
      white-space: nowrap;
    }

    .button-group {
      flex-direction: column;
    }

    .button-group .btn-primary,
    .button-group .btn-secondary {
      width: 100%;
      text-align: center;
    }

    .sponsor-banner {
      padding: 16px;
      gap: 12px;
    }

    .sponsor-logo {
      max-height: var(--sponsor-logo-height-sm, 50px);
    }
  }

  /* ===== Alert Components ===== */
  .alert {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    font-size: 14px;
    font-weight: 500;
    animation: alert-slide-in 0.3s ease-out;
  }

  @keyframes alert-slide-in {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .alert-fade-out {
    animation: alert-fade-out 0.3s ease-out forwards;
  }

  @keyframes alert-fade-out {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(-10px);
    }
  }

  .alert-info {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #93c5fd;
  }

  .alert-success {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #86efac;
  }

  .alert-error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
  }

  .alert-warning {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fde68a;
  }

  .alert-dismiss {
    background: transparent;
    border: none;
    font-size: 20px;
    line-height: 1;
    cursor: pointer;
    opacity: 0.6;
    padding: 0 4px;
    color: inherit;
  }

  .alert-dismiss:hover {
    opacity: 1;
  }

  /* ===== Tier Badges ===== */
  .tier-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 9999px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .tier-badge.platinum,
  .tier-platinum {
    background: #e5e7eb;
    color: #1f2937;
  }

  .tier-badge.gold,
  .tier-gold {
    background: #fef3c7;
    color: #92400e;
  }

  .tier-badge.silver,
  .tier-silver {
    background: #f3f4f6;
    color: #374151;
  }

  .tier-badge.bronze,
  .tier-bronze {
    background: #fed7aa;
    color: #7c2d12;
  }

  /* ===== Form Validation States ===== */
  /* Full class names for specificity */
  .form-input-error,
  input.form-input-error,
  select.form-input-error,
  textarea.form-input-error,
  /* Short aliases (I-004) */
  .input-error,
  input.input-error,
  select.input-error,
  textarea.input-error {
    border-color: var(--color-danger, #ef4444) !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
  }

  .form-input-success,
  input.form-input-success,
  select.form-input-success,
  textarea.form-input-success,
  /* Short aliases (I-004) */
  .input-success,
  input.input-success,
  select.input-success,
  textarea.input-success {
    border-color: var(--color-success, #10b981) !important;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
  }

  /* Validation message styling */
  .input-error-message,
  .form-error-message {
    color: var(--color-danger, #ef4444);
    font-size: var(--font-size-sm, 0.875rem);
    margin-top: 4px;
  }

  .input-success-message {
    color: var(--color-success, #10b981);
    font-size: var(--font-size-sm, 0.875rem);
    margin-top: 4px;
  }

  .form-hint {
    margin-top: 4px;
    font-size: var(--font-size-sm, 13px);
    color: var(--color-gray-500, #64748b);
  }

  .form-error-message {
    margin-top: 4px;
    font-size: var(--font-size-sm, 13px);
    color: var(--color-danger, #ef4444);
  }

  /* ===== Page Layout Components ===== */
  /* Shared page section styles (MVP: Admin.html, Public.html) */
  .page-section {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  }

  .page-section h2 {
    margin: 0 0 1.5rem 0;
    font-size: 1.5rem;
    color: var(--color-gray-800, #1f2937);
    border-bottom: 2px solid var(--color-gray-200, #e5e7eb);
    padding-bottom: 0.75rem;
  }

  .page-header-card {
    background: white;
    border-radius: var(--radius-lg, 16px);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-lg, 0 10px 30px rgba(0, 0, 0, 0.1));
  }

  .page-header-card h1 {
    margin: 0 0 0.5rem 0;
    font-size: 2rem;
    color: var(--color-gray-800, #1f2937);
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .page-header-card .subtitle {
    color: var(--color-gray-500, #6b7280);
    font-size: 1rem;
  }

  .nav-breadcrumb {
    margin-bottom: 1rem;
  }

  .nav-breadcrumb a {
    color: var(--color-primary, #2563eb);
    text-decoration: none;
    transition: color var(--transition-base, 0.2s);
  }

  .nav-breadcrumb a:hover {
    text-decoration: underline;
  }

  /* ===== Entity Card Grid ===== */
  /* Shared grid for sponsors, events, forms, etc. */
  .entity-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
  }

  .entity-card {
    background: var(--color-gray-50, #f9fafb);
    border: 2px solid var(--color-gray-200, #e5e7eb);
    border-radius: var(--radius-md, 12px);
    padding: 1.5rem;
    transition: all var(--transition-base, 0.2s);
  }

  .entity-card:hover {
    border-color: var(--color-primary, #2563eb);
    box-shadow: var(--shadow-md, 0 4px 12px rgba(0, 0, 0, 0.1));
  }

  .entity-card h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
    color: var(--color-gray-800, #1f2937);
  }

  .entity-card-info {
    font-size: var(--font-size-sm, 0.875rem);
    color: var(--color-gray-500, #6b7280);
    margin-bottom: 0.5rem;
  }

  .entity-card-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    flex-wrap: wrap;
  }

  /* ===== Analytics Cards ===== */
  .analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }

  .analytics-card {
    background: var(--color-gray-50, #f9fafb);
    border: 2px solid var(--color-gray-200, #e5e7eb);
    border-radius: var(--radius-base, 8px);
    padding: 1.5rem;
    text-align: center;
    transition: all var(--transition-base, 0.2s);
  }

  .analytics-card:hover {
    border-color: var(--color-primary, #2563eb);
  }

  .analytics-card .value {
    font-size: 2rem;
    font-weight: var(--font-weight-bold, 700);
    color: var(--color-gray-800, #1f2937);
    margin-bottom: 0.5rem;
  }

  .analytics-card .label {
    font-size: var(--font-size-sm, 0.875rem);
    color: var(--color-gray-500, #6b7280);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* ===== Button Size Variants ===== */
  .btn-sm {
    padding: 8px 16px;
    font-size: 14px;
    min-height: 36px;
  }

  .btn-full {
    width: 100%;
  }

  /* ===== Retry Button (D-005: Centralized from 4 pages) ===== */
  .btn-retry {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 20px;
    background: var(--color-primary, #2563eb);
    color: white;
    border: none;
    border-radius: var(--radius-base, 8px);
    font-size: var(--font-size-sm, 0.875rem);
    font-weight: var(--font-weight-medium, 500);
    cursor: pointer;
    text-decoration: none;
    transition: background var(--transition-fast, 0.15s ease);
  }

  .btn-retry:hover {
    background: var(--color-primary-dark, #1d4ed8);
  }

  .btn-retry:focus-visible {
    outline: var(--focus-ring-width, 3px) solid var(--focus-ring-color, var(--color-primary));
    outline-offset: var(--focus-ring-offset, 2px);
  }

  /* ===== Empty State ===== */
  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--color-gray-500, #6b7280);
  }

  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .empty-state h3 {
    margin: 0 0 0.5rem 0;
    color: var(--color-gray-700, #374151);
  }

  /* ===== Loading State ===== */
  .loading-state {
    text-align: center;
    padding: 2rem;
    color: var(--color-gray-500, #6b7280);
  }

  /* Print Styles */
  @media print {
    body {
      background: white;
    }

    .site-header {
      border-bottom: 1px solid #000;
    }

    .build-info,
    .button-group,
    .tabs {
      display: none !important;
    }

    .card {
      box-shadow: none;
      page-break-inside: avoid;
      border: 1px solid var(--color-gray-200, #e2e8f0);
    }

    .qr-code {
      page-break-inside: avoid;
    }
  }

  /* ===== Mobile-First Critical Patterns ===== */

  /* Prevent any element from causing horizontal scroll */
  img, video, iframe, embed, object {
    max-width: 100%;
    height: auto;
  }

  /* Table overflow handling for mobile */
  .table-responsive {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Text overflow prevention */
  h1, h2, h3, h4, h5, h6, p, span, a, li {
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  /* Long URLs and codes */
  code, pre, .monospace, [style*="monospace"] {
    word-break: break-all;
    overflow-wrap: anywhere;
  }

  /* Mobile-optimized links (finger-friendly) */
  @media (max-width: 640px) {
    a {
      -webkit-tap-highlight-color: transparent;
    }

    /* Ensure all interactive elements have adequate spacing */
    .card a,
    .card button {
      min-height: 44px;
      display: inline-flex;
      align-items: center;
    }
  }

  /* Collapsible card headers - Mobile tap-friendly */
  .collapsible-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    padding: 12px 16px;
    min-height: var(--touch-target-min, 44px);
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }

  .collapsible-header:active {
    background: var(--color-gray-100, #f1f5f9);
  }

  .collapsible-icon {
    transition: transform var(--transition-base, 0.2s);
    font-size: 0.8em;
  }

  .collapsible-header.collapsed .collapsible-icon {
    transform: rotate(-90deg);
  }

  /* Mobile-friendly error card */
  .error-card {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-left: 4px solid #ef4444;
    border-radius: var(--radius-md, 12px);
    padding: var(--card-padding-mobile, 16px);
    margin: 16px 0;
    word-wrap: break-word;
  }

  .error-card h3 {
    color: #dc2626;
    font-size: 1.1rem;
    margin-bottom: 8px;
  }

  .error-card p {
    color: #7f1d1d;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .error-card .corr-id {
    font-family: var(--font-family-mono, monospace);
    font-size: 0.75rem;
    color: #9ca3af;
    margin-top: 12px;
    word-break: break-all;
  }

  /* Sticky bottom action bar for mobile */
  .sticky-action-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 12px 16px;
    padding-bottom: max(12px, env(safe-area-inset-bottom));
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    z-index: var(--z-index-sticky, 100);
    border-top: 1px solid var(--color-gray-200, #e2e8f0);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .sticky-action-bar .btn-primary,
  .sticky-action-bar .btn-secondary {
    width: 100%;
    justify-content: center;
  }

  /* Checkbox group for mobile - tap-friendly */
  .checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .checkbox-label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: var(--color-gray-50, #f8fafc);
    border: 1px solid var(--color-gray-200, #e2e8f0);
    border-radius: var(--radius-base, 8px);
    cursor: pointer;
    min-height: var(--touch-target-min, 44px);
    font-size: var(--font-size-sm, 0.875rem);
    transition: all var(--transition-fast, 0.15s);
    -webkit-tap-highlight-color: transparent;
  }

  .checkbox-label:hover {
    background: var(--color-gray-100, #f1f5f9);
  }

  .checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--color-primary, #2563eb);
  }

  .checkbox-label:has(input:checked) {
    background: var(--color-primary-bg, #eff6ff);
    border-color: var(--color-primary-light, #bfdbfe);
  }

  /* Site footer - unified across surfaces */
  .site-footer {
    text-align: center;
    padding: 24px 16px;
    color: var(--color-gray-400, #94a3b8);
    font-size: var(--font-size-sm, 0.875rem);
    border-top: 1px solid var(--color-gray-200, #e2e8f0);
    margin-top: 40px;
    background: var(--color-gray-50, #f8fafc);
  }

  .site-footer a {
    color: var(--color-primary, #2563eb);
    text-decoration: none;
  }

  .site-footer a:hover {
    text-decoration: underline;
  }

  /* TV mode footer */
  body[data-tv="1"] .site-footer {
    background: transparent;
    border-top-color: var(--color-tv-border, #333);
    color: var(--color-tv-text-muted, #888);
    padding: 12px;
    font-size: max(0.75rem, 12px);
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    margin: 0;
  }

  body[data-tv="1"] .site-footer a {
    color: var(--color-tv-accent, #60a5fa);
  }

  /* Mobile footer adjustment for sticky buttons */
  @media (max-width: 640px) {
    body.has-sticky-actions .site-footer {
      padding-bottom: 100px;
    }
  }
</style>

  <script>
/**
 * ═══════════════════════════════════════════════════════════════════════════════
 * SharedUtils - Common utilities for all front-end pages
 * ═══════════════════════════════════════════════════════════════════════════════
 *
 * RESPONSIBILITY: This file provides UI utilities (alerts, dates, forms) ONLY.
 * It does NOT handle data entities or business logic - that belongs in Code.gs.
 *
 * WINDOW ADDITION: window.SharedUtils
 *
 * Dependencies: NUSDK.html (for NU.esc)
 * Used by: Public.html, Display.html, Poster.html, SharedReport.html, Admin.html
 *
 * ═══════════════════════════════════════════════════════════════════════════════
 * HELPER INDEX (keep updated when adding/removing functions):
 * ═══════════════════════════════════════════════════════════════════════════════
 *   showAlert(message, type, options)  → Alert notifications (Admin.html)
 *   showToast(message, type, duration) → Toast notifications (all surfaces)
 *   formatDate(dateInput, options)     → Date formatting (Admin.html)
 *   formatTime(timeStr)                → Time formatting (Admin.html)
 *   debounce(fn, delay)                → Event debouncing (Admin.html)
 *   copyToClipboard(text)              → Clipboard utility (Admin.html)
 *   validateUrl(url)                   → URL validation (Admin.html)
 *   sectionEnabled(settings, key)      → Section visibility check (Feature 4)
 *     Keys: schedule, standings, bracket, sponsors, video, map, gallery
 *
 * S12: StateRenderer - Unified error/empty/loading states (all surfaces)
 *   StateRenderer.showError(container, options)      → Error state
 *   StateRenderer.showEmpty(container, options)      → Empty state
 *   StateRenderer.showLoading(container, options)    → Loading state
 *   StateRenderer.showEventNotFound(container, opts) → Event not found
 *   StateRenderer.showNoData(container, opts)        → No data yet
 *   StateRenderer.showNetworkError(container, opts)  → Connection error
 *   StateRenderer.showUnauthorized(container, opts)  → Access denied
 *   StateRenderer.showFromError(container, err, opts)→ Auto-detect type
 *   ERROR_TYPES                                      → Standard error types
 *   classifyError(error)                             → Map error to type
 * ═══════════════════════════════════════════════════════════════════════════════
 *
 * @version 1.3.0
 */
window.SharedUtils = (function() {
  'use strict';

  // === Alert/Notification System ===

  /**
   * Shows a dismissible alert notification
   * @param {string} message - Alert message text
   * @param {string} type - Alert type: 'info', 'success', 'error', 'warning'
   * @param {Object} options - Optional configuration
   * @param {number} options.duration - Auto-dismiss duration in ms (0 = no auto-dismiss)
   * @param {string} options.containerId - ID of alert container element
   */
  function showAlert(message, type = 'info', options = {}) {
    const {
      duration = 5000,
      containerId = 'alert-container'
    } = options;

    const container = document.getElementById(containerId);
    if (!container) {
      console.warn(`SharedUtils.showAlert: Container #${containerId} not found`);
      return;
    }

    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.setAttribute('role', 'alert');

    // Create alert content with dismiss button
    const content = document.createElement('span');
    content.textContent = message;

    const dismissBtn = document.createElement('button');
    dismissBtn.type = 'button';
    dismissBtn.className = 'alert-dismiss';
    dismissBtn.innerHTML = '&times;';
    dismissBtn.setAttribute('aria-label', 'Dismiss');
    dismissBtn.onclick = () => alert.remove();

    alert.appendChild(content);
    alert.appendChild(dismissBtn);

    // Clear existing alerts and add new one
    container.innerHTML = '';
    container.appendChild(alert);

    // Auto-dismiss if duration > 0
    if (duration > 0) {
      setTimeout(() => {
        if (alert.parentNode) {
          alert.classList.add('alert-fade-out');
          setTimeout(() => alert.remove(), 300);
        }
      }, duration);
    }

    return alert;
  }

  // === Date Formatting ===

  /**
   * Formats a date string to a human-readable format
   * @param {string|Date} dateInput - Date string or Date object
   * @param {Object} options - Intl.DateTimeFormat options
   * @returns {string} Formatted date string
   */
  function formatDate(dateInput, options = {}) {
    if (!dateInput) return 'Date TBD';

    try {
      const date = dateInput instanceof Date ? dateInput : new Date(dateInput);
      if (isNaN(date.getTime())) return 'Invalid Date';

      const defaultOptions = {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      };

      return date.toLocaleDateString('en-US', { ...defaultOptions, ...options });
    } catch (e) {
      return 'Date TBD';
    }
  }

  /**
   * Formats a date string to a relative time (e.g., "2 days ago")
   * @param {string|Date} dateInput - Date string or Date object
   * @returns {string} Relative time string
   */
  function formatRelativeTime(dateInput) {
    if (!dateInput) return '';

    try {
      const date = dateInput instanceof Date ? dateInput : new Date(dateInput);
      if (isNaN(date.getTime())) return '';

      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
      if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
      return `${Math.floor(diffDays / 365)} years ago`;
    } catch (e) {
      return '';
    }
  }

  // === Form Utilities ===

  /**
   * Validates a form and returns validation status
   * @param {string|HTMLFormElement} formIdOrEl - Form ID or form element
   * @returns {Object} { valid: boolean, errors: Array<{field, message}> }
   */
  function validateForm(formIdOrEl) {
    const form = typeof formIdOrEl === 'string'
      ? document.getElementById(formIdOrEl)
      : formIdOrEl;

    if (!form) return { valid: false, errors: [{ field: null, message: 'Form not found' }] };

    const errors = [];
    const requiredInputs = form.querySelectorAll('[required]');

    requiredInputs.forEach(input => {
      // Clear previous error state
      input.classList.remove('form-input-error');

      if (!input.value.trim()) {
        errors.push({
          field: input.name || input.id,
          message: `${input.labels?.[0]?.textContent || input.name || 'Field'} is required`
        });
        input.classList.add('form-input-error');
      }
    });

    // Validate email fields
    form.querySelectorAll('input[type="email"]').forEach(input => {
      if (input.value && !isValidEmail(input.value)) {
        errors.push({ field: input.name || input.id, message: 'Invalid email address' });
        input.classList.add('form-input-error');
      }
    });

    // Validate URL fields
    form.querySelectorAll('input[type="url"]').forEach(input => {
      if (input.value && !isValidUrl(input.value)) {
        errors.push({ field: input.name || input.id, message: 'Invalid URL' });
        input.classList.add('form-input-error');
      }
    });

    return { valid: errors.length === 0, errors };
  }

  /**
   * Validates an email address
   * @param {string} email - Email to validate
   * @returns {boolean} True if valid
   */
  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  /**
   * Validates a URL
   * @param {string} url - URL to validate
   * @returns {boolean} True if valid
   */
  function isValidUrl(url) {
    try {
      new URL(url);
      return true;
    } catch {
      return false;
    }
  }

  // === Loading State Management ===

  /**
   * Executes an async function with loading state management
   * @param {Function} asyncFn - Async function to execute
   * @param {Object} options - Configuration options
   * @param {string} options.loadingElId - ID of loading indicator element
   * @param {string} options.emptyElId - ID of empty state element
   * @param {string} options.contentElId - ID of content container element
   * @param {HTMLButtonElement} options.button - Submit button to disable
   * @returns {Promise<any>} Result of asyncFn
   */
  async function withLoadingState(asyncFn, options = {}) {
    const { loadingElId, emptyElId, contentElId, button } = options;

    const loadingEl = loadingElId ? document.getElementById(loadingElId) : null;
    const emptyEl = emptyElId ? document.getElementById(emptyElId) : null;
    const contentEl = contentElId ? document.getElementById(contentElId) : null;

    // Show loading state
    if (loadingEl) loadingEl.style.display = 'block';
    if (emptyEl) emptyEl.style.display = 'none';
    if (contentEl) contentEl.style.display = 'none';
    if (button) button.disabled = true;

    try {
      const result = await asyncFn();
      return result;
    } finally {
      // Hide loading state
      if (loadingEl) loadingEl.style.display = 'none';
      if (button) button.disabled = false;
    }
  }

  // === DOM Utilities ===

  /**
   * Toggles element visibility
   * @param {string} elementId - ID of element to toggle
   * @param {string} className - Class to toggle (default: 'hidden')
   */
  function toggleElement(elementId, className = 'hidden') {
    const el = document.getElementById(elementId);
    if (el) el.classList.toggle(className);
  }

  /**
   * Shows an element by removing hidden class
   * @param {string} elementId - ID of element to show
   */
  function showElement(elementId) {
    const el = document.getElementById(elementId);
    if (el) el.style.display = 'block';
  }

  /**
   * Hides an element by setting display none
   * @param {string} elementId - ID of element to hide
   */
  function hideElement(elementId) {
    const el = document.getElementById(elementId);
    if (el) el.style.display = 'none';
  }

  // === XSS Prevention (delegating to NU.esc) ===

  /**
   * Escapes HTML special characters to prevent XSS
   * Delegates to NU.esc if available, otherwise uses local implementation
   *
   * IMPORTANT: Prefer using NU.esc() directly when NUSDK is included.
   * This is provided for backwards compatibility.
   *
   * @param {string} unsafe - String to escape
   * @returns {string} HTML-safe string
   */
  function esc(unsafe) {
    // Delegate to NU.esc if available (canonical implementation)
    if (window.NU && typeof window.NU.esc === 'function') {
      return window.NU.esc(unsafe);
    }
    // Fallback implementation (should rarely be used)
    if (!unsafe) return '';
    return String(unsafe).replace(/[&<>"']/g, m => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[m]));
  }

  // === Debounce/Throttle ===

  /**
   * Creates a debounced version of a function
   * @param {Function} fn - Function to debounce
   * @param {number} delay - Delay in milliseconds
   * @returns {Function} Debounced function
   */
  function debounce(fn, delay = 300) {
    let timeoutId;
    return function(...args) {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  /**
   * Creates a throttled version of a function
   * @param {Function} fn - Function to throttle
   * @param {number} limit - Minimum time between calls in milliseconds
   * @returns {Function} Throttled function
   */
  function throttle(fn, limit = 100) {
    let inThrottle;
    return function(...args) {
      if (!inThrottle) {
        fn.apply(this, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    };
  }

  // === Toast Notifications (non-blocking) ===

  /**
   * Shows a brief toast notification (non-blocking alternative to alert())
   * @param {string} message - Toast message
   * @param {string} type - 'success', 'error', 'info', 'warning'
   * @param {number} duration - Auto-dismiss duration in ms (default: 3000)
   */
  function showToast(message, type = 'info', duration = 3000) {
    // Remove existing toast
    const existing = document.querySelector('.shared-toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = `shared-toast shared-toast-${type}`;
    toast.setAttribute('role', 'status');
    toast.textContent = message;

    // Inject minimal styles if not present
    if (!document.getElementById('shared-toast-styles')) {
      const style = document.createElement('style');
      style.id = 'shared-toast-styles';
      style.textContent = `
        .shared-toast {
          position: fixed; bottom: 20px; right: 20px;
          padding: 12px 20px; border-radius: 8px;
          font-size: 14px; font-weight: 500; z-index: 9999;
          animation: toast-slide-in 0.3s ease;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .shared-toast-success { background: #10b981; color: white; }
        .shared-toast-error { background: #ef4444; color: white; }
        .shared-toast-info { background: #3b82f6; color: white; }
        .shared-toast-warning { background: #f59e0b; color: white; }
        @keyframes toast-slide-in { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      `;
      document.head.appendChild(style);
    }

    document.body.appendChild(toast);

    // Auto-dismiss
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(20px)';
      toast.style.transition = 'all 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  // === StateRenderer (unified error/empty/loading states) ===

  /**
   * Standard error types for consistent UX across all surfaces
   * S12: Error & Empty State Polish
   * S13: Graceful Degradation - added SERVICE_UNAVAILABLE, TIMEOUT
   */
  const ERROR_TYPES = {
    EVENT_NOT_FOUND: 'event_not_found',
    NO_DATA: 'no_data',
    NETWORK_ERROR: 'network_error',
    UNAUTHORIZED: 'unauthorized',
    SERVICE_UNAVAILABLE: 'service_unavailable',
    TIMEOUT: 'timeout',
    GENERIC: 'generic'
  };

  /**
   * Maps raw error messages/codes to user-friendly error types
   * Prevents leaking internal details (JSON, stack traces, etc.)
   * S13: Added SERVICE_UNAVAILABLE, TIMEOUT detection
   *
   * @param {string|Error|Object} error - Raw error message, Error object, or {code, message}
   * @returns {string} User-friendly error type from ERROR_TYPES
   */
  function classifyError(error) {
    // Handle error objects with code property (from NU.safeRpc)
    const code = String(error?.code || '').toUpperCase();
    const msg = String(error?.message || error || '').toLowerCase();

    // Check error codes first (most reliable)
    if (code === 'SERVICE_UNAVAILABLE' || code === 'INTERNAL') {
      return ERROR_TYPES.SERVICE_UNAVAILABLE;
    }
    if (code === 'TIMEOUT') {
      return ERROR_TYPES.TIMEOUT;
    }
    if (code === 'NOT_FOUND') {
      return ERROR_TYPES.EVENT_NOT_FOUND;
    }
    if (code === 'UNAUTHORIZED') {
      return ERROR_TYPES.UNAUTHORIZED;
    }
    if (code === 'NETWORK_ERROR') {
      return ERROR_TYPES.NETWORK_ERROR;
    }

    // Fallback to message-based detection
    if (msg.includes('not found') || msg.includes('404') || msg.includes('invalid') || msg.includes('no event')) {
      return ERROR_TYPES.EVENT_NOT_FOUND;
    }
    if (msg.includes('unauthorized') || msg.includes('403') || msg.includes('permission')) {
      return ERROR_TYPES.UNAUTHORIZED;
    }
    if (msg.includes('service unavailable') || msg.includes('503') || msg.includes('temporary issue') || msg.includes('temporary problem')) {
      return ERROR_TYPES.SERVICE_UNAVAILABLE;
    }
    if (msg.includes('timeout') || msg.includes('504') || msg.includes('took too long') || msg.includes('timed out')) {
      return ERROR_TYPES.TIMEOUT;
    }
    if (msg.includes('network') || msg.includes('failed to fetch') || msg.includes('connection') || msg.includes('offline')) {
      return ERROR_TYPES.NETWORK_ERROR;
    }
    if (msg.includes('no data') || msg.includes('empty') || msg.includes('nothing')) {
      return ERROR_TYPES.NO_DATA;
    }
    return ERROR_TYPES.GENERIC;
  }

  /**
   * StateRenderer - Unified error/empty/loading state rendering
   * S12: Consistent UX across Public, Display, Poster, SharedReport, Admin
   */
  const StateRenderer = {
    // Expose error types for external use
    ERROR_TYPES,
    classifyError,

    /**
     * Render error state into a container
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { title, message, onRetry, hint, tvMode }
     */
    showError(container, options = {}) {
      const {
        title = 'Something Went Wrong',
        message = 'Please try again.',
        onRetry = null,
        hint = null,
        tvMode = false
      } = options;

      const stateClass = tvMode ? 'error-state-tv' : 'error-state';
      const iconClass = tvMode ? 'error-icon' : 'error-state-icon';

      container.innerHTML = `
        <div class="${stateClass}">
          <div class="${iconClass}">⚠️</div>
          <h3>${esc(title)}</h3>
          <p>${esc(message)}</p>
          ${hint ? `<p style="font-size: 0.85rem; color: ${tvMode ? '#9ca3af' : '#991b1b'}; margin-top: 8px;">${esc(hint)}</p>` : ''}
          ${onRetry ? '<button class="btn-retry">🔄 Try Again</button>' : ''}
        </div>
      `;
      if (onRetry) {
        container.querySelector('.btn-retry')?.addEventListener('click', onRetry);
      }
    },

    /**
     * Render empty state into a container
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { icon, title, message, hint, backUrl, backLabel, tvMode }
     */
    showEmpty(container, options = {}) {
      const {
        icon = '📭',
        title = 'Nothing Here',
        message = '',
        hint = null,
        backUrl = null,
        backLabel = '← Go Back',
        tvMode = false
      } = options;

      const stateClass = tvMode ? 'error-state-tv' : 'empty-state';
      const iconClass = tvMode ? 'error-icon' : 'empty-state-icon';

      container.innerHTML = `
        <div class="${stateClass}">
          <div class="${iconClass}">${icon}</div>
          <h3>${esc(title)}</h3>
          ${message ? `<p>${esc(message)}</p>` : ''}
          ${hint ? `<p style="font-size: 0.85rem; color: #94a3b8; margin-top: 12px;">${esc(hint)}</p>` : ''}
          ${backUrl ? `<a href="${esc(backUrl)}" class="btn-secondary">${esc(backLabel)}</a>` : ''}
        </div>
      `;
    },

    /**
     * Render loading state into a container
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { message }
     */
    showLoading(container, options = {}) {
      const { message = 'Loading...' } = options;
      container.innerHTML = `
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p>${esc(message)}</p>
        </div>
      `;
    },

    // === Convenience Methods for Common Scenarios (S12) ===

    /**
     * Show "Event Not Found" state
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { backUrl, tvMode }
     */
    showEventNotFound(container, options = {}) {
      const { backUrl = null, tvMode = false } = options;
      this.showEmpty(container, {
        icon: '🔍',
        title: 'Event Not Found',
        message: 'We couldn\'t find this event. The link may be outdated, the event ID might be incorrect, or the event may have been removed.',
        hint: 'Double-check the URL or return to the events list to find what you\'re looking for.',
        backUrl,
        backLabel: '← View All Events',
        tvMode
      });
    },

    /**
     * Show "No Data Yet" state
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { context, backUrl, tvMode }
     */
    showNoData(container, options = {}) {
      const { context = 'content', backUrl = null, tvMode = false } = options;
      const contextMessages = {
        events: 'Check back soon for new events, or contact the organizer for more information.',
        sponsors: 'No sponsors to display yet. Sponsor information will appear here once configured.',
        schedule: 'The event schedule will appear here once it\'s available.',
        standings: 'Standings will appear here once the competition begins.',
        analytics: 'Once attendees start interacting with your content, you\'ll see engagement data here.',
        content: 'This event exists but doesn\'t have any content to display yet. Check back soon!'
      };
      this.showEmpty(container, {
        icon: '📭',
        title: 'No Data Yet',
        message: contextMessages[context] || contextMessages.content,
        backUrl,
        tvMode
      });
    },

    /**
     * Show network/connection error state
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { onRetry, tvMode }
     */
    showNetworkError(container, options = {}) {
      const { onRetry = null, tvMode = false } = options;
      this.showError(container, {
        title: 'Connection Problem',
        message: 'We\'re having trouble connecting right now. This might be a temporary issue.',
        hint: 'Please check your internet connection and try again.',
        onRetry,
        tvMode
      });
    },

    /**
     * Show unauthorized/permission error state
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { backUrl, tvMode }
     */
    showUnauthorized(container, options = {}) {
      const { backUrl = null, tvMode = false } = options;
      this.showError(container, {
        title: 'Access Denied',
        message: 'You don\'t have permission to view this content.',
        hint: 'Please check that you have the correct access link.',
        onRetry: null,
        tvMode
      });
    },

    /**
     * Show temporary service issue state (S13: Graceful Degradation)
     * For 5xx errors from upstream, temporary outages, etc.
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { onRetry, tvMode, corrId }
     */
    showTemporaryIssue(container, options = {}) {
      const { onRetry = null, tvMode = false, corrId = null } = options;
      this.showError(container, {
        title: 'Temporary Issue',
        message: 'We\'re having a temporary issue loading this event.',
        hint: corrId
          ? `Please refresh or try again in a minute. (Ref: ${esc(corrId)})`
          : 'Please refresh or try again in a minute.',
        onRetry,
        tvMode
      });
    },

    /**
     * Show timeout error state (S13: Graceful Degradation)
     * For requests that took too long
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { onRetry, tvMode }
     */
    showTimeout(container, options = {}) {
      const { onRetry = null, tvMode = false } = options;
      this.showError(container, {
        title: 'Taking Too Long',
        message: 'The page is taking longer than expected to load.',
        hint: 'This might be a temporary issue. Please try again.',
        onRetry,
        tvMode
      });
    },

    /**
     * Auto-detect error type and show appropriate state
     * S13: Updated to handle SERVICE_UNAVAILABLE, TIMEOUT
     *
     * @param {HTMLElement} container - Target container
     * @param {string|Error|Object} error - Raw error, Error object, or {code, message, corrId}
     * @param {Object} options - { onRetry, backUrl, tvMode }
     */
    showFromError(container, error, options = {}) {
      const { onRetry = null, backUrl = null, tvMode = false } = options;
      const errorType = classifyError(error);
      const corrId = error?.corrId || null;

      switch (errorType) {
        case ERROR_TYPES.EVENT_NOT_FOUND:
          this.showEventNotFound(container, { backUrl, tvMode });
          break;
        case ERROR_TYPES.NO_DATA:
          this.showNoData(container, { backUrl, tvMode });
          break;
        case ERROR_TYPES.NETWORK_ERROR:
          this.showNetworkError(container, { onRetry, tvMode });
          break;
        case ERROR_TYPES.UNAUTHORIZED:
          this.showUnauthorized(container, { backUrl, tvMode });
          break;
        case ERROR_TYPES.SERVICE_UNAVAILABLE:
          this.showTemporaryIssue(container, { onRetry, tvMode, corrId });
          break;
        case ERROR_TYPES.TIMEOUT:
          this.showTimeout(container, { onRetry, tvMode });
          break;
        default:
          this.showError(container, {
            title: 'Something Went Wrong',
            message: 'We couldn\'t load this content right now. This might be a temporary issue.',
            hint: corrId
              ? `Please try again in a moment. (Ref: ${esc(corrId)})`
              : 'Please try again in a moment.',
            onRetry,
            tvMode
          });
      }
    }
  };

  // === EVENT_CONTRACT.md v2.0 Support ===

  /**
   * Checks if an event section is enabled via settings
   * Extracted from Display.html and Poster.html (D-008)
   * Trust the contract - never invent flags
   *
   * Feature 4: Template-Aware Section Toggles - added showVideo, showMap, showGallery
   *
   * @param {Object} settings - Event settings object
   * @param {string} key - Section key: 'schedule', 'standings', 'bracket', 'sponsors', 'video', 'map', 'gallery'
   * @returns {boolean} True if section is enabled
   */
  function sectionEnabled(settings, key) {
    if (!settings) return false;
    switch (key) {
      // Data sections (require explicit true)
      case 'schedule': return settings.showSchedule === true;
      case 'standings': return settings.showStandings === true;
      case 'bracket': return settings.showBracket === true;
      case 'sponsors': return settings.showSponsors === true;
      // Content sections (default true for backwards compat - Feature 4)
      case 'video': return settings.showVideo !== false;
      case 'map': return settings.showMap !== false;
      case 'gallery': return settings.showGallery !== false;
      default: return false;
    }
  }

  // === Public API ===
  return {
    // Alerts
    showAlert,

    // Toast (non-blocking)
    showToast,

    // State rendering (S12: Enhanced with convenience methods)
    StateRenderer,
    ERROR_TYPES,
    classifyError,

    // Date formatting
    formatDate,
    formatRelativeTime,

    // Form utilities
    validateForm,
    isValidEmail,
    isValidUrl,

    // Loading state
    withLoadingState,

    // DOM utilities
    toggleElement,
    showElement,
    hideElement,

    // XSS (delegates to NU.esc)
    esc,

    // Utility functions
    debounce,
    throttle,

    // EVENT_CONTRACT helpers
    sectionEnabled
  };
})();
</script>

  <!--
================================================================================
FooterComponent - Centralized Trust Footer
================================================================================
Extracted from: Display.html, Poster.html, Public.html, SharedReport.html
Purpose: Consistent "Powered by" footer across all MVP surfaces

Usage:
  include('FooterComponent')

Variants:
  - Default: Standard footer for light backgrounds
  - TV: Subtle footer for dark TV/display mode (use .site-footer-tv)
  - Print: Optimized for print media

DO NOT modify this component's structure without updating:
  - All MVP surfaces that include it
  - Design system documentation
================================================================================
-->
<style>
  /* ===== Trust Footer Component ===== */
  .site-footer {
    text-align: center;
    padding: 24px 16px;
    margin-top: 40px;
    border-top: 1px solid var(--color-gray-200, #e2e8f0);
    color: var(--color-gray-400, #94a3b8);
    font-size: 0.7rem;
  }

  .site-footer a {
    color: var(--color-gray-500, #64748b);
    text-decoration: none;
    transition: color var(--transition-fast, 0.15s ease);
  }

  .site-footer a:hover {
    color: var(--color-primary, #2563eb);
    text-decoration: underline;
  }

  /* TV Mode Variant (dark background) */
  .site-footer-tv,
  body[data-tv="1"] .site-footer {
    position: fixed;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    color: rgba(255, 255, 255, 0.3);
    font-size: 0.6rem;
    z-index: 100;
    padding: 0;
    margin: 0;
    border: none;
    background: transparent;
  }

  .site-footer-tv a,
  body[data-tv="1"] .site-footer a {
    color: rgba(255, 255, 255, 0.4);
  }

  .site-footer-tv a:hover,
  body[data-tv="1"] .site-footer a:hover {
    color: rgba(255, 255, 255, 0.6);
    text-decoration: none;
  }

  /* Print Styles */
  @media print {
    .site-footer {
      border-top: none;
      padding: 12px;
      font-size: 8pt;
      margin-top: 20px;
      page-break-inside: avoid;
    }

    .site-footer-tv {
      position: static;
      transform: none;
    }
  }
</style>

<!-- Default Footer Template (can be included or used as reference) -->
<template id="footer-template">
  <footer class="site-footer">
    <p>Powered by <a href="https://eventangle.com" target="_blank" rel="noopener">EventAngle</a></p>
  </footer>
</template>

  <!--
================================================================================
SpinnerComponent - Unified Loading Indicators
================================================================================
Extracted from: Styles.html spinner + loading patterns across pages
Purpose: Consistent loading states across all MVP surfaces

Usage:
  include('SpinnerComponent')

Then use classes:
  - .spinner: Standalone spinner animation
  - .loading-state: Full loading container with spinner + text
  - .spinner-inline: Small inline spinner for buttons
  - .btn-loading: Button loading state

DO NOT modify this component without updating:
  - All MVP surfaces that use loading states
  - Design system documentation
================================================================================
-->
<style>
  /* ===== Spinner Animation ===== */
  @keyframes spinner-rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Base Spinner */
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--color-gray-200, #e2e8f0);
    border-top-color: var(--color-primary, #2563eb);
    border-radius: 50%;
    animation: spinner-rotate 1s linear infinite;
  }

  /* Small Spinner (for inline use) */
  .spinner-sm {
    width: 20px;
    height: 20px;
    border-width: 2px;
  }

  /* Large Spinner (for full-page loading) */
  .spinner-lg {
    width: 60px;
    height: 60px;
    border-width: 5px;
  }

  /* Inline Spinner (for buttons/text) */
  .spinner-inline {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid currentColor;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spinner-rotate 0.8s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }

  /* ===== Loading State Container ===== */
  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-8, 2rem);
    text-align: center;
    color: var(--color-gray-500, #64748b);
    min-height: 200px;
  }

  .loading-state .spinner {
    margin-bottom: var(--space-4, 1rem);
  }

  .loading-state p {
    margin: 0;
    font-size: var(--font-size-sm, 0.875rem);
  }

  /* Compact Loading State */
  .loading-state.compact {
    min-height: 100px;
    padding: var(--space-4, 1rem);
  }

  .loading-state.compact .spinner {
    width: 30px;
    height: 30px;
    border-width: 3px;
  }

  /* ===== Button Loading State ===== */
  .btn-loading {
    position: relative;
    pointer-events: none;
    opacity: 0.8;
  }

  .btn-loading .btn-text {
    visibility: hidden;
  }

  .btn-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 18px;
    height: 18px;
    margin-top: -9px;
    margin-left: -9px;
    border: 2px solid currentColor;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spinner-rotate 0.8s linear infinite;
  }

  /* ===== Skeleton Loading ===== */
  .skeleton {
    background: linear-gradient(
      90deg,
      var(--color-gray-100, #f1f5f9) 25%,
      var(--color-gray-200, #e2e8f0) 50%,
      var(--color-gray-100, #f1f5f9) 75%
    );
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s ease-in-out infinite;
    border-radius: var(--radius-sm, 6px);
  }

  @keyframes skeleton-shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .skeleton-text {
    height: 1em;
    margin-bottom: 0.5em;
  }

  .skeleton-text:last-child {
    width: 70%;
  }

  .skeleton-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
  }

  .skeleton-card {
    height: 120px;
  }

  /* ===== Reduced Motion Support ===== */
  @media (prefers-reduced-motion: reduce) {
    .spinner,
    .spinner-inline,
    .btn-loading::after {
      animation-duration: 1.5s;
    }

    .skeleton {
      animation: none;
      background: var(--color-gray-200, #e2e8f0);
    }
  }
</style>

<script>
/**
 * SpinnerUtils - Programmatic loading state helpers
 */
window.SpinnerUtils = (function() {
  'use strict';

  /**
   * Set button to loading state
   * @param {HTMLButtonElement} button - Button element
   * @param {boolean} loading - Whether to show loading state
   */
  function setButtonLoading(button, loading = true) {
    if (!button) return;

    if (loading) {
      button.classList.add('btn-loading');
      button.disabled = true;
      button.dataset.originalText = button.innerHTML;
      const textSpan = button.querySelector('.btn-text');
      if (textSpan) textSpan.style.visibility = 'hidden';
    } else {
      button.classList.remove('btn-loading');
      button.disabled = false;
      if (button.dataset.originalText) {
        button.innerHTML = button.dataset.originalText;
        delete button.dataset.originalText;
      }
    }
  }

  /**
   * Create a spinner element
   * @param {string} size - 'sm', 'md', 'lg'
   * @returns {HTMLElement} Spinner element
   */
  function createSpinner(size = 'md') {
    const spinner = document.createElement('div');
    spinner.className = 'spinner';
    if (size === 'sm') spinner.classList.add('spinner-sm');
    if (size === 'lg') spinner.classList.add('spinner-lg');
    spinner.setAttribute('role', 'status');
    spinner.setAttribute('aria-label', 'Loading');
    return spinner;
  }

  /**
   * Create a full loading state container
   * @param {string} message - Loading message
   * @returns {HTMLElement} Loading state element
   */
  function createLoadingState(message = 'Loading...') {
    const container = document.createElement('div');
    container.className = 'loading-state';
    container.innerHTML = `
      <div class="spinner" role="status" aria-label="Loading"></div>
      <p>${message}</p>
    `;
    return container;
  }

  return {
    setButtonLoading,
    createSpinner,
    createLoadingState
  };
})();
</script>

  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="referrer" content="no-referrer"/>
  <style>
    /* SharedReport-specific styles (extends Styles.html) */

    /* Report Header - uses page-header-card pattern with gradient */
    .report-header {
      background: linear-gradient(135deg, var(--color-primary, #2563eb) 0%, var(--color-primary-dark, #1d4ed8) 100%);
      color: white;
      padding: 2rem;
      border-radius: var(--radius-md, 12px);
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-md, 0 4px 6px rgba(0, 0, 0, 0.1));
    }

    .report-header h1 {
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .report-header .subtitle {
      opacity: 0.9;
      font-size: var(--font-size-sm, 0.875rem); /* D-AUDIT: Using design token */
    }

    .report-header .report-context {
      opacity: 0.85;
      font-size: var(--font-size-xs, 0.75rem);
      margin-top: 0.5rem;
      max-width: 500px;
    }

    /* Override metrics-grid for 6-column layout (3x2) on desktop */
    @media (min-width: 1024px) {
      .metrics-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Section card extends .card from Styles.html */
    .section-card {
      background: white;
      border-radius: var(--radius-md, 12px);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-base, 0 1px 3px rgba(0,0,0,0.1));
      border: 1px solid var(--color-gray-200, #e2e8f0);
      border-left: 4px solid var(--color-primary, #2563eb);
    }

    .section-card h2 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      color: var(--color-gray-800, #1e293b);
      font-weight: 600;
    }

    .section-card .section-help {
      font-size: var(--font-size-sm, 0.875rem);
      color: var(--color-gray-500, #64748b);
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    /* Data Table - extends base table styles */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-size-sm, 0.875rem); /* D-AUDIT: Using design token */
    }

    .data-table thead {
      background: var(--color-gray-100, #f1f5f9);
    }

    .data-table th {
      padding: 0.75rem 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--color-gray-600, #475569);
      font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--color-gray-200, #e2e8f0);
    }

    .data-table td {
      padding: 1rem;
      border-bottom: 1px solid var(--color-gray-100, #f1f5f9);
    }

    .data-table tbody tr:hover {
      background: var(--color-gray-50, #f8fafc);
    }

    /* Surface/Placement description in table */
    .surface-desc {
      display: block;
      font-size: var(--font-size-xs, 0.75rem);
      color: var(--color-gray-500, #64748b);
      font-weight: normal;
      margin-top: 2px;
    }

    /* Sponsor table enhancements for tablet/laptop readability */
    .data-table.sponsor-table td {
      padding: 1rem 1.25rem;
    }

    .data-table.sponsor-table th {
      padding: 0.875rem 1.25rem;
    }

    /* Tablet-specific table improvements */
    @media (min-width: 641px) and (max-width: 1024px) {
      .data-table th,
      .data-table td {
        padding: 0.875rem;
        font-size: 0.9rem;
      }

      .data-table.sponsor-table td,
      .data-table.sponsor-table th {
        padding: 1rem;
      }
    }

    /* Tooltip styles for column headers */
    .th-with-tooltip {
      position: relative;
      cursor: help;
    }

    .th-with-tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--color-gray-800, #1e293b);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: normal;
      text-transform: none;
      letter-spacing: normal;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      z-index: 10;
      pointer-events: none;
    }

    .th-with-tooltip:hover::after {
      opacity: 1;
      visibility: visible;
    }

    /* Hide tooltips on mobile (touch devices) */
    @media (max-width: 640px) {
      .th-with-tooltip::after {
        display: none;
      }
    }

    /* Mobile: Stack table */
    @media (max-width: 640px) {
      .data-table thead { display: none; }
      .data-table, .data-table tbody, .data-table tr, .data-table td {
        display: block;
        width: 100%;
      }
      .data-table tr {
        margin-bottom: 1rem;
        background: white;
        border: 1px solid var(--color-gray-200, #e2e8f0);
        border-radius: var(--radius-base, 8px);
        padding: 0.75rem;
      }
      .data-table td {
        padding: 0.5rem 0;
        border: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .data-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--color-gray-500, #64748b);
        text-transform: uppercase;
        font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      }
    }

    /* Badges - compact variants */
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-full, 9999px);
      font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge.high { background: var(--color-danger-pale, #fef2f2); color: var(--color-danger, #dc2626); }
    .badge.medium, .badge.warning { background: var(--color-warning-pale, #fef3c7); color: var(--color-warning-dark, #d97706); }
    .badge.success { background: var(--color-success-pale, #d1fae5); color: var(--color-success, #10b981); }
    .badge.info { background: var(--color-primary-pale, #dbeafe); color: var(--color-primary, #2563eb); }

    /* Chart Placeholder */
    .chart-container {
      height: 300px;
      background: var(--color-gray-50, #f8fafc);
      border: 2px dashed var(--color-gray-300, #cbd5e1);
      border-radius: var(--radius-base, 8px);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-gray-400, #94a3b8);
      font-size: var(--font-size-sm, 0.875rem); /* D-AUDIT: Using design token */
    }

    /* Action Bar */
    .action-bar {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    /* Recommendations - alert-style cards */
    .recommendation {
      padding: 1rem;
      border-radius: var(--radius-base, 8px);
      margin-bottom: 0.75rem;
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }

    .recommendation.high { background: #fef2f2; border-left: 4px solid var(--color-danger, #dc2626); }
    .recommendation.medium { background: #fef3c7; border-left: 4px solid var(--color-warning, #f59e0b); }
    .recommendation.success { background: #ecfdf5; border-left: 4px solid var(--color-success, #10b981); }
    .recommendation.info { background: #eff6ff; border-left: 4px solid var(--color-primary, #2563eb); }

    .recommendation-icon { font-size: var(--font-size-2xl, 1.5rem); } /* D-AUDIT: Using design token */
    .recommendation-content { flex: 1; }
    .recommendation-content .title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      letter-spacing: 0.05em;
    }

    /* Loading state - uses .loading-state from Styles.html but custom spinner */
    .loading {
      text-align: center;
      padding: 3rem 1rem;
    }

    /* Metrics grid override for this page */
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    @media (min-width: 640px) {
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (min-width: 1024px) {
      .metrics-grid { grid-template-columns: repeat(3, 1fr); }
    }

    /* Metric card overrides for SharedReport */
    .metrics-grid .metric-card .label {
      font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      color: var(--color-gray-500, #64748b);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .metrics-grid .metric-card .value {
      font-size: var(--font-size-4xl, 2.25rem); /* D-AUDIT: Aligned to type scale from 2rem */
      font-weight: 700;
      color: var(--color-gray-900, #0f172a);
      margin-bottom: 0.25rem;
    }

    .metrics-grid .metric-card .trend {
      font-size: var(--font-size-sm, 0.875rem); /* D-AUDIT: Using design token */
      color: var(--color-success, #10b981);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .metrics-grid .metric-card .trend.negative {
      color: var(--color-danger, #ef4444);
    }

    .metrics-grid .metric-card .sublabel {
      font-size: var(--font-size-xs, 0.75rem);
      color: var(--color-gray-400, #94a3b8);
      margin-top: 0.25rem;
    }

    /* === MVP Essential: Empty/Error States === */
    .empty-state, .error-state {
      text-align: center;
      padding: 48px 24px;
      max-width: 500px;
      margin: 40px auto;
    }
    .empty-state-icon, .error-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.6;
    }
    .empty-state h3, .error-state h3 {
      color: var(--color-gray-700, #374151);
      margin-bottom: 8px;
      font-size: 1.25rem;
    }
    .empty-state p, .error-state p {
      color: var(--color-gray-500, #6b7280);
      margin-bottom: 16px;
      line-height: 1.6;
    }
    .error-state {
      background: #fef2f2;
      border-radius: var(--radius-md, 12px);
      border: 1px solid #fecaca;
    }
    .error-state h3 { color: #dc2626; }
    .error-state p { color: #b91c1c; }
    /* .btn-retry - Now centralized in Styles.html (C-001) */
    /* .site-footer - Now centralized in FooterComponent.html (D-005) */

    /* Feature 5: Top Event / Top Sponsor Callout Cards */
    .top-callout {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
      border-radius: var(--radius-md, 12px);
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
    }
    .top-callout.event {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }
    .top-callout .callout-icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }
    .top-callout .callout-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #92400e;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .top-callout.event .callout-label {
      color: #1e40af;
    }
    .top-callout .callout-name {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }
    .top-callout .callout-stats {
      display: flex;
      justify-content: center;
      gap: 16px;
      font-size: 0.875rem;
      color: #64748b;
    }
    .top-callout .callout-stats strong {
      color: #1e293b;
    }
    @media (max-width: 640px) {
      #topCallouts { grid-template-columns: 1fr !important; }
    }

    /* ===== Mobile-First SharedReport Enhancements ===== */
    @media (max-width: 640px) {
      /* Container mobile padding */
      .container {
        padding: 12px;
      }

      /* Report header mobile */
      .report-header {
        padding: 1.25rem;
        border-radius: 8px;
        margin-bottom: 1rem;
      }

      .report-header h1 {
        font-size: 1.3rem;
        line-height: 1.3;
        word-wrap: break-word;
      }

      .report-header .subtitle {
        font-size: 0.8rem;
        line-height: 1.4;
      }

      .report-header .report-context {
        font-size: 0.7rem;
        margin-top: 0.5rem;
        line-height: 1.5;
      }

      /* Action bar mobile */
      .action-bar {
        flex-direction: column;
        gap: 8px;
        margin-bottom: 1rem;
      }

      .action-bar .btn {
        width: 100%;
        justify-content: center;
        padding: 14px 16px;
        min-height: 48px;
      }

      /* Metrics grid mobile */
      .metrics-grid {
        gap: 10px;
        margin-bottom: 1rem;
      }

      .metrics-grid .metric-card {
        padding: 14px;
      }

      .metrics-grid .metric-card .label {
        font-size: 0.7rem;
      }

      .metrics-grid .metric-card .value {
        font-size: 1.75rem;
      }

      /* Section cards mobile */
      .section-card {
        padding: 14px;
        margin-bottom: 1rem;
        border-radius: 8px;
      }

      .section-card h2 {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
      }

      .section-card .section-help {
        font-size: 0.75rem;
        margin-bottom: 0.75rem;
        line-height: 1.4;
      }

      /* Metric sublabels mobile */
      .metrics-grid .metric-card .sublabel {
        font-size: 0.65rem;
      }

      /* Surface descriptions mobile */
      .surface-desc {
        font-size: 0.65rem;
        margin-top: 4px;
      }

      /* Top callouts mobile */
      .top-callout {
        padding: 14px;
        border-radius: 10px;
      }

      .top-callout .callout-icon {
        font-size: 1.5rem;
      }

      .top-callout .callout-name {
        font-size: 1rem;
      }

      .top-callout .callout-stats {
        flex-direction: column;
        gap: 6px;
        font-size: 0.8rem;
      }

      /* Top sponsors card mobile */
      .top-sponsors-card {
        padding: 14px;
        border-radius: 10px;
        margin-bottom: 1rem;
      }

      .top-sponsors-card h3 {
        font-size: 0.9rem;
        margin-bottom: 12px;
      }

      .top-sponsors-list {
        gap: 10px;
      }

      .top-sponsor-item {
        padding: 10px 12px;
        border-radius: 6px;
      }

      .top-sponsor-rank {
        font-size: 1.1rem;
        margin-right: 10px;
      }

      .top-sponsor-name {
        font-size: 0.9rem;
      }

      .top-sponsor-metric {
        font-size: 0.8rem;
      }

      /* Empty/Error states mobile */
      .empty-state, .error-state {
        padding: 32px 16px;
        margin: 24px auto;
      }

      .empty-state-icon, .error-state-icon {
        font-size: 2.5rem;
      }

      .empty-state h3, .error-state h3 {
        font-size: 1.1rem;
      }

      .error-state .btn-retry {
        width: 100%;
        padding: 14px 16px;
      }

      /* Badges mobile */
      .badge {
        padding: 0.2rem 0.5rem;
        font-size: 0.65rem;
      }

      /* Modal mobile */
      #sponsorQrModal > div {
        max-width: 90%;
        margin: 16px;
      }

      /* Footer mobile */
      .site-footer {
        padding: 16px;
        margin-top: 24px;
      }
    }

    /* Very small screens (iPhone SE, etc.) */
    @media (max-width: 375px) {
      .container {
        padding: 8px;
      }

      .report-header {
        padding: 1rem;
      }

      .report-header h1 {
        font-size: 1.15rem;
      }

      .metrics-grid .metric-card .value {
        font-size: 1.5rem;
      }

      .section-card {
        padding: 12px;
      }

      .section-card h2 {
        font-size: 1rem;
      }
    }

    /* Top Sponsors Card - Highlights top performers by clicks */
    .top-sponsors-card {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border: 2px solid var(--color-success, #10b981);
      border-radius: var(--radius-md, 12px);
      padding: 20px;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
    }
    .top-sponsors-card h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #065f46;
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .top-sponsors-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .top-sponsor-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      border-radius: var(--radius-base, 8px);
      padding: 12px 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }
    .top-sponsor-rank {
      font-size: 1.25rem;
      margin-right: 12px;
    }
    .top-sponsor-name {
      flex: 1;
      font-weight: 600;
      color: var(--color-gray-800, #1e293b);
    }
    .top-sponsor-metric {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: var(--font-size-sm, 0.875rem);
      color: var(--color-gray-600, #475569);
    }
    .top-sponsor-metric .clicks-value {
      font-weight: 700;
      color: var(--color-success, #10b981);
    }
    .top-sponsor-metric .ctr-badge {
      background: var(--color-success-pale, #d1fae5);
      color: #065f46;
      padding: 2px 8px;
      border-radius: var(--radius-full, 9999px);
      font-size: var(--font-size-xs, 0.75rem);
      font-weight: 600;
    }
    @media (max-width: 640px) {
      .top-sponsor-item {
        flex-wrap: wrap;
        gap: 8px;
      }
      .top-sponsor-metric {
        width: 100%;
        justify-content: flex-end;
      }
    }

    /* Sponsor Funnel Card - Story 11: At-a-glance funnel metrics for sponsors */
    .sponsor-funnel-card {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border: 2px solid var(--color-primary, #2563eb);
      border-radius: var(--radius-md, 12px);
      padding: 20px;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
    }
    .sponsor-funnel-card h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #1e40af;
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sponsor-funnel-card .funnel-subtitle {
      font-size: 0.75rem;
      color: #3b82f6;
      font-weight: normal;
      margin-left: auto;
    }
    .funnel-stages {
      display: flex;
      align-items: stretch;
      gap: 0;
      position: relative;
    }
    .funnel-stage {
      flex: 1;
      background: white;
      padding: 16px 12px;
      text-align: center;
      position: relative;
      border: 1px solid #e2e8f0;
      min-width: 0;
    }
    .funnel-stage:first-child {
      border-radius: 8px 0 0 8px;
    }
    .funnel-stage:last-child {
      border-radius: 0 8px 8px 0;
    }
    .funnel-stage:not(:last-child)::after {
      content: '→';
      position: absolute;
      right: -12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.25rem;
      color: #3b82f6;
      z-index: 1;
      background: white;
      width: 24px;
      text-align: center;
    }
    .funnel-stage .stage-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .funnel-stage .stage-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
      line-height: 1.2;
    }
    .funnel-stage .stage-rate {
      font-size: 0.7rem;
      color: #10b981;
      font-weight: 600;
      margin-top: 4px;
    }
    .funnel-stage .stage-rate.neutral {
      color: #64748b;
    }
    /* Funnel summary row */
    .funnel-summary {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px dashed #bfdbfe;
    }
    .funnel-summary-item {
      text-align: center;
    }
    .funnel-summary-item .summary-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
      margin-bottom: 2px;
    }
    .funnel-summary-item .summary-value {
      font-size: 1rem;
      font-weight: 700;
      color: #1e40af;
    }
    /* Funnel empty state */
    .funnel-empty-state {
      text-align: center;
      padding: 24px 16px;
      color: #64748b;
    }
    .funnel-empty-state .empty-icon {
      font-size: 2rem;
      margin-bottom: 8px;
      opacity: 0.5;
    }
    .funnel-empty-state p {
      margin: 0;
      font-size: 0.875rem;
    }
    /* Funnel card mobile responsive */
    @media (max-width: 640px) {
      .sponsor-funnel-card {
        padding: 14px;
        border-radius: 10px;
        margin-bottom: 1rem;
      }
      .sponsor-funnel-card h3 {
        font-size: 0.9rem;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
      .sponsor-funnel-card .funnel-subtitle {
        width: 100%;
        margin-left: 0;
        margin-top: 4px;
      }
      .funnel-stages {
        flex-direction: column;
        gap: 8px;
      }
      .funnel-stage {
        border-radius: 8px !important;
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-align: left;
      }
      .funnel-stage:not(:last-child)::after {
        content: '↓';
        position: static;
        transform: none;
        order: -1;
        display: none;
      }
      .funnel-stage .stage-label {
        margin-bottom: 0;
        font-size: 0.75rem;
      }
      .funnel-stage .stage-value {
        font-size: 1.25rem;
      }
      .funnel-stage .stage-rate {
        margin-top: 0;
        margin-left: 8px;
        font-size: 0.75rem;
      }
      .funnel-stage .mobile-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .funnel-summary {
        flex-wrap: wrap;
        gap: 16px;
      }
      .funnel-summary-item .summary-value {
        font-size: 0.9rem;
      }
    }
    /* Very small screens */
    @media (max-width: 375px) {
      .sponsor-funnel-card {
        padding: 12px;
      }
      .funnel-stage {
        padding: 10px;
      }
      .funnel-stage .stage-value {
        font-size: 1.1rem;
      }
      .funnel-summary {
        gap: 12px;
      }
    }

    /* ===== Collapsible Detail Sections (Story 12) ===== */
    .detail-section .section-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      text-align: left;
      margin-bottom: 0.5rem;
    }
    .detail-section .section-toggle h2 {
      margin: 0;
      pointer-events: none;
    }
    .detail-section .section-toggle .toggle-icon {
      font-size: 0.75rem;
      color: var(--color-gray-400, #94a3b8);
      transition: transform 0.2s ease;
      margin-left: 8px;
    }
    .detail-section .section-toggle:hover .toggle-icon {
      color: var(--color-primary, #2563eb);
    }
    .detail-section .section-toggle:focus {
      outline: 2px solid var(--color-primary, #2563eb);
      outline-offset: 2px;
      border-radius: 4px;
    }
    /* Collapsed state */
    .detail-section.collapsed .section-content {
      display: none;
    }
    .detail-section.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }
    .detail-section.collapsed .section-help {
      display: none;
    }
    /* Expanded state - add subtle indicator */
    .detail-section:not(.collapsed) {
      border-left-color: var(--color-success, #10b981);
    }
    .detail-section:not(.collapsed) .toggle-icon {
      transform: rotate(0deg);
      color: var(--color-success, #10b981);
    }
    /* Collapsed preview hint */
    .detail-section.collapsed::after {
      content: 'Tap to show details';
      display: block;
      font-size: 0.75rem;
      color: var(--color-gray-400, #94a3b8);
      text-align: center;
      padding: 8px 0;
      font-style: italic;
    }

    /* ===== Table Scroll Wrapper for Mobile ===== */
    .table-scroll-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    /* Show scroll indicator on mobile */
    @media (max-width: 640px) {
      .table-scroll-wrapper {
        margin: 0 -14px;
        padding: 0 14px;
        width: calc(100% + 28px);
      }
      /* Restore normal table display on mobile for card-style layout */
      .table-scroll-wrapper .data-table {
        min-width: auto;
      }
    }
    /* Desktop/tablet: allow horizontal scroll if table overflows */
    @media (min-width: 641px) {
      .table-scroll-wrapper .data-table {
        min-width: 500px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="report-header">
      <h1 id="reportTitle">📊 Your Sponsorship Performance</h1>
      <p class="subtitle" id="reportSubtitle">See how your brand is performing across events</p>
      <p class="subtitle report-context" id="reportContext">Track impressions, clicks, and engagement from all your sponsored placements in one place.</p>
      <p class="subtitle" id="lastUpdated">Loading...</p>
    </div>

    <!-- Action Bar (MVP: Refresh only) -->
    <div class="action-bar">
      <button id="refreshBtn" class="btn btn-primary" onclick="loadReport()">
        <span class="btn-text">🔄 Refresh Data</span>
      </button>
      <!-- V2 features removed from MVP: Export, Filters, Portfolio Mode -->
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Loading analytics data...</p>
    </div>

    <!-- Key Metrics -->
    <div id="metrics" style="display:none;">
      <!-- Sponsor Funnel Card - Story 11: At-a-glance funnel for sponsors -->
      <div id="sponsorFunnelCard"></div>

      <div class="metrics-grid" id="metricsGrid"></div>

      <!-- Top Sponsors Card - Highlights top 3 sponsors by clicks -->
      <div id="topSponsorsCard" style="display:none;"></div>

      <!-- Feature 5: Top Event / Top Sponsor Callouts -->
      <div id="topCallouts" class="metrics-grid" style="grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;"></div>

      <!-- Surface Performance (Ad Placements) - Collapsible detail section -->
      <div class="section-card detail-section collapsed" id="surfacePerformanceCard">
        <button class="section-toggle" onclick="toggleDetailSection('surfacePerformanceCard')" aria-expanded="false">
          <h2>🌐 Where seen</h2>
          <span class="toggle-icon">▼</span>
        </button>
        <p class="section-help">Which placements got the most engagement — posters, screens, pages, or forms.</p>
        <div class="section-content">
          <div class="table-scroll-wrapper">
            <div id="surfacePerformance"></div>
          </div>
        </div>
      </div>

      <!-- Sponsor Performance - Collapsible detail section -->
      <div class="section-card detail-section collapsed" id="sponsorPerformanceCard">
        <button class="section-toggle" onclick="toggleDetailSection('sponsorPerformanceCard')" aria-expanded="false">
          <h2>🏢 By sponsor</h2>
          <span class="toggle-icon">▼</span>
        </button>
        <p class="section-help" id="sponsorHelpText">See how each sponsor is performing. Click Rate shows what percentage of viewers clicked.</p>
        <div class="section-content">
          <div class="table-scroll-wrapper">
            <div id="sponsorPerformance"></div>
          </div>
        </div>
      </div>

      <!-- Event Performance - Collapsible detail section -->
      <div class="section-card detail-section collapsed" id="eventPerformanceCard" style="display:none;">
        <button class="section-toggle" onclick="toggleDetailSection('eventPerformanceCard')" aria-expanded="false">
          <h2>🎉 By event</h2>
          <span class="toggle-icon">▼</span>
        </button>
        <p class="section-help">See which events drove the most engagement and signups.</p>
        <div class="section-content">
          <div class="table-scroll-wrapper">
            <div id="eventPerformance"></div>
          </div>
        </div>
      </div>

      <!-- V2 HIDDEN: ROI, Daily Trends, Recommendations require backend work -->
      <!-- Sections removed to keep MVP honest -->
    </div>

    <!-- S12: Error State container (dynamically rendered by StateRenderer) -->
    <div id="errorState" style="display:none;"></div>
  </div>

  <!-- Trust Footer -->
  <footer class="site-footer">
    <p>Powered by <a href="https://eventangle.com" target="_blank" rel="noopener">EventAngle</a></p>
  </footer>

  <script>
    const BRAND_ID = '<?= brandId ?>';

    // URL parameters control whether this is a sponsor-scoped view (MVP)
    const urlParams = new URLSearchParams(window.location.search);
    const IS_SPONSOR_VIEW = urlParams.get('sponsor') === 'true';
    const SPONSOR_ID = urlParams.get('sponsorId') || '';
    const EVENT_ID = urlParams.get('eventId') || '';

    // Update header based on view type (MVP: sponsor view or organizer view)
    function updateHeaderForView(sponsorName) {
      const titleEl = document.getElementById('reportTitle');
      const subtitleEl = document.getElementById('reportSubtitle');
      const contextEl = document.getElementById('reportContext');

      if (IS_SPONSOR_VIEW) {
        // Sponsor-specific view: personalized and welcoming
        if (titleEl) {
          titleEl.textContent = '📊 Your Sponsorship Report';
        }
        if (subtitleEl) {
          subtitleEl.textContent = '';
          if (sponsorName) {
            subtitleEl.appendChild(document.createTextNode('Performance metrics for '));
            const strong = document.createElement('strong');
            strong.textContent = sponsorName;
            subtitleEl.appendChild(strong);
          } else if (SPONSOR_ID) {
            subtitleEl.textContent = 'Performance metrics for ' + SPONSOR_ID;
          } else {
            subtitleEl.textContent = 'See how your brand is performing';
          }
        }
        if (contextEl) {
          contextEl.textContent = 'This report shows how attendees are engaging with your sponsored content across all event touchpoints.';
        }
      } else {
        // Organizer view: overview of all sponsors
        if (titleEl) {
          titleEl.textContent = '📊 Sponsor Performance Dashboard';
        }
        if (subtitleEl) {
          subtitleEl.textContent = 'Track how sponsors are performing across your events';
        }
        if (contextEl) {
          contextEl.textContent = 'Monitor impressions, clicks, and engagement for all sponsor placements. Share individual reports with sponsors via QR code.';
        }
      }
    }

    // Backwards compatibility alias
    function updateHeaderForSponsorView(sponsorName) {
      updateHeaderForView(sponsorName);
    }

    // Initialize header on page load
    updateHeaderForView(null);

    /**
     * Expected API contract (envelope omitted) - MVP SharedAnalytics shape:
     *
     * Shared report (organizer):
     * {
     *   lastUpdatedISO: string,
     *   summary: {
     *     totalImpressions: number,
     *     totalClicks: number,
     *     totalQrScans: number,
     *     totalSignups: number,
     *     uniqueEvents: number,
     *     uniqueSponsors: number
     *   },
     *   surfaces: [
     *     { id, label, impressions, clicks, qrScans, engagementRate }
     *   ],
     *   sponsors?: [
     *     { id, name, impressions, clicks, ctr }
     *   ],
     *   events?: [
     *     { id, name, impressions, clicks, ctr, signupsCount }
     *   ]
     * }
     *
     * Sponsor view:
     * - Same shape, but summary/surfaces are scoped to that sponsor.
     */
    async function loadReport() {
      toggleLoading(true);

      let rpcName, payload;

      // MVP endpoints: api_getSponsorAnalytics (sponsor view) or api_getSharedAnalytics (organizer view)
      if (IS_SPONSOR_VIEW && SPONSOR_ID) {
        rpcName = 'api_getSponsorAnalytics';
        payload = { brandId: BRAND_ID, sponsorId: SPONSOR_ID, eventId: EVENT_ID || null };
      } else {
        rpcName = 'api_getSharedAnalytics';
        payload = { brandId: BRAND_ID };
      }

      // S13: Use safeRpc for graceful error handling
      const result = await NU.safeRpc(rpcName, payload);

      if (!result || !result.ok) {
        console.error('SharedReport load error', result.code, result.message);
        // S13: Pass error object for proper classification (SERVICE_UNAVAILABLE, TIMEOUT, etc.)
        showError(result);
        return;
      }

      renderReport(result.value || {});
      toggleLoading(false);
    }

    function toggleLoading(isLoading) {
      document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
      document.getElementById('metrics').style.display = isLoading ? 'none' : 'block';
      document.getElementById('errorState').style.display = 'none';
    }

    // S12/S13: Use shared StateRenderer for consistent error handling
    // Accepts either a message string or an error object from safeRpc
    function showError(messageOrError) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('metrics').style.display = 'none';

      const errorContainer = document.getElementById('errorState');
      const { StateRenderer } = SharedUtils;

      // S13: Handle error objects from safeRpc (has code/message properties)
      const message = messageOrError?.message || String(messageOrError || '');

      // Handle portfolio-specific messages (already user-friendly)
      if (message && String(message).toLowerCase().includes('portfolio')) {
        StateRenderer.showError(errorContainer, {
          title: 'Unable to Load Report',
          message: message,
          hint: 'Please try again in a moment.',
          onRetry: loadReport
        });
      } else {
        // S13: Use StateRenderer's auto-detection which handles SERVICE_UNAVAILABLE, TIMEOUT, etc.
        // Pass the full error object for proper classification
        StateRenderer.showFromError(errorContainer, messageOrError, {
          onRetry: loadReport
        });
      }

      errorContainer.style.display = 'block';
    }

    /**
     * Toggle collapsible detail section
     * @param {string} sectionId - The ID of the section to toggle
     */
    function toggleDetailSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (!section) return;

      const isCollapsed = section.classList.contains('collapsed');
      const toggleBtn = section.querySelector('.section-toggle');

      if (isCollapsed) {
        section.classList.remove('collapsed');
        if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'true');
      } else {
        section.classList.add('collapsed');
        if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'false');
      }
    }

    /**
     * Expand all detail sections (useful for printing or full view)
     */
    function expandAllDetailSections() {
      document.querySelectorAll('.detail-section.collapsed').forEach(section => {
        section.classList.remove('collapsed');
        const toggleBtn = section.querySelector('.section-toggle');
        if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'true');
      });
    }

    // Feature 5: Render Top Event / Top Sponsor Callouts (by highest CTR)
    function renderTopCallouts(events, sponsors) {
      const container = document.getElementById('topCallouts');
      let html = '';

      // Top Sponsor (by CTR) - show first per spec order
      if (sponsors && sponsors.length > 0) {
        const topSponsor = sponsors.reduce((a, b) => (b.ctr || 0) > (a.ctr || 0) ? b : a);
        html += `
          <div class="top-callout">
            <div class="callout-icon">⭐</div>
            <div class="callout-label">Top Sponsor</div>
            <div class="callout-name">${escapeHtml(topSponsor.name || topSponsor.id || 'Sponsor')} — ${(topSponsor.ctr || 0).toFixed(1)}% CTR</div>
          </div>
        `;
      }

      // Top Event (by CTR)
      if (events && events.length > 0) {
        const topEvent = events.reduce((a, b) => (b.ctr || 0) > (a.ctr || 0) ? b : a);
        html += `
          <div class="top-callout event">
            <div class="callout-icon">🏆</div>
            <div class="callout-label">Top Event</div>
            <div class="callout-name">${escapeHtml(topEvent.name || topEvent.id || 'Event')} — ${(topEvent.ctr || 0).toFixed(1)}% CTR</div>
          </div>
        `;
      }

      container.innerHTML = html;
      container.style.display = html ? '' : 'none';
    }

    // Render Top Sponsors Card - highlights top 3 sponsors by clicks
    function renderTopSponsorsCard(topSponsors) {
      const container = document.getElementById('topSponsorsCard');

      if (!topSponsors || !topSponsors.length) {
        container.style.display = 'none';
        return;
      }

      const rankEmojis = ['🥇', '🥈', '🥉'];
      const items = topSponsors.slice(0, 3).map(function(sponsor, index) {
        return `
          <div class="top-sponsor-item">
            <span class="top-sponsor-rank">${rankEmojis[index] || '#' + (index + 1)}</span>
            <span class="top-sponsor-name">${escapeHtml(sponsor.name || sponsor.id || 'Sponsor')}</span>
            <span class="top-sponsor-metric">
              <span class="clicks-value">${(sponsor.clicks || 0).toLocaleString()} clicks</span>
              <span class="ctr-badge">${(sponsor.ctr || 0).toFixed(1)}% CTR</span>
            </span>
          </div>
        `;
      }).join('');

      container.innerHTML = `
        <div class="top-sponsors-card">
          <h3>🏆 Top Sponsors</h3>
          <div class="top-sponsors-list">
            ${items}
          </div>
        </div>
      `;
      container.style.display = 'block';
    }

    /**
     * Story 11: Render Sponsor Funnel Card
     * Shows at-a-glance funnel metrics: Impressions → QR Scans → Clicks → Signups
     * with conversion rates between stages.
     *
     * @param {Object} summary - The summary object from SharedAnalytics
     */
    function renderSponsorFunnelCard(summary) {
      const container = document.getElementById('sponsorFunnelCard');
      if (!container) return;

      // Extract values with safe defaults
      const impressions = summary.totalImpressions || 0;
      const qrScans = summary.totalQrScans || 0;
      const clicks = summary.totalClicks || 0;
      const signups = summary.totalSignups || 0;

      // Check if there's any data at all
      const hasData = impressions > 0 || qrScans > 0 || clicks > 0 || signups > 0;

      if (!hasData) {
        // Empty state - clear message, not blanks or NaN
        container.innerHTML = `
          <div class="sponsor-funnel-card">
            <h3>📊 Engagement Funnel</h3>
            <div class="funnel-empty-state">
              <div class="empty-icon">📭</div>
              <p>No engagement data yet. Once attendees start interacting with your content, you'll see your funnel metrics here.</p>
            </div>
          </div>
        `;
        return;
      }

      // Calculate conversion rates (safe division - avoid NaN)
      // Scan Rate: QR scans as % of impressions
      const scanRate = impressions > 0 ? (qrScans / impressions * 100) : 0;
      // Click Rate (CTR): clicks as % of impressions
      const clickRate = impressions > 0 ? (clicks / impressions * 100) : 0;
      // Total interactions for conversion calc
      const totalInteractions = qrScans + clicks;
      // Conversion Rate: signups as % of total interactions (people who engaged)
      const conversionRate = totalInteractions > 0 ? (signups / totalInteractions * 100) : 0;
      // Overall funnel rate: signups as % of impressions
      const overallRate = impressions > 0 ? (signups / impressions * 100) : 0;

      // Format rate display - show % or "—" if zero impressions
      function formatRate(rate, label) {
        if (impressions === 0) return '<span class="stage-rate neutral">—</span>';
        return '<span class="stage-rate">' + rate.toFixed(1) + '% ' + label + '</span>';
      }

      // Determine subtitle based on view
      const subtitle = IS_SPONSOR_VIEW
        ? 'Your engagement journey'
        : 'Sponsor engagement overview';

      container.innerHTML = `
        <div class="sponsor-funnel-card">
          <h3>
            📊 Engagement Funnel
            <span class="funnel-subtitle">${subtitle}</span>
          </h3>
          <div class="funnel-stages">
            <div class="funnel-stage">
              <div class="stage-label">Impressions</div>
              <div class="stage-value">${impressions.toLocaleString()}</div>
              <div class="stage-rate neutral">Top of funnel</div>
            </div>
            <div class="funnel-stage">
              <div class="stage-label">QR Scans</div>
              <div class="stage-value">${qrScans.toLocaleString()}</div>
              ${formatRate(scanRate, 'scan rate')}
            </div>
            <div class="funnel-stage">
              <div class="stage-label">Clicks</div>
              <div class="stage-value">${clicks.toLocaleString()}</div>
              ${formatRate(clickRate, 'CTR')}
            </div>
            <div class="funnel-stage">
              <div class="stage-label">Signups</div>
              <div class="stage-value">${signups.toLocaleString()}</div>
              ${totalInteractions > 0 ? '<span class="stage-rate">' + conversionRate.toFixed(1) + '% conversion</span>' : '<span class="stage-rate neutral">—</span>'}
            </div>
          </div>
          <div class="funnel-summary">
            <div class="funnel-summary-item">
              <div class="summary-label">Overall CTR</div>
              <div class="summary-value">${impressions > 0 ? clickRate.toFixed(2) : '0.00'}%</div>
            </div>
            <div class="funnel-summary-item">
              <div class="summary-label">Total Interactions</div>
              <div class="summary-value">${totalInteractions.toLocaleString()}</div>
            </div>
            <div class="funnel-summary-item">
              <div class="summary-label">Funnel Rate</div>
              <div class="summary-value">${impressions > 0 ? overallRate.toFixed(2) : '0.00'}%</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderReport(data) {
      // Defensive defaults
      const summary = data.summary || {};
      const surfaces = Array.isArray(data.surfaces) ? data.surfaces : [];
      const sponsors = Array.isArray(data.sponsors) ? data.sponsors : [];
      const events = Array.isArray(data.events) ? data.events : [];
      const topSponsors = Array.isArray(data.topSponsors) ? data.topSponsors : [];

      // Update header with sponsor name if in sponsor view
      if (IS_SPONSOR_VIEW && sponsors.length > 0) {
        const sponsorName = sponsors[0].name || SPONSOR_ID;
        updateHeaderForSponsorView(sponsorName);
      }

      // Story 11: Render funnel card at the top for sponsor-first view
      renderSponsorFunnelCard(summary);

      renderSummaryMetrics(summary);

      // Render Top Sponsors Card (organizer view only, appears after metrics grid)
      if (!IS_SPONSOR_VIEW) {
        renderTopSponsorsCard(topSponsors);
      }

      renderSurfacePerformance(surfaces);

      // Feature 5: Render top callouts
      renderTopCallouts(events, sponsors);

      if (IS_SPONSOR_VIEW) {
        // In sponsor mode, focus on sponsor + event breakdown
        if (sponsors.length) {
          renderSponsorPerformance(sponsors);
        }
        if (events.length) {
          document.getElementById('eventPerformanceCard').style.display = 'block';
          renderEventPerformance(events);
        }
      } else {
        // Organizer view: show sponsors + events if present
        if (sponsors.length) {
          renderSponsorPerformance(sponsors);
        }
        if (events.length) {
          document.getElementById('eventPerformanceCard').style.display = 'block';
          renderEventPerformance(events);
        }
      }

      // Last updated label
      const lastUpdated = data.lastUpdatedISO || data.lastUpdated || null;
      if (lastUpdated) {
        document.getElementById('lastUpdated').textContent =
          'Last updated: ' + new Date(lastUpdated).toLocaleString();
      } else {
        document.getElementById('lastUpdated').textContent = 'Last updated: not available';
      }
    }

    function renderSummaryMetrics(summary) {
      const grid = document.getElementById('metricsGrid');
      grid.innerHTML = '';

      // Use sponsor-friendly labels with helpful subtitles
      // Sponsors first - gives immediate context on who's being tracked
      const metricCards = [
        {
          label: 'Sponsors',
          sublabel: 'Active sponsors',
          value: summary.uniqueSponsors || 0
        },
        {
          label: 'Total Views',
          sublabel: 'Times your content was seen',
          value: (summary.totalImpressions || 0).toLocaleString()
        },
        {
          label: 'Total Clicks',
          sublabel: 'Clicks on sponsor links',
          value: (summary.totalClicks || 0).toLocaleString()
        },
        {
          label: 'QR Scans',
          sublabel: 'QR codes scanned',
          value: (summary.totalQrScans || 0).toLocaleString()
        },
        {
          label: 'Signups',
          sublabel: 'Form submissions',
          value: (summary.totalSignups || 0).toLocaleString()
        },
        {
          label: 'Events',
          sublabel: 'Active events',
          value: summary.uniqueEvents || 0
        }
      ];

      metricCards.forEach(metric => {
        const card = document.createElement('div');
        card.className = 'metric-card';
        card.innerHTML = `
          <div class="label">${metric.label}</div>
          <div class="value">${metric.value}</div>
          ${metric.sublabel ? '<div class="sublabel">' + metric.sublabel + '</div>' : ''}
        `;
        grid.appendChild(card);
      });
    }

    // Map surface IDs to user-friendly descriptions
    const SURFACE_DESCRIPTIONS = {
      'poster': 'Physical posters at the event venue',
      'display': 'Digital screens and displays',
      'public': 'Public event pages online',
      'signup': 'Registration and signup forms'
    };

    function renderSurfacePerformance(surfaces) {
      const container = document.getElementById('surfacePerformance');

      if (!surfaces.length) {
        container.innerHTML = `
          <div style="text-align: center; padding: 24px; color: #64748b;">
            <div style="font-size: 1.5rem; margin-bottom: 8px; opacity: 0.5;">📊</div>
            <p style="margin: 0; font-weight: 500; color: #475569;">No Placement Data Yet</p>
            <p style="margin: 8px 0 0; font-size: 0.85rem;">Placement performance data will appear here once sponsor content has been viewed.</p>
          </div>
        `;
        return;
      }

      const rows = surfaces.map(surface => {
        const impressions = surface.impressions || 0;
        const clicks = surface.clicks || 0;
        const qrScans = surface.qrScans || 0;
        const rate = typeof surface.engagementRate === 'number'
          ? surface.engagementRate
          : (impressions > 0 ? (clicks + qrScans) * 100 / impressions : 0);
        const label = surface.label || surface.id || 'Unknown';
        const description = SURFACE_DESCRIPTIONS[surface.id] || '';

        const badgeClass =
          rate >= 5 ? 'success' :
          rate >= 2 ? 'info' : 'warning';

        return `
          <tr>
            <td data-label="Placement">
              <strong>${escapeHtml(label)}</strong>
              ${description ? '<span class="surface-desc">' + escapeHtml(description) + '</span>' : ''}
            </td>
            <td data-label="Views">${impressions.toLocaleString()}</td>
            <td data-label="Clicks">${clicks.toLocaleString()}</td>
            <td data-label="Scans">${qrScans.toLocaleString()}</td>
            <td data-label="Rate">
              <span class="badge ${badgeClass}">${rate.toFixed(1)}%</span>
            </td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th class="th-with-tooltip" data-tooltip="Where sponsor content appears">Placement</th>
              <th class="th-with-tooltip" data-tooltip="Times content was displayed">Views</th>
              <th class="th-with-tooltip" data-tooltip="Clicks on sponsor links">Clicks</th>
              <th class="th-with-tooltip" data-tooltip="QR codes scanned">Scans</th>
              <th class="th-with-tooltip" data-tooltip="% who interacted">Rate</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    function renderSponsorPerformance(sponsors) {
      const container = document.getElementById('sponsorPerformance');

      // Update help text based on view (human-readable language)
      const helpText = document.getElementById('sponsorHelpText');
      if (helpText) {
        if (IS_SPONSOR_VIEW) {
          helpText.textContent = 'Your performance across all placements. Click Rate shows what percentage of viewers clicked your content.';
        } else {
          helpText.textContent = 'See how each sponsor is performing. Tap "Share Report" to give sponsors access to their own analytics.';
        }
      }

      if (!sponsors.length) {
        container.innerHTML = `
          <div style="text-align: center; padding: 24px; color: #64748b;">
            <div style="font-size: 1.5rem; margin-bottom: 8px; opacity: 0.5;">🏢</div>
            <p style="margin: 0; font-weight: 500; color: #475569;">No Sponsor Activity Yet</p>
            <p style="margin: 8px 0 0; font-size: 0.85rem;">Sponsor performance data will appear here once sponsors have been added and their content has been viewed.</p>
          </div>
        `;
        return;
      }

      // Show QR column only in organizer view (not sponsor view)
      const showQrColumn = !IS_SPONSOR_VIEW;

      const rows = sponsors.map((sponsor, index) => {
        const ctr = sponsor.ctr || 0;
        const badgeClass =
          ctr >= 2 ? 'success' :
          ctr >= 1 ? 'info' : 'warning';

        const qrCell = showQrColumn
          ? `<td data-label="Share" style="text-align:center;">
               <button class="btn-secondary sponsor-qr-btn" data-sponsor-id="${escapeHtml(sponsor.id || '')}" data-sponsor-name="${escapeHtml(sponsor.name || sponsor.id || 'Sponsor')}" style="padding:6px 12px;font-size:0.75rem;">Share Report</button>
             </td>`
          : '';

        return `
          <tr>
            <td data-label="Sponsor">
              <strong>${escapeHtml(sponsor.name || sponsor.id || ('Sponsor #' + (index + 1)))}</strong>
            </td>
            <td data-label="Views">${(sponsor.impressions || 0).toLocaleString()}</td>
            <td data-label="Clicks">${(sponsor.clicks || 0).toLocaleString()}</td>
            <td data-label="Rate">
              <span class="badge ${badgeClass}">${ctr.toFixed(2)}%</span>
            </td>
            ${qrCell}
          </tr>
        `;
      }).join('');

      const qrHeader = showQrColumn ? '<th class="th-with-tooltip" data-tooltip="Generate QR code to share report with sponsor">Share</th>' : '';

      container.innerHTML = `
        <table class="data-table sponsor-table">
          <thead>
            <tr>
              <th>Sponsor</th>
              <th class="th-with-tooltip" data-tooltip="Times content was displayed">Views</th>
              <th class="th-with-tooltip" data-tooltip="Clicks on content">Clicks</th>
              <th class="th-with-tooltip" data-tooltip="Clicks ÷ views">Rate</th>
              ${qrHeader}
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;

      // Wire up QR buttons if in organizer view
      if (showQrColumn) {
        wireSponsorQrButtons(container);
      }
    }

    /**
     * Escape HTML to prevent XSS
     * @param {string} str - String to escape
     * @returns {string} Escaped string
     */
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /**
     * Wire QR button click handlers
     * @param {HTMLElement} container - Container element
     */
    function wireSponsorQrButtons(container) {
      container.querySelectorAll('.sponsor-qr-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const sponsorId = this.dataset.sponsorId;
          const sponsorName = this.dataset.sponsorName;
          if (!sponsorId) return;
          fetchAndShowSponsorQr(sponsorId, sponsorName);
        });
      });
    }

    /**
     * Fetch and display QR code for a sponsor's report
     * @param {string} sponsorId - The sponsor ID
     * @param {string} sponsorName - The sponsor name for display
     */
    async function fetchAndShowSponsorQr(sponsorId, sponsorName) {
      // Show loading modal
      showSponsorQrModal(sponsorName, null, true);

      try {
        const result = await NU.rpc('api_getSponsorReportQr', {
          sponsorId: sponsorId,
          brandId: BRAND_ID
        });

        if (!result || !result.ok) {
          showSponsorQrModal(sponsorName, null, false, result?.message || 'Failed to generate QR code');
          return;
        }

        // Respect invariant: no QR for unverified URLs
        if (!result.value.verified || !result.value.qrB64) {
          showSponsorQrModal(sponsorName, null, false, 'QR code unavailable - URL not verified');
          return;
        }

        // Show QR code
        showSponsorQrModal(sponsorName, result.value.qrB64, false, null, result.value.url);

      } catch (e) {
        console.error('Failed to fetch sponsor QR:', e);
        showSponsorQrModal(sponsorName, null, false, 'Network error - please try again');
      }
    }

    /**
     * Display modal with sponsor QR code
     * @param {string} sponsorName - Sponsor name for title
     * @param {string|null} qrB64 - Base64 encoded QR image (null if loading/error)
     * @param {boolean} loading - Show loading spinner
     * @param {string|null} error - Error message to display
     * @param {string|null} url - The URL the QR encodes (for display)
     */
    function showSponsorQrModal(sponsorName, qrB64, loading, error, url) {
      // Remove existing modal if any
      const existing = document.getElementById('sponsorQrModal');
      if (existing) existing.remove();

      let content = '';
      if (loading) {
        content = '<div style="padding:40px;text-align:center;"><span class="spinner"></span><p style="margin-top:12px;color:#64748b;">Loading QR code...</p></div>';
      } else if (error) {
        content = '<div style="padding:40px;text-align:center;color:#ef4444;"><p>' + escapeHtml(error) + '</p></div>';
      } else if (qrB64) {
        content = `
          <div style="text-align:center;padding:20px;">
            <img src="data:image/png;base64,${qrB64}" alt="Sponsor report QR" style="max-width:200px;height:auto;border:1px solid #e2e8f0;border-radius:8px;">
            <p style="margin-top:12px;font-size:0.75rem;color:#64748b;word-break:break-all;">${escapeHtml(url || '')}</p>
            <p style="margin-top:8px;font-size:0.7rem;color:#94a3b8;">Scan to view sponsor analytics</p>
          </div>
        `;
      }

      const modal = document.createElement('div');
      modal.id = 'sponsorQrModal';
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
      modal.innerHTML = `
        <div style="background:white;border-radius:12px;max-width:320px;width:90%;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);">
          <div style="padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;font-size:1rem;font-weight:600;">${escapeHtml(sponsorName)} QR</h3>
            <button onclick="closeSponsorQrModal()" style="background:none;border:none;cursor:pointer;font-size:1.25rem;color:#64748b;padding:0;line-height:1;">&times;</button>
          </div>
          ${content}
        </div>
      `;

      // Close on backdrop click
      modal.addEventListener('click', function(e) {
        if (e.target === modal) closeSponsorQrModal();
      });

      document.body.appendChild(modal);
    }

    /**
     * Close the sponsor QR modal
     */
    function closeSponsorQrModal() {
      const modal = document.getElementById('sponsorQrModal');
      if (modal) modal.remove();
    }

    function renderEventPerformance(events) {
      const container = document.getElementById('eventPerformance');

      if (!events.length) {
        container.innerHTML = `
          <div style="text-align: center; padding: 24px; color: #64748b;">
            <div style="font-size: 1.5rem; margin-bottom: 8px; opacity: 0.5;">🎉</div>
            <p style="margin: 0; font-weight: 500; color: #475569;">No Event Analytics Yet</p>
            <p style="margin: 8px 0 0; font-size: 0.85rem;">Event performance data will appear here once events have been created and attendees have started engaging.</p>
          </div>
        `;
        return;
      }

      const rows = events.map((ev, index) => {
        const ctr = ev.ctr || 0;
        const badgeClass =
          ctr >= 2 ? 'success' :
          ctr >= 1 ? 'info' : 'warning';

        const rank =
          index === 0 ? '🥇' :
          index === 1 ? '🥈' :
          index === 2 ? '🥉' : '#' + (index + 1);

        const signups = ev.signupsCount || 0;

        return `
          <tr>
            <td data-label="Event">
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-size:1.1rem;">${rank}</span>
                <strong>${escapeHtml(ev.name || ev.id)}</strong>
              </div>
            </td>
            <td data-label="Views">${(ev.impressions || 0).toLocaleString()}</td>
            <td data-label="Clicks">${(ev.clicks || 0).toLocaleString()}</td>
            <td data-label="Signups">${signups.toLocaleString()}</td>
            <td data-label="Rate">
              <span class="badge ${badgeClass}">${ctr.toFixed(2)}%</span>
            </td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Event</th>
              <th class="th-with-tooltip" data-tooltip="Times content was displayed">Views</th>
              <th class="th-with-tooltip" data-tooltip="Clicks on content">Clicks</th>
              <th class="th-with-tooltip" data-tooltip="Form submissions">Signups</th>
              <th class="th-with-tooltip" data-tooltip="Clicks ÷ views">Rate</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    /**
     * Expand first detail section on desktop for better UX
     * On mobile (<=640px), keep all sections collapsed to reduce scroll
     */
    function initMobileCollapse() {
      const isMobile = window.innerWidth <= 640;
      if (!isMobile) {
        // On desktop/tablet, expand the first detail section by default
        const firstSection = document.getElementById('surfacePerformanceCard');
        if (firstSection && firstSection.classList.contains('collapsed')) {
          firstSection.classList.remove('collapsed');
          const toggleBtn = firstSection.querySelector('.section-toggle');
          if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'true');
        }
      }
      // On mobile, all sections stay collapsed (already set in HTML)
    }

    window.addEventListener('load', function() {
      loadReport();
      initMobileCollapse();
    });
  </script>
</body>
</html>
