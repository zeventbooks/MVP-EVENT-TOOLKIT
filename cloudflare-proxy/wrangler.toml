# Cloudflare Workers Configuration
# https://developers.cloudflare.com/workers/wrangler/configuration/

name = "eventangle"
main = "worker.js"
compatibility_date = "2024-01-01"

# ===========================================
# Text Rules for Embedded Templates
# ===========================================
# Import HTML templates as text strings for embedding in the Worker.
# This eliminates the need for KV storage for templates.
[[rules]]
type = "Text"
globs = ["**/*.html"]
fallthrough = true

# Account ID - Set via environment or wrangler login
# account_id = "your-account-id"

# ============================================
# Environment Variables - Standardized Naming
# ============================================
# Deployment IDs are updated by CI/CD after each Apps Script deployment
#
# Naming Convention:
#   STAGING_* - Staging environment (stg.eventangle.com)
#   PROD_*    - Production environment (www.eventangle.com)
#
# Variable Types:
#   *_SCRIPT_ID        - Apps Script project ID (permanent, for clasp)
#   *_DEPLOYMENT_ID    - Web app deployment ID (changes with each deploy)
#   *_WEB_APP_URL      - Executable URL (runtime URL)
#   *_GAS_EDIT_URL     - Project editor URL (for development)
#
# Production Script ID: 1YO4apLOQoAIh208AcAqWO3pWtx_O3yas_QC4z-pkurgMem9UgYOsp86l
# Staging Script ID: 1gHiPuj7eXNk09dDyk17SJ6QsCJg7LMqXBRrkowljL3z2TaAKFIvBLhHJ
#
# Other Variables:
# ERROR_LOG_ENDPOINT - (Optional) URL for external error logging (POST JSON)
# UPSTREAM_TIMEOUT_MS - (Optional) Timeout for upstream requests (default: 30000ms)
#
# ============================================
# SECRETS - Worker-Native API (Story 6)
# ============================================
# These secrets enable direct Google Sheets API access from the Worker,
# bypassing GAS entirely. Set via: wrangler secret put <NAME> --env <env>
#
# Required for /api/v2/* endpoints:
#   GOOGLE_CLIENT_EMAIL  - Service account email (e.g., worker@project.iam.gserviceaccount.com)
#   GOOGLE_PRIVATE_KEY   - Service account private key (PEM format, with newlines)
#   SHEETS_SPREADSHEET_ID - Google Sheets spreadsheet ID
#   ADMIN_TOKEN          - Bearer token for admin authentication
#
# Setup commands:
#   wrangler secret put GOOGLE_CLIENT_EMAIL --env staging
#   wrangler secret put GOOGLE_PRIVATE_KEY --env staging
#   wrangler secret put SHEETS_SPREADSHEET_ID --env staging
#   wrangler secret put ADMIN_TOKEN --env staging
#
# Note: GOOGLE_PRIVATE_KEY should be the full PEM content including
# -----BEGIN PRIVATE KEY----- and -----END PRIVATE KEY-----
# When using wrangler secret put, paste the entire key including newlines.
#
[vars]
# Production deployment (used as default/fallback)
PROD_DEPLOYMENT_ID = "AKfycbz-RVTCdsQsI913wN3TkPtUP8F8EhSjyFAlWIpLVRgzV6WJ-isDyG-ntaV1VjBNaWZLdw"
# Legacy alias (keeping for backward compatibility)
DEPLOYMENT_ID = "AKfycbz-RVTCdsQsI913wN3TkPtUP8F8EhSjyFAlWIpLVRgzV6WJ-isDyG-ntaV1VjBNaWZLdw"
# ERROR_LOG_ENDPOINT = "https://your-logging-endpoint.com/errors"
# UPSTREAM_TIMEOUT_MS = "30000"

# ============================================
# Production - FULL SITE (eventangle.com)
# ============================================
# This serves EVERYTHING through Cloudflare:
# - HTML pages (admin, public, display, etc.)
# - API responses (status, events, sponsors)
# - All brands (root, abc, cbc, cbl)
[env.production]
name = "eventangle-prod"
routes = [
  # Main domain - serves full site
  { pattern = "eventangle.com/*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/*", zone_name = "eventangle.com" },
  # API subdomain (optional, same worker)
  { pattern = "api.eventangle.com/*", zone_name = "eventangle.com" }
]

[env.production.vars]
# Story 2: Explicit environment identifier for consistent detection
WORKER_ENV = "production"
# Story 2: Worker versioning - build version logged in X-Worker-Build-Version header
WORKER_BUILD_VERSION = "prod-2025.12.09"
# Story 2: Debug level for observability (production uses 'error' for minimal logging)
DEBUG_LEVEL = "error"
# ============================================
# Story 6.1: DNS Cutover - Worker-Only Mode
# ============================================
# BACKEND_MODE controls which backend handles requests:
#   - 'gas'    : All routes use GAS backend (legacy)
#   - 'worker' : All routes use Worker-native backend (CURRENT)
#   - 'mixed'  : Per-route selection based on backendConfig.js
#
# As of Story 6.1, production routes ALL traffic through Worker.
# GAS is only called for:
#   - Shortlink resolution (/r, /redirect) - proxied through Worker
#   - Legacy RPC (/api/rpc) - proxied through Worker
#
# To rollback to GAS-first routing, change to 'gas' and redeploy.
# ============================================
BACKEND_MODE = "worker"
PROD_DEPLOYMENT_ID = "AKfycbz-RVTCdsQsI913wN3TkPtUP8F8EhSjyFAlWIpLVRgzV6WJ-isDyG-ntaV1VjBNaWZLdw"
PROD_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz-RVTCdsQsI913wN3TkPtUP8F8EhSjyFAlWIpLVRgzV6WJ-isDyG-ntaV1VjBNaWZLdw/exec"
# Legacy aliases (keeping for backward compatibility)
DEPLOYMENT_ID = "AKfycbz-RVTCdsQsI913wN3TkPtUP8F8EhSjyFAlWIpLVRgzV6WJ-isDyG-ntaV1VjBNaWZLdw"
GAS_DEPLOYMENT_BASE_URL = "https://script.google.com/macros/s/AKfycbz-RVTCdsQsI913wN3TkPtUP8F8EhSjyFAlWIpLVRgzV6WJ-isDyG-ntaV1VjBNaWZLdw/exec"

# KV Namespace for HTML templates (production)
# Created via: wrangler kv:namespace create "TEMPLATES_KV" --env production
# NOTE: Uncomment and replace ID after creating the namespace:
#   wrangler kv:namespace create "TEMPLATES_KV" --env production
# Then update the id below with the output namespace ID
# [[env.production.kv_namespaces]]
# binding = "TEMPLATES_KV"
# id = "REPLACE_WITH_PRODUCTION_KV_NAMESPACE_ID"

# ============================================
# Staging Environment (stg.eventangle.com)
# ============================================
# Dedicated staging environment for:
# - Destructive tests, schema experiments, load tests
# - Pre-production validation
# - Safe sandbox for development testing
#
# SETUP INSTRUCTIONS:
# 1. Create staging GAS project (see STAGING_SETUP.md)
# 2. Deploy GAS: npm run deploy:staging
# 3. Configure: npm run staging:configure -- --deployment-id=YOUR_ID
# 4. Set up DNS (choose one):
#    a) Automated: export CLOUDFLARE_API_TOKEN=xxx && npm run staging:dns
#    b) Manual: Add A record for stg.eventangle.com -> 192.0.2.1 (proxied)
# 5. Deploy worker: npm run deploy:staging:worker
# 6. Verify: npm run staging:verify
#
# Quick one-command setup (after setting CLOUDFLARE_API_TOKEN):
#   npm run staging:setup
#
# Deploy: wrangler deploy --env staging
# Status: npm run staging:status
# ============================================
[env.staging]
name = "eventangle-staging"
routes = [
  # Main staging domain - serves full site (HTML + API)
  { pattern = "stg.eventangle.com/*", zone_name = "eventangle.com" },
  # API staging subdomain - same worker, API focus
  { pattern = "api-stg.eventangle.com/*", zone_name = "eventangle.com" }
]

[env.staging.vars]
# ============================================
# STAGING DEPLOYMENT CONFIGURATION
# ============================================
# Uses standardized naming convention:
#   STAGING_SCRIPT_ID      - Permanent project ID (for clasp)
#   STAGING_DEPLOYMENT_ID  - Web app deployment ID (changes per deploy)
#   STAGING_WEB_APP_URL    - Executable URL (runtime)
#
# Script ID: 1gHiPuj7eXNk09dDyk17SJ6QsCJg7LMqXBRrkowljL3z2TaAKFIvBLhHJ
#
# To update after deployment:
# 1. Deploy staging GAS: npm run deploy:staging
# 2. Copy the AKfycb... deployment ID from the output
# 3. Run: npm run staging:configure --deployment-id=AKfycb...
# ============================================
WORKER_ENV = "staging"
# ============================================
# Story 0.1: Versioned Backend Routing
# ============================================
# BACKEND_MODE controls which backend handles requests:
#   - 'gas'    : All routes use GAS backend (current production behavior)
#   - 'worker' : All routes use Worker-native backend
#   - 'mixed'  : Per-route selection based on backendConfig.js
#
# Migration Strategy:
#   1. Start with 'gas' (default)
#   2. Switch to 'mixed' to test individual routes on Worker
#   3. Once all routes verified, switch to 'worker'
#
# Query Param Override (staging only):
#   Add ?backend=gas or ?backend=worker to any request to force a backend
# ============================================
BACKEND_MODE = "mixed"
# Story 2: Worker versioning - build version logged in X-Worker-Build-Version header
WORKER_BUILD_VERSION = "stg-2025.12.09"
# Story 2: STAGING_WEB_APP_URL is the SINGLE SOURCE OF TRUTH
STAGING_DEPLOYMENT_ID = "AKfycbwFneYCpkio7wCn7y08eDUb2PRCPc2Tdtbv20L4AbEHvuCvoqY9ks7-ONL0pzPPw4Hm"
STAGING_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwFneYCpkio7wCn7y08eDUb2PRCPc2Tdtbv20L4AbEHvuCvoqY9ks7-ONL0pzPPw4Hm/exec"
# DEPRECATED: Legacy aliases - migrate to STAGING_* vars
DEPLOYMENT_ID = "AKfycbwFneYCpkio7wCn7y08eDUb2PRCPc2Tdtbv20L4AbEHvuCvoqY9ks7-ONL0pzPPw4Hm"
GAS_DEPLOYMENT_BASE_URL = "https://script.google.com/macros/s/AKfycbwFneYCpkio7wCn7y08eDUb2PRCPc2Tdtbv20L4AbEHvuCvoqY9ks7-ONL0pzPPw4Hm/exec"
# Enable debug endpoints (/__debug/template/*) for staging only
# SECURITY: This should NEVER be enabled in production
ENABLE_DEBUG_ENDPOINTS = "true"
# Story 5: Debug level for observability
# Staging uses 'debug' for full visibility, production uses 'error'
# Note: NU SDK auto-detects based on hostname, this is for documentation
DEBUG_LEVEL = "debug"

# KV Namespace for HTML templates (staging)
# Created via: wrangler kv:namespace create "TEMPLATES_KV" --env staging
# NOTE: Uncomment and replace ID after creating the namespace:
#   wrangler kv:namespace create "TEMPLATES_KV" --env staging
# Then update the id below with the output namespace ID
# [[env.staging.kv_namespaces]]
# binding = "TEMPLATES_KV"
# id = "REPLACE_WITH_STAGING_KV_NAMESPACE_ID"

# ============================================
# API Only (subdomain only, no main site)
# ============================================
[env.api-only]
name = "eventangle-api"
routes = [
  { pattern = "api.eventangle.com/*", zone_name = "eventangle.com" }
]

[env.api-only.vars]
# Story 2: Explicit environment identifier for consistent detection
WORKER_ENV = "production"
# Story 2: Worker versioning - build version logged in X-Worker-Build-Version header
WORKER_BUILD_VERSION = "prod-2025.12.09"
DEBUG_LEVEL = "error"
# Story 6.1: Worker-only mode for production
BACKEND_MODE = "worker"
PROD_DEPLOYMENT_ID = "AKfycbz-RVTCdsQsI913wN3TkPtUP8F8EhSjyFAlWIpLVRgzV6WJ-isDyG-ntaV1VjBNaWZLdw"
PROD_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz-RVTCdsQsI913wN3TkPtUP8F8EhSjyFAlWIpLVRgzV6WJ-isDyG-ntaV1VjBNaWZLdw/exec"
# Legacy alias
DEPLOYMENT_ID = "AKfycbz-RVTCdsQsI913wN3TkPtUP8F8EhSjyFAlWIpLVRgzV6WJ-isDyG-ntaV1VjBNaWZLdw"

# ============================================
# Friendly URLs (all app paths on main site)
# ============================================
# Routes all friendly URL patterns through Cloudflare to GAS.
# See docs/FRIENDLY_URLS.md for complete URL mapping.
[env.events]
name = "eventangle-events"
routes = [
  # Google Apps Script static assets (CSS, JS) - redirect to Google CDN
  { pattern = "eventangle.com/static/*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/static/*", zone_name = "eventangle.com" },
  # Google internal endpoints (warden bot detection, error reporting) - stub responses
  { pattern = "eventangle.com/wardeninit*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/wardeninit*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/warden*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/warden*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/jserror*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/jserror*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/_/*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/_/*", zone_name = "eventangle.com" },
  # Global aliases
  { pattern = "eventangle.com/events*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/events*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/schedule*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/schedule*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/calendar*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/calendar*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/manage*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/manage*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/admin*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/admin*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/dashboard*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/dashboard*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/create*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/create*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/display*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/display*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/tv*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/tv*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/kiosk*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/kiosk*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/screen*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/screen*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/posters*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/posters*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/poster*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/poster*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/flyers*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/flyers*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/analytics*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/analytics*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/reports*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/reports*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/insights*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/insights*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/stats*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/stats*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/status*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/status*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/health*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/health*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/ping*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/ping*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/docs*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/docs*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/api*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/api*", zone_name = "eventangle.com" },
  # RPC endpoint for frontend API calls (replaces google.script.run)
  { pattern = "eventangle.com/api/rpc", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/api/rpc", zone_name = "eventangle.com" },
  # Brand-prefixed paths (abc, cbc, cbl)
  { pattern = "eventangle.com/abc/*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/abc/*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/cbc/*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/cbc/*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/cbl/*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/cbl/*", zone_name = "eventangle.com" },
  # Root brand paths
  { pattern = "eventangle.com/root/*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/root/*", zone_name = "eventangle.com" }
]

[env.events.vars]
# Story 2: Explicit environment identifier for consistent detection
WORKER_ENV = "production"
# Story 2: Worker versioning - build version logged in X-Worker-Build-Version header
WORKER_BUILD_VERSION = "prod-2025.12.09"
DEBUG_LEVEL = "error"
# Story 6.1: Worker-only mode for production
BACKEND_MODE = "worker"
# Production GAS deployment (standardized naming)
PROD_DEPLOYMENT_ID = "AKfycbz-RVTCdsQsI913wN3TkPtUP8F8EhSjyFAlWIpLVRgzV6WJ-isDyG-ntaV1VjBNaWZLdw"
PROD_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz-RVTCdsQsI913wN3TkPtUP8F8EhSjyFAlWIpLVRgzV6WJ-isDyG-ntaV1VjBNaWZLdw/exec"
# Legacy aliases (keeping for backward compatibility)
GAS_DEPLOYMENT_BASE_URL = "https://script.google.com/macros/s/AKfycbz-RVTCdsQsI913wN3TkPtUP8F8EhSjyFAlWIpLVRgzV6WJ-isDyG-ntaV1VjBNaWZLdw/exec"
DEPLOYMENT_ID = "AKfycbz-RVTCdsQsI913wN3TkPtUP8F8EhSjyFAlWIpLVRgzV6WJ-isDyG-ntaV1VjBNaWZLdw"

# ============================================
# Development (workers.dev subdomain)
# ============================================
# Default deployment uses workers.dev:
# https://eventangle.YOUR_SUBDOMAIN.workers.dev
#
# Test URLs:
# - https://eventangle.YOUR_SUBDOMAIN.workers.dev?page=admin&brand=root
# - https://eventangle.YOUR_SUBDOMAIN.workers.dev?p=status&brand=root
# - https://eventangle.YOUR_SUBDOMAIN.workers.dev?page=display&brand=root
