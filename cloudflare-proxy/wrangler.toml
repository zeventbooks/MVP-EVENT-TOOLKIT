# Cloudflare Workers Configuration
# https://developers.cloudflare.com/workers/wrangler/configuration/

name = "eventangle"
main = "worker.js"
compatibility_date = "2024-01-01"

# Account ID - Set via environment or wrangler login
# account_id = "your-account-id"

# ============================================
# Environment Variables
# ============================================
# The deployment ID is updated by CI/CD after each Apps Script deployment
#
# DEPLOYMENT_ID - Apps Script deployment ID (for building exec URL)
# GAS_DEPLOYMENT_BASE_URL - Full Apps Script exec URL (preferred over DEPLOYMENT_ID)
# ERROR_LOG_ENDPOINT - (Optional) URL for external error logging (POST JSON)
# UPSTREAM_TIMEOUT_MS - (Optional) Timeout for upstream requests (default: 30000ms)
#
[vars]
DEPLOYMENT_ID = "AKfycbyS1cW9VhviR-Jr8AmYY_BAGrb1gzuKkrgEBP2M3bMdqAv4ktqHOZInWV8ogkpz5i8SYQ"
# ERROR_LOG_ENDPOINT = "https://your-logging-endpoint.com/errors"
# UPSTREAM_TIMEOUT_MS = "30000"

# ============================================
# Production - FULL SITE (eventangle.com)
# ============================================
# This serves EVERYTHING through Cloudflare:
# - HTML pages (admin, public, display, etc.)
# - API responses (status, events, sponsors)
# - All brands (root, abc, cbc, cbl)
[env.production]
name = "eventangle-prod"
routes = [
  # Main domain - serves full site
  { pattern = "eventangle.com/*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/*", zone_name = "eventangle.com" },
  # API subdomain (optional, same worker)
  { pattern = "api.eventangle.com/*", zone_name = "eventangle.com" }
]

[env.production.vars]
DEPLOYMENT_ID = "AKfycbyS1cW9VhviR-Jr8AmYY_BAGrb1gzuKkrgEBP2M3bMdqAv4ktqHOZInWV8ogkpz5i8SYQ"

# KV Namespace for HTML templates (production)
# Created via: wrangler kv:namespace create "TEMPLATES_KV" --env production
# NOTE: Uncomment and replace ID after creating the namespace:
#   wrangler kv:namespace create "TEMPLATES_KV" --env production
# Then update the id below with the output namespace ID
# [[env.production.kv_namespaces]]
# binding = "TEMPLATES_KV"
# id = "REPLACE_WITH_PRODUCTION_KV_NAMESPACE_ID"

# ============================================
# Staging Environment (stg.eventangle.com)
# ============================================
# Dedicated staging environment for:
# - Destructive tests, schema experiments, load tests
# - Pre-production validation
# - Safe sandbox for development testing
#
# SETUP INSTRUCTIONS:
# 1. Create staging GAS project (see STAGING_SETUP.md)
# 2. Deploy GAS: npm run deploy:staging
# 3. Configure: npm run staging:configure -- --deployment-id=YOUR_ID
# 4. Set up DNS (choose one):
#    a) Automated: export CLOUDFLARE_API_TOKEN=xxx && npm run staging:dns
#    b) Manual: Add A record for stg.eventangle.com -> 192.0.2.1 (proxied)
# 5. Deploy worker: npm run deploy:staging:worker
# 6. Verify: npm run staging:verify
#
# Quick one-command setup (after setting CLOUDFLARE_API_TOKEN):
#   npm run staging:setup
#
# Deploy: wrangler deploy --env staging
# Status: npm run staging:status
# ============================================
[env.staging]
name = "eventangle-staging"
routes = [
  # Main staging domain - serves full site (HTML + API)
  { pattern = "stg.eventangle.com/*", zone_name = "eventangle.com" },
  # API staging subdomain - same worker, API focus
  { pattern = "api-stg.eventangle.com/*", zone_name = "eventangle.com" }
]

[env.staging.vars]
# ============================================
# STAGING DEPLOYMENT CONFIGURATION
# ============================================
# IMPORTANT: These values must point to the STAGING GAS deployment
# NOT production! Run: npm run staging:configure --deployment-id=YOUR_ID
#
# To get your deployment ID:
# 1. Deploy staging GAS: npm run deploy:staging
# 2. Copy the AKfycb... deployment ID from the output
# 3. Run: npm run staging:configure --deployment-id=AKfycb...
#
# Placeholder value indicates staging is NOT configured.
# ============================================
STAGING_DEPLOYMENT_ID = "AKfycbxx2nN-zkU-Jke1ECl1C7RUwOyGmrZ6B-6-ViMIjXKrIT3Q1dLh5lf5LK5Ymdg-cbcJ"
GAS_DEPLOYMENT_BASE_URL = "https://script.google.com/macros/s/AKfycbxx2nN-zkU-Jke1ECl1C7RUwOyGmrZ6B-6-ViMIjXKrIT3Q1dLh5lf5LK5Ymdg-cbcJ/exec"
DEPLOYMENT_ID = "AKfycbxx2nN-zkU-Jke1ECl1C7RUwOyGmrZ6B-6-ViMIjXKrIT3Q1dLh5lf5LK5Ymdg-cbcJ"
# Enable debug endpoints (/__debug/template/*) for staging only
# SECURITY: This should NEVER be enabled in production
ENABLE_DEBUG_ENDPOINTS = "true"
# Story 5: Debug level for observability
# Staging uses 'debug' for full visibility, production uses 'error'
# Note: NU SDK auto-detects based on hostname, this is for documentation
DEBUG_LEVEL = "debug"

# KV Namespace for HTML templates (staging)
# Created via: wrangler kv:namespace create "TEMPLATES_KV" --env staging
# NOTE: Uncomment and replace ID after creating the namespace:
#   wrangler kv:namespace create "TEMPLATES_KV" --env staging
# Then update the id below with the output namespace ID
# [[env.staging.kv_namespaces]]
# binding = "TEMPLATES_KV"
# id = "REPLACE_WITH_STAGING_KV_NAMESPACE_ID"

# ============================================
# API Only (subdomain only, no main site)
# ============================================
[env.api-only]
name = "eventangle-api"
routes = [
  { pattern = "api.eventangle.com/*", zone_name = "eventangle.com" }
]

[env.api-only.vars]
DEPLOYMENT_ID = "AKfycbyS1cW9VhviR-Jr8AmYY_BAGrb1gzuKkrgEBP2M3bMdqAv4ktqHOZInWV8ogkpz5i8SYQ"

# ============================================
# Friendly URLs (all app paths on main site)
# ============================================
# Routes all friendly URL patterns through Cloudflare to GAS.
# See docs/FRIENDLY_URLS.md for complete URL mapping.
[env.events]
name = "eventangle-events"
routes = [
  # Google Apps Script static assets (CSS, JS) - redirect to Google CDN
  { pattern = "eventangle.com/static/*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/static/*", zone_name = "eventangle.com" },
  # Google internal endpoints (warden bot detection, error reporting) - stub responses
  { pattern = "eventangle.com/wardeninit*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/wardeninit*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/warden*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/warden*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/jserror*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/jserror*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/_/*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/_/*", zone_name = "eventangle.com" },
  # Global aliases
  { pattern = "eventangle.com/events*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/events*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/schedule*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/schedule*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/calendar*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/calendar*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/manage*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/manage*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/admin*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/admin*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/dashboard*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/dashboard*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/create*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/create*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/display*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/display*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/tv*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/tv*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/kiosk*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/kiosk*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/screen*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/screen*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/posters*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/posters*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/poster*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/poster*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/flyers*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/flyers*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/analytics*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/analytics*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/reports*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/reports*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/insights*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/insights*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/stats*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/stats*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/status*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/status*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/health*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/health*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/ping*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/ping*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/docs*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/docs*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/api*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/api*", zone_name = "eventangle.com" },
  # RPC endpoint for frontend API calls (replaces google.script.run)
  { pattern = "eventangle.com/api/rpc", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/api/rpc", zone_name = "eventangle.com" },
  # Brand-prefixed paths (abc, cbc, cbl)
  { pattern = "eventangle.com/abc/*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/abc/*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/cbc/*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/cbc/*", zone_name = "eventangle.com" },
  { pattern = "eventangle.com/cbl/*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/cbl/*", zone_name = "eventangle.com" },
  # Root brand paths
  { pattern = "eventangle.com/root/*", zone_name = "eventangle.com" },
  { pattern = "www.eventangle.com/root/*", zone_name = "eventangle.com" }
]

[env.events.vars]
# The full Google Apps Script exec URL - this is the production backend
# Update this URL after each Apps Script deployment (see DEPLOYMENT.md)
GAS_DEPLOYMENT_BASE_URL = "https://script.google.com/macros/s/AKfycbyS1cW9VhviR-Jr8AmYY_BAGrb1gzuKkrgEBP2M3bMdqAv4ktqHOZInWV8ogkpz5i8SYQ/exec"
DEPLOYMENT_ID = "AKfycbyS1cW9VhviR-Jr8AmYY_BAGrb1gzuKkrgEBP2M3bMdqAv4ktqHOZInWV8ogkpz5i8SYQ"

# ============================================
# Development (workers.dev subdomain)
# ============================================
# Default deployment uses workers.dev:
# https://eventangle.YOUR_SUBDOMAIN.workers.dev
#
# Test URLs:
# - https://eventangle.YOUR_SUBDOMAIN.workers.dev?page=admin&brand=root
# - https://eventangle.YOUR_SUBDOMAIN.workers.dev?p=status&brand=root
# - https://eventangle.YOUR_SUBDOMAIN.workers.dev?page=display&brand=root
