<!--
  QR Code Regenerator Component

  Provides one-click regeneration of all event shortlinks and QR codes.
  Useful when event details change or when QR codes need to be refreshed.

  Features:
  - Regenerate all event shortlinks (public, display, poster, report)
  - Generate QR codes for each link
  - Download QR codes as PNG images
  - Bulk regeneration for forms and sponsor links
-->
<section
  id="qrRegeneratorCard"
  class="card"
  role="region"
  aria-label="QR Code and Shortlink Management"
  style="display:none;">

  <div class="card-header">
    <h2 id="qrRegeneratorCard-title">QR Codes & Shortlinks</h2>
    <p class="card-subtitle">Regenerate and download QR codes for your event</p>
  </div>

  <div class="card-body">

    <div class="qr-grid" id="qrGrid">
      <!-- QR codes will be dynamically generated here -->
    </div>

    <div class="qr-actions">
      <button class="btn-primary" onclick="QRRegenerator.regenerateAll()" id="regenerateAllBtn">
        üîÑ Regenerate All QR Codes
      </button>
      <button class="btn-secondary" onclick="QRRegenerator.downloadAll()" id="downloadAllBtn">
        üì• Download All QR Codes
      </button>
      <button class="btn-secondary" onclick="QRRegenerator.printSheet()" id="printSheetBtn">
        üñ®Ô∏è Print QR Code Sheet
      </button>
    </div>

    <div class="qr-options">
      <h3>Advanced Options</h3>

      <div class="form-row">
        <div class="form-group">
          <label for="qrSize">QR Code Size</label>
          <select id="qrSize" onchange="QRRegenerator.updateQRSize()">
            <option value="200">Small (200x200)</option>
            <option value="300" selected>Medium (300x300)</option>
            <option value="500">Large (500x500)</option>
            <option value="1000">Extra Large (1000x1000)</option>
          </select>
        </div>

        <div class="form-group">
          <label for="qrFormat">Image Format</label>
          <select id="qrFormat" onchange="QRRegenerator.updateFormat()">
            <option value="png" selected>PNG</option>
            <option value="svg">SVG</option>
            <option value="jpeg">JPEG</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="includeEventName" checked>
          Include event name below QR code
        </label>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="includeLogo">
          Include logo in QR code center
        </label>
      </div>
    </div>

    <div class="qr-help">
      <h4>How to Use QR Codes</h4>
      <ul>
        <li><strong>Public Page:</strong> Share on social media and promotional materials</li>
        <li><strong>TV Display:</strong> Show on screens at the event entrance</li>
        <li><strong>Poster:</strong> Print on physical posters and flyers</li>
        <li><strong>Check-In:</strong> Use at registration desk for quick attendee check-in</li>
        <li><strong>Forms:</strong> Direct access to registration and survey forms</li>
      </ul>
    </div>
  </div>
</section>

<script>
/**
 * QR Code Regenerator Controller
 */
(function() {
  'use strict';

  // QR code generation using Google Charts API
  const QR_API_BASE = 'https://chart.googleapis.com/chart';

  window.QRRegenerator = {
    currentEvent: null,
    qrCodes: [],
    settings: {
      size: 300,
      format: 'png',
      includeEventName: true,
      includeLogo: false
    },

    /**
     * Initialize with event data
     */
    init: function(eventData) {
      if (!eventData) return;

      this.currentEvent = eventData;
      this.generateQRCodes();
      this.show();
    },

    /**
     * Generate QR codes for all event links
     */
    generateQRCodes: function() {
      if (!this.currentEvent || !this.currentEvent.links) return;

      const links = this.currentEvent.links;
      const eventName = this.currentEvent.data?.name || 'Event';

      this.qrCodes = [
        {
          id: 'public',
          title: 'üì± Public Page',
          description: 'Mobile-friendly event page',
          url: links.publicUrl,
          color: '#3b82f6'
        },
        {
          id: 'display',
          title: 'üì∫ TV Display',
          description: 'Full-screen TV display',
          url: links.displayUrl,
          color: '#8b5cf6'
        },
        {
          id: 'poster',
          title: 'üñ®Ô∏è Poster/Print',
          description: 'Printable poster with QR code',
          url: links.posterUrl,
          color: '#f59e0b'
        },
        {
          id: 'report',
          title: 'üìä Analytics Report',
          description: 'Shared analytics dashboard',
          url: links.reportUrl,
          color: '#10b981'
        }
      ];

      // Add form links if they exist
      const forms = ['registerUrl', 'checkinUrl', 'walkinUrl', 'surveyUrl'];
      const formLabels = {
        registerUrl: 'üìù Registration',
        checkinUrl: '‚úÖ Check-In',
        walkinUrl: 'üö∂ Walk-In',
        surveyUrl: 'üìã Survey'
      };

      for (const formKey of forms) {
        if (this.currentEvent.data?.[formKey]) {
          this.qrCodes.push({
            id: formKey,
            title: formLabels[formKey],
            description: formKey.replace('Url', ' form'),
            url: this.currentEvent.data[formKey],
            color: '#64748b'
          });
        }
      }

      this.renderQRCodes();
    },

    /**
     * Render QR codes in the grid
     */
    renderQRCodes: function() {
      const grid = document.getElementById('qrGrid');
      if (!grid) return;

      grid.innerHTML = '';

      for (const qr of this.qrCodes) {
        const qrUrl = this.generateQRCodeURL(qr.url);

        const card = document.createElement('div');
        card.className = 'qr-card';
        card.setAttribute('role', 'article');
        card.setAttribute('aria-labelledby', `qr-title-${qr.id}`);

        card.innerHTML = `
          <div class="qr-card-header" style="border-left-color: ${qr.color};">
            <h3 id="qr-title-${qr.id}">${qr.title}</h3>
            <p class="muted">${qr.description}</p>
          </div>
          <div class="qr-card-body">
            <img src="${qrUrl}" alt="QR Code for ${qr.title}" class="qr-image" id="qr-img-${qr.id}">
            <div class="qr-url">
              <input type="text" value="${qr.url}" readonly class="qr-url-input" id="qr-url-${qr.id}" aria-label="URL for ${qr.title}">
              <button class="btn-icon" onclick="QRRegenerator.copyURL('${qr.id}')" aria-label="Copy URL">
                üìã
              </button>
            </div>
          </div>
          <div class="qr-card-footer">
            <button class="btn-secondary btn-sm" onclick="QRRegenerator.downloadQR('${qr.id}')" aria-label="Download ${qr.title} QR code">
              üíæ Download
            </button>
            <button class="btn-secondary btn-sm" onclick="QRRegenerator.printQR('${qr.id}')" aria-label="Print ${qr.title} QR code">
              üñ®Ô∏è Print
            </button>
          </div>
        `;

        grid.appendChild(card);
      }
    },

    /**
     * Generate QR code URL using Google Charts API
     */
    generateQRCodeURL: function(dataUrl) {
      const size = this.settings.size;
      const params = new URLSearchParams({
        cht: 'qr',
        chs: `${size}x${size}`,
        chl: dataUrl,
        choe: 'UTF-8',
        chld: 'L|2' // Error correction level L, margin 2
      });

      return `${QR_API_BASE}?${params.toString()}`;
    },

    /**
     * Regenerate all QR codes
     */
    regenerateAll: async function() {
      const btn = document.getElementById('regenerateAllBtn');
      if (!btn) return;

      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'üîÑ Regenerating...';

      try {
        // Regenerate QR codes with current settings
        this.generateQRCodes();

        // Show success message
        this.showNotification('All QR codes regenerated successfully!', 'success');
      } catch (error) {
        console.error('Error regenerating QR codes:', error);
        this.showNotification('Error regenerating QR codes. Please try again.', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    },

    /**
     * Download all QR codes as a ZIP file
     */
    downloadAll: async function() {
      const btn = document.getElementById('downloadAllBtn');
      if (!btn) return;

      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'üì• Preparing download...';

      try {
        // Download each QR code individually
        // (ZIP creation would require additional library)
        for (const qr of this.qrCodes) {
          await this.downloadQR(qr.id, false);
          // Add small delay between downloads
          await new Promise(resolve => setTimeout(resolve, 500));
        }

        this.showNotification('All QR codes downloaded!', 'success');
      } catch (error) {
        console.error('Error downloading QR codes:', error);
        this.showNotification('Error downloading QR codes. Please try again.', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    },

    /**
     * Download a specific QR code
     */
    downloadQR: async function(qrId, showNotification = true) {
      const qr = this.qrCodes.find(q => q.id === qrId);
      if (!qr) return;

      const qrUrl = this.generateQRCodeURL(qr.url);
      const eventName = this.currentEvent.data?.name || 'Event';
      const filename = `${eventName.replace(/\s+/g, '-')}-${qr.id}-qr.png`;

      try {
        // Fetch the QR code image
        const response = await fetch(qrUrl);
        const blob = await response.blob();

        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        if (showNotification) {
          this.showNotification(`Downloaded ${qr.title} QR code!`, 'success');
        }
      } catch (error) {
        console.error('Error downloading QR code:', error);
        if (showNotification) {
          this.showNotification('Error downloading QR code. Please try again.', 'error');
        }
      }
    },

    /**
     * Print a specific QR code
     */
    printQR: function(qrId) {
      const qr = this.qrCodes.find(q => q.id === qrId);
      if (!qr) return;

      const qrUrl = this.generateQRCodeURL(qr.url);
      const eventName = this.currentEvent.data?.name || 'Event';

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${qr.title} - QR Code</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              min-height: 100vh;
              margin: 0;
              padding: 20px;
            }
            h1 { margin-bottom: 10px; }
            h2 { margin-top: 0; color: #64748b; font-weight: normal; }
            img { max-width: 400px; margin: 20px 0; }
            p { font-size: 14px; color: #64748b; }
            @media print {
              @page { margin: 0.5in; }
              body { padding: 0; }
            }
          </style>
        </head>
        <body>
          <h1>${eventName}</h1>
          <h2>${qr.title}</h2>
          <img src="${qrUrl}" alt="QR Code">
          <p>${qr.url}</p>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    },

    /**
     * Print a sheet with all QR codes
     */
    printSheet: function() {
      const eventName = this.currentEvent.data?.name || 'Event';
      const printWindow = window.open('', '_blank');

      let qrHTML = '';
      for (const qr of this.qrCodes) {
        const qrUrl = this.generateQRCodeURL(qr.url);
        qrHTML += `
          <div class="qr-item">
            <h3>${qr.title}</h3>
            <img src="${qrUrl}" alt="${qr.title} QR Code">
            <p class="url">${qr.url}</p>
          </div>
        `;
      }

      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${eventName} - QR Codes</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              padding: 20px;
              margin: 0;
            }
            h1 {
              text-align: center;
              margin-bottom: 30px;
              border-bottom: 2px solid #2563eb;
              padding-bottom: 10px;
            }
            .qr-grid {
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 30px;
            }
            .qr-item {
              text-align: center;
              page-break-inside: avoid;
              border: 1px solid #e2e8f0;
              padding: 20px;
              border-radius: 8px;
            }
            .qr-item h3 {
              margin-top: 0;
              color: #1e293b;
            }
            .qr-item img {
              max-width: 250px;
              margin: 10px 0;
            }
            .qr-item .url {
              font-size: 10px;
              color: #64748b;
              word-break: break-all;
              margin-top: 10px;
            }
            @media print {
              @page { margin: 0.5in; }
              .qr-item { break-inside: avoid; }
            }
          </style>
        </head>
        <body>
          <h1>${eventName} - QR Codes</h1>
          <div class="qr-grid">
            ${qrHTML}
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 500);
    },

    /**
     * Copy URL to clipboard
     */
    copyURL: async function(qrId) {
      const input = document.getElementById(`qr-url-${qrId}`);
      if (!input) return;

      try {
        await navigator.clipboard.writeText(input.value);
        this.showNotification('URL copied to clipboard!', 'success');

        // Visual feedback
        input.select();
        setTimeout(() => {
          input.setSelectionRange(0, 0);
        }, 500);
      } catch (error) {
        // Fallback for older browsers
        input.select();
        document.execCommand('copy');
        this.showNotification('URL copied!', 'success');
      }
    },

    /**
     * Update QR code size
     */
    updateQRSize: function() {
      const select = document.getElementById('qrSize');
      if (!select) return;

      this.settings.size = parseInt(select.value);
      this.renderQRCodes();
    },

    /**
     * Update image format
     */
    updateFormat: function() {
      const select = document.getElementById('qrFormat');
      if (!select) return;

      this.settings.format = select.value;
    },

    /**
     * Show notification
     */
    showNotification: function(message, type = 'info') {
      // Use existing notification system or create a simple alert
      alert(message);
    },

    /**
     * Show the QR regenerator card
     */
    show: function() {
      const card = document.getElementById('qrRegeneratorCard');
      if (card) {
        card.style.display = 'block';
      }
    },

    /**
     * Hide the QR regenerator card
     */
    hide: function() {
      const card = document.getElementById('qrRegeneratorCard');
      if (card) {
        card.style.display = 'none';
      }
    }
  };
})();
</script>

<style>
/* QR Regenerator Styles */
.qr-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}

.qr-card {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  overflow: hidden;
  transition: all 0.2s ease;
}

.qr-card:hover {
  border-color: #cbd5e1;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.qr-card-header {
  padding: 16px;
  border-left: 4px solid #2563eb;
  background: #f8fafc;
}

.qr-card-header h3 {
  margin: 0 0 4px 0;
  font-size: 16px;
  color: #1e293b;
}

.qr-card-header .muted {
  margin: 0;
  font-size: 13px;
}

.qr-card-body {
  padding: 20px;
  text-align: center;
}

.qr-image {
  max-width: 100%;
  height: auto;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  margin-bottom: 12px;
}

.qr-url {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.qr-url-input {
  flex: 1;
  font-size: 12px;
  padding: 8px;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  background: #f8fafc;
  font-family: 'Courier New', monospace;
}

.qr-url-input:focus {
  outline: none;
  border-color: #2563eb;
  background: white;
}

.btn-icon {
  padding: 8px 12px;
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}

.btn-icon:hover {
  background: #f8fafc;
  border-color: #2563eb;
}

.qr-card-footer {
  padding: 12px 16px;
  background: #f8fafc;
  display: flex;
  gap: 8px;
  justify-content: center;
  border-top: 1px solid #e2e8f0;
}

.btn-sm {
  padding: 6px 12px;
  font-size: 13px;
}

.qr-actions {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.qr-actions button {
  flex: 1;
  min-width: 200px;
}

.qr-options {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 24px;
}

.qr-options h3 {
  margin-top: 0;
  margin-bottom: 16px;
  color: #1e293b;
  font-size: 16px;
}

.qr-help {
  background: #eff6ff;
  border: 1px solid #bfdbfe;
  border-radius: 8px;
  padding: 16px;
}

.qr-help h4 {
  margin-top: 0;
  color: #1e40af;
  font-size: 14px;
}

.qr-help ul {
  margin: 0;
  padding-left: 20px;
}

.qr-help li {
  margin-bottom: 8px;
  color: #1e293b;
  font-size: 14px;
  line-height: 1.5;
}

@media (max-width: 640px) {
  .qr-grid {
    grid-template-columns: 1fr;
  }

  .qr-actions {
    flex-direction: column;
  }

  .qr-actions button {
    width: 100%;
  }
}
</style>
