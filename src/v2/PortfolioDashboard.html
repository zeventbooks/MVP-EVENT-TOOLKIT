<!--
================================================================================
V2 SURFACE - Post-MVP Feature
================================================================================
Page: PortfolioDashboard.html
Purpose: Dedicated portfolio report surface for SEM-level sponsor ROI messaging
Status: V2 (not needed for first pilots, huge future upsell lever)

SCHEMA CONTRACT: /schemas/sponsor-portfolio-v2.schema.json (v2.0.0)

═══════════════════════════════════════════════════════════════════════════════
READS FROM SPONSORPORTFOLIOV2 (via api_getPortfolioAnalyticsV2):
═══════════════════════════════════════════════════════════════════════════════
  Root:
    - mode                    → 'multi-event-portfolio'
    - lastUpdatedISO          → Last updated timestamp
    - portfolio.parent        → Parent org info
    - portfolio.children[]    → Child brands in portfolio
    - summary                 → Aggregated metrics
    - byBrand                 → Per-brand breakdown
    - sponsors[]              → Portfolio sponsors list
    - topPerformingEvents[]   → Top events by impressions

  Summary Fields:
    - summary.totalEvents     → Total events metric
    - summary.totalImpressions
    - summary.totalClicks
    - summary.totalQrScans
    - summary.totalSignups
    - summary.totalSponsors
    - summary.activeSponsors
    - summary.portfolioCTR

═══════════════════════════════════════════════════════════════════════════════
API ENDPOINTS:
═══════════════════════════════════════════════════════════════════════════════
  - api_getPortfolioAnalyticsV2({ brandId, mode, adminKey }) → PortfolioAnalytics
  - api_getPortfolioSummaryV2({ brandId, adminKey }) → Summary
  - api_getPortfolioSponsorReportV2({ brandId, sponsorId, adminKey }) → SponsorReport
  - api_getPortfolioSponsorsV2({ brandId, adminKey }) → SponsorList

SEM-LEVEL MESSAGING:
  This dashboard uses clear, executive-friendly language designed to:
  - Demonstrate total sponsor ROI across all brands
  - Highlight cross-brand reach and engagement
  - Support upsell conversations with parent organizations
  - Provide exportable metrics for sponsor presentations
================================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> · Portfolio Dashboard</title>
  <?!= include('Header'); ?>
  <?!= include('HeaderInit'); ?>
  <?!= include('NUSDK'); ?>
  <?!= include('DesignTokens'); ?>
  <?!= include('Styles'); ?>
  <?!= include('FooterComponent'); ?>
  <?!= include('SpinnerComponent'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="referrer" content="no-referrer"/>
  <style>
    /* ═══════════════════════════════════════════════════════════════════════
       PORTFOLIO DASHBOARD STYLES
       SEM-level executive presentation styling
       ═══════════════════════════════════════════════════════════════════════ */

    /* Dashboard Header - Premium gradient for executive feel */
    .portfolio-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #3b7ab8 100%);
      color: white;
      padding: 2.5rem;
      border-radius: var(--radius-md, 12px);
      margin-bottom: 1.5rem;
      box-shadow: 0 8px 32px rgba(30, 58, 95, 0.25);
      position: relative;
      overflow: hidden;
    }

    .portfolio-header::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      transform: translate(50%, -50%);
    }

    .portfolio-header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
      position: relative;
    }

    .portfolio-header .tagline {
      font-size: 1.125rem;
      opacity: 0.95;
      margin-bottom: 0.75rem;
    }

    .portfolio-header .portfolio-context {
      font-size: var(--font-size-sm, 0.875rem);
      opacity: 0.85;
      max-width: 600px;
      line-height: 1.6;
    }

    .portfolio-header .org-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.15);
      padding: 6px 12px;
      border-radius: var(--radius-full, 9999px);
      font-size: var(--font-size-xs, 0.75rem);
      font-weight: 600;
      margin-top: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Executive Summary Card - Hero metrics */
    .executive-summary {
      background: white;
      border-radius: var(--radius-md, 12px);
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-md, 0 4px 6px rgba(0,0,0,0.1));
      border: 1px solid var(--color-gray-200, #e2e8f0);
    }

    .executive-summary h2 {
      font-size: 1.25rem;
      color: var(--color-gray-800, #1e293b);
      margin-bottom: 0.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .executive-summary .summary-tagline {
      font-size: var(--font-size-sm, 0.875rem);
      color: var(--color-gray-500, #64748b);
      margin-bottom: 1.5rem;
    }

    /* Hero Metrics Grid - Large, impactful numbers */
    .hero-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.5rem;
    }

    @media (max-width: 1024px) {
      .hero-metrics {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 640px) {
      .hero-metrics {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }

    .hero-metric {
      text-align: center;
      padding: 1.5rem;
      background: var(--color-gray-50, #f8fafc);
      border-radius: var(--radius-base, 8px);
      border: 1px solid var(--color-gray-200, #e2e8f0);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .hero-metric:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .hero-metric .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--color-gray-900, #0f172a);
      line-height: 1;
      margin-bottom: 0.5rem;
    }

    .hero-metric .metric-label {
      font-size: var(--font-size-sm, 0.875rem);
      color: var(--color-gray-600, #475569);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .hero-metric .metric-sublabel {
      font-size: var(--font-size-xs, 0.75rem);
      color: var(--color-gray-400, #94a3b8);
      margin-top: 0.25rem;
    }

    .hero-metric.highlight {
      background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
      border-color: var(--color-primary, #2563eb);
    }

    .hero-metric.highlight .metric-value {
      color: var(--color-primary, #2563eb);
    }

    .hero-metric.success {
      background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
      border-color: var(--color-success, #10b981);
    }

    .hero-metric.success .metric-value {
      color: var(--color-success, #10b981);
    }

    /* Portfolio Reach Card - Shows brand coverage */
    .portfolio-reach {
      background: white;
      border-radius: var(--radius-md, 12px);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-base, 0 1px 3px rgba(0,0,0,0.1));
      border: 1px solid var(--color-gray-200, #e2e8f0);
    }

    .portfolio-reach h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-gray-800, #1e293b);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .brand-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--color-gray-100, #f1f5f9);
      border-radius: var(--radius-full, 9999px);
      font-size: var(--font-size-sm, 0.875rem);
      font-weight: 500;
      color: var(--color-gray-700, #334155);
      transition: all 0.2s;
    }

    .brand-chip:hover {
      background: var(--color-gray-200, #e2e8f0);
    }

    .brand-chip.parent {
      background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
      border: 1px solid var(--color-primary, #2563eb);
      color: var(--color-primary, #2563eb);
    }

    .brand-chip .chip-badge {
      font-size: var(--font-size-xs, 0.75rem);
      background: var(--color-gray-300, #cbd5e1);
      padding: 2px 6px;
      border-radius: var(--radius-full, 9999px);
    }

    .brand-chip.parent .chip-badge {
      background: var(--color-primary, #2563eb);
      color: white;
    }

    /* Section Cards */
    .section-card {
      background: white;
      border-radius: var(--radius-md, 12px);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-base, 0 1px 3px rgba(0,0,0,0.1));
      border: 1px solid var(--color-gray-200, #e2e8f0);
    }

    .section-card h2 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      color: var(--color-gray-800, #1e293b);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-card .section-help {
      font-size: var(--font-size-sm, 0.875rem);
      color: var(--color-gray-500, #64748b);
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    /* Data Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-size-sm, 0.875rem);
    }

    .data-table thead {
      background: var(--color-gray-100, #f1f5f9);
    }

    .data-table th {
      padding: 0.75rem 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--color-gray-600, #475569);
      font-size: var(--font-size-xs, 0.75rem);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--color-gray-200, #e2e8f0);
    }

    .data-table td {
      padding: 1rem;
      border-bottom: 1px solid var(--color-gray-100, #f1f5f9);
    }

    .data-table tbody tr:hover {
      background: var(--color-gray-50, #f8fafc);
    }

    /* Mobile table cards */
    @media (max-width: 640px) {
      .data-table thead { display: none; }
      .data-table, .data-table tbody, .data-table tr, .data-table td {
        display: block;
        width: 100%;
      }
      .data-table tr {
        margin-bottom: 1rem;
        background: white;
        border: 1px solid var(--color-gray-200, #e2e8f0);
        border-radius: var(--radius-base, 8px);
        padding: 0.75rem;
      }
      .data-table td {
        padding: 0.5rem 0;
        border: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .data-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--color-gray-500, #64748b);
        text-transform: uppercase;
        font-size: var(--font-size-xs, 0.75rem);
      }
    }

    /* Badges */
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-full, 9999px);
      font-size: var(--font-size-xs, 0.75rem);
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge.success { background: var(--color-success-pale, #d1fae5); color: var(--color-success, #10b981); }
    .badge.warning { background: var(--color-warning-pale, #fef3c7); color: var(--color-warning-dark, #d97706); }
    .badge.info { background: var(--color-primary-pale, #dbeafe); color: var(--color-primary, #2563eb); }
    .badge.neutral { background: var(--color-gray-200, #e2e8f0); color: var(--color-gray-600, #475569); }

    /* Rank badges for top performers */
    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: var(--radius-full, 9999px);
      font-size: 1rem;
      margin-right: 8px;
    }

    /* SEM Value Proposition Card */
    .value-prop-card {
      background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
      border: 2px solid #f59e0b;
      border-radius: var(--radius-md, 12px);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .value-prop-card h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .value-prop-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .value-prop-grid {
        grid-template-columns: 1fr;
      }
    }

    .value-prop-item {
      background: white;
      padding: 1rem;
      border-radius: var(--radius-base, 8px);
      text-align: center;
    }

    .value-prop-item .prop-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #92400e;
      margin-bottom: 0.25rem;
    }

    .value-prop-item .prop-label {
      font-size: var(--font-size-xs, 0.75rem);
      color: #b45309;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Action Bar */
    .action-bar {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    /* Loading State */
    .loading-state {
      text-align: center;
      padding: 4rem 2rem;
    }

    /* Error State */
    .error-state {
      text-align: center;
      padding: 3rem 1.5rem;
      background: #fef2f2;
      border-radius: var(--radius-md, 12px);
      border: 1px solid #fecaca;
      margin: 2rem auto;
      max-width: 500px;
    }

    .error-state h3 {
      color: #dc2626;
      margin-bottom: 0.5rem;
    }

    .error-state p {
      color: #b91c1c;
      margin-bottom: 1rem;
    }

    /* Auth Required State */
    .auth-required {
      text-align: center;
      padding: 4rem 2rem;
      background: white;
      border-radius: var(--radius-md, 12px);
      box-shadow: var(--shadow-md, 0 4px 6px rgba(0,0,0,0.1));
      max-width: 500px;
      margin: 2rem auto;
    }

    .auth-required h2 {
      margin-bottom: 1rem;
      color: var(--color-gray-800, #1e293b);
    }

    .auth-required p {
      color: var(--color-gray-600, #475569);
      margin-bottom: 1.5rem;
    }

    .auth-required input {
      width: 100%;
      max-width: 300px;
      padding: 12px 16px;
      border: 1px solid var(--color-gray-300, #cbd5e1);
      border-radius: var(--radius-base, 8px);
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .auth-required input:focus {
      outline: none;
      border-color: var(--color-primary, #2563eb);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* Sponsor filter dropdown */
    .sponsor-filter {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 1rem;
      background: var(--color-gray-50, #f8fafc);
      border-radius: var(--radius-base, 8px);
      margin-bottom: 1rem;
    }

    .sponsor-filter label {
      font-weight: 500;
      color: var(--color-gray-700, #334155);
    }

    .sponsor-filter select {
      flex: 1;
      max-width: 300px;
      padding: 8px 12px;
      border: 1px solid var(--color-gray-300, #cbd5e1);
      border-radius: var(--radius-base, 8px);
      font-size: var(--font-size-sm, 0.875rem);
    }

    /* Mobile responsive adjustments */
    @media (max-width: 640px) {
      .container {
        padding: 12px;
      }

      .portfolio-header {
        padding: 1.5rem;
      }

      .portfolio-header h1 {
        font-size: 1.5rem;
      }

      .executive-summary {
        padding: 1.25rem;
      }

      .hero-metric .metric-value {
        font-size: 2rem;
      }

      .section-card {
        padding: 1rem;
      }

      .action-bar {
        flex-direction: column;
      }

      .action-bar .btn {
        width: 100%;
        justify-content: center;
      }

      .sponsor-filter {
        flex-direction: column;
        align-items: stretch;
      }

      .sponsor-filter select {
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Auth Required State (shown initially if no adminKey) -->
    <div id="authRequired" style="display:none;">
      <div class="auth-required">
        <h2>Portfolio Access Required</h2>
        <p>Enter your admin key to view cross-brand portfolio analytics.</p>
        <input type="password" id="adminKeyInput" placeholder="Admin Key" autocomplete="off"/>
        <br/>
        <button class="btn btn-primary" onclick="authenticateAndLoad()">Access Portfolio</button>
        <p style="margin-top:1rem;font-size:0.75rem;color:var(--color-gray-400);">
          Contact your organization admin for access credentials.
        </p>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" style="display:none;">
      <div class="loading-state">
        <div class="spinner"></div>
        <p style="margin-top:1rem;color:var(--color-gray-500);">Loading portfolio analytics...</p>
      </div>
    </div>

    <!-- Error State -->
    <div id="errorState" style="display:none;">
      <div class="error-state">
        <h3>Unable to Load Portfolio</h3>
        <p id="errorMessage">An error occurred while loading the dashboard.</p>
        <button class="btn btn-primary" onclick="loadPortfolio()">Try Again</button>
      </div>
    </div>

    <!-- Main Dashboard Content -->
    <div id="dashboardContent" style="display:none;">
      <!-- Portfolio Header -->
      <div class="portfolio-header">
        <h1 id="portfolioTitle">Portfolio Analytics Dashboard</h1>
        <p class="tagline" id="portfolioTagline">Your complete cross-brand sponsorship ROI at a glance</p>
        <p class="portfolio-context" id="portfolioContext">
          Consolidated metrics across all your brands. Share this dashboard with sponsors to demonstrate total portfolio value.
        </p>
        <div class="org-badge" id="orgBadge">
          <span>Parent Organization</span>
        </div>
      </div>

      <!-- Action Bar -->
      <div class="action-bar">
        <button id="refreshBtn" class="btn btn-primary" onclick="loadPortfolio()">
          <span class="btn-text">Refresh Data</span>
        </button>
        <button id="exportBtn" class="btn btn-secondary" onclick="showExportOptions()" style="display:none;">
          <span class="btn-text">Export Report</span>
        </button>
      </div>

      <!-- Executive Summary -->
      <div class="executive-summary">
        <h2>Executive Summary</h2>
        <p class="summary-tagline" id="summaryTagline">Your portfolio's total sponsor engagement and reach</p>
        <div class="hero-metrics" id="heroMetrics">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- SEM Value Proposition -->
      <div class="value-prop-card" id="valueProposition">
        <h3>Sponsor Value Highlights</h3>
        <div class="value-prop-grid" id="valuePropGrid">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Portfolio Reach -->
      <div class="portfolio-reach" id="portfolioReach">
        <h3>Portfolio Brands</h3>
        <div class="brand-chips" id="brandChips">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Sponsor Filter -->
      <div class="sponsor-filter" id="sponsorFilter" style="display:none;">
        <label for="sponsorSelect">Filter by Sponsor:</label>
        <select id="sponsorSelect" onchange="filterBySponsor()">
          <option value="">All Sponsors</option>
        </select>
      </div>

      <!-- Brand Performance -->
      <div class="section-card" id="brandPerformanceCard">
        <h2>Performance by Brand</h2>
        <p class="section-help">Compare sponsor engagement across your portfolio brands.</p>
        <div class="table-scroll-wrapper">
          <div id="brandPerformance"></div>
        </div>
      </div>

      <!-- Top Sponsors -->
      <div class="section-card" id="topSponsorsCard">
        <h2>Top Performing Sponsors</h2>
        <p class="section-help">Sponsors driving the most engagement across your portfolio.</p>
        <div class="table-scroll-wrapper">
          <div id="topSponsors"></div>
        </div>
      </div>

      <!-- Top Events -->
      <div class="section-card" id="topEventsCard">
        <h2>Top Performing Events</h2>
        <p class="section-help">Events with the highest sponsor engagement and visibility.</p>
        <div class="table-scroll-wrapper">
          <div id="topEvents"></div>
        </div>
      </div>

      <!-- Last Updated -->
      <p id="lastUpdated" style="text-align:center;color:var(--color-gray-400);font-size:var(--font-size-xs);margin-top:2rem;"></p>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <p>Powered by <a href="https://eventangle.com" target="_blank" rel="noopener">EventAngle</a></p>
  </footer>

  <script>
    // ═══════════════════════════════════════════════════════════════════════════
    // PORTFOLIO DASHBOARD - V2 Feature
    // SEM-level executive dashboard for cross-brand sponsor ROI
    // ═══════════════════════════════════════════════════════════════════════════

    const BRAND_ID = '<?= brandId ?>';
    const urlParams = new URLSearchParams(window.location.search);
    let ADMIN_KEY = urlParams.get('adminKey') || '';
    let currentPortfolioData = null;
    let currentSponsorFilter = '';

    /**
     * Initialize dashboard on load
     */
    function init() {
      if (ADMIN_KEY) {
        loadPortfolio();
      } else {
        showAuthRequired();
      }
    }

    /**
     * Show authentication required state
     */
    function showAuthRequired() {
      document.getElementById('authRequired').style.display = 'block';
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'none';
    }

    /**
     * Authenticate with admin key and load portfolio
     */
    function authenticateAndLoad() {
      const keyInput = document.getElementById('adminKeyInput');
      ADMIN_KEY = keyInput.value.trim();

      if (!ADMIN_KEY) {
        keyInput.style.borderColor = '#ef4444';
        return;
      }

      // Update URL with admin key for sharing
      const newUrl = new URL(window.location.href);
      newUrl.searchParams.set('adminKey', ADMIN_KEY);
      window.history.replaceState({}, '', newUrl.toString());

      loadPortfolio();
    }

    /**
     * Load portfolio analytics data
     */
    async function loadPortfolio() {
      showLoading();

      try {
        const result = await NU.rpc('api_getPortfolioAnalyticsV2', {
          brandId: BRAND_ID,
          mode: 'multi-event-portfolio',
          adminKey: ADMIN_KEY,
          sponsorId: currentSponsorFilter || undefined
        });

        if (!result || !result.ok) {
          throw new Error(result?.message || 'Failed to load portfolio analytics');
        }

        currentPortfolioData = result.value;
        renderDashboard(currentPortfolioData);
        showDashboard();

        // Load sponsors for filter dropdown
        loadSponsorsForFilter();

      } catch (err) {
        console.error('Portfolio load error:', err);
        showError(err.message);
      }
    }

    /**
     * Load sponsors list for filter dropdown
     */
    async function loadSponsorsForFilter() {
      try {
        const result = await NU.rpc('api_getPortfolioSponsorsV2', {
          brandId: BRAND_ID,
          adminKey: ADMIN_KEY
        });

        if (result && result.ok && result.value.sponsors) {
          populateSponsorFilter(result.value.sponsors);
        }
      } catch (e) {
        console.warn('Failed to load sponsors filter:', e);
      }
    }

    /**
     * Populate sponsor filter dropdown
     */
    function populateSponsorFilter(sponsors) {
      if (!sponsors.length) return;

      const select = document.getElementById('sponsorSelect');
      sponsors.forEach(sponsor => {
        const option = document.createElement('option');
        option.value = sponsor.id;
        option.textContent = sponsor.name || sponsor.id;
        select.appendChild(option);
      });

      document.getElementById('sponsorFilter').style.display = 'flex';
    }

    /**
     * Filter by selected sponsor
     */
    function filterBySponsor() {
      const select = document.getElementById('sponsorSelect');
      currentSponsorFilter = select.value;
      loadPortfolio();
    }

    /**
     * Show loading state
     */
    function showLoading() {
      document.getElementById('authRequired').style.display = 'none';
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('errorState').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'none';
    }

    /**
     * Show dashboard content
     */
    function showDashboard() {
      document.getElementById('authRequired').style.display = 'none';
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'block';
    }

    /**
     * Show error state
     */
    function showError(message) {
      document.getElementById('authRequired').style.display = 'none';
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
      document.getElementById('dashboardContent').style.display = 'none';
      document.getElementById('errorMessage').textContent = message || 'An error occurred';
    }

    /**
     * Render the full dashboard
     */
    function renderDashboard(data) {
      renderHeader(data);
      renderHeroMetrics(data.summary);
      renderValueProposition(data.summary);
      renderPortfolioReach(data.portfolio);
      renderBrandPerformance(data.byBrand);
      renderTopSponsors(data.sponsors);
      renderTopEvents(data.topPerformingEvents);
      renderLastUpdated(data.lastUpdatedISO || data.generatedAt);
    }

    /**
     * Render dashboard header with org info
     */
    function renderHeader(data) {
      const parent = data.portfolio?.parent || {};
      const childCount = data.portfolio?.children?.length || 0;

      document.getElementById('portfolioTitle').textContent = 'Portfolio Analytics Dashboard';
      document.getElementById('portfolioTagline').textContent =
        `Cross-brand sponsorship ROI for ${escapeHtml(parent.name || BRAND_ID)}`;
      document.getElementById('portfolioContext').textContent =
        `Consolidated metrics across ${childCount + 1} brand${childCount !== 0 ? 's' : ''}. ` +
        'Share this dashboard with sponsors to demonstrate total portfolio value and justify renewal conversations.';
      document.getElementById('orgBadge').innerHTML =
        `<span>${escapeHtml(parent.name || BRAND_ID)}</span> · ${childCount + 1} Brands`;
    }

    /**
     * Render hero metrics with SEM-level messaging
     */
    function renderHeroMetrics(summary) {
      const container = document.getElementById('heroMetrics');
      if (!summary) {
        container.innerHTML = '<p class="muted">No summary data available.</p>';
        return;
      }

      const metrics = [
        {
          value: (summary.totalImpressions || 0).toLocaleString(),
          label: 'Total Reach',
          sublabel: 'Sponsor impressions',
          className: 'highlight'
        },
        {
          value: (summary.totalClicks || 0).toLocaleString(),
          label: 'Engagements',
          sublabel: 'Sponsor clicks',
          className: ''
        },
        {
          value: (summary.portfolioCTR || 0).toFixed(2) + '%',
          label: 'Click Rate',
          sublabel: 'Portfolio CTR',
          className: (summary.portfolioCTR || 0) >= 2 ? 'success' : ''
        },
        {
          value: summary.totalEvents || 0,
          label: 'Events',
          sublabel: 'Across portfolio',
          className: ''
        }
      ];

      container.innerHTML = metrics.map(m => `
        <div class="hero-metric ${m.className}">
          <div class="metric-value">${m.value}</div>
          <div class="metric-label">${m.label}</div>
          <div class="metric-sublabel">${m.sublabel}</div>
        </div>
      `).join('');
    }

    /**
     * Render SEM value proposition highlights
     */
    function renderValueProposition(summary) {
      const container = document.getElementById('valuePropGrid');
      if (!summary) {
        container.parentElement.style.display = 'none';
        return;
      }

      const impressions = summary.totalImpressions || 0;
      const clicks = summary.totalClicks || 0;
      const qrScans = summary.totalQrScans || 0;
      const totalInteractions = clicks + qrScans;

      // Calculate equivalent advertising value (rough estimate for SEM messaging)
      // Assuming $5 CPM for local event advertising
      const estimatedAdValue = (impressions / 1000) * 5;

      const props = [
        {
          value: (impressions / 1000).toFixed(1) + 'K',
          label: 'Sponsor Views'
        },
        {
          value: totalInteractions.toLocaleString(),
          label: 'Total Interactions'
        },
        {
          value: '$' + estimatedAdValue.toFixed(0),
          label: 'Est. Ad Value'
        }
      ];

      container.innerHTML = props.map(p => `
        <div class="value-prop-item">
          <div class="prop-value">${p.value}</div>
          <div class="prop-label">${p.label}</div>
        </div>
      `).join('');
    }

    /**
     * Render portfolio reach with brand chips
     */
    function renderPortfolioReach(portfolio) {
      const container = document.getElementById('brandChips');
      if (!portfolio) {
        container.innerHTML = '<span class="muted">No portfolio data.</span>';
        return;
      }

      const parent = portfolio.parent || {};
      const children = portfolio.children || [];

      let html = `
        <span class="brand-chip parent">
          ${escapeHtml(parent.name || parent.id || 'Parent')}
          <span class="chip-badge">Parent</span>
        </span>
      `;

      children.forEach(child => {
        html += `
          <span class="brand-chip">
            ${escapeHtml(child.name || child.id)}
          </span>
        `;
      });

      container.innerHTML = html;
    }

    /**
     * Render brand performance table
     */
    function renderBrandPerformance(byBrand) {
      const container = document.getElementById('brandPerformance');

      if (!byBrand || Object.keys(byBrand).length === 0) {
        container.innerHTML = '<p class="muted">No brand performance data available.</p>';
        return;
      }

      const brands = Object.values(byBrand).sort((a, b) => b.impressions - a.impressions);

      const rows = brands.map(brand => {
        const ctr = brand.ctr || 0;
        const badgeClass = ctr >= 2 ? 'success' : ctr >= 1 ? 'info' : 'warning';

        return `
          <tr>
            <td data-label="Brand"><strong>${escapeHtml(brand.brandName || brand.brandId)}</strong></td>
            <td data-label="Events">${brand.events || 0}</td>
            <td data-label="Impressions">${(brand.impressions || 0).toLocaleString()}</td>
            <td data-label="Clicks">${(brand.clicks || 0).toLocaleString()}</td>
            <td data-label="QR Scans">${(brand.qrScans || 0).toLocaleString()}</td>
            <td data-label="Signups">${(brand.signups || 0).toLocaleString()}</td>
            <td data-label="CTR"><span class="badge ${badgeClass}">${ctr.toFixed(2)}%</span></td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Brand</th>
              <th>Events</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>QR Scans</th>
              <th>Signups</th>
              <th>CTR</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    /**
     * Render top sponsors table
     */
    function renderTopSponsors(sponsors) {
      const container = document.getElementById('topSponsors');

      if (!sponsors || sponsors.length === 0) {
        container.innerHTML = '<p class="muted">No sponsor data available.</p>';
        return;
      }

      const rankEmojis = ['1st', '2nd', '3rd'];

      const rows = sponsors.slice(0, 10).map((sponsor, idx) => {
        const metrics = sponsor.metrics || {};
        const ctr = metrics.ctr || 0;
        const badgeClass = ctr >= 2 ? 'success' : ctr >= 1 ? 'info' : 'warning';
        const rank = idx < 3 ? rankEmojis[idx] : '#' + (idx + 1);

        return `
          <tr>
            <td data-label="Rank"><span class="badge neutral">${rank}</span></td>
            <td data-label="Sponsor"><strong>${escapeHtml(sponsor.name || sponsor.id)}</strong></td>
            <td data-label="Impressions">${(metrics.impressions || 0).toLocaleString()}</td>
            <td data-label="Clicks">${(metrics.clicks || 0).toLocaleString()}</td>
            <td data-label="QR Scans">${(metrics.qrScans || 0).toLocaleString()}</td>
            <td data-label="CTR"><span class="badge ${badgeClass}">${ctr.toFixed(2)}%</span></td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Sponsor</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>QR Scans</th>
              <th>CTR</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    /**
     * Render top events table
     */
    function renderTopEvents(events) {
      const container = document.getElementById('topEvents');

      if (!events || events.length === 0) {
        container.innerHTML = '<p class="muted">No event data available.</p>';
        return;
      }

      const rankEmojis = ['1st', '2nd', '3rd'];

      const rows = events.slice(0, 10).map((event, idx) => {
        const ctr = event.ctr || 0;
        const badgeClass = ctr >= 2 ? 'success' : ctr >= 1 ? 'info' : 'warning';
        const rank = idx < 3 ? rankEmojis[idx] : '#' + (idx + 1);

        return `
          <tr>
            <td data-label="Rank"><span class="badge neutral">${rank}</span></td>
            <td data-label="Event">
              <strong>${escapeHtml(event.name || event.id)}</strong>
              <br/><small style="color:var(--color-gray-400)">${escapeHtml(event.brandName || event.brandId || '')}</small>
            </td>
            <td data-label="Impressions">${(event.impressions || 0).toLocaleString()}</td>
            <td data-label="Clicks">${(event.clicks || 0).toLocaleString()}</td>
            <td data-label="Signups">${(event.signupsCount || 0).toLocaleString()}</td>
            <td data-label="CTR"><span class="badge ${badgeClass}">${ctr.toFixed(2)}%</span></td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Event</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>Signups</th>
              <th>CTR</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    /**
     * Render last updated timestamp
     */
    function renderLastUpdated(timestamp) {
      const el = document.getElementById('lastUpdated');
      if (timestamp) {
        el.textContent = 'Last updated: ' + new Date(timestamp).toLocaleString();
      } else {
        el.textContent = '';
      }
    }

    /**
     * Show export options (V2+ feature placeholder)
     */
    function showExportOptions() {
      alert('Export functionality coming soon. Contact support for custom reports.');
    }

    /**
     * Escape HTML for XSS prevention
     */
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Initialize on page load
    window.addEventListener('load', init);
  </script>
</body>
</html>
