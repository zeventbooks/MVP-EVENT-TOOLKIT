<script>
/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * SharedUtils - Common utilities for all front-end pages
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 *
 * RESPONSIBILITY: This file provides UI utilities (alerts, dates, forms) ONLY.
 * It does NOT handle data entities or business logic - that belongs in Code.gs.
 *
 * WINDOW ADDITION: window.SharedUtils
 *
 * Dependencies: NUSDK.html (for NU.esc)
 * Used by: Public.html, Display.html, Poster.html, SharedReport.html, Admin.html
 *
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * HELPER INDEX (keep updated when adding/removing functions):
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 *   showAlert(message, type, options)  ‚Üí Alert notifications (Admin.html)
 *   showToast(message, type, duration) ‚Üí Toast notifications (all surfaces)
 *   formatDate(dateInput, options)     ‚Üí Date formatting (Admin.html)
 *   formatTime(timeStr)                ‚Üí Time formatting (Admin.html)
 *   debounce(fn, delay)                ‚Üí Event debouncing (Admin.html)
 *   copyToClipboard(text)              ‚Üí Clipboard utility (Admin.html)
 *   validateUrl(url)                   ‚Üí URL validation (Admin.html)
 *   sectionEnabled(settings, key)      ‚Üí Section visibility check (Feature 4)
 *     Keys: schedule, standings, bracket, sponsors, video, map, gallery
 *
 * S12: StateRenderer - Unified error/empty/loading states (all surfaces)
 *   StateRenderer.showError(container, options)      ‚Üí Error state
 *   StateRenderer.showEmpty(container, options)      ‚Üí Empty state
 *   StateRenderer.showLoading(container, options)    ‚Üí Loading state
 *   StateRenderer.showEventNotFound(container, opts) ‚Üí Event not found
 *   StateRenderer.showNoData(container, opts)        ‚Üí No data yet
 *   StateRenderer.showNetworkError(container, opts)  ‚Üí Connection error
 *   StateRenderer.showUnauthorized(container, opts)  ‚Üí Access denied
 *   StateRenderer.showFromError(container, err, opts)‚Üí Auto-detect type
 *   ERROR_TYPES                                      ‚Üí Standard error types
 *   classifyError(error)                             ‚Üí Map error to type
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 *
 * @version 1.3.0
 */
window.SharedUtils = (function() {
  'use strict';

  // === Alert/Notification System ===

  /**
   * Shows a dismissible alert notification
   * @param {string} message - Alert message text
   * @param {string} type - Alert type: 'info', 'success', 'error', 'warning'
   * @param {Object} options - Optional configuration
   * @param {number} options.duration - Auto-dismiss duration in ms (0 = no auto-dismiss)
   * @param {string} options.containerId - ID of alert container element
   */
  function showAlert(message, type = 'info', options = {}) {
    const {
      duration = 5000,
      containerId = 'alert-container'
    } = options;

    const container = document.getElementById(containerId);
    if (!container) {
      console.warn(`SharedUtils.showAlert: Container #${containerId} not found`);
      return;
    }

    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.setAttribute('role', 'alert');

    // Create alert content with dismiss button
    const content = document.createElement('span');
    content.textContent = message;

    const dismissBtn = document.createElement('button');
    dismissBtn.type = 'button';
    dismissBtn.className = 'alert-dismiss';
    dismissBtn.innerHTML = '&times;';
    dismissBtn.setAttribute('aria-label', 'Dismiss');
    dismissBtn.onclick = () => alert.remove();

    alert.appendChild(content);
    alert.appendChild(dismissBtn);

    // Clear existing alerts and add new one
    container.innerHTML = '';
    container.appendChild(alert);

    // Auto-dismiss if duration > 0
    if (duration > 0) {
      setTimeout(() => {
        if (alert.parentNode) {
          alert.classList.add('alert-fade-out');
          setTimeout(() => alert.remove(), 300);
        }
      }, duration);
    }

    return alert;
  }

  // === Date Formatting ===

  /**
   * Formats a date string to a human-readable format
   * @param {string|Date} dateInput - Date string or Date object
   * @param {Object} options - Intl.DateTimeFormat options
   * @returns {string} Formatted date string
   */
  function formatDate(dateInput, options = {}) {
    if (!dateInput) return 'Date TBD';

    try {
      const date = dateInput instanceof Date ? dateInput : new Date(dateInput);
      if (isNaN(date.getTime())) return 'Invalid Date';

      const defaultOptions = {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      };

      return date.toLocaleDateString('en-US', { ...defaultOptions, ...options });
    } catch (e) {
      return 'Date TBD';
    }
  }

  /**
   * Formats a date string to a relative time (e.g., "2 days ago")
   * @param {string|Date} dateInput - Date string or Date object
   * @returns {string} Relative time string
   */
  function formatRelativeTime(dateInput) {
    if (!dateInput) return '';

    try {
      const date = dateInput instanceof Date ? dateInput : new Date(dateInput);
      if (isNaN(date.getTime())) return '';

      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
      if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
      return `${Math.floor(diffDays / 365)} years ago`;
    } catch (e) {
      return '';
    }
  }

  // === Form Utilities ===

  /**
   * Validates a form and returns validation status
   * @param {string|HTMLFormElement} formIdOrEl - Form ID or form element
   * @returns {Object} { valid: boolean, errors: Array<{field, message}> }
   */
  function validateForm(formIdOrEl) {
    const form = typeof formIdOrEl === 'string'
      ? document.getElementById(formIdOrEl)
      : formIdOrEl;

    if (!form) return { valid: false, errors: [{ field: null, message: 'Form not found' }] };

    const errors = [];
    const requiredInputs = form.querySelectorAll('[required]');

    requiredInputs.forEach(input => {
      // Clear previous error state
      input.classList.remove('form-input-error');

      if (!input.value.trim()) {
        errors.push({
          field: input.name || input.id,
          message: `${input.labels?.[0]?.textContent || input.name || 'Field'} is required`
        });
        input.classList.add('form-input-error');
      }
    });

    // Validate email fields
    form.querySelectorAll('input[type="email"]').forEach(input => {
      if (input.value && !isValidEmail(input.value)) {
        errors.push({ field: input.name || input.id, message: 'Invalid email address' });
        input.classList.add('form-input-error');
      }
    });

    // Validate URL fields
    form.querySelectorAll('input[type="url"]').forEach(input => {
      if (input.value && !isValidUrl(input.value)) {
        errors.push({ field: input.name || input.id, message: 'Invalid URL' });
        input.classList.add('form-input-error');
      }
    });

    return { valid: errors.length === 0, errors };
  }

  /**
   * Validates an email address
   * @param {string} email - Email to validate
   * @returns {boolean} True if valid
   */
  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  /**
   * Validates a URL
   * @param {string} url - URL to validate
   * @returns {boolean} True if valid
   */
  function isValidUrl(url) {
    try {
      new URL(url);
      return true;
    } catch {
      return false;
    }
  }

  // === Loading State Management ===

  /**
   * Executes an async function with loading state management
   * @param {Function} asyncFn - Async function to execute
   * @param {Object} options - Configuration options
   * @param {string} options.loadingElId - ID of loading indicator element
   * @param {string} options.emptyElId - ID of empty state element
   * @param {string} options.contentElId - ID of content container element
   * @param {HTMLButtonElement} options.button - Submit button to disable
   * @returns {Promise<any>} Result of asyncFn
   */
  async function withLoadingState(asyncFn, options = {}) {
    const { loadingElId, emptyElId, contentElId, button } = options;

    const loadingEl = loadingElId ? document.getElementById(loadingElId) : null;
    const emptyEl = emptyElId ? document.getElementById(emptyElId) : null;
    const contentEl = contentElId ? document.getElementById(contentElId) : null;

    // Show loading state
    if (loadingEl) loadingEl.style.display = 'block';
    if (emptyEl) emptyEl.style.display = 'none';
    if (contentEl) contentEl.style.display = 'none';
    if (button) button.disabled = true;

    try {
      const result = await asyncFn();
      return result;
    } finally {
      // Hide loading state
      if (loadingEl) loadingEl.style.display = 'none';
      if (button) button.disabled = false;
    }
  }

  // === DOM Utilities ===

  /**
   * Toggles element visibility
   * @param {string} elementId - ID of element to toggle
   * @param {string} className - Class to toggle (default: 'hidden')
   */
  function toggleElement(elementId, className = 'hidden') {
    const el = document.getElementById(elementId);
    if (el) el.classList.toggle(className);
  }

  /**
   * Shows an element by removing hidden class
   * @param {string} elementId - ID of element to show
   */
  function showElement(elementId) {
    const el = document.getElementById(elementId);
    if (el) el.style.display = 'block';
  }

  /**
   * Hides an element by setting display none
   * @param {string} elementId - ID of element to hide
   */
  function hideElement(elementId) {
    const el = document.getElementById(elementId);
    if (el) el.style.display = 'none';
  }

  // === XSS Prevention (delegating to NU.esc) ===

  /**
   * Escapes HTML special characters to prevent XSS
   * Delegates to NU.esc if available, otherwise uses local implementation
   *
   * IMPORTANT: Prefer using NU.esc() directly when NUSDK is included.
   * This is provided for backwards compatibility.
   *
   * @param {string} unsafe - String to escape
   * @returns {string} HTML-safe string
   */
  function esc(unsafe) {
    // Delegate to NU.esc if available (canonical implementation)
    if (window.NU && typeof window.NU.esc === 'function') {
      return window.NU.esc(unsafe);
    }
    // Fallback implementation (should rarely be used)
    if (!unsafe) return '';
    return String(unsafe).replace(/[&<>"']/g, m => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[m]));
  }

  // === Debounce/Throttle ===

  /**
   * Creates a debounced version of a function
   * @param {Function} fn - Function to debounce
   * @param {number} delay - Delay in milliseconds
   * @returns {Function} Debounced function
   */
  function debounce(fn, delay = 300) {
    let timeoutId;
    return function(...args) {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  /**
   * Creates a throttled version of a function
   * @param {Function} fn - Function to throttle
   * @param {number} limit - Minimum time between calls in milliseconds
   * @returns {Function} Throttled function
   */
  function throttle(fn, limit = 100) {
    let inThrottle;
    return function(...args) {
      if (!inThrottle) {
        fn.apply(this, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    };
  }

  // === Toast Notifications (non-blocking) ===

  /**
   * Shows a brief toast notification (non-blocking alternative to alert())
   * @param {string} message - Toast message
   * @param {string} type - 'success', 'error', 'info', 'warning'
   * @param {number} duration - Auto-dismiss duration in ms (default: 3000)
   */
  function showToast(message, type = 'info', duration = 3000) {
    // Remove existing toast
    const existing = document.querySelector('.shared-toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = `shared-toast shared-toast-${type}`;
    toast.setAttribute('role', 'status');
    toast.textContent = message;

    // Inject minimal styles if not present
    if (!document.getElementById('shared-toast-styles')) {
      const style = document.createElement('style');
      style.id = 'shared-toast-styles';
      style.textContent = `
        .shared-toast {
          position: fixed; bottom: 20px; right: 20px;
          padding: 12px 20px; border-radius: 8px;
          font-size: 14px; font-weight: 500; z-index: 9999;
          animation: toast-slide-in 0.3s ease;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .shared-toast-success { background: #10b981; color: white; }
        .shared-toast-error { background: #ef4444; color: white; }
        .shared-toast-info { background: #3b82f6; color: white; }
        .shared-toast-warning { background: #f59e0b; color: white; }
        @keyframes toast-slide-in { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      `;
      document.head.appendChild(style);
    }

    document.body.appendChild(toast);

    // Auto-dismiss
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(20px)';
      toast.style.transition = 'all 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  // === StateRenderer (unified error/empty/loading states) ===

  /**
   * Standard error types for consistent UX across all surfaces
   * S12: Error & Empty State Polish
   * S13: Graceful Degradation - added SERVICE_UNAVAILABLE, TIMEOUT
   * Story 4: Added CONFIG_ERROR for 4xx/GAS_UPSTREAM_NON_JSON errors
   */
  const ERROR_TYPES = {
    EVENT_NOT_FOUND: 'event_not_found',
    NO_DATA: 'no_data',
    NETWORK_ERROR: 'network_error',
    UNAUTHORIZED: 'unauthorized',
    SERVICE_UNAVAILABLE: 'service_unavailable',
    TIMEOUT: 'timeout',
    CONFIG_ERROR: 'config_error',
    GENERIC: 'generic'
  };

  /**
   * Maps raw error messages/codes to user-friendly error types
   * Prevents leaking internal details (JSON, stack traces, etc.)
   * S13: Added SERVICE_UNAVAILABLE, TIMEOUT detection
   * Story 4: Added CONFIG_ERROR for 4xx status and GAS_UPSTREAM_NON_JSON
   *
   * @param {string|Error|Object} error - Raw error message, Error object, or {code, message, status, errorCode}
   * @returns {string} User-friendly error type from ERROR_TYPES
   */
  function classifyError(error) {
    // Handle error objects with code property (from NU.safeRpc)
    const code = String(error?.code || '').toUpperCase();
    const errorCode = String(error?.errorCode || '').toUpperCase();
    const status = Number(error?.status) || 0;
    const msg = String(error?.message || error || '').toLowerCase();

    // Story 4: Check errorCode for configuration issues
    if (errorCode === 'GAS_UPSTREAM_NON_JSON') {
      return ERROR_TYPES.CONFIG_ERROR;
    }

    // Story 4: Check status code ranges
    // 4xx errors (except 404/401/403) indicate configuration issues
    if (status >= 400 && status < 500) {
      if (status === 404) {
        return ERROR_TYPES.EVENT_NOT_FOUND;
      }
      if (status === 401 || status === 403) {
        return ERROR_TYPES.UNAUTHORIZED;
      }
      // Other 4xx errors indicate configuration problems
      return ERROR_TYPES.CONFIG_ERROR;
    }

    // 5xx errors indicate temporary service issues
    if (status >= 500 && status < 600) {
      if (status === 504) {
        return ERROR_TYPES.TIMEOUT;
      }
      return ERROR_TYPES.SERVICE_UNAVAILABLE;
    }

    // Check error codes first (most reliable)
    if (code === 'SERVICE_UNAVAILABLE' || code === 'INTERNAL') {
      return ERROR_TYPES.SERVICE_UNAVAILABLE;
    }
    if (code === 'TIMEOUT') {
      return ERROR_TYPES.TIMEOUT;
    }
    if (code === 'NOT_FOUND') {
      return ERROR_TYPES.EVENT_NOT_FOUND;
    }
    if (code === 'UNAUTHORIZED') {
      return ERROR_TYPES.UNAUTHORIZED;
    }
    if (code === 'NETWORK_ERROR') {
      return ERROR_TYPES.NETWORK_ERROR;
    }
    if (code === 'BAD_INPUT' || code === 'BAD_REQUEST' || code === 'CONFIG_ERROR') {
      return ERROR_TYPES.CONFIG_ERROR;
    }

    // Fallback to message-based detection
    if (msg.includes('not found') || msg.includes('404') || msg.includes('invalid') || msg.includes('no event')) {
      return ERROR_TYPES.EVENT_NOT_FOUND;
    }
    if (msg.includes('unauthorized') || msg.includes('403') || msg.includes('permission')) {
      return ERROR_TYPES.UNAUTHORIZED;
    }
    if (msg.includes('service unavailable') || msg.includes('503') || msg.includes('temporary issue') || msg.includes('temporary problem')) {
      return ERROR_TYPES.SERVICE_UNAVAILABLE;
    }
    if (msg.includes('timeout') || msg.includes('504') || msg.includes('took too long') || msg.includes('timed out')) {
      return ERROR_TYPES.TIMEOUT;
    }
    if (msg.includes('network') || msg.includes('failed to fetch') || msg.includes('connection') || msg.includes('offline')) {
      return ERROR_TYPES.NETWORK_ERROR;
    }
    if (msg.includes('no data') || msg.includes('empty') || msg.includes('nothing')) {
      return ERROR_TYPES.NO_DATA;
    }
    if (msg.includes('configuration') || msg.includes('misconfigured') || msg.includes('setup')) {
      return ERROR_TYPES.CONFIG_ERROR;
    }
    return ERROR_TYPES.GENERIC;
  }

  /**
   * StateRenderer - Unified error/empty/loading state rendering
   * S12: Consistent UX across Public, Display, Poster, SharedReport, Admin
   */
  const StateRenderer = {
    // Expose error types for external use
    ERROR_TYPES,
    classifyError,

    /**
     * Render error state into a container
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { title, message, onRetry, hint, tvMode }
     */
    showError(container, options = {}) {
      const {
        title = 'Something Went Wrong',
        message = 'Please try again.',
        onRetry = null,
        hint = null,
        tvMode = false
      } = options;

      const stateClass = tvMode ? 'error-state-tv' : 'error-state';
      const iconClass = tvMode ? 'error-icon' : 'error-state-icon';

      container.innerHTML = `
        <div class="${stateClass}">
          <div class="${iconClass}">‚ö†Ô∏è</div>
          <h3>${esc(title)}</h3>
          <p>${esc(message)}</p>
          ${hint ? `<p style="font-size: 0.85rem; color: ${tvMode ? '#9ca3af' : '#991b1b'}; margin-top: 8px;">${esc(hint)}</p>` : ''}
          ${onRetry ? '<button class="btn-retry">üîÑ Try Again</button>' : ''}
        </div>
      `;
      if (onRetry) {
        container.querySelector('.btn-retry')?.addEventListener('click', onRetry);
      }
    },

    /**
     * Render empty state into a container
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { icon, title, message, hint, backUrl, backLabel, tvMode }
     */
    showEmpty(container, options = {}) {
      const {
        icon = 'üì≠',
        title = 'Nothing Here',
        message = '',
        hint = null,
        backUrl = null,
        backLabel = '‚Üê Go Back',
        tvMode = false
      } = options;

      const stateClass = tvMode ? 'error-state-tv' : 'empty-state';
      const iconClass = tvMode ? 'error-icon' : 'empty-state-icon';

      container.innerHTML = `
        <div class="${stateClass}">
          <div class="${iconClass}">${icon}</div>
          <h3>${esc(title)}</h3>
          ${message ? `<p>${esc(message)}</p>` : ''}
          ${hint ? `<p style="font-size: 0.85rem; color: #94a3b8; margin-top: 12px;">${esc(hint)}</p>` : ''}
          ${backUrl ? `<a href="${esc(backUrl)}" class="btn-secondary">${esc(backLabel)}</a>` : ''}
        </div>
      `;
    },

    /**
     * Render loading state into a container
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { message }
     */
    showLoading(container, options = {}) {
      const { message = 'Loading...' } = options;
      container.innerHTML = `
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p>${esc(message)}</p>
        </div>
      `;
    },

    // === Convenience Methods for Common Scenarios (S12) ===

    /**
     * Show "Event Not Found" state
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { backUrl, tvMode }
     */
    showEventNotFound(container, options = {}) {
      const { backUrl = null, tvMode = false } = options;
      this.showEmpty(container, {
        icon: 'üîç',
        title: 'Event Not Found',
        message: 'We couldn\'t find this event. The link may be outdated, the event ID might be incorrect, or the event may have been removed.',
        hint: 'Double-check the URL or return to the events list to find what you\'re looking for.',
        backUrl,
        backLabel: '‚Üê View All Events',
        tvMode
      });
    },

    /**
     * Show "No Data Yet" state
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { context, backUrl, tvMode }
     */
    showNoData(container, options = {}) {
      const { context = 'content', backUrl = null, tvMode = false } = options;
      const contextMessages = {
        events: 'Check back soon for new events, or contact the organizer for more information.',
        sponsors: 'No sponsors to display yet. Sponsor information will appear here once configured.',
        schedule: 'The event schedule will appear here once it\'s available.',
        standings: 'Standings will appear here once the competition begins.',
        analytics: 'Once attendees start interacting with your content, you\'ll see engagement data here.',
        content: 'This event exists but doesn\'t have any content to display yet. Check back soon!'
      };
      this.showEmpty(container, {
        icon: 'üì≠',
        title: 'No Data Yet',
        message: contextMessages[context] || contextMessages.content,
        backUrl,
        tvMode
      });
    },

    /**
     * Show network/connection error state
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { onRetry, tvMode }
     */
    showNetworkError(container, options = {}) {
      const { onRetry = null, tvMode = false } = options;
      this.showError(container, {
        title: 'Connection Problem',
        message: 'We\'re having trouble connecting right now. This might be a temporary issue.',
        hint: 'Please check your internet connection and try again.',
        onRetry,
        tvMode
      });
    },

    /**
     * Show unauthorized/permission error state
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { backUrl, tvMode }
     */
    showUnauthorized(container, options = {}) {
      const { backUrl = null, tvMode = false } = options;
      this.showError(container, {
        title: 'Access Denied',
        message: 'You don\'t have permission to view this content.',
        hint: 'Please check that you have the correct access link.',
        onRetry: null,
        tvMode
      });
    },

    /**
     * Show temporary service issue state (S13: Graceful Degradation)
     * For 5xx errors from upstream, temporary outages, etc.
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { onRetry, tvMode, corrId }
     */
    showTemporaryIssue(container, options = {}) {
      const { onRetry = null, tvMode = false, corrId = null } = options;
      this.showError(container, {
        title: 'Temporary Issue',
        message: 'We\'re having a temporary issue loading this event.',
        hint: corrId
          ? `Please refresh or try again in a minute. (Ref: ${esc(corrId)})`
          : 'Please refresh or try again in a minute.',
        onRetry,
        tvMode
      });
    },

    /**
     * Show timeout error state (S13: Graceful Degradation)
     * For requests that took too long
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { onRetry, tvMode }
     */
    showTimeout(container, options = {}) {
      const { onRetry = null, tvMode = false } = options;
      this.showError(container, {
        title: 'Taking Too Long',
        message: 'The page is taking longer than expected to load.',
        hint: 'This might be a temporary issue. Please try again.',
        onRetry,
        tvMode
      });
    },

    /**
     * Show configuration issue state (Story 4: Tighten frontend error handling)
     * For 4xx errors or GAS_UPSTREAM_NON_JSON indicating backend misconfiguration.
     * Shows user-friendly message in prod, expanded diagnostics in staging.
     * @param {HTMLElement} container - Target container
     * @param {Object} options - { onRetry, tvMode, isStaging, status, errorCode, corrId }
     */
    showConfigurationIssue(container, options = {}) {
      const {
        onRetry = null,
        tvMode = false,
        isStaging = false,
        status = null,
        errorCode = null,
        corrId = null
      } = options;

      // User-friendly message for production
      const prodTitle = 'Setting Up';
      const prodMessage = 'We\'re setting this event up. Try again later.';
      const prodHint = 'This page should be available shortly.';

      // Staging gets richer diagnostics
      const stagingTitle = 'Configuration Issue';
      const stagingMessage = 'The backend may be misconfigured for this request.';

      // Build diagnostic info for staging
      let diagnosticHtml = '';
      if (isStaging && (status || errorCode || corrId)) {
        const diagParts = [];
        if (status) diagParts.push(`Status: ${status}`);
        if (errorCode) diagParts.push(`Error: ${errorCode}`);
        if (corrId) diagParts.push(`Ref: ${corrId}`);
        diagnosticHtml = `
          <details style="margin-top: 12px; text-align: left;">
            <summary style="cursor: pointer; color: #64748b; font-size: 0.85rem;">Diagnostic Info</summary>
            <pre style="background: #f1f5f9; padding: 8px; border-radius: 4px; font-size: 0.75rem; margin-top: 8px; overflow-x: auto;">${esc(diagParts.join('\n'))}</pre>
          </details>
        `;
      }

      const stateClass = tvMode ? 'error-state-tv' : 'error-state config-error-state';
      const iconClass = tvMode ? 'error-icon' : 'error-state-icon';

      container.innerHTML = `
        <div class="${stateClass}" data-testid="config-error-state">
          <div class="${iconClass}">‚öôÔ∏è</div>
          <h3>${esc(isStaging ? stagingTitle : prodTitle)}</h3>
          <p>${esc(isStaging ? stagingMessage : prodMessage)}</p>
          <p style="font-size: 0.85rem; color: ${tvMode ? '#9ca3af' : '#991b1b'}; margin-top: 8px;">
            ${esc(isStaging ? 'Check backend logs and configuration.' : prodHint)}
          </p>
          ${diagnosticHtml}
          ${onRetry ? '<button class="btn-retry">üîÑ Try Again</button>' : ''}
        </div>
      `;
      if (onRetry) {
        container.querySelector('.btn-retry')?.addEventListener('click', onRetry);
      }
    },

    /**
     * Auto-detect error type and show appropriate state
     * S13: Updated to handle SERVICE_UNAVAILABLE, TIMEOUT
     * Story 4: Added CONFIG_ERROR handling
     *
     * @param {HTMLElement} container - Target container
     * @param {string|Error|Object} error - Raw error, Error object, or {code, message, corrId, status, errorCode}
     * @param {Object} options - { onRetry, backUrl, tvMode, isStaging }
     */
    showFromError(container, error, options = {}) {
      const { onRetry = null, backUrl = null, tvMode = false, isStaging = false } = options;
      const errorType = classifyError(error);
      const corrId = error?.corrId || null;
      const status = error?.status || null;
      const errorCode = error?.errorCode || null;

      switch (errorType) {
        case ERROR_TYPES.EVENT_NOT_FOUND:
          this.showEventNotFound(container, { backUrl, tvMode });
          break;
        case ERROR_TYPES.NO_DATA:
          this.showNoData(container, { backUrl, tvMode });
          break;
        case ERROR_TYPES.NETWORK_ERROR:
          this.showNetworkError(container, { onRetry, tvMode });
          break;
        case ERROR_TYPES.UNAUTHORIZED:
          this.showUnauthorized(container, { backUrl, tvMode });
          break;
        case ERROR_TYPES.SERVICE_UNAVAILABLE:
          this.showTemporaryIssue(container, { onRetry, tvMode, corrId });
          break;
        case ERROR_TYPES.TIMEOUT:
          this.showTimeout(container, { onRetry, tvMode });
          break;
        case ERROR_TYPES.CONFIG_ERROR:
          this.showConfigurationIssue(container, { onRetry, tvMode, isStaging, status, errorCode, corrId });
          break;
        default:
          this.showError(container, {
            title: 'Something Went Wrong',
            message: 'We couldn\'t load this content right now. This might be a temporary issue.',
            hint: corrId
              ? `Please try again in a moment. (Ref: ${esc(corrId)})`
              : 'Please try again in a moment.',
            onRetry,
            tvMode
          });
      }
    }
  };

  // === EVENT_CONTRACT.md v2.0 Support ===

  /**
   * Checks if an event section is enabled via settings
   * Extracted from Display.html and Poster.html (D-008)
   * Trust the contract - never invent flags
   *
   * Feature 4: Template-Aware Section Toggles - added showVideo, showMap, showGallery
   *
   * @param {Object} settings - Event settings object
   * @param {string} key - Section key: 'schedule', 'standings', 'bracket', 'sponsors', 'video', 'map', 'gallery'
   * @returns {boolean} True if section is enabled
   */
  function sectionEnabled(settings, key) {
    if (!settings) return false;
    switch (key) {
      // Data sections (require explicit true)
      case 'schedule': return settings.showSchedule === true;
      case 'standings': return settings.showStandings === true;
      case 'bracket': return settings.showBracket === true;
      case 'sponsors': return settings.showSponsors === true;
      // Content sections (default true for backwards compat - Feature 4)
      case 'video': return settings.showVideo !== false;
      case 'map': return settings.showMap !== false;
      case 'gallery': return settings.showGallery !== false;
      default: return false;
    }
  }

  // === Environment Detection (Story 4) ===

  /**
   * Detects if the current environment is staging.
   * Story 4: Used to show richer diagnostics on staging without leaking in prod.
   *
   * Detection logic (matches NUSDK.html):
   * - stg.eventangle.com ‚Üí staging
   * - localhost, 127.0.0.1 ‚Üí staging (for local dev)
   * - eventangle.com (without stg.) ‚Üí production
   *
   * @returns {boolean} True if running in staging environment
   */
  function isStaging() {
    const hostname = window.location?.hostname || '';

    // Helper for safe domain suffix check
    const isDomain = (host, domain) =>
      host === domain || host.endsWith('.' + domain);

    // Staging indicators
    if (isDomain(hostname, 'stg.eventangle.com')) return true;
    if (hostname === 'localhost' || hostname === '127.0.0.1') return true;

    // Production indicator (eventangle.com without stg.)
    if (isDomain(hostname, 'eventangle.com') && !hostname.includes('stg')) {
      return false;
    }

    // Default to staging for safety (show more info rather than less)
    // This ensures unknown environments don't hide diagnostic info
    return true;
  }

  // === Public API ===
  return {
    // Alerts
    showAlert,

    // Toast (non-blocking)
    showToast,

    // State rendering (S12: Enhanced with convenience methods)
    StateRenderer,
    ERROR_TYPES,
    classifyError,

    // Date formatting
    formatDate,
    formatRelativeTime,

    // Form utilities
    validateForm,
    isValidEmail,
    isValidUrl,

    // Loading state
    withLoadingState,

    // DOM utilities
    toggleElement,
    showElement,
    hideElement,

    // XSS (delegates to NU.esc)
    esc,

    // Utility functions
    debounce,
    throttle,

    // EVENT_CONTRACT helpers
    sectionEnabled,

    // Environment detection (Story 4)
    isStaging
  };
})();
</script>
