<!--
================================================================================
MVP SURFACE - Focus Group Critical
================================================================================
Page: Poster.html
Purpose: Printable event poster with QR code and sponsor branding
Status: LOCKED for MVP v1.0

DO NOT modify this file's contracts without updating:
  - NUSDK.html (API client)
  - tests/e2e/* (end-to-end tests)
  - tests/unit/* (unit tests)

Related MVP Surfaces: Admin, Display, Public, Sponsor, SharedReport
================================================================================
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> ¬∑ Poster</title>
  <?!= include('DesignTokens'); ?>
  <?!= include('Styles'); ?>
  <?!= include('DesignAdapter'); ?>
  <?!= include('SponsorUtils'); ?>
  <?!= include('SharedUtils'); ?>
  <?!= include('FooterComponent'); ?>
  <?!= include('NUSDK'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="referrer" content="no-referrer"/>
  <style>
    /* Poster-specific styles - uses design tokens from DesignAdapter */
    [hidden] { display:none !important; }
    body { background: #fff; }
    .poster-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
      background: #fff;
    }

    /* Enhanced Sponsor Strip */
    .sponsor-strip {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      gap: 24px;
      padding: 20px;
      border-bottom: 3px solid var(--color-primary, #2563eb);
      margin-bottom: 40px;
      background: var(--gradient-sponsor-bg, linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f8fafc 100%));
      box-shadow: var(--shadow-sm, 0 2px 8px rgba(0,0,0,0.05));
    }
    .sponsor-strip img {
      max-height: var(--poster-sponsor-logo-height, 70px);
      object-fit: contain;
    }
    .sponsor-strip strong {
      color: var(--color-gray-800, #1e293b);
      font-size: 1.3em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Enhanced Event Details */
    .event-details {
      text-align: center;
      margin-bottom: 40px;
      padding: 24px;
      background: linear-gradient(135deg, var(--color-gray-50, #f8fafc) 0%, #ffffff 100%);
      border-radius: var(--radius-md, 12px);
    }
    .event-details h1 {
      color: var(--color-primary, #2563eb);
      font-size: 2.8rem;
      margin-bottom: 20px;
      line-height: 1.2;
      text-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
    }
    .event-meta {
      font-size: 1.3rem;
      color: var(--color-gray-600, #475569);
      margin: 12px 0;
      line-height: 1.8;
    }
    .event-meta strong {
      color: var(--color-gray-800, #1e293b);
      font-weight: 700;
    }
    .event-image {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      margin: 24px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .event-summary {
      font-size: 1.1rem;
      line-height: 1.6;
      color: #475569;
      margin: 20px 0;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #2563eb;
    }

    /* Enhanced QR Codes */
    .qr-section {
      margin-top: 48px;
      padding: 32px 0;
      border-top: 3px solid #e2e8f0;
    }
    .qr-section h2 {
      text-align: center;
      color: #1e293b;
      font-size: 2rem;
      margin-bottom: 32px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .qr-section h2::before {
      content: "üì± ";
      font-size: 1.5em;
    }
    .qr-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 28px;
      margin: 24px 0;
    }
    .qr-code {
      text-align: center;
      padding: 24px;
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border-radius: 16px;
      border: 3px solid #e2e8f0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    .qr-code:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.15);
      border-color: #2563eb;
    }
    .qr-code h3 {
      margin: 0 0 8px;
      color: #2563eb;
      font-size: 1.3rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .qr-code h4 {
      margin: 0 0 16px;
      color: #64748b;
      font-size: 0.95rem;
      font-weight: 500;
    }
    .qr-code img {
      width: 100%;
      max-width: 220px;
      height: auto;
      margin: 16px auto;
      display: block;
      border-radius: 8px;
      border: 2px solid #e2e8f0;
      padding: 8px;
      background: white;
    }
    .qr-code p {
      margin-top: 12px;
      color: #94a3b8;
      font-size: 10px;
      word-break: break-all;
      line-height: 1.4;
    }

    /* Print Styles - Optimized for printing */
    /* PR-001, PR-002: Enhanced print safety margins and areas */
    @media print {
      @page {
        margin: 0.5in;
        size: letter portrait;  /* Explicit paper size */
      }

      body {
        background: #fff;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .poster-container {
        padding: 0;  /* @page margin handles outer spacing */
        max-width: 100%;
      }

      /* PR-002: Safe area for sponsor strip */
      .sponsor-strip {
        border: 0;
        padding: 12px 0.25in;  /* Inset from edge for print safety */
        box-shadow: none;
        background: #fff;
        margin: 0 -0.25in;
        width: calc(100% + 0.5in);
      }

      .event-details {
        background: #fff;
        padding: 16px 0;
      }

      /* PR-003: Prevent title overflow on print */
      .event-details h1 {
        font-size: clamp(1.5rem, 6vw, 2.5rem);
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
      }

      .qr-grid {
        gap: 16px;
        page-break-inside: avoid;
      }

      .qr-code {
        box-shadow: none;
        page-break-inside: avoid;
        border-width: 2px;
      }

      .qr-code:hover {
        transform: none;
      }

      .qr-section {
        page-break-inside: avoid;
      }

      .qr-section h2::before {
        content: "";
      }

      /* Hide interactive elements in print */
      .btn-retry,
      .site-footer a {
        text-decoration: none;
        color: inherit;
      }
    }

    /* Narrow print media (e.g., A5, receipt printers) */
    @media print and (max-width: 6in) {
      .qr-grid {
        grid-template-columns: 1fr 1fr;
      }

      .event-details h1 {
        font-size: 1.5rem;
      }

      .sponsor-strip img {
        max-height: 48px;
      }
    }

    /* Responsive - Mobile and tablet */
    @media (max-width: 768px) {
      .poster-container { padding: 24px 16px; }
      .sponsor-strip {
        padding: 16px;
        gap: 16px;
      }
      .sponsor-strip img { max-height: 56px; }
      .event-details {
        padding: 20px 16px;
      }
      .event-details h1 {
        font-size: 2rem;
      }
      .event-meta {
        font-size: 1.1rem;
      }
      .qr-section h2 {
        font-size: 1.6rem;
      }
      .qr-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      .qr-code {
        padding: 20px;
      }
      .qr-code h3 {
        font-size: 1.1rem;
      }
    }

    /* === MVP Essential: Empty/Error States === */
    .empty-state, .error-state {
      text-align: center;
      padding: 48px 24px;
      max-width: 400px;
      margin: 60px auto;
    }
    .empty-state-icon, .error-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.6;
    }
    .empty-state h3, .error-state h3 {
      color: #475569;
      margin-bottom: 8px;
      font-size: 1.25rem;
    }
    .empty-state p, .error-state p {
      color: #64748b;
      margin-bottom: 16px;
      line-height: 1.6;
    }
    .error-state {
      background: #fef2f2;
      border-radius: 12px;
      border: 1px solid #fecaca;
    }
    .error-state h3 { color: #dc2626; }
    .error-state p { color: #b91c1c; }
    /* .btn-retry - Now centralized in Styles.html (C-001) */
    /* .site-footer - Now centralized in FooterComponent.html (D-005) */
  </style>
</head>
<body>
  <div class="poster-container">
    <!-- Sponsor Strip (Top) -->
    <div id="sponsorStrip" class="sponsor-strip" hidden></div>

    <!-- Event Details -->
    <div class="event-details">
      <h1 id="eventName">Event Name</h1>
      <div class="event-meta">
        <div id="eventDate"></div>
        <div id="eventTime"></div>
        <div id="eventLocation"></div>
        <div id="eventEntity"></div>
      </div>
    </div>

    <!-- Event Image -->
    <div id="eventImageContainer" hidden>
      <img id="eventImage" class="event-image" alt="Event Image">
    </div>

    <!-- Event Summary -->
    <div id="eventSummary" class="event-summary" hidden></div>

    <!-- QR Codes Section -->
    <section class="qr-section">
      <h2>Scan to Connect</h2>
      <div id="qrGrid" class="qr-grid"></div>
    </section>
  </div>

  <!-- Trust Footer -->
  <footer class="site-footer">
    <p>Powered by <a href="https://eventangle.com" target="_blank" rel="noopener">EventAngle</a></p>
  </footer>

  <script>
    const BRAND = '<?= brandId ?>';
    const SCOPE = '<?= scope ?>';
    const ID = new URL(location.href).searchParams.get('id');

    // Use shared utilities from SponsorUtils
    const { esc, logEvent, initLogging } = window.SponsorUtils;
    initLogging();

    // === EVENT_CONTRACT.md v2.0 Support ===
    // Use centralized sectionEnabled from SharedUtils (D-008)
    const sectionEnabled = window.SharedUtils?.sectionEnabled || function(settings, key) {
      if (!settings) return false;
      switch (key) {
        case 'schedule': return settings.showSchedule === true;
        case 'standings': return settings.showStandings === true;
        case 'bracket': return settings.showBracket === true;
        case 'sponsors': return settings.showSponsors === true;
        default: return false;
      }
    };

    // NOTE: Legacy renderSponsorStrip* functions removed in E-003
    // All sponsor rendering now uses SponsorUtils.SponsorRenderer

    /**
     * Render event details section
     * EVENT_CONTRACT.md v2.0: Uses canonical fields directly, no fallback chains
     *
     * Contract fields used:
     * - event.name (MVP Required)
     * - event.startDateISO (MVP Required)
     * - event.venue (MVP Required)
     * - event.media.imageUrl (V2 Optional)
     */
    function renderEventDetails(event) {
      // === CONTRACT FIELDS (MVP REQUIRED) ===
      // Trust the contract - no fallback chains
      const name = event.name || 'Event Name';
      const startDateISO = event.startDateISO || '';
      const venue = event.venue || '';

      // === CONTRACT FIELDS (V2 OPTIONAL) ===
      const media = event.media || {};
      const imageUrl = media.imageUrl || '';

      // Event Name (MVP Required)
      document.getElementById('eventName').textContent = name;

      // Date - parse from event.startDateISO (MVP Required)
      const dateEl = document.getElementById('eventDate');
      const timeEl = document.getElementById('eventTime');

      if (startDateISO) {
        const date = new Date(startDateISO + 'T00:00:00');
        if (!isNaN(date.getTime())) {
          dateEl.innerHTML = `<strong>Date:</strong> ${date.toLocaleDateString('en-US', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
          })}`;
        }
      }
      // Hide time element - MVP v2.0 doesn't have time
      timeEl.hidden = true;

      // Venue (MVP Required) - event.venue
      const locEl = document.getElementById('eventLocation');
      if (venue) {
        locEl.innerHTML = `<strong>Location:</strong> ${esc(venue)}`;
      }

      // Entity (hosted by) - not in contract, hidden
      const entityEl = document.getElementById('eventEntity');
      entityEl.hidden = true;

      // Event Image (V2 Optional) - event.media.imageUrl
      if (imageUrl) {
        document.getElementById('eventImage').src = imageUrl;
        document.getElementById('eventImageContainer').hidden = false;
      }

      // Summary - not in MVP contract, hidden
      document.getElementById('eventSummary').hidden = true;
    }

    /**
     * Render QR codes section
     * EVENT_CONTRACT.md v2.0: Uses canonical QR and links fields
     *
     * Contract fields used:
     * - event.qr.public (MVP Required) - Base64 PNG data URI
     * - event.qr.signup (MVP Required) - Base64 PNG data URI
     * - event.links.publicUrl (MVP Required) - shown as text
     * - event.links.signupUrl (MVP Required) - shown as text
     * - event.ctas.primary.label (MVP Required) - button label
     */
    function renderQRCodes(event) {
      const el = document.getElementById('qrGrid');
      el.innerHTML = '';

      // === CONTRACT FIELDS (MVP REQUIRED) ===
      const qr = event.qr || {};
      const links = event.links || {};
      const ctas = event.ctas || { primary: { label: 'Sign Up', url: '' } };

      // QR Code 1: Sign Up - event.qr.signup + event.links.signupUrl
      const signupQR = qr.signup;
      const signupUrl = links.signupUrl || '';
      const signupLabel = ctas.primary?.label || 'Sign Up';

      if (signupQR || signupUrl) {
        // Use pre-generated QR from contract, fallback to quickchart.io
        const qrSrc = signupQR || `https://quickchart.io/qr?text=${encodeURIComponent(signupUrl)}&size=200&margin=4`;
        el.innerHTML += `
          <div class="qr-code">
            <h3>${esc(signupLabel)}</h3>
            <h4>Register Now</h4>
            <img alt="Sign Up QR Code" src="${qrSrc}">
            <p>${esc(signupUrl)}</p>
          </div>
        `;
      }

      // QR Code 2: Public Event Page - event.qr.public + event.links.publicUrl
      const publicQR = qr.public;
      const publicUrl = links.publicUrl || '';

      if (publicQR || publicUrl) {
        // Use pre-generated QR from contract, fallback to quickchart.io
        const qrSrc = publicQR || `https://quickchart.io/qr?text=${encodeURIComponent(publicUrl)}&size=200&margin=4`;
        el.innerHTML += `
          <div class="qr-code">
            <h3>Event Page</h3>
            <h4>View Details</h4>
            <img alt="Public Page QR Code" src="${qrSrc}">
            <p>${esc(publicUrl)}</p>
          </div>
        `;
      }

      // If no QR codes available
      if (el.innerHTML === '') {
        el.innerHTML = '<p style="text-align:center; color:#94a3b8; grid-column: 1 / -1;">No QR codes available. Configure sign-up URL in Admin.</p>';
      }
    }

    /**
     * Render poster from event data
     * EVENT_CONTRACT.md v2.0: Uses getPosterBundle for poster-specific data
     *
     * Contract fields used:
     * - event.name, event.startDateISO, event.venue (MVP Required)
     * - event.qr.public, event.qr.signup (MVP Required)
     * - event.links.publicUrl, event.links.signupUrl (MVP Required)
     * - event.settings.showSponsors (MVP Required)
     * - event.sponsors with placement === 'poster' (V2 Optional)
     */
    function renderPoster(event) {
      if (!event) {
        document.querySelector('.poster-container').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <h3>Event Not Found</h3>
            <p>This poster link may be outdated or the event has been removed.</p>
            <a class="btn-retry" href="javascript:history.back()">‚Üê Go Back</a>
          </div>
        `;
        return;
      }

      // Log poster view
      logEvent({ eventId: event.id, surface: 'poster', metric: 'view', value: 1 });

      // === CONTRACT FIELDS ===
      const settings = event.settings || { showSponsors: false };
      const sponsors = event.sponsors || [];

      // === RESERVED POSTER SPONSOR BAND ===
      // Uses event.settings.showSponsors and event.sponsors with placement === 'poster'
      const sponsorStrip = document.getElementById('sponsorStrip');
      if (settings.showSponsors && sponsors.length > 0) {
        // Filter sponsors with 'poster' placement
        const posterSponsors = sponsors.filter(s => s.placement === 'poster' || !s.placement);
        if (posterSponsors.length > 0) {
          // Use unified SponsorRenderer from SponsorUtils
          const { SponsorRenderer } = window.SponsorUtils;
          SponsorRenderer.renderStrip({
            container: sponsorStrip,
            sponsors: posterSponsors,
            eventId: event.id,
            surface: 'poster',
            showLinks: false, // Poster is print-friendly, no clickable links
            showTier: false
          });
        } else {
          // Reserved: Sponsor strip exists but hidden when no poster sponsors
          sponsorStrip.innerHTML = '';
          sponsorStrip.hidden = true;
        }
      } else {
        // Reserved: Sponsor strip container exists but hidden by default
        sponsorStrip.innerHTML = '';
        sponsorStrip.hidden = true;
      }

      // Render event details and QR codes
      renderEventDetails(event);
      renderQRCodes(event);

      // Track print events
      window.addEventListener('beforeprint', () => {
        logEvent({ eventId: event.id, surface: 'poster', metric: 'print', value: 1 });
      });
    }

    /**
     * Boot Poster.html
     * EVENT_CONTRACT.md v2.0: Uses api_getPosterBundle for poster-specific data
     *
     * PosterBundle returns:
     * - event: Full canonical Event shape
     * - qrCodes: { publicUrl, signupUrl } - QuickChart URLs for print
     */
    async function boot() {
      const res = await NU.rpc('api_getPosterBundle', { brandId: BRAND, scope: SCOPE, id: ID });

      if (res.ok && res.value && res.value.event) {
        // getPosterBundle returns { event: Event, qrCodes: {...} }
        renderPoster(res.value.event);
      } else if (res.ok && res.value) {
        // Backward compat: direct event object
        renderPoster(res.value);
      } else if (!res.ok) {
        // API error - show error state
        document.querySelector('.poster-container').innerHTML = `
          <div class="error-state">
            <div class="error-state-icon">‚ö†Ô∏è</div>
            <h3>Trouble Loading</h3>
            <p>We couldn't load this poster right now.</p>
            <button class="btn-retry" onclick="location.reload()">üîÑ Try Again</button>
          </div>
        `;
      } else {
        renderPoster(null);
      }
    }

    // Boot on load
    boot();
  </script>
</body>
</html>
