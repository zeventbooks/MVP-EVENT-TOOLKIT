<!--
================================================================================
MODULE: AdminDisplay.html
PURPOSE: Display configuration and sponsor management for Admin dashboard
INCLUDED BY: Admin.html
DEPENDENCIES: NUSDK.html (NU.rpc), SharedUtils.html (showToast), AdminEvents.html (overlay, fetchAdminBundleFromWorker)
================================================================================
Story 4.1: Extracted from Admin.html for modularization and maintainability.
Story 2.3: Read operations now use Worker via fetchAdminBundleFromWorker
Story 5.3: All APIs migrated to /api/v2/* endpoints (GAS retired)

Functions exposed to global scope:
  Display Configuration:
  - configureDisplay()           → Open display config panel
  - loadDisplayConfig()          → Load display config from Worker
  - toggleDisplayMode()          → Toggle dynamic/public mode
  - saveDisplayConfig()          → Save display config to API (GAS)
  - closeDisplayConfig()         → Close display config panel

  URL Management:
  - renderUrls(urls)             → Render URL rotation list
  - addUrl()                     → Add new URL to list

  Sponsor Management:
  - renderSponsors(sponsors)     → Render sponsor list
  - addSponsor()                 → Add new sponsor

  Helpers:
  - getAdminKey()                → Get/prompt for admin key
  - saveEventPartial(id, data)   → Load-merge-save helper (GAS)
  - deepMerge_(target, source)   → Deep merge objects
================================================================================
-->
<script>
(function() {
  'use strict';

  // ==========================================================================
  // DISPLAY CONFIGURATION
  // ==========================================================================

  /**
   * Open display configuration panel.
   */
  function configureDisplay() {
    const card = document.getElementById('displayCard');
    if (card) {
      card.style.display = '';
    }
    loadDisplayConfig();
  }

  /**
   * Load display configuration from admin bundle or Worker.
   *
   * Story 2.3/5.3: Uses cached admin bundle data if available,
   * otherwise fetches from Worker /api/v2/events/:id/bundle/admin (GAS retired)
   */
  async function loadDisplayConfig() {
    const BRAND = window.BRAND || 'root';
    const currentEventId = window.currentEventId;

    if (!currentEventId) return;

    if (typeof window.overlay === 'function') {
      window.overlay(true);
    }

    // Story 2.3: Try to use cached admin bundle data first
    let event = null;
    if (window.currentAdminBundle && window.currentAdminBundle.event) {
      event = window.currentAdminBundle.event;
      console.log('[AdminDisplay] Using cached admin bundle for display config');
    } else if (typeof window.fetchAdminBundleFromWorker === 'function') {
      // Fetch from Worker if not cached
      const res = await window.fetchAdminBundleFromWorker(currentEventId, BRAND);
      if (res.ok && res.value) {
        event = res.value.event;
        console.log('[AdminDisplay] Fetched admin bundle from Worker for display config');
      }
    }

    if (typeof window.overlay === 'function') {
      window.overlay(false);
    }

    if (event) {
      const display = event.display || {};
      const sponsors = event.sponsors || [];

      const displayModeEl = document.getElementById('displayMode');
      if (displayModeEl) {
        displayModeEl.value = display.mode || 'public';
        toggleDisplayMode();
      }

      if (display.urls) {
        renderUrls(display.urls);
      }

      renderSponsors(sponsors);
    }
  }

  /**
   * Toggle between public and dynamic display modes.
   */
  function toggleDisplayMode() {
    const modeEl = document.getElementById('displayMode');
    const dynamicConfig = document.getElementById('dynamicConfig');
    if (modeEl && dynamicConfig) {
      const mode = modeEl.value;
      dynamicConfig.style.display = mode === 'dynamic' ? '' : 'none';
    }
  }

  /**
   * Save display configuration to API.
   * Uses canonical api_saveEvent via saveEventPartial (ZEVENT-003).
   */
  async function saveDisplayConfig() {
    const currentEventId = window.currentEventId;
    if (!currentEventId) return;

    const modeEl = document.getElementById('displayMode');
    const mode = modeEl ? modeEl.value : 'public';
    const urls = [];

    if (mode === 'dynamic') {
      document.querySelectorAll('#urlList .form-group').forEach(row => {
        const urlInput = row.querySelector('.url-input');
        const secondsInput = row.querySelector('.url-seconds');
        const url = urlInput ? urlInput.value.trim() : '';
        const seconds = secondsInput ? Number(secondsInput.value || 10) : 10;
        if (url) urls.push({ url, seconds });
      });
    }

    const sponsors = [];
    document.querySelectorAll('#sponsorList .event-card').forEach(row => {
      const nameInput = row.querySelector('.sp-name');
      const name = nameInput ? nameInput.value.trim() : '';
      if (!name) return;

      sponsors.push({
        id: (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : `sp-${Date.now()}`,
        name,
        url: row.querySelector('.sp-url')?.value.trim() || '',
        img: row.querySelector('.sp-img')?.value.trim() || '',
        isPrimary: row.querySelector('.sp-isPrimary')?.checked || false,
        placements: {
          posterTop: row.querySelector('.sp-posterTop')?.checked || false,
          tvTop: row.querySelector('.sp-tvTop')?.checked || false,
          tvSide: row.querySelector('.sp-tvSide')?.checked || false,
          mobileBanner: row.querySelector('.sp-mobileBanner')?.checked || false
        }
      });
    });

    if (typeof window.overlay === 'function') {
      window.overlay(true);
    }

    const res = await saveEventPartial(currentEventId, {
      data: { display: { mode, urls }, sponsors }
    });

    if (typeof window.overlay === 'function') {
      window.overlay(false);
    }

    if (res.ok) {
      if (window.SharedUtils) {
        SharedUtils.showToast('Display configuration saved!', 'success');
      }
    } else {
      if (window.SharedUtils) {
        SharedUtils.showToast(`Error: ${res.message}`, 'error');
      }
    }
  }

  /**
   * Close display configuration panel.
   */
  function closeDisplayConfig() {
    const card = document.getElementById('displayCard');
    if (card) {
      card.style.display = 'none';
    }
  }

  // ==========================================================================
  // URL MANAGEMENT
  // ==========================================================================

  /**
   * Render URL rotation list.
   */
  function renderUrls(urls) {
    const list = document.getElementById('urlList');
    if (!list) return;

    list.innerHTML = '';
    urls.forEach((item, i) => {
      const div = document.createElement('div');
      div.className = 'form-group';
      div.innerHTML = `
        <label>URL ${i + 1}</label>
        <input type="url" value="${item.url || ''}" class="url-input">
        <input type="number" value="${item.seconds || 10}" min="5" max="300" placeholder="Seconds" class="url-seconds" style="width:100px;margin-top:4px;">
      `;
      list.appendChild(div);
    });
  }

  /**
   * Add new URL to rotation list.
   */
  function addUrl() {
    const list = document.getElementById('urlList');
    if (!list) return;

    const div = document.createElement('div');
    div.className = 'form-group';
    div.innerHTML = `
      <label>New URL</label>
      <input type="url" placeholder="https://..." class="url-input">
      <input type="number" value="10" min="5" max="300" placeholder="Seconds" class="url-seconds" style="width:100px;margin-top:4px;">
    `;
    list.appendChild(div);
  }

  // ==========================================================================
  // SPONSOR MANAGEMENT
  // ==========================================================================

  /**
   * Render sponsor list.
   */
  function renderSponsors(sponsors) {
    const list = document.getElementById('sponsorList');
    if (!list) return;

    list.innerHTML = '';
    sponsors.forEach((sp, i) => {
      const div = document.createElement('div');
      div.className = 'event-card';
      const placements = sp.placements || {};
      div.innerHTML = `
        <h4>Sponsor ${i + 1} ${sp.isPrimary ? '<span style="background:#fef3c7;color:#92400e;padding:2px 6px;border-radius:8px;font-size:0.7rem;">PRIMARY</span>' : ''}</h4>
        <input type="text" placeholder="Name" value="${sp.name || ''}" class="sp-name" style="width:100%;margin-bottom:4px;">
        <input type="url" placeholder="URL" value="${sp.url || ''}" class="sp-url" style="width:100%;margin-bottom:4px;">
        <input type="url" placeholder="Image URL" value="${sp.img || ''}" class="sp-img" style="width:100%;margin-bottom:8px;">
        <label style="display:block;margin-bottom:8px;padding:8px;background:#fef3c7;border-radius:6px;"><input type="checkbox" class="sp-isPrimary" ${sp.isPrimary ? 'checked' : ''}> <strong>Primary Sponsor</strong> <span style="font-size:0.8em;color:#92400e;">(Bigger rendering)</span></label>
        <label><input type="checkbox" class="sp-posterTop" ${placements.posterTop ? 'checked' : ''}> Poster Top</label><br>
        <label><input type="checkbox" class="sp-tvTop" ${placements.tvTop ? 'checked' : ''}> TV Top</label><br>
        <label><input type="checkbox" class="sp-tvSide" ${placements.tvSide ? 'checked' : ''}> TV Side</label><br>
        <label><input type="checkbox" class="sp-mobileBanner" ${placements.mobileBanner ? 'checked' : ''}> Mobile Banner</label>
      `;
      list.appendChild(div);
    });
  }

  /**
   * Add new sponsor to list.
   */
  function addSponsor() {
    const list = document.getElementById('sponsorList');
    if (!list) return;

    const div = document.createElement('div');
    div.className = 'event-card';
    div.innerHTML = `
      <h4>New Sponsor</h4>
      <input type="text" placeholder="Name" class="sp-name" style="width:100%;margin-bottom:4px;">
      <input type="url" placeholder="URL" class="sp-url" style="width:100%;margin-bottom:4px;">
      <input type="url" placeholder="Image URL" class="sp-img" style="width:100%;margin-bottom:8px;">
      <label style="display:block;margin-bottom:8px;padding:8px;background:#fef3c7;border-radius:6px;"><input type="checkbox" class="sp-isPrimary"> <strong>Primary Sponsor</strong> <span style="font-size:0.8em;color:#92400e;">(Bigger rendering)</span></label>
      <label><input type="checkbox" class="sp-posterTop"> Poster Top</label><br>
      <label><input type="checkbox" class="sp-tvTop"> TV Top</label><br>
      <label><input type="checkbox" class="sp-tvSide"> TV Side</label><br>
      <label><input type="checkbox" class="sp-mobileBanner"> Mobile Banner</label>
    `;
    list.appendChild(div);
  }

  // ==========================================================================
  // HELPER FUNCTIONS
  // ==========================================================================

  /**
   * Get admin key from session storage or prompt user.
   */
  function getAdminKey() {
    const BRAND = window.BRAND || 'root';
    const k = sessionStorage.getItem('ADMIN_KEY:' + BRAND) || prompt('Admin key for ' + BRAND);
    if (k) sessionStorage.setItem('ADMIN_KEY:' + BRAND, k);
    return k || '';
  }

  /**
   * CANONICAL WRITE API HELPER (ZEVENT-003)
   * Load-Merge-Save pattern using Worker for load, GAS for save.
   *
   * Story 2.3: Load step now uses Worker admin bundle
   * Save step still uses GAS api_saveEvent (canonical write endpoint)
   *
   * @param {string} eventId - Event ID to update
   * @param {Object} partialData - Partial data to merge into event
   * @returns {Object} Result from api_saveEvent { ok, value, message }
   */
  async function saveEventPartial(eventId, partialData) {
    const BRAND = window.BRAND || 'root';
    const SCOPE = window.SCOPE || 'events';

    // Step 1: Load current event - prefer cached admin bundle, then Worker
    let currentEvent = null;

    if (window.currentAdminBundle && window.currentAdminBundle.event &&
        window.currentAdminBundle.event.id === eventId) {
      // Use cached admin bundle event
      currentEvent = window.currentAdminBundle.event;
      console.log('[AdminDisplay] saveEventPartial using cached admin bundle');
    } else if (typeof window.fetchAdminBundleFromWorker === 'function') {
      // Fetch from Worker
      const getRes = await window.fetchAdminBundleFromWorker(eventId, BRAND);
      if (!getRes.ok) {
        return { ok: false, message: `Failed to load event: ${getRes.message}` };
      }
      currentEvent = getRes.value.event;
      console.log('[AdminDisplay] saveEventPartial fetched from Worker');
    } else {
      return { ok: false, message: 'Failed to load event: Worker not available' };
    }

    if (!currentEvent) {
      return { ok: false, message: 'Failed to load event: No event data' };
    }

    // Step 2: Merge partial data into the full event object
    const mergedEvent = deepMerge_(currentEvent, partialData);

    // Step 3: Save via canonical api_saveEvent (GAS)
    const saveRes = await NU.rpc('api_saveEvent', {
      brandId: BRAND,
      adminKey: getAdminKey(),
      event: mergedEvent,
      scope: SCOPE
    });

    // Update cached admin bundle with new event data if save succeeded
    if (saveRes.ok && window.currentAdminBundle) {
      window.currentAdminBundle.event = mergedEvent;
    }

    return saveRes;
  }

  /**
   * Deep merge helper for event objects.
   * Merges source into target, handling nested objects.
   * Arrays are replaced, not merged.
   */
  function deepMerge_(target, source) {
    const result = { ...target };
    for (const key of Object.keys(source)) {
      if (source[key] !== null && typeof source[key] === 'object' && !Array.isArray(source[key])) {
        // Nested object - recurse
        result[key] = deepMerge_(result[key] || {}, source[key]);
      } else {
        // Primitive, array, or null - replace
        result[key] = source[key];
      }
    }
    // Update timestamp on every save
    result.updatedAtISO = new Date().toISOString();
    return result;
  }

  // ==========================================================================
  // EXPOSE FUNCTIONS TO GLOBAL SCOPE
  // ==========================================================================

  // Display configuration
  window.configureDisplay = configureDisplay;
  window.loadDisplayConfig = loadDisplayConfig;
  window.toggleDisplayMode = toggleDisplayMode;
  window.saveDisplayConfig = saveDisplayConfig;
  window.closeDisplayConfig = closeDisplayConfig;

  // URL management
  window.renderUrls = renderUrls;
  window.addUrl = addUrl;

  // Sponsor management
  window.renderSponsors = renderSponsors;
  window.addSponsor = addSponsor;

  // Helpers
  window.getAdminKey = getAdminKey;
  window.saveEventPartial = saveEventPartial;
  window.deepMerge_ = deepMerge_;

})();
</script>
