<!--
================================================================================
MVP SURFACE - Focus Group Critical
================================================================================
Page: Display.html
Purpose: TV/kiosk display for live event streaming with sponsor visibility
Status: HARDENED for MVP v1.0 + V2 Rotation Engine

SCHEMA CONTRACT: /schemas/event.schema.json

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
READS FROM EVENT SCHEMA (via api_getDisplayBundle):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  Identity (MVP Required):
    - event.id                ‚Üí Event identifier for analytics
    - event.name              ‚Üí Event title (fallback display)
    - event.startDateISO      ‚Üí Event date (fallback display)
    - event.venue             ‚Üí Venue name (fallback display)
    - event.templateId        ‚Üí Template type for layout/rotation defaults
    - event.links.publicUrl   ‚Üí Iframe source for main content

  Settings (MVP Required):
    - event.settings.showSchedule     ‚Üí Section toggle (passed to iframe)
    - event.settings.showStandings    ‚Üí Section toggle (passed to iframe)
    - event.settings.showBracket      ‚Üí Section toggle (passed to iframe)
    - event.settings.showSponsors     ‚Üí Master sponsor strip toggle
    - event.settings.showVideo        ‚Üí Video toggle (Feature 4 - passed to iframe)
    - event.settings.showMap          ‚Üí Map toggle (Feature 4 - passed to iframe)
    - event.settings.showGallery      ‚Üí Gallery toggle (Feature 4 - passed to iframe)
    - event.settings.showSponsorStrip ‚Üí TV sponsor strip visibility
    - event.settings.showLeagueStrip  ‚Üí TV league/broadcast strip visibility

  V2 Display Rotation (settings.displayRotation):
    - displayRotation.enabled         ‚Üí Enable rotation mode
    - displayRotation.panes[]         ‚Üí Panes to rotate (schedule, standings, sponsors, public, custom)
    - displayRotation.defaultDwellMs  ‚Üí Default dwell time per pane

  Sponsors (V2 Optional):
    - event.sponsors[].id, name, logoUrl, linkUrl, placement
    - Filter: placement === 'display' OR 'tv-banner'

  Schedule & Standings (V2 Optional - for rotation panes):
    - event.schedule[]   ‚Üí Schedule items for schedule pane
    - event.standings[]  ‚Üí Standings rows for standings pane

  External Data (V2 Optional - league strip):
    - event.externalData.scheduleUrl  ‚Üí League strip link
    - event.externalData.standingsUrl ‚Üí League strip link
    - event.externalData.bracketUrl   ‚Üí League strip link

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
DISPLAY MODES:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  1. PUBLIC MODE (default MVP):
     - Shows Public.html in iframe (mirrors event page)
     - Adds sponsor strip (top) and league strip (bottom) overlays

  2. ROTATION MODE (V2):
     - Multi-pane display with configurable rotation
     - Pane types: public, schedule, standings, sponsors, custom
     - Each pane has configurable dwell time (dwellMs)
     - Schema-driven: settings.displayRotation in event schema
     - Force via URL: ?rotate=1

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SECTION GATES (schema-backed visibility):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  Sponsor Strip: if (settings.showSponsors && settings.showSponsorStrip !== false)
                 && sponsors.some(s => s.placement === 'display' || s.placement === 'tv-banner')
  League Strip:  if (settings.showLeagueStrip !== false)
                 && (externalData.scheduleUrl || standingsUrl || bracketUrl)
  Rotation:      if (displayRotation.enabled || URL ?rotate=1)
                 && displayRotation.panes.length > 0
  Main Content:  Shows Public.html iframe OR rotation panes based on mode

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
KEYBOARD CONTROLS (Rotation Mode):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  Space        ‚Üí Pause/resume rotation
  ArrowRight   ‚Üí Skip to next pane
  ArrowLeft    ‚Üí Go to previous pane

DO NOT add fields without updating:
  - /schemas/event.schema.json (source of truth)
  - src/mvp/Code.gs (_buildEventContract_, api_getDisplayBundle)
  - src/mvp/Config.gs (DISPLAY_CONFIG.paneTypes, templateOverrides)

Related MVP Surfaces: Admin, Poster, Public, Sponsor, SharedReport
================================================================================
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title><?= appTitle ?> ¬∑ TV Display</title>
  <?!= include('Styles'); ?>
  <?!= include('SponsorUtils'); ?>
  <?!= include('SharedUtils'); ?>
  <?!= include('FooterComponent'); ?>
  <?!= include('NUSDK'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="referrer" content="no-referrer" />
  <style>
    :root {
      --tv-pad: 12px;
      --side-w: 320px;
      /* TV overscan safe area - 5% margins for older TVs */
      --tv-safe-area: 5%;
    }
    body[data-tv="1"] {
      background: var(--color-tv-bg, #111);
      color: var(--color-tv-text, #eee);
      font-size: clamp(20px, 2.8vw, 32px); /* Legible at 10-12ft */
      line-height:1.5;
      /* Apply safe area padding for TV overscan */
      padding: var(--tv-safe-area);
      box-sizing: border-box;
    }
    [hidden] { display:none !important; }
    main#tv {
      display:grid; grid-template-columns: 1fr; grid-template-rows: auto 1fr; height:100vh;
    }
    main#tv.has-side {
      grid-template-columns: 1fr var(--side-w); grid-template-rows: auto 1fr;
    }
    .sponsor-top {
      grid-column: 1 / -1; grid-row:1;
      padding: var(--tv-pad); text-align:center; font-weight:600; opacity:.98;
      background: linear-gradient(135deg, var(--color-tv-bg, #0b0b0b) 0%, var(--color-tv-bg-elevated, #1a1a1a) 100%);
      border-bottom: 2px solid var(--color-tv-border, #333);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      flex-wrap: wrap;
      min-height: 80px;
    }
    .sponsor-top img {
      max-height: var(--display-sponsor-logo-height-top, 72px); vertical-align:middle; margin:0 1rem;
      filter: brightness(1.1);
      transition: transform var(--transition-slow, 0.3s ease);
    }
    .sponsor-top img:hover {
      transform: scale(1.05);
    }
    .stage { position:relative; grid-column:1; grid-row:2; }
    iframe#stage {
      position:absolute; inset:0; width:100%; height:100%; border:0;
      background: var(--color-tv-bg, #000);
    }
    .fallback-card {
      position:absolute; inset:0; display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      background: linear-gradient(135deg, var(--color-tv-bg-elevated, #1a1a1a) 0%, var(--color-tv-bg, #0f0f0f) 100%);
      text-align:center; padding:40px;
    }
    .fallback-card h2 {
      margin:0 0 16px; color: var(--color-warning, #f59e0b); font-size:2em;
      text-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    .fallback-card p { color: var(--color-tv-text-muted, #9ca3af); font-size: max(1.2em, 1.125rem); margin:8px 0; line-height: 1.6; } /* D-AUDIT: Min 18px for TV legibility */
    aside#sponsorSide {
      grid-column:2; grid-row:2; padding: var(--tv-pad); overflow:auto;
      background: linear-gradient(180deg, var(--color-tv-bg, #0b0b0b) 0%, var(--color-tv-bg-elevated, #161616) 100%);
      display:flex; flex-direction:column; gap:16px;
      border-left: 2px solid var(--color-tv-border, #333);
    }
    .sp-card {
      display:flex; align-items:center; gap:12px;
      background: var(--color-tv-bg-card, #1f1f1f);
      padding:16px; border-radius:12px;
      border: 1px solid var(--color-tv-border, #2a2a2a);
      transition: all 0.3s ease;
    }
    .sp-card:hover {
      background: var(--color-tv-bg-elevated, #252525);
      transform: translateX(-4px);
      border-color: var(--color-tv-border-hover, #3a3a3a);
    }
    .sp-card img {
      max-height: var(--display-sponsor-logo-height-side, 64px); max-width:160px; object-fit:contain;
      filter: brightness(1.15);
    }
    /* TV-005: Sponsor name legibility for TV distance */
    .sp-name { font-weight:600; font-size: clamp(1.125rem, 2vw, 1.5rem); color: var(--color-tv-text, #f0f0f0); }
    .toast {
      position:fixed; right:20px; bottom:20px;
      background: linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.95) 100%);
      color:#fff; padding:12px 20px; border-radius:12px;
      font-size: max(1rem, 0.9em); /* D-AUDIT: Min 1rem for TV legibility at 10ft */
      z-index:999;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      backdrop-filter: blur(8px);
    }

    /* TV Mode Focus Indicators - for D-pad/remote navigation */
    body[data-tv="1"] a:focus-visible,
    body[data-tv="1"] button:focus-visible,
    body[data-tv="1"] [tabindex]:focus-visible {
      outline: 4px solid #ffb84d;
      outline-offset: 4px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(255, 184, 77, 0.5);
    }

    /* Sponsor logo sizing for TV legibility */
    body[data-tv="1"] .sponsor-top img {
      max-height: clamp(var(--display-sponsor-logo-height-top, 72px), 10vw, var(--sponsor-logo-height-tv, 120px));
      filter: brightness(1.3) contrast(1.1);
    }

    /* .site-footer - Now centralized in FooterComponent.html (D-005) */
    /* TV mode styling handled by body[data-tv="1"] .site-footer selector */

    /* === League & Broadcast Strip (TV-optimized, bottom strip) === */
    .league-broadcast-strip {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 12px 24px;
      z-index: 50;
      border: 1px solid rgba(255, 255, 255, 0.15);
      display: flex;
      align-items: center;
      gap: 20px;
      max-width: 90vw;
    }
    /* TV-optimized strip text sizes (10-12ft viewing distance) */
    /* Fixed: TV-001, TV-002, TV-003 - text was illegible at TV distance */
    .league-broadcast-strip .strip-title {
      color: var(--color-warning, #f59e0b);
      font-size: clamp(1rem, 1.8vw, 1.5rem);  /* 16-24px for TV legibility */
      text-transform: uppercase;
      letter-spacing: 1px;
      white-space: nowrap;
      font-weight: 600;
    }
    .league-broadcast-strip .strip-divider {
      width: 2px;
      height: 28px;
      background: rgba(255, 255, 255, 0.25);
    }
    .league-broadcast-strip .strip-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .league-broadcast-strip .strip-label {
      color: #9ca3af;
      font-size: clamp(0.875rem, 1.5vw, 1.25rem);  /* 14-20px minimum */
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .league-broadcast-strip .strip-links {
      display: flex;
      gap: 12px;
    }
    .league-broadcast-strip .strip-link {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #fff;
      text-decoration: none;
      padding: 10px 16px;  /* Larger touch/remote targets */
      background: rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      font-size: clamp(1rem, 2vw, 1.5rem);  /* 16-24px for TV */
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .league-broadcast-strip .strip-link:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    .league-broadcast-strip .strip-link .icon {
      font-size: 1rem;
    }
    .league-broadcast-strip .strip-link.stream-link {
      background: rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }
    .league-broadcast-strip .strip-link.stream-link:hover {
      background: rgba(239, 68, 68, 0.5);
    }

    /* Lifecycle Phase Indicator (TV mode) - matches Admin/Public styling */
    .lifecycle-indicator-tv {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 100;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: clamp(14px, 1.5vw, 18px);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .lifecycle-indicator-tv::before {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: currentColor;
    }
    .lifecycle-indicator-tv[data-phase="pre-event"] {
      background: rgba(219, 234, 254, 0.9);
      color: #1e40af;
    }
    .lifecycle-indicator-tv[data-phase="event-day"] {
      background: rgba(209, 250, 229, 0.9);
      color: #065f46;
      animation: pulse-live 2s ease-in-out infinite;
    }
    .lifecycle-indicator-tv[data-phase="post-event"] {
      background: rgba(252, 231, 243, 0.9);
      color: #9f1239;
    }
    @keyframes pulse-live {
      0%, 100% { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
      50% { box-shadow: 0 4px 20px rgba(16, 185, 129, 0.5); }
    }

    /* Legacy overlay support (fallback/side column option) */
    .league-info-overlay {
      position: fixed;
      bottom: 40px;
      right: 20px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 20px 24px;
      z-index: 50;
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-width: 320px;
    }
    .league-info-overlay h3 {
      color: #f59e0b;
      font-size: 1rem;
      margin: 0 0 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .league-info-overlay .league-links {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .league-info-overlay .league-link {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #eee;
      text-decoration: none;
      padding: 12px 16px; /* D-AUDIT: Increased padding for touch targets */
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      font-size: max(1rem, 0.9em); /* D-AUDIT: Min 1rem for TV legibility */
      transition: all 0.2s ease;
    }
    .league-info-overlay .league-link:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateX(4px);
    }
    .league-info-overlay .league-link .icon {
      font-size: 1.2em;
    }

    /* === MVP Essential: Error State (TV-themed) === */
    .error-state-tv {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      text-align: center;
      padding: 40px;
    }
    .error-state-tv .error-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.7;
    }
    .error-state-tv h2 {
      color: #ef4444;
      font-size: 1.8em;
      margin-bottom: 12px;
    }
    .error-state-tv p {
      color: #9ca3af;
      font-size: 1.1em;
      margin: 8px 0;
      max-width: 500px;
    }
    .error-state-tv .btn-retry {
      margin-top: 24px;
      padding: 14px 28px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
    }
    .error-state-tv .btn-retry:hover {
      background: #1d4ed8;
    }

    /* Feature 3: Primary Sponsor - Bigger Rendering for TV */
    .sponsor-primary img,
    .sponsor-logo.sponsor-primary {
      max-height: calc(var(--display-sponsor-logo-height-top, 72px) * 1.6) !important;
      filter: brightness(1.3) drop-shadow(0 4px 12px rgba(245, 158, 11, 0.4));
    }
    .sponsor-primary strong {
      font-size: 1.5em;
      color: #fcd34d;
    }
    .sponsor-item.sponsor-primary {
      order: -1;
      padding: 12px 24px;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(234, 179, 8, 0.15) 100%);
      border-radius: 12px;
      border: 2px solid rgba(245, 158, 11, 0.4);
    }
    .sponsor-tier-badge {
      display: inline-block;
      padding: 4px 10px;
      background: #f59e0b;
      color: #000;
      font-size: 0.7rem;
      font-weight: 700;
      border-radius: 10px;
      text-transform: uppercase;
      margin-left: 8px;
      vertical-align: middle;
      letter-spacing: 0.5px;
    }
    .sp-card.sponsor-primary {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, var(--color-tv-bg-card, #1f1f1f) 100%);
      border-color: rgba(245, 158, 11, 0.5);
    }
    .sp-card.sponsor-primary img {
      max-height: calc(var(--display-sponsor-logo-height-side, 64px) * 1.4);
    }

    /* ===== Mobile Fallback for Phone Preview/Debugging ===== */
    /* Display is TV-first but must be "mobile-valid" for phone preview */
    @media (max-width: 768px) {
      :root {
        --tv-safe-area: 0;
      }

      body[data-tv="1"] {
        font-size: 16px;
        padding: 0;
        overflow-x: hidden;
      }

      /* Stack layout vertically on phone */
      main#tv {
        display: flex;
        flex-direction: column;
        height: auto;
        min-height: 100vh;
      }

      main#tv.has-side {
        grid-template-columns: 1fr;
      }

      /* Sponsor strip mobile - scrollable horizontal */
      .sponsor-top {
        min-height: 60px;
        padding: 10px 12px;
        gap: 12px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        flex-wrap: nowrap;
        justify-content: flex-start;
      }

      .sponsor-top img {
        max-height: 40px;
        margin: 0 8px;
      }

      /* Stage takes remaining height */
      .stage {
        flex: 1;
        min-height: 300px;
        position: relative;
      }

      /* Hide side panel on mobile - show in top strip only */
      aside#sponsorSide {
        display: none !important;
      }

      /* League strip mobile adjustments */
      .league-broadcast-strip {
        bottom: auto;
        top: auto;
        position: relative;
        transform: none;
        margin: 8px;
        max-width: 100%;
        padding: 10px 14px;
        border-radius: 10px;
        flex-wrap: wrap;
        gap: 12px;
      }

      .league-broadcast-strip .strip-title {
        font-size: 0.85rem;
        flex-basis: 100%;
        text-align: center;
      }

      .league-broadcast-strip .strip-divider {
        display: none;
      }

      .league-broadcast-strip .strip-section {
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        width: 100%;
      }

      .league-broadcast-strip .strip-label {
        font-size: 0.75rem;
        width: 100%;
        text-align: center;
      }

      .league-broadcast-strip .strip-links {
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
      }

      .league-broadcast-strip .strip-link {
        font-size: 0.85rem;
        padding: 8px 12px;
        min-height: 44px;
      }

      /* Legacy overlay mobile */
      .league-info-overlay {
        position: relative;
        bottom: auto;
        right: auto;
        margin: 8px;
        max-width: 100%;
        border-radius: 10px;
      }

      /* Toast mobile */
      .toast {
        right: 12px;
        bottom: 80px;
        left: 12px;
        text-align: center;
        font-size: 0.85rem;
      }

      /* Fallback card mobile */
      .fallback-card {
        padding: 24px 16px;
      }

      .fallback-card h2 {
        font-size: 1.4em;
      }

      .fallback-card p {
        font-size: 0.95rem;
      }

      /* Error state mobile */
      .error-state-tv {
        padding: 24px 16px;
      }

      .error-state-tv .error-icon {
        font-size: 3rem;
      }

      .error-state-tv h2 {
        font-size: 1.3em;
      }

      .error-state-tv p {
        font-size: 0.95rem;
      }

      /* Footer mobile - visible at bottom */
      .site-footer {
        position: relative !important;
        padding: 16px;
        margin-top: 0;
        background: var(--color-tv-bg, #111);
        border-top: 1px solid var(--color-tv-border, #333);
      }

      /* Primary sponsor mobile */
      .sponsor-primary img {
        max-height: 50px !important;
      }

      .sponsor-item.sponsor-primary {
        padding: 8px 14px;
      }
    }

    /* Very small screens */
    @media (max-width: 375px) {
      .sponsor-top {
        padding: 8px;
        gap: 8px;
      }

      .sponsor-top img {
        max-height: 32px;
        margin: 0 4px;
      }

      .league-broadcast-strip {
        padding: 8px 10px;
      }

      .league-broadcast-strip .strip-link {
        font-size: 0.8rem;
        padding: 6px 10px;
      }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       V2 ROTATION ENGINE - Multi-Pane Display
       Schema: settings.displayRotation in /schemas/event.schema.json
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    /* === Rotation Pane Container === */
    .rotation-pane {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
      background: var(--color-tv-bg, #111);
    }
    .rotation-pane.active {
      opacity: 1;
      visibility: visible;
      z-index: 10;
    }
    .rotation-pane.fade-out {
      opacity: 0;
    }

    /* === Pane Title Overlay === */
    .pane-title-overlay {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      padding: 12px 32px;
      border-radius: 12px;
      z-index: 20;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .pane-title-overlay h2 {
      margin: 0;
      font-size: clamp(1.25rem, 2.5vw, 2rem);
      font-weight: 600;
      color: var(--color-tv-text, #fff);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* === Rotation Progress Indicator === */
    .rotation-indicator {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      padding: 8px 16px;
      border-radius: 20px;
    }
    .rotation-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }
    .rotation-dot.active {
      background: var(--color-warning, #f59e0b);
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
      transform: scale(1.2);
    }
    .rotation-progress {
      position: absolute;
      bottom: -4px;
      left: 0;
      height: 3px;
      background: var(--color-warning, #f59e0b);
      border-radius: 2px;
      transition: width linear;
    }

    /* === Schedule Pane === */
    .pane-schedule {
      padding: 40px;
      overflow: auto;
    }
    .schedule-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 900px;
      margin: 60px auto 0;
    }
    .schedule-item {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 24px;
      padding: 20px 24px;
      background: var(--color-tv-bg-card, #1a1a1a);
      border-radius: 12px;
      border: 1px solid var(--color-tv-border, #2a2a2a);
      transition: all 0.3s ease;
    }
    .schedule-item:hover {
      background: var(--color-tv-bg-elevated, #252525);
      transform: translateX(4px);
    }
    .schedule-time {
      font-size: clamp(1.25rem, 2vw, 1.75rem);
      font-weight: 700;
      color: var(--color-warning, #f59e0b);
      white-space: nowrap;
    }
    .schedule-content h3 {
      margin: 0 0 4px;
      font-size: clamp(1.1rem, 1.8vw, 1.5rem);
      font-weight: 600;
      color: var(--color-tv-text, #fff);
    }
    .schedule-content p {
      margin: 0;
      font-size: clamp(0.9rem, 1.4vw, 1.1rem);
      color: var(--color-tv-text-muted, #9ca3af);
    }
    .schedule-empty {
      text-align: center;
      padding: 80px 40px;
      color: var(--color-tv-text-muted, #9ca3af);
      font-size: clamp(1.1rem, 2vw, 1.5rem);
    }

    /* === Standings Pane === */
    .pane-standings {
      padding: 40px;
      overflow: auto;
    }
    .standings-table {
      width: 100%;
      max-width: 900px;
      margin: 60px auto 0;
      border-collapse: collapse;
    }
    .standings-table th,
    .standings-table td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid var(--color-tv-border, #2a2a2a);
    }
    .standings-table th {
      font-size: clamp(0.9rem, 1.4vw, 1.1rem);
      font-weight: 600;
      color: var(--color-tv-text-muted, #9ca3af);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--color-tv-bg-elevated, #1a1a1a);
    }
    .standings-table td {
      font-size: clamp(1.1rem, 1.8vw, 1.4rem);
      color: var(--color-tv-text, #fff);
    }
    .standings-table tr:hover td {
      background: var(--color-tv-bg-card, #1f1f1f);
    }
    .standings-rank {
      font-weight: 700;
      color: var(--color-warning, #f59e0b);
      width: 60px;
    }
    .standings-rank.top-3 {
      font-size: 1.3em;
    }
    .standings-team {
      font-weight: 600;
    }
    .standings-record {
      color: var(--color-tv-text-muted, #9ca3af);
    }
    .standings-empty {
      text-align: center;
      padding: 80px 40px;
      color: var(--color-tv-text-muted, #9ca3af);
      font-size: clamp(1.1rem, 2vw, 1.5rem);
    }

    /* === Sponsor Carousel Pane === */
    .pane-sponsors {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }
    .sponsor-carousel {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 48px;
      max-width: 1200px;
      margin-top: 40px;
    }
    .sponsor-carousel-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 24px;
      background: var(--color-tv-bg-card, #1a1a1a);
      border-radius: 16px;
      border: 2px solid var(--color-tv-border, #2a2a2a);
      transition: all 0.4s ease;
      min-width: 200px;
      max-width: 280px;
    }
    .sponsor-carousel-item:hover {
      transform: scale(1.05);
      border-color: var(--color-warning, #f59e0b);
      box-shadow: 0 8px 32px rgba(245, 158, 11, 0.2);
    }
    .sponsor-carousel-item.primary {
      border-color: var(--color-warning, #f59e0b);
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, var(--color-tv-bg-card, #1a1a1a) 100%);
    }
    .sponsor-carousel-item img {
      max-height: 100px;
      max-width: 200px;
      object-fit: contain;
      filter: brightness(1.2);
    }
    .sponsor-carousel-item .sponsor-name {
      font-size: clamp(1rem, 1.5vw, 1.25rem);
      font-weight: 600;
      color: var(--color-tv-text, #fff);
    }
    .sponsors-empty {
      text-align: center;
      padding: 80px 40px;
      color: var(--color-tv-text-muted, #9ca3af);
      font-size: clamp(1.1rem, 2vw, 1.5rem);
    }

    /* === Rotation Controls (optional, for manual mode) === */
    .rotation-controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 8px;
      z-index: 100;
    }
    .rotation-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .rotation-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .rotation-btn:focus-visible {
      outline: 3px solid var(--color-warning, #f59e0b);
      outline-offset: 2px;
    }
    .rotation-btn.paused {
      background: rgba(239, 68, 68, 0.3);
    }

    /* === Mobile adjustments for rotation panes === */
    @media (max-width: 768px) {
      .pane-schedule,
      .pane-standings,
      .pane-sponsors {
        padding: 20px;
      }
      .schedule-grid,
      .standings-table {
        margin-top: 80px;
      }
      .schedule-item {
        grid-template-columns: 100px 1fr;
        gap: 12px;
        padding: 14px 16px;
      }
      .sponsor-carousel {
        gap: 20px;
        margin-top: 80px;
      }
      .sponsor-carousel-item {
        padding: 16px;
        min-width: 140px;
      }
      .sponsor-carousel-item img {
        max-height: 60px;
        max-width: 120px;
      }
      .rotation-indicator {
        bottom: 80px;
      }
      .pane-title-overlay {
        top: 10px;
        padding: 8px 20px;
      }
    }
  </style>
</head>
<body data-tv="1">
  <main id="tv">
    <div class="sponsor-top" id="sponsorTop" hidden></div>
    <!-- Lifecycle Phase Indicator (same labels as Admin/Public for parity) -->
    <div id="lifecycleIndicator" class="lifecycle-indicator-tv" data-testid="lifecycle-indicator" hidden></div>
    <div class="stage">
      <!-- V1: Public embed mode (default) -->
      <iframe id="stage" allow="autoplay; fullscreen" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>
      <div id="fallback" class="fallback-card" hidden>
        <h2>‚ö† Content Unavailable</h2>
        <p id="fallbackMsg">This source cannot be embedded.</p>
        <p class="muted">Switching to next item...</p>
      </div>

      <!-- V2: Rotation Panes (schema: settings.displayRotation) -->
      <div id="paneSchedule" class="rotation-pane pane-schedule" hidden>
        <div class="pane-title-overlay" id="schedulePaneTitle" hidden><h2>Schedule</h2></div>
        <div id="scheduleContent" class="schedule-grid"></div>
      </div>

      <div id="paneStandings" class="rotation-pane pane-standings" hidden>
        <div class="pane-title-overlay" id="standingsPaneTitle" hidden><h2>Standings</h2></div>
        <div id="standingsContent"></div>
      </div>

      <div id="paneSponsors" class="rotation-pane pane-sponsors" hidden>
        <div class="pane-title-overlay" id="sponsorsPaneTitle" hidden><h2>Our Sponsors</h2></div>
        <div id="sponsorsCarouselContent" class="sponsor-carousel"></div>
      </div>

      <div id="paneCustom" class="rotation-pane" hidden>
        <div class="pane-title-overlay" id="customPaneTitle" hidden><h2>Custom</h2></div>
        <iframe id="customFrame" allow="autoplay; fullscreen" sandbox="allow-scripts allow-same-origin allow-popups allow-forms" style="position:absolute;inset:0;width:100%;height:100%;border:0;"></iframe>
      </div>
    </div>

    <!-- Rotation Progress Indicator (V2) -->
    <div id="rotationIndicator" class="rotation-indicator" hidden></div>
    <aside id="sponsorSide" hidden></aside>
  </main>
  <div class="toast" id="toast" hidden></div>

  <!-- External Links Strip (bottom bar for TV) -->
  <div id="leagueBroadcastStrip" class="league-broadcast-strip" hidden>
    <span id="stripTitle" class="strip-title">Event Links</span>
    <div class="strip-divider"></div>
    <div id="leagueLinksSection" class="strip-section" hidden>
      <span class="strip-label">Resources:</span>
      <div id="leagueStripLinks" class="strip-links"></div>
    </div>
    <div id="broadcastLinksSection" class="strip-section" hidden>
      <span class="strip-label">Broadcast:</span>
      <div id="broadcastStripLinks" class="strip-links"></div>
    </div>
  </div>

  <!-- Legacy Event Info Overlay (side column fallback) -->
  <div id="leagueInfoOverlay" class="league-info-overlay" hidden>
    <h3>üìä Event Info</h3>
    <div id="leagueLinks" class="league-links"></div>
  </div>

  <!-- Trust Footer (subtle for TV) -->
  <footer class="site-footer">
    <span>Powered by <a href="https://eventangle.com" target="_blank" rel="noopener">EventAngle</a></span>
  </footer>

  <script>
    const qs = new URLSearchParams(location.search);
    const eventId = qs.get('event') || qs.get('id') || '';
    const brandId = qs.get('brand') || '<?= brandId ?>';
    const stage = document.getElementById('stage');
    const fallback = document.getElementById('fallback');
    const topEl = document.getElementById('sponsorTop');
    const sideEl = document.getElementById('sponsorSide');
    const mainEl = document.getElementById('tv');
    const toast = document.getElementById('toast');

    const showToast = (msg, ms=2500) => {
      toast.textContent = msg; toast.hidden = false;
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.hidden = true, ms);
    };

    // Use shared utilities from SponsorUtils
    const { esc, logEvent, initLogging, getSessionId } = window.SponsorUtils;
    initLogging();

    // Track rendered sponsor IDs for BBN attribution
    let currentRenderedSponsorIds = [];

    // === SCHEMA SUPPORT: /schemas/event.schema.json ===
    // Use centralized sectionEnabled from SharedUtils
    // Feature 4: Template-Aware Section Toggles - added showVideo, showMap, showGallery
    const sectionEnabled = window.SharedUtils?.sectionEnabled || function(settings, key) {
      if (!settings) return false;
      switch (key) {
        case 'schedule': return settings.showSchedule === true;
        case 'standings': return settings.showStandings === true;
        case 'bracket': return settings.showBracket === true;
        case 'sponsors': return settings.showSponsors === true;
        // Feature 4: Template-Aware Content Sections
        case 'video': return settings.showVideo !== false; // Default true for backwards compat
        case 'map': return settings.showMap !== false;     // Default true for backwards compat
        case 'gallery': return settings.showGallery !== false; // Default true for backwards compat
        default: return false;
      }
    };

    // League templates that show the League & Broadcast strip
    const LEAGUE_TEMPLATES = ['rec_league', 'darts', 'bags', 'pinball', 'trivia', 'custom'];

    // Render League & Broadcast strip (ExternalLeagueData per EVENT_CONTRACT.md)
    function renderLeagueBroadcast(templateId, externalData) {
      const ext = externalData || {};

      // Check for league links
      const leagueLinks = [];
      if (ext.scheduleUrl) leagueLinks.push({ icon: 'üìÖ', label: 'Schedule', url: ext.scheduleUrl, type: 'schedule' });
      if (ext.standingsUrl) leagueLinks.push({ icon: 'üèÜ', label: 'Standings', url: ext.standingsUrl, type: 'standings' });
      if (ext.bracketUrl) leagueLinks.push({ icon: 'üéØ', label: 'Bracket', url: ext.bracketUrl, type: 'bracket' });

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // V2 COMMENTED OUT - statsUrl/scoreboardUrl/streamUrl NOT IN /schemas/event.schema.json
      // ExternalData only has: scheduleUrl, standingsUrl, bracketUrl
      // V2 FEATURE ‚Äì NOT MVP: Add broadcast URLs to schema when streaming feature is ready
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      const broadcastLinks = [];
      // if (ext.statsUrl) broadcastLinks.push({ icon: 'üìà', label: 'Stats', url: ext.statsUrl, type: 'stats' });
      // if (ext.scoreboardUrl) broadcastLinks.push({ icon: 'üì∫', label: 'Scoreboard', url: ext.scoreboardUrl, type: 'scoreboard' });
      // if (ext.streamUrl) broadcastLinks.push({ icon: 'üé•', label: 'Watch', url: ext.streamUrl, type: 'stream', isStream: true });

      const hasLeagueLinks = leagueLinks.length > 0;
      const hasBroadcastLinks = broadcastLinks.length > 0;

      // Only show if we have links AND (is league template OR has explicit data)
      if (!hasLeagueLinks && !hasBroadcastLinks) return;
      if (!LEAGUE_TEMPLATES.includes(templateId) && !hasLeagueLinks && !hasBroadcastLinks) return;

      // Get strip elements
      const strip = document.getElementById('leagueBroadcastStrip');
      const titleEl = document.getElementById('stripTitle');
      const leagueSection = document.getElementById('leagueLinksSection');
      const leagueLinksEl = document.getElementById('leagueStripLinks');
      const broadcastSection = document.getElementById('broadcastLinksSection');
      const broadcastLinksEl = document.getElementById('broadcastStripLinks');

      // Set dynamic title based on providerName
      const providerName = ext.providerName;
      if (providerName && providerName !== 'None' && providerName !== 'Custom') {
        titleEl.textContent = `League & Broadcast (${providerName})`;
      } else {
        titleEl.textContent = 'League & Broadcast';
      }

      // Render league links
      if (hasLeagueLinks) {
        leagueLinksEl.innerHTML = leagueLinks.map(l => `
          <a href="${esc(l.url)}" target="_blank" rel="noopener" class="strip-link" data-link-type="${l.type}">
            <span class="icon">${l.icon}</span>
            <span>${esc(l.label)}</span>
          </a>
        `).join('');
        leagueSection.hidden = false;
      }

      // Render broadcast links
      if (hasBroadcastLinks) {
        broadcastLinksEl.innerHTML = broadcastLinks.map(l => `
          <a href="${esc(l.url)}" target="_blank" rel="noopener" class="strip-link${l.isStream ? ' stream-link' : ''}" data-link-type="${l.type}">
            <span class="icon">${l.icon}</span>
            <span>${esc(l.label)}</span>
          </a>
        `).join('');
        broadcastSection.hidden = false;
      }

      strip.hidden = false;

      // S13: Analytics - use safeLogClick, never throws
      strip.querySelectorAll('a[data-link-type]').forEach(a => {
        a.addEventListener('click', () => {
          const linkType = a.dataset.linkType;
          NU.safeLogClick({
            eventId,
            linkType,
            surface: 'display',
            sessionId: getSessionId?.() || '',
            visibleSponsorIds: currentRenderedSponsorIds
          });
        });
      });
    }

    /**
     * Render lifecycle phase indicator
     * Uses same labels as Admin/Public for consistent parity across surfaces.
     * @param {Object} lifecyclePhase - { phase: string, label: string, isLive: boolean } from bundle
     */
    function renderLifecycleIndicator(lifecyclePhase) {
      const indicator = document.getElementById('lifecycleIndicator');
      if (!indicator || !lifecyclePhase) return;

      indicator.textContent = lifecyclePhase.label;
      indicator.setAttribute('data-phase', lifecyclePhase.phase);
      indicator.hidden = false;
    }

    // Legacy: Render league info overlay for rec_league template (side column fallback)
    function renderLeagueInfo(templateId, externalData) {
      // Only show for rec_league template (legacy behavior)
      if (templateId !== 'rec_league') return;

      const ext = externalData || {};
      const links = [];

      if (ext.scheduleUrl) {
        links.push({ icon: 'üìÖ', label: 'Schedule', url: ext.scheduleUrl });
      }
      if (ext.standingsUrl) {
        links.push({ icon: 'üèÜ', label: 'Standings', url: ext.standingsUrl });
      }
      if (ext.bracketUrl) {
        links.push({ icon: 'üéØ', label: 'Bracket', url: ext.bracketUrl });
      }

      if (!links.length) return;

      const overlay = document.getElementById('leagueInfoOverlay');
      const linksEl = document.getElementById('leagueLinks');

      linksEl.innerHTML = links.map(l => `
        <a href="${esc(l.url)}" target="_blank" rel="noopener" class="league-link">
          <span class="icon">${l.icon}</span>
          <span>${esc(l.label)}</span>
        </a>
      `).join('');

      overlay.hidden = false;
    }

    // NOTE: Legacy renderSponsor* functions removed in E-003
    // All sponsor rendering now uses SponsorUtils.SponsorRenderer

    function startPublicMode() {
      const base = location.origin + location.pathname;
      const tvPublicUrl = `${base}?p=public&brand=${encodeURIComponent(brandId)}&id=${encodeURIComponent(eventId)}&tv=1`;
      loadIframe(tvPublicUrl);
      showToast('TV: Public mode (mirroring event page)');
    }

    function loadIframe(url, onFail) {
      fallback.hidden = true;
      stage.hidden = false;
      stage.src = url;

      // Detect iframe load errors (blocked embed, 404, etc.)
      let loaded = false;
      const checkLoad = () => {
        try {
          // If same-origin, we can check; if cross-origin with errors, this will fail
          const doc = stage.contentDocument || stage.contentWindow?.document;
          if (doc && doc.readyState === 'complete') loaded = true;
        } catch (_) {
          // Cross-origin, assume it's loading unless we timeout
        }
      };

      stage.onload = () => { loaded = true; checkLoad(); };
      stage.onerror = () => {
        showFallback(url);
        if (onFail) onFail();
      };

      // Fallback timeout: if not loaded in 4s, assume blocked
      setTimeout(() => {
        if (!loaded) {
          showFallback(url);
          if (onFail) onFail();
        }
      }, 4000);
    }

    function showFallback(url) {
      stage.hidden = true;
      fallback.hidden = false;
      document.getElementById('fallbackMsg').textContent = `Cannot embed: ${url.slice(0, 60)}...`;
      logEvent({ eventId, surface: 'display', metric: 'blocked_embed', value: 1 });
    }

    /**
     * S12/S13: Show error state for TV display using shared StateRenderer
     * @param {string|Object} typeOrError - Error type string ('notfound', 'nodata', 'load') or error object from safeRpc
     */
    function showDisplayError(typeOrError = 'load') {
      // Hide all content panes and stage
      stage.hidden = true;
      fallback.hidden = true;
      Object.values(paneElements).forEach(pane => {
        if (pane.el) pane.el.hidden = true;
      });

      // Create error container in the stage area
      const stageContainer = stage.parentElement;
      let existingError = document.getElementById('displayError');
      if (existingError) existingError.remove();

      const errorDiv = document.createElement('div');
      errorDiv.id = 'displayError';

      const onRetry = () => location.reload();

      // S13: Handle error objects from safeRpc (has code/message properties)
      if (typeOrError && typeof typeOrError === 'object' && typeOrError.code) {
        // Use showFromError which handles SERVICE_UNAVAILABLE, TIMEOUT, etc.
        SharedUtils.StateRenderer.showFromError(errorDiv, typeOrError, {
          onRetry,
          tvMode: true
        });
      } else if (typeOrError === 'notfound') {
        SharedUtils.StateRenderer.showEventNotFound(errorDiv, { tvMode: true });
      } else if (typeOrError === 'nodata') {
        SharedUtils.StateRenderer.showNoData(errorDiv, { context: 'content', tvMode: true });
      } else {
        SharedUtils.StateRenderer.showError(errorDiv, {
          title: 'Unable to Load Display',
          message: 'We\'re having trouble loading the display content right now.',
          hint: 'This might be a temporary issue. Please try again.',
          onRetry,
          tvMode: true
        });
      }

      stageContainer.appendChild(errorDiv);
    }

    function startDynamicMode(urls) {
      if (!urls || !urls.length) return startPublicMode();
      let idx = -1;

      const next = () => {
        idx = (idx + 1) % urls.length;
        const it = urls[idx] || {};
        const url = String(it.url || '').trim();
        const sec = Math.max(5, Number(it.seconds || it.sec || it.duration || 10));

        if (!url) return setTimeout(next, 200);

        // Skip known restricted embeds (Instagram, etc.) silently
        const lower = url.toLowerCase();
        if (lower.includes('instagram.com') || lower.includes('tiktok.com')) {
          console.log(`Skipping restricted embed: ${url}`);
          return setTimeout(next, 500);
        }

        showToast(`TV: Dynamic ${idx + 1}/${urls.length} ¬∑ ${sec}s`);

        logEvent({ eventId, surface: 'display', metric: 'impression' });
        logEvent({ eventId, surface: 'display', metric: 'dwellSec', value: sec });

        loadIframe(url, () => {
          // If blocked, skip to next after 2s (no error display, just skip)
          setTimeout(next, 2000);
        });

        clearTimeout(startDynamicMode._t);
        startDynamicMode._t = setTimeout(next, sec * 1000);
      };
      next();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // V2 ROTATION ENGINE - Multi-Pane Display
    // Schema: settings.displayRotation in /schemas/event.schema.json
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Rotation engine state
    let rotationState = {
      panes: [],
      currentIndex: -1,
      paused: false,
      timer: null,
      eventData: null
    };

    // Pane element references
    const paneElements = {
      public: { el: null, titleEl: null },  // Uses stage iframe
      schedule: { el: document.getElementById('paneSchedule'), titleEl: document.getElementById('schedulePaneTitle') },
      standings: { el: document.getElementById('paneStandings'), titleEl: document.getElementById('standingsPaneTitle') },
      sponsors: { el: document.getElementById('paneSponsors'), titleEl: document.getElementById('sponsorsPaneTitle') },
      custom: { el: document.getElementById('paneCustom'), titleEl: document.getElementById('customPaneTitle') }
    };
    const rotationIndicator = document.getElementById('rotationIndicator');

    /**
     * Render schedule pane content
     * @param {Array} schedule - Event schedule array from bundle.event.schedule
     */
    function renderSchedulePane(schedule) {
      const container = document.getElementById('scheduleContent');
      if (!schedule || !schedule.length) {
        container.innerHTML = '<div class="schedule-empty">üìÖ No schedule available yet.<br><span style="font-size:0.8em;opacity:0.7;">The event schedule will appear here once it\'s been added.</span></div>';
        return;
      }

      container.innerHTML = schedule.map(item => `
        <div class="schedule-item">
          <div class="schedule-time">${esc(item.time || '')}</div>
          <div class="schedule-content">
            <h3>${esc(item.title || '')}</h3>
            ${item.description ? `<p>${esc(item.description)}</p>` : ''}
          </div>
        </div>
      `).join('');
    }

    /**
     * Render standings pane content
     * @param {Array} standings - Event standings array from bundle.event.standings
     */
    function renderStandingsPane(standings) {
      const container = document.getElementById('standingsContent');
      if (!standings || !standings.length) {
        container.innerHTML = '<div class="standings-empty">üèÜ No standings available yet.<br><span style="font-size:0.8em;opacity:0.7;">Team rankings will appear here once games have been played.</span></div>';
        return;
      }

      container.innerHTML = `
        <table class="standings-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Team</th>
              <th>W</th>
              <th>L</th>
              ${standings[0].points !== undefined ? '<th>Pts</th>' : ''}
            </tr>
          </thead>
          <tbody>
            ${standings.map(row => `
              <tr>
                <td class="standings-rank ${row.rank <= 3 ? 'top-3' : ''}">${row.rank}</td>
                <td class="standings-team">${esc(row.team || '')}</td>
                <td>${row.wins}</td>
                <td>${row.losses}</td>
                ${row.points !== undefined ? `<td>${row.points}</td>` : ''}
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    /**
     * Render sponsors carousel pane content
     * @param {Array} sponsors - Event sponsors array from bundle.event.sponsors
     */
    function renderSponsorsCarouselPane(sponsors) {
      const container = document.getElementById('sponsorsCarouselContent');
      // Filter for display/tv-banner placements
      const displaySponsors = (sponsors || []).filter(s =>
        s.placement === 'display' || s.placement === 'tv-banner'
      );

      if (!displaySponsors.length) {
        container.innerHTML = '<div class="sponsors-empty">ü§ù No sponsors to display yet.<br><span style="font-size:0.8em;opacity:0.7;">Sponsor logos will appear here once they\'ve been added.</span></div>';
        return;
      }

      container.innerHTML = displaySponsors.map(s => {
        const isPrimary = s.tier === 'primary' || s.tier === 'gold' || s.tier === 'title';
        return `
          <a href="${esc(s.linkUrl || '#')}" target="_blank" rel="noopener" class="sponsor-carousel-item ${isPrimary ? 'primary' : ''}" data-sponsor-id="${esc(s.id)}">
            ${s.logoUrl ? `<img src="${esc(s.logoUrl)}" alt="${esc(s.name)}" onerror="this.style.display='none'">` : ''}
            <span class="sponsor-name">${esc(s.name)}</span>
          </a>
        `;
      }).join('');

      // Track sponsor impressions
      const sponsorIds = displaySponsors.map(s => s.id);
      currentRenderedSponsorIds = [...new Set([...currentRenderedSponsorIds, ...sponsorIds])];

      // Log impressions for carousel sponsors
      sponsorIds.forEach(id => {
        logEvent({ eventId, surface: 'display', metric: 'sponsor_impression', value: 1, sponsorId: id });
      });
    }

    /**
     * Build rotation indicator dots
     * @param {Array} panes - Array of pane configurations
     */
    function buildRotationIndicator(panes) {
      if (!panes || panes.length <= 1) {
        rotationIndicator.hidden = true;
        return;
      }

      rotationIndicator.innerHTML = panes.map((p, i) => `
        <div class="rotation-dot ${i === 0 ? 'active' : ''}" data-index="${i}" title="${p.type}"></div>
      `).join('');
      rotationIndicator.hidden = false;
    }

    /**
     * Update rotation indicator to show current pane
     * @param {number} index - Current pane index
     */
    function updateRotationIndicator(index) {
      const dots = rotationIndicator.querySelectorAll('.rotation-dot');
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
      });
    }

    /**
     * Show a specific pane by type
     * @param {string} type - Pane type: public, schedule, standings, sponsors, custom
     * @param {object} paneConfig - Pane configuration with title, url, etc.
     */
    function showPane(type, paneConfig) {
      // Hide all panes first
      Object.entries(paneElements).forEach(([paneType, pane]) => {
        if (paneType === 'public') {
          // Public pane uses the stage iframe
          stage.classList.remove('active');
          stage.classList.add('fade-out');
        } else if (pane.el) {
          pane.el.classList.remove('active');
          pane.el.classList.add('fade-out');
          pane.el.hidden = true;
        }
      });

      // Show the requested pane after brief delay for fade effect
      setTimeout(() => {
        if (type === 'public') {
          // Public mode: show the iframe
          stage.hidden = false;
          stage.classList.remove('fade-out');
          stage.classList.add('active');
          fallback.hidden = true;

          // Ensure iframe has the public URL
          const base = location.origin + location.pathname;
          const tvPublicUrl = `${base}?p=public&brand=${encodeURIComponent(brandId)}&id=${encodeURIComponent(eventId)}&tv=1`;
          if (stage.src !== tvPublicUrl) {
            stage.src = tvPublicUrl;
          }
        } else if (type === 'custom' && paneConfig?.url) {
          // Custom URL pane
          const pane = paneElements.custom;
          const customFrame = document.getElementById('customFrame');
          customFrame.src = paneConfig.url;
          pane.el.hidden = false;
          pane.el.classList.remove('fade-out');
          pane.el.classList.add('active');

          // Show title if provided
          if (paneConfig.title && pane.titleEl) {
            pane.titleEl.querySelector('h2').textContent = paneConfig.title;
            pane.titleEl.hidden = false;
          }
        } else if (paneElements[type]?.el) {
          // Content panes (schedule, standings, sponsors)
          const pane = paneElements[type];
          pane.el.hidden = false;
          pane.el.classList.remove('fade-out');
          pane.el.classList.add('active');

          // Hide the stage iframe for content panes
          stage.hidden = true;

          // Show title if provided
          if (paneConfig?.title && pane.titleEl) {
            pane.titleEl.querySelector('h2').textContent = paneConfig.title;
            pane.titleEl.hidden = false;
          } else if (pane.titleEl) {
            pane.titleEl.hidden = true;
          }
        }
      }, 100);

      // Log pane view
      logEvent({ eventId, surface: 'display', metric: 'pane_view', value: 1, paneType: type });
    }

    /**
     * Start the rotation engine
     * @param {object} displayRotation - Rotation config from bundle.displayRotation
     * @param {object} eventData - Full event data for rendering panes
     */
    function startRotationEngine(displayRotation, eventData) {
      if (!displayRotation?.enabled || !displayRotation?.panes?.length) {
        console.log('Rotation engine: Disabled or no panes, using public mode');
        return false;
      }

      // Store event data for pane rendering
      rotationState.eventData = eventData;
      rotationState.panes = displayRotation.panes;
      rotationState.currentIndex = -1;

      // Pre-render content panes
      renderSchedulePane(eventData.schedule);
      renderStandingsPane(eventData.standings);
      renderSponsorsCarouselPane(eventData.sponsors);

      // Build rotation indicator
      buildRotationIndicator(displayRotation.panes);

      // Start rotation
      const rotateTo = (index) => {
        rotationState.currentIndex = index;
        const pane = rotationState.panes[index];
        if (!pane) return;

        // Get dwell time: pane-specific > displayRotation default > 15s
        const dwellMs = pane.dwellMs || displayRotation.defaultDwellMs || 15000;

        showPane(pane.type, pane);
        updateRotationIndicator(index);

        // Show toast with pane info (subtle)
        const paneLabel = displayRotation.paneTypes?.[pane.type]?.label || pane.type;
        showToast(`${paneLabel} ¬∑ ${Math.round(dwellMs / 1000)}s`, 1500);

        // Schedule next rotation
        clearTimeout(rotationState.timer);
        if (!rotationState.paused) {
          rotationState.timer = setTimeout(() => {
            const nextIndex = (index + 1) % rotationState.panes.length;
            rotateTo(nextIndex);
          }, dwellMs);
        }
      };

      // Start with first pane
      rotateTo(0);

      console.log(`Rotation engine: Started with ${rotationState.panes.length} panes`);
      return true;
    }

    /**
     * Pause/resume rotation
     */
    function toggleRotationPause() {
      rotationState.paused = !rotationState.paused;
      if (rotationState.paused) {
        clearTimeout(rotationState.timer);
        showToast('Rotation paused', 2000);
      } else {
        // Resume by moving to next pane
        const nextIndex = (rotationState.currentIndex + 1) % rotationState.panes.length;
        const pane = rotationState.panes[rotationState.currentIndex];
        const dwellMs = pane?.dwellMs || 15000;
        rotationState.timer = setTimeout(() => {
          startRotationEngine({ enabled: true, panes: rotationState.panes }, rotationState.eventData);
        }, dwellMs);
        showToast('Rotation resumed', 2000);
      }
    }

    // Keyboard controls for rotation (arrow keys, space to pause)
    document.addEventListener('keydown', (e) => {
      if (!rotationState.panes.length) return;

      if (e.key === ' ' || e.key === 'Spacebar') {
        e.preventDefault();
        toggleRotationPause();
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        clearTimeout(rotationState.timer);
        const nextIndex = (rotationState.currentIndex + 1) % rotationState.panes.length;
        showPane(rotationState.panes[nextIndex].type, rotationState.panes[nextIndex]);
        updateRotationIndicator(nextIndex);
        rotationState.currentIndex = nextIndex;
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        clearTimeout(rotationState.timer);
        const prevIndex = rotationState.currentIndex === 0
          ? rotationState.panes.length - 1
          : rotationState.currentIndex - 1;
        showPane(rotationState.panes[prevIndex].type, rotationState.panes[prevIndex]);
        updateRotationIndicator(prevIndex);
        rotationState.currentIndex = prevIndex;
      }
    });

    /**
     * Boot Display.html
     * API: api_getDisplayBundle ‚Üí { event, rotation, layout, displayRotation }
     * SCHEMA: /schemas/event.schema.json
     */
    async function boot() {
      if (!eventId) {
        // No event ID in URL - show friendly error instead of blank screen
        showDisplayError('notfound');
        return;
      }

      // S13: Use safeRpc for graceful error handling
      const res = await NU.safeRpc('api_getDisplayBundle', { brandId, scope: 'events', id: eventId });

      // S13: Handle API errors - pass error object to showDisplayError
      if (!res?.ok) {
        console.error('Display API error:', res.code, res.message);
        // Pass the error object to showDisplayError for proper classification
        showDisplayError(res);
        return;
      }

      if (!res?.value || !res?.value?.event) {
        showDisplayError('nodata');
        return;
      }

      const bundle = res.value;
      const ev = bundle.event || {};
      const rotation = bundle.rotation || {};
      const layout = bundle.layout || {};
      const displayRotation = bundle.displayRotation || {};
      const lifecyclePhase = bundle.lifecyclePhase || null;

      // === LOG DISPLAY VIEW METRIC ===
      logEvent({ eventId: ev.id, surface: 'display', metric: 'view', value: 1 });

      // === RENDER LIFECYCLE PHASE INDICATOR ===
      // Uses same labels as Admin/Public for consistent parity across surfaces
      if (lifecyclePhase) {
        renderLifecycleIndicator(lifecyclePhase);
      }

      // === CONTRACT FIELDS (MVP REQUIRED) ===
      const settings = ev.settings || { showSchedule: false, showStandings: false, showBracket: false, showSponsors: false };

      // === CONTRACT FIELDS (V2 OPTIONAL) ===
      const sponsors = ev.sponsors || [];
      const externalData = ev.externalData || {};

      // === RENDER LEAGUE & BROADCAST STRIP ===
      // Uses event.externalData (V2 Optional per /schemas/event.schema.json)
      // Schema fields: scheduleUrl, standingsUrl, bracketUrl
      // Feature 4: Respect showLeagueStrip toggle
      if ((settings.showLeagueStrip !== false) &&
          (externalData.scheduleUrl || externalData.standingsUrl || externalData.bracketUrl)) {
        renderLeagueBroadcast(ev.templateId || '', externalData);
      }

      // === SPONSOR STRIP (V2 Optional) ===
      // Schema: event.sponsors[].placement MUST be 'display' or 'tv-banner' - no fallback
      // Feature 4: Respect showSponsorStrip toggle
      // Note: In rotation mode, sponsor strip is optional (sponsors shown in carousel pane)
      if (settings.showSponsors && (settings.showSponsorStrip !== false) && sponsors.length > 0) {
        // Use centralized SponsorRenderer with placement filter (E-003 centralization)
        const { SponsorRenderer } = window.SponsorUtils;
        const displayPlacements = ['display', 'tv-banner'];  // Accept either placement
        const renderedSponsors = SponsorRenderer.renderStrip({
          container: topEl,
          sponsors: sponsors,
          placement: displayPlacements,  // Filter to display/tv-banner placements
          eventId: ev.id,
          surface: 'display',
          showTier: true,
          onRender: ids => { currentRenderedSponsorIds = [...new Set([...currentRenderedSponsorIds, ...ids])]; }
        });
        // Use layout.hasSidePane from DisplayBundle to show side panel
        if (renderedSponsors.length > 0 && layout.hasSidePane) {
          SponsorRenderer.renderGrid({
            container: sideEl,
            sponsors: sponsors,
            placement: displayPlacements,  // Same filter for side panel
            eventId: ev.id,
            surface: 'display',
            mainEl: mainEl,
            onRender: ids => { currentRenderedSponsorIds = [...new Set([...currentRenderedSponsorIds, ...ids])]; }
          });
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // V2: ROTATION ENGINE - Multi-Pane Display Mode
      // Schema: settings.displayRotation in /schemas/event.schema.json
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // Check URL param to force rotation mode: ?rotate=1
      const forceRotate = qs.get('rotate') === '1' || qs.get('rotation') === '1';

      // Try to start rotation engine
      // Rotation is enabled if: explicitly enabled on event, OR forced via URL param
      const rotationEnabled = displayRotation.enabled || forceRotate;

      if (rotationEnabled && displayRotation.panes?.length > 0) {
        const started = startRotationEngine(
          { ...displayRotation, enabled: true },
          ev
        );
        if (started) {
          console.log('Display: Rotation engine active');
          return; // Rotation engine handles display
        }
      }

      // === FALLBACK: PUBLIC MODE ===
      // Default display mode (embed Public.html via iframe)
      startPublicMode();
    }

    boot();
  </script>
</body>
</html>
