<!--
================================================================================
MVP SURFACE - Focus Group Critical
================================================================================
Page: SharedReport.html
Purpose: Shareable analytics dashboard for stakeholders and sponsors
Status: LOCKED for MVP v1.0

SCHEMA CONTRACT: /schemas/shared-analytics.schema.json (v1.1 frozen)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
READS FROM SHAREDANALYTICS SCHEMA (via api_getSharedAnalytics):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  Root (MVP Required):
    - lastUpdatedISO           ‚Üí Last updated timestamp display
    - summary                  ‚Üí Key metrics cards
    - surfaces[]               ‚Üí Surface performance table

  Root (MVP Optional):
    - sponsors[]               ‚Üí Sponsor performance table
    - events[]                 ‚Üí Event performance table (if present)
    - topSponsors[]            ‚Üí Top Sponsors highlight card

  Summary Fields (MVP Required):
    - summary.totalImpressions ‚Üí "Total Impressions" metric card
    - summary.totalClicks      ‚Üí "Total Clicks" metric card
    - summary.totalQrScans     ‚Üí "QR Scans" metric card
    - summary.totalSignups     ‚Üí "Signups" metric card
    - summary.uniqueEvents     ‚Üí "Active Events" metric card
    - summary.uniqueSponsors   ‚Üí "Active Sponsors" metric card

  SurfaceMetrics[] (MVP Required):
    - surface.id               ‚Üí Surface identifier
    - surface.label            ‚Üí Display name
    - surface.impressions      ‚Üí Table column
    - surface.clicks           ‚Üí Table column
    - surface.qrScans          ‚Üí Table column
    - surface.engagementRate   ‚Üí Badge (derived if missing)

  SponsorMetrics[] (MVP Optional):
    - sponsor.id               ‚Üí Row key
    - sponsor.name             ‚Üí Display name
    - sponsor.impressions      ‚Üí Table column
    - sponsor.clicks           ‚Üí Table column
    - sponsor.ctr              ‚Üí CTR badge

  EventMetrics[] (MVP Optional):
    - event.id                 ‚Üí Row key
    - event.name               ‚Üí Display name + rank badge
    - event.impressions        ‚Üí Table column + Top callout
    - event.clicks             ‚Üí Table column
    - event.signupsCount       ‚Üí Signups column (from Form/Sheet)
    - event.ctr                ‚Üí CTR badge + Top callout

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SECTION GATES (schema-backed visibility):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  Metrics Grid:       Always shown (summary is required)
  Surface Table:      Always shown (surfaces[] is required)
  Sponsor Table:      if (sponsors?.length) ‚Üí renderSponsorPerformance()
  Event Table:        if (events?.length) ‚Üí renderEventPerformance()
  Top Callouts:       if (events?.length || sponsors?.length) ‚Üí renderTopCallouts()
  Top Sponsors Card:  if (topSponsors?.length) ‚Üí renderTopSponsorsCard()

  NO freelancing: JS only accesses fields defined in shared-analytics.schema.json

API ENDPOINTS:
  - api_getSharedAnalytics({ brandId }) ‚Üí SharedAnalytics
  - api_getSponsorAnalytics({ brandId, sponsorId }) ‚Üí SharedAnalytics (scoped)

DO NOT modify contracts without updating:
  - /schemas/shared-analytics.schema.json (source of truth)
  - NUSDK.html (API client)
================================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> ¬∑ Shared Analytics</title>
  <?!= include('Header'); ?>
  <?!= include('HeaderInit'); ?>
  <?!= include('NUSDK'); ?>
  <?!= include('DesignTokens'); ?>
  <?!= include('Styles'); ?>
  <?!= include('FooterComponent'); ?>
  <?!= include('SpinnerComponent'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="referrer" content="no-referrer"/>
  <style>
    /* SharedReport-specific styles (extends Styles.html) */

    /* Report Header - uses page-header-card pattern with gradient */
    .report-header {
      background: linear-gradient(135deg, var(--color-primary, #2563eb) 0%, var(--color-primary-dark, #1d4ed8) 100%);
      color: white;
      padding: 2rem;
      border-radius: var(--radius-md, 12px);
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-md, 0 4px 6px rgba(0, 0, 0, 0.1));
    }

    .report-header h1 {
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .report-header .subtitle {
      opacity: 0.9;
      font-size: var(--font-size-sm, 0.875rem); /* D-AUDIT: Using design token */
    }

    /* Override metrics-grid for 6-column layout (3x2) on desktop */
    @media (min-width: 1024px) {
      .metrics-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Section card extends .card from Styles.html */
    .section-card {
      background: white;
      border-radius: var(--radius-md, 12px);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-base, 0 1px 3px rgba(0,0,0,0.1));
      border: 1px solid var(--color-gray-200, #e2e8f0);
      border-left: 4px solid var(--color-primary, #2563eb);
    }

    .section-card h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      color: var(--color-gray-800, #1e293b);
      font-weight: 600;
    }

    /* Data Table - extends base table styles */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-size-sm, 0.875rem); /* D-AUDIT: Using design token */
    }

    .data-table thead {
      background: var(--color-gray-100, #f1f5f9);
    }

    .data-table th {
      padding: 0.75rem 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--color-gray-600, #475569);
      font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--color-gray-200, #e2e8f0);
    }

    .data-table td {
      padding: 1rem;
      border-bottom: 1px solid var(--color-gray-100, #f1f5f9);
    }

    .data-table tbody tr:hover {
      background: var(--color-gray-50, #f8fafc);
    }

    /* Mobile: Stack table */
    @media (max-width: 640px) {
      .data-table thead { display: none; }
      .data-table, .data-table tbody, .data-table tr, .data-table td {
        display: block;
        width: 100%;
      }
      .data-table tr {
        margin-bottom: 1rem;
        background: white;
        border: 1px solid var(--color-gray-200, #e2e8f0);
        border-radius: var(--radius-base, 8px);
        padding: 0.75rem;
      }
      .data-table td {
        padding: 0.5rem 0;
        border: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .data-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--color-gray-500, #64748b);
        text-transform: uppercase;
        font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      }
    }

    /* Badges - compact variants */
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-full, 9999px);
      font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge.high { background: var(--color-danger-pale, #fef2f2); color: var(--color-danger, #dc2626); }
    .badge.medium, .badge.warning { background: var(--color-warning-pale, #fef3c7); color: var(--color-warning-dark, #d97706); }
    .badge.success { background: var(--color-success-pale, #d1fae5); color: var(--color-success, #10b981); }
    .badge.info { background: var(--color-primary-pale, #dbeafe); color: var(--color-primary, #2563eb); }

    /* Chart Placeholder */
    .chart-container {
      height: 300px;
      background: var(--color-gray-50, #f8fafc);
      border: 2px dashed var(--color-gray-300, #cbd5e1);
      border-radius: var(--radius-base, 8px);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-gray-400, #94a3b8);
      font-size: var(--font-size-sm, 0.875rem); /* D-AUDIT: Using design token */
    }

    /* Action Bar */
    .action-bar {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    /* Recommendations - alert-style cards */
    .recommendation {
      padding: 1rem;
      border-radius: var(--radius-base, 8px);
      margin-bottom: 0.75rem;
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }

    .recommendation.high { background: #fef2f2; border-left: 4px solid var(--color-danger, #dc2626); }
    .recommendation.medium { background: #fef3c7; border-left: 4px solid var(--color-warning, #f59e0b); }
    .recommendation.success { background: #ecfdf5; border-left: 4px solid var(--color-success, #10b981); }
    .recommendation.info { background: #eff6ff; border-left: 4px solid var(--color-primary, #2563eb); }

    .recommendation-icon { font-size: var(--font-size-2xl, 1.5rem); } /* D-AUDIT: Using design token */
    .recommendation-content { flex: 1; }
    .recommendation-content .title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      letter-spacing: 0.05em;
    }

    /* Loading state - uses .loading-state from Styles.html but custom spinner */
    .loading {
      text-align: center;
      padding: 3rem 1rem;
    }

    /* Metrics grid override for this page */
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    @media (min-width: 640px) {
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (min-width: 1024px) {
      .metrics-grid { grid-template-columns: repeat(3, 1fr); }
    }

    /* Metric card overrides for SharedReport */
    .metrics-grid .metric-card .label {
      font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      color: var(--color-gray-500, #64748b);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .metrics-grid .metric-card .value {
      font-size: var(--font-size-4xl, 2.25rem); /* D-AUDIT: Aligned to type scale from 2rem */
      font-weight: 700;
      color: var(--color-gray-900, #0f172a);
      margin-bottom: 0.25rem;
    }

    .metrics-grid .metric-card .trend {
      font-size: var(--font-size-sm, 0.875rem); /* D-AUDIT: Using design token */
      color: var(--color-success, #10b981);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .metrics-grid .metric-card .trend.negative {
      color: var(--color-danger, #ef4444);
    }

    /* === MVP Essential: Empty/Error States === */
    .empty-state, .error-state {
      text-align: center;
      padding: 48px 24px;
      max-width: 500px;
      margin: 40px auto;
    }
    .empty-state-icon, .error-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.6;
    }
    .empty-state h3, .error-state h3 {
      color: var(--color-gray-700, #374151);
      margin-bottom: 8px;
      font-size: 1.25rem;
    }
    .empty-state p, .error-state p {
      color: var(--color-gray-500, #6b7280);
      margin-bottom: 16px;
      line-height: 1.6;
    }
    .error-state {
      background: #fef2f2;
      border-radius: var(--radius-md, 12px);
      border: 1px solid #fecaca;
    }
    .error-state h3 { color: #dc2626; }
    .error-state p { color: #b91c1c; }
    /* .btn-retry - Now centralized in Styles.html (C-001) */
    /* .site-footer - Now centralized in FooterComponent.html (D-005) */

    /* Feature 5: Top Event / Top Sponsor Callout Cards */
    .top-callout {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
      border-radius: var(--radius-md, 12px);
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
    }
    .top-callout.event {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }
    .top-callout .callout-icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }
    .top-callout .callout-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #92400e;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .top-callout.event .callout-label {
      color: #1e40af;
    }
    .top-callout .callout-name {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }
    .top-callout .callout-stats {
      display: flex;
      justify-content: center;
      gap: 16px;
      font-size: 0.875rem;
      color: #64748b;
    }
    .top-callout .callout-stats strong {
      color: #1e293b;
    }
    @media (max-width: 640px) {
      #topCallouts { grid-template-columns: 1fr !important; }
    }

    /* Top Sponsors Card - Highlights top performers by clicks */
    .top-sponsors-card {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border: 2px solid var(--color-success, #10b981);
      border-radius: var(--radius-md, 12px);
      padding: 20px;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
    }
    .top-sponsors-card h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #065f46;
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .top-sponsors-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .top-sponsor-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      border-radius: var(--radius-base, 8px);
      padding: 12px 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }
    .top-sponsor-rank {
      font-size: 1.25rem;
      margin-right: 12px;
    }
    .top-sponsor-name {
      flex: 1;
      font-weight: 600;
      color: var(--color-gray-800, #1e293b);
    }
    .top-sponsor-metric {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: var(--font-size-sm, 0.875rem);
      color: var(--color-gray-600, #475569);
    }
    .top-sponsor-metric .clicks-value {
      font-weight: 700;
      color: var(--color-success, #10b981);
    }
    .top-sponsor-metric .ctr-badge {
      background: var(--color-success-pale, #d1fae5);
      color: #065f46;
      padding: 2px 8px;
      border-radius: var(--radius-full, 9999px);
      font-size: var(--font-size-xs, 0.75rem);
      font-weight: 600;
    }
    @media (max-width: 640px) {
      .top-sponsor-item {
        flex-wrap: wrap;
        gap: 8px;
      }
      .top-sponsor-metric {
        width: 100%;
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="report-header">
      <h1 id="reportTitle">üìä Shared Event-Sponsor Analytics</h1>
      <p class="subtitle" id="reportSubtitle">Single source of truth for Event Managers & Sponsors</p>
      <p class="subtitle" id="lastUpdated">Loading...</p>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <button id="refreshBtn" class="btn btn-primary" onclick="loadReport()">
        <span class="btn-text">üîÑ Refresh Data</span>
      </button>
      <!-- V2 FEATURE ‚Äì NOT MVP: Export to Sheets (requires backend export matrix implementation) -->
      <button id="exportBtn" class="btn btn-secondary" onclick="exportReport()" style="display:none;">
        <span class="btn-text">üìä Export to Sheets</span>
      </button>
      <!-- V2 FEATURE ‚Äì NOT MVP: Filter by date range, sponsor, event (requires backend filter support) -->
      <button id="filterBtn" class="btn btn-secondary" onclick="showFilters()" style="display:none;">
        <span class="btn-text">üîç Filter</span>
      </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Loading analytics data...</p>
    </div>

    <!-- Key Metrics -->
    <div id="metrics" style="display:none;">
      <div class="metrics-grid" id="metricsGrid"></div>

      <!-- Top Sponsors Card - Highlights top 3 sponsors by clicks -->
      <div id="topSponsorsCard" style="display:none;"></div>

      <!-- Feature 5: Top Event / Top Sponsor Callouts -->
      <div id="topCallouts" class="metrics-grid" style="grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;"></div>

      <!-- Surface Performance -->
      <div class="section-card">
        <h2>üåê Performance by Surface</h2>
        <div id="surfacePerformance"></div>
      </div>

      <!-- Sponsor Performance -->
      <div class="section-card">
        <h2>üè¢ Sponsor Performance</h2>
        <div id="sponsorPerformance"></div>
      </div>

      <!-- Event Performance -->
      <div class="section-card" id="eventPerformanceCard" style="display:none;">
        <h2>üéâ Event Performance</h2>
        <div id="eventPerformance"></div>
      </div>

      <!-- V2 HIDDEN: ROI, Daily Trends, Recommendations require backend work -->
      <!-- Sections removed to keep MVP honest -->
    </div>

    <!-- Error State (hidden by default) -->
    <div id="errorState" style="display:none;">
      <div class="error-state">
        <div class="error-state-icon">‚ö†Ô∏è</div>
        <h3>Trouble Loading Analytics</h3>
        <p id="errorMessage">We couldn't load the report data. Please try again.</p>
        <button class="btn-retry" onclick="loadReport()">üîÑ Try Again</button>
      </div>
    </div>
  </div>

  <!-- Trust Footer -->
  <footer class="site-footer">
    <p>Powered by <a href="https://eventangle.com" target="_blank" rel="noopener">EventAngle</a></p>
  </footer>

  <script>
    const BRAND_ID = '<?= brandId ?>';

    // URL parameters control whether this is a sponsor-scoped view
    const urlParams = new URLSearchParams(window.location.search);
    const IS_SPONSOR_VIEW = urlParams.get('sponsor') === 'true';
    const SPONSOR_ID = urlParams.get('sponsorId') || '';
    const EVENT_ID = urlParams.get('eventId') || '';

    // Update header for sponsor view
    function updateHeaderForSponsorView(sponsorName) {
      if (!IS_SPONSOR_VIEW) return;

      const titleEl = document.getElementById('reportTitle');
      const subtitleEl = document.getElementById('reportSubtitle');

      if (titleEl) {
        titleEl.textContent = 'üìä Sponsor Report';
      }
      if (subtitleEl) {
        // Clear existing content safely
        subtitleEl.textContent = '';
        if (sponsorName) {
          // Build DOM safely to avoid XSS - don't use innerHTML with user data
          subtitleEl.appendChild(document.createTextNode('Performance metrics for '));
          const strong = document.createElement('strong');
          strong.textContent = sponsorName;
          subtitleEl.appendChild(strong);
        } else if (SPONSOR_ID) {
          subtitleEl.textContent = 'Performance metrics for ' + SPONSOR_ID;
        } else {
          subtitleEl.textContent = 'Your sponsor performance metrics';
        }
      }
    }

    // Initialize header on page load if sponsor view
    if (IS_SPONSOR_VIEW) {
      updateHeaderForSponsorView(null);
    }

    /**
     * Expected API contract (envelope omitted):
     *
     * Shared report (organizer):
     * {
     *   lastUpdatedISO: string,
     *   summary: {
     *     totalImpressions: number,
     *     totalClicks: number,
     *     totalQrScans: number,
     *     totalSignups: number,
     *     uniqueEvents: number,
     *     uniqueSponsors: number
     *   },
     *   surfaces: [
     *     { id, label, impressions, clicks, qrScans, engagementRate }
     *   ],
     *   sponsors?: [
     *     { id, name, impressions, clicks, ctr }
     *   ],
     *   events?: [
     *     { id, name, impressions, clicks, ctr, signupsCount }
     *   ]
     * }
     *
     * Sponsor view:
     * - Same shape, but summary/surfaces are scoped to that sponsor.
     */
    async function loadReport() {
      try {
        toggleLoading(true);

        const rpcName = IS_SPONSOR_VIEW && SPONSOR_ID
          ? 'api_getSponsorAnalytics'
          : 'api_getSharedAnalytics';

        const payload = IS_SPONSOR_VIEW && SPONSOR_ID
          ? { brandId: BRAND_ID, sponsorId: SPONSOR_ID, eventId: EVENT_ID || null }
          : { brandId: BRAND_ID };

        const result = await NU.rpc(rpcName, payload);

        if (!result || !result.ok) {
          throw new Error(result && result.message || 'Failed to load analytics');
        }

        renderReport(result.value || {});
        toggleLoading(false);
      } catch (err) {
        console.error('SharedReport load error', err);
        showError(err && err.message);
      }
    }

    function toggleLoading(isLoading) {
      document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
      document.getElementById('metrics').style.display = isLoading ? 'none' : 'block';
      document.getElementById('errorState').style.display = 'none';
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('metrics').style.display = 'none';
      document.getElementById('errorMessage').textContent =
        message || 'We couldn\'t load the report data. Please try again.';
      document.getElementById('errorState').style.display = 'block';
    }

    // Feature 5: Render Top Event / Top Sponsor Callouts (by highest CTR)
    function renderTopCallouts(events, sponsors) {
      const container = document.getElementById('topCallouts');
      let html = '';

      // Top Sponsor (by CTR) - show first per spec order
      if (sponsors && sponsors.length > 0) {
        const topSponsor = sponsors.reduce((a, b) => (b.ctr || 0) > (a.ctr || 0) ? b : a);
        html += `
          <div class="top-callout">
            <div class="callout-icon">‚≠ê</div>
            <div class="callout-label">Top Sponsor</div>
            <div class="callout-name">${escapeHtml(topSponsor.name || topSponsor.id || 'Sponsor')} ‚Äî ${(topSponsor.ctr || 0).toFixed(1)}% CTR</div>
          </div>
        `;
      }

      // Top Event (by CTR)
      if (events && events.length > 0) {
        const topEvent = events.reduce((a, b) => (b.ctr || 0) > (a.ctr || 0) ? b : a);
        html += `
          <div class="top-callout event">
            <div class="callout-icon">üèÜ</div>
            <div class="callout-label">Top Event</div>
            <div class="callout-name">${escapeHtml(topEvent.name || topEvent.id || 'Event')} ‚Äî ${(topEvent.ctr || 0).toFixed(1)}% CTR</div>
          </div>
        `;
      }

      container.innerHTML = html;
      container.style.display = html ? '' : 'none';
    }

    // Render Top Sponsors Card - highlights top 3 sponsors by clicks
    function renderTopSponsorsCard(topSponsors) {
      const container = document.getElementById('topSponsorsCard');

      if (!topSponsors || !topSponsors.length) {
        container.style.display = 'none';
        return;
      }

      const rankEmojis = ['ü•á', 'ü•à', 'ü•â'];
      const items = topSponsors.slice(0, 3).map(function(sponsor, index) {
        return `
          <div class="top-sponsor-item">
            <span class="top-sponsor-rank">${rankEmojis[index] || '#' + (index + 1)}</span>
            <span class="top-sponsor-name">${escapeHtml(sponsor.name || sponsor.id || 'Sponsor')}</span>
            <span class="top-sponsor-metric">
              <span class="clicks-value">${(sponsor.clicks || 0).toLocaleString()} clicks</span>
              <span class="ctr-badge">${(sponsor.ctr || 0).toFixed(1)}% CTR</span>
            </span>
          </div>
        `;
      }).join('');

      container.innerHTML = `
        <div class="top-sponsors-card">
          <h3>üèÜ Top Sponsors</h3>
          <div class="top-sponsors-list">
            ${items}
          </div>
        </div>
      `;
      container.style.display = 'block';
    }

    function renderReport(data) {
      // Defensive defaults
      const summary = data.summary || {};
      const surfaces = Array.isArray(data.surfaces) ? data.surfaces : [];
      const sponsors = Array.isArray(data.sponsors) ? data.sponsors : [];
      const events = Array.isArray(data.events) ? data.events : [];
      const topSponsors = Array.isArray(data.topSponsors) ? data.topSponsors : [];

      // Update header with sponsor name if in sponsor view
      if (IS_SPONSOR_VIEW && sponsors.length > 0) {
        const sponsorName = sponsors[0].name || SPONSOR_ID;
        updateHeaderForSponsorView(sponsorName);
      }

      renderSummaryMetrics(summary);

      // Render Top Sponsors Card (organizer view only, appears after metrics grid)
      if (!IS_SPONSOR_VIEW) {
        renderTopSponsorsCard(topSponsors);
      }

      renderSurfacePerformance(surfaces);

      // Feature 5: Render top callouts
      renderTopCallouts(events, sponsors);

      if (IS_SPONSOR_VIEW) {
        // In sponsor mode, focus on sponsor + event breakdown
        if (sponsors.length) {
          renderSponsorPerformance(sponsors);
        }
        if (events.length) {
          document.getElementById('eventPerformanceCard').style.display = 'block';
          renderEventPerformance(events);
        }
      } else {
        // Organizer view: show sponsors + events if present
        if (sponsors.length) {
          renderSponsorPerformance(sponsors);
        }
        if (events.length) {
          document.getElementById('eventPerformanceCard').style.display = 'block';
          renderEventPerformance(events);
        }
      }

      // Last updated label
      const lastUpdated = data.lastUpdatedISO || data.lastUpdated || null;
      if (lastUpdated) {
        document.getElementById('lastUpdated').textContent =
          'Last updated: ' + new Date(lastUpdated).toLocaleString();
      } else {
        document.getElementById('lastUpdated').textContent = 'Last updated: not available';
      }
    }

    function renderSummaryMetrics(summary) {
      const grid = document.getElementById('metricsGrid');
      grid.innerHTML = '';

      const metricCards = [
        {
          label: 'Total Impressions',
          value: (summary.totalImpressions || 0).toLocaleString()
        },
        {
          label: 'Total Clicks',
          value: (summary.totalClicks || 0).toLocaleString()
        },
        {
          label: 'QR Scans',
          value: (summary.totalQrScans || 0).toLocaleString()
        },
        {
          label: 'Signups',
          value: (summary.totalSignups || 0).toLocaleString()
        },
        {
          label: 'Active Events',
          value: summary.uniqueEvents || 0
        },
        {
          label: 'Active Sponsors',
          value: summary.uniqueSponsors || 0
        }
      ];

      metricCards.forEach(metric => {
        const card = document.createElement('div');
        card.className = 'metric-card';
        card.innerHTML = `
          <div class="label">${metric.label}</div>
          <div class="value">${metric.value}</div>
        `;
        grid.appendChild(card);
      });
    }

    function renderSurfacePerformance(surfaces) {
      const container = document.getElementById('surfacePerformance');

      if (!surfaces.length) {
        container.innerHTML = '<p class="muted">No surface data available yet.</p>';
        return;
      }

      const rows = surfaces.map(surface => {
        const impressions = surface.impressions || 0;
        const clicks = surface.clicks || 0;
        const qrScans = surface.qrScans || 0;
        const rate = typeof surface.engagementRate === 'number'
          ? surface.engagementRate
          : (impressions > 0 ? (clicks + qrScans) * 100 / impressions : 0);
        const label = surface.label || surface.id || 'Unknown';

        const badgeClass =
          rate >= 5 ? 'success' :
          rate >= 2 ? 'info' : 'warning';

        return `
          <tr>
            <td data-label="Surface"><strong>${label}</strong></td>
            <td data-label="Impressions">${impressions.toLocaleString()}</td>
            <td data-label="Clicks">${clicks.toLocaleString()}</td>
            <td data-label="QR Scans">${qrScans.toLocaleString()}</td>
            <td data-label="Engagement">
              <span class="badge ${badgeClass}">${rate.toFixed(1)}%</span>
            </td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Surface</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>QR Scans</th>
              <th>Engagement Rate</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    function renderSponsorPerformance(sponsors) {
      const container = document.getElementById('sponsorPerformance');

      if (!sponsors.length) {
        container.innerHTML = '<p class="muted">No sponsor activity recorded yet.</p>';
        return;
      }

      // Show QR column only in organizer view (not sponsor view)
      const showQrColumn = !IS_SPONSOR_VIEW;

      const rows = sponsors.map((sponsor, index) => {
        const ctr = sponsor.ctr || 0;
        const badgeClass =
          ctr >= 2 ? 'success' :
          ctr >= 1 ? 'info' : 'warning';

        const qrCell = showQrColumn
          ? `<td data-label="QR" style="text-align:center;">
               <button class="btn-secondary sponsor-qr-btn" data-sponsor-id="${escapeHtml(sponsor.id || '')}" data-sponsor-name="${escapeHtml(sponsor.name || sponsor.id || 'Sponsor')}" style="padding:4px 8px;font-size:0.75rem;">Show QR</button>
             </td>`
          : '';

        return `
          <tr>
            <td data-label="Sponsor">
              <strong>${sponsor.name || sponsor.id || ('Sponsor #' + (index + 1))}</strong>
            </td>
            <td data-label="Impressions">${(sponsor.impressions || 0).toLocaleString()}</td>
            <td data-label="Clicks">${(sponsor.clicks || 0).toLocaleString()}</td>
            <td data-label="CTR">
              <span class="badge ${badgeClass}">${ctr.toFixed(2)}%</span>
            </td>
            ${qrCell}
          </tr>
        `;
      }).join('');

      const qrHeader = showQrColumn ? '<th>QR</th>' : '';

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Sponsor</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>CTR</th>
              ${qrHeader}
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;

      // Wire up QR buttons if in organizer view
      if (showQrColumn) {
        wireSponsorQrButtons(container);
      }
    }

    /**
     * Escape HTML to prevent XSS
     * @param {string} str - String to escape
     * @returns {string} Escaped string
     */
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /**
     * Wire QR button click handlers
     * @param {HTMLElement} container - Container element
     */
    function wireSponsorQrButtons(container) {
      container.querySelectorAll('.sponsor-qr-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const sponsorId = this.dataset.sponsorId;
          const sponsorName = this.dataset.sponsorName;
          if (!sponsorId) return;
          fetchAndShowSponsorQr(sponsorId, sponsorName);
        });
      });
    }

    /**
     * Fetch and display QR code for a sponsor's report
     * @param {string} sponsorId - The sponsor ID
     * @param {string} sponsorName - The sponsor name for display
     */
    async function fetchAndShowSponsorQr(sponsorId, sponsorName) {
      // Show loading modal
      showSponsorQrModal(sponsorName, null, true);

      try {
        const result = await NU.rpc('api_getSponsorReportQr', {
          sponsorId: sponsorId,
          brandId: BRAND_ID
        });

        if (!result || !result.ok) {
          showSponsorQrModal(sponsorName, null, false, result?.message || 'Failed to generate QR code');
          return;
        }

        // Respect invariant: no QR for unverified URLs
        if (!result.value.verified || !result.value.qrB64) {
          showSponsorQrModal(sponsorName, null, false, 'QR code unavailable - URL not verified');
          return;
        }

        // Show QR code
        showSponsorQrModal(sponsorName, result.value.qrB64, false, null, result.value.url);

      } catch (e) {
        console.error('Failed to fetch sponsor QR:', e);
        showSponsorQrModal(sponsorName, null, false, 'Network error - please try again');
      }
    }

    /**
     * Display modal with sponsor QR code
     * @param {string} sponsorName - Sponsor name for title
     * @param {string|null} qrB64 - Base64 encoded QR image (null if loading/error)
     * @param {boolean} loading - Show loading spinner
     * @param {string|null} error - Error message to display
     * @param {string|null} url - The URL the QR encodes (for display)
     */
    function showSponsorQrModal(sponsorName, qrB64, loading, error, url) {
      // Remove existing modal if any
      const existing = document.getElementById('sponsorQrModal');
      if (existing) existing.remove();

      let content = '';
      if (loading) {
        content = '<div style="padding:40px;text-align:center;"><span class="spinner"></span><p style="margin-top:12px;color:#64748b;">Loading QR code...</p></div>';
      } else if (error) {
        content = '<div style="padding:40px;text-align:center;color:#ef4444;"><p>' + escapeHtml(error) + '</p></div>';
      } else if (qrB64) {
        content = `
          <div style="text-align:center;padding:20px;">
            <img src="data:image/png;base64,${qrB64}" alt="Sponsor report QR" style="max-width:200px;height:auto;border:1px solid #e2e8f0;border-radius:8px;">
            <p style="margin-top:12px;font-size:0.75rem;color:#64748b;word-break:break-all;">${escapeHtml(url || '')}</p>
            <p style="margin-top:8px;font-size:0.7rem;color:#94a3b8;">Scan to view sponsor analytics</p>
          </div>
        `;
      }

      const modal = document.createElement('div');
      modal.id = 'sponsorQrModal';
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
      modal.innerHTML = `
        <div style="background:white;border-radius:12px;max-width:320px;width:90%;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);">
          <div style="padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;font-size:1rem;font-weight:600;">${escapeHtml(sponsorName)} QR</h3>
            <button onclick="closeSponsorQrModal()" style="background:none;border:none;cursor:pointer;font-size:1.25rem;color:#64748b;padding:0;line-height:1;">&times;</button>
          </div>
          ${content}
        </div>
      `;

      // Close on backdrop click
      modal.addEventListener('click', function(e) {
        if (e.target === modal) closeSponsorQrModal();
      });

      document.body.appendChild(modal);
    }

    /**
     * Close the sponsor QR modal
     */
    function closeSponsorQrModal() {
      const modal = document.getElementById('sponsorQrModal');
      if (modal) modal.remove();
    }

    function renderEventPerformance(events) {
      const container = document.getElementById('eventPerformance');

      if (!events.length) {
        container.innerHTML = '<p class="muted">No event-level analytics yet.</p>';
        return;
      }

      const rows = events.map((ev, index) => {
        const ctr = ev.ctr || 0;
        const badgeClass =
          ctr >= 2 ? 'success' :
          ctr >= 1 ? 'info' : 'warning';

        const rank =
          index === 0 ? 'ü•á' :
          index === 1 ? 'ü•à' :
          index === 2 ? 'ü•â' : '#' + (index + 1);

        const signups = ev.signupsCount || 0;

        return `
          <tr>
            <td data-label="Event">
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-size:1.1rem;">${rank}</span>
                <strong>${ev.name || ev.id}</strong>
              </div>
            </td>
            <td data-label="Impressions">${(ev.impressions || 0).toLocaleString()}</td>
            <td data-label="Clicks">${(ev.clicks || 0).toLocaleString()}</td>
            <td data-label="Signups">${signups.toLocaleString()}</td>
            <td data-label="CTR">
              <span class="badge ${badgeClass}">${ctr.toFixed(2)}%</span>
            </td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Event</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>Signups</th>
              <th>CTR</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    // V2 FEATURE ‚Äì NOT MVP: Export and Filter functions (buttons hidden in MVP)
    // These stubs remain for when V2 features are enabled
    function exportReport() {
      showComingSoon(document.getElementById('exportBtn'));
    }

    function showFilters() {
      showComingSoon(document.getElementById('filterBtn'));
    }

    function showComingSoon(btn) {
      if (!btn) return;
      const label = btn.querySelector('.btn-text');
      if (!label) return;
      const original = label.textContent;
      label.textContent = 'üöß Coming Soon';
      setTimeout(() => {
        label.textContent = original;
      }, 1500);
    }

    window.addEventListener('load', loadReport);
  </script>
</body>
</html>
