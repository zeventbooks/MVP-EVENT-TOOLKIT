<!--
================================================================================
MVP SURFACE - Focus Group Critical
================================================================================
Page: SharedReport.html
Purpose: Shareable analytics dashboard for stakeholders and sponsors
Status: LOCKED for MVP v1.0

SCHEMA CONTRACT: /schemas/shared-analytics.schema.json (v1.1 frozen)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
READS FROM SHAREDANALYTICS SCHEMA (via api_getSharedAnalytics):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  Root (MVP Required):
    - lastUpdatedISO           ‚Üí Last updated timestamp display
    - summary                  ‚Üí Key metrics cards
    - surfaces[]               ‚Üí Surface performance table

  Root (MVP Optional):
    - sponsors[]               ‚Üí Sponsor performance table
    - events[]                 ‚Üí Event performance table (if present)
    - topSponsors[]            ‚Üí Top Sponsors highlight card

  Summary Fields (MVP Required):
    - summary.totalImpressions ‚Üí "Total Impressions" metric card
    - summary.totalClicks      ‚Üí "Total Clicks" metric card
    - summary.totalQrScans     ‚Üí "QR Scans" metric card
    - summary.totalSignups     ‚Üí "Signups" metric card
    - summary.uniqueEvents     ‚Üí "Active Events" metric card
    - summary.uniqueSponsors   ‚Üí "Active Sponsors" metric card

  SurfaceMetrics[] (MVP Required):
    - surface.id               ‚Üí Surface identifier
    - surface.label            ‚Üí Display name
    - surface.impressions      ‚Üí Table column
    - surface.clicks           ‚Üí Table column
    - surface.qrScans          ‚Üí Table column
    - surface.engagementRate   ‚Üí Badge (derived if missing)

  SponsorMetrics[] (MVP Optional):
    - sponsor.id               ‚Üí Row key
    - sponsor.name             ‚Üí Display name
    - sponsor.impressions      ‚Üí Table column
    - sponsor.clicks           ‚Üí Table column
    - sponsor.ctr              ‚Üí CTR badge

  EventMetrics[] (MVP Optional):
    - event.id                 ‚Üí Row key
    - event.name               ‚Üí Display name + rank badge
    - event.impressions        ‚Üí Table column + Top callout
    - event.clicks             ‚Üí Table column
    - event.signupsCount       ‚Üí Signups column (from Form/Sheet)
    - event.ctr                ‚Üí CTR badge + Top callout

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SECTION GATES (schema-backed visibility):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  Sponsor Funnel:     Always shown (summary is required) ‚Üí renderSponsorFunnelCard()
                      Shows empty state if no data (Story 11)
  Metrics Grid:       Always shown (summary is required)
  Surface Table:      Always shown (surfaces[] is required)
  Sponsor Table:      if (sponsors?.length) ‚Üí renderSponsorPerformance()
  Event Table:        if (events?.length) ‚Üí renderEventPerformance()
  Top Callouts:       if (events?.length || sponsors?.length) ‚Üí renderTopCallouts()
  Top Sponsors Card:  if (topSponsors?.length) ‚Üí renderTopSponsorsCard()

  NO freelancing: JS only accesses fields defined in shared-analytics.schema.json

API ENDPOINTS (3 MVP canonical - Story 6):
  - api_getSharedAnalytics({ brandId }) ‚Üí SharedAnalytics
  - api_getSponsorAnalytics({ brandId, sponsorId, eventId? }) ‚Üí SharedAnalytics (scoped)
  - api_getSponsorReportQr({ sponsorId, brandId? }) ‚Üí { url, qrB64, verified }

V2-ONLY ENDPOINTS (not called by MVP surface):
  - api_getPortfolioAnalyticsV2 - Multi-event portfolio mode (hidden behind URL params)
  - api_exportSharedReport - Export feature (button display:none)

DO NOT modify contracts without updating:
  - /schemas/shared-analytics.schema.json (source of truth)
  - NUSDK.html (API client)
================================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> ¬∑ Shared Analytics</title>
  <?!= include('Header'); ?>
  <?!= include('HeaderInit'); ?>
  <?!= include('NUSDK'); ?>
  <?!= include('DesignTokens'); ?>
  <?!= include('Styles'); ?>
  <?!= include('FooterComponent'); ?>
  <?!= include('SpinnerComponent'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="referrer" content="no-referrer"/>
  <style>
    /* SharedReport-specific styles (extends Styles.html) */

    /* Report Header - uses page-header-card pattern with gradient */
    .report-header {
      background: linear-gradient(135deg, var(--color-primary, #2563eb) 0%, var(--color-primary-dark, #1d4ed8) 100%);
      color: white;
      padding: 2rem;
      border-radius: var(--radius-md, 12px);
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-md, 0 4px 6px rgba(0, 0, 0, 0.1));
    }

    .report-header h1 {
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .report-header .subtitle {
      opacity: 0.9;
      font-size: var(--font-size-sm, 0.875rem); /* D-AUDIT: Using design token */
    }

    .report-header .report-context {
      opacity: 0.85;
      font-size: var(--font-size-xs, 0.75rem);
      margin-top: 0.5rem;
      max-width: 500px;
    }

    /* Override metrics-grid for 6-column layout (3x2) on desktop */
    @media (min-width: 1024px) {
      .metrics-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Section card extends .card from Styles.html */
    .section-card {
      background: white;
      border-radius: var(--radius-md, 12px);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-base, 0 1px 3px rgba(0,0,0,0.1));
      border: 1px solid var(--color-gray-200, #e2e8f0);
      border-left: 4px solid var(--color-primary, #2563eb);
    }

    .section-card h2 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      color: var(--color-gray-800, #1e293b);
      font-weight: 600;
    }

    .section-card .section-help {
      font-size: var(--font-size-sm, 0.875rem);
      color: var(--color-gray-500, #64748b);
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    /* Data Table - extends base table styles */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-size-sm, 0.875rem); /* D-AUDIT: Using design token */
    }

    .data-table thead {
      background: var(--color-gray-100, #f1f5f9);
    }

    .data-table th {
      padding: 0.75rem 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--color-gray-600, #475569);
      font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--color-gray-200, #e2e8f0);
    }

    .data-table td {
      padding: 1rem;
      border-bottom: 1px solid var(--color-gray-100, #f1f5f9);
    }

    .data-table tbody tr:hover {
      background: var(--color-gray-50, #f8fafc);
    }

    /* Surface/Placement description in table */
    .surface-desc {
      display: block;
      font-size: var(--font-size-xs, 0.75rem);
      color: var(--color-gray-500, #64748b);
      font-weight: normal;
      margin-top: 2px;
    }

    /* Sponsor table enhancements for tablet/laptop readability */
    .data-table.sponsor-table td {
      padding: 1rem 1.25rem;
    }

    .data-table.sponsor-table th {
      padding: 0.875rem 1.25rem;
    }

    /* Tablet-specific table improvements */
    @media (min-width: 641px) and (max-width: 1024px) {
      .data-table th,
      .data-table td {
        padding: 0.875rem;
        font-size: 0.9rem;
      }

      .data-table.sponsor-table td,
      .data-table.sponsor-table th {
        padding: 1rem;
      }
    }

    /* Tooltip styles for column headers */
    .th-with-tooltip {
      position: relative;
      cursor: help;
    }

    .th-with-tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--color-gray-800, #1e293b);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: normal;
      text-transform: none;
      letter-spacing: normal;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      z-index: 10;
      pointer-events: none;
    }

    .th-with-tooltip:hover::after {
      opacity: 1;
      visibility: visible;
    }

    /* Hide tooltips on mobile (touch devices) */
    @media (max-width: 640px) {
      .th-with-tooltip::after {
        display: none;
      }
    }

    /* Mobile: Stack table */
    @media (max-width: 640px) {
      .data-table thead { display: none; }
      .data-table, .data-table tbody, .data-table tr, .data-table td {
        display: block;
        width: 100%;
      }
      .data-table tr {
        margin-bottom: 1rem;
        background: white;
        border: 1px solid var(--color-gray-200, #e2e8f0);
        border-radius: var(--radius-base, 8px);
        padding: 0.75rem;
      }
      .data-table td {
        padding: 0.5rem 0;
        border: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .data-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--color-gray-500, #64748b);
        text-transform: uppercase;
        font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      }
    }

    /* Badges - compact variants */
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-full, 9999px);
      font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge.high { background: var(--color-danger-pale, #fef2f2); color: var(--color-danger, #dc2626); }
    .badge.medium, .badge.warning { background: var(--color-warning-pale, #fef3c7); color: var(--color-warning-dark, #d97706); }
    .badge.success { background: var(--color-success-pale, #d1fae5); color: var(--color-success, #10b981); }
    .badge.info { background: var(--color-primary-pale, #dbeafe); color: var(--color-primary, #2563eb); }

    /* Chart Placeholder */
    .chart-container {
      height: 300px;
      background: var(--color-gray-50, #f8fafc);
      border: 2px dashed var(--color-gray-300, #cbd5e1);
      border-radius: var(--radius-base, 8px);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-gray-400, #94a3b8);
      font-size: var(--font-size-sm, 0.875rem); /* D-AUDIT: Using design token */
    }

    /* Action Bar */
    .action-bar {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    /* Recommendations - alert-style cards */
    .recommendation {
      padding: 1rem;
      border-radius: var(--radius-base, 8px);
      margin-bottom: 0.75rem;
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }

    .recommendation.high { background: #fef2f2; border-left: 4px solid var(--color-danger, #dc2626); }
    .recommendation.medium { background: #fef3c7; border-left: 4px solid var(--color-warning, #f59e0b); }
    .recommendation.success { background: #ecfdf5; border-left: 4px solid var(--color-success, #10b981); }
    .recommendation.info { background: #eff6ff; border-left: 4px solid var(--color-primary, #2563eb); }

    .recommendation-icon { font-size: var(--font-size-2xl, 1.5rem); } /* D-AUDIT: Using design token */
    .recommendation-content { flex: 1; }
    .recommendation-content .title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      letter-spacing: 0.05em;
    }

    /* Loading state - uses .loading-state from Styles.html but custom spinner */
    .loading {
      text-align: center;
      padding: 3rem 1rem;
    }

    /* Metrics grid override for this page */
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    @media (min-width: 640px) {
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (min-width: 1024px) {
      .metrics-grid { grid-template-columns: repeat(3, 1fr); }
    }

    /* Metric card overrides for SharedReport */
    .metrics-grid .metric-card .label {
      font-size: var(--font-size-xs, 0.75rem); /* D-AUDIT: Using design token */
      color: var(--color-gray-500, #64748b);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .metrics-grid .metric-card .value {
      font-size: var(--font-size-4xl, 2.25rem); /* D-AUDIT: Aligned to type scale from 2rem */
      font-weight: 700;
      color: var(--color-gray-900, #0f172a);
      margin-bottom: 0.25rem;
    }

    .metrics-grid .metric-card .trend {
      font-size: var(--font-size-sm, 0.875rem); /* D-AUDIT: Using design token */
      color: var(--color-success, #10b981);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .metrics-grid .metric-card .trend.negative {
      color: var(--color-danger, #ef4444);
    }

    .metrics-grid .metric-card .sublabel {
      font-size: var(--font-size-xs, 0.75rem);
      color: var(--color-gray-400, #94a3b8);
      margin-top: 0.25rem;
    }

    /* === MVP Essential: Empty/Error States === */
    .empty-state, .error-state {
      text-align: center;
      padding: 48px 24px;
      max-width: 500px;
      margin: 40px auto;
    }
    .empty-state-icon, .error-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.6;
    }
    .empty-state h3, .error-state h3 {
      color: var(--color-gray-700, #374151);
      margin-bottom: 8px;
      font-size: 1.25rem;
    }
    .empty-state p, .error-state p {
      color: var(--color-gray-500, #6b7280);
      margin-bottom: 16px;
      line-height: 1.6;
    }
    .error-state {
      background: #fef2f2;
      border-radius: var(--radius-md, 12px);
      border: 1px solid #fecaca;
    }
    .error-state h3 { color: #dc2626; }
    .error-state p { color: #b91c1c; }
    /* .btn-retry - Now centralized in Styles.html (C-001) */
    /* .site-footer - Now centralized in FooterComponent.html (D-005) */

    /* Feature 5: Top Event / Top Sponsor Callout Cards */
    .top-callout {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
      border-radius: var(--radius-md, 12px);
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
    }
    .top-callout.event {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }
    .top-callout .callout-icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }
    .top-callout .callout-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #92400e;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .top-callout.event .callout-label {
      color: #1e40af;
    }
    .top-callout .callout-name {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }
    .top-callout .callout-stats {
      display: flex;
      justify-content: center;
      gap: 16px;
      font-size: 0.875rem;
      color: #64748b;
    }
    .top-callout .callout-stats strong {
      color: #1e293b;
    }
    @media (max-width: 640px) {
      #topCallouts { grid-template-columns: 1fr !important; }
    }

    /* ===== Mobile-First SharedReport Enhancements ===== */
    @media (max-width: 640px) {
      /* Container mobile padding */
      .container {
        padding: 12px;
      }

      /* Report header mobile */
      .report-header {
        padding: 1.25rem;
        border-radius: 8px;
        margin-bottom: 1rem;
      }

      .report-header h1 {
        font-size: 1.3rem;
        line-height: 1.3;
        word-wrap: break-word;
      }

      .report-header .subtitle {
        font-size: 0.8rem;
        line-height: 1.4;
      }

      .report-header .report-context {
        font-size: 0.7rem;
        margin-top: 0.5rem;
        line-height: 1.5;
      }

      /* Action bar mobile */
      .action-bar {
        flex-direction: column;
        gap: 8px;
        margin-bottom: 1rem;
      }

      .action-bar .btn {
        width: 100%;
        justify-content: center;
        padding: 14px 16px;
        min-height: 48px;
      }

      /* Metrics grid mobile */
      .metrics-grid {
        gap: 10px;
        margin-bottom: 1rem;
      }

      .metrics-grid .metric-card {
        padding: 14px;
      }

      .metrics-grid .metric-card .label {
        font-size: 0.7rem;
      }

      .metrics-grid .metric-card .value {
        font-size: 1.75rem;
      }

      /* Section cards mobile */
      .section-card {
        padding: 14px;
        margin-bottom: 1rem;
        border-radius: 8px;
      }

      .section-card h2 {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
      }

      .section-card .section-help {
        font-size: 0.75rem;
        margin-bottom: 0.75rem;
        line-height: 1.4;
      }

      /* Metric sublabels mobile */
      .metrics-grid .metric-card .sublabel {
        font-size: 0.65rem;
      }

      /* Surface descriptions mobile */
      .surface-desc {
        font-size: 0.65rem;
        margin-top: 4px;
      }

      /* Top callouts mobile */
      .top-callout {
        padding: 14px;
        border-radius: 10px;
      }

      .top-callout .callout-icon {
        font-size: 1.5rem;
      }

      .top-callout .callout-name {
        font-size: 1rem;
      }

      .top-callout .callout-stats {
        flex-direction: column;
        gap: 6px;
        font-size: 0.8rem;
      }

      /* Top sponsors card mobile */
      .top-sponsors-card {
        padding: 14px;
        border-radius: 10px;
        margin-bottom: 1rem;
      }

      .top-sponsors-card h3 {
        font-size: 0.9rem;
        margin-bottom: 12px;
      }

      .top-sponsors-list {
        gap: 10px;
      }

      .top-sponsor-item {
        padding: 10px 12px;
        border-radius: 6px;
      }

      .top-sponsor-rank {
        font-size: 1.1rem;
        margin-right: 10px;
      }

      .top-sponsor-name {
        font-size: 0.9rem;
      }

      .top-sponsor-metric {
        font-size: 0.8rem;
      }

      /* Empty/Error states mobile */
      .empty-state, .error-state {
        padding: 32px 16px;
        margin: 24px auto;
      }

      .empty-state-icon, .error-state-icon {
        font-size: 2.5rem;
      }

      .empty-state h3, .error-state h3 {
        font-size: 1.1rem;
      }

      .error-state .btn-retry {
        width: 100%;
        padding: 14px 16px;
      }

      /* Badges mobile */
      .badge {
        padding: 0.2rem 0.5rem;
        font-size: 0.65rem;
      }

      /* Modal mobile */
      #sponsorQrModal > div {
        max-width: 90%;
        margin: 16px;
      }

      /* Footer mobile */
      .site-footer {
        padding: 16px;
        margin-top: 24px;
      }
    }

    /* Very small screens (iPhone SE, etc.) */
    @media (max-width: 375px) {
      .container {
        padding: 8px;
      }

      .report-header {
        padding: 1rem;
      }

      .report-header h1 {
        font-size: 1.15rem;
      }

      .metrics-grid .metric-card .value {
        font-size: 1.5rem;
      }

      .section-card {
        padding: 12px;
      }

      .section-card h2 {
        font-size: 1rem;
      }
    }

    /* Top Sponsors Card - Highlights top performers by clicks */
    .top-sponsors-card {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border: 2px solid var(--color-success, #10b981);
      border-radius: var(--radius-md, 12px);
      padding: 20px;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
    }
    .top-sponsors-card h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #065f46;
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .top-sponsors-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .top-sponsor-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      border-radius: var(--radius-base, 8px);
      padding: 12px 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }
    .top-sponsor-rank {
      font-size: 1.25rem;
      margin-right: 12px;
    }
    .top-sponsor-name {
      flex: 1;
      font-weight: 600;
      color: var(--color-gray-800, #1e293b);
    }
    .top-sponsor-metric {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: var(--font-size-sm, 0.875rem);
      color: var(--color-gray-600, #475569);
    }
    .top-sponsor-metric .clicks-value {
      font-weight: 700;
      color: var(--color-success, #10b981);
    }
    .top-sponsor-metric .ctr-badge {
      background: var(--color-success-pale, #d1fae5);
      color: #065f46;
      padding: 2px 8px;
      border-radius: var(--radius-full, 9999px);
      font-size: var(--font-size-xs, 0.75rem);
      font-weight: 600;
    }
    @media (max-width: 640px) {
      .top-sponsor-item {
        flex-wrap: wrap;
        gap: 8px;
      }
      .top-sponsor-metric {
        width: 100%;
        justify-content: flex-end;
      }
    }

    /* Sponsor Funnel Card - Story 11: At-a-glance funnel metrics for sponsors */
    .sponsor-funnel-card {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border: 2px solid var(--color-primary, #2563eb);
      border-radius: var(--radius-md, 12px);
      padding: 20px;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
    }
    .sponsor-funnel-card h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #1e40af;
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sponsor-funnel-card .funnel-subtitle {
      font-size: 0.75rem;
      color: #3b82f6;
      font-weight: normal;
      margin-left: auto;
    }
    .funnel-stages {
      display: flex;
      align-items: stretch;
      gap: 0;
      position: relative;
    }
    .funnel-stage {
      flex: 1;
      background: white;
      padding: 16px 12px;
      text-align: center;
      position: relative;
      border: 1px solid #e2e8f0;
      min-width: 0;
    }
    .funnel-stage:first-child {
      border-radius: 8px 0 0 8px;
    }
    .funnel-stage:last-child {
      border-radius: 0 8px 8px 0;
    }
    .funnel-stage:not(:last-child)::after {
      content: '‚Üí';
      position: absolute;
      right: -12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.25rem;
      color: #3b82f6;
      z-index: 1;
      background: white;
      width: 24px;
      text-align: center;
    }
    .funnel-stage .stage-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .funnel-stage .stage-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
      line-height: 1.2;
    }
    .funnel-stage .stage-rate {
      font-size: 0.7rem;
      color: #10b981;
      font-weight: 600;
      margin-top: 4px;
    }
    .funnel-stage .stage-rate.neutral {
      color: #64748b;
    }
    /* Funnel summary row */
    .funnel-summary {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px dashed #bfdbfe;
    }
    .funnel-summary-item {
      text-align: center;
    }
    .funnel-summary-item .summary-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
      margin-bottom: 2px;
    }
    .funnel-summary-item .summary-value {
      font-size: 1rem;
      font-weight: 700;
      color: #1e40af;
    }
    /* Funnel empty state */
    .funnel-empty-state {
      text-align: center;
      padding: 24px 16px;
      color: #64748b;
    }
    .funnel-empty-state .empty-icon {
      font-size: 2rem;
      margin-bottom: 8px;
      opacity: 0.5;
    }
    .funnel-empty-state p {
      margin: 0;
      font-size: 0.875rem;
    }
    /* Funnel card mobile responsive */
    @media (max-width: 640px) {
      .sponsor-funnel-card {
        padding: 14px;
        border-radius: 10px;
        margin-bottom: 1rem;
      }
      .sponsor-funnel-card h3 {
        font-size: 0.9rem;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
      .sponsor-funnel-card .funnel-subtitle {
        width: 100%;
        margin-left: 0;
        margin-top: 4px;
      }
      .funnel-stages {
        flex-direction: column;
        gap: 8px;
      }
      .funnel-stage {
        border-radius: 8px !important;
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-align: left;
      }
      .funnel-stage:not(:last-child)::after {
        content: '‚Üì';
        position: static;
        transform: none;
        order: -1;
        display: none;
      }
      .funnel-stage .stage-label {
        margin-bottom: 0;
        font-size: 0.75rem;
      }
      .funnel-stage .stage-value {
        font-size: 1.25rem;
      }
      .funnel-stage .stage-rate {
        margin-top: 0;
        margin-left: 8px;
        font-size: 0.75rem;
      }
      .funnel-stage .mobile-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .funnel-summary {
        flex-wrap: wrap;
        gap: 16px;
      }
      .funnel-summary-item .summary-value {
        font-size: 0.9rem;
      }
    }
    /* Very small screens */
    @media (max-width: 375px) {
      .sponsor-funnel-card {
        padding: 12px;
      }
      .funnel-stage {
        padding: 10px;
      }
      .funnel-stage .stage-value {
        font-size: 1.1rem;
      }
      .funnel-summary {
        gap: 12px;
      }
    }

    /* ===== Collapsible Detail Sections (Story 12) ===== */
    .detail-section .section-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      text-align: left;
      margin-bottom: 0.5rem;
    }
    .detail-section .section-toggle h2 {
      margin: 0;
      pointer-events: none;
    }
    .detail-section .section-toggle .toggle-icon {
      font-size: 0.75rem;
      color: var(--color-gray-400, #94a3b8);
      transition: transform 0.2s ease;
      margin-left: 8px;
    }
    .detail-section .section-toggle:hover .toggle-icon {
      color: var(--color-primary, #2563eb);
    }
    .detail-section .section-toggle:focus {
      outline: 2px solid var(--color-primary, #2563eb);
      outline-offset: 2px;
      border-radius: 4px;
    }
    /* Collapsed state */
    .detail-section.collapsed .section-content {
      display: none;
    }
    .detail-section.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }
    .detail-section.collapsed .section-help {
      display: none;
    }
    /* Expanded state - add subtle indicator */
    .detail-section:not(.collapsed) {
      border-left-color: var(--color-success, #10b981);
    }
    .detail-section:not(.collapsed) .toggle-icon {
      transform: rotate(0deg);
      color: var(--color-success, #10b981);
    }
    /* Collapsed preview hint */
    .detail-section.collapsed::after {
      content: 'Tap to show details';
      display: block;
      font-size: 0.75rem;
      color: var(--color-gray-400, #94a3b8);
      text-align: center;
      padding: 8px 0;
      font-style: italic;
    }

    /* ===== Table Scroll Wrapper for Mobile ===== */
    .table-scroll-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    /* Show scroll indicator on mobile */
    @media (max-width: 640px) {
      .table-scroll-wrapper {
        margin: 0 -14px;
        padding: 0 14px;
        width: calc(100% + 28px);
      }
      /* Restore normal table display on mobile for card-style layout */
      .table-scroll-wrapper .data-table {
        min-width: auto;
      }
    }
    /* Desktop/tablet: allow horizontal scroll if table overflows */
    @media (min-width: 641px) {
      .table-scroll-wrapper .data-table {
        min-width: 500px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="report-header">
      <h1 id="reportTitle">üìä Your Sponsorship Performance</h1>
      <p class="subtitle" id="reportSubtitle">See how your brand is performing across events</p>
      <p class="subtitle report-context" id="reportContext">Track impressions, clicks, and engagement from all your sponsored placements in one place.</p>
      <p class="subtitle" id="lastUpdated">Loading...</p>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <button id="refreshBtn" class="btn btn-primary" onclick="loadReport()">
        <span class="btn-text">üîÑ Refresh Data</span>
      </button>
      <!-- V2 FEATURE ‚Äì NOT MVP: Export to Sheets (requires backend export matrix implementation) -->
      <button id="exportBtn" class="btn btn-secondary" onclick="exportReport()" style="display:none;">
        <span class="btn-text">üìä Export to Sheets</span>
      </button>
      <!-- V2 FEATURE ‚Äì NOT MVP: Filter by date range, sponsor, event (requires backend filter support) -->
      <button id="filterBtn" class="btn btn-secondary" onclick="showFilters()" style="display:none;">
        <span class="btn-text">üîç Filter</span>
      </button>
      <!-- V2 FEATURE: Portfolio Mode Toggle (only shown for parent orgs with adminKey) -->
      <button id="portfolioToggleBtn" class="btn btn-secondary" onclick="togglePortfolioMode()" style="display:none;">
        <span class="btn-text">üìà Portfolio View</span>
      </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Loading analytics data...</p>
    </div>

    <!-- Key Metrics -->
    <div id="metrics" style="display:none;">
      <!-- Sponsor Funnel Card - Story 11: At-a-glance funnel for sponsors -->
      <div id="sponsorFunnelCard"></div>

      <div class="metrics-grid" id="metricsGrid"></div>

      <!-- Top Sponsors Card - Highlights top 3 sponsors by clicks -->
      <div id="topSponsorsCard" style="display:none;"></div>

      <!-- Feature 5: Top Event / Top Sponsor Callouts -->
      <div id="topCallouts" class="metrics-grid" style="grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;"></div>

      <!-- Surface Performance (Ad Placements) - Collapsible detail section -->
      <div class="section-card detail-section collapsed" id="surfacePerformanceCard">
        <button class="section-toggle" onclick="toggleDetailSection('surfacePerformanceCard')" aria-expanded="false">
          <h2>üåê Where you were seen</h2>
          <span class="toggle-icon">‚ñº</span>
        </button>
        <p class="section-help">See which placements drove the most engagement ‚Äî posters, screens, public pages, or signup forms.</p>
        <div class="section-content">
          <div class="table-scroll-wrapper">
            <div id="surfacePerformance"></div>
          </div>
        </div>
      </div>

      <!-- Sponsor Performance - Collapsible detail section -->
      <div class="section-card detail-section collapsed" id="sponsorPerformanceCard">
        <button class="section-toggle" onclick="toggleDetailSection('sponsorPerformanceCard')" aria-expanded="false">
          <h2>üè¢ Sponsor breakdown</h2>
          <span class="toggle-icon">‚ñº</span>
        </button>
        <p class="section-help" id="sponsorHelpText">See how each sponsor is performing. Click Rate shows what percentage of viewers clicked.</p>
        <div class="section-content">
          <div class="table-scroll-wrapper">
            <div id="sponsorPerformance"></div>
          </div>
        </div>
      </div>

      <!-- Event Performance - Collapsible detail section -->
      <div class="section-card detail-section collapsed" id="eventPerformanceCard" style="display:none;">
        <button class="section-toggle" onclick="toggleDetailSection('eventPerformanceCard')" aria-expanded="false">
          <h2>üéâ Event breakdown</h2>
          <span class="toggle-icon">‚ñº</span>
        </button>
        <p class="section-help">See which events drove the most engagement and signups.</p>
        <div class="section-content">
          <div class="table-scroll-wrapper">
            <div id="eventPerformance"></div>
          </div>
        </div>
      </div>

      <!-- V2 HIDDEN: ROI, Daily Trends, Recommendations require backend work -->
      <!-- Sections removed to keep MVP honest -->
    </div>

    <!-- Error State (hidden by default) -->
    <div id="errorState" style="display:none;">
      <div class="error-state">
        <div class="error-state-icon">‚ö†Ô∏è</div>
        <h3>Trouble Loading Analytics</h3>
        <p id="errorMessage">We couldn't load the report data. Please try again.</p>
        <button class="btn-retry" onclick="loadReport()">üîÑ Try Again</button>
      </div>
    </div>
  </div>

  <!-- Trust Footer -->
  <footer class="site-footer">
    <p>Powered by <a href="https://eventangle.com" target="_blank" rel="noopener">EventAngle</a></p>
  </footer>

  <script>
    const BRAND_ID = '<?= brandId ?>';

    // URL parameters control whether this is a sponsor-scoped view
    const urlParams = new URLSearchParams(window.location.search);
    const IS_SPONSOR_VIEW = urlParams.get('sponsor') === 'true';
    const SPONSOR_ID = urlParams.get('sponsorId') || '';
    const EVENT_ID = urlParams.get('eventId') || '';

    // V2 Portfolio Mode: 'single-brand' (default) or 'multi-event-portfolio'
    // Multi-event portfolio mode aggregates metrics across child brands
    // Only available for parent organization brands with adminKey
    const PORTFOLIO_MODE = urlParams.get('portfolioMode') || 'single-brand';
    const ADMIN_KEY = urlParams.get('adminKey') || '';
    const IS_PORTFOLIO_MODE = PORTFOLIO_MODE === 'multi-event-portfolio' && !IS_SPONSOR_VIEW;

    // Update header based on view type
    function updateHeaderForView(sponsorName, portfolioData) {
      const titleEl = document.getElementById('reportTitle');
      const subtitleEl = document.getElementById('reportSubtitle');
      const contextEl = document.getElementById('reportContext');

      if (IS_PORTFOLIO_MODE && portfolioData) {
        // V2 Multi-event portfolio view: cross-brand aggregation
        if (titleEl) {
          titleEl.textContent = 'üìä Portfolio Analytics Dashboard';
        }
        if (subtitleEl) {
          const childCount = portfolioData.portfolio?.children?.length || 0;
          const parentName = portfolioData.portfolio?.parent?.name || BRAND_ID;
          subtitleEl.textContent = `Cross-brand analytics for ${parentName} (${childCount + 1} brands)`;
        }
        if (contextEl) {
          contextEl.textContent = 'Multi-event portfolio view: aggregated sponsor performance across all your brands. Use this to demonstrate total ROI to sponsors.';
        }
      } else if (IS_SPONSOR_VIEW) {
        // Sponsor-specific view: personalized and welcoming
        if (titleEl) {
          titleEl.textContent = 'üìä Your Sponsorship Report';
        }
        if (subtitleEl) {
          subtitleEl.textContent = '';
          if (sponsorName) {
            subtitleEl.appendChild(document.createTextNode('Performance metrics for '));
            const strong = document.createElement('strong');
            strong.textContent = sponsorName;
            subtitleEl.appendChild(strong);
          } else if (SPONSOR_ID) {
            subtitleEl.textContent = 'Performance metrics for ' + SPONSOR_ID;
          } else {
            subtitleEl.textContent = 'See how your brand is performing';
          }
        }
        if (contextEl) {
          contextEl.textContent = 'This report shows how attendees are engaging with your sponsored content across all event touchpoints.';
        }
      } else {
        // Organizer view: overview of all sponsors
        if (titleEl) {
          titleEl.textContent = 'üìä Sponsor Performance Dashboard';
        }
        if (subtitleEl) {
          subtitleEl.textContent = 'Track how sponsors are performing across your events';
        }
        if (contextEl) {
          contextEl.textContent = 'Monitor impressions, clicks, and engagement for all sponsor placements. Share individual reports with sponsors via QR code.';
        }
      }
    }

    // Backwards compatibility alias
    function updateHeaderForSponsorView(sponsorName) {
      updateHeaderForView(sponsorName);
    }

    // Initialize header on page load
    updateHeaderForView(null);

    /**
     * Expected API contract (envelope omitted):
     *
     * Shared report (organizer):
     * {
     *   lastUpdatedISO: string,
     *   summary: {
     *     totalImpressions: number,
     *     totalClicks: number,
     *     totalQrScans: number,
     *     totalSignups: number,
     *     uniqueEvents: number,
     *     uniqueSponsors: number
     *   },
     *   surfaces: [
     *     { id, label, impressions, clicks, qrScans, engagementRate }
     *   ],
     *   sponsors?: [
     *     { id, name, impressions, clicks, ctr }
     *   ],
     *   events?: [
     *     { id, name, impressions, clicks, ctr, signupsCount }
     *   ]
     * }
     *
     * Sponsor view:
     * - Same shape, but summary/surfaces are scoped to that sponsor.
     *
     * V2 Portfolio mode (multi-event-portfolio):
     * {
     *   mode: 'multi-event-portfolio',
     *   lastUpdatedISO: string,
     *   portfolio: { parent: {...}, children: [...] },
     *   summary: { totalEvents, totalImpressions, totalClicks, ... },
     *   byBrand: { brandId: { events, impressions, clicks, ... } },
     *   sponsors: [...],
     *   topPerformingEvents: [...]
     * }
     */
    async function loadReport() {
      try {
        toggleLoading(true);

        let rpcName, payload;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // [V2-ONLY] Portfolio mode - NOT MVP, requires URL params to activate
        // Access: ?portfolioMode=multi-event-portfolio&adminKey=<key>
        // This code path is NOT part of the canonical 3 MVP endpoints (Story 6)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        if (IS_PORTFOLIO_MODE && ADMIN_KEY) {
          rpcName = 'api_getPortfolioAnalyticsV2';
          payload = {
            brandId: BRAND_ID,
            mode: 'multi-event-portfolio',
            adminKey: ADMIN_KEY
          };
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // [MVP CANONICAL] Sponsor view - api_getSponsorAnalytics (Story 6)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        } else if (IS_SPONSOR_VIEW && SPONSOR_ID) {
          rpcName = 'api_getSponsorAnalytics';
          payload = { brandId: BRAND_ID, sponsorId: SPONSOR_ID, eventId: EVENT_ID || null };
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // [MVP CANONICAL] Organizer view - api_getSharedAnalytics (Story 6)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        } else {
          rpcName = 'api_getSharedAnalytics';
          payload = { brandId: BRAND_ID };
        }

        const result = await NU.rpc(rpcName, payload);

        if (!result || !result.ok) {
          throw new Error(result && result.message || 'Failed to load analytics');
        }

        // [V2-ONLY] Handle V2 portfolio mode response (not MVP)
        if (IS_PORTFOLIO_MODE && result.value && result.value.mode === 'multi-event-portfolio') {
          renderPortfolioReport(result.value);
        // [MVP] Standard organizer/sponsor view response
        } else {
          renderReport(result.value || {});
        }
        toggleLoading(false);
      } catch (err) {
        console.error('SharedReport load error', err);
        showError(err && err.message);
      }
    }

    /**
     * [V2-ONLY] Render V2 portfolio report (multi-event mode)
     *
     * NOT MVP - This function is only called when the V2 portfolio mode is
     * activated via URL params (?portfolioMode=multi-event-portfolio&adminKey=KEY).
     * The portfolio toggle button is hidden (display:none) for MVP release.
     *
     * @param {Object} data - Portfolio analytics response from api_getPortfolioAnalyticsV2
     */
    function renderPortfolioReport(data) {
      // Update header for portfolio mode
      updateHeaderForView(null, data);

      // Convert portfolio format to SharedAnalytics-compatible format for reuse
      const summary = {
        totalImpressions: data.summary?.totalImpressions || 0,
        totalClicks: data.summary?.totalClicks || 0,
        totalQrScans: data.summary?.totalQrScans || 0,
        totalSignups: data.summary?.totalSignups || 0,
        uniqueEvents: data.summary?.totalEvents || 0,
        uniqueSponsors: data.summary?.totalSponsors || 0
      };

      // Story 11: Render funnel card at the top (V2 portfolio mode)
      renderSponsorFunnelCard(summary);

      // Render summary metrics
      renderSummaryMetrics(summary);

      // Render portfolio-specific brand breakdown
      if (data.byBrand) {
        renderBrandBreakdown(data.byBrand, data.portfolio);
      }

      // Render top sponsors (convert from portfolio format)
      const topSponsors = (data.sponsors || []).slice(0, 3).map(s => ({
        id: s.id,
        name: s.name || s.id,
        impressions: s.metrics?.impressions || 0,
        clicks: s.metrics?.clicks || 0,
        ctr: s.metrics?.ctr || 0
      }));
      if (topSponsors.length > 0) {
        renderTopSponsorsCard(topSponsors);
      }

      // Build surfaces from portfolio data (aggregate across brands)
      const surfaces = data.bySurface ? Object.values(data.bySurface).map(s => ({
        id: s.id,
        label: s.label || s.id,
        impressions: s.impressions || 0,
        clicks: s.clicks || 0,
        qrScans: s.qrScans || 0,
        engagementRate: s.impressions > 0 ? ((s.clicks + s.qrScans) / s.impressions * 100) : 0
      })) : [];

      if (surfaces.length > 0) {
        renderSurfacePerformance(surfaces);
      }

      // Render top callouts from portfolio events and sponsors
      const events = (data.topPerformingEvents || []).map(e => ({
        id: e.id,
        name: e.name,
        impressions: e.impressions || 0,
        clicks: e.clicks || 0,
        ctr: e.ctr || 0,
        signupsCount: e.signupsCount || 0
      }));
      const sponsors = (data.sponsors || []).map(s => ({
        id: s.id,
        name: s.name || s.id,
        impressions: s.metrics?.impressions || 0,
        clicks: s.metrics?.clicks || 0,
        ctr: s.metrics?.ctr || 0
      }));

      renderTopCallouts(events, sponsors);

      // Render sponsor performance
      if (sponsors.length > 0) {
        renderSponsorPerformance(sponsors);
      }

      // Render top performing events
      if (events.length > 0) {
        document.getElementById('eventPerformanceCard').style.display = 'block';
        renderEventPerformance(events);
      }

      // Last updated label
      const lastUpdated = data.lastUpdatedISO || data.generatedAt || null;
      if (lastUpdated) {
        document.getElementById('lastUpdated').textContent =
          'Last updated: ' + new Date(lastUpdated).toLocaleString();
      } else {
        document.getElementById('lastUpdated').textContent = 'Last updated: not available';
      }
    }

    /**
     * Render brand breakdown section (V2 portfolio mode only)
     *
     * @param {Object} byBrand - Metrics by brand ID
     * @param {Object} portfolio - Portfolio structure (parent/children)
     */
    function renderBrandBreakdown(byBrand, portfolio) {
      // Create brand breakdown section if it doesn't exist
      let container = document.getElementById('brandBreakdownCard');
      if (!container) {
        container = document.createElement('div');
        container.id = 'brandBreakdownCard';
        container.className = 'section-card';
        container.innerHTML = `
          <h2>üè¢ Performance by Brand</h2>
          <p class="section-help">Compare sponsor engagement across your portfolio of brands.</p>
          <div id="brandBreakdown"></div>
        `;
        // Insert after metrics grid
        const metricsGrid = document.getElementById('metricsGrid');
        if (metricsGrid && metricsGrid.parentNode) {
          metricsGrid.parentNode.insertBefore(container, metricsGrid.nextSibling);
        }
      }

      const breakdown = document.getElementById('brandBreakdown');
      if (!breakdown) return;

      const brands = Object.values(byBrand).sort((a, b) => b.impressions - a.impressions);

      if (!brands.length) {
        breakdown.innerHTML = '<p class="muted">No brand data available.</p>';
        return;
      }

      const rows = brands.map(brand => {
        const ctr = brand.ctr || 0;
        const badgeClass = ctr >= 2 ? 'success' : ctr >= 1 ? 'info' : 'warning';
        const isParent = portfolio?.parent?.id === brand.brandId;

        return `
          <tr>
            <td data-label="Brand">
              <strong>${escapeHtml(brand.brandName || brand.brandId)}</strong>
              ${isParent ? '<span class="badge info" style="margin-left:8px;font-size:0.6rem;">Parent</span>' : ''}
            </td>
            <td data-label="Events">${brand.events || 0}</td>
            <td data-label="Impressions">${(brand.impressions || 0).toLocaleString()}</td>
            <td data-label="Clicks">${(brand.clicks || 0).toLocaleString()}</td>
            <td data-label="Signups">${(brand.signups || 0).toLocaleString()}</td>
            <td data-label="CTR">
              <span class="badge ${badgeClass}">${ctr.toFixed(2)}%</span>
            </td>
          </tr>
        `;
      }).join('');

      breakdown.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Brand</th>
              <th class="th-with-tooltip" data-tooltip="Number of events for this brand">Events</th>
              <th class="th-with-tooltip" data-tooltip="Total impressions">Impressions</th>
              <th class="th-with-tooltip" data-tooltip="Total clicks">Clicks</th>
              <th class="th-with-tooltip" data-tooltip="Form signups">Signups</th>
              <th class="th-with-tooltip" data-tooltip="Click-through rate">CTR</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    function toggleLoading(isLoading) {
      document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
      document.getElementById('metrics').style.display = isLoading ? 'none' : 'block';
      document.getElementById('errorState').style.display = 'none';
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('metrics').style.display = 'none';
      document.getElementById('errorMessage').textContent =
        message || 'We couldn\'t load the report data. Please try again.';
      document.getElementById('errorState').style.display = 'block';
    }

    /**
     * Toggle collapsible detail section
     * @param {string} sectionId - The ID of the section to toggle
     */
    function toggleDetailSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (!section) return;

      const isCollapsed = section.classList.contains('collapsed');
      const toggleBtn = section.querySelector('.section-toggle');

      if (isCollapsed) {
        section.classList.remove('collapsed');
        if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'true');
      } else {
        section.classList.add('collapsed');
        if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'false');
      }
    }

    /**
     * Expand all detail sections (useful for printing or full view)
     */
    function expandAllDetailSections() {
      document.querySelectorAll('.detail-section.collapsed').forEach(section => {
        section.classList.remove('collapsed');
        const toggleBtn = section.querySelector('.section-toggle');
        if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'true');
      });
    }

    // Feature 5: Render Top Event / Top Sponsor Callouts (by highest CTR)
    function renderTopCallouts(events, sponsors) {
      const container = document.getElementById('topCallouts');
      let html = '';

      // Top Sponsor (by CTR) - show first per spec order
      if (sponsors && sponsors.length > 0) {
        const topSponsor = sponsors.reduce((a, b) => (b.ctr || 0) > (a.ctr || 0) ? b : a);
        html += `
          <div class="top-callout">
            <div class="callout-icon">‚≠ê</div>
            <div class="callout-label">Top Sponsor</div>
            <div class="callout-name">${escapeHtml(topSponsor.name || topSponsor.id || 'Sponsor')} ‚Äî ${(topSponsor.ctr || 0).toFixed(1)}% CTR</div>
          </div>
        `;
      }

      // Top Event (by CTR)
      if (events && events.length > 0) {
        const topEvent = events.reduce((a, b) => (b.ctr || 0) > (a.ctr || 0) ? b : a);
        html += `
          <div class="top-callout event">
            <div class="callout-icon">üèÜ</div>
            <div class="callout-label">Top Event</div>
            <div class="callout-name">${escapeHtml(topEvent.name || topEvent.id || 'Event')} ‚Äî ${(topEvent.ctr || 0).toFixed(1)}% CTR</div>
          </div>
        `;
      }

      container.innerHTML = html;
      container.style.display = html ? '' : 'none';
    }

    // Render Top Sponsors Card - highlights top 3 sponsors by clicks
    function renderTopSponsorsCard(topSponsors) {
      const container = document.getElementById('topSponsorsCard');

      if (!topSponsors || !topSponsors.length) {
        container.style.display = 'none';
        return;
      }

      const rankEmojis = ['ü•á', 'ü•à', 'ü•â'];
      const items = topSponsors.slice(0, 3).map(function(sponsor, index) {
        return `
          <div class="top-sponsor-item">
            <span class="top-sponsor-rank">${rankEmojis[index] || '#' + (index + 1)}</span>
            <span class="top-sponsor-name">${escapeHtml(sponsor.name || sponsor.id || 'Sponsor')}</span>
            <span class="top-sponsor-metric">
              <span class="clicks-value">${(sponsor.clicks || 0).toLocaleString()} clicks</span>
              <span class="ctr-badge">${(sponsor.ctr || 0).toFixed(1)}% CTR</span>
            </span>
          </div>
        `;
      }).join('');

      container.innerHTML = `
        <div class="top-sponsors-card">
          <h3>üèÜ Top Sponsors</h3>
          <div class="top-sponsors-list">
            ${items}
          </div>
        </div>
      `;
      container.style.display = 'block';
    }

    /**
     * Story 11: Render Sponsor Funnel Card
     * Shows at-a-glance funnel metrics: Impressions ‚Üí QR Scans ‚Üí Clicks ‚Üí Signups
     * with conversion rates between stages.
     *
     * @param {Object} summary - The summary object from SharedAnalytics
     */
    function renderSponsorFunnelCard(summary) {
      const container = document.getElementById('sponsorFunnelCard');
      if (!container) return;

      // Extract values with safe defaults
      const impressions = summary.totalImpressions || 0;
      const qrScans = summary.totalQrScans || 0;
      const clicks = summary.totalClicks || 0;
      const signups = summary.totalSignups || 0;

      // Check if there's any data at all
      const hasData = impressions > 0 || qrScans > 0 || clicks > 0 || signups > 0;

      if (!hasData) {
        // Empty state - clear message, not blanks or NaN
        container.innerHTML = `
          <div class="sponsor-funnel-card">
            <h3>üìä Engagement Funnel</h3>
            <div class="funnel-empty-state">
              <div class="empty-icon">üì≠</div>
              <p>No engagement data yet. Once attendees start interacting with your content, you'll see your funnel metrics here.</p>
            </div>
          </div>
        `;
        return;
      }

      // Calculate conversion rates (safe division - avoid NaN)
      // Scan Rate: QR scans as % of impressions
      const scanRate = impressions > 0 ? (qrScans / impressions * 100) : 0;
      // Click Rate (CTR): clicks as % of impressions
      const clickRate = impressions > 0 ? (clicks / impressions * 100) : 0;
      // Total interactions for conversion calc
      const totalInteractions = qrScans + clicks;
      // Conversion Rate: signups as % of total interactions (people who engaged)
      const conversionRate = totalInteractions > 0 ? (signups / totalInteractions * 100) : 0;
      // Overall funnel rate: signups as % of impressions
      const overallRate = impressions > 0 ? (signups / impressions * 100) : 0;

      // Format rate display - show % or "‚Äî" if zero impressions
      function formatRate(rate, label) {
        if (impressions === 0) return '<span class="stage-rate neutral">‚Äî</span>';
        return '<span class="stage-rate">' + rate.toFixed(1) + '% ' + label + '</span>';
      }

      // Determine subtitle based on view
      const subtitle = IS_SPONSOR_VIEW
        ? 'Your engagement journey'
        : 'Sponsor engagement overview';

      container.innerHTML = `
        <div class="sponsor-funnel-card">
          <h3>
            üìä Engagement Funnel
            <span class="funnel-subtitle">${subtitle}</span>
          </h3>
          <div class="funnel-stages">
            <div class="funnel-stage">
              <div class="stage-label">Impressions</div>
              <div class="stage-value">${impressions.toLocaleString()}</div>
              <div class="stage-rate neutral">Top of funnel</div>
            </div>
            <div class="funnel-stage">
              <div class="stage-label">QR Scans</div>
              <div class="stage-value">${qrScans.toLocaleString()}</div>
              ${formatRate(scanRate, 'scan rate')}
            </div>
            <div class="funnel-stage">
              <div class="stage-label">Clicks</div>
              <div class="stage-value">${clicks.toLocaleString()}</div>
              ${formatRate(clickRate, 'CTR')}
            </div>
            <div class="funnel-stage">
              <div class="stage-label">Signups</div>
              <div class="stage-value">${signups.toLocaleString()}</div>
              ${totalInteractions > 0 ? '<span class="stage-rate">' + conversionRate.toFixed(1) + '% conversion</span>' : '<span class="stage-rate neutral">‚Äî</span>'}
            </div>
          </div>
          <div class="funnel-summary">
            <div class="funnel-summary-item">
              <div class="summary-label">Overall CTR</div>
              <div class="summary-value">${impressions > 0 ? clickRate.toFixed(2) : '0.00'}%</div>
            </div>
            <div class="funnel-summary-item">
              <div class="summary-label">Total Interactions</div>
              <div class="summary-value">${totalInteractions.toLocaleString()}</div>
            </div>
            <div class="funnel-summary-item">
              <div class="summary-label">Funnel Rate</div>
              <div class="summary-value">${impressions > 0 ? overallRate.toFixed(2) : '0.00'}%</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderReport(data) {
      // Defensive defaults
      const summary = data.summary || {};
      const surfaces = Array.isArray(data.surfaces) ? data.surfaces : [];
      const sponsors = Array.isArray(data.sponsors) ? data.sponsors : [];
      const events = Array.isArray(data.events) ? data.events : [];
      const topSponsors = Array.isArray(data.topSponsors) ? data.topSponsors : [];

      // Update header with sponsor name if in sponsor view
      if (IS_SPONSOR_VIEW && sponsors.length > 0) {
        const sponsorName = sponsors[0].name || SPONSOR_ID;
        updateHeaderForSponsorView(sponsorName);
      }

      // Story 11: Render funnel card at the top for sponsor-first view
      renderSponsorFunnelCard(summary);

      renderSummaryMetrics(summary);

      // Render Top Sponsors Card (organizer view only, appears after metrics grid)
      if (!IS_SPONSOR_VIEW) {
        renderTopSponsorsCard(topSponsors);
      }

      renderSurfacePerformance(surfaces);

      // Feature 5: Render top callouts
      renderTopCallouts(events, sponsors);

      if (IS_SPONSOR_VIEW) {
        // In sponsor mode, focus on sponsor + event breakdown
        if (sponsors.length) {
          renderSponsorPerformance(sponsors);
        }
        if (events.length) {
          document.getElementById('eventPerformanceCard').style.display = 'block';
          renderEventPerformance(events);
        }
      } else {
        // Organizer view: show sponsors + events if present
        if (sponsors.length) {
          renderSponsorPerformance(sponsors);
        }
        if (events.length) {
          document.getElementById('eventPerformanceCard').style.display = 'block';
          renderEventPerformance(events);
        }
      }

      // Last updated label
      const lastUpdated = data.lastUpdatedISO || data.lastUpdated || null;
      if (lastUpdated) {
        document.getElementById('lastUpdated').textContent =
          'Last updated: ' + new Date(lastUpdated).toLocaleString();
      } else {
        document.getElementById('lastUpdated').textContent = 'Last updated: not available';
      }
    }

    function renderSummaryMetrics(summary) {
      const grid = document.getElementById('metricsGrid');
      grid.innerHTML = '';

      // Use sponsor-friendly labels with helpful subtitles
      const metricCards = [
        {
          label: 'Total Views',
          sublabel: 'Times your content was seen',
          value: (summary.totalImpressions || 0).toLocaleString()
        },
        {
          label: 'Total Clicks',
          sublabel: 'Clicks on sponsor links',
          value: (summary.totalClicks || 0).toLocaleString()
        },
        {
          label: 'QR Scans',
          sublabel: 'QR codes scanned',
          value: (summary.totalQrScans || 0).toLocaleString()
        },
        {
          label: 'Signups',
          sublabel: 'Form submissions',
          value: (summary.totalSignups || 0).toLocaleString()
        },
        {
          label: 'Events',
          sublabel: 'Active events',
          value: summary.uniqueEvents || 0
        },
        {
          label: 'Sponsors',
          sublabel: 'Active sponsors',
          value: summary.uniqueSponsors || 0
        }
      ];

      metricCards.forEach(metric => {
        const card = document.createElement('div');
        card.className = 'metric-card';
        card.innerHTML = `
          <div class="label">${metric.label}</div>
          <div class="value">${metric.value}</div>
          ${metric.sublabel ? '<div class="sublabel">' + metric.sublabel + '</div>' : ''}
        `;
        grid.appendChild(card);
      });
    }

    // Map surface IDs to user-friendly descriptions
    const SURFACE_DESCRIPTIONS = {
      'poster': 'Physical posters at the event venue',
      'display': 'Digital screens and displays',
      'public': 'Public event pages online',
      'signup': 'Registration and signup forms'
    };

    function renderSurfacePerformance(surfaces) {
      const container = document.getElementById('surfacePerformance');

      if (!surfaces.length) {
        container.innerHTML = '<p class="muted">No placement data available yet.</p>';
        return;
      }

      const rows = surfaces.map(surface => {
        const impressions = surface.impressions || 0;
        const clicks = surface.clicks || 0;
        const qrScans = surface.qrScans || 0;
        const rate = typeof surface.engagementRate === 'number'
          ? surface.engagementRate
          : (impressions > 0 ? (clicks + qrScans) * 100 / impressions : 0);
        const label = surface.label || surface.id || 'Unknown';
        const description = SURFACE_DESCRIPTIONS[surface.id] || '';

        const badgeClass =
          rate >= 5 ? 'success' :
          rate >= 2 ? 'info' : 'warning';

        return `
          <tr>
            <td data-label="Placement">
              <strong>${escapeHtml(label)}</strong>
              ${description ? '<span class="surface-desc">' + escapeHtml(description) + '</span>' : ''}
            </td>
            <td data-label="Views">${impressions.toLocaleString()}</td>
            <td data-label="Clicks">${clicks.toLocaleString()}</td>
            <td data-label="QR Scans">${qrScans.toLocaleString()}</td>
            <td data-label="Interaction Rate">
              <span class="badge ${badgeClass}">${rate.toFixed(1)}%</span>
            </td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th class="th-with-tooltip" data-tooltip="Where sponsor content appears">Placement</th>
              <th class="th-with-tooltip" data-tooltip="Number of times content was displayed">Views</th>
              <th class="th-with-tooltip" data-tooltip="Number of clicks on sponsor links">Clicks</th>
              <th class="th-with-tooltip" data-tooltip="QR codes scanned by attendees">QR Scans</th>
              <th class="th-with-tooltip" data-tooltip="Percentage of viewers who interacted">Interaction Rate</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    function renderSponsorPerformance(sponsors) {
      const container = document.getElementById('sponsorPerformance');

      // Update help text based on view (human-readable language)
      const helpText = document.getElementById('sponsorHelpText');
      if (helpText) {
        if (IS_SPONSOR_VIEW) {
          helpText.textContent = 'Your performance across all placements. Click Rate shows what percentage of viewers clicked your content.';
        } else {
          helpText.textContent = 'See how each sponsor is performing. Tap "Share Report" to give sponsors access to their own analytics.';
        }
      }

      if (!sponsors.length) {
        container.innerHTML = '<p class="muted">No sponsor activity recorded yet.</p>';
        return;
      }

      // Show QR column only in organizer view (not sponsor view)
      const showQrColumn = !IS_SPONSOR_VIEW;

      const rows = sponsors.map((sponsor, index) => {
        const ctr = sponsor.ctr || 0;
        const badgeClass =
          ctr >= 2 ? 'success' :
          ctr >= 1 ? 'info' : 'warning';

        const qrCell = showQrColumn
          ? `<td data-label="Share" style="text-align:center;">
               <button class="btn-secondary sponsor-qr-btn" data-sponsor-id="${escapeHtml(sponsor.id || '')}" data-sponsor-name="${escapeHtml(sponsor.name || sponsor.id || 'Sponsor')}" style="padding:6px 12px;font-size:0.75rem;">Share Report</button>
             </td>`
          : '';

        return `
          <tr>
            <td data-label="Sponsor">
              <strong>${escapeHtml(sponsor.name || sponsor.id || ('Sponsor #' + (index + 1)))}</strong>
            </td>
            <td data-label="Views">${(sponsor.impressions || 0).toLocaleString()}</td>
            <td data-label="Clicks">${(sponsor.clicks || 0).toLocaleString()}</td>
            <td data-label="Click Rate">
              <span class="badge ${badgeClass}">${ctr.toFixed(2)}%</span>
            </td>
            ${qrCell}
          </tr>
        `;
      }).join('');

      const qrHeader = showQrColumn ? '<th class="th-with-tooltip" data-tooltip="Generate QR code to share report with sponsor">Share</th>' : '';

      container.innerHTML = `
        <table class="data-table sponsor-table">
          <thead>
            <tr>
              <th>Sponsor</th>
              <th class="th-with-tooltip" data-tooltip="Number of times sponsor content was displayed">Views</th>
              <th class="th-with-tooltip" data-tooltip="Number of clicks on sponsor content">Clicks</th>
              <th class="th-with-tooltip" data-tooltip="Click-through rate: clicks √∑ views">Click Rate</th>
              ${qrHeader}
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;

      // Wire up QR buttons if in organizer view
      if (showQrColumn) {
        wireSponsorQrButtons(container);
      }
    }

    /**
     * Escape HTML to prevent XSS
     * @param {string} str - String to escape
     * @returns {string} Escaped string
     */
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /**
     * Wire QR button click handlers
     * @param {HTMLElement} container - Container element
     */
    function wireSponsorQrButtons(container) {
      container.querySelectorAll('.sponsor-qr-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const sponsorId = this.dataset.sponsorId;
          const sponsorName = this.dataset.sponsorName;
          if (!sponsorId) return;
          fetchAndShowSponsorQr(sponsorId, sponsorName);
        });
      });
    }

    /**
     * Fetch and display QR code for a sponsor's report
     * @param {string} sponsorId - The sponsor ID
     * @param {string} sponsorName - The sponsor name for display
     */
    async function fetchAndShowSponsorQr(sponsorId, sponsorName) {
      // Show loading modal
      showSponsorQrModal(sponsorName, null, true);

      try {
        const result = await NU.rpc('api_getSponsorReportQr', {
          sponsorId: sponsorId,
          brandId: BRAND_ID
        });

        if (!result || !result.ok) {
          showSponsorQrModal(sponsorName, null, false, result?.message || 'Failed to generate QR code');
          return;
        }

        // Respect invariant: no QR for unverified URLs
        if (!result.value.verified || !result.value.qrB64) {
          showSponsorQrModal(sponsorName, null, false, 'QR code unavailable - URL not verified');
          return;
        }

        // Show QR code
        showSponsorQrModal(sponsorName, result.value.qrB64, false, null, result.value.url);

      } catch (e) {
        console.error('Failed to fetch sponsor QR:', e);
        showSponsorQrModal(sponsorName, null, false, 'Network error - please try again');
      }
    }

    /**
     * Display modal with sponsor QR code
     * @param {string} sponsorName - Sponsor name for title
     * @param {string|null} qrB64 - Base64 encoded QR image (null if loading/error)
     * @param {boolean} loading - Show loading spinner
     * @param {string|null} error - Error message to display
     * @param {string|null} url - The URL the QR encodes (for display)
     */
    function showSponsorQrModal(sponsorName, qrB64, loading, error, url) {
      // Remove existing modal if any
      const existing = document.getElementById('sponsorQrModal');
      if (existing) existing.remove();

      let content = '';
      if (loading) {
        content = '<div style="padding:40px;text-align:center;"><span class="spinner"></span><p style="margin-top:12px;color:#64748b;">Loading QR code...</p></div>';
      } else if (error) {
        content = '<div style="padding:40px;text-align:center;color:#ef4444;"><p>' + escapeHtml(error) + '</p></div>';
      } else if (qrB64) {
        content = `
          <div style="text-align:center;padding:20px;">
            <img src="data:image/png;base64,${qrB64}" alt="Sponsor report QR" style="max-width:200px;height:auto;border:1px solid #e2e8f0;border-radius:8px;">
            <p style="margin-top:12px;font-size:0.75rem;color:#64748b;word-break:break-all;">${escapeHtml(url || '')}</p>
            <p style="margin-top:8px;font-size:0.7rem;color:#94a3b8;">Scan to view sponsor analytics</p>
          </div>
        `;
      }

      const modal = document.createElement('div');
      modal.id = 'sponsorQrModal';
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
      modal.innerHTML = `
        <div style="background:white;border-radius:12px;max-width:320px;width:90%;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);">
          <div style="padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;font-size:1rem;font-weight:600;">${escapeHtml(sponsorName)} QR</h3>
            <button onclick="closeSponsorQrModal()" style="background:none;border:none;cursor:pointer;font-size:1.25rem;color:#64748b;padding:0;line-height:1;">&times;</button>
          </div>
          ${content}
        </div>
      `;

      // Close on backdrop click
      modal.addEventListener('click', function(e) {
        if (e.target === modal) closeSponsorQrModal();
      });

      document.body.appendChild(modal);
    }

    /**
     * Close the sponsor QR modal
     */
    function closeSponsorQrModal() {
      const modal = document.getElementById('sponsorQrModal');
      if (modal) modal.remove();
    }

    function renderEventPerformance(events) {
      const container = document.getElementById('eventPerformance');

      if (!events.length) {
        container.innerHTML = '<p class="muted">No event-level analytics yet.</p>';
        return;
      }

      const rows = events.map((ev, index) => {
        const ctr = ev.ctr || 0;
        const badgeClass =
          ctr >= 2 ? 'success' :
          ctr >= 1 ? 'info' : 'warning';

        const rank =
          index === 0 ? 'ü•á' :
          index === 1 ? 'ü•à' :
          index === 2 ? 'ü•â' : '#' + (index + 1);

        const signups = ev.signupsCount || 0;

        return `
          <tr>
            <td data-label="Event">
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-size:1.1rem;">${rank}</span>
                <strong>${escapeHtml(ev.name || ev.id)}</strong>
              </div>
            </td>
            <td data-label="Views">${(ev.impressions || 0).toLocaleString()}</td>
            <td data-label="Clicks">${(ev.clicks || 0).toLocaleString()}</td>
            <td data-label="Signups">${signups.toLocaleString()}</td>
            <td data-label="Click Rate">
              <span class="badge ${badgeClass}">${ctr.toFixed(2)}%</span>
            </td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Event</th>
              <th class="th-with-tooltip" data-tooltip="Number of times event content was displayed">Views</th>
              <th class="th-with-tooltip" data-tooltip="Number of clicks on event content">Clicks</th>
              <th class="th-with-tooltip" data-tooltip="Form submissions for this event">Signups</th>
              <th class="th-with-tooltip" data-tooltip="Click-through rate: clicks √∑ views">Click Rate</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    // V2 FEATURE ‚Äì NOT MVP: Export and Filter functions (buttons hidden in MVP)
    // These stubs remain for when V2 features are enabled
    function exportReport() {
      showComingSoon(document.getElementById('exportBtn'));
    }

    function showFilters() {
      showComingSoon(document.getElementById('filterBtn'));
    }

    function showComingSoon(btn) {
      if (!btn) return;
      const label = btn.querySelector('.btn-text');
      if (!label) return;
      const original = label.textContent;
      label.textContent = 'üöß Coming Soon';
      setTimeout(() => {
        label.textContent = original;
      }, 1500);
    }

    /**
     * V2 FEATURE: Toggle between single-brand and portfolio mode
     *
     * This function switches the report between standard single-brand view
     * and multi-event portfolio view (cross-brand aggregation).
     *
     * Portfolio mode is activated via URL parameters:
     *   ?portfolioMode=multi-event-portfolio&adminKey=<admin-key>
     *
     * Once sponsor adoption warrants it, this toggle can be shown to
     * parent organization administrators.
     */
    function togglePortfolioMode() {
      const currentUrl = new URL(window.location.href);
      const currentMode = currentUrl.searchParams.get('portfolioMode');

      if (currentMode === 'multi-event-portfolio') {
        // Switch to single-brand mode
        currentUrl.searchParams.delete('portfolioMode');
        currentUrl.searchParams.delete('adminKey');
      } else {
        // Switch to portfolio mode - prompt for admin key if not present
        const adminKey = currentUrl.searchParams.get('adminKey');
        if (!adminKey) {
          const key = prompt('Enter admin key for portfolio access:');
          if (!key) return;
          currentUrl.searchParams.set('adminKey', key);
        }
        currentUrl.searchParams.set('portfolioMode', 'multi-event-portfolio');
      }

      window.location.href = currentUrl.toString();
    }

    /**
     * Check if portfolio toggle should be visible
     * Only show for non-sponsor views when adminKey is present
     */
    function checkPortfolioToggleVisibility() {
      const toggleBtn = document.getElementById('portfolioToggleBtn');
      if (!toggleBtn) return;

      // Show toggle if:
      // 1. Not in sponsor view
      // 2. adminKey is present OR already in portfolio mode
      if (!IS_SPONSOR_VIEW && (ADMIN_KEY || IS_PORTFOLIO_MODE)) {
        toggleBtn.style.display = 'inline-flex';

        // Update button text based on current mode
        const btnText = toggleBtn.querySelector('.btn-text');
        if (btnText) {
          btnText.textContent = IS_PORTFOLIO_MODE
            ? 'üìâ Single Brand View'
            : 'üìà Portfolio View';
        }
      }
    }

    window.addEventListener('load', function() {
      loadReport();
      checkPortfolioToggleVisibility();
    });
  </script>
</body>
</html>
