<!--
================================================================================
MVP SURFACE - Focus Group Critical
================================================================================
Page: SharedReport.html
Purpose: Shareable analytics dashboard for stakeholders and sponsors
Status: LOCKED for MVP v1.0

DO NOT modify this file's contracts without updating:
  - NUSDK.html (API client)
  - tests/e2e/* (end-to-end tests)
  - tests/unit/* (unit tests)

Related MVP Surfaces: Admin, Poster, Display, Public
================================================================================

SCHEMA CONTRACT: /schemas/analytics.schema.json (MVP v1.0)
This surface READS analytics data aggregated from tracked events.

RESPONSE ENVELOPE (same as NUSDK):
  { ok: true, value: SharedAnalytics } | { ok: false, code, message }

SharedAnalytics SHAPE:
  lastUpdatedISO: string              ‚Üí #lastUpdated display
  summary: {
    totalImpressions: number          ‚Üí Metric card
    totalClicks: number               ‚Üí Metric card
    totalQrScans: number              ‚Üí Metric card
    totalSignups: number              ‚Üí Metric card
    uniqueEvents: number              ‚Üí Metric card
    uniqueSponsors: number            ‚Üí Metric card
  }
  surfaces: Array<{
    id: string                        ‚Üí 'poster' | 'display' | 'public' | 'signup'
    label: string                     ‚Üí Display name
    impressions: number
    clicks: number
    qrScans: number
    engagementRate?: number           ‚Üí Derived if missing
  }>
  sponsors?: Array<{                  ‚Üí Organizer view only
    id: string
    name: string
    impressions: number
    clicks: number
    ctr: number                       ‚Üí Percentage (e.g., 2.5)
  }>
  events?: Array<{                    ‚Üí Optional breakdown
    id: string
    name: string
    impressions: number
    clicks: number
    ctr: number                       ‚Üí Percentage (e.g., 2.5)
  }>

API ENDPOINTS:
  - api_getSharedAnalytics({ brandId })     ‚Üí Organizer view (aggregated)
  - api_getSponsorAnalytics({ sponsorId })  ‚Üí Sponsor view (scoped) - V2
================================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> ¬∑ Shared Analytics</title>
  <?!= include('Header'); ?>
  <?!= include('HeaderInit'); ?>
  <?!= include('NUSDK'); ?>
  <?!= include('DesignTokens'); ?>
  <?!= include('Styles'); ?>
  <?!= include('FooterComponent'); ?>
  <?!= include('SpinnerComponent'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="referrer" content="no-referrer"/>
  <style>
    /* SharedReport-specific styles (extends Styles.html) */

    /* Report Header - uses page-header-card pattern with gradient */
    .report-header {
      background: linear-gradient(135deg, var(--color-primary, #2563eb) 0%, var(--color-primary-dark, #1d4ed8) 100%);
      color: white;
      padding: 2rem;
      border-radius: var(--radius-md, 12px);
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-md, 0 4px 6px rgba(0, 0, 0, 0.1));
    }

    .report-header h1 {
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .report-header .subtitle {
      opacity: 0.9;
      font-size: 0.875rem;
    }

    /* Override metrics-grid for 6-column layout (3x2) on desktop */
    @media (min-width: 1024px) {
      .metrics-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Section card extends .card from Styles.html */
    .section-card {
      background: white;
      border-radius: var(--radius-md, 12px);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-base, 0 1px 3px rgba(0,0,0,0.1));
      border: 1px solid var(--color-gray-200, #e2e8f0);
      border-left: 4px solid var(--color-primary, #2563eb);
    }

    .section-card h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      color: var(--color-gray-800, #1e293b);
      font-weight: 600;
    }

    /* Data Table - extends base table styles */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .data-table thead {
      background: var(--color-gray-100, #f1f5f9);
    }

    .data-table th {
      padding: 0.75rem 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--color-gray-600, #475569);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--color-gray-200, #e2e8f0);
    }

    .data-table td {
      padding: 1rem;
      border-bottom: 1px solid var(--color-gray-100, #f1f5f9);
    }

    .data-table tbody tr:hover {
      background: var(--color-gray-50, #f8fafc);
    }

    /* Mobile: Stack table */
    @media (max-width: 640px) {
      .data-table thead { display: none; }
      .data-table, .data-table tbody, .data-table tr, .data-table td {
        display: block;
        width: 100%;
      }
      .data-table tr {
        margin-bottom: 1rem;
        background: white;
        border: 1px solid var(--color-gray-200, #e2e8f0);
        border-radius: var(--radius-base, 8px);
        padding: 0.75rem;
      }
      .data-table td {
        padding: 0.5rem 0;
        border: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .data-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--color-gray-500, #64748b);
        text-transform: uppercase;
        font-size: 0.75rem;
      }
    }

    /* Badges - compact variants */
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-full, 9999px);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge.high { background: var(--color-danger-pale, #fef2f2); color: var(--color-danger, #dc2626); }
    .badge.medium, .badge.warning { background: var(--color-warning-pale, #fef3c7); color: var(--color-warning-dark, #d97706); }
    .badge.success { background: var(--color-success-pale, #d1fae5); color: var(--color-success, #10b981); }
    .badge.info { background: var(--color-primary-pale, #dbeafe); color: var(--color-primary, #2563eb); }

    /* Chart Placeholder */
    .chart-container {
      height: 300px;
      background: var(--color-gray-50, #f8fafc);
      border: 2px dashed var(--color-gray-300, #cbd5e1);
      border-radius: var(--radius-base, 8px);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-gray-400, #94a3b8);
      font-size: 0.875rem;
    }

    /* Action Bar */
    .action-bar {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    /* Recommendations - alert-style cards */
    .recommendation {
      padding: 1rem;
      border-radius: var(--radius-base, 8px);
      margin-bottom: 0.75rem;
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }

    .recommendation.high { background: #fef2f2; border-left: 4px solid var(--color-danger, #dc2626); }
    .recommendation.medium { background: #fef3c7; border-left: 4px solid var(--color-warning, #f59e0b); }
    .recommendation.success { background: #ecfdf5; border-left: 4px solid var(--color-success, #10b981); }
    .recommendation.info { background: #eff6ff; border-left: 4px solid var(--color-primary, #2563eb); }

    .recommendation-icon { font-size: 1.5rem; }
    .recommendation-content { flex: 1; }
    .recommendation-content .title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }

    /* Loading state - uses .loading-state from Styles.html but custom spinner */
    .loading {
      text-align: center;
      padding: 3rem 1rem;
    }

    /* Metrics grid override for this page */
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    @media (min-width: 640px) {
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (min-width: 1024px) {
      .metrics-grid { grid-template-columns: repeat(3, 1fr); }
    }

    /* Metric card overrides for SharedReport */
    .metrics-grid .metric-card .label {
      font-size: 0.75rem;
      color: var(--color-gray-500, #64748b);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .metrics-grid .metric-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-gray-900, #0f172a);
      margin-bottom: 0.25rem;
    }

    .metrics-grid .metric-card .trend {
      font-size: 0.875rem;
      color: var(--color-success, #10b981);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .metrics-grid .metric-card .trend.negative {
      color: var(--color-danger, #ef4444);
    }

    /* === MVP Essential: Empty/Error States === */
    .empty-state, .error-state {
      text-align: center;
      padding: 48px 24px;
      max-width: 500px;
      margin: 40px auto;
    }
    .empty-state-icon, .error-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.6;
    }
    .empty-state h3, .error-state h3 {
      color: var(--color-gray-700, #374151);
      margin-bottom: 8px;
      font-size: 1.25rem;
    }
    .empty-state p, .error-state p {
      color: var(--color-gray-500, #6b7280);
      margin-bottom: 16px;
      line-height: 1.6;
    }
    .error-state {
      background: #fef2f2;
      border-radius: var(--radius-md, 12px);
      border: 1px solid #fecaca;
    }
    .error-state h3 { color: #dc2626; }
    .error-state p { color: #b91c1c; }
    /* .btn-retry - Now centralized in Styles.html (C-001) */
    /* .site-footer - Now centralized in FooterComponent.html (D-005) */
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="report-header">
      <h1>üìä Shared Event-Sponsor Analytics</h1>
      <p class="subtitle">Single source of truth for Event Managers & Sponsors</p>
      <p class="subtitle" id="lastUpdated">Loading...</p>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <button id="refreshBtn" class="btn btn-primary" onclick="loadReport()">
        <span class="btn-text">üîÑ Refresh Data</span>
      </button>
      <button id="exportBtn" class="btn btn-secondary" onclick="exportReport()">
        <span class="btn-text">üìä Export to Sheets</span>
      </button>
      <button id="filterBtn" class="btn btn-secondary" onclick="showFilters()">
        <span class="btn-text">üîç Filter</span>
      </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Loading analytics data...</p>
    </div>

    <!-- Key Metrics -->
    <div id="metrics" style="display:none;">
      <div class="metrics-grid" id="metricsGrid"></div>

      <!-- Surface Performance -->
      <div class="section-card">
        <h2>üåê Performance by Surface</h2>
        <div id="surfacePerformance"></div>
      </div>

      <!-- Sponsor Performance -->
      <div class="section-card">
        <h2>üè¢ Sponsor Performance</h2>
        <div id="sponsorPerformance"></div>
      </div>

      <!-- ROI & Surface Breakdown (Sponsors Only) -->
      <div class="section-card" id="sponsorROICard" style="display:none;">
        <h2>üí∞ ROI & Performance Breakdown</h2>
        <div id="sponsorROI"></div>
      </div>

      <!-- Event Breakdown (Sponsors Only) -->
      <div class="section-card" id="sponsorEventsCard" style="display:none;">
        <h2>üéØ Performance by Event</h2>
        <div id="sponsorEvents"></div>
      </div>

      <!-- Event Performance (Event Managers Only) -->
      <div class="section-card" id="eventPerformanceCard" style="display:none;">
        <h2>üéâ Event Performance</h2>
        <div id="eventPerformance"></div>
      </div>

      <!-- V2 HIDDEN: Daily Trends requires time-series backend -->
      <div class="section-card" style="display:none;">
        <h2>üìà Daily Trends</h2>
        <div class="chart-container">
          V2: Chart requires time-series analytics backend
        </div>
      </div>

      <!-- Recommendations -->
      <div class="section-card">
        <h2>üí° Recommendations</h2>
        <div id="recommendations"></div>
      </div>
    </div>

    <!-- Error State (hidden by default) -->
    <div id="errorState" style="display:none;">
      <div class="error-state">
        <div class="error-state-icon">‚ö†Ô∏è</div>
        <h3>Trouble Loading Analytics</h3>
        <p id="errorMessage">We couldn't load the report data. Please try again.</p>
        <button class="btn-retry" onclick="loadReport()">üîÑ Try Again</button>
      </div>
    </div>
  </div>

  <!-- Trust Footer -->
  <footer class="site-footer">
    <p>Powered by <a href="https://eventangle.com" target="_blank" rel="noopener">EventAngle</a></p>
  </footer>

  <script>
    const BRAND_ID = '<?= brandId ?>';

    // Detect sponsor view from URL params
    const urlParams = new URLSearchParams(window.location.search);
    const IS_SPONSOR_VIEW = urlParams.get('sponsor') === 'true';
    const SPONSOR_ID = urlParams.get('sponsorId') || '';
    const EVENT_ID = urlParams.get('eventId') || '';

    /**
     * Loads analytics data from the backend.
     * API contract: See schema header for api_getSharedAnalytics response shape.
     * Response must match /schemas/analytics.schema.json
     */
    async function loadReport() {
      try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('metrics').style.display = 'none';

        let result;

        // MVP: Use api_getSharedAnalytics for event manager view
        // V2: api_getSponsorAnalytics for sponsor-specific view (requires auth)
        if (IS_SPONSOR_VIEW && SPONSOR_ID) {
          result = await NU.rpc('api_getSponsorAnalytics', {
            sponsorId: SPONSOR_ID,
            eventId: EVENT_ID || null,
            brandId: BRAND_ID
          });
        } else {
          result = await NU.rpc('api_getSharedAnalytics', {
            brandId: BRAND_ID,
            isSponsorView: IS_SPONSOR_VIEW
          });
        }

        if (!result.ok) {
          throw new Error(result.message || 'Failed to load analytics');
        }

        renderReport(result.value);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('metrics').style.display = 'block';

        // Use lastUpdatedISO from response, fallback to now
        const lastUpdated = result.value.lastUpdatedISO
          ? new Date(result.value.lastUpdatedISO).toLocaleString()
          : new Date().toLocaleString();
        document.getElementById('lastUpdated').textContent = `Last updated: ${lastUpdated}`;

      } catch (e) {
        console.error(e);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('metrics').style.display = 'none';
        document.getElementById('errorMessage').textContent = e.message || 'We couldn\'t load the report data. Please try again.';
        document.getElementById('errorState').style.display = 'block';
      }
    }

    /**
     * Renders the full report from SharedAnalytics data.
     * Schema contract: /schemas/analytics.schema.json
     */
    function renderReport(data) {
      // Render key metrics from summary
      renderMetrics(data);

      // Render surface performance (required field)
      renderSurfacePerformance(data.surfaces);

      // Handle sponsor-specific view (V2)
      if (IS_SPONSOR_VIEW && SPONSOR_ID) {
        // Show sponsor-specific sections
        document.getElementById('sponsorROICard').style.display = 'block';
        document.getElementById('sponsorEventsCard').style.display = 'block';

        // V2: ROI and surface breakdown
        renderSponsorROI(data);

        // Render event breakdown for sponsor
        renderSponsorEventBreakdown(data.events);

        // V2: Sponsor-specific insights
        renderSponsorInsights(data.insights || []);
      } else {
        // Organizer view
        // Render sponsor performance (optional)
        renderSponsorPerformance(data.sponsors);

        // Render event performance (optional)
        if (data.events && data.events.length > 0) {
          document.getElementById('eventPerformanceCard').style.display = 'block';
          renderEventPerformance(data.events);
        }

        // V2: Recommendations placeholder
        renderRecommendations(data);
      }
    }

    /**
     * Renders MVP key metrics grid.
     * Schema contract: /schemas/analytics.schema.json#/$defs/Summary
     */
    function renderMetrics(data) {
      const grid = document.getElementById('metricsGrid');
      grid.innerHTML = '';

      // Use summary object from new contract
      const summary = data.summary || {};
      const metricCards = [
        {
          label: 'Impressions',
          value: (summary.totalImpressions ?? 0).toLocaleString()
        },
        {
          label: 'Clicks',
          value: (summary.totalClicks ?? 0).toLocaleString()
        },
        {
          label: 'QR Scans',
          value: (summary.totalQrScans ?? 0).toLocaleString()
        },
        {
          label: 'Signups',
          value: (summary.totalSignups ?? 0).toLocaleString()
        },
        {
          label: 'Events',
          value: (summary.uniqueEvents ?? 0).toLocaleString()
        },
        {
          label: 'Sponsors',
          value: (summary.uniqueSponsors ?? 0).toLocaleString()
        }
      ];

      metricCards.forEach(metric => {
        const card = document.createElement('div');
        card.className = 'metric-card';
        card.innerHTML = `
          <div class="label">${metric.label}</div>
          <div class="value">${metric.value}</div>
        `;
        grid.appendChild(card);
      });
    }

    /**
     * Calculate CTR as formatted string.
     * @param {number} clicks
     * @param {number} impressions
     * @returns {string} e.g., "2.5%"
     */
    function calculateCTR(clicks, impressions) {
      if (!impressions || impressions === 0) return '0%';
      return ((clicks / impressions) * 100).toFixed(1) + '%';
    }

    /**
     * Renders surface performance table.
     * Schema contract: /schemas/analytics.schema.json#/$defs/SurfaceMetrics
     */
    function renderSurfacePerformance(surfaces) {
      const container = document.getElementById('surfacePerformance');

      if (!surfaces || surfaces.length === 0) {
        container.innerHTML = '<p style="color: #64748b;">No surface data available.</p>';
        return;
      }

      const html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Surface</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>QR Scans</th>
              <th>CTR</th>
            </tr>
          </thead>
          <tbody>
            ${surfaces.map(surface => {
              const ctr = surface.engagementRate != null
                ? surface.engagementRate.toFixed(1) + '%'
                : calculateCTR(surface.clicks, surface.impressions);
              return `
                <tr>
                  <td data-label="Surface"><strong>${surface.label || surface.id}</strong></td>
                  <td data-label="Impressions">${(surface.impressions || 0).toLocaleString()}</td>
                  <td data-label="Clicks">${(surface.clicks || 0).toLocaleString()}</td>
                  <td data-label="QR Scans">${(surface.qrScans || 0).toLocaleString()}</td>
                  <td data-label="CTR"><span class="badge info">${ctr}</span></td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    /**
     * Renders sponsor performance table.
     * Schema contract: /schemas/analytics.schema.json#/$defs/SponsorMetrics
     */
    function renderSponsorPerformance(sponsors) {
      const container = document.getElementById('sponsorPerformance');

      if (!sponsors || sponsors.length === 0) {
        container.innerHTML = '<p style="color: #64748b;">No sponsor data available.</p>';
        return;
      }

      const html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Sponsor</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>CTR</th>
            </tr>
          </thead>
          <tbody>
            ${sponsors.slice(0, 10).map(sponsor => {
              // ctr is a number (e.g., 2.5), format it
              const ctr = sponsor.ctr != null
                ? sponsor.ctr.toFixed(1) + '%'
                : calculateCTR(sponsor.clicks, sponsor.impressions);
              return `
              <tr>
                <td data-label="Sponsor"><strong>${sponsor.name || sponsor.id}</strong></td>
                <td data-label="Impressions">${(sponsor.impressions || 0).toLocaleString()}</td>
                <td data-label="Clicks">${(sponsor.clicks || 0).toLocaleString()}</td>
                <td data-label="CTR">
                  <span class="badge success">${ctr}</span>
                </td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    /**
     * Renders event performance table.
     * Schema contract: /schemas/analytics.schema.json#/$defs/EventMetrics
     */
    function renderEventPerformance(events) {
      const container = document.getElementById('eventPerformance');

      if (!events || events.length === 0) {
        container.innerHTML = '<p style="color: #64748b;">No event data available.</p>';
        return;
      }

      const html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Event</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>CTR</th>
            </tr>
          </thead>
          <tbody>
            ${events.slice(0, 10).map(event => {
              // ctr is a number (e.g., 2.5), format it
              const ctr = event.ctr != null
                ? event.ctr.toFixed(1) + '%'
                : calculateCTR(event.clicks, event.impressions);
              return `
              <tr>
                <td data-label="Event"><strong>${event.name || event.id}</strong></td>
                <td data-label="Impressions">${(event.impressions || 0).toLocaleString()}</td>
                <td data-label="Clicks">${(event.clicks || 0).toLocaleString()}</td>
                <td data-label="CTR">
                  <span class="badge info">${ctr}</span>
                </td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    /**
     * V2 HIDDEN: Auto-generated recommendations require more data.
     * For MVP, show a simple placeholder.
     */
    function renderRecommendations(metrics) {
      const container = document.getElementById('recommendations');
      // V2: Auto-generated recommendations based on CTR thresholds
      container.innerHTML = '<p style="color: #64748b;">Recommendations will be available in a future update. Review the tables above to identify high-performing surfaces and sponsors.</p>';
    }

    /**
     * V2 HIDDEN: ROI calculations require cost data not available in MVP.
     * Sponsor-specific view shows simplified surface breakdown.
     */
    function renderSponsorROI(metrics) {
      const container = document.getElementById('sponsorROI');
      // V2: ROI calculations require cost data integration
      container.innerHTML = '<p style="color: #64748b;">ROI analytics will be available in a future update when cost tracking is enabled.</p>';
    }

    /**
     * Renders sponsor event breakdown table.
     * Schema contract: /schemas/analytics.schema.json#/$defs/EventMetrics
     */
    function renderSponsorEventBreakdown(events) {
      const container = document.getElementById('sponsorEvents');

      if (!events || events.length === 0) {
        container.innerHTML = '<p style="color: #64748b;">No event data available.</p>';
        return;
      }

      // Sort by impressions descending
      const sorted = [...events].sort((a, b) => (b.impressions || 0) - (a.impressions || 0));

      const html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Event</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>CTR</th>
            </tr>
          </thead>
          <tbody>
            ${sorted.slice(0, 10).map(event => {
              // ctr is a number (e.g., 2.5), format it
              const ctr = event.ctr != null
                ? event.ctr.toFixed(1) + '%'
                : calculateCTR(event.clicks, event.impressions);
              return `
                <tr>
                  <td data-label="Event"><strong>${event.name || event.id}</strong></td>
                  <td data-label="Impressions">${(event.impressions || 0).toLocaleString()}</td>
                  <td data-label="Clicks">${(event.clicks || 0).toLocaleString()}</td>
                  <td data-label="CTR">
                    <span class="badge info">${ctr}</span>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    /**
     * V2 HIDDEN: Sponsor insights require ML-based analysis.
     * For MVP, show a simple placeholder.
     */
    function renderSponsorInsights(insights) {
      const container = document.getElementById('recommendations');
      // V2: ML-based sponsor insights
      container.innerHTML = '<p style="color: #64748b;">Sponsor insights will be available in a future update.</p>';
    }

    async function exportReport() {
      const btn = document.getElementById('exportBtn');
      const btnText = btn.querySelector('.btn-text');
      const originalText = btnText.textContent;

      try {
        if (!confirm('Export report to Google Sheets?')) return;

        // Show loading state (C-006)
        btn.disabled = true;
        btn.classList.add('btn-loading');
        btnText.textContent = '‚è≥ Exporting...';

        const result = await NU.rpc('api_exportSharedReport', BRAND_ID, {});

        if (!result.ok) {
          throw new Error(result.message || 'Failed to export');
        }

        btnText.textContent = '‚úÖ Exported!';
        setTimeout(() => {
          btnText.textContent = originalText;
          btn.classList.remove('btn-loading');
          btn.disabled = false;
        }, 2000);

        window.open(result.value.url, '_blank');

      } catch (e) {
        btnText.textContent = '‚ùå Failed';
        setTimeout(() => {
          btnText.textContent = originalText;
          btn.classList.remove('btn-loading');
          btn.disabled = false;
        }, 2000);
        console.error('Export error:', e);
      }
    }

    function showFilters() {
      const btn = document.getElementById('filterBtn');
      // Show brief feedback for coming soon feature
      const btnText = btn.querySelector('.btn-text');
      const originalText = btnText.textContent;
      btnText.textContent = 'üöß Coming Soon';
      setTimeout(() => {
        btnText.textContent = originalText;
      }, 1500);
    }

    // Auto-load on page load
    window.addEventListener('load', loadReport);
  </script>
</body>
</html>
