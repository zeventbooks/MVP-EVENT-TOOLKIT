<!--
================================================================================
MVP SURFACE - Focus Group Critical
================================================================================
Page: Poster.html
Purpose: Printable event poster with QR code and sponsor branding
Status: LOCKED for MVP v1.0

DO NOT modify this file's contracts without updating:
  - NUSDK.html (API client)
  - tests/e2e/* (end-to-end tests)
  - tests/unit/* (unit tests)

Related MVP Surfaces: Admin, Display, Public, Sponsor, SharedReport
================================================================================
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> ¬∑ Poster</title>
  <?!= include('DesignTokens'); ?>
  <?!= include('Styles'); ?>
  <?!= include('DesignAdapter'); ?>
  <?!= include('DemoMode'); ?>
  <?!= include('SponsorUtils'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="referrer" content="no-referrer"/>
  <style>
    /* Poster-specific styles - uses design tokens from DesignAdapter */
    [hidden] { display:none !important; }
    body { background: #fff; }
    .poster-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
      background: #fff;
    }

    /* Enhanced Sponsor Strip */
    .sponsor-strip {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      gap: 24px;
      padding: 20px;
      border-bottom: 3px solid var(--color-primary, #2563eb);
      margin-bottom: 40px;
      background: var(--gradient-sponsor-bg, linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f8fafc 100%));
      box-shadow: var(--shadow-sm, 0 2px 8px rgba(0,0,0,0.05));
    }
    .sponsor-strip img {
      max-height: 70px;
      object-fit: contain;
    }
    .sponsor-strip strong {
      color: var(--color-gray-800, #1e293b);
      font-size: 1.3em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Enhanced Event Details */
    .event-details {
      text-align: center;
      margin-bottom: 40px;
      padding: 24px;
      background: linear-gradient(135deg, var(--color-gray-50, #f8fafc) 0%, #ffffff 100%);
      border-radius: var(--radius-md, 12px);
    }
    .event-details h1 {
      color: var(--color-primary, #2563eb);
      font-size: 2.8rem;
      margin-bottom: 20px;
      line-height: 1.2;
      text-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
    }
    .event-meta {
      font-size: 1.3rem;
      color: var(--color-gray-600, #475569);
      margin: 12px 0;
      line-height: 1.8;
    }
    .event-meta strong {
      color: var(--color-gray-800, #1e293b);
      font-weight: 700;
    }
    .event-image {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      margin: 24px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .event-summary {
      font-size: 1.1rem;
      line-height: 1.6;
      color: #475569;
      margin: 20px 0;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #2563eb;
    }

    /* Enhanced QR Codes */
    .qr-section {
      margin-top: 48px;
      padding: 32px 0;
      border-top: 3px solid #e2e8f0;
    }
    .qr-section h2 {
      text-align: center;
      color: #1e293b;
      font-size: 2rem;
      margin-bottom: 32px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .qr-section h2::before {
      content: "üì± ";
      font-size: 1.5em;
    }
    .qr-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 28px;
      margin: 24px 0;
    }
    .qr-code {
      text-align: center;
      padding: 24px;
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border-radius: 16px;
      border: 3px solid #e2e8f0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    .qr-code:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.15);
      border-color: #2563eb;
    }
    .qr-code h3 {
      margin: 0 0 8px;
      color: #2563eb;
      font-size: 1.3rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .qr-code h4 {
      margin: 0 0 16px;
      color: #64748b;
      font-size: 0.95rem;
      font-weight: 500;
    }
    .qr-code img {
      width: 100%;
      max-width: 220px;
      height: auto;
      margin: 16px auto;
      display: block;
      border-radius: 8px;
      border: 2px solid #e2e8f0;
      padding: 8px;
      background: white;
    }
    .qr-code p {
      margin-top: 12px;
      color: #94a3b8;
      font-size: 10px;
      word-break: break-all;
      line-height: 1.4;
    }

    /* Print Styles - Optimized for printing */
    @media print {
      body { background: #fff; }
      .poster-container { padding: 20px; }
      .sponsor-strip {
        border: 0;
        padding-bottom: 12px;
        box-shadow: none;
        background: #fff;
      }
      .event-details {
        background: #fff;
      }
      .qr-grid {
        gap: 16px;
        page-break-inside: avoid;
      }
      .qr-code {
        box-shadow: none;
        page-break-inside: avoid;
      }
      .qr-code:hover {
        transform: none;
      }
      .qr-section h2::before {
        content: "";
      }
      @page { margin: 0.5in; }
    }

    /* Responsive - Mobile and tablet */
    @media (max-width: 768px) {
      .poster-container { padding: 24px 16px; }
      .sponsor-strip {
        padding: 16px;
        gap: 16px;
      }
      .sponsor-strip img { max-height: 56px; }
      .event-details {
        padding: 20px 16px;
      }
      .event-details h1 {
        font-size: 2rem;
      }
      .event-meta {
        font-size: 1.1rem;
      }
      .qr-section h2 {
        font-size: 1.6rem;
      }
      .qr-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      .qr-code {
        padding: 20px;
      }
      .qr-code h3 {
        font-size: 1.1rem;
      }
    }

    /* === MVP Essential: Empty/Error States === */
    .empty-state, .error-state {
      text-align: center;
      padding: 48px 24px;
      max-width: 400px;
      margin: 60px auto;
    }
    .empty-state-icon, .error-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.6;
    }
    .empty-state h3, .error-state h3 {
      color: #475569;
      margin-bottom: 8px;
      font-size: 1.25rem;
    }
    .empty-state p, .error-state p {
      color: #64748b;
      margin-bottom: 16px;
      line-height: 1.6;
    }
    .error-state {
      background: #fef2f2;
      border-radius: 12px;
      border: 1px solid #fecaca;
    }
    .error-state h3 { color: #dc2626; }
    .error-state p { color: #b91c1c; }
    .btn-retry {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
    }
    .btn-retry:hover { background: #1d4ed8; }

    /* === MVP Essential: Trust Footer === */
    .site-footer {
      text-align: center;
      padding: 24px 16px;
      margin-top: 40px;
      border-top: 1px solid #e2e8f0;
      color: #94a3b8;
      font-size: 0.7rem;
    }
    .site-footer a {
      color: #64748b;
      text-decoration: none;
    }
    .site-footer a:hover {
      color: #2563eb;
      text-decoration: underline;
    }
    @media print {
      .site-footer {
        border-top: none;
        padding: 12px;
        font-size: 8pt;
      }
    }
  </style>
</head>
<body>
  <div class="poster-container">
    <!-- Sponsor Strip (Top) -->
    <div id="sponsorStrip" class="sponsor-strip" hidden></div>

    <!-- Event Details -->
    <div class="event-details">
      <h1 id="eventName">Event Name</h1>
      <div class="event-meta">
        <div id="eventDate"></div>
        <div id="eventTime"></div>
        <div id="eventLocation"></div>
        <div id="eventEntity"></div>
      </div>
    </div>

    <!-- Event Image -->
    <div id="eventImageContainer" hidden>
      <img id="eventImage" class="event-image" alt="Event Image">
    </div>

    <!-- Event Summary -->
    <div id="eventSummary" class="event-summary" hidden></div>

    <!-- QR Codes Section -->
    <section class="qr-section">
      <h2>Scan to Connect</h2>
      <div id="qrGrid" class="qr-grid"></div>
    </section>
  </div>

  <!-- Trust Footer -->
  <footer class="site-footer">
    <p>Powered by <a href="https://eventangle.com" target="_blank" rel="noopener">EventAngle</a></p>
  </footer>

  <script>
    const BRAND = '<?= brandId ?>';
    const SCOPE = '<?= scope ?>';
    const ID = new URL(location.href).searchParams.get('id');

    // Use shared utilities from SponsorUtils
    const { esc, logEvent, initLogging } = window.SponsorUtils;
    initLogging();

    // === EVENT_CONTRACT.md v1.0 Support ===
    // Helper to check if section is enabled
    function sectionEnabled(sections, key) {
      if (!sections) return true;
      const section = sections[key];
      if (section === null || section === undefined) return true;
      if (typeof section === 'boolean') return section;
      return section.enabled !== false;
    }

    // Render sponsor strip from canonical sponsors[] array
    function renderSponsorStripFromArray(eventId, sponsors) {
      if (!sponsors || !sponsors.length) return;
      const picks = sponsors.filter(s => s.name);
      if (!picks.length) return;

      const strip = document.getElementById('sponsorStrip');
      strip.innerHTML = picks.map(s =>
        s.logoUrl
          ? `<img src="${esc(s.logoUrl)}" alt="${esc(s.name || '')}">`
          : `<strong>${esc(s.name || '')}</strong>`
      ).join('');
      strip.hidden = false;

      // Log sponsor impressions for poster surface
      picks.forEach(s => {
        logEvent({ eventId, surface: 'poster', metric: 'impression', sponsorId: s.id || '' });
      });
    }

    // Legacy sponsor strip rendering (for backward compat)
    function renderSponsorStripLegacy(evt) {
      const picks = (evt?.data?.sponsors || []).filter(s => s?.placements?.posterTop);
      if (!picks.length) return;

      const strip = document.getElementById('sponsorStrip');
      strip.innerHTML = picks.map(s =>
        s.img
          ? `<img src="${esc(s.img)}" alt="${esc(s.name || '')}">`
          : `<strong>${esc(s.name || '')}</strong>`
      ).join('');
      strip.hidden = false;

      // Log sponsor impressions for poster surface
      picks.forEach(s => {
        logEvent({ eventId: evt.id, surface: 'poster', metric: 'impression', sponsorId: s.id || '' });
      });
    }

    function renderEventDetails(evt) {
      // EVENT_CONTRACT.md v1.0: Read from top-level with legacy fallback
      const legacyData = evt?.data || {};
      const name = evt.name || legacyData.name || 'Event Name';
      const dateTime = evt.dateTime || null;
      const location = evt.location || legacyData.location || null;
      const venueName = evt.venueName || legacyData.venueName || null;
      const summary = evt.summary || legacyData.summary || null;
      const entity = legacyData.entity || null; // Legacy field for hosted by
      const imageUrl = legacyData.imageUrl || null; // Legacy field

      // Event Name
      document.getElementById('eventName').textContent = name;

      // Date & Time - parse from ISO dateTime or legacy fields
      const dateEl = document.getElementById('eventDate');
      const timeEl = document.getElementById('eventTime');

      if (dateTime) {
        // Canonical: combined dateTime ISO string
        const dt = new Date(dateTime);
        if (!isNaN(dt.getTime())) {
          dateEl.innerHTML = `<strong>Date:</strong> ${dt.toLocaleDateString('en-US', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
          })}`;
          timeEl.innerHTML = `<strong>Time:</strong> ${dt.toLocaleTimeString('en-US', {
            hour: 'numeric', minute: '2-digit', hour12: true
          })}`;
        }
      } else {
        // Legacy: separate dateISO/timeISO
        if (legacyData.dateISO) {
          const date = new Date(legacyData.dateISO + 'T00:00:00');
          dateEl.innerHTML = `<strong>Date:</strong> ${date.toLocaleDateString('en-US', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
          })}`;
        }
        if (legacyData.timeISO) {
          timeEl.innerHTML = `<strong>Time:</strong> ${legacyData.timeISO}`;
        }
      }

      // Location (show venueName if separate, or combined location)
      const locEl = document.getElementById('eventLocation');
      if (venueName && location && venueName !== location) {
        locEl.innerHTML = `<strong>Location:</strong> ${esc(venueName)} &middot; ${esc(location)}`;
      } else if (location) {
        locEl.innerHTML = `<strong>Location:</strong> ${esc(location)}`;
      } else if (venueName) {
        locEl.innerHTML = `<strong>Location:</strong> ${esc(venueName)}`;
      }

      // Entity (hosted by) - legacy field
      const entityEl = document.getElementById('eventEntity');
      if (entity) {
        entityEl.innerHTML = `<strong>Hosted by:</strong> ${esc(entity)}`;
      }

      // Event Image (legacy)
      if (imageUrl) {
        document.getElementById('eventImage').src = imageUrl;
        document.getElementById('eventImageContainer').hidden = false;
      }

      // Summary
      if (summary) {
        document.getElementById('eventSummary').textContent = summary;
        document.getElementById('eventSummary').hidden = false;
      }
    }

    function renderQRCodes(evt) {
      const el = document.getElementById('qrGrid');
      el.innerHTML = '';

      // EVENT_CONTRACT.md v1.0: Read from top-level with legacy fallback
      const legacyData = evt?.data || {};
      const links = evt?.links || {};

      // QR Code 1: Sign Up (Register) - canonical or legacy
      const signupUrl = evt.signupUrl || legacyData.registerUrl || legacyData.signupUrl;
      if (signupUrl) {
        el.innerHTML += `
          <div class="qr-code">
            <h3>Sign Up</h3>
            <h4>Register Now</h4>
            <img alt="Sign Up QR Code" src="https://quickchart.io/qr?text=${encodeURIComponent(signupUrl)}&size=200&margin=1">
            <p>${esc(signupUrl)}</p>
          </div>
        `;
      }

      // QR Code 2: Public Event Page
      const publicUrl = links.publicUrl;
      if (publicUrl) {
        el.innerHTML += `
          <div class="qr-code">
            <h3>Event Page</h3>
            <h4>View Details</h4>
            <img alt="Public Page QR Code" src="https://quickchart.io/qr?text=${encodeURIComponent(publicUrl)}&size=200&margin=1">
            <p>${esc(publicUrl)}</p>
          </div>
        `;
      }

      // QR Code 3: Check-in URL (if available)
      const checkinUrl = evt.checkinUrl || legacyData.checkinUrl;
      if (checkinUrl) {
        el.innerHTML += `
          <div class="qr-code">
            <h3>Check In</h3>
            <h4>Day-of Check-in</h4>
            <img alt="Check-in QR Code" src="https://quickchart.io/qr?text=${encodeURIComponent(checkinUrl)}&size=200&margin=1">
            <p>${esc(checkinUrl)}</p>
          </div>
        `;
      }

      // Legacy: Promotion Link (could be summaryLink or custom promotion URL)
      if (el.childElementCount < 3) {
        const promoUrl = legacyData.summaryLink || legacyData.bioLink;
        if (promoUrl) {
          el.innerHTML += `
            <div class="qr-code">
              <h3>Learn More</h3>
              <h4>Additional Info</h4>
              <img alt="Promotion QR Code" src="https://quickchart.io/qr?text=${encodeURIComponent(promoUrl)}&size=200&margin=1">
              <p>${esc(promoUrl)}</p>
            </div>
          `;
        }
      }

      // If no QR codes available
      if (el.innerHTML === '') {
        el.innerHTML = '<p style="text-align:center; color:#94a3b8; grid-column: 1 / -1;">No QR codes available. Configure sign-up forms in Admin.</p>';
      }
    }

    function renderPoster(evt) {
      if (!evt) {
        document.querySelector('.poster-container').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <h3>Event Not Found</h3>
            <p>This poster link may be outdated or the event has been removed.</p>
            <a class="btn-retry" href="javascript:history.back()">‚Üê Go Back</a>
          </div>
        `;
        return;
      }

      // Log poster view
      logEvent({ eventId: evt.id, surface: 'poster', metric: 'view', value: 1 });

      // EVENT_CONTRACT.md v1.0: Read from top-level with legacy fallback
      const legacyData = evt?.data || {};
      const sections = evt.sections || legacyData.sections || {};
      const sponsors = evt.sponsors || [];

      // Render sponsors if sections.sponsors is enabled
      if (sectionEnabled(sections, 'sponsors')) {
        if (sponsors.length > 0) {
          renderSponsorStripFromArray(evt.id, sponsors);
        } else {
          renderSponsorStripLegacy(evt);
        }
      }

      renderEventDetails(evt);
      renderQRCodes(evt);

      // Track print events
      window.addEventListener('beforeprint', () => {
        logEvent({ eventId: evt.id, surface: 'poster', metric: 'print', value: 1 });
      });
    }

    google.script.run
      .withSuccessHandler(res => {
        if (res.ok && res.value) {
          renderPoster(res.value);
        } else {
          renderPoster(null);
        }
      })
      .withFailureHandler(() => {
        document.querySelector('.poster-container').innerHTML = `
          <div class="error-state">
            <div class="error-state-icon">‚ö†Ô∏è</div>
            <h3>Trouble Loading</h3>
            <p>We couldn't load this poster right now.</p>
            <button class="btn-retry" onclick="location.reload()">üîÑ Try Again</button>
          </div>
        `;
      })
      .api_get({ brandId: BRAND, scope: SCOPE, id: ID });
  </script>
</body>
</html>
