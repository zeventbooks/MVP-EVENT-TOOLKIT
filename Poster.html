<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> Â· Poster</title>
  <?!= include('Styles'); ?>
  <?!= include('DesignAdapter'); ?>
  <?!= include('DemoMode'); ?>
  <?!= include('SponsorUtils'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="referrer" content="no-referrer"/>
  <style>
    [hidden] { display:none !important; }
    body { background: #fff; }
    .poster-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
      background: #fff;
    }

    /* Enhanced Sponsor Strip */
    .sponsor-strip {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      gap: 24px;
      padding: 20px;
      border-bottom: 3px solid #2563eb;
      margin-bottom: 40px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f8fafc 100%);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .sponsor-strip img {
      max-height: 70px;
      object-fit: contain;
    }
    .sponsor-strip strong {
      color: #1e293b;
      font-size: 1.3em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Enhanced Event Details */
    .event-details {
      text-align: center;
      margin-bottom: 40px;
      padding: 24px;
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border-radius: 12px;
    }
    .event-details h1 {
      color: #2563eb;
      font-size: 2.8rem;
      margin-bottom: 20px;
      line-height: 1.2;
      text-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
    }
    .event-meta {
      font-size: 1.3rem;
      color: #475569;
      margin: 12px 0;
      line-height: 1.8;
    }
    .event-meta strong {
      color: #1e293b;
      font-weight: 700;
    }
    .event-image {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      margin: 24px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .event-summary {
      font-size: 1.1rem;
      line-height: 1.6;
      color: #475569;
      margin: 20px 0;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #2563eb;
    }

    /* Enhanced QR Codes */
    .qr-section {
      margin-top: 48px;
      padding: 32px 0;
      border-top: 3px solid #e2e8f0;
    }
    .qr-section h2 {
      text-align: center;
      color: #1e293b;
      font-size: 2rem;
      margin-bottom: 32px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .qr-section h2::before {
      content: "ðŸ“± ";
      font-size: 1.5em;
    }
    .qr-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 28px;
      margin: 24px 0;
    }
    .qr-code {
      text-align: center;
      padding: 24px;
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border-radius: 16px;
      border: 3px solid #e2e8f0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    .qr-code:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.15);
      border-color: #2563eb;
    }
    .qr-code h3 {
      margin: 0 0 8px;
      color: #2563eb;
      font-size: 1.3rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .qr-code h4 {
      margin: 0 0 16px;
      color: #64748b;
      font-size: 0.95rem;
      font-weight: 500;
    }
    .qr-code img {
      width: 100%;
      max-width: 220px;
      height: auto;
      margin: 16px auto;
      display: block;
      border-radius: 8px;
      border: 2px solid #e2e8f0;
      padding: 8px;
      background: white;
    }
    .qr-code p {
      margin-top: 12px;
      color: #94a3b8;
      font-size: 10px;
      word-break: break-all;
      line-height: 1.4;
    }

    /* Print Styles - Optimized for printing */
    @media print {
      body { background: #fff; }
      .poster-container { padding: 20px; }
      .sponsor-strip {
        border: 0;
        padding-bottom: 12px;
        box-shadow: none;
        background: #fff;
      }
      .event-details {
        background: #fff;
      }
      .qr-grid {
        gap: 16px;
        page-break-inside: avoid;
      }
      .qr-code {
        box-shadow: none;
        page-break-inside: avoid;
      }
      .qr-code:hover {
        transform: none;
      }
      .qr-section h2::before {
        content: "";
      }
      @page { margin: 0.5in; }
    }

    /* Responsive - Mobile and tablet */
    @media (max-width: 768px) {
      .poster-container { padding: 24px 16px; }
      .sponsor-strip {
        padding: 16px;
        gap: 16px;
      }
      .sponsor-strip img { max-height: 56px; }
      .event-details {
        padding: 20px 16px;
      }
      .event-details h1 {
        font-size: 2rem;
      }
      .event-meta {
        font-size: 1.1rem;
      }
      .qr-section h2 {
        font-size: 1.6rem;
      }
      .qr-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      .qr-code {
        padding: 20px;
      }
      .qr-code h3 {
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <div class="poster-container">
    <!-- Sponsor Strip (Top) -->
    <div id="sponsorStrip" class="sponsor-strip" hidden></div>

    <!-- Event Details -->
    <div class="event-details">
      <h1 id="eventName">Event Name</h1>
      <div class="event-meta">
        <div id="eventDate"></div>
        <div id="eventTime"></div>
        <div id="eventLocation"></div>
        <div id="eventEntity"></div>
      </div>
    </div>

    <!-- Event Image -->
    <div id="eventImageContainer" hidden>
      <img id="eventImage" class="event-image" alt="Event Image">
    </div>

    <!-- Event Summary -->
    <div id="eventSummary" class="event-summary" hidden></div>

    <!-- QR Codes Section -->
    <section class="qr-section">
      <h2>Scan to Connect</h2>
      <div id="qrGrid" class="qr-grid"></div>
    </section>
  </div>

  <script>
    const BRAND = '<?= brandId ?>';
    const SCOPE = '<?= scope ?>';
    const ID = new URL(location.href).searchParams.get('id');

    // Use shared utilities from SponsorUtils
    const { esc, logEvent, initLogging } = window.SponsorUtils;
    initLogging();

    function renderSponsorStrip(evt) {
      const picks = (evt?.data?.sponsors || []).filter(s => s?.placements?.posterTop);
      if (!picks.length) return;

      const strip = document.getElementById('sponsorStrip');
      strip.innerHTML = picks.map(s =>
        s.img
          ? `<img src="${esc(s.img)}" alt="${esc(s.name || '')}">`
          : `<strong>${esc(s.name || '')}</strong>`
      ).join('');
      strip.hidden = false;

      // Log sponsor impressions for poster surface
      picks.forEach(s => {
        logEvent({ eventId: evt.id, surface: 'poster', metric: 'impression', sponsorId: s.id || '' });
      });
    }

    function renderEventDetails(evt) {
      const d = evt?.data || {};

      // Event Name
      document.getElementById('eventName').textContent = d.name || 'Event Name';

      // Date & Time
      const dateEl = document.getElementById('eventDate');
      if (d.dateISO) {
        const date = new Date(d.dateISO + 'T00:00:00');
        dateEl.innerHTML = `<strong>Date:</strong> ${date.toLocaleDateString('en-US', {
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        })}`;
      }

      const timeEl = document.getElementById('eventTime');
      if (d.timeISO) {
        timeEl.innerHTML = `<strong>Time:</strong> ${d.timeISO}`;
      }

      // Location
      const locEl = document.getElementById('eventLocation');
      if (d.location) {
        locEl.innerHTML = `<strong>Location:</strong> ${esc(d.location)}`;
      }

      // Entity
      const entityEl = document.getElementById('eventEntity');
      if (d.entity) {
        entityEl.innerHTML = `<strong>Hosted by:</strong> ${esc(d.entity)}`;
      }

      // Event Image
      if (d.imageUrl) {
        document.getElementById('eventImage').src = d.imageUrl;
        document.getElementById('eventImageContainer').hidden = false;
      }

      // Summary
      if (d.summary) {
        document.getElementById('eventSummary').textContent = d.summary;
        document.getElementById('eventSummary').hidden = false;
      }
    }

    function renderQRCodes(evt) {
      const el = document.getElementById('qrGrid');
      el.innerHTML = '';

      const d = evt?.data || {};
      const links = evt?.links || {};

      // QR Code 1: Sign Up (Register)
      const registerUrl = d.registerUrl || d.signupUrl;
      if (registerUrl) {
        el.innerHTML += `
          <div class="qr-code">
            <h3>Sign Up</h3>
            <h4>Register Now</h4>
            <img alt="Sign Up QR Code" src="https://quickchart.io/qr?text=${encodeURIComponent(registerUrl)}&size=200&margin=1">
            <p>${esc(registerUrl)}</p>
          </div>
        `;
      }

      // QR Code 2: Public Event Page
      const publicUrl = links.publicUrl;
      if (publicUrl) {
        el.innerHTML += `
          <div class="qr-code">
            <h3>Event Page</h3>
            <h4>View Details</h4>
            <img alt="Public Page QR Code" src="https://quickchart.io/qr?text=${encodeURIComponent(publicUrl)}&size=200&margin=1">
            <p>${esc(publicUrl)}</p>
          </div>
        `;
      }

      // QR Code 3: Promotion Link (could be summaryLink or custom promotion URL)
      const promoUrl = d.summaryLink || d.bioLink;
      if (promoUrl) {
        el.innerHTML += `
          <div class="qr-code">
            <h3>Learn More</h3>
            <h4>Additional Info</h4>
            <img alt="Promotion QR Code" src="https://quickchart.io/qr?text=${encodeURIComponent(promoUrl)}&size=200&margin=1">
            <p>${esc(promoUrl)}</p>
          </div>
        `;
      }

      // If no QR codes available
      if (el.innerHTML === '') {
        el.innerHTML = '<p style="text-align:center; color:#94a3b8; grid-column: 1 / -1;">No QR codes available. Configure sign-up forms in Admin.</p>';
      }
    }

    function renderPoster(evt) {
      if (!evt) {
        document.querySelector('.poster-container').innerHTML =
          '<p style="text-align:center; color:#94a3b8; padding:40px;">Event not found.</p>';
        return;
      }

      // Log poster view
      logEvent({ eventId: evt.id, surface: 'poster', metric: 'view', value: 1 });

      renderSponsorStrip(evt);
      renderEventDetails(evt);
      renderQRCodes(evt);

      // Track print events
      window.addEventListener('beforeprint', () => {
        logEvent({ eventId: evt.id, surface: 'poster', metric: 'print', value: 1 });
      });
    }

    google.script.run
      .withSuccessHandler(res => {
        if (res.ok && res.value) {
          renderPoster(res.value);
        } else {
          renderPoster(null);
        }
      })
      .withFailureHandler(() => {
        document.querySelector('.poster-container').innerHTML =
          '<p style="text-align:center; color:#ef4444; padding:40px;">Could not load event.</p>';
      })
      .api_get({ brandId: BRAND, scope: SCOPE, id: ID });
  </script>
</body>
</html>
