<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> · Admin</title>
  <?!= include('Styles'); ?>
  <?!= include('DesignAdapter'); ?>
  <?!= include('NUSDK'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
</head>
<body>
  <?!= include('Header'); ?>

  <main id="app" class="container">

    <!-- Create Event Card -->
    <section class="card">
      <h2>Create Event</h2>
      <form id="createForm">
        <div class="form-group">
          <label>Event Name</label>
          <input id="name" type="text" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Date</label>
            <input id="dateISO" type="date" required>
          </div>
          <div class="form-group">
            <label>Signup URL (optional)</label>
            <input id="signupUrl" type="url">
          </div>
        </div>
        <div class="button-group">
          <button class="btn-primary" type="submit">Create Event</button>
          <button class="btn-secondary" type="button" onclick="clearForm()">Clear</button>
        </div>
      </form>
    </section>

    <!-- Event Card (appears after event is selected/created) -->
    <section id="eventCard" class="card" style="display:none;">
      <h2>Event Details</h2>
      <div id="eventInfo"></div>

      <h3>Links</h3>
      <div class="events-grid">
        <div class="event-card">
          <h3>Public (Mobile)</h3>
          <p><a id="lnkPublic" target="_blank" rel="noopener"></a></p>
          <button class="btn-secondary" onclick="copy('lnkPublic')">Copy Link</button>
        </div>
        <div class="event-card">
          <h3>Display (TV)</h3>
          <p><a id="lnkDisplay" target="_blank" rel="noopener"></a></p>
          <button class="btn-secondary" onclick="copy('lnkDisplay')">Copy Link</button>
        </div>
        <div class="event-card">
          <h3>Poster (Print/QR)</h3>
          <p><a id="lnkPoster" target="_blank" rel="noopener"></a></p>
          <button class="btn-secondary" onclick="copy('lnkPoster')">Copy Link</button>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="configureDisplay()">Configure Display & Sponsors</button>
        <button class="btn-secondary" onclick="configureSignup()">Configure Sign-Up Forms</button>
      </div>
    </section>

    <!-- Sign Up Cards -->
    <section id="signupCard" class="card" style="display:none;">
      <h2>Sign-Up Forms Configuration</h2>

      <!-- Pre-Event: Register -->
      <div class="event-card">
        <h3>Pre-Event: Registration</h3>
        <p>Allow users to register before the event</p>
        <div class="form-group">
          <label>Registration Form URL</label>
          <input type="url" id="registerUrl" placeholder="https://forms.google.com/...">
        </div>
        <button class="btn-secondary" onclick="saveSignupForm('register')">Save</button>
      </div>

      <!-- Event: Check-in -->
      <div class="event-card">
        <h3>During Event: Check-In</h3>
        <p>Allow attendees to check in when they arrive</p>
        <div class="form-group">
          <label>Check-In Form URL</label>
          <input type="url" id="checkinUrl" placeholder="https://forms.google.com/...">
        </div>
        <button class="btn-secondary" onclick="saveSignupForm('checkin')">Save</button>
      </div>

      <!-- Event: Walk-in -->
      <div class="event-card">
        <h3>During Event: Walk-In Registration</h3>
        <p>Allow walk-ins to register on the spot</p>
        <div class="form-group">
          <label>Walk-In Form URL</label>
          <input type="url" id="walkinUrl" placeholder="https://forms.google.com/...">
        </div>
        <button class="btn-secondary" onclick="saveSignupForm('walkin')">Save</button>
      </div>

      <!-- Post-Event: Survey -->
      <div class="event-card">
        <h3>Post-Event: Survey</h3>
        <p>Collect feedback after the event</p>
        <div class="form-group">
          <label>Survey Form URL</label>
          <input type="url" id="surveyUrl" placeholder="https://forms.google.com/...">
        </div>
        <button class="btn-secondary" onclick="saveSignupForm('survey')">Save</button>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="closeSignupConfig()">Done</button>
      </div>
    </section>

    <!-- Display & Sponsors Configuration -->
    <section id="displayCard" class="card" style="display:none;">
      <h2>Display & Sponsors Configuration</h2>

      <h3>Display Mode</h3>
      <div class="form-group">
        <label>Mode</label>
        <select id="displayMode" onchange="toggleDisplayMode()">
          <option value="public">Public (Mirror mobile page)</option>
          <option value="dynamic">Dynamic (Carousel with URLs)</option>
        </select>
      </div>

      <div id="dynamicConfig" style="display:none;">
        <h4>Carousel URLs</h4>
        <p class="muted">Add URLs to display. YouTube and Vimeo are supported. Instagram and other restricted iframes will be skipped automatically.</p>
        <div id="urlList"></div>
        <button class="btn-secondary" onclick="addUrl()">Add URL</button>
      </div>

      <h3>Sponsors</h3>
      <div id="sponsorList"></div>
      <button class="btn-secondary" onclick="addSponsor()">Add Sponsor</button>

      <div class="button-group">
        <button class="btn-primary" onclick="saveDisplayConfig()">Save Configuration</button>
        <button class="btn-secondary" onclick="closeDisplayConfig()">Cancel</button>
      </div>
    </section>

  </main>

  <div id="overlay" class="loading-overlay"><div class="spinner"></div><p>Working…</p></div>

  <script>
    const TENANT = '<?= tenantId ?>';
    const SCOPE = '<?= scope ?>';
    let currentEventId = null;

    // Create Event
    document.getElementById('createForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      overlay(true);

      const res = await NU.rpc('api_create', {
        tenantId: TENANT,
        scope: SCOPE,
        templateId: 'event',
        adminKey: getAdminKey(),
        idemKey: crypto.randomUUID?.() || `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        data: {
          name: document.getElementById('name').value.trim(),
          dateISO: document.getElementById('dateISO').value,
          signupUrl: document.getElementById('signupUrl').value.trim()
        }
      });

      overlay(false);

      if (!res.ok) {
        alert(`Error: ${res.message}`);
        return;
      }

      currentEventId = res.value.id;
      showEventCard(res.value);
    });

    function showEventCard(event) {
      const { publicUrl, posterUrl, displayUrl } = event.links;

      setLink('lnkPublic', publicUrl);
      setLink('lnkDisplay', displayUrl);
      setLink('lnkPoster', posterUrl);

      document.getElementById('eventCard').style.display = '';
      document.getElementById('eventInfo').innerHTML = `
        <p><strong>Name:</strong> ${NU.esc(event.data?.name || '')}</p>
        <p><strong>Date:</strong> ${NU.esc(event.data?.dateISO || '')}</p>
        <p><strong>ID:</strong> ${event.id}</p>
      `;
    }

    function setLink(id, url) {
      const a = document.getElementById(id);
      a.textContent = url;
      a.href = url;
    }

    async function copy(id) {
      const url = document.getElementById(id).textContent;
      await navigator.clipboard.writeText(url);
      alert('Link copied!');
    }

    function clearForm() {
      document.getElementById('createForm').reset();
      document.getElementById('eventCard').style.display = 'none';
      document.getElementById('signupCard').style.display = 'none';
      document.getElementById('displayCard').style.display = 'none';
      currentEventId = null;
    }

    // Configure Sign-Up Forms
    function configureSignup() {
      document.getElementById('signupCard').style.display = '';
      loadSignupForms();
    }

    async function loadSignupForms() {
      if (!currentEventId) return;
      overlay(true);
      const res = await NU.rpc('api_get', { tenantId: TENANT, scope: SCOPE, id: currentEventId });
      overlay(false);

      if (res.ok && res.value) {
        const forms = res.value.data?.signupForms || {};
        document.getElementById('registerUrl').value = forms.register || '';
        document.getElementById('checkinUrl').value = forms.checkin || '';
        document.getElementById('walkinUrl').value = forms.walkin || '';
        document.getElementById('surveyUrl').value = forms.survey || '';
      }
    }

    async function saveSignupForm(type) {
      if (!currentEventId) return;

      const forms = {
        register: document.getElementById('registerUrl').value.trim(),
        checkin: document.getElementById('checkinUrl').value.trim(),
        walkin: document.getElementById('walkinUrl').value.trim(),
        survey: document.getElementById('surveyUrl').value.trim()
      };

      overlay(true);
      const res = await NU.rpc('api_updateEventData', {
        tenantId: TENANT,
        scope: SCOPE,
        id: currentEventId,
        adminKey: getAdminKey(),
        data: { signupForms: forms }
      });
      overlay(false);

      if (res.ok) {
        alert('Sign-up form saved!');
      } else {
        alert(`Error: ${res.message}`);
      }
    }

    function closeSignupConfig() {
      document.getElementById('signupCard').style.display = 'none';
    }

    // Configure Display & Sponsors
    function configureDisplay() {
      document.getElementById('displayCard').style.display = '';
      loadDisplayConfig();
    }

    async function loadDisplayConfig() {
      if (!currentEventId) return;
      overlay(true);
      const res = await NU.rpc('api_get', { tenantId: TENANT, scope: SCOPE, id: currentEventId });
      overlay(false);

      if (res.ok && res.value) {
        const display = res.value.data?.display || {};
        const sponsors = res.value.data?.sponsors || [];

        document.getElementById('displayMode').value = display.mode || 'public';
        toggleDisplayMode();

        if (display.urls) {
          renderUrls(display.urls);
        }

        renderSponsors(sponsors);
      }
    }

    function toggleDisplayMode() {
      const mode = document.getElementById('displayMode').value;
      document.getElementById('dynamicConfig').style.display = mode === 'dynamic' ? '' : 'none';
    }

    function renderUrls(urls) {
      const list = document.getElementById('urlList');
      list.innerHTML = '';
      urls.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
          <label>URL ${i + 1}</label>
          <input type="url" value="${item.url || ''}" class="url-input">
          <input type="number" value="${item.seconds || 10}" min="5" max="300" placeholder="Seconds" class="url-seconds" style="width:100px;margin-top:4px;">
        `;
        list.appendChild(div);
      });
    }

    function addUrl() {
      const list = document.getElementById('urlList');
      const div = document.createElement('div');
      div.className = 'form-group';
      div.innerHTML = `
        <label>New URL</label>
        <input type="url" placeholder="https://..." class="url-input">
        <input type="number" value="10" min="5" max="300" placeholder="Seconds" class="url-seconds" style="width:100px;margin-top:4px;">
      `;
      list.appendChild(div);
    }

    function renderSponsors(sponsors) {
      const list = document.getElementById('sponsorList');
      list.innerHTML = '';
      sponsors.forEach((sp, i) => {
        const div = document.createElement('div');
        div.className = 'event-card';
        div.innerHTML = `
          <h4>Sponsor ${i + 1}</h4>
          <input type="text" placeholder="Name" value="${sp.name || ''}" class="sp-name" style="width:100%;margin-bottom:4px;">
          <input type="url" placeholder="URL" value="${sp.url || ''}" class="sp-url" style="width:100%;margin-bottom:4px;">
          <input type="url" placeholder="Image URL" value="${sp.img || ''}" class="sp-img" style="width:100%;margin-bottom:8px;">
          <label><input type="checkbox" class="sp-posterTop" ${sp.placements?.posterTop ? 'checked' : ''}> Poster Top</label><br>
          <label><input type="checkbox" class="sp-tvTop" ${sp.placements?.tvTop ? 'checked' : ''}> TV Top</label><br>
          <label><input type="checkbox" class="sp-tvSide" ${sp.placements?.tvSide ? 'checked' : ''}> TV Side</label><br>
          <label><input type="checkbox" class="sp-mobileBanner" ${sp.placements?.mobileBanner ? 'checked' : ''}> Mobile Banner</label>
        `;
        list.appendChild(div);
      });
    }

    function addSponsor() {
      const list = document.getElementById('sponsorList');
      const div = document.createElement('div');
      div.className = 'event-card';
      div.innerHTML = `
        <h4>New Sponsor</h4>
        <input type="text" placeholder="Name" class="sp-name" style="width:100%;margin-bottom:4px;">
        <input type="url" placeholder="URL" class="sp-url" style="width:100%;margin-bottom:4px;">
        <input type="url" placeholder="Image URL" class="sp-img" style="width:100%;margin-bottom:8px;">
        <label><input type="checkbox" class="sp-posterTop"> Poster Top</label><br>
        <label><input type="checkbox" class="sp-tvTop"> TV Top</label><br>
        <label><input type="checkbox" class="sp-tvSide"> TV Side</label><br>
        <label><input type="checkbox" class="sp-mobileBanner"> Mobile Banner</label>
      `;
      list.appendChild(div);
    }

    async function saveDisplayConfig() {
      if (!currentEventId) return;

      const mode = document.getElementById('displayMode').value;
      const urls = [];

      if (mode === 'dynamic') {
        document.querySelectorAll('#urlList .form-group').forEach(row => {
          const url = row.querySelector('.url-input').value.trim();
          const seconds = Number(row.querySelector('.url-seconds').value || 10);
          if (url) urls.push({ url, seconds });
        });
      }

      const sponsors = [];
      document.querySelectorAll('#sponsorList .event-card').forEach(row => {
        const name = row.querySelector('.sp-name').value.trim();
        if (!name) return;
        sponsors.push({
          id: crypto.randomUUID?.() || `sp-${Date.now()}`,
          name,
          url: row.querySelector('.sp-url').value.trim(),
          img: row.querySelector('.sp-img').value.trim(),
          placements: {
            posterTop: row.querySelector('.sp-posterTop').checked,
            tvTop: row.querySelector('.sp-tvTop').checked,
            tvSide: row.querySelector('.sp-tvSide').checked,
            mobileBanner: row.querySelector('.sp-mobileBanner').checked
          }
        });
      });

      overlay(true);
      const res = await NU.rpc('api_updateEventData', {
        tenantId: TENANT,
        scope: SCOPE,
        id: currentEventId,
        adminKey: getAdminKey(),
        data: { display: { mode, urls }, sponsors }
      });
      overlay(false);

      if (res.ok) {
        alert('Display configuration saved!');
      } else {
        alert(`Error: ${res.message}`);
      }
    }

    function closeDisplayConfig() {
      document.getElementById('displayCard').style.display = 'none';
    }

    // Helpers
    function overlay(on) {
      document.getElementById('overlay').style.display = on ? 'flex' : 'none';
    }

    function getAdminKey() {
      const k = sessionStorage.getItem('ADMIN_KEY:' + TENANT) || prompt('Admin key for ' + TENANT);
      if (k) sessionStorage.setItem('ADMIN_KEY:' + TENANT, k);
      return k || '';
    }
  </script>
</body>
</html>
