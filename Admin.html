<!--
================================================================================
MVP SURFACE - Focus Group Critical
================================================================================
Page: Admin.html
Purpose: Event management dashboard for organizers
Status: LOCKED for MVP v1.0

DO NOT modify this file's contracts without updating:
  - NUSDK.html (API client)
  - tests/e2e/* (end-to-end tests)
  - tests/unit/* (unit tests)

Related MVP Surfaces: Poster, Display, Public, Sponsor, SharedReport
================================================================================
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> ¬∑ Admin</title>
  <?!= include('Styles'); ?>
  <?!= include('DesignAdapter'); ?>
  <?!= include('NUSDK'); ?>
  <?!= include('DemoMode'); ?>
  <?!= include('CollapsibleSections'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="referrer" content="no-referrer"/>
  <style>
    /* MVP Template Picker - matches .event-card pattern */
    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }
    .template-card {
      padding: 16px 12px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-left: 3px solid #94a3b8;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .template-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-left-color: #2563eb;
      background: #fff;
    }
    .template-card.selected {
      border-left-color: #2563eb;
      border-color: #bfdbfe;
      background: #eff6ff;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }
    .template-card .template-icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }
    .template-card .template-name {
      font-weight: 600;
      font-size: 0.9rem;
      color: #1e293b;
      margin-bottom: 4px;
    }
    .template-card .template-desc {
      font-size: 0.75rem;
      color: #64748b;
      line-height: 1.3;
    }
    .template-card .template-sections {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin-top: 8px;
      font-size: 0.7rem;
      opacity: 0.7;
    }
    .template-card .template-sections span {
      padding: 2px 4px;
      background: #e2e8f0;
      border-radius: 4px;
    }
    .template-card .template-sections span.off {
      opacity: 0.4;
      text-decoration: line-through;
    }
    .template-card .recommended-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #2563eb;
      color: white;
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: 8px;
      font-weight: 600;
    }
    .template-card {
      position: relative;
    }
    .template-loading {
      grid-column: 1 / -1;
      text-align: center;
      padding: 24px;
      color: #64748b;
    }
    /* Section toggles grid */
    .sections-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
    }
    .section-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .section-toggle:hover {
      background: #f1f5f9;
    }
    .section-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #2563eb;
    }
    .section-toggle .section-label {
      font-size: 0.875rem;
      color: #475569;
    }
    .section-toggle:has(input:checked) {
      background: #eff6ff;
      border-color: #bfdbfe;
    }
    .section-toggle:has(input:checked) .section-label {
      color: #1e40af;
      font-weight: 500;
    }
    /* Modified from template indicator */
    .sections-modified-notice {
      display: none;
      margin-top: 12px;
      padding: 8px 12px;
      background: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: 8px;
      font-size: 0.8rem;
      color: #92400e;
    }
    .sections-modified-notice.visible {
      display: block;
    }
  </style>
</head>
<body>
  <?!= include('Header'); ?>
  <?!= include('HeaderInit'); ?>

  <main id="app" class="container">

    <!-- Event Lifecycle Dashboard -->
    <section class="card" id="dashboardCard" style="display:none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="margin: 0;">Event Dashboard</h2>
      </div>
      <div id="eventPhaseIndicator"></div>

      <!-- Statistics Section -->
      <div class="subsection">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <h3>Statistics</h3>
          <span class="collapsible-icon">‚ñº</span>
        </div>
        <div class="collapsible-content">
          <div class="stats-grid" style="margin-top: 20px;">
        <div class="stat-card blue">
          <div class="stat-value" id="statViews">-</div>
          <div class="stat-label">Total Views</div>
        </div>
        <div class="stat-card green">
          <div class="stat-value" id="statImpressions">-</div>
          <div class="stat-label">Sponsor Impressions</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-value" id="statCTR">-</div>
          <div class="stat-label">Click-Through Rate</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-value" id="statEngagement">-</div>
          <div class="stat-label">Engagement Score</div>
        </div>
      </div>
        </div>
      </div>

      <!-- Event Lifecycle Section -->
      <div class="subsection">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <h3>Event Lifecycle</h3>
          <span class="collapsible-icon">‚ñº</span>
        </div>
        <div class="collapsible-content">
      <div class="metric-card">
        <div class="metric-header">
          <span class="metric-title">Pre-Event Phase</span>
          <span class="phase-indicator pre-event">Preparation</span>
        </div>
        <p style="color: #64748b; font-size: 14px; margin-top: 8px;">
          Advertising with sponsors, creating posters, setting up displays, and getting the public to register
        </p>
        <div class="progress-bar">
          <div class="progress-bar-fill" id="preEventProgress" style="width: 0%"></div>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <span class="metric-title">Event Day</span>
          <span class="phase-indicator event-day">Active</span>
        </div>
        <p style="color: #64748b; font-size: 14px; margin-top: 8px;">
          Public reminders, displays at entrance, check-in at door, sponsor banners rotating on screens
        </p>
        <div class="progress-bar">
          <div class="progress-bar-fill green" id="eventDayProgress" style="width: 0%"></div>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <span class="metric-title">Post-Event Phase</span>
          <span class="phase-indicator post-event">Analytics</span>
        </div>
        <p style="color: #64748b; font-size: 14px; margin-top: 8px;">
          CTR analysis, sponsor impressions per screen/time/location, ROI calculations
        </p>
        <div class="progress-bar">
          <div class="progress-bar-fill orange" id="postEventProgress" style="width: 0%"></div>
        </div>
      </div>
        </div>
      </div>
    </section>

    <!-- Create Event Card -->
    <section class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="margin: 0;">Create Event</h2>
        <a href="?page=wizard" style="color: #2563eb; text-decoration: none; font-size: 14px; font-weight: 500;">
          ‚Üê Simple Mode
        </a>
      </div>
      <form id="createForm">
        <!-- Event Template Section (MVP) -->
        <div class="subsection">
          <div class="collapsible-header" onclick="toggleSection(this)">
            <h3>Event Template</h3>
            <span class="collapsible-icon">‚ñº</span>
          </div>
          <div class="collapsible-content">
            <div class="form-group">
              <label>Choose a Template</label>
              <p class="muted" style="margin-bottom: 12px;">Templates pre-configure sections and defaults for different event types</p>
              <div id="templatePicker" class="template-grid">
                <!-- Populated by JS -->
                <div class="template-loading">Loading templates...</div>
              </div>
              <input type="hidden" id="templateId" value="custom">
            </div>
          </div>
        </div>

        <!-- Section Toggles (MVP) -->
        <div class="subsection">
          <div class="collapsible-header" onclick="toggleSection(this)">
            <h3>Sections</h3>
            <span class="collapsible-icon">‚ñº</span>
          </div>
          <div class="collapsible-content">
            <p class="muted" style="margin-bottom: 12px;">Choose which sections to show on your event page</p>
            <div class="sections-grid" id="sectionsGrid">
              <label class="section-toggle">
                <input type="checkbox" id="sectionVideo" checked>
                <span class="section-label">üé¨ Video</span>
              </label>
              <label class="section-toggle">
                <input type="checkbox" id="sectionMap" checked>
                <span class="section-label">üìç Map</span>
              </label>
              <label class="section-toggle">
                <input type="checkbox" id="sectionSchedule" checked>
                <span class="section-label">üìÖ Schedule</span>
              </label>
              <label class="section-toggle">
                <input type="checkbox" id="sectionSponsors" checked>
                <span class="section-label">ü§ù Sponsors</span>
              </label>
              <label class="section-toggle">
                <input type="checkbox" id="sectionNotes" checked>
                <span class="section-label">üìù Notes</span>
              </label>
              <label class="section-toggle">
                <input type="checkbox" id="sectionGallery" checked>
                <span class="section-label">üñºÔ∏è Gallery</span>
              </label>
            </div>
            <div id="sectionsModifiedNotice" class="sections-modified-notice">
              ‚ö†Ô∏è Sections modified from template defaults
            </div>
          </div>
        </div>

        <!-- Core Event Details Section (MVP Required) -->
        <div class="subsection">
          <div class="collapsible-header" onclick="toggleSection(this)">
            <h3>Core Event Details</h3>
            <span class="collapsible-icon">‚ñº</span>
          </div>
          <div class="collapsible-content">
            <div class="form-group">
              <label>Event Name *</label>
              <input id="name" type="text" required placeholder="Enter event name">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Event Date *</label>
                <input id="startDateISO" type="date" required>
              </div>
              <div class="form-group">
                <label>Venue *</label>
                <input id="venue" type="text" required placeholder="Venue name or address">
              </div>
            </div>

            <div class="form-group">
              <label>Primary CTA Label</label>
              <input id="ctaLabel" type="text" value="Sign Up" placeholder="e.g., Sign Up, Register, Join">
              <small style="color:#64748b;">This appears on the main call-to-action button</small>
            </div>
          </div>
        </div>

        <!-- Settings Section (MVP Required) -->
        <div class="subsection">
          <div class="collapsible-header" onclick="toggleSection(this)">
            <h3>Display Settings</h3>
            <span class="collapsible-icon">‚ñº</span>
          </div>
          <div class="collapsible-content">
            <p style="color:#64748b; font-size:0.9rem; margin-bottom:12px;">Control what sections are visible on event pages</p>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="showSchedule">
                <span>Show Schedule</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="showStandings">
                <span>Show Standings</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="showBracket">
                <span>Show Bracket</span>
              </label>
            </div>
          </div>
        </div>

        <!-- V2 FIELDS: Hidden but preserved in event object -->
        <!-- Summary Section (V2 - Hidden) -->
        <div class="subsection" id="v2SummarySection" style="display:none;">
          <div class="collapsible-header" onclick="toggleSection(this)">
            <h3>Summary</h3>
            <span class="collapsible-icon">‚ñº</span>
          </div>
          <div class="collapsible-content">
            <div class="form-group">
              <label>Summary</label>
              <textarea id="summary" placeholder="Brief event description"></textarea>
            </div>
            <div class="form-group">
              <label>Summary Link</label>
              <input id="summaryLink" type="url" placeholder="https://...">
            </div>
          </div>
        </div>

        <!-- Media Section (V2 - Hidden) -->
        <div class="subsection" id="v2MediaSection" style="display:none;">
          <div class="collapsible-header" onclick="toggleSection(this)">
            <h3>Media</h3>
            <span class="collapsible-icon">‚ñº</span>
          </div>
          <div class="collapsible-content">
            <div class="form-group">
              <label>Event Image URL</label>
              <input id="imageUrl" type="url" placeholder="https://...">
            </div>
            <div class="form-group">
              <label>Video URL</label>
              <input id="videoUrl" type="url" placeholder="YouTube, Vimeo, etc.">
            </div>
            <div class="form-group">
              <label>Gallery URLs</label>
              <textarea id="galleryUrls" placeholder="Comma-separated image URLs"></textarea>
            </div>
          </div>
        </div>

        <!-- Bio Section (V2 - Hidden) -->
        <div class="subsection" id="v2BioSection" style="display:none;">
          <div class="collapsible-header" onclick="toggleSection(this)">
            <h3>Bio</h3>
            <span class="collapsible-icon">‚ñº</span>
          </div>
          <div class="collapsible-content">
            <div class="form-group">
              <label>Bio</label>
              <textarea id="bio" placeholder="Detailed event or organizer bio"></textarea>
            </div>
            <div class="form-group">
              <label>Bio Link</label>
              <input id="bioLink" type="url" placeholder="https://...">
            </div>
          </div>
        </div>

        <!-- League & Broadcast Section (V2 - Hidden) -->
        <div class="subsection" id="leagueBroadcastPanel" data-template-filter="rec_league,custom">
          <div class="collapsible-header" onclick="toggleSection(this)">
            <h3>League & Broadcast</h3>
            <span class="collapsible-icon">‚ñº</span>
          </div>
          <div class="collapsible-content">
            <p class="muted" style="margin-bottom: 12px;">Add league schedule, standings, and broadcast information</p>

            <!-- Core League Links -->
            <div class="form-row">
              <div class="form-group">
                <label>üìÖ Schedule URL</label>
                <input id="scheduleUrl" type="url" placeholder="https://...">
                <small class="muted">Link to full schedule or season calendar</small>
              </div>
              <div class="form-group">
                <label>üìä Standings URL</label>
                <input id="standingsUrl" type="url" placeholder="https://...">
                <small class="muted">Link to current standings or rankings</small>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>üèÜ Bracket URL</label>
                <input id="bracketUrl" type="url" placeholder="https://...">
                <small class="muted">Tournament bracket or playoff tree</small>
              </div>
              <div class="form-group">
                <label>üìà Stats URL</label>
                <input id="statsUrl" type="url" placeholder="https://...">
                <small class="muted">Stats hub (e.g., BocceLabs league page)</small>
              </div>
            </div>

            <!-- Broadcast Links -->
            <div class="form-row">
              <div class="form-group">
                <label>üì∫ Scoreboard URL</label>
                <input id="scoreboardUrl" type="url" placeholder="https://...">
                <small class="muted">Live scoreboard or game center</small>
              </div>
              <div class="form-group">
                <label>üé• Stream URL</label>
                <input id="streamUrl" type="url" placeholder="https://...">
                <small class="muted">Live or VOD stream (YouTube, Twitch, BBN)</small>
              </div>
            </div>

            <!-- Provider Integration -->
            <div class="form-row">
              <div class="form-group">
                <label>Provider</label>
                <select id="providerName">
                  <option value="">-- Select Provider --</option>
                  <option value="BocceLabs">BocceLabs</option>
                  <option value="BBN">BBN (Bocce Broadcast Network)</option>
                  <option value="Custom">Custom</option>
                  <option value="None">None</option>
                </select>
                <small class="muted">External league platform if applicable</small>
              </div>
              <div class="form-group">
                <label>Provider League ID</label>
                <input id="providerLeagueId" type="text" placeholder="External league ID">
                <small class="muted">ID from the league platform (optional)</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Template-Specific Fields (MVP) -->
        <div class="subsection">
          <div class="collapsible-header collapsed" onclick="toggleSection(this)">
            <h3>Additional Links</h3>
            <span class="collapsible-icon">‚ñº</span>
          </div>
          <div class="collapsible-content" style="display: none;">
            <p class="muted" style="margin-bottom: 12px;">Optional fields based on your event type</p>

            <!-- Registration & Tickets -->
            <div class="form-row">
              <div class="form-group">
                <label>üéüÔ∏è Ticket URL</label>
                <input id="ticketUrl" type="url" placeholder="Ticket purchase link">
              </div>
              <div class="form-group">
                <label>üíù Donation URL</label>
                <input id="donationUrl" type="url" placeholder="Donation page link">
              </div>
            </div>

            <!-- Photos & Registry -->
            <div class="form-row">
              <div class="form-group">
                <label>üì∏ Photo Album URL</label>
                <input id="albumUrl" type="url" placeholder="Google Photos, Flickr, etc.">
              </div>
              <div class="form-group">
                <label>üéÅ Gift Registry URL</label>
                <input id="registryUrl" type="url" placeholder="Amazon, Zola, etc.">
              </div>
            </div>

            <!-- Vendors (League fields moved to League & Broadcast panel) -->
            <div class="form-row">
              <div class="form-group">
                <label>üõí Vendor List URL</label>
                <input id="vendorListUrl" type="url" placeholder="List of vendors">
              </div>
              <div class="form-group">
                <!-- Empty for layout balance -->
              </div>
            </div>

            <!-- Fundraising -->
            <div class="form-row">
              <div class="form-group">
                <label>üéØ Fundraising Goal ($)</label>
                <input id="goalAmount" type="number" placeholder="5000">
              </div>
              <div class="form-group">
                <label>üí∞ Amount Raised ($)</label>
                <input id="raisedAmount" type="number" placeholder="2500">
              </div>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button class="btn-primary" type="submit">Create Event</button>
          <button class="btn-secondary" type="button" onclick="clearForm()">Clear</button>
          <? if (demoMode && ZEB.DEMO_MODE.showPrefillButton) { ?>
          <button class="demo-prefill-btn" type="button" onclick="window.demoFillSampleEvent && window.demoFillSampleEvent()">
            ‚ú® Fill Sample Data
          </button>
          <? } ?>
        </div>
      </form>
    </section>

    <!-- Event Card (appears after event is selected/created) -->
    <section id="eventCard" class="card" style="display:none;">
      <h2>Event Details</h2>
      <div id="eventInfo"></div>

      <h3>Links</h3>
      <div class="events-grid">
        <div class="event-card">
          <h3>Public (Mobile)</h3>
          <p><a id="lnkPublic" target="_blank" rel="noopener"></a></p>
          <button class="btn-secondary" onclick="copy('lnkPublic')">Copy Link</button>
        </div>
        <div class="event-card">
          <h3>Display (TV)</h3>
          <p><a id="lnkDisplay" target="_blank" rel="noopener"></a></p>
          <button class="btn-secondary" onclick="copy('lnkDisplay')">Copy Link</button>
        </div>
        <div class="event-card">
          <h3>Poster (Print/QR)</h3>
          <p><a id="lnkPoster" target="_blank" rel="noopener"></a></p>
          <button class="btn-secondary" onclick="copy('lnkPoster')">Copy Link</button>
        </div>
        <div class="event-card">
          <h3>üìä Shared Analytics</h3>
          <p><a id="lnkReport" target="_blank" rel="noopener"></a></p>
          <button class="btn-secondary" onclick="copy('lnkReport')">Copy Link</button>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="configureDisplay()">Configure Display & Sponsors</button>
        <button class="btn-secondary" onclick="configureSignup()">Configure Sign-Up Forms</button>
        <button class="btn-secondary <? if (demoMode && ZEB.DEMO_MODE.highlightNewFeatures) { ?>demo-new-feature<? } ?>" onclick="openFormsTemplates()">
          Google Forms Templates
          <? if (demoMode && ZEB.DEMO_MODE.highlightNewFeatures) { ?><span class="demo-new-badge">NEW</span><? } ?>
        </button>
      </div>
    </section>

    <!-- Sign Up Forms (Compact) -->
    <section id="signupCard" class="card" style="display:none;">
      <h2>Sign-Up Forms Configuration</h2>
      <p class="muted">Configure Google Forms or other sign-up links for different event phases</p>

      <div class="form-row">
        <!-- Pre-Event: Register -->
        <div class="form-group">
          <label><strong>Pre-Event:</strong> Registration</label>
          <input type="url" id="registerUrl" placeholder="https://forms.google.com/...">
          <small class="muted">Allow users to register before the event</small>
        </div>

        <!-- Event: Check-in -->
        <div class="form-group">
          <label><strong>During Event:</strong> Check-In</label>
          <input type="url" id="checkinUrl" placeholder="https://forms.google.com/...">
          <small class="muted">Attendees check in on arrival</small>
        </div>
      </div>

      <div class="form-row">
        <!-- Event: Walk-in -->
        <div class="form-group">
          <label><strong>During Event:</strong> Walk-In</label>
          <input type="url" id="walkinUrl" placeholder="https://forms.google.com/...">
          <small class="muted">Walk-ins register on the spot</small>
        </div>

        <!-- Post-Event: Survey -->
        <div class="form-group">
          <label><strong>Post-Event:</strong> Survey</label>
          <input type="url" id="surveyUrl" placeholder="https://forms.google.com/...">
          <small class="muted">Collect feedback after the event</small>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="saveAllSignupForms()">Save All Forms</button>
        <button class="btn-secondary" onclick="closeSignupConfig()">Cancel</button>
      </div>
    </section>

    <!-- Google Forms Templates -->
    <section id="formsCard" class="card" style="display:none;">
      <h2>Google Forms Templates</h2>
      <p class="muted">Create pre-built forms for check-in, walk-in, and surveys with automatic shortlink generation</p>

      <div class="form-row">
        <!-- Check-In Form -->
        <div class="form-group">
          <label><strong>Check-In Form</strong></label>
          <small class="muted">Quick check-in for registered attendees</small>
          <button class="btn-secondary" onclick="createFormTemplate('check-in')" style="margin-top: 8px;">
            Create Check-In Form
          </button>
          <div id="checkin-form-display" style="margin-top: 8px;"></div>
        </div>

        <!-- Walk-In Form -->
        <div class="form-group">
          <label><strong>Walk-In Registration Form</strong></label>
          <small class="muted">Registration for walk-in attendees</small>
          <button class="btn-secondary" onclick="createFormTemplate('walk-in')" style="margin-top: 8px;">
            Create Walk-In Form
          </button>
          <div id="walkin-form-display" style="margin-top: 8px;"></div>
        </div>
      </div>

      <div class="form-row">
        <!-- Survey Form -->
        <div class="form-group">
          <label><strong>Post-Event Survey</strong></label>
          <small class="muted">Feedback and satisfaction survey</small>
          <button class="btn-secondary" onclick="createFormTemplate('survey')" style="margin-top: 8px;">
            Create Survey Form
          </button>
          <div id="survey-form-display" style="margin-top: 8px;"></div>
        </div>

        <div class="form-group">
          <label><strong>Instructions</strong></label>
          <small class="muted">
            1. Click a button to create a form from template<br>
            2. Forms are created with response spreadsheets<br>
            3. Copy the shortlink to share with attendees<br>
            4. Use "Edit Form" to customize questions
          </small>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-secondary" onclick="closeFormsTemplates()">Close</button>
      </div>
    </section>

    <!-- Display & Sponsors Configuration -->
    <section id="displayCard" class="card" style="display:none;">
      <h2>Display & Sponsors Configuration</h2>

      <h3>Display Mode</h3>
      <div class="form-group">
        <label>Mode</label>
        <select id="displayMode" onchange="toggleDisplayMode()">
          <option value="public">Public (Mirror mobile page)</option>
          <option value="dynamic">Dynamic (Carousel with URLs)</option>
        </select>
      </div>

      <div id="dynamicConfig" style="display:none;">
        <h4>Carousel URLs</h4>
        <p class="muted">Add URLs to display. YouTube and Vimeo are supported. Instagram and other restricted iframes will be skipped automatically.</p>
        <div id="urlList"></div>
        <button class="btn-secondary" onclick="addUrl()">Add URL</button>
      </div>

      <h3>Sponsors</h3>
      <div id="sponsorList"></div>
      <button class="btn-secondary" onclick="addSponsor()">Add Sponsor</button>

      <div class="button-group">
        <button class="btn-primary" onclick="saveDisplayConfig()">Save Configuration</button>
        <button class="btn-secondary" onclick="closeDisplayConfig()">Cancel</button>
      </div>
    </section>

  </main>

  <div id="overlay" class="loading-overlay"><div class="spinner"></div><p>Working‚Ä¶</p></div>

  <script>
    const BRAND = '<?= brandId ?>';
    const SCOPE = '<?= scope ?>';

    // Event state for edit mode - tracks current event's immutable/server-set fields
    const STATE = {
      id: null,
      slug: null,
      createdAtISO: null
    };

    let currentEventId = null;  // Legacy compat - will migrate to STATE.id
    let availableTemplates = [];
    let defaultTemplateId = 'custom';

    // === Helper Functions ===
    function generateId() {
      // Generate UUID v4-like ID
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = (crypto.getRandomValues(new Uint8Array(1))[0] & 15) >> (c === 'x' ? 0 : 3);
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
      });
    }

    function slugify(text) {
      return text.toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .substring(0, 50);
    }

    // === MVP Template System ===
    async function loadTemplates() {
      try {
        const res = await NU.rpc('api_getEventTemplates', { brandId: BRAND });
        if (res.ok && res.value) {
          availableTemplates = res.value.items || [];
          defaultTemplateId = res.value.defaultTemplateId || 'custom';
          renderTemplatePicker();
          // Select default template
          selectTemplate(defaultTemplateId);
        } else {
          document.getElementById('templatePicker').innerHTML =
            '<p class="muted">Could not load templates. Using defaults.</p>';
          updateTemplatePanelVisibility('custom'); // Show league panel for custom fallback
        }
      } catch (e) {
        console.error('Failed to load templates:', e);
        document.getElementById('templatePicker').innerHTML =
          '<p class="muted">Could not load templates. Using defaults.</p>';
        updateTemplatePanelVisibility('custom'); // Show league panel for custom fallback
      }
    }

    function renderTemplatePicker() {
      const picker = document.getElementById('templatePicker');
      if (!availableTemplates.length) {
        picker.innerHTML = '<p class="muted">No templates available.</p>';
        return;
      }

      const sectionIcons = { video: 'üé¨', map: 'üìç', schedule: 'üìÖ', sponsors: 'ü§ù', notes: 'üìù', gallery: 'üñºÔ∏è' };

      picker.innerHTML = availableTemplates.map(t => {
        const isRecommended = t.id === defaultTemplateId;
        const sectionPreview = Object.keys(sectionIcons).map(key => {
          const on = t.sections && t.sections[key];
          return `<span class="${on ? '' : 'off'}">${sectionIcons[key]}</span>`;
        }).join('');

        return `
          <div class="template-card" data-template-id="${NU.esc(t.id)}" onclick="selectTemplate('${NU.esc(t.id)}')">
            ${isRecommended ? '<span class="recommended-badge">Recommended</span>' : ''}
            <div class="template-icon">${t.icon || 'üìã'}</div>
            <div class="template-name">${NU.esc(t.label || t.id)}</div>
            <div class="template-desc">${NU.esc(t.description || '')}</div>
            <div class="template-sections">${sectionPreview}</div>
          </div>
        `;
      }).join('');
    }

    let currentTemplateSections = null; // Track for modification detection

    function selectTemplate(templateId) {
      // Update hidden input
      document.getElementById('templateId').value = templateId;

      // Update visual selection
      document.querySelectorAll('.template-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.templateId === templateId);
      });

      // Find template and apply section defaults
      const tpl = availableTemplates.find(t => t.id === templateId);
      if (tpl && tpl.sections) {
        currentTemplateSections = { ...tpl.sections };
        applySectionDefaults(tpl.sections);
        checkSectionsModified(); // Reset notice
      }

      // Update template-filtered panel visibility
      updateTemplatePanelVisibility(templateId);
    }

    /**
     * Show/hide panels based on data-template-filter attribute
     * Panels with data-template-filter="rec_league,custom" only show for those templates
     */
    function updateTemplatePanelVisibility(templateId) {
      document.querySelectorAll('[data-template-filter]').forEach(panel => {
        const allowedTemplates = panel.dataset.templateFilter.split(',').map(t => t.trim());
        const shouldShow = allowedTemplates.includes(templateId);
        panel.style.display = shouldShow ? '' : 'none';
      });
    }

    function checkSectionsModified() {
      if (!currentTemplateSections) return;
      const current = getSectionsFromForm();
      const modified = Object.keys(currentTemplateSections).some(
        key => current[key] !== currentTemplateSections[key]
      );
      const notice = document.getElementById('sectionsModifiedNotice');
      notice.classList.toggle('visible', modified);
    }

    // Add change listeners to section checkboxes
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('#sectionsGrid input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', checkSectionsModified);
      });
    });

    function applySectionDefaults(sections) {
      const sectionMap = {
        video: 'sectionVideo',
        map: 'sectionMap',
        schedule: 'sectionSchedule',
        sponsors: 'sectionSponsors',
        notes: 'sectionNotes',
        gallery: 'sectionGallery'
      };
      Object.keys(sectionMap).forEach(key => {
        const checkbox = document.getElementById(sectionMap[key]);
        if (checkbox && Object.prototype.hasOwnProperty.call(sections, key)) {
          checkbox.checked = !!sections[key];
        }
      });
    }

    function getSectionsFromForm() {
      return {
        video: document.getElementById('sectionVideo').checked,
        map: document.getElementById('sectionMap').checked,
        schedule: document.getElementById('sectionSchedule').checked,
        sponsors: document.getElementById('sectionSponsors').checked,
        notes: document.getElementById('sectionNotes').checked,
        gallery: document.getElementById('sectionGallery').checked
      };
    }

    // Load templates when page loads
    document.addEventListener('DOMContentLoaded', loadTemplates);

    /**
     * Build canonical Event object from form per EVENT_CONTRACT.md v2.0
     * This ensures Admin always produces a valid Event Contract structure.
     * Uses STATE for edit mode (preserves id, slug, createdAtISO from existing event).
     */
    function buildEventFromForm() {
      const name = document.getElementById('name').value.trim();
      const startDateISO = document.getElementById('startDateISO').value;
      const venue = document.getElementById('venue').value.trim();
      const ctaLabel = document.getElementById('ctaLabel').value.trim() || 'Sign Up';

      const now = new Date().toISOString();

      // Build canonical event structure per EVENT_CONTRACT.md v2.0
      return {
        // Identity (MVP Required)
        // Use STATE values for edit mode, generate new for create mode
        id: STATE.id ?? generateId(),
        slug: STATE.slug ?? slugify(name),
        name: name,
        startDateISO: startDateISO,
        venue: venue,

        // Links - server will fill these
        links: {
          publicUrl: '',
          displayUrl: '',
          posterUrl: '',
          signupUrl: ''
        },

        // QR Codes - server will generate
        qr: {},

        // CTAs (MVP Required)
        ctas: {
          primary: {
            label: ctaLabel,
            url: ''  // Server injects signupUrl
          },
          secondary: null
        },

        // Schedule/Standings/Bracket (MVP Optional)
        schedule: null,
        standings: null,
        bracket: null,

        // Settings (MVP Required)
        settings: {
          showSchedule: document.getElementById('showSchedule').checked,
          showStandings: document.getElementById('showStandings').checked,
          showBracket: document.getElementById('showBracket').checked,
          showSponsors: false
        },

        // V2 Optional fields - reserved with proper defaults per EVENT_CONTRACT.md
        sponsors: [],
        media: {},
        externalData: {},
        analytics: { enabled: false },
        payments: { enabled: false },

        // Timestamps
        createdAtISO: STATE.createdAtISO ?? now,
        updatedAtISO: now
      };
    }

    // Create Event
    document.getElementById('createForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate required fields
      const name = document.getElementById('name').value.trim();
      const startDateISO = document.getElementById('startDateISO').value;
      const venue = document.getElementById('venue').value.trim();

      if (!name) {
        alert('Event Name is required');
        return;
      }
      if (!startDateISO) {
        alert('Event Date is required');
        return;
      }
      if (!venue) {
        alert('Venue is required');
        return;
      }

      overlay(true);

      // Build canonical event object
      const eventData = buildEventFromForm();

      // Get the selected event template (bar_night, rec_league, etc.)
      const selectedTemplateId = document.getElementById('templateId').value || 'custom';

      const res = await NU.rpc('api_create', {
        brandId: BRAND,
        scope: SCOPE,
        templateId: selectedTemplateId,
        adminKey: getAdminKey(),
        idemKey: (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        data: eventData
      });

      overlay(false);

      if (!res.ok) {
        alert(`Error: ${res.message}`);
        return;
      }

      currentEventId = res.value.id;
      showEventCard(res.value);
    });

    /**
     * Show event card with canonical event data per EVENT_CONTRACT.md v2.0
     * Also updates STATE for edit mode support.
     */
    function showEventCard(event) {
      // Update STATE for edit mode - preserve id, slug, createdAtISO
      STATE.id = event.id || null;
      STATE.slug = event.slug || null;
      STATE.createdAtISO = event.createdAtISO || null;

      // Also sync legacy currentEventId
      currentEventId = event.id || null;

      // EVENT_CONTRACT.md v2.0: Links at top level
      const links = event.links || {};
      const qr = event.qr || {};
      const ctas = event.ctas || {};
      const settings = event.settings || {};

      // Set links
      setLink('lnkPublic', links.publicUrl);
      setLink('lnkDisplay', links.displayUrl);
      setLink('lnkPoster', links.posterUrl);
      if (links.signupUrl) setLink('lnkSignup', links.signupUrl);

      document.getElementById('eventCard').style.display = '';
      document.getElementById('dashboardCard').style.display = '';

      // Determine event phase based on date (v2.0: startDateISO)
      const dateStr = event.startDateISO || '';
      const eventDate = new Date(dateStr + 'T00:00:00');
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const eventDay = new Date(eventDate);
      eventDay.setHours(0, 0, 0, 0);

      let phase = 'pre-event';
      let phaseLabel = 'Pre-Event Preparation';

      if (!isNaN(eventDay.getTime())) {
        if (eventDay.getTime() === today.getTime()) {
          phase = 'event-day';
          phaseLabel = 'Event Day - Live';
        } else if (eventDay < today) {
          phase = 'post-event';
          phaseLabel = 'Post-Event Analytics';
        }
      }

      // Update phase indicator
      document.getElementById('eventPhaseIndicator').innerHTML = `
        <div style="text-align: center; margin-bottom: 16px;">
          <span class="phase-indicator ${phase}" style="font-size: 15px; padding: 8px 20px;">
            ${phaseLabel}
          </span>
        </div>
      `;

      // Stats (placeholder - in MVP these are not tracked)
      document.getElementById('statViews').textContent = '‚Äî';
      document.getElementById('statImpressions').textContent = '‚Äî';
      document.getElementById('statCTR').textContent = '‚Äî';
      document.getElementById('statEngagement').textContent = '‚Äî';

      // Update progress bars based on phase
      const preEventProg = phase === 'pre-event' ? 50 : 100;
      const eventDayProg = phase === 'event-day' ? 50 : (phase === 'post-event' ? 100 : 0);
      const postEventProg = phase === 'post-event' ? 50 : 0;

      document.getElementById('preEventProgress').style.width = preEventProg + '%';
      document.getElementById('eventDayProgress').style.width = eventDayProg + '%';
      document.getElementById('postEventProgress').style.width = postEventProg + '%';

      // Format date for display
      let dateDisplay = dateStr;
      if (dateStr && !isNaN(eventDate.getTime())) {
        dateDisplay = eventDate.toLocaleDateString('en-US', {
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });
      }

      // Event info - using canonical v2.0 fields
      let info = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
          <div>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 4px;">EVENT NAME</p>
            <p style="font-weight: 600; font-size: 16px;">${NU.esc(event.name || '')}</p>
          </div>
          <div>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 4px;">DATE</p>
            <p style="font-weight: 600; font-size: 16px;">${NU.esc(dateDisplay)}</p>
          </div>
          <div>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 4px;">VENUE</p>
            <p style="font-weight: 600; font-size: 16px;">${NU.esc(event.venue || '')}</p>
          </div>
          <div>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 4px;">PRIMARY CTA</p>
            <p style="font-weight: 600; font-size: 16px;">${NU.esc(ctas.primary?.label || 'Sign Up')}</p>
          </div>
        </div>
      `;

      // Settings display
      const enabledSettings = [];
      if (settings.showSchedule) enabledSettings.push('Schedule');
      if (settings.showStandings) enabledSettings.push('Standings');
      if (settings.showBracket) enabledSettings.push('Bracket');

      if (enabledSettings.length > 0) {
        info += `
          <div style="margin-top: 16px;">
            <p style="color: #64748b; font-size: 13px; margin-bottom: 4px;">ENABLED SECTIONS</p>
            <p style="font-weight: 600; font-size: 16px;">${enabledSettings.join(', ')}</p>
          </div>
        `;
      }

      // QR Codes preview
      if (qr.public || qr.signup) {
        info += `
          <div style="margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px;">
            <p style="color: #64748b; font-size: 13px; margin-bottom: 12px;">QR CODES</p>
            <div style="display: flex; gap: 24px; flex-wrap: wrap;">
              ${qr.public ? `
                <div style="text-align: center;">
                  <img src="${qr.public}" alt="Public QR" style="width: 100px; height: 100px; border: 1px solid #e2e8f0; border-radius: 8px;">
                  <p style="font-size: 12px; color: #64748b; margin-top: 4px;">Event Page</p>
                </div>
              ` : ''}
              ${qr.signup ? `
                <div style="text-align: center;">
                  <img src="${qr.signup}" alt="Signup QR" style="width: 100px; height: 100px; border: 1px solid #e2e8f0; border-radius: 8px;">
                  <p style="font-size: 12px; color: #64748b; margin-top: 4px;">Sign Up</p>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }

      // Links summary
      info += `
        <div style="margin-top: 16px; padding: 16px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
          <p style="color: #0369a1; font-size: 13px; margin-bottom: 8px; font-weight: 600;">EVENT LINKS</p>
          <div style="display: grid; gap: 8px; font-size: 13px;">
            <div><strong>Public:</strong> <a href="${NU.esc(links.publicUrl || '')}" target="_blank" style="color: #2563eb;">${NU.esc(links.publicUrl || '')}</a></div>
            <div><strong>Display:</strong> <a href="${NU.esc(links.displayUrl || '')}" target="_blank" style="color: #2563eb;">${NU.esc(links.displayUrl || '')}</a></div>
            <div><strong>Poster:</strong> <a href="${NU.esc(links.posterUrl || '')}" target="_blank" style="color: #2563eb;">${NU.esc(links.posterUrl || '')}</a></div>
            ${links.signupUrl ? `<div><strong>Sign Up:</strong> <a href="${NU.esc(links.signupUrl)}" target="_blank" style="color: #2563eb;">${NU.esc(links.signupUrl)}</a></div>` : ''}
          </div>
        </div>
      `;

      info += `<p style="margin-top: 16px;"><strong>Event ID:</strong> <code>${event.id}</code> &nbsp; <strong>Slug:</strong> <code>${event.slug || ''}</code></p>`;

      document.getElementById('eventInfo').innerHTML = info;
    }

    function setLink(id, url) {
      const a = document.getElementById(id);
      a.textContent = url;
      a.href = url;
    }

    async function copy(id) {
      const url = document.getElementById(id).textContent;
      await navigator.clipboard.writeText(url);
      alert('Link copied!');
    }

    function clearForm() {
      document.getElementById('createForm').reset();
      document.getElementById('dashboardCard').style.display = 'none';
      document.getElementById('eventCard').style.display = 'none';
      document.getElementById('signupCard').style.display = 'none';
      document.getElementById('displayCard').style.display = 'none';

      // Clear STATE for new event creation
      STATE.id = null;
      STATE.slug = null;
      STATE.createdAtISO = null;
      currentEventId = null;

      // Reset to default template
      selectTemplate(defaultTemplateId);
    }

    // Configure Sign-Up Forms
    function configureSignup() {
      document.getElementById('signupCard').style.display = '';
      loadSignupForms();
    }

    async function loadSignupForms() {
      if (!currentEventId) return;
      overlay(true);
      const res = await NU.rpc('api_get', { brandId: BRAND, scope: SCOPE, id: currentEventId });
      overlay(false);

      if (res.ok && res.value) {
        const data = res.value.data || {};
        document.getElementById('registerUrl').value = data.registerUrl || '';
        document.getElementById('checkinUrl').value = data.checkinUrl || '';
        document.getElementById('walkinUrl').value = data.walkinUrl || '';
        document.getElementById('surveyUrl').value = data.surveyUrl || '';
      }
    }

    async function saveAllSignupForms() {
      if (!currentEventId) return;

      const data = {
        registerUrl: document.getElementById('registerUrl').value.trim(),
        checkinUrl: document.getElementById('checkinUrl').value.trim(),
        walkinUrl: document.getElementById('walkinUrl').value.trim(),
        surveyUrl: document.getElementById('surveyUrl').value.trim()
      };

      overlay(true);
      const res = await NU.rpc('api_updateEventData', {
        brandId: BRAND,
        scope: SCOPE,
        id: currentEventId,
        adminKey: getAdminKey(),
        data
      });
      overlay(false);

      if (res.ok) {
        alert('Sign-up forms saved!');
        closeSignupConfig();
      } else {
        alert(`Error: ${res.message}`);
      }
    }

    function closeSignupConfig() {
      document.getElementById('signupCard').style.display = 'none';
    }

    // Google Forms Templates
    function openFormsTemplates() {
      document.getElementById('formsCard').style.display = '';
    }

    function closeFormsTemplates() {
      document.getElementById('formsCard').style.display = 'none';
    }

    async function createFormTemplate(templateType) {
      if (!currentEventId) {
        alert('Please select or create an event first.');
        return;
      }

      const displayMap = {
        'check-in': 'checkin-form-display',
        'walk-in': 'walkin-form-display',
        'survey': 'survey-form-display'
      };

      const displayId = displayMap[templateType];
      if (!displayId) return;

      const displayDiv = document.getElementById(displayId);
      displayDiv.innerHTML = '<p class="muted">Creating form...</p>';

      overlay(true);

      // Get event data for context
      const eventRes = await NU.rpc('api_get', {
        brandId: BRAND,
        scope: SCOPE,
        id: currentEventId
      });

      const eventName = eventRes.ok && eventRes.value?.data?.name
        ? eventRes.value.data.name
        : 'Event';

      // Create form from template
      const formRes = await NU.rpc('api_createFormFromTemplate', {
        brandId: BRAND,
        adminKey: getAdminKey(),
        templateType,
        eventName,
        eventId: currentEventId
      });

      if (!formRes.ok) {
        overlay(false);
        displayDiv.innerHTML = `<p style="color: #ef4444;">Error: ${formRes.message}</p>`;
        return;
      }

      const { publishedUrl, editUrl, responseSheetUrl } = formRes.value;

      // Generate shortlink for the published form
      const shortlinkRes = await NU.rpc('api_generateFormShortlink', {
        brandId: BRAND,
        adminKey: getAdminKey(),
        formUrl: publishedUrl,
        formType: templateType,
        eventId: currentEventId
      });

      overlay(false);

      const shortlink = shortlinkRes.ok ? shortlinkRes.value.shortlink : publishedUrl;

      // Display form links with copy buttons
      displayDiv.innerHTML = `
        <div style="background: #f1f5f9; padding: 12px; border-radius: 4px; margin-top: 8px;">
          <div style="margin-bottom: 8px;">
            <strong>Shortlink:</strong><br>
            <input type="text" id="${templateType}-shortlink" value="${shortlink}" readonly
                   style="width: 100%; margin-top: 4px; font-size: 12px;">
            <button class="btn-secondary" onclick="copyFormLink('${templateType}-shortlink')"
                    style="margin-top: 4px; width: 100%;">
              Copy Shortlink
            </button>
          </div>
          <div style="margin-top: 12px;">
            <a href="${editUrl}" target="_blank" rel="noopener" class="btn-secondary"
               style="display: inline-block; margin-right: 8px;">
              Edit Form
            </a>
            <a href="${responseSheetUrl}" target="_blank" rel="noopener" class="btn-secondary"
               style="display: inline-block;">
              View Responses
            </a>
          </div>
          <div style="margin-top: 8px; font-size: 12px; color: #64748b;">
            Form created successfully! Share the shortlink with attendees.
          </div>
        </div>
      `;
    }

    function copyFormLink(inputId) {
      const input = document.getElementById(inputId);
      if (input) {
        input.select();
        input.setSelectionRange(0, 99999); // For mobile devices
        document.execCommand('copy');

        // Visual feedback
        const originalValue = input.value;
        input.value = 'Copied!';
        setTimeout(() => {
          input.value = originalValue;
        }, 1000);
      }
    }

    // Configure Display & Sponsors
    function configureDisplay() {
      document.getElementById('displayCard').style.display = '';
      loadDisplayConfig();
    }

    async function loadDisplayConfig() {
      if (!currentEventId) return;
      overlay(true);
      const res = await NU.rpc('api_get', { brandId: BRAND, scope: SCOPE, id: currentEventId });
      overlay(false);

      if (res.ok && res.value) {
        const data = res.value.data || {};
        const display = data.display || {};
        const sponsors = data.sponsors || [];

        document.getElementById('displayMode').value = display.mode || 'public';
        toggleDisplayMode();

        if (display.urls) {
          renderUrls(display.urls);
        }

        renderSponsors(sponsors);
      }
    }

    function toggleDisplayMode() {
      const mode = document.getElementById('displayMode').value;
      document.getElementById('dynamicConfig').style.display = mode === 'dynamic' ? '' : 'none';
    }

    function renderUrls(urls) {
      const list = document.getElementById('urlList');
      list.innerHTML = '';
      urls.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
          <label>URL ${i + 1}</label>
          <input type="url" value="${item.url || ''}" class="url-input">
          <input type="number" value="${item.seconds || 10}" min="5" max="300" placeholder="Seconds" class="url-seconds" style="width:100px;margin-top:4px;">
        `;
        list.appendChild(div);
      });
    }

    function addUrl() {
      const list = document.getElementById('urlList');
      const div = document.createElement('div');
      div.className = 'form-group';
      div.innerHTML = `
        <label>New URL</label>
        <input type="url" placeholder="https://..." class="url-input">
        <input type="number" value="10" min="5" max="300" placeholder="Seconds" class="url-seconds" style="width:100px;margin-top:4px;">
      `;
      list.appendChild(div);
    }

    function renderSponsors(sponsors) {
      const list = document.getElementById('sponsorList');
      list.innerHTML = '';
      sponsors.forEach((sp, i) => {
        const div = document.createElement('div');
        div.className = 'event-card';
        const placements = sp.placements || {};
        div.innerHTML = `
          <h4>Sponsor ${i + 1}</h4>
          <input type="text" placeholder="Name" value="${sp.name || ''}" class="sp-name" style="width:100%;margin-bottom:4px;">
          <input type="url" placeholder="URL" value="${sp.url || ''}" class="sp-url" style="width:100%;margin-bottom:4px;">
          <input type="url" placeholder="Image URL" value="${sp.img || ''}" class="sp-img" style="width:100%;margin-bottom:8px;">
          <label><input type="checkbox" class="sp-posterTop" ${placements.posterTop ? 'checked' : ''}> Poster Top</label><br>
          <label><input type="checkbox" class="sp-tvTop" ${placements.tvTop ? 'checked' : ''}> TV Top</label><br>
          <label><input type="checkbox" class="sp-tvSide" ${placements.tvSide ? 'checked' : ''}> TV Side</label><br>
          <label><input type="checkbox" class="sp-mobileBanner" ${placements.mobileBanner ? 'checked' : ''}> Mobile Banner</label>
        `;
        list.appendChild(div);
      });
    }

    function addSponsor() {
      const list = document.getElementById('sponsorList');
      const div = document.createElement('div');
      div.className = 'event-card';
      div.innerHTML = `
        <h4>New Sponsor</h4>
        <input type="text" placeholder="Name" class="sp-name" style="width:100%;margin-bottom:4px;">
        <input type="url" placeholder="URL" class="sp-url" style="width:100%;margin-bottom:4px;">
        <input type="url" placeholder="Image URL" class="sp-img" style="width:100%;margin-bottom:8px;">
        <label><input type="checkbox" class="sp-posterTop"> Poster Top</label><br>
        <label><input type="checkbox" class="sp-tvTop"> TV Top</label><br>
        <label><input type="checkbox" class="sp-tvSide"> TV Side</label><br>
        <label><input type="checkbox" class="sp-mobileBanner"> Mobile Banner</label>
      `;
      list.appendChild(div);
    }

    async function saveDisplayConfig() {
      if (!currentEventId) return;

      const mode = document.getElementById('displayMode').value;
      const urls = [];

      if (mode === 'dynamic') {
        document.querySelectorAll('#urlList .form-group').forEach(row => {
          const url = row.querySelector('.url-input').value.trim();
          const seconds = Number(row.querySelector('.url-seconds').value || 10);
          if (url) urls.push({ url, seconds });
        });
      }

      const sponsors = [];
      document.querySelectorAll('#sponsorList .event-card').forEach(row => {
        const name = row.querySelector('.sp-name').value.trim();
        if (!name) return;
        sponsors.push({
          id: (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : `sp-${Date.now()}`,
          name,
          url: row.querySelector('.sp-url').value.trim(),
          img: row.querySelector('.sp-img').value.trim(),
          placements: {
            posterTop: row.querySelector('.sp-posterTop').checked,
            tvTop: row.querySelector('.sp-tvTop').checked,
            tvSide: row.querySelector('.sp-tvSide').checked,
            mobileBanner: row.querySelector('.sp-mobileBanner').checked
          }
        });
      });

      overlay(true);
      const res = await NU.rpc('api_updateEventData', {
        brandId: BRAND,
        scope: SCOPE,
        id: currentEventId,
        adminKey: getAdminKey(),
        data: { display: { mode, urls }, sponsors }
      });
      overlay(false);

      if (res.ok) {
        alert('Display configuration saved!');
      } else {
        alert(`Error: ${res.message}`);
      }
    }

    function closeDisplayConfig() {
      document.getElementById('displayCard').style.display = 'none';
    }

    // Helpers
    function overlay(on) {
      document.getElementById('overlay').style.display = on ? 'flex' : 'none';
    }

    function getAdminKey() {
      const k = sessionStorage.getItem('ADMIN_KEY:' + BRAND) || prompt('Admin key for ' + BRAND);
      if (k) sessionStorage.setItem('ADMIN_KEY:' + BRAND, k);
      return k || '';
    }
  </script>
</body>
</html>
