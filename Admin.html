<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> · Admin</title>
  <?!= include('Styles'); ?>
  <?!= include('DesignAdapter'); ?>
  <?!= include('NUSDK'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
</head>
<body>
  <?!= include('Header'); ?>

  <main id="app" class="container">

    <!-- Event Lifecycle Dashboard -->
    <section class="card" id="dashboardCard" style="display:none;">
      <h2>Event Dashboard</h2>
      <div id="eventPhaseIndicator"></div>

      <div class="stats-grid" style="margin-top: 20px;">
        <div class="stat-card blue">
          <div class="stat-value" id="statViews">-</div>
          <div class="stat-label">Total Views</div>
        </div>
        <div class="stat-card green">
          <div class="stat-value" id="statImpressions">-</div>
          <div class="stat-label">Sponsor Impressions</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-value" id="statCTR">-</div>
          <div class="stat-label">Click-Through Rate</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-value" id="statEngagement">-</div>
          <div class="stat-label">Engagement Score</div>
        </div>
      </div>

      <h3 style="margin-top: 24px;">Event Lifecycle</h3>
      <div class="metric-card">
        <div class="metric-header">
          <span class="metric-title">Pre-Event Phase</span>
          <span class="phase-indicator pre-event">Preparation</span>
        </div>
        <p style="color: #64748b; font-size: 14px; margin-top: 8px;">
          Advertising with sponsors, creating posters, setting up displays, and getting the public to register
        </p>
        <div class="progress-bar">
          <div class="progress-bar-fill" id="preEventProgress" style="width: 0%"></div>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <span class="metric-title">Event Day</span>
          <span class="phase-indicator event-day">Active</span>
        </div>
        <p style="color: #64748b; font-size: 14px; margin-top: 8px;">
          Public reminders, displays at entrance, check-in at door, sponsor banners rotating on screens
        </p>
        <div class="progress-bar">
          <div class="progress-bar-fill green" id="eventDayProgress" style="width: 0%"></div>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <span class="metric-title">Post-Event Phase</span>
          <span class="phase-indicator post-event">Analytics</span>
        </div>
        <p style="color: #64748b; font-size: 14px; margin-top: 8px;">
          CTR analysis, sponsor impressions per screen/time/location, ROI calculations
        </p>
        <div class="progress-bar">
          <div class="progress-bar-fill orange" id="postEventProgress" style="width: 0%"></div>
        </div>
      </div>
    </section>

    <!-- Create Event Card -->
    <section class="card">
      <h2>Create Event</h2>
      <form id="createForm">
        <!-- Core Event Details -->
        <div class="form-group">
          <label>Event Name *</label>
          <input id="name" type="text" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Date *</label>
            <input id="dateISO" type="date" required>
          </div>
          <div class="form-group">
            <label>Time</label>
            <input id="timeISO" type="time">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Location</label>
            <input id="location" type="text" placeholder="Venue name or address">
          </div>
          <div class="form-group">
            <label>Entity</label>
            <input id="entity" type="text" placeholder="Organization or department">
          </div>
        </div>

        <!-- Summary Section -->
        <h3>Summary</h3>
        <div class="form-group">
          <label>Summary</label>
          <textarea id="summary" placeholder="Brief event description"></textarea>
        </div>
        <div class="form-group">
          <label>Summary Link</label>
          <input id="summaryLink" type="url" placeholder="https://...">
        </div>

        <!-- Media Section -->
        <h3>Media</h3>
        <div class="form-group">
          <label>Event Image URL</label>
          <input id="imageUrl" type="url" placeholder="https://...">
        </div>
        <div class="form-group">
          <label>Video URL</label>
          <input id="videoUrl" type="url" placeholder="YouTube, Vimeo, etc.">
        </div>
        <div class="form-group">
          <label>Gallery URLs</label>
          <textarea id="galleryUrls" placeholder="Comma-separated image URLs"></textarea>
        </div>

        <!-- Bio Section -->
        <h3>Bio</h3>
        <div class="form-group">
          <label>Bio</label>
          <textarea id="bio" placeholder="Detailed event or organizer bio"></textarea>
        </div>
        <div class="form-group">
          <label>Bio Link</label>
          <input id="bioLink" type="url" placeholder="https://...">
        </div>

        <div class="button-group">
          <button class="btn-primary" type="submit">Create Event</button>
          <button class="btn-secondary" type="button" onclick="clearForm()">Clear</button>
        </div>
      </form>
    </section>

    <!-- Event Card (appears after event is selected/created) -->
    <section id="eventCard" class="card" style="display:none;">
      <h2>Event Details</h2>
      <div id="eventInfo"></div>

      <h3>Links</h3>
      <div class="events-grid">
        <div class="event-card">
          <h3>Public (Mobile)</h3>
          <p><a id="lnkPublic" target="_blank" rel="noopener"></a></p>
          <button class="btn-secondary" onclick="copy('lnkPublic')">Copy Link</button>
        </div>
        <div class="event-card">
          <h3>Display (TV)</h3>
          <p><a id="lnkDisplay" target="_blank" rel="noopener"></a></p>
          <button class="btn-secondary" onclick="copy('lnkDisplay')">Copy Link</button>
        </div>
        <div class="event-card">
          <h3>Poster (Print/QR)</h3>
          <p><a id="lnkPoster" target="_blank" rel="noopener"></a></p>
          <button class="btn-secondary" onclick="copy('lnkPoster')">Copy Link</button>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="configureDisplay()">Configure Display & Sponsors</button>
        <button class="btn-secondary" onclick="configureSignup()">Configure Sign-Up Forms</button>
      </div>
    </section>

    <!-- Sign Up Forms (Compact) -->
    <section id="signupCard" class="card" style="display:none;">
      <h2>Sign-Up Forms Configuration</h2>
      <p class="muted">Configure Google Forms or other sign-up links for different event phases</p>

      <div class="form-row">
        <!-- Pre-Event: Register -->
        <div class="form-group">
          <label><strong>Pre-Event:</strong> Registration</label>
          <input type="url" id="registerUrl" placeholder="https://forms.google.com/...">
          <small class="muted">Allow users to register before the event</small>
        </div>

        <!-- Event: Check-in -->
        <div class="form-group">
          <label><strong>During Event:</strong> Check-In</label>
          <input type="url" id="checkinUrl" placeholder="https://forms.google.com/...">
          <small class="muted">Attendees check in on arrival</small>
        </div>
      </div>

      <div class="form-row">
        <!-- Event: Walk-in -->
        <div class="form-group">
          <label><strong>During Event:</strong> Walk-In</label>
          <input type="url" id="walkinUrl" placeholder="https://forms.google.com/...">
          <small class="muted">Walk-ins register on the spot</small>
        </div>

        <!-- Post-Event: Survey -->
        <div class="form-group">
          <label><strong>Post-Event:</strong> Survey</label>
          <input type="url" id="surveyUrl" placeholder="https://forms.google.com/...">
          <small class="muted">Collect feedback after the event</small>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="saveAllSignupForms()">Save All Forms</button>
        <button class="btn-secondary" onclick="closeSignupConfig()">Cancel</button>
      </div>
    </section>

    <!-- Display & Sponsors Configuration -->
    <section id="displayCard" class="card" style="display:none;">
      <h2>Display & Sponsors Configuration</h2>

      <h3>Display Mode</h3>
      <div class="form-group">
        <label>Mode</label>
        <select id="displayMode" onchange="toggleDisplayMode()">
          <option value="public">Public (Mirror mobile page)</option>
          <option value="dynamic">Dynamic (Carousel with URLs)</option>
        </select>
      </div>

      <div id="dynamicConfig" style="display:none;">
        <h4>Carousel URLs</h4>
        <p class="muted">Add URLs to display. YouTube and Vimeo are supported. Instagram and other restricted iframes will be skipped automatically.</p>
        <div id="urlList"></div>
        <button class="btn-secondary" onclick="addUrl()">Add URL</button>
      </div>

      <h3>Sponsors</h3>
      <div id="sponsorList"></div>
      <button class="btn-secondary" onclick="addSponsor()">Add Sponsor</button>

      <div class="button-group">
        <button class="btn-primary" onclick="saveDisplayConfig()">Save Configuration</button>
        <button class="btn-secondary" onclick="closeDisplayConfig()">Cancel</button>
      </div>
    </section>

  </main>

  <div id="overlay" class="loading-overlay"><div class="spinner"></div><p>Working…</p></div>

  <script>
    const TENANT = '<?= tenantId ?>';
    const SCOPE = '<?= scope ?>';
    let currentEventId = null;

    // Create Event
    document.getElementById('createForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      overlay(true);

      const data = {
        name: document.getElementById('name').value.trim(),
        dateISO: document.getElementById('dateISO').value
      };

      // Optional fields
      const optional = ['timeISO', 'location', 'entity', 'summary', 'summaryLink',
                       'imageUrl', 'videoUrl', 'galleryUrls', 'bio', 'bioLink'];

      optional.forEach(field => {
        const elem = document.getElementById(field);
        const val = elem ? elem.value.trim() : '';
        if (val) data[field] = val;
      });

      const res = await NU.rpc('api_create', {
        tenantId: TENANT,
        scope: SCOPE,
        templateId: 'event',
        adminKey: getAdminKey(),
        idemKey: (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        data
      });

      overlay(false);

      if (!res.ok) {
        alert(`Error: ${res.message}`);
        return;
      }

      currentEventId = res.value.id;
      showEventCard(res.value);
    });

    function showEventCard(event) {
      const { publicUrl, posterUrl, displayUrl } = event.links;
      const d = event.data || {};

      setLink('lnkPublic', publicUrl);
      setLink('lnkDisplay', displayUrl);
      setLink('lnkPoster', posterUrl);

      document.getElementById('eventCard').style.display = '';
      document.getElementById('dashboardCard').style.display = '';

      // Determine event phase based on date
      const eventDate = new Date(d.dateISO || '');
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const eventDay = new Date(eventDate);
      eventDay.setHours(0, 0, 0, 0);

      let phase = 'pre-event';
      let phaseLabel = 'Pre-Event Preparation';

      if (eventDay.getTime() === today.getTime()) {
        phase = 'event-day';
        phaseLabel = 'Event Day - Live';
      } else if (eventDay < today) {
        phase = 'post-event';
        phaseLabel = 'Post-Event Analytics';
      }

      // Update phase indicator
      document.getElementById('eventPhaseIndicator').innerHTML = `
        <div style="text-align: center; margin-bottom: 16px;">
          <span class="phase-indicator ${phase}" style="font-size: 15px; padding: 8px 20px;">
            ${phaseLabel}
          </span>
        </div>
      `;

      // Calculate mock metrics (in real implementation, fetch from analytics)
      const sponsors = d.sponsors || [];
      const mockViews = Math.floor(Math.random() * 500) + 100;
      const mockImpressions = sponsors.length * Math.floor(Math.random() * 1000) + 200;
      const mockCTR = ((Math.random() * 5) + 1).toFixed(1) + '%';
      const mockEngagement = Math.floor(Math.random() * 100);

      document.getElementById('statViews').textContent = mockViews;
      document.getElementById('statImpressions').textContent = mockImpressions.toLocaleString();
      document.getElementById('statCTR').textContent = mockCTR;
      document.getElementById('statEngagement').textContent = mockEngagement + '/100';

      // Update progress bars based on phase
      const preEventProg = phase === 'pre-event' ? 50 : 100;
      const eventDayProg = phase === 'event-day' ? 50 : (phase === 'post-event' ? 100 : 0);
      const postEventProg = phase === 'post-event' ? 50 : 0;

      document.getElementById('preEventProgress').style.width = preEventProg + '%';
      document.getElementById('eventDayProgress').style.width = eventDayProg + '%';
      document.getElementById('postEventProgress').style.width = postEventProg + '%';

      // Event info
      let info = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
          <div>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 4px;">EVENT NAME</p>
            <p style="font-weight: 600; font-size: 16px;">${NU.esc(d.name || '')}</p>
          </div>
          <div>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 4px;">DATE & TIME</p>
            <p style="font-weight: 600; font-size: 16px;">${NU.esc(d.dateISO || '')}${d.timeISO ? ' at ' + NU.esc(d.timeISO) : ''}</p>
          </div>
      `;

      if (d.location) {
        info += `
          <div>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 4px;">LOCATION</p>
            <p style="font-weight: 600; font-size: 16px;">${NU.esc(d.location)}</p>
          </div>
        `;
      }

      if (d.entity) {
        info += `
          <div>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 4px;">ORGANIZATION</p>
            <p style="font-weight: 600; font-size: 16px;">${NU.esc(d.entity)}</p>
          </div>
        `;
      }

      info += `</div>`;

      if (d.summary) {
        info += `
          <div style="margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px;">
            <p style="color: #64748b; font-size: 13px; margin-bottom: 4px;">SUMMARY</p>
            <p style="color: #1e293b; line-height: 1.6;">${NU.esc(d.summary)}</p>
          </div>
        `;
      }

      info += `<p style="margin-top: 16px;"><strong>Event ID:</strong> <code>${event.id}</code></p>`;

      document.getElementById('eventInfo').innerHTML = info;
    }

    function setLink(id, url) {
      const a = document.getElementById(id);
      a.textContent = url;
      a.href = url;
    }

    async function copy(id) {
      const url = document.getElementById(id).textContent;
      await navigator.clipboard.writeText(url);
      alert('Link copied!');
    }

    function clearForm() {
      document.getElementById('createForm').reset();
      document.getElementById('dashboardCard').style.display = 'none';
      document.getElementById('eventCard').style.display = 'none';
      document.getElementById('signupCard').style.display = 'none';
      document.getElementById('displayCard').style.display = 'none';
      currentEventId = null;
    }

    // Configure Sign-Up Forms
    function configureSignup() {
      document.getElementById('signupCard').style.display = '';
      loadSignupForms();
    }

    async function loadSignupForms() {
      if (!currentEventId) return;
      overlay(true);
      const res = await NU.rpc('api_get', { tenantId: TENANT, scope: SCOPE, id: currentEventId });
      overlay(false);

      if (res.ok && res.value) {
        const data = res.value.data || {};
        document.getElementById('registerUrl').value = data.registerUrl || '';
        document.getElementById('checkinUrl').value = data.checkinUrl || '';
        document.getElementById('walkinUrl').value = data.walkinUrl || '';
        document.getElementById('surveyUrl').value = data.surveyUrl || '';
      }
    }

    async function saveAllSignupForms() {
      if (!currentEventId) return;

      const data = {
        registerUrl: document.getElementById('registerUrl').value.trim(),
        checkinUrl: document.getElementById('checkinUrl').value.trim(),
        walkinUrl: document.getElementById('walkinUrl').value.trim(),
        surveyUrl: document.getElementById('surveyUrl').value.trim()
      };

      overlay(true);
      const res = await NU.rpc('api_updateEventData', {
        tenantId: TENANT,
        scope: SCOPE,
        id: currentEventId,
        adminKey: getAdminKey(),
        data
      });
      overlay(false);

      if (res.ok) {
        alert('Sign-up forms saved!');
        closeSignupConfig();
      } else {
        alert(`Error: ${res.message}`);
      }
    }

    function closeSignupConfig() {
      document.getElementById('signupCard').style.display = 'none';
    }

    // Configure Display & Sponsors
    function configureDisplay() {
      document.getElementById('displayCard').style.display = '';
      loadDisplayConfig();
    }

    async function loadDisplayConfig() {
      if (!currentEventId) return;
      overlay(true);
      const res = await NU.rpc('api_get', { tenantId: TENANT, scope: SCOPE, id: currentEventId });
      overlay(false);

      if (res.ok && res.value) {
        const data = res.value.data || {};
        const display = data.display || {};
        const sponsors = data.sponsors || [];

        document.getElementById('displayMode').value = display.mode || 'public';
        toggleDisplayMode();

        if (display.urls) {
          renderUrls(display.urls);
        }

        renderSponsors(sponsors);
      }
    }

    function toggleDisplayMode() {
      const mode = document.getElementById('displayMode').value;
      document.getElementById('dynamicConfig').style.display = mode === 'dynamic' ? '' : 'none';
    }

    function renderUrls(urls) {
      const list = document.getElementById('urlList');
      list.innerHTML = '';
      urls.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
          <label>URL ${i + 1}</label>
          <input type="url" value="${item.url || ''}" class="url-input">
          <input type="number" value="${item.seconds || 10}" min="5" max="300" placeholder="Seconds" class="url-seconds" style="width:100px;margin-top:4px;">
        `;
        list.appendChild(div);
      });
    }

    function addUrl() {
      const list = document.getElementById('urlList');
      const div = document.createElement('div');
      div.className = 'form-group';
      div.innerHTML = `
        <label>New URL</label>
        <input type="url" placeholder="https://..." class="url-input">
        <input type="number" value="10" min="5" max="300" placeholder="Seconds" class="url-seconds" style="width:100px;margin-top:4px;">
      `;
      list.appendChild(div);
    }

    function renderSponsors(sponsors) {
      const list = document.getElementById('sponsorList');
      list.innerHTML = '';
      sponsors.forEach((sp, i) => {
        const div = document.createElement('div');
        div.className = 'event-card';
        const placements = sp.placements || {};
        div.innerHTML = `
          <h4>Sponsor ${i + 1}</h4>
          <input type="text" placeholder="Name" value="${sp.name || ''}" class="sp-name" style="width:100%;margin-bottom:4px;">
          <input type="url" placeholder="URL" value="${sp.url || ''}" class="sp-url" style="width:100%;margin-bottom:4px;">
          <input type="url" placeholder="Image URL" value="${sp.img || ''}" class="sp-img" style="width:100%;margin-bottom:8px;">
          <label><input type="checkbox" class="sp-posterTop" ${placements.posterTop ? 'checked' : ''}> Poster Top</label><br>
          <label><input type="checkbox" class="sp-tvTop" ${placements.tvTop ? 'checked' : ''}> TV Top</label><br>
          <label><input type="checkbox" class="sp-tvSide" ${placements.tvSide ? 'checked' : ''}> TV Side</label><br>
          <label><input type="checkbox" class="sp-mobileBanner" ${placements.mobileBanner ? 'checked' : ''}> Mobile Banner</label>
        `;
        list.appendChild(div);
      });
    }

    function addSponsor() {
      const list = document.getElementById('sponsorList');
      const div = document.createElement('div');
      div.className = 'event-card';
      div.innerHTML = `
        <h4>New Sponsor</h4>
        <input type="text" placeholder="Name" class="sp-name" style="width:100%;margin-bottom:4px;">
        <input type="url" placeholder="URL" class="sp-url" style="width:100%;margin-bottom:4px;">
        <input type="url" placeholder="Image URL" class="sp-img" style="width:100%;margin-bottom:8px;">
        <label><input type="checkbox" class="sp-posterTop"> Poster Top</label><br>
        <label><input type="checkbox" class="sp-tvTop"> TV Top</label><br>
        <label><input type="checkbox" class="sp-tvSide"> TV Side</label><br>
        <label><input type="checkbox" class="sp-mobileBanner"> Mobile Banner</label>
      `;
      list.appendChild(div);
    }

    async function saveDisplayConfig() {
      if (!currentEventId) return;

      const mode = document.getElementById('displayMode').value;
      const urls = [];

      if (mode === 'dynamic') {
        document.querySelectorAll('#urlList .form-group').forEach(row => {
          const url = row.querySelector('.url-input').value.trim();
          const seconds = Number(row.querySelector('.url-seconds').value || 10);
          if (url) urls.push({ url, seconds });
        });
      }

      const sponsors = [];
      document.querySelectorAll('#sponsorList .event-card').forEach(row => {
        const name = row.querySelector('.sp-name').value.trim();
        if (!name) return;
        sponsors.push({
          id: (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : `sp-${Date.now()}`,
          name,
          url: row.querySelector('.sp-url').value.trim(),
          img: row.querySelector('.sp-img').value.trim(),
          placements: {
            posterTop: row.querySelector('.sp-posterTop').checked,
            tvTop: row.querySelector('.sp-tvTop').checked,
            tvSide: row.querySelector('.sp-tvSide').checked,
            mobileBanner: row.querySelector('.sp-mobileBanner').checked
          }
        });
      });

      overlay(true);
      const res = await NU.rpc('api_updateEventData', {
        tenantId: TENANT,
        scope: SCOPE,
        id: currentEventId,
        adminKey: getAdminKey(),
        data: { display: { mode, urls }, sponsors }
      });
      overlay(false);

      if (res.ok) {
        alert('Display configuration saved!');
      } else {
        alert(`Error: ${res.message}`);
      }
    }

    function closeDisplayConfig() {
      document.getElementById('displayCard').style.display = 'none';
    }

    // Helpers
    function overlay(on) {
      document.getElementById('overlay').style.display = on ? 'flex' : 'none';
    }

    function getAdminKey() {
      const k = sessionStorage.getItem('ADMIN_KEY:' + TENANT) || prompt('Admin key for ' + TENANT);
      if (k) sessionStorage.setItem('ADMIN_KEY:' + TENANT, k);
      return k || '';
    }
  </script>
</body>
</html>
