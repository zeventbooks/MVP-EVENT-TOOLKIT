# ============================================
# Staging Worker Configuration (Root wrangler.toml)
# ============================================
# This is the staging deployment configuration.
# For production, use cloudflare-proxy/wrangler.toml [env.production]
#
# Deployment: wrangler deploy
# This deploys to stg.eventangle.com for pre-production validation.
#
# Naming Convention (see config/deployment-ids.js):
#   STAGING_* - Staging environment variables
#   PROD_*    - Production environment variables
# ============================================

name = "eventangle-staging"
main = "cloudflare-proxy/worker.js"
compatibility_date = "2024-01-01"

# ===========================================
# Text Rules for Embedded Templates
# ===========================================
# Import HTML templates as text strings for embedding in the Worker.
# This eliminates the need for KV storage for templates.
[[rules]]
type = "Text"
globs = ["**/*.html"]
fallthrough = true

routes = [
  { pattern = "stg.eventangle.com/*", zone_name = "eventangle.com" },
  { pattern = "api-stg.eventangle.com/*", zone_name = "eventangle.com" }
]

[vars]
# ============================================
# STAGING DEPLOYMENT CONFIGURATION
# ============================================
# Uses standardized naming convention:
#   STAGING_DEPLOYMENT_ID  - Web app deployment ID (changes per deploy)
#   STAGING_WEB_APP_URL    - Executable URL (runtime)
#
# Script ID: 1gHiPuj7eXNk09dDyk17SJ6QsCJg7LMqXBRrkowljL3z2TaAKFIvBLhHJ
# ============================================
WORKER_ENV = "staging"
# Story 5.2: Worker versioning - Updated for full DNS cutover
WORKER_BUILD_VERSION = "stg-2025.12.13-story5.2"
UPSTREAM_TIMEOUT_MS = "30000"
# Story 5.2: Worker-only mode - NO GAS backend calls
BACKEND_MODE = "worker"
# ============================================
# DEPRECATED GAS VARS (Story 5.2)
# ============================================
# These vars are NO LONGER USED. All traffic routes through Worker-native implementations.
# Kept for emergency rollback only (NOT RECOMMENDED).
# ============================================
# STAGING_DEPLOYMENT_ID = "AKfycbwFneYCpkio7wCn7y08eDUb2PRCPc2Tdtbv20L4AbEHvuCvoqY9ks7-ONL0pzPPw4Hm"
# STAGING_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwFneYCpkio7wCn7y08eDUb2PRCPc2Tdtbv20L4AbEHvuCvoqY9ks7-ONL0pzPPw4Hm/exec"
# DEPLOYMENT_ID = "AKfycbwFneYCpkio7wCn7y08eDUb2PRCPc2Tdtbv20L4AbEHvuCvoqY9ks7-ONL0pzPPw4Hm"
# GAS_DEPLOYMENT_BASE_URL = "https://script.google.com/macros/s/AKfycbwFneYCpkio7wCn7y08eDUb2PRCPc2Tdtbv20L4AbEHvuCvoqY9ks7-ONL0pzPPw4Hm/exec"

# ============================================
# SECRETS - Worker Admin Authentication (Story 3.1)
# ============================================
# Admin API endpoints require authentication via Bearer token.
# Configure ADMIN_TOKEN as a Cloudflare secret:
#
#   wrangler secret put ADMIN_TOKEN
#
# Clients must send the token in the Authorization header:
#   Authorization: Bearer <ADMIN_TOKEN>
#
# Or as a query parameter (legacy, for backward compatibility):
#   ?adminKey=<ADMIN_TOKEN>
#
# Protected endpoints (return 401 without valid token):
#   - /api/admin/*
#   - /api/v2/admin/*
#   - /api/events/:id/adminBundle
#
# Note: In dev mode (ADMIN_TOKEN not set), admin endpoints allow access
# with a warning logged. In production, ADMIN_TOKEN MUST be configured.
#
# Security Notes:
#   - Rotate tokens periodically
#   - Never log tokens (even in error messages)
#   - Phase 2 will add scoped keys and JWT support
# ============================================
