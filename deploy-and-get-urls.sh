#!/bin/bash
# Deploy to Apps Script and output test URLs for all tenants

set -e

echo "ğŸš€ Deploying to Google Apps Script..."
echo ""

# Push latest code
echo "ğŸ“¤ Pushing code to Apps Script..."
npx @google/clasp push --force

echo ""
echo "âœ… Code pushed successfully!"
echo ""

# Create new deployment
echo "ğŸ“¦ Creating new deployment..."
DEPLOY_OUTPUT=$(npx @google/clasp deploy --description "Deployment $(date '+%Y-%m-%d %H:%M:%S')" 2>&1)
echo "$DEPLOY_OUTPUT"

echo ""
echo "ğŸ” Getting deployment information..."
DEPLOYMENTS=$(npx @google/clasp deployments 2>&1)
echo "$DEPLOYMENTS"
echo ""

# Try to extract URL from deployments output
WEBAPP_URL=$(echo "$DEPLOYMENTS" | grep -oP 'https://script\.google\.com/macros/s/[^\s]+' | head -1)

# If no URL found, provide instructions to get it
if [ -z "$WEBAPP_URL" ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… DEPLOYMENT SUCCESSFUL!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "âš ï¸  Please get your Web App URL manually:"
    echo ""
    echo "1. Open: https://script.google.com/home/projects/1KttRXT0Sq2663irNS0FlUi3mMkHL9QisErtY4pAqwtqPKH2ZuS7y_Upe/edit"
    echo "2. Click 'Deploy' â†’ 'Manage deployments'"
    echo "3. Find deployment @21 (most recent)"
    echo "4. Copy the 'Web app' URL"
    echo ""
    echo "Then use this URL format for testing:"
    echo ""
    echo "Root Admin:     {URL}?page=admin&tenant=root"
    echo "Root Analytics: {URL}?page=report&tenant=root"
    echo "ABC Admin:      {URL}?page=admin&tenant=abc"
    echo "ABC Analytics:  {URL}?page=report&tenant=abc"
    echo ""
    exit 0
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“‹ BASE URL:"
echo "$WEBAPP_URL"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ¢ ROOT TENANT (Zeventbook)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Admin Page:"
echo "${WEBAPP_URL}?page=admin&tenant=root"
echo ""
echo "ğŸ“Š Shared Analytics (NEW!):"
echo "${WEBAPP_URL}?page=report&tenant=root"
echo ""
echo "Public Page:"
echo "${WEBAPP_URL}?page=public&tenant=root"
echo ""
echo "Display Page (TV):"
echo "${WEBAPP_URL}?page=display&tenant=root"
echo ""
echo "Poster Page (Print):"
echo "${WEBAPP_URL}?page=poster&tenant=root"
echo ""
echo "Test Dashboard:"
echo "${WEBAPP_URL}?page=test&tenant=root"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ¯ ABC TENANT (American Bocce Co.)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Admin Page:"
echo "${WEBAPP_URL}?page=admin&tenant=abc"
echo ""
echo "ğŸ“Š Shared Analytics (NEW!):"
echo "${WEBAPP_URL}?page=report&tenant=abc"
echo ""
echo "Public Page:"
echo "${WEBAPP_URL}?page=public&tenant=abc"
echo ""
echo "Display Page (TV):"
echo "${WEBAPP_URL}?page=display&tenant=abc"
echo ""
echo "Poster Page (Print):"
echo "${WEBAPP_URL}?page=poster&tenant=abc"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ† CBC TENANT (Chicago Bocce Club)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Admin Page:"
echo "${WEBAPP_URL}?page=admin&tenant=cbc"
echo ""
echo "ğŸ“Š Shared Analytics (NEW!):"
echo "${WEBAPP_URL}?page=report&tenant=cbc"
echo ""
echo "Public Page:"
echo "${WEBAPP_URL}?page=public&tenant=cbc"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âš½ CBL TENANT (Chicago Bocce League)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Admin Page:"
echo "${WEBAPP_URL}?page=admin&tenant=cbl"
echo ""
echo "ğŸ“Š Shared Analytics (NEW!):"
echo "${WEBAPP_URL}?page=report&tenant=cbl"
echo ""
echo "Public Page:"
echo "${WEBAPP_URL}?page=public&tenant=cbl"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“š API & DOCUMENTATION"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "API Documentation:"
echo "${WEBAPP_URL}?page=api"
echo ""
echo "System Status:"
echo "${WEBAPP_URL}?page=status"
echo ""
echo "Diagnostics:"
echo "${WEBAPP_URL}?page=diagnostics&tenant=root"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ’¡ TESTING TIPS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "1. Start with Admin page to create test events"
echo "2. Check the Shared Analytics page (NEW feature!)"
echo "3. Test mobile responsiveness (F12 â†’ Toggle device)"
echo "4. Verify all TRIANGLE pages (Admin â†’ Poster â†’ Display â†’ Public)"
echo ""
echo "ğŸ“ Save these URLs for easy testing!"
echo ""
