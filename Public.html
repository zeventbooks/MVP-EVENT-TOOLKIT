<!--
================================================================================
MVP SURFACE - Focus Group Critical
================================================================================
Page: Public.html
Purpose: Public-facing event listing and registration page
Status: LOCKED for MVP v1.0

DO NOT modify this file's contracts without updating:
  - NUSDK.html (API client)
  - tests/e2e/* (end-to-end tests)
  - tests/unit/* (unit tests)

Related MVP Surfaces: Admin, Poster, Display, Sponsor, SharedReport
================================================================================
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> ¬∑ Public</title>
  <?!= include('Styles'); ?>
  <?!= include('DemoMode'); ?>
  <?!= include('SponsorUtils'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="referrer" content="no-referrer"/>
  <style>
    .card{ background:#fff; border-radius:12px; padding:20px; margin-bottom:20px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .card h2{ margin:0 0 16px; color:#1e293b; }
    .events-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:16px; }
    .event-card{ background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:16px; transition:all 0.2s; }
    .event-card:hover{ transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.1); border-color:#2563eb; }
    .event-card h3{ margin:0 0 8px; color:#1e293b; }
    .event-card p{ margin:4px 0; color:#64748b; font-size:14px; }

    /* Enhanced Sponsor Banner */
    .sponsor-banner{
      background:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border:2px solid #e2e8f0; border-radius:12px; padding:20px;
      margin-bottom:24px; text-align:center; display:flex; align-items:center;
      justify-content:center; gap:16px; flex-wrap:wrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .sponsor-banner img{
      max-height:60px; max-width:220px; object-fit:contain;
      transition: transform 0.2s ease;
    }
    .sponsor-banner img:hover {
      transform: scale(1.05);
    }
    .sponsor-banner strong{
      color:#1e293b; font-size:1.1em; font-weight:600;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .sponsor-banner a {
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .sponsor-indicator {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 500;
    }
    .sponsor-banner {
      position: relative;
      transition: opacity 0.3s ease;
    }

    /* Event Detail View */
    .event-detail {
      max-width: 800px;
      margin: 0 auto;
    }
    .event-header {
      text-align: center;
      margin-bottom: 24px;
    }
    .event-header h1 {
      color: #2563eb;
      font-size: 2.2rem;
      margin-bottom: 12px;
      line-height: 1.2;
    }
    .event-meta {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
      margin: 12px 0;
      color: #475569;
      font-size: 1rem;
    }
    .event-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .event-meta-item strong {
      color: #1e293b;
    }
    .event-image {
      width: 100%;
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      margin: 24px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .event-video {
      width: 100%;
      max-width: 100%;
      aspect-ratio: 16/9;
      border-radius: 12px;
      margin: 24px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .event-section {
      margin: 32px 0;
    }
    .event-section h2 {
      color: #1e293b;
      font-size: 1.5rem;
      margin-bottom: 12px;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 8px;
    }
    .event-section p {
      color: #475569;
      line-height: 1.7;
      margin: 12px 0;
    }
    .event-section a {
      color: #2563eb;
      text-decoration: none;
      font-weight: 500;
    }
    .event-section a:hover {
      text-decoration: underline;
    }
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    .gallery img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .gallery img:hover {
      transform: scale(1.05);
    }
    /* Schedule section */
    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .schedule-item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px 16px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 3px solid #2563eb;
    }
    .schedule-time {
      font-weight: 600;
      color: #2563eb;
      white-space: nowrap;
    }
    .schedule-title {
      font-weight: 600;
      color: #1e293b;
    }
    .schedule-desc {
      grid-column: 2;
      color: #64748b;
      font-size: 0.9rem;
    }
    /* Fundraising progress */
    .fundraising-progress {
      margin: 16px 0;
    }
    .fundraising-progress .progress-bar {
      height: 24px;
      background: #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
    }
    .fundraising-progress .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      border-radius: 12px;
      transition: width 0.5s ease;
    }
    .fundraising-progress .progress-text {
      text-align: center;
      margin-top: 8px;
      font-weight: 600;
      color: #059669;
    }
    /* Data tables (standings, etc.) */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .data-table th, .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    .data-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #475569;
      font-size: 0.8rem;
      text-transform: uppercase;
    }
    .data-table tbody tr:hover {
      background: #f8fafc;
    }
    .standings-table .rank {
      display: inline-block;
      width: 24px;
      height: 24px;
      line-height: 24px;
      text-align: center;
      background: #e2e8f0;
      border-radius: 50%;
      font-weight: 600;
      font-size: 0.75rem;
      margin-right: 8px;
    }
    .standings-table .top-rank .rank {
      background: #fef3c7;
      color: #92400e;
    }
    .standings-table .top-rank:first-child .rank {
      background: #fcd34d;
      color: #78350f;
    }
    /* Vendor grid */
    .vendor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }
    .vendor-card {
      padding: 16px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
    }
    .vendor-card h4 {
      margin: 0 0 8px 0;
      color: #1e293b;
    }
    .vendor-card p {
      margin: 0 0 12px 0;
      color: #64748b;
      font-size: 0.9rem;
    }
    .vendor-card a {
      color: #2563eb;
      text-decoration: none;
      font-weight: 500;
    }
    /* Bracket/Tournament styling */
    .bracket-container {
      overflow-x: auto;
    }
    .bracket-rounds {
      display: flex;
      gap: 24px;
      min-width: max-content;
      padding: 12px 0;
    }
    .bracket-round {
      min-width: 200px;
    }
    .round-title {
      font-size: 0.85rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }
    .bracket-matches {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .bracket-match-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .match-num {
      font-size: 0.75rem;
      color: #94a3b8;
      font-weight: 600;
      min-width: 28px;
    }
    .bracket-match {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      flex: 1;
    }
    .match-team {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: white;
      border-radius: 6px;
      margin: 4px 0;
    }
    .match-team.winner {
      background: #dcfce7;
      border-left: 3px solid #22c55e;
    }
    .team-name {
      font-weight: 500;
      color: #1e293b;
    }
    .team-score {
      font-weight: 700;
      color: #2563eb;
      font-size: 1.1rem;
    }
    .match-vs {
      text-align: center;
      font-size: 0.7rem;
      color: #94a3b8;
      text-transform: uppercase;
      margin: 2px 0;
    }
    /* Loading placeholder */
    .loading-placeholder {
      padding: 24px;
      text-align: center;
      color: #64748b;
      background: #f8fafc;
      border-radius: 8px;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .action-buttons {
      display: flex;
      gap: 12px;
      margin: 24px 0;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* Mobile: Sticky bottom buttons for one-handed use */
    @media (max-width: 640px) {
      body {
        padding-bottom: 80px; /* Space for sticky buttons */
      }

      .events-grid{ grid-template-columns:1fr; }
      .sponsor-banner{ flex-direction:column; padding:16px; gap:12px; }
      .sponsor-banner img{ max-height:50px; }
      .event-header h1 { font-size: 1.75rem; }
      .event-meta { font-size: 0.9rem; gap: 12px; }
      .gallery { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
      .gallery img { height: 150px; }

      /* Sticky action buttons at bottom for thumb reach */
      .action-buttons {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 12px 16px;
        margin: 0;
        box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
        z-index: 100;
        border-top: 2px solid #e2e8f0;
        flex-direction: column;
        gap: 8px;
      }

      .action-buttons .btn-primary,
      .action-buttons .btn-secondary {
        width: 100%;
        margin: 0;
      }

      .event-image,
      .event-video {
        margin: 16px 0;
      }

      .event-section {
        margin: 24px 0;
      }
    }

    /* === MVP Essential Additions === */

    /* Loading Skeletons */
    .skeleton {
      background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton-title { height: 2.5rem; width: 70%; margin: 0 auto 16px; }
    .skeleton-meta { height: 1.2rem; width: 50%; margin: 8px auto; }
    .skeleton-image { height: 300px; width: 100%; margin: 24px 0; }
    .skeleton-button { height: 44px; width: 140px; display: inline-block; margin: 8px; }
    .skeleton-text { height: 1rem; width: 100%; margin: 8px 0; }
    .skeleton-text.short { width: 60%; }

    /* Utility Action Bar (Maps, Calendar, Share) */
    .utility-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 16px 0;
    }
    .btn-utility {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      color: #475569;
      font-size: 0.875rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-utility:hover {
      background: #e2e8f0;
      color: #1e293b;
      border-color: #cbd5e1;
    }
    .btn-utility:active {
      transform: scale(0.98);
    }

    /* Calendar Dropdown */
    .calendar-dropdown {
      position: relative;
      display: inline-block;
    }
    .calendar-menu {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 8px 0;
      min-width: 180px;
      z-index: 200;
      display: none;
    }
    .calendar-dropdown.open .calendar-menu {
      display: block;
    }
    .calendar-menu a {
      display: block;
      padding: 10px 16px;
      color: #475569;
      text-decoration: none;
      font-size: 0.875rem;
    }
    .calendar-menu a:hover {
      background: #f1f5f9;
      color: #1e293b;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #1e293b;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 300;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Trust Footer */
    .site-footer {
      text-align: center;
      padding: 32px 16px;
      margin-top: 48px;
      border-top: 1px solid #e2e8f0;
      color: #94a3b8;
      font-size: 0.75rem;
    }
    .site-footer a {
      color: #64748b;
      text-decoration: none;
    }
    .site-footer a:hover {
      color: #2563eb;
      text-decoration: underline;
    }

    /* Better Empty States */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #64748b;
    }
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .empty-state h3 {
      color: #475569;
      margin-bottom: 8px;
      font-size: 1.25rem;
    }
    .empty-state p {
      margin-bottom: 16px;
      line-height: 1.6;
    }

    /* Error State */
    .error-state {
      text-align: center;
      padding: 48px 24px;
      background: #fef2f2;
      border-radius: 12px;
      border: 1px solid #fecaca;
    }
    .error-state-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
    }
    .error-state h3 {
      color: #dc2626;
      margin-bottom: 8px;
    }
    .error-state p {
      color: #b91c1c;
      margin-bottom: 16px;
    }
    .btn-retry {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
    }
    .btn-retry:hover {
      background: #b91c1c;
    }

    /* Mobile adjustments for utility buttons */
    @media (max-width: 640px) {
      .utility-buttons {
        flex-direction: column;
        align-items: stretch;
        padding: 0 16px;
      }
      .btn-utility {
        justify-content: center;
      }
      .calendar-menu {
        left: 0;
        right: 0;
        transform: none;
        width: auto;
      }
      .site-footer {
        padding-bottom: 100px; /* Space for sticky buttons */
      }
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-badge.active {
      background: #dcfce7;
      color: #166534;
    }
    .status-badge.upcoming {
      background: #dbeafe;
      color: #1e40af;
    }
    .status-badge.ended {
      background: #f1f5f9;
      color: #64748b;
    }
    .status-badge.cancelled {
      background: #fef2f2;
      color: #dc2626;
    }

    /* League Info Card */
    .league-info-card {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 12px;
      padding: 24px;
    }
    .league-links {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .league-link-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px 24px;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      text-decoration: none;
      color: #1e293b;
      transition: all 0.2s;
      min-width: 120px;
    }
    .league-link-btn:hover {
      border-color: #2563eb;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
      transform: translateY(-2px);
    }
    .league-link-icon {
      font-size: 1.5rem;
    }
    .league-link-label {
      font-size: 0.875rem;
      font-weight: 600;
    }
    .league-data-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e2e8f0;
    }

    /* Sponsor tier badge */
    .sponsor-tier {
      display: inline-block;
      padding: 2px 8px;
      background: #fef3c7;
      color: #92400e;
      font-size: 0.7rem;
      font-weight: 600;
      border-radius: 10px;
      text-transform: uppercase;
      margin-left: 8px;
    }

    @media (max-width: 640px) {
      .league-links {
        flex-direction: column;
      }
      .league-link-btn {
        flex-direction: row;
        justify-content: flex-start;
        gap: 12px;
        padding: 12px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><?= appTitle ?></h1>
    <div id="sponsorBanner" hidden></div>
    <section class="card">
      <h2>Events</h2>
      <div id="list" class="events-grid">
        <!-- Skeleton loader shown during fetch -->
        <div class="skeleton-loader">
          <div class="skeleton skeleton-title"></div>
          <div class="skeleton skeleton-meta"></div>
          <div class="skeleton skeleton-meta" style="width: 40%;"></div>
          <div style="text-align: center; margin: 16px 0;">
            <div class="skeleton skeleton-button"></div>
            <div class="skeleton skeleton-button"></div>
          </div>
          <div class="skeleton skeleton-image"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Toast notification -->
  <div id="toast" class="toast"></div>

  <!-- Trust Footer -->
  <footer class="site-footer">
    <p>Powered by <a href="https://eventangle.com" target="_blank" rel="noopener">EventAngle</a></p>
  </footer>

  <script>
    const BRAND = '<?= brandId ?>';
    const SCOPE = '<?= scope ?>';
    const EXEC_URL = '<?= execUrl ?>';
    const url = new URL(location.href);
    const ID = url.searchParams.get('id');

    // Use shared utilities from SponsorUtils
    const { esc, logEvent, initLogging } = window.SponsorUtils;
    initLogging();

    // === MVP Essential Utilities ===

    // Toast notification
    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    // === League & Broadcast Link Analytics ===
    // Logs external link clicks with sponsor attribution context
    let currentEventId = null; // Set when event is loaded
    let currentRenderedSponsorIds = []; // Track sponsors visible on page for attribution

    function onLeagueLinkClick(e) {
      const linkType = e.currentTarget.dataset.linkType;
      if (!linkType || !currentEventId) return;

      // Fire and forget - don't block the navigation
      // Include sessionId and visibleSponsorIds for sponsor/BBN attribution
      NU.rpc('api_logExternalClick', {
        eventId: currentEventId,
        linkType: linkType,
        surface: 'public',
        sessionId: window.SponsorUtils?.getSessionId?.() || '',
        visibleSponsorIds: currentRenderedSponsorIds
      }).catch(err => console.warn('Failed to log external click:', err));
    }

    // === Google Sheets "Bring Your Own Data" ===

    // Detect if URL is a Google Sheets URL and extract sheet ID
    function parseGoogleSheetUrl(url) {
      if (!url) return null;
      const match = url.match(/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
      if (match) {
        return { sheetId: match[1], originalUrl: url };
      }
      return null;
    }

    // Convert Google Sheets URL to CSV export URL
    function getSheetCsvUrl(sheetId, sheetName = '') {
      let csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;
      if (sheetName) csvUrl += `&sheet=${encodeURIComponent(sheetName)}`;
      return csvUrl;
    }

    // Fetch and parse CSV data from Google Sheets
    async function fetchSheetData(url) {
      const sheetInfo = parseGoogleSheetUrl(url);
      if (!sheetInfo) return null; // Not a Google Sheet, fallback to link

      try {
        const csvUrl = getSheetCsvUrl(sheetInfo.sheetId);
        const response = await fetch(csvUrl);
        if (!response.ok) return null;

        const csvText = await response.text();
        return parseCSV(csvText);
      } catch (e) {
        console.warn('Failed to fetch sheet data:', e);
        return null; // Fallback to link on error
      }
    }

    // Simple CSV parser (handles quoted fields)
    function parseCSV(csv) {
      const lines = csv.split('\n').filter(line => line.trim());
      if (lines.length === 0) return { headers: [], rows: [] };

      const parseRow = (line) => {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim());
        return result;
      };

      const headers = parseRow(lines[0]);
      const rows = lines.slice(1).map(parseRow);
      return { headers, rows };
    }

    // Render standings table from sheet data
    function renderStandingsTable(data) {
      if (!data || !data.rows.length) return '<p class="muted">No standings data available.</p>';

      let html = '<table class="data-table standings-table">';
      html += '<thead><tr>';
      data.headers.forEach((h, i) => {
        html += `<th>${esc(h)}</th>`;
      });
      html += '</tr></thead><tbody>';

      data.rows.forEach((row, idx) => {
        html += `<tr class="${idx < 3 ? 'top-rank' : ''}">`;
        row.forEach((cell, i) => {
          if (i === 0) {
            html += `<td><span class="rank">${idx + 1}</span> ${esc(cell)}</td>`;
          } else {
            html += `<td>${esc(cell)}</td>`;
          }
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      return html;
    }

    // Render schedule/agenda from sheet data
    function renderScheduleTable(data) {
      if (!data || !data.rows.length) return '<p class="muted">No schedule data available.</p>';

      let html = '<div class="schedule-list">';
      data.rows.forEach(row => {
        const [time, title, description] = row;
        html += '<div class="schedule-item">';
        if (time) html += `<span class="schedule-time">${esc(time)}</span>`;
        if (title) html += `<span class="schedule-title">${esc(title)}</span>`;
        if (description) html += `<span class="schedule-desc">${esc(description)}</span>`;
        html += '</div>';
      });
      html += '</div>';
      return html;
    }

    // Render vendor list from sheet data
    function renderVendorList(data) {
      if (!data || !data.rows.length) return '<p class="muted">No vendor data available.</p>';

      let html = '<div class="vendor-grid">';
      data.rows.forEach(row => {
        const [name, description, url] = row;
        html += '<div class="vendor-card">';
        html += `<h4>${esc(name || 'Vendor')}</h4>`;
        if (description) html += `<p>${esc(description)}</p>`;
        if (url) html += `<a href="${esc(url)}" target="_blank" rel="noopener">Visit ‚Üí</a>`;
        html += '</div>';
      });
      html += '</div>';
      return html;
    }

    // Render bracket/tournament from sheet data
    // Supports formats: Round, Match, Team1, Score1, Team2, Score2 -OR- Team1, Team2, Winner, Score
    function renderBracketTable(data) {
      if (!data || !data.rows.length) return '<p class="muted">No bracket data available.</p>';

      // Detect format based on headers
      const headers = data.headers.map(h => h.toLowerCase());
      const hasRound = headers.some(h => h.includes('round'));

      let html = '<div class="bracket-container">';

      if (hasRound) {
        // Group by round for tournament bracket view
        const rounds = {};
        data.rows.forEach(row => {
          const round = row[0] || 'Round 1';
          if (!rounds[round]) rounds[round] = [];
          rounds[round].push(row.slice(1)); // Rest of columns are match data
        });

        html += '<div class="bracket-rounds">';
        Object.keys(rounds).forEach(round => {
          html += `<div class="bracket-round">`;
          html += `<h4 class="round-title">${esc(round)}</h4>`;
          rounds[round].forEach(match => {
            html += renderBracketMatch(match, headers.slice(1));
          });
          html += '</div>';
        });
        html += '</div>';
      } else {
        // Simple match list format
        html += '<div class="bracket-matches">';
        data.rows.forEach((row, idx) => {
          html += `<div class="bracket-match-row">`;
          html += `<span class="match-num">#${idx + 1}</span>`;
          html += renderBracketMatch(row, headers);
          html += '</div>';
        });
        html += '</div>';
      }

      html += '</div>';
      return html;
    }

    // Render a single bracket match
    function renderBracketMatch(row, headers) {
      // Try to identify team columns and scores
      const team1 = row[0] || '‚Äî';
      const team2 = row[headers.indexOf('team2') > -1 ? headers.indexOf('team2') : 2] || row[2] || '‚Äî';
      const score1 = row[1] || '';
      const score2 = row[3] || '';
      const winner = row[headers.indexOf('winner') > -1 ? headers.indexOf('winner') : row.length - 1] || '';

      let html = '<div class="bracket-match">';
      html += `<div class="match-team ${winner && winner.toLowerCase() === team1.toLowerCase() ? 'winner' : ''}">`;
      html += `<span class="team-name">${esc(team1)}</span>`;
      if (score1) html += `<span class="team-score">${esc(score1)}</span>`;
      html += '</div>';
      html += '<div class="match-vs">vs</div>';
      html += `<div class="match-team ${winner && winner.toLowerCase() === team2.toLowerCase() ? 'winner' : ''}">`;
      html += `<span class="team-name">${esc(team2)}</span>`;
      if (score2) html += `<span class="team-score">${esc(score2)}</span>`;
      html += '</div>';
      html += '</div>';
      return html;
    }

    // Map CTA label to URL from event data
    function getCTAUrl(data, label) {
      const labelLower = label.toLowerCase();
      // Map common CTA labels to data fields
      if (labelLower.includes('register') || labelLower.includes('rsvp')) return data.registerUrl || data.signupUrl;
      if (labelLower.includes('sign up')) return data.signupUrl || data.registerUrl;
      if (labelLower.includes('donate')) return data.donationUrl;
      if (labelLower.includes('ticket')) return data.ticketUrl || data.registerUrl;
      if (labelLower.includes('registry')) return data.registryUrl;
      if (labelLower.includes('schedule') || labelLower.includes('itinerary')) return data.scheduleUrl;
      if (labelLower.includes('standing')) return data.standingsUrl;
      if (labelLower.includes('bracket')) return data.bracketUrl;
      if (labelLower.includes('photo') || labelLower.includes('album')) return data.albumUrl;
      if (labelLower.includes('download')) return data.downloadUrl;
      if (labelLower.includes('vendor')) return data.vendorListUrl;
      if (labelLower.includes('calendar')) return buildGoogleCalendarUrl(data);
      if (labelLower.includes('direction') || labelLower.includes('map')) return buildMapsUrl(data.location);
      if (labelLower.includes('rule')) return data.rulesUrl;
      if (labelLower.includes('roster') || labelLower.includes('team')) return data.rosterUrl;
      // Fallback to generic URLs
      return data.registerUrl || data.signupUrl || data.summaryLink;
    }

    // Build Google Maps URL from location string
    function buildMapsUrl(location) {
      if (!location) return null;
      const encoded = encodeURIComponent(location);
      return `https://www.google.com/maps/search/?api=1&query=${encoded}`;
    }

    // Build Google Calendar URL
    function buildGoogleCalendarUrl(data) {
      if (!data.name || !data.dateISO) return null;
      const params = new URLSearchParams();
      params.set('action', 'TEMPLATE');
      params.set('text', data.name);

      // Format date: YYYYMMDD or with time YYYYMMDDTHHMMSS
      let startDate = data.dateISO.replace(/-/g, '');
      let endDate = startDate;
      if (data.timeISO) {
        // Parse time like "7:00 PM" or "19:00"
        const timeParts = data.timeISO.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
        if (timeParts) {
          let hours = parseInt(timeParts[1]);
          const mins = timeParts[2];
          const ampm = timeParts[3];
          if (ampm && ampm.toUpperCase() === 'PM' && hours < 12) hours += 12;
          if (ampm && ampm.toUpperCase() === 'AM' && hours === 12) hours = 0;
          startDate += 'T' + String(hours).padStart(2, '0') + mins + '00';
          // Assume 2 hour event
          const endHours = (hours + 2) % 24;
          endDate += 'T' + String(endHours).padStart(2, '0') + mins + '00';
        }
      }
      params.set('dates', `${startDate}/${endDate}`);

      if (data.location) params.set('location', data.location);
      if (data.summary) params.set('details', data.summary);

      return `https://calendar.google.com/calendar/render?${params.toString()}`;
    }

    // Generate ICS file content for Apple/Outlook
    function generateICS(data) {
      if (!data.name || !data.dateISO) return null;

      const formatDate = (dateStr, timeStr) => {
        let dt = dateStr.replace(/-/g, '');
        if (timeStr) {
          const timeParts = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
          if (timeParts) {
            let hours = parseInt(timeParts[1]);
            const mins = timeParts[2];
            const ampm = timeParts[3];
            if (ampm && ampm.toUpperCase() === 'PM' && hours < 12) hours += 12;
            if (ampm && ampm.toUpperCase() === 'AM' && hours === 12) hours = 0;
            dt += 'T' + String(hours).padStart(2, '0') + mins + '00';
          }
        }
        return dt;
      };

      const start = formatDate(data.dateISO, data.timeISO);
      const end = data.timeISO
        ? formatDate(data.dateISO, data.timeISO).replace(/T(\d{2})/, (m, h) => 'T' + String((parseInt(h) + 2) % 24).padStart(2, '0'))
        : start;

      const ics = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//EventAngle//Event//EN',
        'BEGIN:VEVENT',
        `DTSTART:${start}`,
        `DTEND:${end}`,
        `SUMMARY:${data.name.replace(/[,;\\]/g, ' ')}`,
        data.location ? `LOCATION:${data.location.replace(/[,;\\]/g, ' ')}` : '',
        data.summary ? `DESCRIPTION:${data.summary.replace(/[,;\\]/g, ' ').substring(0, 200)}` : '',
        `UID:${Date.now()}@eventangle.com`,
        'END:VEVENT',
        'END:VCALENDAR'
      ].filter(Boolean).join('\r\n');

      return ics;
    }

    // Download ICS file
    function downloadICS(data) {
      const ics = generateICS(data);
      if (!ics) return;

      const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${(data.name || 'event').replace(/[^a-z0-9]/gi, '-')}.ics`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Calendar file downloaded');
    }

    // Share event (Web Share API with clipboard fallback)
    async function shareEvent(data) {
      const shareData = {
        title: data.name || 'Event',
        text: `Check out this event: ${data.name}`,
        url: window.location.href
      };

      if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
        try {
          await navigator.share(shareData);
        } catch (err) {
          if (err.name !== 'AbortError') {
            copyToClipboard();
          }
        }
      } else {
        copyToClipboard();
      }
    }

    // Copy link to clipboard
    function copyToClipboard() {
      navigator.clipboard.writeText(window.location.href).then(() => {
        showToast('Link copied to clipboard');
      }).catch(() => {
        // Fallback for older browsers
        const input = document.createElement('input');
        input.value = window.location.href;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        showToast('Link copied to clipboard');
      });
    }

    // Toggle calendar dropdown
    function toggleCalendarDropdown(e) {
      e.stopPropagation();
      const dropdown = e.target.closest('.calendar-dropdown');
      dropdown.classList.toggle('open');

      // Close when clicking outside
      const closeDropdown = () => {
        dropdown.classList.remove('open');
        document.removeEventListener('click', closeDropdown);
      };
      if (dropdown.classList.contains('open')) {
        setTimeout(() => document.addEventListener('click', closeDropdown), 0);
      }
    }

    // Store current event data for utility functions
    let currentEventData = null;

    async function rpc(method, payload) {
      return new Promise((resolve) => {
        google.script.run
          .withSuccessHandler(res => resolve(res))
          .withFailureHandler(err => resolve({ ok: false, code: 'INTERNAL', message: String(err) }))
          [method](payload);
      });
    }

    // Sponsor carousel state
    let sponsorCarouselTimer = null;
    let currentSponsorIndex = 0;

    // Render sponsor banner from legacy format (ev.data.sponsors with placements)
    function renderSponsorBanner(ev) {
      const picks = (ev?.data?.sponsors || []).filter(s => s?.placements?.mobileBanner);
      if (!picks.length) return;

      // Track rendered sponsor IDs for BBN attribution
      currentRenderedSponsorIds = picks.map(s => s.id).filter(Boolean);

      const banner = document.getElementById('sponsorBanner');
      const eventId = ev.id;

      // Render single sponsor
      function showSponsor(index) {
        const s = picks[index];
        const link = s.url ? `<a href="${esc(s.url)}" target="_blank" rel="noopener sponsored" class="sponsor-link" data-sponsor-id="${esc(s.id || '')}">` : '';
        const linkClose = s.url ? '</a>' : '';

        banner.innerHTML = `
          ${link}
            ${s.img ? `<img src="${esc(s.img)}" alt="${esc(s.name || '')}">` : ''}
            <strong>${esc(s.name || '')}</strong>
          ${linkClose}
          ${picks.length > 1 ? `<span class="sponsor-indicator">${index + 1}/${picks.length}</span>` : ''}
        `;

        // Log impression for this sponsor
        logEvent({ eventId, surface: 'public', metric: 'impression', sponsorId: s.id || '' });

        // Attach click handler
        const linkEl = banner.querySelector('.sponsor-link');
        if (linkEl) {
          linkEl.addEventListener('click', () => {
            logEvent({ eventId, surface: 'public', metric: 'click', sponsorId: s.id || '' });
          });
        }
      }

      // Show first sponsor
      showSponsor(0);
      banner.hidden = false;

      // Start carousel if multiple sponsors (rotate every 5 seconds)
      if (picks.length > 1) {
        if (sponsorCarouselTimer) clearInterval(sponsorCarouselTimer);
        sponsorCarouselTimer = setInterval(() => {
          currentSponsorIndex = (currentSponsorIndex + 1) % picks.length;
          showSponsor(currentSponsorIndex);
        }, 5000);
      }
    }

    // Render sponsor banner from EVENT_CONTRACT.md format (hydrated sponsors array)
    function renderSponsorBannerFromArray(eventId, sponsors) {
      if (!sponsors || !sponsors.length) return;

      const banner = document.getElementById('sponsorBanner');
      const picks = sponsors.filter(s => s.name); // Filter out invalid sponsors

      if (!picks.length) return;

      // Track rendered sponsor IDs for BBN attribution
      currentRenderedSponsorIds = picks.map(s => s.id).filter(Boolean);

      // Render single sponsor
      function showSponsor(index) {
        const s = picks[index];
        const link = s.website ? `<a href="${esc(s.website)}" target="_blank" rel="noopener sponsored" class="sponsor-link" data-sponsor-id="${esc(s.id || '')}">` : '';
        const linkClose = s.website ? '</a>' : '';
        const tierBadge = s.tier ? `<span class="sponsor-tier">${esc(s.tier)}</span>` : '';

        banner.innerHTML = `
          ${link}
            ${s.logoUrl ? `<img src="${esc(s.logoUrl)}" alt="${esc(s.name || '')}">` : ''}
            <strong>${esc(s.name || '')}</strong>
            ${tierBadge}
          ${linkClose}
          ${picks.length > 1 ? `<span class="sponsor-indicator">${index + 1}/${picks.length}</span>` : ''}
        `;

        // Log impression for this sponsor
        logEvent({ eventId, surface: 'public', metric: 'impression', sponsorId: s.id || '' });

        // Attach click handler
        const linkEl = banner.querySelector('.sponsor-link');
        if (linkEl) {
          linkEl.addEventListener('click', () => {
            logEvent({ eventId, surface: 'public', metric: 'click', sponsorId: s.id || '' });
          });
        }
      }

      // Show first sponsor
      showSponsor(0);
      banner.hidden = false;

      // Start carousel if multiple sponsors (rotate every 5 seconds)
      if (picks.length > 1) {
        if (sponsorCarouselTimer) clearInterval(sponsorCarouselTimer);
        currentSponsorIndex = 0;
        sponsorCarouselTimer = setInterval(() => {
          currentSponsorIndex = (currentSponsorIndex + 1) % picks.length;
          showSponsor(currentSponsorIndex);
        }, 5000);
      }
    }

    /**
     * Render event list view
     * EVENT_CONTRACT.md v2.0: Consumes canonical Event shapes from api_list
     * Uses: event.name, event.startDateISO, event.venue
     */
    async function renderList(items) {
      const root = document.getElementById('list');
      root.innerHTML = '';
      if (!items || !items.length) {
        root.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìÖ</div>
            <h3>No Upcoming Events</h3>
            <p>Check back soon for new events, or contact the organizer for more information.</p>
          </div>
        `;
        return;
      }
      for (const event of items) {
        // EVENT_CONTRACT.md v2.0: Use canonical fields directly
        const name = event.name || '(untitled)';
        const startDateISO = event.startDateISO || '';
        const venue = event.venue || '';

        // Format date for display
        let dateDisplay = '';
        if (startDateISO) {
          const date = new Date(startDateISO + 'T00:00:00');
          dateDisplay = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        // Status badge based on date
        let statusBadge = '';
        if (startDateISO) {
          const eventDate = new Date(startDateISO + 'T00:00:00');
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          if (eventDate.getTime() === today.getTime()) {
            statusBadge = '<span class="status-badge active" style="font-size:0.65rem;padding:2px 6px;">Today</span>';
          }
        }

        const d = document.createElement('div');
        d.className = 'event-card';
        d.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:flex-start;">
            <h3 style="flex:1;">${esc(name)}</h3>
            ${statusBadge}
          </div>
          ${dateDisplay ? `<p>üìÖ ${esc(dateDisplay)}</p>` : ''}
          ${venue ? `<p>üìç ${esc(venue)}</p>` : ''}
          <div style="margin-top:12px;">
            <a class="btn secondary" href="${EXEC_URL}?p=events&brand=${BRAND}&id=${event.id}">View Details ‚Üí</a>
          </div>
        `;
        root.appendChild(d);
      }
    }

    /**
     * Render event detail view
     * EVENT_CONTRACT.md v2.0: Consumes canonical Event shape from getPublicBundle
     *
     * Contract fields used:
     * - event.name (MVP Required)
     * - event.startDateISO (MVP Required)
     * - event.venue (MVP Required)
     * - event.ctas.primary / event.ctas.secondary (MVP Required)
     * - event.settings.showSchedule / showStandings / showBracket / showSponsors (MVP Required)
     * - event.links.* (MVP Required - never hardcode URLs)
     * - event.schedule / event.standings / event.bracket (MVP Optional)
     * - event.sponsors (V2 Optional)
     * - event.media (V2 Optional)
     * - event.externalData (V2 Optional)
     *
     * @param {Object} event - Canonical Event object per EVENT_CONTRACT.md
     * @param {Object} config - Brand config from getPublicBundle
     */
    async function renderDetail(event, config = {}) {
      const root = document.getElementById('list');

      // === CONTRACT FIELDS (MVP REQUIRED) ===
      // Trust the contract - no fallback chains
      const eventId = event.id;
      const eventName = event.name;
      const startDateISO = event.startDateISO;
      const venue = event.venue;
      const ctas = event.ctas || { primary: { label: 'Sign Up', url: '' }, secondary: null };
      const settings = event.settings || { showSchedule: false, showStandings: false, showBracket: false, showSponsors: false };
      const links = event.links || {};

      // === CONTRACT FIELDS (MVP OPTIONAL) ===
      const schedule = event.schedule || [];
      const standings = event.standings || [];
      const bracket = event.bracket || null;

      // === CONTRACT FIELDS (V2 OPTIONAL) ===
      const sponsors = event.sponsors || [];
      const media = event.media || {};
      const externalData = event.externalData || {};

      // Set currentEventId for analytics tracking
      currentEventId = eventId;

      // Build data object for utility functions (calendar, maps, share)
      const data = {
        name: eventName,
        dateISO: startDateISO,
        venue: venue,
        ctas: ctas,
        links: links,
        settings: settings
      };
      currentEventData = data;

      // === SETTINGS-BASED VISIBILITY ===
      // EVENT_CONTRACT.md v2.0: Trust event.settings.* - never invent flags
      const sectionEnabled = (key) => {
        switch (key) {
          case 'schedule': return settings.showSchedule === true;
          case 'standings': return settings.showStandings === true;
          case 'bracket': return settings.showBracket === true;
          case 'sponsors': return settings.showSponsors === true;
          default: return true; // Media sections default to visible if data exists
        }
      };

      // === RESERVED SPONSOR BAR ===
      // Always render sponsor bar container (even if empty for future use)
      const sponsorBanner = document.getElementById('sponsorBanner');
      if (sectionEnabled('sponsors') && sponsors.length > 0) {
        // Filter for public placement sponsors
        const publicSponsors = sponsors.filter(s => s.placement === 'public' || !s.placement);
        if (publicSponsors.length > 0) {
          renderSponsorBannerFromArray(eventId, publicSponsors);
        } else {
          // Reserved: Show placeholder for future sponsors
          sponsorBanner.innerHTML = '';
          sponsorBanner.hidden = true;
        }
      } else {
        // Reserved: Sponsor bar exists but hidden when no sponsors
        sponsorBanner.innerHTML = '';
        sponsorBanner.hidden = true;
      }

      // Build event detail HTML
      let html = '<div class="event-detail">';

      // Header with name and meta
      html += '<div class="event-header">';

      // Determine event status from startDateISO
      let statusBadge = '';
      if (startDateISO) {
        const eventDate = new Date(startDateISO + 'T00:00:00');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const eventDay = new Date(eventDate);
        eventDay.setHours(0, 0, 0, 0);

        if (eventDay.getTime() === today.getTime()) {
          statusBadge = '<span class="status-badge active">Today</span>';
        } else if (eventDay > today) {
          statusBadge = '<span class="status-badge upcoming">Upcoming</span>';
        } else {
          statusBadge = '<span class="status-badge ended">Past Event</span>';
        }
      }

      html += `<div style="margin-bottom: 12px;">${statusBadge}</div>`;

      // EVENT_CONTRACT.md v2.0: event.name (MVP Required)
      html += `<h1>${esc(eventName || '(untitled)')}</h1>`;

      // Meta information - event.startDateISO + event.venue (MVP Required)
      html += '<div class="event-meta">';
      if (startDateISO) {
        const date = new Date(startDateISO + 'T00:00:00');
        html += `<div class="event-meta-item"><strong>üìÖ</strong> ${date.toLocaleDateString('en-US', {
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        })}</div>`;
      }
      if (venue) {
        html += `<div class="event-meta-item"><strong>üìç</strong> ${esc(venue)}</div>`;
      }
      html += '</div>';
      html += '</div>';

      // === ACTION ROW (EVENT_CONTRACT.md v2.0: ctas.primary / ctas.secondary) ===
      html += '<div class="action-buttons">';

      // Primary CTA (MVP Required) - trust event.ctas.primary
      if (ctas.primary?.url) {
        html += `<a class="btn-primary" href="${esc(ctas.primary.url)}" target="_blank" rel="noopener">üìù ${esc(ctas.primary.label || 'Sign Up')}</a>`;
      } else if (ctas.primary?.label) {
        // CTA has label but no URL - show disabled state
        html += `<span class="btn-primary" style="opacity: 0.5; cursor: not-allowed;">üìù ${esc(ctas.primary.label)}</span>`;
      }

      // Secondary CTA (optional) - trust event.ctas.secondary
      if (ctas.secondary?.url && ctas.secondary?.label) {
        html += `<a class="btn-secondary" href="${esc(ctas.secondary.url)}" target="_blank" rel="noopener">${esc(ctas.secondary.label)}</a>`;
      }

      // Back to all events - use links.publicUrl base or fallback
      html += `<a class="btn-secondary" href="${EXEC_URL}?p=events&brand=${BRAND}">‚Üê All Events</a>`;
      html += '</div>';

      // === UTILITY BUTTONS: Maps, Calendar, Share ===
      html += '<div class="utility-buttons">';

      // Open in Maps - use media.mapUrl or build from venue
      if (media.mapUrl) {
        // Direct map URL from event.media.mapUrl (V2 Optional)
        html += `<a class="btn-utility" href="${esc(media.mapUrl)}" target="_blank" rel="noopener">üìç Open in Maps</a>`;
      } else if (venue) {
        // Build Google Maps search URL from event.venue (MVP Required)
        const mapsUrl = buildMapsUrl(venue);
        html += `<a class="btn-utility" href="${esc(mapsUrl)}" target="_blank" rel="noopener">üìç Open in Maps</a>`;
      }

      // Add to Calendar (Google URL + .ics) - uses event.startDateISO
      if (startDateISO) {
        const gcalUrl = buildGoogleCalendarUrl(data);
        html += `
          <div class="calendar-dropdown">
            <button class="btn-utility" onclick="toggleCalendarDropdown(event)">üìÖ Add to Calendar</button>
            <div class="calendar-menu">
              <a href="${esc(gcalUrl || '#')}" target="_blank" rel="noopener">üìÜ Google Calendar</a>
              <a href="#" onclick="event.preventDefault(); downloadICS(currentEventData);">üì± Apple / Outlook (.ics)</a>
            </div>
          </div>
        `;
      }

      // Share / Copy Link - uses current page URL
      html += `<button class="btn-utility" onclick="shareEvent(currentEventData)">üîó Share / Copy Link</button>`;

      html += '</div>';

      // Event Image
      if (data.imageUrl) {
        html += `<img src="${esc(data.imageUrl)}" alt="${esc(data.name || 'Event')}" class="event-image">`;
      }

      // Summary Section
      if (data.summary || data.summaryLink) {
        html += '<div class="event-section">';
        html += '<h2>About This Event</h2>';
        if (data.summary) {
          html += `<p>${esc(data.summary)}</p>`;
        }
        if (data.summaryLink) {
          html += `<p><a href="${esc(data.summaryLink)}" target="_blank" rel="noopener">Learn more ‚Üí</a></p>`;
        }
        html += '</div>';
      }

      // Video Section - Fixed: Bug #3 - XSS via video URL injection (respects sections.video)
      if (data.videoUrl && sectionEnabled('video')) {
        html += '<div class="event-section">';
        html += '<h2>Video</h2>';

        // Validate and sanitize video URL with strict regex
        const videoUrl = String(data.videoUrl);
        let embedUrl = null;
        let isValidVideo = false;

        // YouTube validation with strict regex
        const youtubeRegex = /^https?:\/\/(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11}).*$/;
        const youtubeMatch = videoUrl.match(youtubeRegex);
        if (youtubeMatch) {
          const videoId = youtubeMatch[3];
          // Additional validation: ensure videoId is exactly 11 chars and alphanumeric
          if (videoId && videoId.length === 11 && /^[a-zA-Z0-9_-]+$/.test(videoId)) {
            embedUrl = `https://www.youtube.com/embed/${esc(videoId)}`;
            isValidVideo = true;
          }
        }

        // Vimeo validation with strict regex
        if (!isValidVideo) {
          const vimeoRegex = /^https?:\/\/(www\.)?vimeo\.com\/(\d+).*$/;
          const vimeoMatch = videoUrl.match(vimeoRegex);
          if (vimeoMatch) {
            const videoId = vimeoMatch[2];
            // Additional validation: ensure videoId is numeric
            if (videoId && /^\d+$/.test(videoId)) {
              embedUrl = `https://player.vimeo.com/video/${esc(videoId)}`;
              isValidVideo = true;
            }
          }
        }

        if (isValidVideo && embedUrl) {
          html += `<iframe src="${embedUrl}" class="event-video" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
        } else {
          // Fallback to link for invalid or unsupported videos
          html += `<p><a href="${esc(videoUrl)}" target="_blank" rel="noopener">Watch Video ‚Üí</a></p>`;
        }
        html += '</div>';
      }

      // Gallery Section (respects sections.gallery)
      if (data.galleryUrls && sectionEnabled('gallery')) {
        const urls = data.galleryUrls.split(',').map(u => u.trim()).filter(u => u);
        if (urls.length > 0) {
          html += '<div class="event-section">';
          html += '<h2>Gallery</h2>';
          html += '<div class="gallery">';
          urls.forEach(url => {
            html += `<img src="${esc(url)}" alt="Event photo" loading="lazy">`;
          });
          html += '</div>';
          html += '</div>';
        }
      }

      // Schedule Section - uses event.schedule (MVP Optional) + event.settings.showSchedule
      if (sectionEnabled('schedule') && (schedule.length > 0 || externalData.scheduleUrl)) {
        html += '<div class="event-section">';
        html += '<h2>Schedule</h2>';
        if (schedule.length > 0) {
          // Render from event.schedule array per EVENT_CONTRACT.md
          html += '<div class="schedule-list">';
          schedule.forEach(item => {
            html += `<div class="schedule-item">`;
            if (item.time) html += `<span class="schedule-time">${esc(item.time)}</span>`;
            if (item.title) html += `<span class="schedule-title">${esc(item.title)}</span>`;
            if (item.description) html += `<span class="schedule-desc">${esc(item.description)}</span>`;
            html += `</div>`;
          });
          html += '</div>';
        } else if (externalData.scheduleUrl) {
          // External data URL from event.externalData.scheduleUrl (V2 Optional)
          html += `<div id="schedule-container" data-url="${esc(externalData.scheduleUrl)}">
            <div class="loading-placeholder">Loading schedule...</div>
          </div>`;
        }
        html += '</div>';
      }

      // Template-specific sections
      // Photo Album (photo_gallery, wedding, shower templates)
      if (data.albumUrl && sectionEnabled('gallery')) {
        html += '<div class="event-section">';
        html += '<h2>Photo Album</h2>';
        html += `<p><a class="btn-primary" href="${esc(data.albumUrl)}" target="_blank" rel="noopener">üì∏ View Photo Album</a></p>`;
        if (data.downloadUrl) {
          html += `<p><a class="btn-secondary" href="${esc(data.downloadUrl)}" target="_blank" rel="noopener">‚¨áÔ∏è Download All Photos</a></p>`;
        }
        html += '</div>';
      }

      // Registry (wedding, shower templates)
      if (data.registryUrl) {
        html += '<div class="event-section">';
        html += '<h2>Gift Registry</h2>';
        html += `<p><a class="btn-primary" href="${esc(data.registryUrl)}" target="_blank" rel="noopener">üéÅ View Registry</a></p>`;
        html += '</div>';
      }

      // === STANDINGS SECTION - uses event.standings (MVP Optional) + event.settings.showStandings ===
      if (sectionEnabled('standings') && (standings.length > 0 || externalData.standingsUrl)) {
        html += '<div class="event-section">';
        html += '<h2>Standings</h2>';
        if (standings.length > 0) {
          // Render from event.standings array per EVENT_CONTRACT.md
          html += '<table class="data-table standings-table">';
          html += '<thead><tr><th>Team</th><th>W</th><th>L</th><th>Pts</th></tr></thead>';
          html += '<tbody>';
          standings.forEach((row, idx) => {
            html += `<tr class="${idx < 3 ? 'top-rank' : ''}">`;
            html += `<td><span class="rank">${row.rank || idx + 1}</span> ${esc(row.team || '')}</td>`;
            html += `<td>${row.wins || 0}</td>`;
            html += `<td>${row.losses || 0}</td>`;
            html += `<td>${row.points || 0}</td>`;
            html += '</tr>';
          });
          html += '</tbody></table>';
        } else if (externalData.standingsUrl) {
          // External data URL from event.externalData.standingsUrl (V2 Optional)
          html += `<div id="standings-container" data-url="${esc(externalData.standingsUrl)}">
            <div class="loading-placeholder">Loading standings...</div>
          </div>`;
        }
        html += '</div>';
      }

      // === BRACKET SECTION - uses event.bracket (MVP Optional) + event.settings.showBracket ===
      if (sectionEnabled('bracket') && (bracket || externalData.bracketUrl)) {
        html += '<div class="event-section">';
        html += '<h2>Bracket</h2>';
        if (bracket && bracket.rounds && bracket.rounds.length > 0) {
          // Render from event.bracket per EVENT_CONTRACT.md
          html += '<div class="bracket-container"><div class="bracket-rounds">';
          bracket.rounds.forEach(round => {
            html += `<div class="bracket-round">`;
            html += `<h4 class="round-title">${esc(round.name || 'Round')}</h4>`;
            html += '<div class="bracket-matches">';
            (round.matches || []).forEach(match => {
              html += '<div class="bracket-match">';
              html += `<div class="match-team ${match.winner === match.team1 ? 'winner' : ''}">`;
              html += `<span class="team-name">${esc(match.team1 || 'TBD')}</span>`;
              if (match.score1 !== undefined) html += `<span class="team-score">${match.score1}</span>`;
              html += '</div>';
              html += '<div class="match-vs">vs</div>';
              html += `<div class="match-team ${match.winner === match.team2 ? 'winner' : ''}">`;
              html += `<span class="team-name">${esc(match.team2 || 'TBD')}</span>`;
              if (match.score2 !== undefined) html += `<span class="team-score">${match.score2}</span>`;
              html += '</div>';
              html += '</div>';
            });
            html += '</div></div>';
          });
          html += '</div></div>';
        } else if (externalData.bracketUrl) {
          // External data URL from event.externalData.bracketUrl (V2 Optional)
          html += `<div id="bracket-container" data-url="${esc(externalData.bracketUrl)}">
            <div class="loading-placeholder">Loading bracket...</div>
          </div>`;
        }
        html += '</div>';
      }

      // Vendor List (farmers_market template) - supports Google Sheets BYOD
      if (data.vendorListUrl) {
        html += '<div class="event-section">';
        html += '<h2>Vendors</h2>';
        html += `<div id="vendors-container" data-url="${esc(data.vendorListUrl)}">
          <div class="loading-placeholder">Loading vendors...</div>
        </div>`;
        html += '</div>';
      }

      // Donation Progress (fundraiser template)
      if (data.goalAmount && data.raisedAmount !== undefined) {
        const progress = Math.min(100, Math.round((data.raisedAmount / data.goalAmount) * 100));
        html += '<div class="event-section">';
        html += '<h2>Fundraising Progress</h2>';
        html += `<div class="fundraising-progress">`;
        html += `<div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div>`;
        html += `<p class="progress-text">$${data.raisedAmount.toLocaleString()} raised of $${data.goalAmount.toLocaleString()} goal (${progress}%)</p>`;
        html += `</div>`;
        if (data.donationUrl) {
          html += `<p><a class="btn-primary" href="${esc(data.donationUrl)}" target="_blank" rel="noopener">üíù Donate Now</a></p>`;
        }
        html += '</div>';
      }

      // Bio/Notes Section (respects sections.notes) - uses custom label from template
      if ((data.bio || data.bioLink || data.notes) && sectionEnabled('notes')) {
        html += '<div class="event-section">';
        html += `<h2>${esc(getSectionTitle('notes', 'More Information'))}</h2>`;
        if (data.notes) {
          html += `<p>${esc(data.notes)}</p>`;
        }
        if (data.bio) {
          html += `<p>${esc(data.bio)}</p>`;
        }
        if (data.bioLink) {
          html += `<p><a href="${esc(data.bioLink)}" target="_blank" rel="noopener">Read more ‚Üí</a></p>`;
        }
        html += '</div>';
      }

      // Feedback Survey (uses feedbackUrl per EVENT_CONTRACT.md)
      if (data.feedbackUrl) {
        html += '<div class="event-section">';
        html += '<h2>Feedback</h2>';
        html += `<p><a class="btn-primary" href="${esc(data.feedbackUrl)}" target="_blank" rel="noopener">üìã Share Your Feedback</a></p>`;
        html += '</div>';
      }

      html += '</div>';

      root.innerHTML = html;

      // Populate Google Sheets data asynchronously (BYOD)
      populateSheetData();
    }

    // Fetch and populate all sheet data containers
    async function populateSheetData() {
      const containers = [
        { id: 'schedule-container', renderer: renderScheduleTable },
        { id: 'standings-container', renderer: renderStandingsTable },
        { id: 'bracket-container', renderer: renderBracketTable },
        { id: 'vendors-container', renderer: renderVendorList }
      ];

      for (const { id, renderer } of containers) {
        const container = document.getElementById(id);
        if (!container) continue;

        const url = container.dataset.url;
        const sheetData = await fetchSheetData(url);

        if (sheetData && sheetData.rows.length > 0) {
          // Google Sheet data fetched - render styled
          container.innerHTML = renderer(sheetData);
        } else {
          // Not a Google Sheet or fetch failed - show link fallback
          container.innerHTML = `<p><a class="btn-secondary" href="${esc(url)}" target="_blank" rel="noopener">View Full Data ‚Üí</a></p>`;
        }
      }
    }

    // Error state renderer
    function showError(type = 'load') {
      const root = document.getElementById('list');
      if (type === 'notfound') {
        root.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <h3>Event Not Found</h3>
            <p>This event link may be outdated or incorrect.<br>Please check the URL or return to the events list.</p>
            <a class="btn-secondary" href="${EXEC_URL}?p=events&brand=${BRAND}">‚Üê View All Events</a>
          </div>
        `;
      } else {
        root.innerHTML = `
          <div class="error-state">
            <div class="error-state-icon">‚ö†Ô∏è</div>
            <h3>Trouble Loading</h3>
            <p>We couldn't load the events right now. Please try again.</p>
            <button class="btn-retry" onclick="location.reload()">üîÑ Try Again</button>
          </div>
        `;
      }
    }

    // Load event data
    // EVENT_CONTRACT.md v2.0: Use getPublicBundle for single event (returns { event, config })
    if (ID) {
      rpc('api_getPublicBundle', { brandId: BRAND, scope: SCOPE, id: ID }).then(res => {
        if (res.ok && res.value && res.value.event) {
          // getPublicBundle returns { event: Event, config: { brandId, brandName, appTitle } }
          renderDetail(res.value.event, res.value.config);
        } else {
          showError('notfound');
        }
      });
    } else {
      // List view uses api_list which returns canonical Event shapes
      rpc('api_list', { brandId: BRAND, scope: SCOPE }).then(res => {
        if (res.ok && res.value) renderList(res.value.items || []);
        else showError('load');
      });
    }
  </script>
</body>
</html>
