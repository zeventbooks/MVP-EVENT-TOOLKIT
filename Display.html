<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title><?= appTitle ?> · TV Display</title>
  <?!= include('Styles'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="referrer" content="no-referrer" />
  <style>
    :root { --tv-pad: 12px; --side-w: 320px; }
    body[data-tv="1"] {
      background:#111; color:#eee;
      font-size: clamp(20px, 2.8vw, 32px); /* Legible at 10-12ft */
      line-height:1.5;
    }
    [hidden] { display:none !important; }
    main#tv {
      display:grid; grid-template-columns: 1fr; grid-template-rows: auto 1fr; height:100vh;
    }
    main#tv.has-side {
      grid-template-columns: 1fr var(--side-w); grid-template-rows: auto 1fr;
    }
    .sponsor-top {
      grid-column: 1 / -1; grid-row:1;
      padding: var(--tv-pad); text-align:center; font-weight:600; opacity:.98;
      background: linear-gradient(135deg, #0b0b0b 0%, #1a1a1a 100%);
      border-bottom: 2px solid #333;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      flex-wrap: wrap;
      min-height: 80px;
    }
    .sponsor-top img {
      max-height:72px; vertical-align:middle; margin:0 1rem;
      filter: brightness(1.1);
      transition: transform 0.3s ease;
    }
    .sponsor-top img:hover {
      transform: scale(1.05);
    }
    .stage { position:relative; grid-column:1; grid-row:2; }
    iframe#stage {
      position:absolute; inset:0; width:100%; height:100%; border:0; background:#000;
    }
    .fallback-card {
      position:absolute; inset:0; display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      text-align:center; padding:40px;
    }
    .fallback-card h2 {
      margin:0 0 16px; color:#f59e0b; font-size:2em;
      text-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    .fallback-card p { color:#9ca3af; font-size:1.2em; margin:8px 0; line-height: 1.6; }
    aside#sponsorSide {
      grid-column:2; grid-row:2; padding: var(--tv-pad); overflow:auto;
      background: linear-gradient(180deg, #0b0b0b 0%, #161616 100%);
      display:flex; flex-direction:column; gap:16px;
      border-left: 2px solid #333;
    }
    .sp-card {
      display:flex; align-items:center; gap:12px; background:#1f1f1f;
      padding:16px; border-radius:12px;
      border: 1px solid #2a2a2a;
      transition: all 0.3s ease;
    }
    .sp-card:hover {
      background: #252525;
      transform: translateX(-4px);
      border-color: #3a3a3a;
    }
    .sp-card img {
      max-height:64px; max-width:160px; object-fit:contain;
      filter: brightness(1.15);
    }
    .sp-name { font-weight:600; font-size:1em; color: #f0f0f0; }
    .toast {
      position:fixed; right:20px; bottom:20px;
      background: linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.95) 100%);
      color:#fff; padding:12px 20px; border-radius:12px;
      font-size:.9em; z-index:999;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      backdrop-filter: blur(8px);
    }
  </style>
</head>
<body data-tv="1">
  <main id="tv">
    <div class="sponsor-top" id="sponsorTop" hidden></div>
    <div class="stage">
      <iframe id="stage" allow="autoplay; fullscreen" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>
      <div id="fallback" class="fallback-card" hidden>
        <h2>⚠ Content Unavailable</h2>
        <p id="fallbackMsg">This source cannot be embedded.</p>
        <p class="muted">Switching to next item...</p>
      </div>
    </div>
    <aside id="sponsorSide" hidden></aside>
  </main>
  <div class="toast" id="toast" hidden></div>

  <script>
    const qs = new URLSearchParams(location.search);
    const eventId = qs.get('event') || qs.get('id') || '';
    const tenantId = qs.get('tenant') || '<?= tenantId ?>';
    const stage = document.getElementById('stage');
    const fallback = document.getElementById('fallback');
    const topEl = document.getElementById('sponsorTop');
    const sideEl = document.getElementById('sponsorSide');
    const mainEl = document.getElementById('tv');
    const toast = document.getElementById('toast');

    const showToast = (msg, ms=2500) => {
      toast.textContent = msg; toast.hidden = false;
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.hidden = true, ms);
    };

    const logBatch = [];
    function logEvent(evt) {
      try {
        evt.ua = navigator.userAgent;
        evt.ts = Date.now();
        logBatch.push(evt);
        if (logBatch.length >= 5) flush();
      } catch(_) {}
    }
    function flush() {
      if (!logBatch.length) return;
      const copy = logBatch.splice(0, logBatch.length);
      if (google?.script?.run) {
        google.script.run.withFailureHandler(() => {}).api_logEvents({ items: copy });
      }
    }
    setInterval(flush, 6000);
    window.addEventListener('beforeunload', flush);

    function renderSponsorTop(ev) {
      const picks = (ev?.data?.sponsors || []).filter(s => s?.placements?.tvTop);
      if (!picks.length) return;
      topEl.innerHTML = picks.map(s => s.img
        ? `<img src="${s.img}" alt="${s.name || ''}">`
        : `<strong>${s.name || ''}</strong>`
      ).join('');
      topEl.hidden = false;
      picks.forEach(s => logEvent({ eventId, surface: 'display', metric: 'impression', sponsorId: s.id || '' }));
    }

    function renderSponsorSide(ev) {
      const picks = (ev?.data?.sponsors || []).filter(s => s?.placements?.tvSide);
      if (!picks.length) return;
      sideEl.innerHTML = picks.map(s => `
        <div class="sp-card" data-id="${s.id || ''}">
          ${s.img ? `<img src="${s.img}" alt="${s.name || ''}">` : ''}
          <div class="sp-name">${s.name || ''}</div>
        </div>
      `).join('');
      sideEl.hidden = false;
      mainEl.classList.add('has-side');
      picks.forEach(s => logEvent({ eventId, surface: 'display', metric: 'impression', sponsorId: s.id || '' }));
    }

    function startPublicMode() {
      const base = location.origin + location.pathname;
      const tvPublicUrl = `${base}?p=public&tenant=${encodeURIComponent(tenantId)}&id=${encodeURIComponent(eventId)}&tv=1`;
      loadIframe(tvPublicUrl);
      showToast('TV: Public mode (mirroring event page)');
    }

    function loadIframe(url, onFail) {
      fallback.hidden = true;
      stage.hidden = false;
      stage.src = url;

      // Detect iframe load errors (blocked embed, 404, etc.)
      let loaded = false;
      const checkLoad = () => {
        try {
          // If same-origin, we can check; if cross-origin with errors, this will fail
          const doc = stage.contentDocument || stage.contentWindow?.document;
          if (doc && doc.readyState === 'complete') loaded = true;
        } catch (_) {
          // Cross-origin, assume it's loading unless we timeout
        }
      };

      stage.onload = () => { loaded = true; checkLoad(); };
      stage.onerror = () => {
        showFallback(url);
        if (onFail) onFail();
      };

      // Fallback timeout: if not loaded in 4s, assume blocked
      setTimeout(() => {
        if (!loaded) {
          showFallback(url);
          if (onFail) onFail();
        }
      }, 4000);
    }

    function showFallback(url) {
      stage.hidden = true;
      fallback.hidden = false;
      document.getElementById('fallbackMsg').textContent = `Cannot embed: ${url.slice(0, 60)}...`;
      logEvent({ eventId, surface: 'display', metric: 'blocked_embed', value: 1 });
    }

    function startDynamicMode(urls) {
      if (!urls || !urls.length) return startPublicMode();
      let idx = -1;

      const next = () => {
        idx = (idx + 1) % urls.length;
        const it = urls[idx] || {};
        const url = String(it.url || '').trim();
        const sec = Math.max(5, Number(it.seconds || it.sec || it.duration || 10));

        if (!url) return setTimeout(next, 200);

        // Skip known restricted embeds (Instagram, etc.) silently
        const lower = url.toLowerCase();
        if (lower.includes('instagram.com') || lower.includes('tiktok.com')) {
          console.log(`Skipping restricted embed: ${url}`);
          return setTimeout(next, 500);
        }

        showToast(`TV: Dynamic ${idx + 1}/${urls.length} · ${sec}s`);

        logEvent({ eventId, surface: 'display', metric: 'impression' });
        logEvent({ eventId, surface: 'display', metric: 'dwellSec', value: sec });

        loadIframe(url, () => {
          // If blocked, skip to next after 2s (no error display, just skip)
          setTimeout(next, 2000);
        });

        clearTimeout(startDynamicMode._t);
        startDynamicMode._t = setTimeout(next, sec * 1000);
      };
      next();
    }

    function boot() {
      if (!eventId || !google?.script?.run) return startPublicMode();

      google.script.run
        .withSuccessHandler(res => {
          const ev = res?.value || {};
          const d = ev?.data?.display || {};

          renderSponsorTop(ev);
          renderSponsorSide(ev);

          // Check display mode: 'dynamic' uses carousel with configured URLs, 'public' mirrors event page
          if (String(d.mode || '').toLowerCase() === 'dynamic' && Array.isArray(d.urls) && d.urls.length) {
            startDynamicMode(d.urls);
          } else {
            startPublicMode();
          }
        })
        .withFailureHandler(() => startPublicMode())
        .api_get({ tenantId, scope: 'events', id: eventId });
    }

    boot();
  </script>
</body>
</html>
