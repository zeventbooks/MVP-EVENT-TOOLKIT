
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title><?= appTitle ?> · TV Display</title>
  <?!= include('Styles'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    :root { --tv-pad: 12px; --side-w: 320px; }
    body[data-tv="1"] { background:#111; color:#eee; font-size: clamp(18px, 2.6vw, 28px); }
    [hidden] { display:none !important; }
    main#tv { display:grid; grid-template-columns: 1fr; grid-template-rows: auto 1fr; height:100vh; }
    main#tv.has-side { grid-template-columns: 1fr var(--side-w); grid-template-rows: auto 1fr; }
    .sponsor-top { grid-column: 1 / -1; grid-row:1; padding: var(--tv-pad); text-align:center; font-weight:600; opacity:.95; }
    .sponsor-top img { max-height:56px; vertical-align:middle; margin:0 .75rem; }
    .stage { position:relative; grid-column:1; grid-row:2; }
    iframe#stage { position:absolute; inset:0; width:100%; height:100%; border:0; background:#000; }
    aside#sponsorSide { grid-column:2; grid-row:2; padding: var(--tv-pad); overflow:auto; background:#0b0b0b; display:flex; flex-direction:column; gap:12px; border-left: 1px solid #222; }
    .sp-card { display:flex; align-items:center; gap:10px; background:#161616; padding:8px; border-radius:10px; }
    .sp-card img { max-height:48px; max-width:120px; object-fit:contain; }
    .sp-name { font-weight:600; }
    .toast { position:fixed; right:16px; bottom:12px; background:#000a; color:#fff; padding:8px 12px; border-radius:8px; font-size:.9em; z-index:9 }
  </style>
</head>
<body data-tv="1">
  <main id="tv">
    <div class="sponsor-top" id="sponsorTop" hidden></div>
    <div class="stage"><iframe id="stage" allow="autoplay; fullscreen"></iframe></div>
    <aside id="sponsorSide" hidden></aside>
  </main>
  <div class="toast" id="toast" hidden></div>
  <script>
    const qs = new URLSearchParams(location.search);
    const eventId = qs.get('event') || qs.get('id') || '';
    const TENANT = '<?= tenantId ?>';
    const SCOPE = '<?= scope ?>';
    const stage = document.getElementById('stage');
    const topEl = document.getElementById('sponsorTop');
    const sideEl = document.getElementById('sponsorSide');
    const mainEl = document.getElementById('tv');
    const toast = document.getElementById('toast');
    const showToast = (msg, ms=2000) => { toast.textContent = msg; toast.hidden = false; clearTimeout(showToast._t); showToast._t = setTimeout(()=> toast.hidden = true, ms); };

    function renderSponsorTop(ev){
      const picks = (ev?.data?.sponsors || []).filter(s => s?.placements?.tvTop);
      if (!picks.length) return;
      topEl.innerHTML = picks.map(s => s.img ? `<img src="${s.img}" alt="${s.name||''}">` : `<strong>${s.name||''}</strong>`).join('');
      topEl.hidden = false;
      try {
        const events = picks.map(s => ({tenantId: TENANT, eventId, surface:'display', metric:'impression', sponsorId: s.id||''}));
        google?.script?.run?.withFailureHandler(()=>{}).api_logEvents({events});
      } catch (_) {}
    }
    function renderSponsorSide(ev){
      const picks = (ev?.data?.sponsors || []).filter(s => s?.placements?.tvSide);
      if (!picks.length) return;
      sideEl.innerHTML = picks.map(s => `<div class="sp-card" data-id="${s.id||''}">${s.img ? `<img src="${s.img}" alt="${s.name||''}">` : ''}<div class="sp-name">${s.name||''}</div></div>`).join('');
      sideEl.hidden = false; mainEl.classList.add('has-side');
      try {
        const events = picks.map(s => ({tenantId: TENANT, eventId, surface:'display', metric:'impression', sponsorId: s.id||''}));
        google?.script?.run?.withFailureHandler(()=>{}).api_logEvents({events});
      } catch (_) {}
    }
    function startStatic(){
      const base = location.origin + location.pathname;
      const tvPublicUrl = `${base}?p=public&event=${encodeURIComponent(eventId)}&tv=1`; 
      stage.src = tvPublicUrl; showToast('TV: Static');
    }
    function startCarousel(items){
      if (!items || !items.length) return startStatic();
      let idx = -1;
      const next = () => {
        idx = (idx + 1) % items.length;
        const it = items[idx] || {};
        const url = String(it.url || '').trim();
        const sec = Math.max(5, Number(it.sec || it.seconds || 12));
        if (!url) return setTimeout(next, 100);
        stage.src = url; showToast(`TV: Carousel ${idx+1}/${items.length} · ${sec}s`);
        try {
          const events = [{tenantId: TENANT, eventId, surface:'display', metric:'dwellSec', value: sec}];
          google?.script?.run?.withFailureHandler(()=>{}).api_logEvents({events});
        } catch (_) {}
        startCarousel._t && clearTimeout(startCarousel._t); startCarousel._t = setTimeout(next, sec * 1000);
      };
      next();
    }
    function boot(){
      if (!eventId || !google?.script?.run) return startStatic();
      google.script.run.withSuccessHandler(res => {
        const ev = res?.value || {}; const d  = ev?.data?.display || {};
        renderSponsorTop(ev); renderSponsorSide(ev);
        (String(d.mode||'') === 'carousel' && Array.isArray(d.items) && d.items.length) ? startCarousel(d.items) : startStatic();
      }).withFailureHandler(() => startStatic()).api_get({ tenantId: TENANT, scope: SCOPE, id: eventId });
    }
    boot();
  </script>
</body>
</html>
