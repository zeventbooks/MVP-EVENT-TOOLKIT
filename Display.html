<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> Â· TV Display</title>
  <?!= include('Header'); ?>
  <?!= include('NUSDK'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <style>
    body { margin: 0; padding: 0; background: #000; color: #fff; overflow: hidden; }
    .display-container { width: 100vw; height: 100vh; display: flex; flex-direction: column; }
    .sponsor-top { height: 10vh; background: #1e293b; display: flex; align-items: center; justify-content: center; padding: 0 40px; font-size: 2rem; font-weight: 600; }
    .display-main { flex: 1; display: flex; }
    .display-content { flex: 1; display: flex; align-items: center; justify-content: center; background: #000; }
    .display-content iframe { width: 100%; height: 100%; border: none; }
    .sponsor-side { width: 15vw; background: #1e293b; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; gap: 20px; }
    .sponsor-card { background: #334155; padding: 16px; border-radius: 8px; text-align: center; width: 100%; font-size: 1.2rem; }
    .no-sponsor { display: none; }
    .info-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,41,59,0.95); color: #fff; padding: 12px 24px; border-radius: 8px; font-size: 16px; z-index: 10000; }
  </style>
</head>
<body>
  <div class="display-container">
    <div id="sponsorTop" class="sponsor-top no-sponsor"></div>
    <div class="display-main">
      <div class="display-content">
        <iframe id="contentFrame" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
      </div>
      <div id="sponsorSide" class="sponsor-side no-sponsor"></div>
    </div>
  </div>

  <div id="infoToast" class="info-toast" style="display:none;"></div>

  <script>
  const TENANT = '<?= tenantId ?>';
  const ID = new URL(location.href).searchParams.get('id');
  let displayConfig = { urls: [], timings: [] };
  let currentIndex = 0;
  let dwellStart = Date.now();

  async function init() {
    if (!ID) {
      document.querySelector('.display-content').innerHTML = '<h1 style="color:#fff;">No event ID specified</h1>';
      return;
    }

    // Load sponsors
    const sponsorsRes = await NU.rpc('api_getSponsors', { tenantId: TENANT, entityType: 'event', entityId: ID });
    if (sponsorsRes.ok && sponsorsRes.value.sponsors) {
      const s = sponsorsRes.value.sponsors;

      if (s.tvTop) {
        const topEl = document.getElementById('sponsorTop');
        topEl.textContent = s.tvTop;
        topEl.classList.remove('no-sponsor');
        NU.logAnalytics({ entityId: ID, surface: 'tv-top', action: 'impression', meta: { sponsor: s.tvTop } });
      }

      if (s.tvSide) {
        const sideEl = document.getElementById('sponsorSide');
        sideEl.innerHTML = `<div class="sponsor-card">${esc(s.tvSide)}</div>`;
        sideEl.classList.remove('no-sponsor');
        NU.logAnalytics({ entityId: ID, surface: 'tv-side', action: 'impression', meta: { sponsor: s.tvSide } });
      }
    }

    // Load display config
    const displayRes = await NU.rpc('api_getDisplay', { tenantId: TENANT, entityType: 'event', entityId: ID });
    if (displayRes.ok && displayRes.value.displayConfig) {
      displayConfig = displayRes.value.displayConfig;
      if (displayConfig.urls && displayConfig.urls.length > 0) {
        startCarousel();
      } else {
        document.querySelector('.display-content').innerHTML = '<h1 style="color:#fff;">No display URLs configured</h1>';
      }
    }
  }

  function startCarousel() {
    showSlide(0);
  }

  function showSlide(index) {
    if (index >= displayConfig.urls.length) index = 0;
    currentIndex = index;

    const url = displayConfig.urls[index];
    const timing = displayConfig.timings[index] || 10;

    const frame = document.getElementById('contentFrame');

    // Log dwell time for previous slide
    if (index > 0 || dwellStart) {
      const dwellSeconds = Math.round((Date.now() - dwellStart) / 1000);
      const prevIndex = index > 0 ? index - 1 : displayConfig.urls.length - 1;
      NU.logAnalytics({
        entityId: ID,
        surface: 'tv-carousel',
        action: 'dwell',
        meta: { url: displayConfig.urls[prevIndex], seconds: dwellSeconds, index: prevIndex }
      });
    }
    dwellStart = Date.now();

    // Set new URL
    frame.src = url;

    // Log impression
    NU.logAnalytics({ entityId: ID, surface: 'tv-carousel', action: 'impression', meta: { url, index } });

    // Show toast notification
    showInfo(`Slide ${index + 1}/${displayConfig.urls.length} (${timing}s)`);

    // Next slide
    setTimeout(() => {
      showSlide(index + 1);
    }, timing * 1000);
  }

  function showInfo(msg) {
    const toast = document.getElementById('infoToast');
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(() => {
      toast.style.display = 'none';
    }, 2000);
  }

  init();
  </script>
</body>
</html>
