name: Stage 2 - Sequential Progressive Testing

on:
  # Auto-trigger when Stage 1 completes successfully
  # MVP SRE Policy: Only run full Playwright on main/release, not feature branches
  workflow_run:
    workflows: ["Stage 1 - Build & Deploy"]
    types: [completed]
    branches:
      - main
      - 'release/**'
      - 'release/*'

  # Manual trigger for "I want full regression" runs
  workflow_dispatch:
    inputs:
      deployment_url:
        description: 'Deployment URL to test (leave empty to use Stage 1 output)'
        required: false
        type: string
        default: ''
      use_production:
        description: 'âš ï¸ DANGER: Run minimal smoke tests against PRODUCTION (www.eventangle.com). Only workflow_dispatch. Read-only tests ONLY. Use with extreme caution!'
        required: false
        type: boolean
        default: false

# Prevent duplicate runs: only one Stage 2 at a time per branch
# Note: cancel-in-progress: false ensures runs queue instead of cancelling each other
# This provides deterministic test results - cancelled runs give no useful feedback
concurrency:
  group: stage2-${{ github.event.workflow_run.head_branch || github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # STAGE 2: E2E TESTING (API â†’ SMOKE â†’ FLOWS â†’ PAGES)
  # ============================================================================
  # Local equivalent: BASE_URL='<url>' ADMIN_KEY='<key>' npm run test:ci:stage2
  # Runs: test:api && test:fe (smoke + flows + pages)
  # Stage 2 red â†’ DEPLOYMENT BROKEN, fix before release
  # ============================================================================

  # ============================================================================
  # SETUP: Extract deployment URL from Stage 1
  # ============================================================================

  setup:
    name: ğŸ”§ Setup & Extract Deployment URL
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    outputs:
      deployment_url: ${{ steps.get-url.outputs.url }}
      url_mode: ${{ steps.get-url.outputs.url_mode }}
      environment: ${{ steps.get-url.outputs.environment }}
      skip_tests: ${{ steps.final-decision.outputs.skip }}
      skip_reason: ${{ steps.final-decision.outputs.reason }}
      is_prod_smoke: ${{ steps.get-url.outputs.is_prod_smoke }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if Stage 1 failed
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]] && \
             [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
            echo "âš ï¸ Stage 1 did not succeed. Skipping Stage 2."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Get deployment URL
        id: get-url
        run: |
          echo "=================================================="
          echo "ğŸ¯ Stage 2 URL Selection (Precedence Order)"
          echo "=================================================="
          echo ""
          echo "Precedence:"
          echo "  0. use_production (PROD SMOKE - workflow_dispatch only)"
          echo "  1. inputs.deployment_url (manual_override)"
          echo "  2. Stage 1 artifact (from_artifact â†’ prod)"
          echo "  3. Fallback (default_staging)"
          echo ""
          echo "=================================================="
          echo ""

          # Priority 0: Production smoke mode (workflow_dispatch only, explicit opt-in)
          if [[ "${{ inputs.use_production }}" == "true" ]]; then
            DEPLOYMENT_URL="https://www.eventangle.com"
            URL_MODE="prod_smoke"
            echo "=============================================="
            echo "âš ï¸  PRODUCTION SMOKE MODE ACTIVATED"
            echo "=============================================="
            echo "You have explicitly opted into production testing."
            echo "ONLY minimal read-only smoke tests will run."
            echo "=============================================="
            echo ""
            echo "ğŸ“‹ Mode: prod_smoke"
            echo "ğŸ“‹ URL:  $DEPLOYMENT_URL"
            echo ""
            echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
            echo "url_mode=$URL_MODE" >> $GITHUB_OUTPUT
            echo "is_prod_smoke=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "is_prod_smoke=false" >> $GITHUB_OUTPUT

          # Priority 1: Manual override via workflow_dispatch input
          if [[ -n "${{ inputs.deployment_url }}" ]]; then
            DEPLOYMENT_URL="${{ inputs.deployment_url }}"
            URL_MODE="manual_override"
            echo "âœ… Priority 1 MATCHED: inputs.deployment_url provided"
            echo ""
            echo "ğŸ“‹ Mode: manual_override"
            echo "ğŸ“‹ URL:  $DEPLOYMENT_URL"
            echo ""
            echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
            echo "url_mode=$URL_MODE" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "âŒ Priority 1: No inputs.deployment_url provided"
          echo ""

          # Priority 2: Stage 1 artifact (deployment-url.txt + environment.txt)
          echo "ğŸ” Checking Priority 2: Stage 1 artifact..."
          if [[ -n "${{ github.event.workflow_run.id }}" ]]; then
            gh run download ${{ github.event.workflow_run.id }} \
              --name deployment-info 2>/dev/null || true

            if [[ -f deployment-info/deployment-url.txt ]]; then
              DEPLOYMENT_URL=$(cat deployment-info/deployment-url.txt)
              ENVIRONMENT="staging"
              if [[ -f deployment-info/environment.txt ]]; then
                ENVIRONMENT=$(cat deployment-info/environment.txt)
              fi
              URL_MODE="from_artifact"
              echo "âœ… Priority 2 MATCHED: Found deployment artifacts from Stage 1"
              echo ""
              echo "ğŸ“‹ Mode: from_artifact"
              echo "ğŸ“‹ Environment: $ENVIRONMENT"
              echo "ğŸ“‹ URL:  $DEPLOYMENT_URL"
              echo ""
              echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
              echo "url_mode=$URL_MODE" >> $GITHUB_OUTPUT
              echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "âŒ Priority 2: No Stage 1 artifact found"
          echo ""

          # Priority 3: Default to staging (safe fallback)
          DEPLOYMENT_URL="https://stg.eventangle.com"
          URL_MODE="default_staging"
          ENVIRONMENT="staging"
          echo "âœ… Priority 3 FALLBACK: Using default staging URL"
          echo ""
          echo "ğŸ“‹ Mode: default_staging"
          echo "ğŸ“‹ Environment: $ENVIRONMENT"
          echo "ğŸ“‹ URL:  $DEPLOYMENT_URL"
          echo "ğŸ“‹ Note: Staging is the safe default - tests won't stress production"
          echo ""
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "url_mode=$URL_MODE" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Validate deployment URL is reachable
        id: validate-url
        run: |
          DEPLOYMENT_URL="${{ steps.get-url.outputs.url }}"
          URL_MODE="${{ steps.get-url.outputs.url_mode }}"

          echo "ğŸ” Validating deployment URL is reachable..."
          echo "   URL:  $DEPLOYMENT_URL"
          echo "   Mode: $URL_MODE"
          echo ""

          # Try to reach the /ping endpoint (fastest health check)
          PING_URL="${DEPLOYMENT_URL}/ping"
          echo "   Testing: $PING_URL"

          # Use curl with timeout and follow redirects
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 -L "$PING_URL" || echo "000")

          echo "   HTTP Status: $HTTP_STATUS"
          echo ""

          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "âœ… Deployment URL is reachable!"
            echo "url_reachable=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Deployment URL is NOT reachable (HTTP $HTTP_STATUS)"
            echo ""

            # If this was the default staging URL, provide helpful message
            if [[ "$URL_MODE" == "default_staging" ]]; then
              echo "âš ï¸ The default staging URL (stg.eventangle.com) is not available."
              echo "   This typically means staging is not yet deployed in Cloudflare."
              echo ""
              echo "   Options to resolve:"
              echo "   1. Deploy staging environment in Cloudflare"
              echo "   2. Manually trigger Stage 2 with a valid deployment_url"
              echo "   3. Ensure Stage 1 produces a deployment-url artifact"
              echo ""
              echo "   Skipping tests to avoid false positives."
            fi

            echo "url_reachable=false" >> $GITHUB_OUTPUT
          fi

      - name: Display URL selection result
        run: |
          URL_MODE="${{ steps.get-url.outputs.url_mode }}"
          DEPLOYMENT_URL="${{ steps.get-url.outputs.url }}"
          ENVIRONMENT="${{ steps.get-url.outputs.environment }}"

          echo "=================================================="
          echo "ğŸ“‹ Stage 2 URL Selection Result"
          echo "=================================================="
          echo ""
          echo "ğŸ¯ Environment: ${ENVIRONMENT:-staging}"
          echo "ğŸ¯ URL: $DEPLOYMENT_URL"
          echo ""

          # Display mode with explanation
          case "$URL_MODE" in
            "prod_smoke")
              echo "ğŸ“‹ Mode: prod_smoke"
              echo "   â†’ âš ï¸  PRODUCTION SMOKE - Explicit opt-in via use_production=true"
              echo "   â†’ Only minimal read-only tests will run"
              echo "   â†’ Full test suite is SKIPPED in this mode"
              ;;
            "manual_override")
              echo "ğŸ“‹ Mode: manual_override"
              echo "   â†’ URL provided via workflow_dispatch input"
              echo "   â†’ User explicitly chose this target"
              ;;
            "from_artifact")
              echo "ğŸ“‹ Mode: from_artifact"
              echo "   â†’ URL read from Stage 1 deployment artifact"
              echo "   â†’ Environment: ${ENVIRONMENT:-staging}"
              ;;
            "default_staging")
              echo "ğŸ“‹ Mode: default_staging"
              echo "   â†’ Using fallback staging URL"
              echo "   â†’ Safe default: tests won't stress production"
              ;;
            *)
              echo "ğŸ“‹ Mode: unknown ($URL_MODE)"
              ;;
          esac
          echo ""

          # Determine environment from URL
          if [[ "$DEPLOYMENT_URL" == *"stg."* ]]; then
            echo "ğŸ§ª Environment: STAGING (safe sandbox for testing)"
          else
            echo "ğŸš€ Environment: PRODUCTION (live site)"
          fi
          echo ""
          echo "ğŸ¯ Canonical Events URL: $DEPLOYMENT_URL/events"
          echo "=================================================="

      - name: Final decision - should tests run?
        id: final-decision
        run: |
          echo "ğŸ¯ Final Decision: Should Stage 2 tests run?"
          echo "================================================"
          echo ""

          STAGE1_SKIP="${{ steps.check.outputs.skip }}"
          URL_REACHABLE="${{ steps.validate-url.outputs.url_reachable }}"
          URL_MODE="${{ steps.get-url.outputs.url_mode }}"

          echo "Stage 1 check (skip): $STAGE1_SKIP"
          echo "URL reachable: $URL_REACHABLE"
          echo "URL mode: $URL_MODE"
          echo ""

          # Skip if Stage 1 failed
          if [[ "$STAGE1_SKIP" == "true" ]]; then
            echo "âŒ SKIP: Stage 1 did not succeed"
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=stage1_failed" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Skip if URL is not reachable
          if [[ "$URL_REACHABLE" != "true" ]]; then
            echo "âŒ SKIP: Deployment URL is not reachable"
            echo ""
            if [[ "$URL_MODE" == "default_staging" ]]; then
              echo "   The default staging URL (stg.eventangle.com) is not available."
              echo "   This prevents false positive test failures."
              echo ""
              echo "   To run tests, either:"
              echo "   - Deploy staging to Cloudflare"
              echo "   - Manually trigger with a valid deployment_url"
              echo "   - Ensure Stage 1 produces a deployment URL artifact"
            fi
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=url_unreachable" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ… PROCEED: All checks passed, tests will run"
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "reason=none" >> $GITHUB_OUTPUT

      - name: Create setup summary
        if: always()
        run: |
          echo "## ğŸ”§ Stage 2 Setup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SKIP_TESTS="${{ steps.final-decision.outputs.skip }}"
          SKIP_REASON="${{ steps.final-decision.outputs.reason }}"
          URL_MODE="${{ steps.get-url.outputs.url_mode }}"
          DEPLOYMENT_URL="${{ steps.get-url.outputs.url }}"

          # URL Selection info
          echo "### ğŸ¯ URL Selection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | \`$DEPLOYMENT_URL\` |" >> $GITHUB_STEP_SUMMARY

          # Mode description
          case "$URL_MODE" in
            "prod_smoke")
              echo "| **Mode** | \`prod_smoke\` - âš ï¸ PRODUCTION minimal smoke (opt-in) |" >> $GITHUB_STEP_SUMMARY
              ;;
            "manual_override")
              echo "| **Mode** | \`manual_override\` - User provided via workflow_dispatch |" >> $GITHUB_STEP_SUMMARY
              ;;
            "from_artifact")
              echo "| **Mode** | \`from_artifact\` - From Stage 1 deployment-url.txt (prod) |" >> $GITHUB_STEP_SUMMARY
              ;;
            "default_staging")
              echo "| **Mode** | \`default_staging\` - Fallback to stg.eventangle.com |" >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "| **Mode** | \`$URL_MODE\` |" >> $GITHUB_STEP_SUMMARY
              ;;
          esac

          # Environment
          if [[ "$DEPLOYMENT_URL" == *"stg."* ]]; then
            echo "| **Environment** | ğŸ§ª STAGING |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Environment** | ğŸš€ PRODUCTION |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "$SKIP_TESTS" == "true" ]]; then
            echo "### â­ï¸ Tests SKIPPED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [[ "$SKIP_REASON" == "stage1_failed" ]]; then
              echo "**Reason:** Stage 1 did not succeed" >> $GITHUB_STEP_SUMMARY
            elif [[ "$SKIP_REASON" == "url_unreachable" ]]; then
              echo "**Reason:** Deployment URL is not reachable" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              if [[ "$URL_MODE" == "default_staging" ]]; then
                echo "The default staging URL is not available in Cloudflare." >> $GITHUB_STEP_SUMMARY
                echo "This is **NOT a test failure** - tests were skipped to prevent false positives." >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "### âœ… Tests will run" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # PRODUCTION SMOKE: Minimal read-only health checks against production
  # ============================================================================
  # DANGER: This job runs tests against LIVE PRODUCTION (www.eventangle.com)
  # - Only runs when use_production=true (workflow_dispatch only)
  # - Runs ONLY minimal read-only tests (status + admin + public page load)
  # - All other test jobs are SKIPPED in this mode
  # ============================================================================

  prod-smoke:
    name: ğŸš¨ PRODUCTION Smoke (Read-Only)
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.is_prod_smoke == 'true'
    outputs:
      result: ${{ steps.test.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Display Production Warning
        run: |
          echo "=============================================="
          echo "âš ï¸  PRODUCTION SMOKE TEST"
          echo "=============================================="
          echo ""
          echo "You are running tests against LIVE PRODUCTION:"
          echo "  https://www.eventangle.com"
          echo ""
          echo "These are READ-ONLY tests only:"
          echo "  - Status API health check"
          echo "  - Admin page loads (no form submissions)"
          echo "  - Public page loads (read-only)"
          echo ""
          echo "NO write operations will be performed."
          echo "=============================================="

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Production Smoke Tests
        id: test
        env:
          BASE_URL: https://www.eventangle.com
          CI: true
        run: |
          echo "ğŸš¨ Running Production Smoke Tests"
          echo "Target: https://www.eventangle.com"
          echo ""
          npm run test:prod:smoke:minimal
          if [ $? -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ… PRODUCTION SMOKE PASSED"
            echo "Production is healthy and responding correctly."
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo ""
            echo "âŒ PRODUCTION SMOKE FAILED"
            echo "Production may have issues - investigate immediately!"
            exit 1
          fi

      - name: Create Production Smoke Summary
        if: always()
        run: |
          echo "## ğŸš¨ Production Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** \`https://www.eventangle.com\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.test.outputs.result }}" == "success" ]]; then
            echo "### âœ… PRODUCTION IS HEALTHY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All minimal read-only checks passed:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Status API responding" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Admin page loads" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Public page loads" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ PRODUCTION HAS ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more health checks failed. Investigate immediately!" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Note: This was a minimal read-only smoke test. No data was modified.*" >> $GITHUB_STEP_SUMMARY

      - name: Upload Production Smoke report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-prod-smoke-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # PREFLIGHT STAGING: Fail fast if staging is unreachable
  # ============================================================================
  # Checks that the target URL is reachable before running any tests.
  # This prevents noisy test failures when staging is simply down.
  # ============================================================================

  preflight-staging:
    name: ğŸ›« Preflight - Check Staging Reachable
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true'
    outputs:
      staging_reachable: ${{ steps.check.outputs.reachable }}
    steps:
      - name: Check staging is reachable
        id: check
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
        run: |
          echo "ğŸ›« Preflight Check: Is staging reachable?"
          echo "==========================================="
          echo ""
          echo "Target URL: $BASE_URL"
          echo ""

          # Try /status endpoint first, then /ping as fallback
          STATUS_URL="${BASE_URL}/status"
          PING_URL="${BASE_URL}/ping"

          echo "ğŸ” Checking $STATUS_URL ..."
          HTTP_STATUS=$(curl -sf -o /dev/null -w "%{http_code}" --connect-timeout 15 --max-time 30 "$STATUS_URL" 2>/dev/null || echo "000")

          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "âœ… Staging is reachable (status: $HTTP_STATUS)"
            echo "reachable=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âš ï¸ /status returned $HTTP_STATUS, trying /ping..."
          HTTP_STATUS=$(curl -sf -o /dev/null -w "%{http_code}" --connect-timeout 15 --max-time 30 "$PING_URL" 2>/dev/null || echo "000")

          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "âœ… Staging is reachable via /ping (status: $HTTP_STATUS)"
            echo "reachable=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Staging is unreachable - fail fast with clear message
          echo ""
          echo "=============================================="
          echo "âŒ STAGING UNREACHABLE"
          echo "=============================================="
          echo ""
          echo "Target: $BASE_URL"
          echo "Status: $HTTP_STATUS"
          echo ""
          echo "Tests cannot run because the deployment is not responding."
          echo "This is NOT a test failure - staging is simply down."
          echo ""
          echo "To fix:"
          echo "  1. Check if staging is deployed"
          echo "  2. Check Cloudflare Worker status"
          echo "  3. Check Apps Script deployment"
          echo "=============================================="
          echo "reachable=false" >> $GITHUB_OUTPUT
          exit 1

  # ============================================================================
  # WARMUP: Eliminate Cold Start Flakiness
  # ============================================================================
  # Warms up the GAS deployment before running any tests
  # This ensures the first test doesn't hit a cold instance
  # ============================================================================

  warmup:
    name: ğŸ”¥ Warmup Deployment
    runs-on: ubuntu-latest
    needs: [setup, preflight-staging]
    if: needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true'
    outputs:
      warmup_success: ${{ steps.warmup.outputs.success }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Warmup deployment
        id: warmup
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          WARMUP_MAX_ATTEMPTS: 5
          WARMUP_TIMEOUT: 60000
        run: |
          echo "ğŸ”¥ Warming up deployment before tests..."
          echo "   BASE_URL: $BASE_URL"
          echo ""

          if node scripts/warmup-deployment.js; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Warmup complete - deployment is hot!"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âš ï¸ Warmup failed - tests will still run but may experience cold start delays"
          fi

  # ============================================================================
  # STAGE 2A: API TESTS (Always Run First)
  # ============================================================================

  api-tests:
    name: ğŸ”¥ API Tests (Critical)
    runs-on: ubuntu-latest
    needs: [setup, preflight-staging, warmup]
    if: needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true' && needs.preflight-staging.outputs.staging_reachable == 'true'
    outputs:
      result: ${{ steps.test.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium webkit

      - name: Run API tests
        id: test
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          CI: true
          # Per-brand admin keys (brand-specific > shared fallback)
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          # Per-brand spreadsheet IDs (brand-specific > shared fallback)
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "ğŸ”¥ Running API tests"
          echo "BASE_URL: $BASE_URL"
          echo "ğŸ“ Canonical Events URL: $BASE_URL/events"
          npm run test:api
          if [ $? -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload API test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-api-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # GATE 1: Check API Test Results
  # ============================================================================

  gate-1-api-results:
    name: ğŸš¦ Gate 1 - Check API Results
    runs-on: ubuntu-latest
    needs: [setup, preflight-staging, api-tests]
    if: always() && needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true'
    outputs:
      should_run_smoke_packs: ${{ steps.gate.outputs.should_run }}
      api_passed: ${{ steps.gate.outputs.api_passed }}
      skipped_reason: ${{ steps.gate.outputs.skipped_reason }}
    steps:
      - name: Evaluate API test results
        id: gate
        run: |
          echo "ğŸš¦ Gate 1: Evaluating API Test Results"
          echo "========================================="

          API_RESULT="${{ needs.api-tests.result }}"
          PREFLIGHT_RESULT="${{ needs.preflight-staging.result }}"
          STAGING_REACHABLE="${{ needs.preflight-staging.outputs.staging_reachable }}"

          echo "Preflight Result: $PREFLIGHT_RESULT"
          echo "Staging Reachable: $STAGING_REACHABLE"
          echo "API Tests Result: $API_RESULT"
          echo ""

          # Handle case where API tests were skipped due to staging being unreachable
          if [[ "$API_RESULT" == "skipped" ]]; then
            if [[ "$PREFLIGHT_RESULT" == "failure" ]] || [[ "$STAGING_REACHABLE" != "true" ]]; then
              echo "â­ï¸ API tests were SKIPPED (staging unreachable)"
              echo ""
              echo "This is NOT a test failure - staging is simply not available."
              echo "All downstream tests will also be skipped."
              echo ""
              echo "To fix: Ensure staging is deployed and accessible"
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "api_passed=skipped" >> $GITHUB_OUTPUT
              echo "skipped_reason=staging_unreachable" >> $GITHUB_OUTPUT
            else
              echo "â­ï¸ API tests were SKIPPED (unknown reason)"
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "api_passed=skipped" >> $GITHUB_OUTPUT
              echo "skipped_reason=unknown" >> $GITHUB_OUTPUT
            fi
          elif [[ "$API_RESULT" == "success" ]]; then
            echo "âœ… API tests PASSED"
            echo "âœ… Proceeding to Smoke Packs"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "api_passed=true" >> $GITHUB_OUTPUT
            echo "skipped_reason=" >> $GITHUB_OUTPUT
          else
            echo "âŒ API tests FAILED"
            echo "ğŸ›‘ BLOCKING: Skipping Smoke Packs and all downstream tests"
            echo "   Fix API issues before running further tests"
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "api_passed=false" >> $GITHUB_OUTPUT
            echo "skipped_reason=" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # STAGE 2B: SMOKE PACKS (4 Core Smoke Tests - Hard Blocker)
  # ============================================================================
  # Runs the 4 smoke pack tests as a Stage 1 gate:
  #   - pages.smoke.test.js    (MVP surface health)
  #   - integration.smoke.test.js (cross-component flows)
  #   - components.smoke.test.js (deep component validation)
  #   - api.smoke.test.js      (backend endpoint health)
  # ============================================================================

  smoke-packs:
    name: ğŸ“¦ Smoke Packs (Stage 1 Gate)
    runs-on: ubuntu-latest
    needs: [setup, gate-1-api-results]
    if: needs.setup.outputs.is_prod_smoke != 'true' && needs.gate-1-api-results.outputs.should_run_smoke_packs == 'true'
    outputs:
      result: ${{ steps.test.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Smoke Packs
        id: test
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          CI: true
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "ğŸ“¦ Running Smoke Packs (Stage 1 Gate)"
          echo "BASE_URL: $BASE_URL"
          echo ""
          echo "Smoke Packs:"
          echo "  - pages.smoke.test.js"
          echo "  - integration.smoke.test.js"
          echo "  - components.smoke.test.js"
          echo "  - api.smoke.test.js"
          echo ""
          npm run test:smoke:packs
          if [ $? -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload Smoke Packs report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-smoke-packs-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # GATE 1.5: Check Smoke Packs Results
  # ============================================================================

  gate-smoke-packs-results:
    name: ğŸš¦ Gate 1.5 - Check Smoke Packs
    runs-on: ubuntu-latest
    needs: [setup, gate-1-api-results, smoke-packs]
    if: always() && needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true' && needs.gate-1-api-results.outputs.should_run_smoke_packs == 'true'
    outputs:
      should_run_smoke: ${{ steps.gate.outputs.should_run }}
      smoke_packs_passed: ${{ steps.gate.outputs.smoke_packs_passed }}
    steps:
      - name: Evaluate Smoke Packs results
        id: gate
        run: |
          echo "ğŸš¦ Gate 1.5: Evaluating Smoke Packs Results"
          echo "============================================"

          SMOKE_PACKS_RESULT="${{ needs.smoke-packs.result }}"

          echo "Smoke Packs Result: $SMOKE_PACKS_RESULT"
          echo ""

          if [[ "$SMOKE_PACKS_RESULT" == "success" ]]; then
            echo "âœ… Smoke Packs PASSED"
            echo "âœ… Proceeding to E2E Smoke Tests"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "smoke_packs_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Smoke Packs FAILED"
            echo "ğŸ›‘ BLOCKING: Skipping E2E Smoke Tests and Expensive Tests"
            echo "   Fix Smoke Pack issues before running further tests"
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "smoke_packs_passed=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # STAGE 2B.5: UI SMOKE TESTS (Surface Validation - Only if Smoke Packs passed)
  # ============================================================================
  # Validates "If you show it, it works" across Admin, Public, Display, Poster
  # Catches breakage in HTML, CSS, routing, and SSR before anyone sees it
  # ============================================================================

  ui-smoke-tests:
    name: ğŸ–¥ï¸ UI Smoke Tests (Surface Validation)
    runs-on: ubuntu-latest
    needs: [setup, gate-smoke-packs-results]
    if: needs.setup.outputs.is_prod_smoke != 'true' && needs.gate-smoke-packs-results.outputs.should_run_smoke == 'true'
    outputs:
      result: ${{ steps.test.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run UI Smoke Tests
        id: test
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          CI: true
          TEST_BRAND: root
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
        run: |
          echo "ğŸ–¥ï¸ Running UI Smoke Tests"
          echo "BASE_URL: $BASE_URL"
          echo ""
          echo "Surfaces being tested:"
          echo "  - Admin page (wizard, event management, data-testid selectors)"
          echo "  - Public page (event listing, sponsor display)"
          echo "  - Display page (TV/kiosk mode, sponsor carousel)"
          echo "  - Poster page (print layout, QR codes, map)"
          echo ""
          npm run test:ui:smoke
          if [ $? -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload UI Smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-ui-smoke-report
          path: playwright-report-ui-smoke/
          retention-days: 7

  # ============================================================================
  # STAGE 2C: SMOKE TESTS (E2E Smoke - Only if Smoke Packs passed)
  # ============================================================================

  smoke-tests:
    name: ğŸ”¥ Smoke Tests (E2E)
    runs-on: ubuntu-latest
    needs: [setup, gate-smoke-packs-results]
    if: needs.setup.outputs.is_prod_smoke != 'true' && needs.gate-smoke-packs-results.outputs.should_run_smoke == 'true'
    outputs:
      result: ${{ steps.test.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium webkit

      - name: Run Smoke tests
        id: test
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          CI: true
          # Per-brand admin keys (brand-specific > shared fallback)
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          # Per-brand spreadsheet IDs (brand-specific > shared fallback)
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "ğŸ”¥ Running Smoke tests"
          echo "BASE_URL: $BASE_URL"
          echo "CI: $CI (only chromium browser will be used)"
          npm run test:smoke
          if [ $? -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Generate test summary
        if: always()
        run: |
          echo "## ğŸ”¥ Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse junit.xml if it exists for detailed results
          if [ -f ".test-results/junit.xml" ]; then
            TESTS=$(grep -oP 'tests="\K[0-9]+' .test-results/junit.xml | head -1 || echo "0")
            FAILURES=$(grep -oP 'failures="\K[0-9]+' .test-results/junit.xml | head -1 || echo "0")
            ERRORS=$(grep -oP 'errors="\K[0-9]+' .test-results/junit.xml | head -1 || echo "0")
            SKIPPED=$(grep -oP 'skipped="\K[0-9]+' .test-results/junit.xml | head -1 || echo "0")
            TIME=$(grep -oP 'time="\K[0-9.]+' .test-results/junit.xml | head -1 || echo "0")

            PASSED=$((TESTS - FAILURES - ERRORS - SKIPPED))

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILURES |" >> $GITHUB_STEP_SUMMARY
            echo "| âš ï¸ Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| â±ï¸ Duration | ${TIME}s |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # List failed tests if any
            if [ "$FAILURES" -gt 0 ] || [ "$ERRORS" -gt 0 ]; then
              echo "### âŒ Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              grep -oP 'name="\K[^"]+(?=".*(failure|error))' .test-results/junit.xml | head -20 >> $GITHUB_STEP_SUMMARY || echo "See full report for details"
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No junit.xml found - check test output above" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š [View Full HTML Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Upload Smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-smoke-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # GATE 2: Check Smoke Test Results
  # ============================================================================

  gate-2-smoke-results:
    name: ğŸš¦ Gate 2 - Check Smoke Results
    runs-on: ubuntu-latest
    needs: [setup, gate-smoke-packs-results, smoke-tests]
    if: always() && needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true' && needs.gate-smoke-packs-results.outputs.should_run_smoke == 'true'
    outputs:
      should_run_expensive: ${{ steps.gate.outputs.should_run }}
      smoke_passed: ${{ steps.gate.outputs.smoke_passed }}
    steps:
      - name: Evaluate Smoke test results
        id: gate
        run: |
          echo "ğŸš¦ Gate 2: Evaluating Smoke Test Results"
          echo "=========================================="
          
          SMOKE_RESULT="${{ needs.smoke-tests.result }}"
          
          echo "Smoke Tests Result: $SMOKE_RESULT"
          echo ""
          
          if [[ "$SMOKE_RESULT" == "success" ]]; then
            echo "âœ… Smoke tests PASSED"
            echo "âœ… Proceeding to Expensive Tests (Flow + Page)"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "smoke_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Smoke tests FAILED"
            echo "ğŸ›‘ BLOCKING: Skipping Expensive Tests"
            echo "   Fix Smoke test issues before running expensive tests"
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "smoke_passed=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # STAGE 2C: EXPENSIVE TESTS (Only if Smoke tests passed)
  # MVP Flow Tests: Template scenarios + Core propagation
  # ============================================================================

  expensive-tests:
    name: ğŸ’° Expensive - ${{ matrix.suite }}
    runs-on: ubuntu-latest
    needs: [setup, gate-2-smoke-results]
    if: needs.setup.outputs.is_prod_smoke != 'true' && needs.gate-2-smoke-results.outputs.should_run_expensive == 'true'
    strategy:
      fail-fast: false
      matrix:
        suite:
          - flows    # Includes: template-scenarios.spec.js (Bar/Rec/School/Fundraiser)
          - pages    # Includes: Admin, Public, Display, Poster, Sponsor page tests
    outputs:
      flows_result: ${{ steps.set-result.outputs.flows_result }}
      pages_result: ${{ steps.set-result.outputs.pages_result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium webkit

      - name: Run ${{ matrix.suite }} tests
        id: test
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          CI: true
          # Per-brand admin keys (brand-specific > shared fallback)
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          # Per-brand spreadsheet IDs (brand-specific > shared fallback)
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "ğŸ’° Running ${{ matrix.suite }} tests"
          echo "BASE_URL: $BASE_URL"
          if [[ "${{ matrix.suite }}" == "flows" ]]; then
            echo "ğŸ“‹ MVP Flow Coverage:"
            echo "   - template-scenarios.spec.js (Bar/Rec League/School/Fundraiser)"
            echo "   - admin-flows.spec.js (event CRUD)"
            echo "   - sponsor-flows.spec.js (sponsor creation & display)"
            echo "   - shared-reporting.spec.js (SharedReport smoke)"
            echo "   - Data propagation: Admin â†’ Public â†’ Display â†’ Poster"
          fi
          npm run test:${{ matrix.suite }}

      - name: Set result output
        id: set-result
        if: always()
        run: |
          if [ "${{ matrix.suite }}" == "flows" ]; then
            if [ "${{ steps.test.outcome }}" == "success" ]; then
              echo "flows_result=success" >> $GITHUB_OUTPUT
            else
              echo "flows_result=failure" >> $GITHUB_OUTPUT
            fi
          else
            if [ "${{ steps.test.outcome }}" == "success" ]; then
              echo "pages_result=success" >> $GITHUB_OUTPUT
            else
              echo "pages_result=failure" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Upload ${{ matrix.suite }} test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-${{ matrix.suite }}-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # FINAL QUALITY GATE & REPORTING
  # ============================================================================

  quality-gate:
    name: ğŸ¯ Quality Gate - Final Validation
    runs-on: ubuntu-latest
    needs: [setup, preflight-staging, api-tests, gate-1-api-results, smoke-packs, gate-smoke-packs-results, ui-smoke-tests, smoke-tests, gate-2-smoke-results, expensive-tests]
    if: always() && needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true'
    outputs:
      qa_approved: ${{ steps.gate.outputs.approved }}
    steps:
      - name: Check all tests passed
        id: gate
        run: |
          echo "ğŸ“Š Stage 2 Quality Gate Summary (Sequential Progressive)"
          echo "=========================================================="
          echo ""
          echo "Deployment URL: ${{ needs.setup.outputs.deployment_url }}"
          echo ""
          echo "Test Results (Sequential):"
          echo "  ğŸ”¥ API Tests (Critical):     ${{ needs.api-tests.result }}"
          echo "  ğŸš¦ Gate 1 Decision:          ${{ needs.gate-1-api-results.outputs.should_run_smoke_packs }}"

          if [[ "${{ needs.gate-1-api-results.outputs.should_run_smoke_packs }}" == "true" ]]; then
            echo "  ğŸ“¦ Smoke Packs (Stage 1):    ${{ needs.smoke-packs.result }}"
            echo "  ğŸš¦ Gate 1.5 Decision:        ${{ needs.gate-smoke-packs-results.outputs.should_run_smoke }}"
          else
            echo "  ğŸ“¦ Smoke Packs:              â­ï¸ SKIPPED (API failed)"
            echo "  ğŸš¦ Gate 1.5 Decision:        N/A"
          fi

          if [[ "${{ needs.gate-smoke-packs-results.outputs.should_run_smoke }}" == "true" ]]; then
            echo "  ğŸ–¥ï¸ UI Smoke Tests:           ${{ needs.ui-smoke-tests.result }}"
            echo "  ğŸ”¥ Smoke Tests (E2E):        ${{ needs.smoke-tests.result }}"
            echo "  ğŸš¦ Gate 2 Decision:          ${{ needs.gate-2-smoke-results.outputs.should_run_expensive }}"
          else
            echo "  ğŸ–¥ï¸ UI Smoke Tests:           â­ï¸ SKIPPED (Smoke Packs failed)"
            echo "  ğŸ”¥ Smoke Tests:              â­ï¸ SKIPPED (Smoke Packs failed)"
            echo "  ğŸš¦ Gate 2 Decision:          N/A"
          fi

          if [[ "${{ needs.gate-2-smoke-results.outputs.should_run_expensive }}" == "true" ]]; then
            echo "  ğŸ’° Flow Tests (Expensive):   ${{ needs.expensive-tests.result }}"
            echo "  ğŸ’° Page Tests (Expensive):   ${{ needs.expensive-tests.result }}"
          else
            echo "  ğŸ’° Expensive Tests:          â­ï¸ SKIPPED (Smoke failed or not run)"
          fi
          echo ""
          echo "=========================================================="

          # Determine overall quality gate
          API_PASSED="${{ needs.gate-1-api-results.outputs.api_passed }}"
          SKIPPED_REASON="${{ needs.gate-1-api-results.outputs.skipped_reason }}"
          SMOKE_PACKS_PASSED="${{ needs.gate-smoke-packs-results.outputs.smoke_packs_passed }}"
          UI_SMOKE_RESULT="${{ needs.ui-smoke-tests.result }}"
          SMOKE_PASSED="${{ needs.gate-2-smoke-results.outputs.smoke_passed }}"
          EXPENSIVE_RESULT="${{ needs.expensive-tests.result }}"

          # Quality gate passes if:
          # 1. API tests passed AND
          # 2. Smoke Packs passed AND
          # 3. UI Smoke tests passed AND
          # 4. Smoke tests passed AND
          # 5. Expensive tests passed (or were skipped)
          #
          # Special case: If tests were skipped due to staging being unreachable,
          # we don't fail the quality gate - we just indicate tests were skipped.

          # Handle skipped tests due to staging being unreachable
          if [[ "$API_PASSED" == "skipped" ]]; then
            echo "â­ï¸ QUALITY GATE SKIPPED: Tests were skipped"
            echo ""
            if [[ "$SKIPPED_REASON" == "staging_unreachable" ]]; then
              echo "   Reason: Staging environment is not reachable"
              echo "   This is NOT a test failure - staging is simply not deployed/available."
              echo ""
              echo "   To run tests:"
              echo "   1. Ensure staging is deployed (Stage 1 must succeed)"
              echo "   2. Verify Cloudflare Worker is configured"
              echo "   3. Check that stg.eventangle.com resolves correctly"
            else
              echo "   Reason: $SKIPPED_REASON"
            fi
            echo ""
            echo "approved=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ "$API_PASSED" != "true" ]]; then
            echo "âŒ QUALITY GATE FAILED: API tests failed"
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [[ "$SMOKE_PACKS_PASSED" != "true" ]]; then
            echo "âŒ QUALITY GATE FAILED: Smoke Packs failed"
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [[ "$UI_SMOKE_RESULT" != "success" ]]; then
            echo "âŒ QUALITY GATE FAILED: UI Smoke tests failed"
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [[ "$SMOKE_PASSED" != "true" ]]; then
            echo "âŒ QUALITY GATE FAILED: Smoke tests failed"
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check expensive tests only if they ran
          if [[ "${{ needs.gate-2-smoke-results.outputs.should_run_expensive }}" == "true" ]]; then
            if [[ "$EXPENSIVE_RESULT" != "success" ]]; then
              echo "âŒ QUALITY GATE FAILED: Expensive tests failed"
              echo "approved=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          echo ""
          echo "âœ… QUALITY GATE PASSED!"
          echo "All tests in the progressive sequence passed."
          echo "approved=true" >> $GITHUB_OUTPUT

      - name: Create quality gate summary
        if: always()
        run: |
          echo "## ğŸ¯ Stage 2 Quality Gate Results (Sequential Progressive)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Sequential Test Strategy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Strategy:** Progressive failure gates to minimize wasted test time" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… **API Tests** (always run first)" >> $GITHUB_STEP_SUMMARY
          echo "2. ğŸš¦ **Gate 1**: Only proceed if API tests pass" >> $GITHUB_STEP_SUMMARY
          echo "3. ğŸ“¦ **Smoke Packs** (Stage 1 gate - 4 core smoke tests)" >> $GITHUB_STEP_SUMMARY
          echo "4. ğŸš¦ **Gate 1.5**: Only proceed if Smoke Packs pass" >> $GITHUB_STEP_SUMMARY
          echo "5. ğŸ–¥ï¸ **UI Smoke Tests** (Admin, Public, Display, Poster surfaces)" >> $GITHUB_STEP_SUMMARY
          echo "6. âœ… **Smoke Tests** (E2E smoke tests)" >> $GITHUB_STEP_SUMMARY
          echo "7. ğŸš¦ **Gate 2**: Only proceed if Smoke tests pass" >> $GITHUB_STEP_SUMMARY
          echo "8. âœ… **Expensive Tests** (Flow + Page, run if Smoke passed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Test Suite | Result | Gate Decision |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------------|--------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1ï¸âƒ£ | ğŸ”¥ API Tests | ${{ needs.api-tests.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš¦ | Gate 1 | - | ${{ needs.gate-1-api-results.outputs.should_run_smoke_packs == 'true' && 'âœ… Proceed to Smoke Packs' || 'ğŸ›‘ Block Smoke Packs' }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.gate-1-api-results.outputs.should_run_smoke_packs }}" == "true" ]]; then
            echo "| 2ï¸âƒ£ | ğŸ“¦ Smoke Packs | ${{ needs.smoke-packs.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸš¦ | Gate 1.5 | - | ${{ needs.gate-smoke-packs-results.outputs.should_run_smoke == 'true' && 'âœ… Proceed to Smoke' || 'ğŸ›‘ Block Smoke' }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 2ï¸âƒ£ | ğŸ“¦ Smoke Packs | â­ï¸ SKIPPED | API failed |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸš¦ | Gate 1.5 | - | N/A |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.gate-smoke-packs-results.outputs.should_run_smoke }}" == "true" ]]; then
            echo "| 2.5ï¸âƒ£ | ğŸ–¥ï¸ UI Smoke Tests | ${{ needs.ui-smoke-tests.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
            echo "| 3ï¸âƒ£ | ğŸ”¥ Smoke Tests | ${{ needs.smoke-tests.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸš¦ | Gate 2 | - | ${{ needs.gate-2-smoke-results.outputs.should_run_expensive == 'true' && 'âœ… Proceed to Expensive' || 'ğŸ›‘ Block Expensive' }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 2.5ï¸âƒ£ | ğŸ–¥ï¸ UI Smoke Tests | â­ï¸ SKIPPED | Smoke Packs failed |" >> $GITHUB_STEP_SUMMARY
            echo "| 3ï¸âƒ£ | ğŸ”¥ Smoke Tests | â­ï¸ SKIPPED | Smoke Packs failed |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸš¦ | Gate 2 | - | N/A |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.gate-2-smoke-results.outputs.should_run_expensive }}" == "true" ]]; then
            echo "| 4ï¸âƒ£ | ğŸ’° Flow Tests | ${{ needs.expensive-tests.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
            echo "| 4ï¸âƒ£ | ğŸ’° Page Tests | ${{ needs.expensive-tests.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 4ï¸âƒ£ | ğŸ’° Expensive Tests | â­ï¸ SKIPPED | Smoke failed or not run |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Final Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.gate.outputs.approved }}" == "true" ]]; then
            echo "**âœ… QUALITY GATE PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All sequential tests passed! Deployment validated." >> $GITHUB_STEP_SUMMARY
          else
            echo "**âŒ QUALITY GATE FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more tests in the sequence failed. Review test reports." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** \`${{ needs.setup.outputs.deployment_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Benefits of Sequential Progressive Testing:**" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ Fail fast - stop at first failure" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ’° Save test time - skip expensive tests if critical tests fail" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¯ Clear feedback - know exactly which stage failed" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¤– Fully automated - no manual intervention" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # GLOBAL CI GATE: ci:all - Single pass/fail gate for production safety
  # ============================================================================
  # This job runs the unified ci:all command that combines all validations.
  # Production deployment should be contingent on this gate passing.
  # ============================================================================

  ci-all-gate:
    name: ğŸš¦ CI:ALL Global Gate
    runs-on: ubuntu-latest
    needs: [setup, quality-gate]
    if: always() && needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true'
    outputs:
      gate_passed: ${{ steps.ci-all.outputs.passed }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium webkit

      - name: Run ci:all global gate
        id: ci-all
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          CI: true
          # Per-brand admin keys
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          # Per-brand spreadsheet IDs
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "ğŸš¦ Running ci:all Global Gate"
          echo "================================================"
          echo "BASE_URL: $BASE_URL"
          echo ""
          echo "This command runs:"
          echo "  1. ci:fast   - Unit tests"
          echo "  2. ci:contracts - Schema, services, API contracts, SDK tests"
          echo "  3. ci:e2e    - All E2E surface tests (admin, public, display, poster, report)"
          echo ""
          echo "================================================"
          npm run ci:all
          if [ $? -eq 0 ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ… CI:ALL GATE PASSED - Build is safe for production"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âŒ CI:ALL GATE FAILED - Do NOT deploy to production"
            exit 1
          fi

      - name: Create ci:all summary
        if: always()
        run: |
          echo "## ğŸš¦ CI:ALL Global Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** \`${{ needs.setup.outputs.deployment_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.ci-all.outputs.passed }}" == "true" ]]; then
            echo "### âœ… GATE PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The ci:all gate passed. This build is safe for production." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Tests Executed:**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ci:fast (unit tests)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ci:contracts (schemas, services, API contracts, SDK)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ci:e2e (admin, public, display, poster, report)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ GATE FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The ci:all gate failed. **DO NOT deploy to production.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the test output above to identify failures." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # PRODUCTION DEPLOYMENT GATE
  # ============================================================================
  # This gate blocks any production deployment unless ci:all passes.
  # Use this job as a required check for production deployments.
  # ============================================================================

  production-gate:
    name: ğŸ”’ Production Deployment Gate
    runs-on: ubuntu-latest
    needs: [setup, quality-gate, ci-all-gate]
    if: always() && needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true'
    steps:
      - name: Check production readiness
        id: prod-check
        run: |
          echo "ğŸ”’ Production Deployment Gate"
          echo "================================================"
          echo ""
          echo "Quality Gate Status: ${{ needs.quality-gate.outputs.qa_approved }}"
          echo "CI:ALL Gate Status:  ${{ needs.ci-all-gate.outputs.gate_passed }}"
          echo ""

          QUALITY_PASSED="${{ needs.quality-gate.outputs.qa_approved }}"
          CIALL_PASSED="${{ needs.ci-all-gate.outputs.gate_passed }}"

          # Handle case where tests were skipped (staging unreachable)
          if [[ "$QUALITY_PASSED" == "skipped" ]]; then
            echo "â­ï¸ PRODUCTION GATE SKIPPED"
            echo ""
            echo "Tests were skipped because staging was not reachable."
            echo "This is NOT a failure - production gate simply cannot be evaluated."
            echo ""
            echo "Once staging is deployed and tests run successfully,"
            echo "the production gate will properly evaluate."
            echo "production_approved=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ "$QUALITY_PASSED" == "true" ]] && [[ "$CIALL_PASSED" == "true" ]]; then
            echo "âœ… PRODUCTION GATE PASSED"
            echo ""
            echo "All validations passed. This build is approved for production deployment."
            echo "production_approved=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ PRODUCTION GATE FAILED"
            echo ""
            echo "One or more gates failed. DO NOT deploy to production."
            echo ""
            if [[ "$QUALITY_PASSED" != "true" ]]; then
              echo "  - Quality Gate: FAILED"
            fi
            if [[ "$CIALL_PASSED" != "true" ]]; then
              echo "  - CI:ALL Gate: FAILED"
            fi
            echo "production_approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Create production gate summary
        if: always()
        run: |
          echo "## ğŸ”’ Production Deployment Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PROD_APPROVED="${{ steps.prod-check.outputs.production_approved }}"
          QUALITY_STATUS="${{ needs.quality-gate.outputs.qa_approved }}"
          CIALL_STATUS="${{ needs.ci-all-gate.outputs.gate_passed }}"

          if [[ "$PROD_APPROVED" == "true" ]]; then
            echo "### âœ… APPROVED FOR PRODUCTION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All gates passed. This build is safe to deploy to production." >> $GITHUB_STEP_SUMMARY
          elif [[ "$PROD_APPROVED" == "skipped" ]]; then
            echo "### â­ï¸ TESTS SKIPPED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tests were skipped because staging was not reachable." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**This is NOT a failure** - the staging environment is simply not available." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To run tests, ensure:" >> $GITHUB_STEP_SUMMARY
            echo "1. Stage 1 deployment succeeds" >> $GITHUB_STEP_SUMMARY
            echo "2. Staging environment is accessible at stg.eventangle.com" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ BLOCKED FROM PRODUCTION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**This build should NOT be deployed to production.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Fix the failing tests before attempting production deployment." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY

          # Quality Gate status with skipped handling
          if [[ "$QUALITY_STATUS" == "true" ]]; then
            echo "| Quality Gate | âœ… PASS |" >> $GITHUB_STEP_SUMMARY
          elif [[ "$QUALITY_STATUS" == "skipped" ]]; then
            echo "| Quality Gate | â­ï¸ SKIPPED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Quality Gate | âŒ FAIL |" >> $GITHUB_STEP_SUMMARY
          fi

          # CI:ALL Gate status
          if [[ "$CIALL_STATUS" == "true" ]]; then
            echo "| CI:ALL Gate | âœ… PASS |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| CI:ALL Gate | âŒ FAIL |" >> $GITHUB_STEP_SUMMARY
          fi
