name: Stage 2 - Sequential Progressive Testing

on:
  # Auto-trigger when Stage 1 completes successfully
  # MVP SRE Policy: Only run full Playwright on main/release, not feature branches
  workflow_run:
    workflows: ["Stage 1 - Build & Deploy"]
    types: [completed]
    branches:
      - main
      - 'release/**'
      - 'release/*'

  # Manual trigger for "I want full regression" runs
  workflow_dispatch:
    inputs:
      deployment_url:
        description: 'Deployment URL to test (leave empty to use Stage 1 output)'
        required: false
        type: string
        default: ''

# Prevent duplicate runs: only one Stage 2 at a time per branch
concurrency:
  group: stage2-${{ github.event.workflow_run.head_branch || github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # STAGE 2: E2E TESTING (API â†’ SMOKE â†’ FLOWS â†’ PAGES)
  # ============================================================================
  # Local equivalent: BASE_URL='<url>' ADMIN_KEY='<key>' npm run test:ci:stage2
  # Runs: test:api && test:fe (smoke + flows + pages)
  # Stage 2 red â†’ DEPLOYMENT BROKEN, fix before release
  # ============================================================================

  # ============================================================================
  # SETUP: Extract deployment URL from Stage 1
  # ============================================================================

  setup:
    name: ðŸ”§ Setup & Extract Deployment URL
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    outputs:
      deployment_url: ${{ steps.get-url.outputs.url }}
      skip_tests: ${{ steps.check.outputs.skip }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if Stage 1 failed
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]] && \
             [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
            echo "âš ï¸ Stage 1 did not succeed. Skipping Stage 2."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Get deployment URL
        id: get-url
        run: |
          # If manually triggered with URL, use that
          if [[ -n "${{ inputs.deployment_url }}" ]]; then
            echo "ðŸŽ¯ Using manual deployment URL"
            echo "url=${{ inputs.deployment_url }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Otherwise, extract from Stage 1 workflow run
          echo "ðŸ” Extracting deployment URL from Stage 1..."

          # Download Stage 1 artifacts to get deployment info
          gh run download ${{ github.event.workflow_run.id }} \
            --name deployment-info || true

          # If artifact exists, read URL from it
          # Note: gh run download creates a folder with the artifact name
          if [[ -f deployment-info/deployment-url.txt ]]; then
            DEPLOYMENT_URL=$(cat deployment-info/deployment-url.txt)
            echo "âœ… Found deployment URL: $DEPLOYMENT_URL"
            echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No deployment URL found from Stage 1"
            echo "Using default Cloudflare friendly URL (www.eventangle.com)"
            # Use www.eventangle.com to match Cloudflare Worker routes and DNS config
            # Note: The base URL should NOT include /events path - tests append paths like /status, /{brand}/status
            echo "url=https://www.eventangle.com" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Display URL
        run: |
          echo "ðŸ“‹ Deployment URL for testing:"
          echo "${{ steps.get-url.outputs.url }}"
          echo ""
          echo "ðŸŽ¯ Canonical Events URL: ${{ steps.get-url.outputs.url }}/events"
          echo "   All user-facing links use this base URL pattern"

  # ============================================================================
  # STAGE 2A: API TESTS (Always Run First)
  # ============================================================================

  api-tests:
    name: ðŸ”¥ API Tests (Critical)
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.skip_tests != 'true'
    outputs:
      result: ${{ steps.test.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium webkit

      - name: Run API tests
        id: test
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          CI: true
          # Per-brand admin keys (brand-specific > shared fallback)
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          # Per-brand spreadsheet IDs (brand-specific > shared fallback)
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "ðŸ”¥ Running API tests"
          echo "BASE_URL: $BASE_URL"
          echo "ðŸ“ Canonical Events URL: $BASE_URL/events"
          npm run test:api
          if [ $? -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload API test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-api-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # GATE 1: Check API Test Results
  # ============================================================================

  gate-1-api-results:
    name: ðŸš¦ Gate 1 - Check API Results
    runs-on: ubuntu-latest
    needs: [setup, api-tests]
    if: always() && needs.setup.outputs.skip_tests != 'true'
    outputs:
      should_run_smoke: ${{ steps.gate.outputs.should_run }}
      api_passed: ${{ steps.gate.outputs.api_passed }}
    steps:
      - name: Evaluate API test results
        id: gate
        run: |
          echo "ðŸš¦ Gate 1: Evaluating API Test Results"
          echo "========================================="
          
          API_RESULT="${{ needs.api-tests.result }}"
          
          echo "API Tests Result: $API_RESULT"
          echo ""
          
          if [[ "$API_RESULT" == "success" ]]; then
            echo "âœ… API tests PASSED"
            echo "âœ… Proceeding to Smoke Tests"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "api_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ API tests FAILED"
            echo "ðŸ›‘ BLOCKING: Skipping Smoke Tests and Expensive Tests"
            echo "   Fix API issues before running further tests"
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "api_passed=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # STAGE 2B: SMOKE TESTS (Only if API tests passed)
  # ============================================================================

  smoke-tests:
    name: ðŸ”¥ Smoke Tests (Critical)
    runs-on: ubuntu-latest
    needs: [setup, gate-1-api-results]
    if: needs.gate-1-api-results.outputs.should_run_smoke == 'true'
    outputs:
      result: ${{ steps.test.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium webkit

      - name: Run Smoke tests
        id: test
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          CI: true
          # Per-brand admin keys (brand-specific > shared fallback)
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          # Per-brand spreadsheet IDs (brand-specific > shared fallback)
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "ðŸ”¥ Running Smoke tests"
          echo "BASE_URL: $BASE_URL"
          echo "CI: $CI (only chromium browser will be used)"
          npm run test:smoke
          if [ $? -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Generate test summary
        if: always()
        run: |
          echo "## ðŸ”¥ Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse junit.xml if it exists for detailed results
          if [ -f ".test-results/junit.xml" ]; then
            TESTS=$(grep -oP 'tests="\K[0-9]+' .test-results/junit.xml | head -1 || echo "0")
            FAILURES=$(grep -oP 'failures="\K[0-9]+' .test-results/junit.xml | head -1 || echo "0")
            ERRORS=$(grep -oP 'errors="\K[0-9]+' .test-results/junit.xml | head -1 || echo "0")
            SKIPPED=$(grep -oP 'skipped="\K[0-9]+' .test-results/junit.xml | head -1 || echo "0")
            TIME=$(grep -oP 'time="\K[0-9.]+' .test-results/junit.xml | head -1 || echo "0")

            PASSED=$((TESTS - FAILURES - ERRORS - SKIPPED))

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILURES |" >> $GITHUB_STEP_SUMMARY
            echo "| âš ï¸ Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| â±ï¸ Duration | ${TIME}s |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # List failed tests if any
            if [ "$FAILURES" -gt 0 ] || [ "$ERRORS" -gt 0 ]; then
              echo "### âŒ Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              grep -oP 'name="\K[^"]+(?=".*(failure|error))' .test-results/junit.xml | head -20 >> $GITHUB_STEP_SUMMARY || echo "See full report for details"
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No junit.xml found - check test output above" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š [View Full HTML Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Upload Smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-smoke-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # GATE 2: Check Smoke Test Results
  # ============================================================================

  gate-2-smoke-results:
    name: ðŸš¦ Gate 2 - Check Smoke Results
    runs-on: ubuntu-latest
    needs: [setup, gate-1-api-results, smoke-tests]
    if: always() && needs.setup.outputs.skip_tests != 'true' && needs.gate-1-api-results.outputs.should_run_smoke == 'true'
    outputs:
      should_run_expensive: ${{ steps.gate.outputs.should_run }}
      smoke_passed: ${{ steps.gate.outputs.smoke_passed }}
    steps:
      - name: Evaluate Smoke test results
        id: gate
        run: |
          echo "ðŸš¦ Gate 2: Evaluating Smoke Test Results"
          echo "=========================================="
          
          SMOKE_RESULT="${{ needs.smoke-tests.result }}"
          
          echo "Smoke Tests Result: $SMOKE_RESULT"
          echo ""
          
          if [[ "$SMOKE_RESULT" == "success" ]]; then
            echo "âœ… Smoke tests PASSED"
            echo "âœ… Proceeding to Expensive Tests (Flow + Page)"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "smoke_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Smoke tests FAILED"
            echo "ðŸ›‘ BLOCKING: Skipping Expensive Tests"
            echo "   Fix Smoke test issues before running expensive tests"
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "smoke_passed=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # STAGE 2C: EXPENSIVE TESTS (Only if Smoke tests passed)
  # MVP Flow Tests: Template scenarios + Core propagation
  # ============================================================================

  expensive-tests:
    name: ðŸ’° Expensive - ${{ matrix.suite }}
    runs-on: ubuntu-latest
    needs: [setup, gate-2-smoke-results]
    if: needs.gate-2-smoke-results.outputs.should_run_expensive == 'true'
    strategy:
      fail-fast: false
      matrix:
        suite:
          - flows    # Includes: template-scenarios.spec.js (Bar/Rec/School/Fundraiser)
          - pages    # Includes: Admin, Public, Display, Poster, Sponsor page tests
    outputs:
      flows_result: ${{ steps.set-result.outputs.flows_result }}
      pages_result: ${{ steps.set-result.outputs.pages_result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium webkit

      - name: Run ${{ matrix.suite }} tests
        id: test
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          CI: true
          # Per-brand admin keys (brand-specific > shared fallback)
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          # Per-brand spreadsheet IDs (brand-specific > shared fallback)
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "ðŸ’° Running ${{ matrix.suite }} tests"
          echo "BASE_URL: $BASE_URL"
          if [[ "${{ matrix.suite }}" == "flows" ]]; then
            echo "ðŸ“‹ MVP Flow Coverage:"
            echo "   - template-scenarios.spec.js (Bar/Rec League/School/Fundraiser)"
            echo "   - admin-flows.spec.js (event CRUD)"
            echo "   - sponsor-flows.spec.js (sponsor creation & display)"
            echo "   - shared-reporting.spec.js (SharedReport smoke)"
            echo "   - Data propagation: Admin â†’ Public â†’ Display â†’ Poster"
          fi
          npm run test:${{ matrix.suite }}

      - name: Set result output
        id: set-result
        if: always()
        run: |
          if [ "${{ matrix.suite }}" == "flows" ]; then
            if [ "${{ steps.test.outcome }}" == "success" ]; then
              echo "flows_result=success" >> $GITHUB_OUTPUT
            else
              echo "flows_result=failure" >> $GITHUB_OUTPUT
            fi
          else
            if [ "${{ steps.test.outcome }}" == "success" ]; then
              echo "pages_result=success" >> $GITHUB_OUTPUT
            else
              echo "pages_result=failure" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Upload ${{ matrix.suite }} test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-${{ matrix.suite }}-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # FINAL QUALITY GATE & REPORTING
  # ============================================================================

  quality-gate:
    name: ðŸŽ¯ Quality Gate - Final Validation
    runs-on: ubuntu-latest
    needs: [setup, api-tests, gate-1-api-results, smoke-tests, gate-2-smoke-results, expensive-tests]
    if: always() && needs.setup.outputs.skip_tests != 'true'
    outputs:
      qa_approved: ${{ steps.gate.outputs.approved }}
    steps:
      - name: Check all tests passed
        id: gate
        run: |
          echo "ðŸ“Š Stage 2 Quality Gate Summary (Sequential Progressive)"
          echo "=========================================================="
          echo ""
          echo "Deployment URL: ${{ needs.setup.outputs.deployment_url }}"
          echo ""
          echo "Test Results (Sequential):"
          echo "  ðŸ”¥ API Tests (Critical):     ${{ needs.api-tests.result }}"
          echo "  ðŸš¦ Gate 1 Decision:          ${{ needs.gate-1-api-results.outputs.should_run_smoke }}"
          
          if [[ "${{ needs.gate-1-api-results.outputs.should_run_smoke }}" == "true" ]]; then
            echo "  ðŸ”¥ Smoke Tests (Critical):   ${{ needs.smoke-tests.result }}"
            echo "  ðŸš¦ Gate 2 Decision:          ${{ needs.gate-2-smoke-results.outputs.should_run_expensive }}"
          else
            echo "  ðŸ”¥ Smoke Tests:              â­ï¸ SKIPPED (API failed)"
            echo "  ðŸš¦ Gate 2 Decision:          N/A"
          fi
          
          if [[ "${{ needs.gate-2-smoke-results.outputs.should_run_expensive }}" == "true" ]]; then
            echo "  ðŸ’° Flow Tests (Expensive):   ${{ needs.expensive-tests.result }}"
            echo "  ðŸ’° Page Tests (Expensive):   ${{ needs.expensive-tests.result }}"
          else
            echo "  ðŸ’° Expensive Tests:          â­ï¸ SKIPPED (Smoke failed or not run)"
          fi
          echo ""
          echo "=========================================================="
          
          # Determine overall quality gate
          API_PASSED="${{ needs.gate-1-api-results.outputs.api_passed }}"
          SMOKE_PASSED="${{ needs.gate-2-smoke-results.outputs.smoke_passed }}"
          EXPENSIVE_RESULT="${{ needs.expensive-tests.result }}"
          
          # Quality gate passes if:
          # 1. API tests passed AND
          # 2. Smoke tests passed (or were skipped due to API failure) AND
          # 3. Expensive tests passed (or were skipped due to Smoke failure)
          
          if [[ "$API_PASSED" != "true" ]]; then
            echo "âŒ QUALITY GATE FAILED: API tests failed"
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [[ "$SMOKE_PASSED" != "true" ]]; then
            echo "âŒ QUALITY GATE FAILED: Smoke tests failed"
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check expensive tests only if they ran
          if [[ "${{ needs.gate-2-smoke-results.outputs.should_run_expensive }}" == "true" ]]; then
            if [[ "$EXPENSIVE_RESULT" != "success" ]]; then
              echo "âŒ QUALITY GATE FAILED: Expensive tests failed"
              echo "approved=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
          
          echo ""
          echo "âœ… QUALITY GATE PASSED!"
          echo "All tests in the progressive sequence passed."
          echo "approved=true" >> $GITHUB_OUTPUT

      - name: Create quality gate summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Stage 2 Quality Gate Results (Sequential Progressive)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Sequential Test Strategy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Strategy:** Progressive failure gates to minimize wasted test time" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… **API Tests** (always run first)" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸš¦ **Gate 1**: Only proceed if API tests pass" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… **Smoke Tests** (run if API passed)" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸš¦ **Gate 2**: Only proceed if Smoke tests pass" >> $GITHUB_STEP_SUMMARY
          echo "5. âœ… **Expensive Tests** (Flow + Page, run if Smoke passed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Test Suite | Result | Gate Decision |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------------|--------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1ï¸âƒ£ | ðŸ”¥ API Tests | ${{ needs.api-tests.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš¦ | Gate 1 | - | ${{ needs.gate-1-api-results.outputs.should_run_smoke == 'true' && 'âœ… Proceed to Smoke' || 'ðŸ›‘ Block Smoke' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.gate-1-api-results.outputs.should_run_smoke }}" == "true" ]]; then
            echo "| 2ï¸âƒ£ | ðŸ”¥ Smoke Tests | ${{ needs.smoke-tests.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸš¦ | Gate 2 | - | ${{ needs.gate-2-smoke-results.outputs.should_run_expensive == 'true' && 'âœ… Proceed to Expensive' || 'ðŸ›‘ Block Expensive' }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 2ï¸âƒ£ | ðŸ”¥ Smoke Tests | â­ï¸ SKIPPED | API failed |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸš¦ | Gate 2 | - | N/A |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.gate-2-smoke-results.outputs.should_run_expensive }}" == "true" ]]; then
            echo "| 3ï¸âƒ£ | ðŸ’° Flow Tests | ${{ needs.expensive-tests.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
            echo "| 3ï¸âƒ£ | ðŸ’° Page Tests | ${{ needs.expensive-tests.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 3ï¸âƒ£ | ðŸ’° Expensive Tests | â­ï¸ SKIPPED | Smoke failed or not run |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Final Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.gate.outputs.approved }}" == "true" ]]; then
            echo "**âœ… QUALITY GATE PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All sequential tests passed! Deployment validated." >> $GITHUB_STEP_SUMMARY
          else
            echo "**âŒ QUALITY GATE FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more tests in the sequence failed. Review test reports." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** \`${{ needs.setup.outputs.deployment_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Benefits of Sequential Progressive Testing:**" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ Fail fast - stop at first failure" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’° Save test time - skip expensive tests if critical tests fail" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ Clear feedback - know exactly which stage failed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¤– Fully automated - no manual intervention" >> $GITHUB_STEP_SUMMARY
