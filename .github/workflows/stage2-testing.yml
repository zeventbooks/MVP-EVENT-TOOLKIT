name: Stage 2 - Sequential Progressive Testing

on:
  # Auto-trigger when Stage 1 completes successfully
  # MVP SRE Policy: Only run full Playwright on main/release, not feature branches
  workflow_run:
    workflows: ["Stage 1 - Build & Deploy"]
    types: [completed]
    branches:
      - main
      - 'release/**'
      - 'release/*'

  # Manual trigger for "I want full regression" runs
  workflow_dispatch:
    inputs:
      deployment_url:
        description: 'Deployment URL to test (leave empty to use Stage 1 output)'
        required: false
        type: string
        default: ''
      use_production:
        description: '‚ö†Ô∏è DANGER: Run minimal smoke tests against PRODUCTION (www.eventangle.com). Only workflow_dispatch. Read-only tests ONLY. Use with extreme caution!'
        required: false
        type: boolean
        default: false

# Prevent duplicate runs: only one Stage 2 at a time per branch
# Note: cancel-in-progress: false ensures runs queue instead of cancelling each other
# This provides deterministic test results - cancelled runs give no useful feedback
concurrency:
  group: stage2-${{ github.event.workflow_run.head_branch || github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # STAGE 2: E2E TESTING (API ‚Üí SMOKE ‚Üí FLOWS ‚Üí PAGES)
  # ============================================================================
  # Local equivalent: BASE_URL='<url>' ADMIN_KEY='<key>' npm run test:ci:stage2
  # Runs: test:api && test:fe (smoke + flows + pages)
  # Stage 2 red ‚Üí DEPLOYMENT BROKEN, fix before release
  # ============================================================================

  # ============================================================================
  # SETUP: Extract deployment URL from Stage 1
  # ============================================================================

  setup:
    name: üîß Setup & Extract Deployment URL
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    outputs:
      deployment_url: ${{ steps.get-url.outputs.url }}
      url_mode: ${{ steps.get-url.outputs.url_mode }}
      skip_tests: ${{ steps.final-decision.outputs.skip }}
      skip_reason: ${{ steps.final-decision.outputs.reason }}
      is_prod_smoke: ${{ steps.get-url.outputs.is_prod_smoke }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if Stage 1 failed
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]] && \
             [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
            echo "‚ö†Ô∏è Stage 1 did not succeed. Skipping Stage 2."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Get deployment URL
        id: get-url
        run: |
          echo "=================================================="
          echo "üéØ Stage 2 URL Selection (Precedence Order)"
          echo "=================================================="
          echo ""
          echo "Precedence:"
          echo "  0. use_production (PROD SMOKE - workflow_dispatch only)"
          echo "  1. inputs.deployment_url (manual_override)"
          echo "  2. Stage 1 artifact (from_artifact ‚Üí prod)"
          echo "  3. Fallback (default_staging)"
          echo ""
          echo "=================================================="
          echo ""

          # Priority 0: Production smoke mode (workflow_dispatch only, explicit opt-in)
          if [[ "${{ inputs.use_production }}" == "true" ]]; then
            DEPLOYMENT_URL="https://www.eventangle.com"
            URL_MODE="prod_smoke"
            echo "=============================================="
            echo "‚ö†Ô∏è  PRODUCTION SMOKE MODE ACTIVATED"
            echo "=============================================="
            echo "You have explicitly opted into production testing."
            echo "ONLY minimal read-only smoke tests will run."
            echo "=============================================="
            echo ""
            echo "üìã Mode: prod_smoke"
            echo "üìã URL:  $DEPLOYMENT_URL"
            echo ""
            echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
            echo "url_mode=$URL_MODE" >> $GITHUB_OUTPUT
            echo "is_prod_smoke=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "is_prod_smoke=false" >> $GITHUB_OUTPUT

          # Priority 1: Manual override via workflow_dispatch input
          if [[ -n "${{ inputs.deployment_url }}" ]]; then
            DEPLOYMENT_URL="${{ inputs.deployment_url }}"
            URL_MODE="manual_override"
            echo "‚úÖ Priority 1 MATCHED: inputs.deployment_url provided"
            echo ""
            echo "üìã Mode: manual_override"
            echo "üìã URL:  $DEPLOYMENT_URL"
            echo ""
            echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
            echo "url_mode=$URL_MODE" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "‚ùå Priority 1: No inputs.deployment_url provided"
          echo ""

          # Priority 2: Stage 1 artifact (deployment-url.txt)
          echo "üîç Checking Priority 2: Stage 1 artifact..."
          if [[ -n "${{ github.event.workflow_run.id }}" ]]; then
            gh run download ${{ github.event.workflow_run.id }} \
              --name deployment-info 2>/dev/null || true

            if [[ -f deployment-info/deployment-url.txt ]]; then
              DEPLOYMENT_URL=$(cat deployment-info/deployment-url.txt)
              URL_MODE="from_artifact"
              echo "‚úÖ Priority 2 MATCHED: Found deployment-url.txt from Stage 1"
              echo ""
              echo "üìã Mode: from_artifact"
              echo "üìã URL:  $DEPLOYMENT_URL"
              echo "üìã Note: This is typically the PRODUCTION deployment from Stage 1"
              echo ""
              echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
              echo "url_mode=$URL_MODE" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "‚ùå Priority 2: No Stage 1 artifact found"
          echo ""

          # Priority 3: Default to staging (safe fallback)
          DEPLOYMENT_URL="https://stg.eventangle.com"
          URL_MODE="default_staging"
          echo "‚úÖ Priority 3 FALLBACK: Using default staging URL"
          echo ""
          echo "üìã Mode: default_staging"
          echo "üìã URL:  $DEPLOYMENT_URL"
          echo "üìã Note: Staging is the safe default - tests won't stress production"
          echo ""
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "url_mode=$URL_MODE" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Validate deployment URL is reachable
        id: validate-url
        run: |
          DEPLOYMENT_URL="${{ steps.get-url.outputs.url }}"
          URL_MODE="${{ steps.get-url.outputs.url_mode }}"

          echo "üîç Validating deployment URL is reachable..."
          echo "   URL:  $DEPLOYMENT_URL"
          echo "   Mode: $URL_MODE"
          echo ""

          # Try to reach the /ping endpoint (fastest health check)
          PING_URL="${DEPLOYMENT_URL}/ping"
          echo "   Testing: $PING_URL"

          # Use curl with timeout and follow redirects
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 -L "$PING_URL" || echo "000")

          echo "   HTTP Status: $HTTP_STATUS"
          echo ""

          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "‚úÖ Deployment URL is reachable!"
            echo "url_reachable=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Deployment URL is NOT reachable (HTTP $HTTP_STATUS)"
            echo ""

            # If this was the default staging URL, provide helpful message
            if [[ "$URL_MODE" == "default_staging" ]]; then
              echo "‚ö†Ô∏è The default staging URL (stg.eventangle.com) is not available."
              echo "   This typically means staging is not yet deployed in Cloudflare."
              echo ""
              echo "   Options to resolve:"
              echo "   1. Deploy staging environment in Cloudflare"
              echo "   2. Manually trigger Stage 2 with a valid deployment_url"
              echo "   3. Ensure Stage 1 produces a deployment-url artifact"
              echo ""
              echo "   Skipping tests to avoid false positives."
            fi

            echo "url_reachable=false" >> $GITHUB_OUTPUT
          fi

      - name: Display URL selection result
        run: |
          URL_MODE="${{ steps.get-url.outputs.url_mode }}"
          DEPLOYMENT_URL="${{ steps.get-url.outputs.url }}"

          echo "=================================================="
          echo "üìã Stage 2 URL Selection Result"
          echo "=================================================="
          echo ""
          echo "üéØ URL:  $DEPLOYMENT_URL"
          echo ""

          # Display mode with explanation
          case "$URL_MODE" in
            "prod_smoke")
              echo "üìã Mode: prod_smoke"
              echo "   ‚Üí ‚ö†Ô∏è  PRODUCTION SMOKE - Explicit opt-in via use_production=true"
              echo "   ‚Üí Only minimal read-only tests will run"
              echo "   ‚Üí Full test suite is SKIPPED in this mode"
              ;;
            "manual_override")
              echo "üìã Mode: manual_override"
              echo "   ‚Üí URL provided via workflow_dispatch input"
              echo "   ‚Üí User explicitly chose this target"
              ;;
            "from_artifact")
              echo "üìã Mode: from_artifact"
              echo "   ‚Üí URL read from Stage 1 deployment-url.txt"
              echo "   ‚Üí This is the production deployment from Stage 1"
              ;;
            "default_staging")
              echo "üìã Mode: default_staging"
              echo "   ‚Üí Using fallback staging URL"
              echo "   ‚Üí Safe default: tests won't stress production"
              ;;
            *)
              echo "üìã Mode: unknown ($URL_MODE)"
              ;;
          esac
          echo ""

          # Determine environment from URL
          if [[ "$DEPLOYMENT_URL" == *"stg."* ]]; then
            echo "üß™ Environment: STAGING (safe sandbox for testing)"
          else
            echo "üöÄ Environment: PRODUCTION (live site)"
          fi
          echo ""
          echo "üéØ Canonical Events URL: $DEPLOYMENT_URL/events"
          echo "=================================================="

      - name: Final decision - should tests run?
        id: final-decision
        run: |
          echo "üéØ Final Decision: Should Stage 2 tests run?"
          echo "================================================"
          echo ""

          STAGE1_SKIP="${{ steps.check.outputs.skip }}"
          URL_REACHABLE="${{ steps.validate-url.outputs.url_reachable }}"
          URL_MODE="${{ steps.get-url.outputs.url_mode }}"

          echo "Stage 1 check (skip): $STAGE1_SKIP"
          echo "URL reachable: $URL_REACHABLE"
          echo "URL mode: $URL_MODE"
          echo ""

          # Skip if Stage 1 failed
          if [[ "$STAGE1_SKIP" == "true" ]]; then
            echo "‚ùå SKIP: Stage 1 did not succeed"
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=stage1_failed" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Skip if URL is not reachable
          if [[ "$URL_REACHABLE" != "true" ]]; then
            echo "‚ùå SKIP: Deployment URL is not reachable"
            echo ""
            if [[ "$URL_MODE" == "default_staging" ]]; then
              echo "   The default staging URL (stg.eventangle.com) is not available."
              echo "   This prevents false positive test failures."
              echo ""
              echo "   To run tests, either:"
              echo "   - Deploy staging to Cloudflare"
              echo "   - Manually trigger with a valid deployment_url"
              echo "   - Ensure Stage 1 produces a deployment URL artifact"
            fi
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=url_unreachable" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "‚úÖ PROCEED: All checks passed, tests will run"
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "reason=none" >> $GITHUB_OUTPUT

      - name: Create setup summary
        if: always()
        run: |
          echo "## üîß Stage 2 Setup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SKIP_TESTS="${{ steps.final-decision.outputs.skip }}"
          SKIP_REASON="${{ steps.final-decision.outputs.reason }}"
          URL_MODE="${{ steps.get-url.outputs.url_mode }}"
          DEPLOYMENT_URL="${{ steps.get-url.outputs.url }}"

          # URL Selection info
          echo "### üéØ URL Selection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | \`$DEPLOYMENT_URL\` |" >> $GITHUB_STEP_SUMMARY

          # Mode description
          case "$URL_MODE" in
            "prod_smoke")
              echo "| **Mode** | \`prod_smoke\` - ‚ö†Ô∏è PRODUCTION minimal smoke (opt-in) |" >> $GITHUB_STEP_SUMMARY
              ;;
            "manual_override")
              echo "| **Mode** | \`manual_override\` - User provided via workflow_dispatch |" >> $GITHUB_STEP_SUMMARY
              ;;
            "from_artifact")
              echo "| **Mode** | \`from_artifact\` - From Stage 1 deployment-url.txt (prod) |" >> $GITHUB_STEP_SUMMARY
              ;;
            "default_staging")
              echo "| **Mode** | \`default_staging\` - Fallback to stg.eventangle.com |" >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "| **Mode** | \`$URL_MODE\` |" >> $GITHUB_STEP_SUMMARY
              ;;
          esac

          # Environment
          if [[ "$DEPLOYMENT_URL" == *"stg."* ]]; then
            echo "| **Environment** | üß™ STAGING |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Environment** | üöÄ PRODUCTION |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "$SKIP_TESTS" == "true" ]]; then
            echo "### ‚è≠Ô∏è Tests SKIPPED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [[ "$SKIP_REASON" == "stage1_failed" ]]; then
              echo "**Reason:** Stage 1 did not succeed" >> $GITHUB_STEP_SUMMARY
            elif [[ "$SKIP_REASON" == "url_unreachable" ]]; then
              echo "**Reason:** Deployment URL is not reachable" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              if [[ "$URL_MODE" == "default_staging" ]]; then
                echo "The default staging URL is not available in Cloudflare." >> $GITHUB_STEP_SUMMARY
                echo "This is **NOT a test failure** - tests were skipped to prevent false positives." >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "### ‚úÖ Tests will run" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # PRODUCTION SMOKE: Minimal read-only health checks against production
  # ============================================================================
  # DANGER: This job runs tests against LIVE PRODUCTION (www.eventangle.com)
  # - Only runs when use_production=true (workflow_dispatch only)
  # - Runs ONLY minimal read-only tests (status + admin + public page load)
  # - All other test jobs are SKIPPED in this mode
  # ============================================================================

  prod-smoke:
    name: üö® PRODUCTION Smoke (Read-Only)
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.is_prod_smoke == 'true'
    outputs:
      result: ${{ steps.test.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Display Production Warning
        run: |
          echo "=============================================="
          echo "‚ö†Ô∏è  PRODUCTION SMOKE TEST"
          echo "=============================================="
          echo ""
          echo "You are running tests against LIVE PRODUCTION:"
          echo "  https://www.eventangle.com"
          echo ""
          echo "These are READ-ONLY tests only:"
          echo "  - Status API health check"
          echo "  - Admin page loads (no form submissions)"
          echo "  - Public page loads (read-only)"
          echo ""
          echo "NO write operations will be performed."
          echo "=============================================="

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Production Smoke Tests
        id: test
        env:
          BASE_URL: https://www.eventangle.com
          CI: true
        run: |
          echo "üö® Running Production Smoke Tests"
          echo "Target: https://www.eventangle.com"
          echo ""
          npm run test:prod:smoke:minimal
          if [ $? -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úÖ PRODUCTION SMOKE PASSED"
            echo "Production is healthy and responding correctly."
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo ""
            echo "‚ùå PRODUCTION SMOKE FAILED"
            echo "Production may have issues - investigate immediately!"
            exit 1
          fi

      - name: Create Production Smoke Summary
        if: always()
        run: |
          echo "## üö® Production Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** \`https://www.eventangle.com\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.test.outputs.result }}" == "success" ]]; then
            echo "### ‚úÖ PRODUCTION IS HEALTHY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All minimal read-only checks passed:" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Status API responding" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Admin page loads" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Public page loads" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå PRODUCTION HAS ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more health checks failed. Investigate immediately!" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Note: This was a minimal read-only smoke test. No data was modified.*" >> $GITHUB_STEP_SUMMARY

      - name: Upload Production Smoke report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-prod-smoke-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # PREFLIGHT STAGING: Fail fast if staging is unreachable
  # ============================================================================
  # Checks that the target URL is reachable before running any tests.
  # This prevents noisy test failures when staging is simply down.
  # ============================================================================

  preflight-staging:
    name: üõ´ Preflight - Check Staging Reachable
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true'
    outputs:
      staging_reachable: ${{ steps.check.outputs.reachable }}
    steps:
      - name: Check staging is reachable
        id: check
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
        run: |
          echo "üõ´ Preflight Check: Is staging reachable?"
          echo "==========================================="
          echo ""
          echo "Target URL: $BASE_URL"
          echo ""

          # Try /status endpoint first, then /ping as fallback
          STATUS_URL="${BASE_URL}/status"
          PING_URL="${BASE_URL}/ping"

          echo "üîç Checking $STATUS_URL ..."
          HTTP_STATUS=$(curl -sf -o /dev/null -w "%{http_code}" --connect-timeout 15 --max-time 30 "$STATUS_URL" 2>/dev/null || echo "000")

          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "‚úÖ Staging is reachable (status: $HTTP_STATUS)"
            echo "reachable=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "‚ö†Ô∏è /status returned $HTTP_STATUS, trying /ping..."
          HTTP_STATUS=$(curl -sf -o /dev/null -w "%{http_code}" --connect-timeout 15 --max-time 30 "$PING_URL" 2>/dev/null || echo "000")

          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "‚úÖ Staging is reachable via /ping (status: $HTTP_STATUS)"
            echo "reachable=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Staging is unreachable - fail fast with clear message
          echo ""
          echo "=============================================="
          echo "‚ùå STAGING UNREACHABLE"
          echo "=============================================="
          echo ""
          echo "Target: $BASE_URL"
          echo "Status: $HTTP_STATUS"
          echo ""
          echo "Tests cannot run because the deployment is not responding."
          echo "This is NOT a test failure - staging is simply down."
          echo ""
          echo "To fix:"
          echo "  1. Check if staging is deployed"
          echo "  2. Check Cloudflare Worker status"
          echo "  3. Check Apps Script deployment"
          echo "=============================================="
          echo "reachable=false" >> $GITHUB_OUTPUT
          exit 1

  # ============================================================================
  # WARMUP: Eliminate Cold Start Flakiness
  # ============================================================================
  # Warms up the GAS deployment before running any tests
  # This ensures the first test doesn't hit a cold instance
  # ============================================================================

  warmup:
    name: üî• Warmup Deployment
    runs-on: ubuntu-latest
    needs: [setup, preflight-staging]
    if: needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true'
    outputs:
      warmup_success: ${{ steps.warmup.outputs.success }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Warmup deployment
        id: warmup
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          WARMUP_MAX_ATTEMPTS: 5
          WARMUP_TIMEOUT: 60000
        run: |
          echo "üî• Warming up deployment before tests..."
          echo "   BASE_URL: $BASE_URL"
          echo ""

          if node scripts/warmup-deployment.js; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Warmup complete - deployment is hot!"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo ""
            echo "‚ö†Ô∏è Warmup failed - tests will still run but may experience cold start delays"
          fi

  # ============================================================================
  # STAGE 2A: API TESTS (Always Run First)
  # ============================================================================

  api-tests:
    name: üî• API Tests (Critical)
    runs-on: ubuntu-latest
    needs: [setup, preflight-staging, warmup]
    if: needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true' && needs.preflight-staging.outputs.staging_reachable == 'true'
    outputs:
      result: ${{ steps.test.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium webkit

      - name: Run API tests
        id: test
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          CI: true
          # Per-brand admin keys (brand-specific > shared fallback)
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          # Per-brand spreadsheet IDs (brand-specific > shared fallback)
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "üî• Running API tests"
          echo "BASE_URL: $BASE_URL"
          echo "üìç Canonical Events URL: $BASE_URL/events"
          npm run test:api
          if [ $? -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload API test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-api-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # GATE 1: Check API Test Results
  # ============================================================================

  gate-1-api-results:
    name: üö¶ Gate 1 - Check API Results
    runs-on: ubuntu-latest
    needs: [setup, api-tests]
    if: always() && needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true'
    outputs:
      should_run_smoke_packs: ${{ steps.gate.outputs.should_run }}
      api_passed: ${{ steps.gate.outputs.api_passed }}
    steps:
      - name: Evaluate API test results
        id: gate
        run: |
          echo "üö¶ Gate 1: Evaluating API Test Results"
          echo "========================================="

          API_RESULT="${{ needs.api-tests.result }}"

          echo "API Tests Result: $API_RESULT"
          echo ""

          if [[ "$API_RESULT" == "success" ]]; then
            echo "‚úÖ API tests PASSED"
            echo "‚úÖ Proceeding to Smoke Packs"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "api_passed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå API tests FAILED"
            echo "üõë BLOCKING: Skipping Smoke Packs and all downstream tests"
            echo "   Fix API issues before running further tests"
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "api_passed=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # STAGE 2B: SMOKE PACKS (4 Core Smoke Tests - Hard Blocker)
  # ============================================================================
  # Runs the 4 smoke pack tests as a Stage 1 gate:
  #   - pages.smoke.test.js    (MVP surface health)
  #   - integration.smoke.test.js (cross-component flows)
  #   - components.smoke.test.js (deep component validation)
  #   - api.smoke.test.js      (backend endpoint health)
  # ============================================================================

  smoke-packs:
    name: üì¶ Smoke Packs (Stage 1 Gate)
    runs-on: ubuntu-latest
    needs: [setup, gate-1-api-results]
    if: needs.setup.outputs.is_prod_smoke != 'true' && needs.gate-1-api-results.outputs.should_run_smoke_packs == 'true'
    outputs:
      result: ${{ steps.test.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Smoke Packs
        id: test
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          CI: true
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "üì¶ Running Smoke Packs (Stage 1 Gate)"
          echo "BASE_URL: $BASE_URL"
          echo ""
          echo "Smoke Packs:"
          echo "  - pages.smoke.test.js"
          echo "  - integration.smoke.test.js"
          echo "  - components.smoke.test.js"
          echo "  - api.smoke.test.js"
          echo ""
          npm run test:smoke:packs
          if [ $? -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload Smoke Packs report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-smoke-packs-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # GATE 1.5: Check Smoke Packs Results
  # ============================================================================

  gate-smoke-packs-results:
    name: üö¶ Gate 1.5 - Check Smoke Packs
    runs-on: ubuntu-latest
    needs: [setup, gate-1-api-results, smoke-packs]
    if: always() && needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true' && needs.gate-1-api-results.outputs.should_run_smoke_packs == 'true'
    outputs:
      should_run_smoke: ${{ steps.gate.outputs.should_run }}
      smoke_packs_passed: ${{ steps.gate.outputs.smoke_packs_passed }}
    steps:
      - name: Evaluate Smoke Packs results
        id: gate
        run: |
          echo "üö¶ Gate 1.5: Evaluating Smoke Packs Results"
          echo "============================================"

          SMOKE_PACKS_RESULT="${{ needs.smoke-packs.result }}"

          echo "Smoke Packs Result: $SMOKE_PACKS_RESULT"
          echo ""

          if [[ "$SMOKE_PACKS_RESULT" == "success" ]]; then
            echo "‚úÖ Smoke Packs PASSED"
            echo "‚úÖ Proceeding to E2E Smoke Tests"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "smoke_packs_passed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Smoke Packs FAILED"
            echo "üõë BLOCKING: Skipping E2E Smoke Tests and Expensive Tests"
            echo "   Fix Smoke Pack issues before running further tests"
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "smoke_packs_passed=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # STAGE 2C: SMOKE TESTS (E2E Smoke - Only if Smoke Packs passed)
  # ============================================================================

  smoke-tests:
    name: üî• Smoke Tests (E2E)
    runs-on: ubuntu-latest
    needs: [setup, gate-smoke-packs-results]
    if: needs.setup.outputs.is_prod_smoke != 'true' && needs.gate-smoke-packs-results.outputs.should_run_smoke == 'true'
    outputs:
      result: ${{ steps.test.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium webkit

      - name: Run Smoke tests
        id: test
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          CI: true
          # Per-brand admin keys (brand-specific > shared fallback)
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          # Per-brand spreadsheet IDs (brand-specific > shared fallback)
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "üî• Running Smoke tests"
          echo "BASE_URL: $BASE_URL"
          echo "CI: $CI (only chromium browser will be used)"
          npm run test:smoke
          if [ $? -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Generate test summary
        if: always()
        run: |
          echo "## üî• Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse junit.xml if it exists for detailed results
          if [ -f ".test-results/junit.xml" ]; then
            TESTS=$(grep -oP 'tests="\K[0-9]+' .test-results/junit.xml | head -1 || echo "0")
            FAILURES=$(grep -oP 'failures="\K[0-9]+' .test-results/junit.xml | head -1 || echo "0")
            ERRORS=$(grep -oP 'errors="\K[0-9]+' .test-results/junit.xml | head -1 || echo "0")
            SKIPPED=$(grep -oP 'skipped="\K[0-9]+' .test-results/junit.xml | head -1 || echo "0")
            TIME=$(grep -oP 'time="\K[0-9.]+' .test-results/junit.xml | head -1 || echo "0")

            PASSED=$((TESTS - FAILURES - ERRORS - SKIPPED))

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ùå Failed | $FAILURES |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ö†Ô∏è Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚è≠Ô∏è Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚è±Ô∏è Duration | ${TIME}s |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # List failed tests if any
            if [ "$FAILURES" -gt 0 ] || [ "$ERRORS" -gt 0 ]; then
              echo "### ‚ùå Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              grep -oP 'name="\K[^"]+(?=".*(failure|error))' .test-results/junit.xml | head -20 >> $GITHUB_STEP_SUMMARY || echo "See full report for details"
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ö†Ô∏è No junit.xml found - check test output above" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä [View Full HTML Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Upload Smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-smoke-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # GATE 2: Check Smoke Test Results
  # ============================================================================

  gate-2-smoke-results:
    name: üö¶ Gate 2 - Check Smoke Results
    runs-on: ubuntu-latest
    needs: [setup, gate-smoke-packs-results, smoke-tests]
    if: always() && needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true' && needs.gate-smoke-packs-results.outputs.should_run_smoke == 'true'
    outputs:
      should_run_expensive: ${{ steps.gate.outputs.should_run }}
      smoke_passed: ${{ steps.gate.outputs.smoke_passed }}
    steps:
      - name: Evaluate Smoke test results
        id: gate
        run: |
          echo "üö¶ Gate 2: Evaluating Smoke Test Results"
          echo "=========================================="
          
          SMOKE_RESULT="${{ needs.smoke-tests.result }}"
          
          echo "Smoke Tests Result: $SMOKE_RESULT"
          echo ""
          
          if [[ "$SMOKE_RESULT" == "success" ]]; then
            echo "‚úÖ Smoke tests PASSED"
            echo "‚úÖ Proceeding to Expensive Tests (Flow + Page)"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "smoke_passed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Smoke tests FAILED"
            echo "üõë BLOCKING: Skipping Expensive Tests"
            echo "   Fix Smoke test issues before running expensive tests"
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "smoke_passed=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # STAGE 2C: EXPENSIVE TESTS (Only if Smoke tests passed)
  # MVP Flow Tests: Template scenarios + Core propagation
  # ============================================================================

  expensive-tests:
    name: üí∞ Expensive - ${{ matrix.suite }}
    runs-on: ubuntu-latest
    needs: [setup, gate-2-smoke-results]
    if: needs.setup.outputs.is_prod_smoke != 'true' && needs.gate-2-smoke-results.outputs.should_run_expensive == 'true'
    strategy:
      fail-fast: false
      matrix:
        suite:
          - flows    # Includes: template-scenarios.spec.js (Bar/Rec/School/Fundraiser)
          - pages    # Includes: Admin, Public, Display, Poster, Sponsor page tests
    outputs:
      flows_result: ${{ steps.set-result.outputs.flows_result }}
      pages_result: ${{ steps.set-result.outputs.pages_result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium webkit

      - name: Run ${{ matrix.suite }} tests
        id: test
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          CI: true
          # Per-brand admin keys (brand-specific > shared fallback)
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          # Per-brand spreadsheet IDs (brand-specific > shared fallback)
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "üí∞ Running ${{ matrix.suite }} tests"
          echo "BASE_URL: $BASE_URL"
          if [[ "${{ matrix.suite }}" == "flows" ]]; then
            echo "üìã MVP Flow Coverage:"
            echo "   - template-scenarios.spec.js (Bar/Rec League/School/Fundraiser)"
            echo "   - admin-flows.spec.js (event CRUD)"
            echo "   - sponsor-flows.spec.js (sponsor creation & display)"
            echo "   - shared-reporting.spec.js (SharedReport smoke)"
            echo "   - Data propagation: Admin ‚Üí Public ‚Üí Display ‚Üí Poster"
          fi
          npm run test:${{ matrix.suite }}

      - name: Set result output
        id: set-result
        if: always()
        run: |
          if [ "${{ matrix.suite }}" == "flows" ]; then
            if [ "${{ steps.test.outcome }}" == "success" ]; then
              echo "flows_result=success" >> $GITHUB_OUTPUT
            else
              echo "flows_result=failure" >> $GITHUB_OUTPUT
            fi
          else
            if [ "${{ steps.test.outcome }}" == "success" ]; then
              echo "pages_result=success" >> $GITHUB_OUTPUT
            else
              echo "pages_result=failure" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Upload ${{ matrix.suite }} test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-${{ matrix.suite }}-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # FINAL QUALITY GATE & REPORTING
  # ============================================================================

  quality-gate:
    name: üéØ Quality Gate - Final Validation
    runs-on: ubuntu-latest
    needs: [setup, preflight-staging, api-tests, gate-1-api-results, smoke-packs, gate-smoke-packs-results, smoke-tests, gate-2-smoke-results, expensive-tests]
    if: always() && needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true'
    outputs:
      qa_approved: ${{ steps.gate.outputs.approved }}
    steps:
      - name: Check all tests passed
        id: gate
        run: |
          echo "üìä Stage 2 Quality Gate Summary (Sequential Progressive)"
          echo "=========================================================="
          echo ""
          echo "Deployment URL: ${{ needs.setup.outputs.deployment_url }}"
          echo ""
          echo "Test Results (Sequential):"
          echo "  üî• API Tests (Critical):     ${{ needs.api-tests.result }}"
          echo "  üö¶ Gate 1 Decision:          ${{ needs.gate-1-api-results.outputs.should_run_smoke_packs }}"

          if [[ "${{ needs.gate-1-api-results.outputs.should_run_smoke_packs }}" == "true" ]]; then
            echo "  üì¶ Smoke Packs (Stage 1):    ${{ needs.smoke-packs.result }}"
            echo "  üö¶ Gate 1.5 Decision:        ${{ needs.gate-smoke-packs-results.outputs.should_run_smoke }}"
          else
            echo "  üì¶ Smoke Packs:              ‚è≠Ô∏è SKIPPED (API failed)"
            echo "  üö¶ Gate 1.5 Decision:        N/A"
          fi

          if [[ "${{ needs.gate-smoke-packs-results.outputs.should_run_smoke }}" == "true" ]]; then
            echo "  üî• Smoke Tests (E2E):        ${{ needs.smoke-tests.result }}"
            echo "  üö¶ Gate 2 Decision:          ${{ needs.gate-2-smoke-results.outputs.should_run_expensive }}"
          else
            echo "  üî• Smoke Tests:              ‚è≠Ô∏è SKIPPED (Smoke Packs failed)"
            echo "  üö¶ Gate 2 Decision:          N/A"
          fi

          if [[ "${{ needs.gate-2-smoke-results.outputs.should_run_expensive }}" == "true" ]]; then
            echo "  üí∞ Flow Tests (Expensive):   ${{ needs.expensive-tests.result }}"
            echo "  üí∞ Page Tests (Expensive):   ${{ needs.expensive-tests.result }}"
          else
            echo "  üí∞ Expensive Tests:          ‚è≠Ô∏è SKIPPED (Smoke failed or not run)"
          fi
          echo ""
          echo "=========================================================="

          # Determine overall quality gate
          API_PASSED="${{ needs.gate-1-api-results.outputs.api_passed }}"
          SMOKE_PACKS_PASSED="${{ needs.gate-smoke-packs-results.outputs.smoke_packs_passed }}"
          SMOKE_PASSED="${{ needs.gate-2-smoke-results.outputs.smoke_passed }}"
          EXPENSIVE_RESULT="${{ needs.expensive-tests.result }}"

          # Quality gate passes if:
          # 1. API tests passed AND
          # 2. Smoke Packs passed AND
          # 3. Smoke tests passed AND
          # 4. Expensive tests passed (or were skipped)

          if [[ "$API_PASSED" != "true" ]]; then
            echo "‚ùå QUALITY GATE FAILED: API tests failed"
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [[ "$SMOKE_PACKS_PASSED" != "true" ]]; then
            echo "‚ùå QUALITY GATE FAILED: Smoke Packs failed"
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [[ "$SMOKE_PASSED" != "true" ]]; then
            echo "‚ùå QUALITY GATE FAILED: Smoke tests failed"
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check expensive tests only if they ran
          if [[ "${{ needs.gate-2-smoke-results.outputs.should_run_expensive }}" == "true" ]]; then
            if [[ "$EXPENSIVE_RESULT" != "success" ]]; then
              echo "‚ùå QUALITY GATE FAILED: Expensive tests failed"
              echo "approved=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          echo ""
          echo "‚úÖ QUALITY GATE PASSED!"
          echo "All tests in the progressive sequence passed."
          echo "approved=true" >> $GITHUB_OUTPUT

      - name: Create quality gate summary
        if: always()
        run: |
          echo "## üéØ Stage 2 Quality Gate Results (Sequential Progressive)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Sequential Test Strategy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Strategy:** Progressive failure gates to minimize wasted test time" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ‚úÖ **API Tests** (always run first)" >> $GITHUB_STEP_SUMMARY
          echo "2. üö¶ **Gate 1**: Only proceed if API tests pass" >> $GITHUB_STEP_SUMMARY
          echo "3. üì¶ **Smoke Packs** (Stage 1 gate - 4 core smoke tests)" >> $GITHUB_STEP_SUMMARY
          echo "4. üö¶ **Gate 1.5**: Only proceed if Smoke Packs pass" >> $GITHUB_STEP_SUMMARY
          echo "5. ‚úÖ **Smoke Tests** (E2E smoke tests)" >> $GITHUB_STEP_SUMMARY
          echo "6. üö¶ **Gate 2**: Only proceed if Smoke tests pass" >> $GITHUB_STEP_SUMMARY
          echo "7. ‚úÖ **Expensive Tests** (Flow + Page, run if Smoke passed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Test Suite | Result | Gate Decision |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------------|--------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1Ô∏è‚É£ | üî• API Tests | ${{ needs.api-tests.result == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| üö¶ | Gate 1 | - | ${{ needs.gate-1-api-results.outputs.should_run_smoke_packs == 'true' && '‚úÖ Proceed to Smoke Packs' || 'üõë Block Smoke Packs' }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.gate-1-api-results.outputs.should_run_smoke_packs }}" == "true" ]]; then
            echo "| 2Ô∏è‚É£ | üì¶ Smoke Packs | ${{ needs.smoke-packs.result == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
            echo "| üö¶ | Gate 1.5 | - | ${{ needs.gate-smoke-packs-results.outputs.should_run_smoke == 'true' && '‚úÖ Proceed to Smoke' || 'üõë Block Smoke' }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 2Ô∏è‚É£ | üì¶ Smoke Packs | ‚è≠Ô∏è SKIPPED | API failed |" >> $GITHUB_STEP_SUMMARY
            echo "| üö¶ | Gate 1.5 | - | N/A |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.gate-smoke-packs-results.outputs.should_run_smoke }}" == "true" ]]; then
            echo "| 3Ô∏è‚É£ | üî• Smoke Tests | ${{ needs.smoke-tests.result == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
            echo "| üö¶ | Gate 2 | - | ${{ needs.gate-2-smoke-results.outputs.should_run_expensive == 'true' && '‚úÖ Proceed to Expensive' || 'üõë Block Expensive' }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 3Ô∏è‚É£ | üî• Smoke Tests | ‚è≠Ô∏è SKIPPED | Smoke Packs failed |" >> $GITHUB_STEP_SUMMARY
            echo "| üö¶ | Gate 2 | - | N/A |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.gate-2-smoke-results.outputs.should_run_expensive }}" == "true" ]]; then
            echo "| 4Ô∏è‚É£ | üí∞ Flow Tests | ${{ needs.expensive-tests.result == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
            echo "| 4Ô∏è‚É£ | üí∞ Page Tests | ${{ needs.expensive-tests.result == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 4Ô∏è‚É£ | üí∞ Expensive Tests | ‚è≠Ô∏è SKIPPED | Smoke failed or not run |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üéØ Final Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.gate.outputs.approved }}" == "true" ]]; then
            echo "**‚úÖ QUALITY GATE PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All sequential tests passed! Deployment validated." >> $GITHUB_STEP_SUMMARY
          else
            echo "**‚ùå QUALITY GATE FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more tests in the sequence failed. Review test reports." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** \`${{ needs.setup.outputs.deployment_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Benefits of Sequential Progressive Testing:**" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ö° Fail fast - stop at first failure" >> $GITHUB_STEP_SUMMARY
          echo "- üí∞ Save test time - skip expensive tests if critical tests fail" >> $GITHUB_STEP_SUMMARY
          echo "- üéØ Clear feedback - know exactly which stage failed" >> $GITHUB_STEP_SUMMARY
          echo "- ü§ñ Fully automated - no manual intervention" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # GLOBAL CI GATE: ci:all - Single pass/fail gate for production safety
  # ============================================================================
  # This job runs the unified ci:all command that combines all validations.
  # Production deployment should be contingent on this gate passing.
  # ============================================================================

  ci-all-gate:
    name: üö¶ CI:ALL Global Gate
    runs-on: ubuntu-latest
    needs: [setup, quality-gate]
    if: always() && needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true'
    outputs:
      gate_passed: ${{ steps.ci-all.outputs.passed }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium webkit

      - name: Run ci:all global gate
        id: ci-all
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.setup.outputs.deployment_url }}
          CI: true
          # Per-brand admin keys
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          # Per-brand spreadsheet IDs
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "üö¶ Running ci:all Global Gate"
          echo "================================================"
          echo "BASE_URL: $BASE_URL"
          echo ""
          echo "This command runs:"
          echo "  1. ci:fast   - Unit tests"
          echo "  2. ci:contracts - Schema, services, API contracts, SDK tests"
          echo "  3. ci:e2e    - All E2E surface tests (admin, public, display, poster, report)"
          echo ""
          echo "================================================"
          npm run ci:all
          if [ $? -eq 0 ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úÖ CI:ALL GATE PASSED - Build is safe for production"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo ""
            echo "‚ùå CI:ALL GATE FAILED - Do NOT deploy to production"
            exit 1
          fi

      - name: Create ci:all summary
        if: always()
        run: |
          echo "## üö¶ CI:ALL Global Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** \`${{ needs.setup.outputs.deployment_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.ci-all.outputs.passed }}" == "true" ]]; then
            echo "### ‚úÖ GATE PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The ci:all gate passed. This build is safe for production." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Tests Executed:**" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ ci:fast (unit tests)" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ ci:contracts (schemas, services, API contracts, SDK)" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ ci:e2e (admin, public, display, poster, report)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå GATE FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The ci:all gate failed. **DO NOT deploy to production.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the test output above to identify failures." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # PRODUCTION DEPLOYMENT GATE
  # ============================================================================
  # This gate blocks any production deployment unless ci:all passes.
  # Use this job as a required check for production deployments.
  # ============================================================================

  production-gate:
    name: üîí Production Deployment Gate
    runs-on: ubuntu-latest
    needs: [setup, quality-gate, ci-all-gate]
    if: always() && needs.setup.outputs.skip_tests != 'true' && needs.setup.outputs.is_prod_smoke != 'true'
    steps:
      - name: Check production readiness
        id: prod-check
        run: |
          echo "üîí Production Deployment Gate"
          echo "================================================"
          echo ""
          echo "Quality Gate Status: ${{ needs.quality-gate.outputs.qa_approved }}"
          echo "CI:ALL Gate Status:  ${{ needs.ci-all-gate.outputs.gate_passed }}"
          echo ""

          QUALITY_PASSED="${{ needs.quality-gate.outputs.qa_approved }}"
          CIALL_PASSED="${{ needs.ci-all-gate.outputs.gate_passed }}"

          if [[ "$QUALITY_PASSED" == "true" ]] && [[ "$CIALL_PASSED" == "true" ]]; then
            echo "‚úÖ PRODUCTION GATE PASSED"
            echo ""
            echo "All validations passed. This build is approved for production deployment."
            echo "production_approved=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå PRODUCTION GATE FAILED"
            echo ""
            echo "One or more gates failed. DO NOT deploy to production."
            echo ""
            if [[ "$QUALITY_PASSED" != "true" ]]; then
              echo "  - Quality Gate: FAILED"
            fi
            if [[ "$CIALL_PASSED" != "true" ]]; then
              echo "  - CI:ALL Gate: FAILED"
            fi
            echo "production_approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Create production gate summary
        if: always()
        run: |
          echo "## üîí Production Deployment Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.prod-check.outputs.production_approved }}" == "true" ]]; then
            echo "### ‚úÖ APPROVED FOR PRODUCTION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All gates passed. This build is safe to deploy to production." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå BLOCKED FROM PRODUCTION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**This build should NOT be deployed to production.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Fix the failing tests before attempting production deployment." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Gate | ${{ needs.quality-gate.outputs.qa_approved == 'true' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CI:ALL Gate | ${{ needs.ci-all-gate.outputs.gate_passed == 'true' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> $GITHUB_STEP_SUMMARY
