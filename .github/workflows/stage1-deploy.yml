name: Stage 1 - Build & Deploy

on:
  push:
    branches: [ main, 'claude/**' ]
  pull_request:
    branches: [ main ]

jobs:
  # ============================================================================
  # STAGE 1: BUILD, TEST & DEPLOY
  # ============================================================================

  lint:
    name: üîç Code Quality (ESLint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: |
          echo "üîç Running ESLint to check code quality..."
          npm run lint
          echo "‚úÖ Linting passed! Code quality verified."

  unit-tests:
    name: ‚úÖ Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: |
          echo "‚ÑπÔ∏è Running Jest unit tests (no BASE_URL required - uses mock data)"
          npm test -- --coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info

  contract-tests:
    name: üìã Contract Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run contract tests
        run: |
          echo "‚ÑπÔ∏è Running contract tests (no BASE_URL required - validates response structure with mocks)"
          npm run test:contract

      - name: Run Triangle contract tests
        run: |
          npm run test:triangle:before:contract
          npm run test:triangle:during:contract
          npm run test:triangle:after:contract
          npm run test:triangle:all:contract

  deploy-to-apps-script:
    name: üöÄ Deploy to Apps Script API
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, contract-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      deployment_url: ${{ steps.deploy.outputs.url }}
      root_url: ${{ steps.urls.outputs.root_url }}
      abc_url: ${{ steps.urls.outputs.abc_url }}
      cbc_url: ${{ steps.urls.outputs.cbc_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate deployment secrets
        env:
          CLASPRC_JSON: ${{ secrets.OAUTH_CREDENTIALS }}
        run: |
          echo "üîç Validating deployment secrets..."

          # Check if OAUTH_CREDENTIALS is set
          if [ -z "$CLASPRC_JSON" ]; then
            echo "‚ùå ERROR: OAUTH_CREDENTIALS secret not set"
            echo "Please configure the OAUTH_CREDENTIALS secret in GitHub repository settings"
            exit 1
          fi

          # Validate JSON structure
          if ! echo "$CLASPRC_JSON" | jq -e '.token.access_token' > /dev/null 2>&1; then
            echo "‚ùå ERROR: Invalid OAUTH_CREDENTIALS format"
            echo "Expected JSON with .token.access_token field"
            exit 1
          fi

          # Check if refresh_token exists
          if ! echo "$CLASPRC_JSON" | jq -e '.token.refresh_token' > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  WARNING: No refresh_token found in OAUTH_CREDENTIALS"
            echo "Token may expire and fail future deployments"
          fi

          echo "‚úÖ Secrets validation passed"

      - name: Deploy to Apps Script via clasp
        id: deploy
        env:
          CLASPRC_JSON: ${{ secrets.OAUTH_CREDENTIALS }}
          DEPLOYMENT_ID: ${{ secrets.DEPLOYMENT_ID }}
        run: |
          echo "üîê Setting up clasp credentials..."
          echo "$CLASPRC_JSON" > ~/.clasprc.json

          echo "üöÄ Deploying to Apps Script..."
          npx clasp push --force

          echo "üì¶ Updating deployment..."
          # Check if we have a deployment ID to update
          if [ -n "$DEPLOYMENT_ID" ]; then
            echo "Updating existing deployment: $DEPLOYMENT_ID"
            DEPLOY_OUTPUT=$(npx clasp deploy -i "$DEPLOYMENT_ID" -d "Stage 1 Deploy $(date -Iseconds)" 2>&1)
          else
            echo "Creating new deployment (no DEPLOYMENT_ID secret set)"
            DEPLOY_OUTPUT=$(npx clasp deploy -d "Stage 1 Deploy $(date -Iseconds)" 2>&1)
          fi

          echo "$DEPLOY_OUTPUT"
          VERSION_ID=$(echo "$DEPLOY_OUTPUT" | grep -oP 'Created version \K\d+' || echo "$DEPLOY_OUTPUT" | grep -oP 'Updated deployment \K\w+' || echo "unknown")

          # Get the deployment ID and construct the web app URL
          echo "üìã Fetching deployment URL..."
          DEPLOYMENTS_OUTPUT=$(npx clasp deployments 2>&1)
          echo "$DEPLOYMENTS_OUTPUT"

          # Extract deployment ID from the deploy output first
          DEPLOYMENT_ID_FROM_OUTPUT=$(echo "$DEPLOY_OUTPUT" | grep -oP 'AKfycb[a-zA-Z0-9_-]+' | head -1)

          # If not found in deploy output, try to get from deployments list
          if [ -z "$DEPLOYMENT_ID_FROM_OUTPUT" ]; then
            echo "Extracting deployment ID from deployments list..."
            DEPLOYMENT_ID_FROM_OUTPUT=$(echo "$DEPLOYMENTS_OUTPUT" | grep -oP 'AKfycb[a-zA-Z0-9_-]+' | head -1)
          fi

          # Construct the Web App URL from the deployment ID
          if [ -n "$DEPLOYMENT_ID_FROM_OUTPUT" ]; then
            WEB_APP_URL="https://script.google.com/macros/s/${DEPLOYMENT_ID_FROM_OUTPUT}/exec"
            echo "‚úÖ Found deployment ID: ${DEPLOYMENT_ID_FROM_OUTPUT}"
          else
            echo "‚ö†Ô∏è Warning: Could not extract deployment ID from deployments"
            echo "Please check clasp deployments manually"
            exit 1
          fi

          echo "url=$WEB_APP_URL" >> $GITHUB_OUTPUT
          echo "deployment_id=$DEPLOYMENT_ID_FROM_OUTPUT" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployment complete! Base URL: $WEB_APP_URL"

      - name: Update Hostinger Proxy (Automated)
        if: success()
        env:
          FTP_SERVER: ${{ secrets.HOSTINGER_FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          DEPLOYMENT_ID: ${{ steps.deploy.outputs.deployment_id }}
        run: |
          echo "üîÑ Updating Hostinger proxy with new deployment ID..."

          # Check if FTP secrets are configured
          if [ -z "$FTP_SERVER" ] || [ -z "$FTP_USERNAME" ] || [ -z "$FTP_PASSWORD" ]; then
            echo "‚ö†Ô∏è FTP secrets not configured - skipping Hostinger update"
            echo "‚ÑπÔ∏è To enable automated Hostinger updates, add these secrets:"
            echo "   - HOSTINGER_FTP_SERVER"
            echo "   - HOSTINGER_FTP_USERNAME"
            echo "   - HOSTINGER_FTP_PASSWORD"
            echo ""
            echo "üìù Manual update required:"
            echo "   1. Edit hostinger-proxy/index.php line 19"
            echo "   2. Update deployment ID to: $DEPLOYMENT_ID"
            echo "   3. Upload to Hostinger via FTP"
            exit 0
          fi

          # Update index.php with new deployment ID
          sed -i "s|define('GOOGLE_SCRIPT_URL', 'https://script.google.com/macros/s/[^/]*/exec');|define('GOOGLE_SCRIPT_URL', 'https://script.google.com/macros/s/${DEPLOYMENT_ID}/exec');|" hostinger-proxy/index.php

          # Update the comment with deployment ID
          sed -i "s|// Deployment ID: AKfycb[a-zA-Z0-9_-]*|// Deployment ID: ${DEPLOYMENT_ID}|" hostinger-proxy/index.php

          # Update the timestamp
          sed -i "s|// Last updated: [0-9-]*|// Last updated: $(date -I)|" hostinger-proxy/index.php

          echo "‚úÖ Updated index.php with deployment ID: $DEPLOYMENT_ID"

          # Install FTP client
          npm install -g basic-ftp

          # Upload to Hostinger via FTP
          node << 'FTPSCRIPT'
          const ftp = require("basic-ftp");
          const fs = require("fs");

          async function uploadToHostinger() {
            const client = new ftp.Client();
            client.ftp.verbose = true;

            try {
              console.log("üì° Connecting to FTP server...");
              await client.access({
                host: process.env.FTP_SERVER,
                user: process.env.FTP_USERNAME,
                password: process.env.FTP_PASSWORD,
                secure: false
              });

              console.log("‚úÖ Connected to FTP server");

              // Upload index.php
              console.log("üì§ Uploading index.php to public_html/...");
              await client.uploadFrom("hostinger-proxy/index.php", "public_html/index.php");

              console.log("‚úÖ Hostinger proxy updated successfully!");
              console.log("üåê Changes will be live at https://zeventbooks.com in ~30 seconds");

            } catch (err) {
              console.error("‚ùå FTP upload failed:", err.message);
              process.exit(1);
            } finally {
              client.close();
            }
          }

          uploadToHostinger();
          FTPSCRIPT

          echo ""
          echo "‚úÖ Automated Hostinger deployment complete!"
          echo "üîó Test URLs:"
          echo "   https://zeventbooks.com?p=status&brand=root"
          echo "   https://zeventbooks.com?p=admin&brand=root"

      - name: Update Cloudflare Worker (Optional)
        if: success()
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DEPLOYMENT_ID: ${{ steps.deploy.outputs.deployment_id }}
        run: |
          echo "‚òÅÔ∏è Checking Cloudflare Worker configuration..."

          # Check if Cloudflare secrets are configured
          if [ -z "$CLOUDFLARE_API_TOKEN" ] || [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "‚ÑπÔ∏è Cloudflare secrets not configured - skipping Worker update"
            echo "   To enable Cloudflare Workers, add these secrets:"
            echo "   - CLOUDFLARE_API_TOKEN"
            echo "   - CLOUDFLARE_ACCOUNT_ID"
            echo ""
            echo "   See: cloudflare-proxy/CLOUDFLARE_SETUP.md"
            exit 0
          fi

          echo "üîÑ Updating Cloudflare Worker with new deployment ID..."

          # Update wrangler.toml with new deployment ID
          sed -i "s/DEPLOYMENT_ID = \"[^\"]*\"/DEPLOYMENT_ID = \"${DEPLOYMENT_ID}\"/" cloudflare-proxy/wrangler.toml

          # Also update the worker.js default
          sed -i "s/const DEFAULT_DEPLOYMENT_ID = '[^']*'/const DEFAULT_DEPLOYMENT_ID = '${DEPLOYMENT_ID}'/" cloudflare-proxy/worker.js

          # Install and deploy with Wrangler
          npm install -g wrangler

          cd cloudflare-proxy
          wrangler deploy

          echo ""
          echo "‚úÖ Cloudflare Worker updated!"
          echo "üîó Worker URL: https://zeventbooks-api.workers.dev?p=status&brand=root"

      - name: Generate comprehensive brand URLs
        id: urls
        run: |
          APPS_SCRIPT_BASE="${{ steps.deploy.outputs.url }}"
          HOSTINGER_BASE="https://zeventbooks.com"

          # Brands: root, abc, cbc, cbl
          BRANDS=("root" "abc" "cbc" "cbl")

          # Page types
          PAGES=("status" "admin" "events" "display" "sponsor" "public")

          echo ""
          echo "=============================================="
          echo "üìã DEPLOYMENT URLS - READY FOR TESTING"
          echo "=============================================="
          echo ""
          echo "üöÄ Apps Script Base URL:"
          echo "$APPS_SCRIPT_BASE"
          echo ""
          echo "üåê Hostinger Base URL:"
          echo "$HOSTINGER_BASE"
          echo ""
          echo "=============================================="
          echo ""

          # Generate URLs for each brand and page type
          for brand in "${BRANDS[@]}"; do
            echo "üéØ Brand: ${brand^^}"
            echo "----------------------------------------"
            for page in "${PAGES[@]}"; do
              # Use 'p' parameter for most pages, 'page' for admin
              if [ "$page" == "admin" ]; then
                PARAM="page"
              else
                PARAM="p"
              fi

              APPS_URL="${APPS_SCRIPT_BASE}?${PARAM}=${page}&brand=${brand}"
              HOST_URL="${HOSTINGER_BASE}?${PARAM}=${page}&brand=${brand}"

              echo "  ${page}:"
              echo "    Apps Script: $APPS_URL"
              echo "    Hostinger:   $HOST_URL"
            done
            echo ""
          done

          echo "=============================================="
          echo "üí° Full clickable URLs available in Job Summary below"
          echo "=============================================="
          echo ""

          # Save primary URLs for backward compatibility with Stage 2
          echo "root_url=${APPS_SCRIPT_BASE}?p=events&brand=root" >> $GITHUB_OUTPUT
          echo "abc_url=${APPS_SCRIPT_BASE}?p=events&brand=abc" >> $GITHUB_OUTPUT
          echo "cbc_url=${APPS_SCRIPT_BASE}?p=events&brand=cbc" >> $GITHUB_OUTPUT
          echo "cbl_url=${APPS_SCRIPT_BASE}?p=events&brand=cbl" >> $GITHUB_OUTPUT

      - name: Save deployment URL for Stage 2
        run: |
          mkdir -p deployment-info
          echo "${{ steps.deploy.outputs.url }}" > deployment-info/deployment-url.txt
          echo "‚úÖ Saved deployment URL for Stage 2 auto-trigger"

      - name: Upload deployment info artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info
          path: deployment-info/deployment-url.txt
          retention-days: 1

      - name: Create comprehensive deployment summary
        run: |
          APPS_SCRIPT_BASE="${{ steps.deploy.outputs.url }}"
          HOSTINGER_BASE="https://zeventbooks.com"

          echo "## üöÄ Stage 1 Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Quality Gates Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality (ESLint)" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests (Jest)" >> $GITHUB_STEP_SUMMARY
          echo "- Contract Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üåê Comprehensive Test URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** Test both Apps Script and Hostinger URLs to verify which works best for your use case." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Base Deployment URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Base URL |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| üöÄ **Apps Script** | \`${APPS_SCRIPT_BASE}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| üåê **Hostinger** | \`${HOSTINGER_BASE}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Generate comprehensive URL tables for each brand
          BRANDS=("root" "abc" "cbc" "cbl")
          BRAND_NAMES=("ROOT (Zeventbook)" "ABC (American Bocce Co.)" "CBC (Chicago Bocce Club)" "CBL (Chicago Bocce League)")

          for i in "${!BRANDS[@]}"; do
            brand="${BRANDS[$i]}"
            brand_name="${BRAND_NAMES[$i]}"

            echo "### üéØ Brand: ${brand_name}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Page | Apps Script URL | Hostinger URL |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-----------------|---------------|" >> $GITHUB_STEP_SUMMARY

            # Status
            echo "| üîç **Status** | [Test](${APPS_SCRIPT_BASE}?p=status&brand=${brand}) | [Test](${HOSTINGER_BASE}?p=status&brand=${brand}) |" >> $GITHUB_STEP_SUMMARY

            # Admin
            echo "| ‚öôÔ∏è **Admin** | [Test](${APPS_SCRIPT_BASE}?page=admin&brand=${brand}) | [Test](${HOSTINGER_BASE}?page=admin&brand=${brand}) |" >> $GITHUB_STEP_SUMMARY

            # Events (Public listing)
            echo "| üìÖ **Events** | [Test](${APPS_SCRIPT_BASE}?p=events&brand=${brand}) | [Test](${HOSTINGER_BASE}?p=events&brand=${brand}) |" >> $GITHUB_STEP_SUMMARY

            # Display (TV mode)
            echo "| üì∫ **Display** | [Test](${APPS_SCRIPT_BASE}?p=display&brand=${brand}) | [Test](${HOSTINGER_BASE}?p=display&brand=${brand}) |" >> $GITHUB_STEP_SUMMARY

            # Sponsor
            echo "| üíº **Sponsor** | [Test](${APPS_SCRIPT_BASE}?p=sponsor&brand=${brand}) | [Test](${HOSTINGER_BASE}?p=sponsor&brand=${brand}) |" >> $GITHUB_STEP_SUMMARY

            # Public
            echo "| üë• **Public** | [Test](${APPS_SCRIPT_BASE}?p=public&brand=${brand}) | [Test](${HOSTINGER_BASE}?p=public&brand=${brand}) |" >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
          done

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üí° Testing Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Status Page**: Verify API health and connectivity" >> $GITHUB_STEP_SUMMARY
          echo "2. **Admin Page**: Test event management interface (requires admin key)" >> $GITHUB_STEP_SUMMARY
          echo "3. **Events Page**: Test public event listing" >> $GITHUB_STEP_SUMMARY
          echo "4. **Display Page**: Test TV/kiosk display mode" >> $GITHUB_STEP_SUMMARY
          echo "5. **Sponsor Page**: Test sponsor self-service interface" >> $GITHUB_STEP_SUMMARY
          echo "6. **Public Page**: Test customer-facing event view" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä **Next Step**: Stage 2 will automatically run Playwright tests against these URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Quick Copy-Paste URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Apps Script - Status Endpoints (API Health)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}?p=status&brand=root" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}?p=status&brand=abc" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}?p=status&brand=cbc" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}?p=status&brand=cbl" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Hostinger - Status Endpoints (API Health)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${HOSTINGER_BASE}?p=status&brand=root" >> $GITHUB_STEP_SUMMARY
          echo "${HOSTINGER_BASE}?p=status&brand=abc" >> $GITHUB_STEP_SUMMARY
          echo "${HOSTINGER_BASE}?p=status&brand=cbc" >> $GITHUB_STEP_SUMMARY
          echo "${HOSTINGER_BASE}?p=status&brand=cbl" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Apps Script - Admin Pages (Event Management)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}?page=admin&brand=root" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}?page=admin&brand=abc" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}?page=admin&brand=cbc" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}?page=admin&brand=cbl" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Hostinger - Admin Pages (Event Management)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${HOSTINGER_BASE}?page=admin&brand=root" >> $GITHUB_STEP_SUMMARY
          echo "${HOSTINGER_BASE}?page=admin&brand=abc" >> $GITHUB_STEP_SUMMARY
          echo "${HOSTINGER_BASE}?page=admin&brand=cbc" >> $GITHUB_STEP_SUMMARY
          echo "${HOSTINGER_BASE}?page=admin&brand=cbl" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ü§ñ **Stage 2 will auto-trigger in a few seconds!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cost-Optimized Progressive Testing Strategy:**" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Stage 1 Complete (ESLint + Jest Unit + Contract tests passed)" >> $GITHUB_STEP_SUMMARY
          echo "- üöÄ Stage 2 Starting automatically..." >> $GITHUB_STEP_SUMMARY
          echo "  - üî• **Critical Tests** (run first):" >> $GITHUB_STEP_SUMMARY
          echo "    - Playwright API Tests (validates REST endpoints)" >> $GITHUB_STEP_SUMMARY
          echo "    - Playwright Smoke Tests (validates critical user paths)" >> $GITHUB_STEP_SUMMARY
          echo "  - üö¶ **Failure Gate**: Calculate failure rate" >> $GITHUB_STEP_SUMMARY
          echo "  - üí∞ **Expensive Tests** (only if failure rate < 50%):" >> $GITHUB_STEP_SUMMARY
          echo "    - Playwright Flow Tests (multi-step user workflows)" >> $GITHUB_STEP_SUMMARY
          echo "    - Playwright Page Tests (comprehensive page validation)" >> $GITHUB_STEP_SUMMARY
          echo "  - üéØ **Quality Gate**: All tests must pass" >> $GITHUB_STEP_SUMMARY
          echo "  - üöÄ **QA Deployment**: Deploy to QA environment if approved" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the **Actions** tab to monitor Stage 2 progress." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
