name: Stage 1 - Build & Deploy

on:
  push:
    branches: [ main, 'claude/**' ]
  pull_request:
    branches: [ main ]

jobs:
  # ============================================================================
  # STAGE 1: BUILD, TEST & DEPLOY
  # ============================================================================

  unit-tests:
    name: âœ… Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: |
          echo "â„¹ï¸ Running Jest unit tests (no BASE_URL required - uses mock data)"
          npm test -- --coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info

  contract-tests:
    name: ðŸ“‹ Contract Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run contract tests
        run: |
          echo "â„¹ï¸ Running contract tests (no BASE_URL required - validates response structure with mocks)"
          npm run test:contract

      - name: Run Triangle contract tests
        run: |
          npm run test:triangle:before:contract
          npm run test:triangle:during:contract
          npm run test:triangle:after:contract
          npm run test:triangle:all:contract

  deploy-to-apps-script:
    name: ðŸš€ Deploy to Apps Script API
    runs-on: ubuntu-latest
    needs: [unit-tests, contract-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      deployment_url: ${{ steps.deploy.outputs.url }}
      root_url: ${{ steps.urls.outputs.root_url }}
      abc_url: ${{ steps.urls.outputs.abc_url }}
      cbc_url: ${{ steps.urls.outputs.cbc_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate deployment secrets
        env:
          CLASPRC_JSON: ${{ secrets.OAUTH_CREDENTIALS }}
        run: |
          echo "ðŸ” Validating deployment secrets..."

          # Check if OAUTH_CREDENTIALS is set
          if [ -z "$CLASPRC_JSON" ]; then
            echo "âŒ ERROR: OAUTH_CREDENTIALS secret not set"
            echo "Please configure the OAUTH_CREDENTIALS secret in GitHub repository settings"
            exit 1
          fi

          # Validate JSON structure
          if ! echo "$CLASPRC_JSON" | jq -e '.token.access_token' > /dev/null 2>&1; then
            echo "âŒ ERROR: Invalid OAUTH_CREDENTIALS format"
            echo "Expected JSON with .token.access_token field"
            exit 1
          fi

          # Check if refresh_token exists
          if ! echo "$CLASPRC_JSON" | jq -e '.token.refresh_token' > /dev/null 2>&1; then
            echo "âš ï¸  WARNING: No refresh_token found in OAUTH_CREDENTIALS"
            echo "Token may expire and fail future deployments"
          fi

          echo "âœ… Secrets validation passed"

      - name: Deploy to Apps Script via clasp
        id: deploy
        env:
          CLASPRC_JSON: ${{ secrets.OAUTH_CREDENTIALS }}
          DEPLOYMENT_ID: ${{ secrets.DEPLOYMENT_ID }}
        run: |
          echo "ðŸ” Setting up clasp credentials..."
          echo "$CLASPRC_JSON" > ~/.clasprc.json

          echo "ðŸš€ Deploying to Apps Script..."
          npx clasp push --force

          echo "ðŸ“¦ Updating deployment..."
          # Check if we have a deployment ID to update
          if [ -n "$DEPLOYMENT_ID" ]; then
            echo "Updating existing deployment: $DEPLOYMENT_ID"
            DEPLOY_OUTPUT=$(npx clasp deploy -i "$DEPLOYMENT_ID" -d "Stage 1 Deploy $(date -Iseconds)" 2>&1)
          else
            echo "Creating new deployment (no DEPLOYMENT_ID secret set)"
            DEPLOY_OUTPUT=$(npx clasp deploy -d "Stage 1 Deploy $(date -Iseconds)" 2>&1)
          fi

          echo "$DEPLOY_OUTPUT"
          VERSION_ID=$(echo "$DEPLOY_OUTPUT" | grep -oP 'Created version \K\d+' || echo "$DEPLOY_OUTPUT" | grep -oP 'Updated deployment \K\w+' || echo "unknown")

          # Get the deployment ID and construct the web app URL
          echo "ðŸ“‹ Fetching deployment URL..."
          DEPLOYMENTS_OUTPUT=$(npx clasp deployments 2>&1)
          echo "$DEPLOYMENTS_OUTPUT"

          # Extract deployment ID from the deploy output first
          DEPLOYMENT_ID_FROM_OUTPUT=$(echo "$DEPLOY_OUTPUT" | grep -oP 'AKfycb[a-zA-Z0-9_-]+' | head -1)

          # If not found in deploy output, try to get from deployments list
          if [ -z "$DEPLOYMENT_ID_FROM_OUTPUT" ]; then
            echo "Extracting deployment ID from deployments list..."
            DEPLOYMENT_ID_FROM_OUTPUT=$(echo "$DEPLOYMENTS_OUTPUT" | grep -oP 'AKfycb[a-zA-Z0-9_-]+' | head -1)
          fi

          # Construct the Web App URL from the deployment ID
          if [ -n "$DEPLOYMENT_ID_FROM_OUTPUT" ]; then
            WEB_APP_URL="https://script.google.com/macros/s/${DEPLOYMENT_ID_FROM_OUTPUT}/exec"
            echo "âœ… Found deployment ID: ${DEPLOYMENT_ID_FROM_OUTPUT}"
          else
            echo "âš ï¸ Warning: Could not extract deployment ID from deployments"
            echo "Please check clasp deployments manually"
            exit 1
          fi

          echo "url=$WEB_APP_URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployment complete! Base URL: $WEB_APP_URL"

      - name: Generate tenant URLs
        id: urls
        run: |
          BASE_URL="${{ steps.deploy.outputs.url }}"

          # Generate tenant-specific URLs
          ROOT_URL="${BASE_URL}?p=events&tenant=root"
          ABC_URL="${BASE_URL}?p=events&tenant=abc"
          CBC_URL="${BASE_URL}?p=events&tenant=cbc"

          echo "root_url=$ROOT_URL" >> $GITHUB_OUTPUT
          echo "abc_url=$ABC_URL" >> $GITHUB_OUTPUT
          echo "cbc_url=$CBC_URL" >> $GITHUB_OUTPUT

          echo ""
          echo "=============================================="
          echo "ðŸ“‹ DEPLOYMENT URLS - READY FOR TESTING"
          echo "=============================================="
          echo ""
          echo "Base URL:"
          echo "$BASE_URL"
          echo ""
          echo "Tenant-specific test URLs:"
          echo ""
          echo "ðŸŽ¯ ROOT tenant:"
          echo "$ROOT_URL"
          echo ""
          echo "ðŸŽ¯ ABC tenant:"
          echo "$ABC_URL"
          echo ""
          echo "ðŸŽ¯ CBC tenant:"
          echo "$CBC_URL"
          echo ""
          echo "=============================================="
          echo "ðŸ’¡ Full clickable URLs available in Job Summary below"
          echo "=============================================="
          echo ""

      - name: Save deployment URL for Stage 2
        run: |
          mkdir -p deployment-info
          echo "${{ steps.deploy.outputs.url }}" > deployment-info/deployment-url.txt
          echo "âœ… Saved deployment URL for Stage 2 auto-trigger"

      - name: Upload deployment info artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info
          path: deployment-info/deployment-url.txt
          retention-days: 1

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Stage 1 Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Contract Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŒ Deployment URLs (Full & Unmasked)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** URLs may appear masked (***) in console logs due to GitHub's automatic secret detection, but the full URLs are displayed here for testing and record-keeping." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Base Deployment URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tenant-Specific Test URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Click any URL below to test directly in your browser:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tenant | Test URL |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ **ROOT** | [${{ steps.urls.outputs.root_url }}](${{ steps.urls.outputs.root_url }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ **ABC** | [${{ steps.urls.outputs.abc_url }}](${{ steps.urls.outputs.abc_url }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ **CBC** | [${{ steps.urls.outputs.cbc_url }}](${{ steps.urls.outputs.cbc_url }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Copy-Paste URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ROOT:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.urls.outputs.root_url }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ABC:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.urls.outputs.abc_url }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CBC:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.urls.outputs.cbc_url }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ¤– **Stage 2 will auto-trigger in a few seconds!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Process 3: Fast-Fail Progressive Testing**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Stage 1 Complete (Unit + Contract tests passed)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Stage 2 Starting automatically..." >> $GITHUB_STEP_SUMMARY
          echo "  - Newman API Tests" >> $GITHUB_STEP_SUMMARY
          echo "  - Playwright Tests (Parallel: Smoke + Flow + Page)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the **Actions** tab to monitor Stage 2 progress." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
