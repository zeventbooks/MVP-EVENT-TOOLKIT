name: Stage 1 - Build & Deploy

on:
  push:
    branches:
      - main           # Deploy on main push (after PR merge)
      - 'release/**'   # Deploy on release branches
      - 'release/*'
  pull_request:
    branches: [ main ]  # Validate PRs before merge

# Prevent duplicate runs: cancel in-progress runs for the same PR/branch
concurrency:
  group: stage1-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # STAGE 1: BUILD, TEST & DEPLOY
  # ============================================================================
  # Local equivalent: npm run test:ci:stage1
  # Runs: lint && test:unit && test:contract
  # Stage 1 red â†’ DO NOT DEPLOY
  # ============================================================================

  lint:
    name: ðŸ” Code Quality (ESLint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: |
          echo "ðŸ” Running ESLint to check code quality..."
          npm run lint
          echo "âœ… Linting passed! Code quality verified."

  unit-tests:
    name: âœ… Unit Tests (MVP Gate)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: |
          echo "â„¹ï¸ Running Jest unit tests (MVP Gate)"
          echo "ðŸ“‹ MVP Unit Test Coverage:"
          echo "   - template-service.test.js (applyTemplateToEvent_, sections, CTAs)"
          echo "   - validation.test.js (event data validation)"
          echo "   - forms.test.js (form template management)"
          echo "   - sponsor-utils.test.js (sponsor utilities)"
          echo "   - shared-reporting.test.js (analytics)"
          echo "   - security.test.js (auth, XSS, CSRF)"
          echo "   - multi-brand.test.js (brand isolation)"
          npm run test:unit

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info

  mvp-guards:
    name: ðŸ›¡ï¸ MVP Guards (Surface + Dead Export + V2 Files)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run MVP Surface Check
        run: |
          echo "ðŸ” Checking MVP surfaces..."
          echo "   Only 5 MVP surfaces allowed: admin, public, display, poster, report"
          echo ""
          node scripts/check-surfaces.js

      - name: Run Dead Export Check
        run: |
          echo "ðŸ” Checking for dead/zombie exports in Code.gs..."
          echo "   Unused api_* functions will fail the build"
          echo ""
          node scripts/check-dead-code.js --fail-on-dead

      - name: Run V2 File Check
        run: |
          echo "ðŸ” Checking for V2 files in src/mvp..."
          echo "   No V2 files allowed in MVP directory"
          echo ""
          node scripts/check-v2-files.js

  contract-tests:
    name: ðŸ“‹ Contract Tests (Schema Gate)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run contract tests
        run: |
          echo "â„¹ï¸ Running contract tests (validates API response structure & schema consistency)"
          echo ""
          echo "ðŸ“‹ Contract Test Coverage:"
          echo "   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "   ðŸ”’ SCHEMA CONSISTENCY (MVP Gate):"
          echo "      - schema-consistency.contract.test.js"
          echo "        â†’ Validates JSON schemas match ApiSchemas.gs"
          echo "        â†’ Validates Settings includes all template toggles"
          echo "        â†’ Cross-schema consistency (enums, surfaces)"
          echo ""
          echo "   ðŸ“„ TEMPLATE VALIDATION:"
          echo "      - template-flows.contract.test.js"
          echo "        â†’ Uses shared fixtures (templates.fixtures.js)"
          echo "        â†’ Custom template full schema access"
          echo "        â†’ Template â†’ Settings mapping"
          echo ""
          echo "   ðŸ”— API CONTRACTS:"
          echo "      - api.contract.test.js"
          echo "      - bundles.contract.test.js"
          echo "      - all-endpoints.contract.test.js"
          echo "      - jwt-security.contract.test.js"
          echo "   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          npm run test:contract

      - name: Verify schema consistency tests ran
        run: |
          echo "ðŸ” Verifying schema consistency tests exist and ran..."

          # Check that the schema consistency test file exists
          if [ ! -f "tests/contract/schema-consistency.contract.test.js" ]; then
            echo "âŒ ERROR: schema-consistency.contract.test.js not found!"
            echo "   This file is required to prevent schema drift."
            exit 1
          fi

          # Check that templates fixtures exist
          if [ ! -f "tests/shared/fixtures/templates.fixtures.js" ]; then
            echo "âŒ ERROR: templates.fixtures.js not found!"
            echo "   This file is required for template validation."
            exit 1
          fi

          echo "âœ… Schema consistency tests verified"
          echo "âœ… Template fixtures verified"

  # ============================================================================
  # CI:ALL GATE - Mandatory pre-deploy validation
  # ============================================================================
  # This job runs npm run ci:all which executes all contract guards:
  #   1. MVP Surfaces (check-surfaces.js)
  #   2. RPC Inventory (check-rpc-inventory.js)
  #   3. API vs Schemas (check-apis-vs-schemas.js)
  #   4. Event Schema (test-event-schema.js)
  #   5. Service Tests (test-services.js)
  #   6. Dead Exports (check-dead-code.js)
  #   7. Schema Fields (check-schema-fields.js)
  #   8. Analytics Schema (test-analytics-schema.js)
  # ============================================================================

  ci-all-gate:
    name: ðŸš¦ CI:ALL Gate (Pre-Deploy)
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, contract-tests, mvp-guards]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run CI:ALL Gate
        run: |
          echo "ðŸš¦ Running ci:all - Mandatory pre-deploy gate"
          echo ""
          echo "This gate runs ALL contract guards. Deployment is blocked if any fail."
          echo ""
          npm run ci:all

      - name: Create gate summary
        if: always()
        run: |
          echo "## ðŸš¦ CI:ALL Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… GATE PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All contract guards passed. Deployment may proceed." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ GATE FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more contract guards failed. **Deployment blocked.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run locally: \`npm run ci:all:verbose\`" >> $GITHUB_STEP_SUMMARY
          fi

  deploy-to-apps-script:
    name: ðŸš€ Deploy to Apps Script API
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, contract-tests, mvp-guards, ci-all-gate]
    # MVP SRE Policy: Deploy only if Stage 1 passes AND push to main/release branches
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/'))
    outputs:
      deployment_url: ${{ steps.deploy.outputs.url }}
      root_url: ${{ steps.urls.outputs.root_url }}
      abc_url: ${{ steps.urls.outputs.abc_url }}
      cbc_url: ${{ steps.urls.outputs.cbc_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate deployment secrets
        env:
          CLASPRC_JSON: ${{ secrets.OAUTH_CREDENTIALS }}
        run: |
          echo "ðŸ” Validating deployment secrets..."

          # Check if OAUTH_CREDENTIALS is set
          if [ -z "$CLASPRC_JSON" ]; then
            echo "âŒ ERROR: OAUTH_CREDENTIALS secret not set"
            echo "Please configure the OAUTH_CREDENTIALS secret in GitHub repository settings"
            exit 1
          fi

          # Validate JSON structure
          if ! echo "$CLASPRC_JSON" | jq -e '.token.access_token' > /dev/null 2>&1; then
            echo "âŒ ERROR: Invalid OAUTH_CREDENTIALS format"
            echo "Expected JSON with .token.access_token field"
            exit 1
          fi

          # Check if refresh_token exists (required for token refresh)
          if ! echo "$CLASPRC_JSON" | jq -e '.token.refresh_token' > /dev/null 2>&1; then
            echo "âŒ ERROR: No refresh_token found in OAUTH_CREDENTIALS"
            echo "The refresh_token is required for clasp to refresh expired access tokens."
            echo ""
            echo "ðŸ“– To fix this, regenerate credentials with full scopes:"
            echo "   npx clasp login --no-localhost"
            echo "   cat ~/.clasprc.json"
            echo "   Then update the OAUTH_CREDENTIALS secret in GitHub"
            exit 1
          fi

          # Check token expiry if expiry_date is present
          EXPIRY_DATE=$(echo "$CLASPRC_JSON" | jq -r '.token.expiry_date // empty' 2>/dev/null)
          if [ -n "$EXPIRY_DATE" ]; then
            CURRENT_TIME=$(date +%s)000  # Current time in milliseconds
            if [ "$EXPIRY_DATE" -lt "$CURRENT_TIME" ]; then
              echo "âš ï¸  WARNING: Access token appears to be expired"
              echo "   Expiry: $EXPIRY_DATE, Current: $CURRENT_TIME"
              echo "   clasp should refresh the token using the refresh_token"
            fi
          fi

          echo "âœ… Secrets validation passed"

      # NOTE: Version cleanup removed - Google Apps Script API does not support
      # deleting versions. The DELETE endpoint does not exist for projects.versions.
      # Versions can only be deleted manually via the Apps Script UI.
      # See: https://developers.google.com/apps-script/api/reference/rest/v1/projects.versions

      - name: Deploy to Apps Script via clasp
        id: deploy
        env:
          CLASPRC_JSON: ${{ secrets.OAUTH_CREDENTIALS }}
          DEPLOYMENT_ID: ${{ secrets.DEPLOYMENT_ID }}
        run: |
          echo "ðŸ” Setting up clasp credentials..."
          echo "$CLASPRC_JSON" > ~/.clasprc.json
          chmod 600 ~/.clasprc.json

          echo "ðŸ” Pre-flight check: Verifying script access..."
          # Use 'clasp list' to verify authentication - this actually calls the API
          # Unlike 'clasp status' which only checks local files
          echo "   Testing API authentication with 'clasp list'..."
          if ! LIST_OUTPUT=$(npx clasp list 2>&1); then
            echo "âŒ ERROR: Cannot authenticate with Google Apps Script API"
            echo ""
            echo "ðŸ“‹ clasp list output:"
            echo "$LIST_OUTPUT"
            echo ""
            echo "ðŸ“‹ Diagnostic information:"
            echo "   Script ID from .clasp.json: $(cat .clasp.json | jq -r '.scriptId' 2>/dev/null || echo 'could not read')"
            echo ""
            echo "ðŸ”§ Possible fixes:"
            echo "   1. OAuth token may have expired - regenerate OAUTH_CREDENTIALS secret"
            echo "   2. Script access may have been revoked - check Google Apps Script permissions"
            echo "   3. The refresh_token may have been invalidated"
            echo ""
            echo "ðŸ“– To regenerate credentials locally:"
            echo "   npx clasp login"
            echo "   cat ~/.clasprc.json"
            echo "   Then update the OAUTH_CREDENTIALS secret in GitHub"
            exit 1
          fi

          # Also check for error messages in the output (clasp sometimes exits 0 but shows errors)
          if echo "$LIST_OUTPUT" | grep -qiE "(error|unauthorized|invalid.*token|access.*denied)"; then
            echo "âŒ ERROR: Authentication issue detected in clasp output"
            echo ""
            echo "ðŸ“‹ clasp list output:"
            echo "$LIST_OUTPUT"
            echo ""
            echo "ðŸ“– To regenerate credentials:"
            echo "   npx clasp login"
            echo "   cat ~/.clasprc.json"
            echo "   Then update the OAUTH_CREDENTIALS secret in GitHub"
            exit 1
          fi

          echo "   Found $(echo "$LIST_OUTPUT" | wc -l) scripts accessible"
          echo "âœ… Script access verified"

          echo "ðŸš€ Deploying to Apps Script..."
          # Capture both stdout and stderr for better error reporting
          if ! PUSH_OUTPUT=$(npx clasp push --force 2>&1); then
            echo "âŒ ERROR: clasp push failed"
            echo ""
            echo "ðŸ“‹ clasp push output:"
            echo "$PUSH_OUTPUT"
            echo ""
            echo "ðŸ“‹ Additional diagnostics:"
            echo "   Checking .clasp.json configuration..."
            cat .clasp.json 2>/dev/null || echo "   Could not read .clasp.json"
            echo ""
            echo "   Files being pushed:"
            ls -la src/mvp/*.gs src/mvp/*.html 2>/dev/null | head -20 || echo "   Could not list files"
            echo ""
            echo "ðŸ”§ Common causes:"
            echo "   1. Syntax error in .gs or .html files"
            echo "   2. File size exceeds Apps Script limits (50KB per file)"
            echo "   3. OAuth token expired mid-operation"
            echo "   4. Google Apps Script API rate limiting"
            echo "   5. Invalid scriptId in .clasp.json"
            echo "   6. Missing spreadsheetId for bound scripts"
            exit 1
          fi
          echo "$PUSH_OUTPUT"
          echo "âœ… Push successful"

          echo "ðŸ“¦ Updating deployment..."
          # Check if we have a deployment ID to update
          DEPLOY_FAILED=false
          if [ -n "$DEPLOYMENT_ID" ]; then
            echo "Updating existing deployment: $DEPLOYMENT_ID"
            if ! DEPLOY_OUTPUT=$(npx clasp deploy -i "$DEPLOYMENT_ID" -d "Stage 1 Deploy $(date -Iseconds)" 2>&1); then
              DEPLOY_FAILED=true
            fi
          else
            echo "Creating new deployment (no DEPLOYMENT_ID secret set)"
            if ! DEPLOY_OUTPUT=$(npx clasp deploy -d "Stage 1 Deploy $(date -Iseconds)" 2>&1); then
              DEPLOY_FAILED=true
            fi
          fi

          echo "$DEPLOY_OUTPUT"

          if [ "$DEPLOY_FAILED" = true ]; then
            echo "âŒ ERROR: clasp deploy failed"
            echo ""
            echo "ðŸ“‹ Deploy output:"
            echo "$DEPLOY_OUTPUT"
            echo ""
            echo "ðŸ“‹ Listing current deployments for diagnostics..."
            npx clasp deployments 2>&1 || echo "   Could not list deployments"
            echo ""
            echo "ðŸ”§ Possible causes:"
            echo "   1. Invalid deployment ID - check DEPLOYMENT_ID secret"
            echo "   2. Deployment quota exceeded (max 20 deployments)"
            echo "   3. OAuth token issues"
            echo "   4. Version limit reached (max 200 versions)"
            exit 1
          fi

          VERSION_ID=$(echo "$DEPLOY_OUTPUT" | grep -oP 'Created version \K\d+' || echo "$DEPLOY_OUTPUT" | grep -oP 'Updated deployment \K\w+' || echo "unknown")

          # Get the deployment ID and construct the web app URL
          echo "ðŸ“‹ Fetching deployment URL..."
          DEPLOYMENTS_OUTPUT=$(npx clasp deployments 2>&1)
          echo "$DEPLOYMENTS_OUTPUT"

          # Extract deployment ID from the deploy output first
          DEPLOYMENT_ID_FROM_OUTPUT=$(echo "$DEPLOY_OUTPUT" | grep -oP 'AKfycb[a-zA-Z0-9_-]+' | head -1)

          # If not found in deploy output, try to get from deployments list
          if [ -z "$DEPLOYMENT_ID_FROM_OUTPUT" ]; then
            echo "Extracting deployment ID from deployments list..."
            DEPLOYMENT_ID_FROM_OUTPUT=$(echo "$DEPLOYMENTS_OUTPUT" | grep -oP 'AKfycb[a-zA-Z0-9_-]+' | head -1)
          fi

          # Construct the Web App URL from the deployment ID
          if [ -n "$DEPLOYMENT_ID_FROM_OUTPUT" ]; then
            WEB_APP_URL="https://script.google.com/macros/s/${DEPLOYMENT_ID_FROM_OUTPUT}/exec"
            echo "âœ… Found deployment ID: ${DEPLOYMENT_ID_FROM_OUTPUT}"
          else
            echo "âš ï¸ Warning: Could not extract deployment ID from deployments"
            echo "Please check clasp deployments manually"
            exit 1
          fi

          echo "url=$WEB_APP_URL" >> $GITHUB_OUTPUT
          echo "deployment_id=$DEPLOYMENT_ID_FROM_OUTPUT" >> $GITHUB_OUTPUT
          echo "âœ… Deployment complete! Base URL: $WEB_APP_URL"

      - name: Update Cloudflare Worker (Optional)
        if: success()
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DEPLOYMENT_ID: ${{ steps.deploy.outputs.deployment_id }}
        run: |
          echo "â˜ï¸ Checking Cloudflare Worker configuration..."

          # Check if Cloudflare secrets are configured
          if [ -z "$CLOUDFLARE_API_TOKEN" ] || [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "â„¹ï¸ Cloudflare secrets not configured - skipping Worker update"
            echo "   To enable Cloudflare Workers, add these secrets:"
            echo "   - CLOUDFLARE_API_TOKEN"
            echo "   - CLOUDFLARE_ACCOUNT_ID"
            echo ""
            echo "   See: cloudflare-proxy/CLOUDFLARE_SETUP.md"
            exit 0
          fi

          echo "ðŸ”„ Updating Cloudflare Worker with new deployment ID..."

          # Update wrangler.toml with new deployment ID
          sed -i "s/DEPLOYMENT_ID = \"[^\"]*\"/DEPLOYMENT_ID = \"${DEPLOYMENT_ID}\"/" cloudflare-proxy/wrangler.toml

          # Also update the worker.js default
          sed -i "s/const DEFAULT_DEPLOYMENT_ID = '[^']*'/const DEFAULT_DEPLOYMENT_ID = '${DEPLOYMENT_ID}'/" cloudflare-proxy/worker.js

          # Install and deploy with Wrangler
          npm install -g wrangler

          cd cloudflare-proxy
          wrangler deploy

          echo ""
          echo "âœ… Cloudflare Worker updated!"
          echo "ðŸ”— Worker URL: https://eventangle.workers.dev/status"

      - name: Generate comprehensive brand URLs
        id: urls
        run: |
          APPS_SCRIPT_BASE="${{ steps.deploy.outputs.url }}"
          CLOUDFLARE_BASE="https://eventangle.com"

          # Brands: root, abc, cbc, cbl
          BRANDS=("root" "abc" "cbc" "cbl")

          # Friendly URL aliases (maps to pages internally)
          # events -> public page, manage -> admin page, etc.
          ALIASES=("status" "manage" "events" "display")

          echo ""
          echo "=============================================="
          echo "ðŸ“‹ DEPLOYMENT URLS - READY FOR TESTING"
          echo "=============================================="
          echo ""
          echo "ðŸš€ Apps Script Base URL:"
          echo "$APPS_SCRIPT_BASE"
          echo ""
          echo "ðŸŒ Cloudflare Base URL:"
          echo "$CLOUDFLARE_BASE"
          echo ""
          echo "=============================================="
          echo ""

          # Generate friendly URLs for each brand
          for brand in "${BRANDS[@]}"; do
            echo "ðŸŽ¯ Brand: ${brand^^}"
            echo "----------------------------------------"
            for alias in "${ALIASES[@]}"; do
              # Friendly URL format: /{alias} for root, /{brand}/{alias} for others
              if [ "$brand" == "root" ]; then
                FRIENDLY_PATH="/${alias}"
              else
                FRIENDLY_PATH="/${brand}/${alias}"
              fi

              APPS_URL="${APPS_SCRIPT_BASE}${FRIENDLY_PATH}"
              CF_URL="${CLOUDFLARE_BASE}${FRIENDLY_PATH}"

              echo "  ${alias}:"
              echo "    Apps Script: $APPS_URL"
              echo "    Cloudflare:  $CF_URL"
            done
            echo ""
          done

          echo "=============================================="
          echo "ðŸ’¡ Full clickable URLs available in Job Summary below"
          echo "=============================================="
          echo ""

          # Save primary URLs for backward compatibility with Stage 2
          echo "root_url=${APPS_SCRIPT_BASE}/events" >> $GITHUB_OUTPUT
          echo "abc_url=${APPS_SCRIPT_BASE}/abc/events" >> $GITHUB_OUTPUT
          echo "cbc_url=${APPS_SCRIPT_BASE}/cbc/events" >> $GITHUB_OUTPUT
          echo "cbl_url=${APPS_SCRIPT_BASE}/cbl/events" >> $GITHUB_OUTPUT

      - name: Save deployment URL for Stage 2
        run: |
          mkdir -p deployment-info
          # Use the Cloudflare friendly URL for Stage 2 testing
          # This ensures tests run against the production-ready endpoint
          CLOUDFLARE_URL="https://eventangle.com"
          echo "$CLOUDFLARE_URL" > deployment-info/deployment-url.txt
          echo "âœ… Saved Cloudflare URL for Stage 2 auto-trigger: $CLOUDFLARE_URL"
          echo ""
          echo "ðŸ“‹ Stage 2 will test against: $CLOUDFLARE_URL"
          echo "   (Apps Script URL also available: ${{ steps.deploy.outputs.url }})"

      - name: Upload deployment info artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info
          path: deployment-info/deployment-url.txt
          retention-days: 1

      - name: Create comprehensive deployment summary
        run: |
          APPS_SCRIPT_BASE="${{ steps.deploy.outputs.url }}"
          CLOUDFLARE_BASE="https://eventangle.com"

          echo "## ðŸš€ Stage 1 Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Quality Gates Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality (ESLint)" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests (Jest)" >> $GITHUB_STEP_SUMMARY
          echo "- Contract Tests" >> $GITHUB_STEP_SUMMARY
          echo "- MVP Guards (Surfaces + Dead Exports + V2 Files)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŒ Comprehensive Test URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** Test both Apps Script and Cloudflare URLs to verify which works best for your use case." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Base Deployment URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Base URL |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ **Apps Script** | \`${APPS_SCRIPT_BASE}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ **Cloudflare** | \`${CLOUDFLARE_BASE}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Generate comprehensive URL tables for each brand
          BRANDS=("root" "abc" "cbc" "cbl")
          BRAND_NAMES=("ROOT (Eventangle)" "ABC (American Bocce Co.)" "CBC (Chicago Bocce Club)" "CBL (Chicago Bocce League)")

          for i in "${!BRANDS[@]}"; do
            brand="${BRANDS[$i]}"
            brand_name="${BRAND_NAMES[$i]}"

            # Build brand prefix for friendly URLs
            if [ "$brand" == "root" ]; then
              PREFIX=""
            else
              PREFIX="/${brand}"
            fi

            echo "### ðŸŽ¯ Brand: ${brand_name}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Page | Apps Script URL | Cloudflare URL |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-----------------|---------------|" >> $GITHUB_STEP_SUMMARY

            # Status (friendly URL: /status or /{brand}/status)
            echo "| ðŸ” **Status** | [Test](${APPS_SCRIPT_BASE}${PREFIX}/status) | [Test](${CLOUDFLARE_BASE}${PREFIX}/status) |" >> $GITHUB_STEP_SUMMARY

            # Manage/Admin (friendly URL: /manage or /{brand}/manage)
            echo "| âš™ï¸ **Manage** | [Test](${APPS_SCRIPT_BASE}${PREFIX}/manage) | [Test](${CLOUDFLARE_BASE}${PREFIX}/manage) |" >> $GITHUB_STEP_SUMMARY

            # Events (friendly URL: /events or /{brand}/events)
            echo "| ðŸ“… **Events** | [Test](${APPS_SCRIPT_BASE}${PREFIX}/events) | [Test](${CLOUDFLARE_BASE}${PREFIX}/events) |" >> $GITHUB_STEP_SUMMARY

            # Display (friendly URL: /display or /{brand}/display)
            echo "| ðŸ“º **Display** | [Test](${APPS_SCRIPT_BASE}${PREFIX}/display) | [Test](${CLOUDFLARE_BASE}${PREFIX}/display) |" >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
          done

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Testing Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Status Page** (\`/status\`): Verify API health and connectivity" >> $GITHUB_STEP_SUMMARY
          echo "2. **Manage Page** (\`/manage\`): Test event management interface (requires admin key)" >> $GITHUB_STEP_SUMMARY
          echo "3. **Events Page** (\`/events\`): Test public event listing" >> $GITHUB_STEP_SUMMARY
          echo "4. **Display Page** (\`/display\`): Test TV/kiosk display mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Next Step**: Stage 2 will automatically run Playwright tests against these URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Quick Copy-Paste URLs (Friendly URLs)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Apps Script - Status Endpoints (API Health)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}/status" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}/abc/status" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}/cbc/status" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}/cbl/status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Cloudflare - Status Endpoints (API Health)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${CLOUDFLARE_BASE}/status" >> $GITHUB_STEP_SUMMARY
          echo "${CLOUDFLARE_BASE}/abc/status" >> $GITHUB_STEP_SUMMARY
          echo "${CLOUDFLARE_BASE}/cbc/status" >> $GITHUB_STEP_SUMMARY
          echo "${CLOUDFLARE_BASE}/cbl/status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Apps Script - Manage Pages (Event Management)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}/manage" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}/abc/manage" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}/cbc/manage" >> $GITHUB_STEP_SUMMARY
          echo "${APPS_SCRIPT_BASE}/cbl/manage" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Cloudflare - Manage Pages (Event Management)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${CLOUDFLARE_BASE}/manage" >> $GITHUB_STEP_SUMMARY
          echo "${CLOUDFLARE_BASE}/abc/manage" >> $GITHUB_STEP_SUMMARY
          echo "${CLOUDFLARE_BASE}/cbc/manage" >> $GITHUB_STEP_SUMMARY
          echo "${CLOUDFLARE_BASE}/cbl/manage" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ¤– **Stage 2 will auto-trigger in a few seconds!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cost-Optimized Progressive Testing Strategy:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Stage 1 Complete (ESLint + Jest Unit + Contract tests passed)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Stage 2 Starting automatically..." >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸ”¥ **Critical Tests** (run first):" >> $GITHUB_STEP_SUMMARY
          echo "    - Playwright API Tests (validates REST endpoints)" >> $GITHUB_STEP_SUMMARY
          echo "    - Playwright Smoke Tests (validates critical user paths)" >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸš¦ **Failure Gate**: Calculate failure rate" >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸ’° **Expensive Tests** (only if failure rate < 50%):" >> $GITHUB_STEP_SUMMARY
          echo "    - Playwright Flow Tests (multi-step user workflows)" >> $GITHUB_STEP_SUMMARY
          echo "    - Playwright Page Tests (comprehensive page validation)" >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸŽ¯ **Quality Gate**: All tests must pass" >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸš€ **QA Deployment**: Deploy to QA environment if approved" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the **Actions** tab to monitor Stage 2 progress." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
