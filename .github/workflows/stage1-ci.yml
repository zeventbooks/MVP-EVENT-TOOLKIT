# Stage-1 CI: Validate + Build + Deploy (Staging)
#
# EPIC 5 - Story 5.1: Stage-1 Staging-First Pipeline
#
# Purpose / Value:
#   Every main branch change passes a real, predictable path into staging.
#   No more random GAS deploys - the pipeline owns clones and deploys.
#
# Flow:
#   1. Checkout + Install
#   2. Lint / Format Check
#   3. Unit Tests (parallel with Contract Tests)
#   4. Contract Tests (parallel with Unit Tests)
#   5. Sheets Connectivity Test
#   6. Template Bundle Check
#   7. Build Worker (wrangler build)
#   8. Deploy to Staging (wrangler deploy --env staging)
#
# Acceptance Criteria:
#   - If any job fails â†’ no deploy
#   - On success, stg.eventangle.com is updated using the built worker
#   - PR validation runs without deployment
#   - Push to main triggers full pipeline with deployment
#
# Negative Paths:
#   - Misconfigured secrets â†’ pipeline fails with clear error logs
#   - Template bundling fails â†’ deployment blocked
#
# Required Secrets:
#   - CLOUDFLARE_API_TOKEN: Cloudflare API token for Worker deployment
#   - GOOGLE_CLIENT_EMAIL: Service account email for Sheets connectivity
#   - GOOGLE_PRIVATE_KEY: Service account private key (PEM format)
#   - SHEETS_SPREADSHEET_ID: Staging spreadsheet ID for connectivity test
#
# Rollback:
#   - Use: npm run rollback:staging
#   - Or: wrangler rollback --env staging
#   - See: docs/ROLLBACK.md

name: Stage-1 CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_deploy:
        description: 'Skip deployment (validation only)'
        required: false
        default: 'false'
        type: boolean
      force_deploy:
        description: 'Force deployment even on PR (use with caution)'
        required: false
        default: 'false'
        type: boolean

# Prevent duplicate runs: cancel in-progress runs for the same branch
concurrency:
  group: stage1-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  STG_BASE_URL: 'https://stg.eventangle.com'

jobs:
  # ==========================================================================
  # JOB 1: CHECKOUT + INSTALL
  # ==========================================================================
  # Checkout code and install dependencies, cached for subsequent jobs
  # ==========================================================================
  install:
    name: ðŸ“¦ Checkout + Install
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

  # ==========================================================================
  # JOB 2: LINT / FORMAT CHECK
  # ==========================================================================
  # ESLint code quality validation
  # ==========================================================================
  lint:
    name: ðŸ” Lint / Format Check
    runs-on: ubuntu-latest
    needs: [install]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies (fallback)
        run: npm ci
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Run ESLint
        run: |
          echo "=================================================="
          echo "STAGE-1: LINT / FORMAT CHECK"
          echo "=================================================="
          npm run lint

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ” Lint / Format Check" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm run lint\` locally to see details." >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================================================
  # JOB 3: UNIT TESTS
  # ==========================================================================
  # Jest unit tests with coverage threshold
  # ==========================================================================
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: [lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies (fallback)
        run: npm ci
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Run unit tests
        run: |
          echo "=================================================="
          echo "STAGE-1: UNIT TESTS"
          echo "=================================================="
          npm run test:unit

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ§ª Unit Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm run test:unit\` locally to debug." >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================================================
  # JOB 4: CONTRACT TESTS (API Shapes)
  # ==========================================================================
  # Schema, API contract, and bundle validation tests
  # ==========================================================================
  contract-tests:
    name: ðŸ“œ Contract Tests
    runs-on: ubuntu-latest
    needs: [lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies (fallback)
        run: npm ci
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Run contract tests
        run: |
          echo "=================================================="
          echo "STAGE-1: CONTRACT TESTS (API Shapes)"
          echo "=================================================="
          npm run test:contract

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ“œ Contract Tests (API Shapes)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… PASSED" >> $GITHUB_STEP_SUMMARY
            echo "API response schemas validated against v4.1.2 contract." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm run test:contract\` locally to debug." >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================================================
  # JOB 5: SHEETS CONNECTIVITY TEST
  # ==========================================================================
  # Story 1.1: Verify service account can read/write to Google Sheets
  # ==========================================================================
  sheets-connectivity:
    name: ðŸ“Š Sheets Connectivity Test
    runs-on: ubuntu-latest
    needs: [lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies (fallback)
        run: npm ci
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Validate Sheets secrets
        run: |
          echo "=================================================="
          echo "STAGE-1: VALIDATING SHEETS SECRETS"
          echo "=================================================="

          ERRORS=0

          if [ -z "${{ secrets.GOOGLE_CLIENT_EMAIL }}" ]; then
            echo "::error::Missing required secret: GOOGLE_CLIENT_EMAIL"
            echo "  Configure in: Settings â†’ Secrets â†’ Actions â†’ New repository secret"
            echo "  Value: Service account email (e.g., worker@project.iam.gserviceaccount.com)"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ“ GOOGLE_CLIENT_EMAIL is set"
          fi

          if [ -z "${{ secrets.GOOGLE_PRIVATE_KEY }}" ]; then
            echo "::error::Missing required secret: GOOGLE_PRIVATE_KEY"
            echo "  Configure in: Settings â†’ Secrets â†’ Actions â†’ New repository secret"
            echo "  Value: Service account private key (full PEM content including headers)"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ“ GOOGLE_PRIVATE_KEY is set"
          fi

          if [ -z "${{ secrets.SHEETS_SPREADSHEET_ID }}" ]; then
            echo "::error::Missing required secret: SHEETS_SPREADSHEET_ID"
            echo "  Configure in: Settings â†’ Secrets â†’ Actions â†’ New repository secret"
            echo "  Value: Google Sheets spreadsheet ID for staging"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ“ SHEETS_SPREADSHEET_ID is set"
          fi

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "::error::$ERRORS required secret(s) missing. See: docs/env/GOOGLE_SERVICE_ACCOUNT_SETUP.md"
            exit 1
          fi

          echo ""
          echo "All required Sheets secrets are configured."

      - name: Run Sheets connectivity test
        env:
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          SHEETS_SPREADSHEET_ID: ${{ secrets.SHEETS_SPREADSHEET_ID }}
        run: |
          echo "=================================================="
          echo "STAGE-1: SHEETS CONNECTIVITY TEST"
          echo "=================================================="
          npm run test:story1.1

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ“Š Sheets Connectivity Test" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… PASSED" >> $GITHUB_STEP_SUMMARY
            echo "Service account successfully authenticated and read/write verified." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Check secrets configuration in GitHub Settings." >> $GITHUB_STEP_SUMMARY
            echo "See: \`docs/env/GOOGLE_SERVICE_ACCOUNT_SETUP.md\`" >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================================================
  # JOB 6: TEMPLATE BUNDLE CHECK
  # ==========================================================================
  # Verify HTML templates can be bundled for Worker embedding
  # Story 5.1: Ensures templates are valid before deployment
  # ==========================================================================
  template-bundle:
    name: ðŸ“¦ Template Bundle Check
    runs-on: ubuntu-latest
    needs: [lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies (fallback)
        run: npm ci
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Verify template bundling
        run: |
          echo "=================================================="
          echo "STAGE-1: TEMPLATE BUNDLE CHECK"
          echo "=================================================="
          npm run bundle:templates:check

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ“¦ Template Bundle Check" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… PASSED" >> $GITHUB_STEP_SUMMARY
            echo "HTML templates validated and ready for bundling." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Template bundling failed. Check HTML template syntax." >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================================================
  # JOB 7: BUILD WORKER
  # ==========================================================================
  # Build the Cloudflare Worker using wrangler
  # ==========================================================================
  build-worker:
    name: ðŸ”¨ Build Worker
    runs-on: ubuntu-latest
    needs: [unit-tests, contract-tests, sheets-connectivity, template-bundle]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies (fallback)
        run: npm ci
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Install Wrangler
        run: npm install -g wrangler@3

      - name: Build Worker
        working-directory: cloudflare-proxy
        run: |
          echo "=================================================="
          echo "STAGE-1: BUILD WORKER"
          echo "=================================================="
          wrangler deploy --dry-run --outdir=dist --env staging
          echo ""
          echo "Worker build artifacts:"
          ls -la dist/ || echo "No dist directory (dry-run mode)"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: worker-build
          path: cloudflare-proxy/dist/
          retention-days: 1
          if-no-files-found: ignore

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ”¨ Build Worker" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… PASSED" >> $GITHUB_STEP_SUMMARY
            echo "Worker built successfully for staging environment." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Worker build failed. Check wrangler configuration." >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================================================
  # JOB 8: DEPLOY TO STAGING
  # ==========================================================================
  # Deploy the Worker to stg.eventangle.com
  # Only runs on push to main (not PRs) and if ALL previous jobs pass
  # ==========================================================================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-worker]
    # Deploy only on push to main, unless force_deploy is set or skip_deploy is set
    if: |
      github.event.inputs.skip_deploy != 'true' &&
      (github.event_name == 'push' || github.event.inputs.force_deploy == 'true')
    environment:
      name: staging
      url: https://stg.eventangle.com
    outputs:
      deployed: ${{ steps.deploy.outcome == 'success' }}
      deployment_time: ${{ steps.deploy.outputs.deployment_time }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies (fallback)
        run: npm ci
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Validate Cloudflare secrets
        run: |
          echo "=================================================="
          echo "STAGE-1: VALIDATING CLOUDFLARE SECRETS"
          echo "=================================================="

          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "::error::Missing required secret: CLOUDFLARE_API_TOKEN"
            echo "  Configure in: Settings â†’ Secrets â†’ Actions â†’ New repository secret"
            echo "  Value: Cloudflare API token with Workers deployment permissions"
            echo ""
            echo "  Required permissions:"
            echo "    - Account: Cloudflare Workers Scripts:Edit"
            echo "    - Zone: Zone:Read, DNS:Edit"
            exit 1
          fi

          echo "âœ“ CLOUDFLARE_API_TOKEN is set"

      - name: Install Wrangler
        run: npm install -g wrangler@3

      - name: Deploy Worker to Staging
        id: deploy
        working-directory: cloudflare-proxy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "=================================================="
          echo "STAGE-1: DEPLOYING TO STAGING"
          echo "=================================================="
          echo "Target: stg.eventangle.com"
          echo "Environment: staging"
          echo ""

          # Capture deployment time
          DEPLOY_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "deployment_time=$DEPLOY_TIME" >> $GITHUB_OUTPUT

          wrangler deploy --env staging

          echo ""
          echo "=================================================="
          echo "âœ… WORKER DEPLOYED TO STAGING"
          echo "=================================================="
          echo "URL: https://stg.eventangle.com"
          echo "Time: $DEPLOY_TIME"
          echo ""

      - name: Verify staging deployment
        run: |
          echo "=================================================="
          echo "VERIFYING STAGING DEPLOYMENT"
          echo "=================================================="

          # Wait for edge propagation
          sleep 10

          # Test /api/status endpoint
          echo "Testing /api/status endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" "${{ env.STG_BASE_URL }}/api/status" || echo "CURL_FAILED")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ“ /api/status returned HTTP 200"
            echo "Response: $BODY" | head -c 200
          else
            echo "::warning::Staging verification: /api/status returned HTTP $HTTP_CODE"
            echo "Response: $BODY"
          fi

          echo ""
          echo "Staging deployment complete."

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸš€ Deploy to Staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… DEPLOYED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Staging URL:** https://stg.eventangle.com" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The Worker has been deployed to the staging environment." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Deployment to staging failed. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create staging URL artifact
        run: |
          mkdir -p artifacts
          echo "https://stg.eventangle.com" > artifacts/stg-base-url.txt

      - name: Upload staging URL artifact
        uses: actions/upload-artifact@v4
        with:
          name: stg-base-url
          path: artifacts/stg-base-url.txt
          retention-days: 1

  # ==========================================================================
  # PIPELINE SUMMARY
  # ==========================================================================
  # Final job that creates an overall summary of the pipeline run
  # ==========================================================================
  pipeline-summary:
    name: ðŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, contract-tests, sheets-connectivity, template-bundle, build-worker, deploy-staging]
    if: always()

    steps:
      - name: Create pipeline summary
        run: |
          echo "# ðŸ”„ Stage-1 CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Story 5.1**: Stage-1: Validate + Build + Deploy (Staging)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Lint / Format Check | ${{ needs.lint.result == 'success' && 'âœ… Passed' || needs.lint.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ… Passed' || needs.unit-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“œ Contract Tests | ${{ needs.contract-tests.result == 'success' && 'âœ… Passed' || needs.contract-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Sheets Connectivity | ${{ needs.sheets-connectivity.result == 'success' && 'âœ… Passed' || needs.sheets-connectivity.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Template Bundle | ${{ needs.template-bundle.result == 'success' && 'âœ… Passed' || needs.template-bundle.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¨ Build Worker | ${{ needs.build-worker.result == 'success' && 'âœ… Passed' || needs.build-worker.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Deploy to Staging | ${{ needs.deploy-staging.result == 'success' && 'âœ… Deployed' || needs.deploy-staging.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ needs.deploy-staging.result }}" == "success" ]; then
            echo "## âœ… Pipeline Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Staging URL:** https://stg.eventangle.com" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Rollback" >> $GITHUB_STEP_SUMMARY
            echo "If issues are found, rollback with:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "npm run rollback:staging" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.lint.result }}" != "success" ] || \
               [ "${{ needs.unit-tests.result }}" != "success" ] || \
               [ "${{ needs.contract-tests.result }}" != "success" ] || \
               [ "${{ needs.sheets-connectivity.result }}" != "success" ] || \
               [ "${{ needs.template-bundle.result }}" != "success" ] || \
               [ "${{ needs.build-worker.result }}" != "success" ]; then
            echo "## âŒ Pipeline Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Deployment blocked due to validation failures." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "## âœ… PR Validation Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All validation checks passed. Deployment will occur on merge to main." >> $GITHUB_STEP_SUMMARY
          else
            echo "## â­ï¸ Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          fi
