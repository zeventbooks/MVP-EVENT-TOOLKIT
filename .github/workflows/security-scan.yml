# CodeQL Security Analysis & Release Gate (Story 4)
#
# Purpose: Continuous security analysis for all code changes.
#          This is a REQUIRED CHECK for merging - no code goes to production
#          without passing security scans.
#
# Story 4 Acceptance Criteria:
#   - CodeQL runs on every push and PR
#   - Critical/severe findings BLOCK merges
#   - Weekly scheduled scans for vulnerability discovery
#   - Team agreement: No production deployment without passing scans
#
# Integration:
#   - Runs independently of Stage-1/Stage-2 (parallel security gate)
#   - Configure as REQUIRED status check in GitHub branch protection
#   - Results visible in Security tab and PR checks
#
# @see docs/ci-cd-architecture.md - Security scan documentation
name: CodeQL Security Analysis

on:
  push:
    branches: [ main, 'claude/**' ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sundays at 00:00 UTC for vulnerability discovery
    - cron: '0 0 * * 0'
  workflow_dispatch:
    # Allow manual trigger for security audits
    inputs:
      skip_cache:
        description: 'Skip cache for fresh analysis'
        required: false
        default: 'false'
        type: boolean

# Environment configuration
env:
  # Security scan policy - CRITICAL and HIGH findings block merges
  FAIL_ON_SEVERITY: 'critical,high'

jobs:
  # ============================================================================
  # CODEQL SECURITY SCAN
  # ============================================================================
  # Primary security gate using GitHub's CodeQL analysis.
  # This is a REQUIRED CHECK - configure in branch protection rules.
  # ============================================================================
  analyze:
    name: ðŸ”’ CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
      # Required for CodeQL to upload SARIF results
      pull-requests: read

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]
        # CodeQL supports: 'cpp', 'csharp', 'go', 'java', 'javascript', 'python', 'ruby'
        # Learn more about CodeQL language support at https://aka.ms/codeql-docs/language-support

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Display security scan configuration
      run: |
        echo "=============================================="
        echo "CODEQL SECURITY SCAN (Story 4)"
        echo "=============================================="
        echo ""
        echo "This scan is a REQUIRED CHECK for merging."
        echo "Critical and high severity findings will BLOCK the PR."
        echo ""
        echo "Trigger: ${{ github.event_name }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        echo "Policy: Fail on $FAIL_ON_SEVERITY severity findings"
        echo "=============================================="

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        # Extended security queries for comprehensive coverage
        # Prefix with "+" to use these queries AND those in config file
        queries: +security-extended,security-and-quality

    - name: Setup Node.js (for dependency analysis)
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: |
        echo "Installing dependencies for better analysis..."
        npm ci || npm install

    - name: Perform CodeQL Analysis
      id: codeql-analyze
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"
        # Upload SARIF results to GitHub Security tab
        upload: true
        # Output results for summary generation
        output: codeql-results

    # Note: CodeQL analyze action automatically fails on errors during analysis
    # The SARIF upload makes results visible in the Security tab
    # Branch protection rules should be configured to require this check

    - name: Create analysis summary
      if: always()
      run: |
        echo "## ðŸ”’ CodeQL Security Analysis Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Determine scan type for better context
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "### ðŸš¦ REQUIRED CHECK: Pull Request Security Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This security scan must pass before the PR can be merged." >> $GITHUB_STEP_SUMMARY
          echo "Critical and high severity findings will block the merge." >> $GITHUB_STEP_SUMMARY
        elif [ "${{ github.event_name }}" == "schedule" ]; then
          echo "### ðŸ“… Scheduled Weekly Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Regular security audit for vulnerability discovery." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ðŸ”„ Push Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Continuous security monitoring for code changes." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Language Analyzed" >> $GITHUB_STEP_SUMMARY
        echo "- **JavaScript** (includes .js, .gs, .html files)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Query Packs Used" >> $GITHUB_STEP_SUMMARY
        echo "- **security-extended**: Extended security queries" >> $GITHUB_STEP_SUMMARY
        echo "- **security-and-quality**: Security and code quality queries" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Coverage" >> $GITHUB_STEP_SUMMARY
        echo "- Backend: Google Apps Script (.gs files)" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend: HTML files with embedded JavaScript" >> $GITHUB_STEP_SUMMARY
        echo "- Tests: Jest and Playwright test files" >> $GITHUB_STEP_SUMMARY
        echo "- Scripts: Deployment and utility scripts" >> $GITHUB_STEP_SUMMARY
        echo "- Cloudflare Worker: cloudflare-proxy/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Security Checks Include" >> $GITHUB_STEP_SUMMARY
        echo "- SQL Injection vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "- Cross-Site Scripting (XSS)" >> $GITHUB_STEP_SUMMARY
        echo "- Command Injection" >> $GITHUB_STEP_SUMMARY
        echo "- Path Traversal" >> $GITHUB_STEP_SUMMARY
        echo "- Insecure Randomness" >> $GITHUB_STEP_SUMMARY
        echo "- Hardcoded Credentials" >> $GITHUB_STEP_SUMMARY
        echo "- Prototype Pollution" >> $GITHUB_STEP_SUMMARY
        echo "- Regular Expression DoS (ReDoS)" >> $GITHUB_STEP_SUMMARY
        echo "- And 200+ other security patterns" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Results" >> $GITHUB_STEP_SUMMARY
        echo "Check the **Security** tab to view detailed findings." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Story 4 Policy**: This is a required release gate." >> $GITHUB_STEP_SUMMARY
        echo "No code goes to production without passing security scans." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # DEPENDENCY AUDIT (npm audit)
  # ============================================================================
  # Checks for known vulnerabilities in npm dependencies.
  # Runs alongside CodeQL for comprehensive security coverage.
  # ============================================================================
  dependency-audit:
    name: ðŸ” Dependency Vulnerability Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run npm audit
      id: npm-audit
      run: |
        echo "=============================================="
        echo "NPM DEPENDENCY AUDIT"
        echo "=============================================="
        echo ""

        # Run audit and capture output
        set +e
        AUDIT_OUTPUT=$(npm audit --audit-level=high 2>&1)
        AUDIT_EXIT_CODE=$?
        set -e

        echo "$AUDIT_OUTPUT"

        # Check for critical/high vulnerabilities
        if [ $AUDIT_EXIT_CODE -ne 0 ]; then
          echo ""
          echo "âš ï¸ High or critical vulnerabilities found in dependencies!"
          echo "audit_status=warning" >> $GITHUB_OUTPUT

          # Extract vulnerability counts if present
          CRITICAL=$(echo "$AUDIT_OUTPUT" | grep -oP '\d+ critical' | head -1 || echo "0 critical")
          HIGH=$(echo "$AUDIT_OUTPUT" | grep -oP '\d+ high' | head -1 || echo "0 high")

          echo "critical_count=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high_count=$HIGH" >> $GITHUB_OUTPUT
        else
          echo ""
          echo "âœ… No high or critical vulnerabilities found"
          echo "audit_status=pass" >> $GITHUB_OUTPUT
        fi

        # Don't fail the job - just report (npm audit can be noisy)
        # CodeQL is the authoritative security gate
        exit 0

    - name: Create audit summary
      if: always()
      run: |
        echo "## ðŸ” Dependency Vulnerability Audit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        AUDIT_STATUS="${{ steps.npm-audit.outputs.audit_status }}"

        if [ "$AUDIT_STATUS" == "pass" ]; then
          echo "### âœ… No Critical/High Vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All dependencies are clear of high and critical severity issues." >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ Vulnerabilities Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Found vulnerabilities in npm dependencies:" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ steps.npm-audit.outputs.critical_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ steps.npm-audit.outputs.high_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run \`npm audit\` locally for details and fix recommendations." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note**: CodeQL is the authoritative security gate." >> $GITHUB_STEP_SUMMARY
        echo "Dependency audit is informational but should be addressed." >> $GITHUB_STEP_SUMMARY
