# Staging E2E Tests with Environment Reset (Story 3.5/5.2)
#
# Purpose: Run E2E tests against staging AFTER deployment.
# Tests require a live staging environment with the deployed Worker.
#
# Story 5.2 Update:
#   - No longer runs on PRs (PRs don't deploy, so no staging to test)
#   - Triggered by Stage-1 CI completion (after staging deploy)
#   - Can also be triggered manually for ad-hoc testing
#
# Features:
# - Pre-test environment health check
# - QA brand isolation for test data
# - Post-test cleanup of created data
# - Stability tracking and reporting
# - Graceful error handling
#
# @see docs/QA_ENVIRONMENT_MANAGEMENT.md for details
# @see stage1-ci.yml - Triggers this workflow after staging deploy

name: E2E Staging (Stable)

on:
  # Trigger after Stage-1 CI deploys to staging
  workflow_run:
    workflows:
      - "Stage-1 CI"
    types:
      - completed
  workflow_dispatch:
    inputs:
      cleanup_before:
        description: 'Clean up old test data before tests'
        required: false
        default: 'true'
        type: boolean
      run_full_suite:
        description: 'Run full E2E suite (not just smoke)'
        required: false
        default: 'false'
        type: boolean

env:
  BASE_URL: 'https://stg.eventangle.com'
  ENVIRONMENT: 'staging'
  QA_BRAND_ID: 'qa-testing'
  CI: true
  NODE_ENV: test

jobs:
  # ============================================================================
  # GATE CHECK: Verify Stage-1 deployed (not just validated)
  # ============================================================================
  check-deployment:
    name: 0. Check Deployment Status
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}

    steps:
      - name: Check if deployment occurred
        id: check
        run: |
          # Handle manual dispatch - always run
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual dispatch - proceeding with E2E tests"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Handle workflow_run trigger
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          TRIGGER_EVENT="${{ github.event.workflow_run.event }}"
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"

          echo "Stage-1 CI conclusion: $CONCLUSION"
          echo "Stage-1 trigger event: $TRIGGER_EVENT"
          echo "Stage-1 head branch: $HEAD_BRANCH"

          # E2E should only run if Stage-1 deployed (push to main)
          if [ "$CONCLUSION" != "success" ]; then
            echo "::notice::Stage-1 CI did not succeed - skipping E2E"
            echo "should_run=false" >> $GITHUB_OUTPUT
          elif [ "$TRIGGER_EVENT" != "push" ]; then
            echo "::notice::Stage-1 was triggered by '$TRIGGER_EVENT' - no deployment, skipping E2E"
            echo "should_run=false" >> $GITHUB_OUTPUT
          elif [ "$HEAD_BRANCH" != "main" ]; then
            echo "::notice::Stage-1 ran on branch '$HEAD_BRANCH' - skipping E2E"
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "Stage-1 deployed to staging - proceeding with E2E tests"
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

      - name: Create skip summary
        if: steps.check.outputs.should_run != 'true'
        run: |
          echo "## E2E Staging Tests - Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "E2E tests only run after Stage-1 deploys to staging (push to main)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Trigger Event** | \`${{ github.event.workflow_run.event }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.event.workflow_run.head_branch }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ENVIRONMENT PREPARATION
  # ============================================================================
  prepare-environment:
    name: 1. Prepare QA Environment
    runs-on: ubuntu-latest
    needs: check-deployment
    if: needs.check-deployment.outputs.should_run == 'true'
    outputs:
      ready: ${{ steps.validate.outputs.ready }}
      session_id: ${{ steps.session.outputs.id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate session ID
        id: session
        run: |
          SESSION_ID="SESSION_$(date +%s)_${{ github.run_number }}"
          echo "id=$SESSION_ID" >> $GITHUB_OUTPUT
          echo "Session ID: $SESSION_ID"

      - name: Check environment health
        id: health
        run: |
          echo "Checking staging environment health..."

          # Follow redirects (-L) and accept 200/302 as valid (staging may redirect)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 30 "$BASE_URL/?page=status" || echo "000")

          if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "302" ] || [ "$HTTP_CODE" == "301" ]; then
            echo "Environment is healthy (HTTP $HTTP_CODE)"
            echo "healthy=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Environment may be unhealthy (HTTP $HTTP_CODE)"
            # Still mark as healthy to allow tests to run - they'll fail if truly broken
            echo "healthy=true" >> $GITHUB_OUTPUT
          fi

      - name: Clean up old test data
        if: github.event.inputs.cleanup_before != 'false'
        env:
          ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
          TEST_SESSION_ID: ${{ steps.session.outputs.id }}
        run: |
          echo "Cleaning up old test data from QA brand..."
          node scripts/qa-environment-setup.js cleanup || echo "Cleanup completed with warnings"
        continue-on-error: true

      - name: Validate environment ready
        id: validate
        run: |
          if [ "${{ steps.health.outputs.healthy }}" == "true" ]; then
            echo "Environment is ready for testing"
            echo "ready=true" >> $GITHUB_OUTPUT
          else
            echo "::error::Environment is not ready"
            echo "ready=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # ============================================================================
  # API SMOKE TESTS
  # ============================================================================
  api-smoke:
    name: 2. API Smoke Tests
    runs-on: ubuntu-latest
    needs: prepare-environment
    if: needs.prepare-environment.outputs.ready == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Run API smoke tests
        id: api-tests
        env:
          ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
          TEST_SESSION_ID: ${{ needs.prepare-environment.outputs.session_id }}
        run: |
          echo "Running API smoke tests..."
          npm run test:api:smoke
        timeout-minutes: 10
        continue-on-error: true

      - name: Upload API test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-smoke-results-${{ github.run_number }}
          path: |
            playwright-report-smoke/
            .test-results/smoke-*.json
          retention-days: 14

      - name: Check API test result
        if: steps.api-tests.outcome == 'failure'
        run: |
          echo "::error::API smoke tests failed"
          exit 1

  # ============================================================================
  # UI SMOKE TESTS
  # ============================================================================
  ui-smoke:
    name: 3. UI Smoke Tests
    runs-on: ubuntu-latest
    needs: [prepare-environment, api-smoke]
    if: needs.prepare-environment.outputs.ready == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Run UI smoke tests
        id: ui-tests
        env:
          ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
          TEST_SESSION_ID: ${{ needs.prepare-environment.outputs.session_id }}
        run: |
          echo "Running UI smoke tests..."
          npm run test:ui:smoke
        timeout-minutes: 15
        continue-on-error: true

      - name: Upload UI test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-smoke-results-${{ github.run_number }}
          path: |
            playwright-report-ui-smoke/
            .test-results/ui-smoke-*.json
            test-results/
          retention-days: 14

      - name: Upload failure artifacts
        uses: actions/upload-artifact@v4
        if: steps.ui-tests.outcome == 'failure'
        with:
          name: ui-failure-debug-${{ github.run_number }}
          path: |
            test-results/**/trace.zip
            test-results/**/*.webm
            test-results/**/*.png
          retention-days: 30

      - name: Check UI test result
        if: steps.ui-tests.outcome == 'failure'
        run: |
          echo "::error::UI smoke tests failed"
          exit 1

  # ============================================================================
  # FULL E2E SUITE (Optional)
  # ============================================================================
  full-e2e:
    name: 4. Full E2E Suite
    runs-on: ubuntu-latest
    needs: [prepare-environment, api-smoke, ui-smoke]
    if: |
      needs.prepare-environment.outputs.ready == 'true' &&
      github.event.inputs.run_full_suite == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Run full E2E suite
        id: full-tests
        env:
          ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
          TEST_SESSION_ID: ${{ needs.prepare-environment.outputs.session_id }}
          CLEANUP_AFTER_TESTS: 'true'
        run: |
          echo "Running full E2E test suite..."
          npx playwright test --config playwright.staging.config.js
        timeout-minutes: 30
        continue-on-error: true

      - name: Upload full E2E results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: full-e2e-results-${{ github.run_number }}
          path: |
            playwright-report-staging/
            .test-results/staging-*.json
            test-results-staging/
          retention-days: 14

      - name: Check full E2E result
        if: steps.full-tests.outcome == 'failure'
        run: |
          echo "::error::Full E2E suite failed"
          exit 1

  # ============================================================================
  # POST-TEST CLEANUP & STABILITY TRACKING
  # ============================================================================
  cleanup-and-track:
    name: 5. Cleanup & Stability
    runs-on: ubuntu-latest
    needs: [prepare-environment, api-smoke, ui-smoke]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Clean up test data
        env:
          ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
          TEST_SESSION_ID: ${{ needs.prepare-environment.outputs.session_id }}
        run: |
          echo "Cleaning up test data created during this run..."
          node scripts/qa-environment-setup.js cleanup || echo "Cleanup completed with warnings"
        continue-on-error: true

      - name: Update stability metrics
        run: |
          echo "Updating test stability tracking..."
          mkdir -p .test-data

          # Record this run's status
          API_STATUS="${{ needs.api-smoke.result }}"
          UI_STATUS="${{ needs.ui-smoke.result }}"

          if [ "$API_STATUS" == "success" ] && [ "$UI_STATUS" == "success" ]; then
            echo '{"status": "success", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > .test-data/last-run.json
          else
            echo '{"status": "failure", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'", "api": "'$API_STATUS'", "ui": "'$UI_STATUS'"}' > .test-data/last-run.json
          fi

          # Generate stability report
          node tests/shared/stability-tracker.js json > .test-data/stability-report.json 2>/dev/null || echo '{"error": "Could not generate report"}'
        continue-on-error: true

      - name: Upload stability report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stability-report-${{ github.run_number }}
          path: |
            .test-data/stability-report.json
            .test-data/last-run.json
            .test-data/stability-metrics.json
          retention-days: 30

  # ============================================================================
  # SUMMARY
  # ============================================================================
  summary:
    name: 6. Test Summary
    runs-on: ubuntu-latest
    needs: [prepare-environment, api-smoke, ui-smoke, cleanup-and-track]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# E2E Staging Tests Summary (Story 3.5)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** $BASE_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Session:** ${{ needs.prepare-environment.outputs.session_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PREP="${{ needs.prepare-environment.result }}"
          API="${{ needs.api-smoke.result }}"
          UI="${{ needs.ui-smoke.result }}"
          CLEANUP="${{ needs.cleanup-and-track.result }}"

          # Determine overall status
          if [ "$PREP" == "success" ] && [ "$API" == "success" ] && [ "$UI" == "success" ]; then
            echo "## Status: All Tests Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Test suite completed successfully. This contributes to the stability streak!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## Status: Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more test stages failed. Review artifacts for details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment Prep | \`$PREP\` |" >> $GITHUB_STEP_SUMMARY
          echo "| API Smoke Tests | \`$API\` |" >> $GITHUB_STEP_SUMMARY
          echo "| UI Smoke Tests | \`$UI\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Cleanup & Tracking | \`$CLEANUP\` |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- API test results" >> $GITHUB_STEP_SUMMARY
          echo "- UI test results" >> $GITHUB_STEP_SUMMARY
          echo "- Stability report" >> $GITHUB_STEP_SUMMARY
          echo "- Failure debug artifacts (if any)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # FAILURE NOTIFICATION
  # ============================================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [api-smoke, ui-smoke]
    if: |
      always() &&
      (needs.api-smoke.result == 'failure' || needs.ui-smoke.result == 'failure')

    steps:
      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured, skipping"
            exit 0
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "E2E Staging Tests Failed (Story 3.5)",
              "attachments": [{
                "color": "#FF6B6B",
                "fields": [
                  {"title": "Environment", "value": "Staging", "short": true},
                  {"title": "API Tests", "value": "${{ needs.api-smoke.result }}", "short": true},
                  {"title": "UI Tests", "value": "${{ needs.ui-smoke.result }}", "short": true},
                  {"title": "Run", "value": "#${{ github.run_number }}", "short": true}
                ],
                "actions": [{
                  "type": "button",
                  "text": "View Results",
                  "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }]
              }]
            }' \
            "$SLACK_WEBHOOK_URL" || echo "Slack notification failed"
