# Stage-2 Orchestrator Workflow
#
# Purpose: Validates live staging AND production environments after Stage-1 deploys.
#          This closes the loop: Stage-1 deploys -> Stage-2 validates.
#
# Trigger: Runs automatically when Stage-1 Validation workflow succeeds.
#
# What it does:
#   - Staging (push to main): Downloads stg-base-url, runs full validation
#   - Production (tag push): Downloads prod-base-url, requires approval, runs post-deploy sanity
#   - Runs API smoke tests against the live URL
#   - Runs UI smoke tests against the live URL (GATED by API tests)
#   - Validates HTML integrity (Story 6: blocks GAS HTML leaks)
#   - Validates Story 7 acceptance criteria for production
#   - Blocks release on any failure (authoritative deployment validator)
#
# Story 2.5 (DevOps): Progressive Test Gates
#   - API smoke tests run FIRST (critical gate)
#   - If API tests fail, UI tests are SKIPPED (fail-fast)
#   - If any staging test fails, production deployment is NOT successful
#   - Team notification sent immediately on gate failure
#
# Story 6 - GAS HTML Guardrails:
#   API smoke tests include gas-html-integrity.spec.ts which:
#   - Fetches /events and all HTML routes
#   - Validates response does NOT contain GAS HTML markers
#   - Saves HTML artifacts on failure for debugging
#   - Blocks promotion if GAS HTML is detected
#
# Story 7 - Mirror Fixed Pipeline & Backend Wiring to Production:
#   Purpose: Bring prod to parity with staging so https://www.eventangle.com/events
#   behaves identically to staging.
#
#   Acceptance Criteria (CI):
#   - After manual approval, prod Stage-2 leg can:
#     - Hit https://www.eventangle.com/api/status
#     - Run lightweight /events smoke test (events.smoke.prod.spec.ts)
#     - Fail if prod /events is broken
#   - Prod Stage-2 blocks marking deployment as "live good" if /events fails
#
#   Production Tests:
#   - events.smoke.prod.spec.ts: Lightweight /events validation
#   - prod-sanity.spec.ts: Full production sanity checks
#   - No GAS blue banner on /events
#   - Admin UI visible
#   - Network calls use /api/* for JSON only
#   - QR codes still resolve to correct pages
#
#   Negative Path Handling:
#   - If prod deployment fails or /api/status not OK:
#     - Pipeline leaves current prod untouched
#     - Raises red flag with clear log output
#     - See docs/ROLLBACK.md for recovery procedures
#
#   Manual Approval Gate:
#   - Production tests require manual approval via GitHub Environment
#   - Setup: Settings > Environments > "production" > Required reviewers
#
# Contract Boundaries:
#   - Uses strict JSON schema checks from v4.1.2
#   - Validates stable routes only (no dev-only endpoints)
#   - Prevents broken posters, QR codes, events from going live
#   - Prevents GAS HTML shell from leaking to users
#
# System Impacts:
#   - Upstream: Validates deployment integrity from Stage-1
#   - Downstream: Prevents broken features from reaching users
#   - Rollback: If validation fails, see docs/ROLLBACK.md
#
# @see tests/api/smoke/ - API smoke test pack
# @see tests/api/smoke/gas-html-integrity.spec.ts - Story 6 GAS HTML guardrails
# @see tests/api/smoke/prod-sanity.spec.ts - Story 7 production sanity
# @see tests/ui/smoke/ - UI smoke test pack
# @see playwright.smoke.config.ts - API smoke configuration
# @see playwright.ui-smoke.config.ts - UI smoke configuration

name: Stage-2 Orchestrator

on:
  workflow_run:
    workflows:
      - "Stage-1 Validation"
    types:
      - completed

# Environment configuration - Standardized naming convention
# See config/deployment-ids.js for canonical source of truth
#
# Story 6 - CI Environment Configuration:
#   STG_BASE_URL: Used by Stage-2 tests against staging
#   PROD_BASE_URL: Used by Stage-2 tests against production
env:
  # Staging environment (Story 6 CI config)
  STG_BASE_URL: 'https://stg.eventangle.com'
  STAGING_URL: 'https://stg.eventangle.com'
  # Production environment (Story 6 CI config)
  PROD_BASE_URL: 'https://www.eventangle.com'
  PROD_URL: 'https://www.eventangle.com'
  # Legacy alias (keeping for backward compatibility)
  PRODUCTION_URL: 'https://www.eventangle.com'

# Prevent duplicate runs for the same deployment
concurrency:
  group: stage2-orchestrator-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # GATE CHECK
  # ============================================================================
  # Only proceed if Stage-1 completed successfully.
  # Determines whether this is a staging (push to main) or production (tag) deploy.
  # This prevents running Stage-2 on failed deployments.
  # ============================================================================
  check-stage1:
    name: Check Stage-1 Status
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      stage1_conclusion: ${{ steps.check.outputs.conclusion }}
      deploy_type: ${{ steps.check.outputs.deploy_type }}
      is_production: ${{ steps.check.outputs.is_production }}

    steps:
      - name: Check Stage-1 conclusion and deploy type
        id: check
        run: |
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"

          echo "Stage-1 Validation conclusion: $CONCLUSION"
          echo "Head branch/tag: $HEAD_BRANCH"
          echo "conclusion=$CONCLUSION" >> $GITHUB_OUTPUT

          # Determine deploy type based on head branch (tag vs main)
          if [[ "$HEAD_BRANCH" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Detected PRODUCTION deployment (tag: $HEAD_BRANCH)"
            echo "deploy_type=production" >> $GITHUB_OUTPUT
            echo "is_production=true" >> $GITHUB_OUTPUT
          else
            echo "Detected STAGING deployment (branch: $HEAD_BRANCH)"
            echo "deploy_type=staging" >> $GITHUB_OUTPUT
            echo "is_production=false" >> $GITHUB_OUTPUT
          fi

          if [ "$CONCLUSION" == "success" ]; then
            echo "Stage-1 succeeded - proceeding with Stage-2 validation"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Stage-1 did not succeed (conclusion: $CONCLUSION)"
            echo "Stage-2 validation skipped - Stage-1 must succeed first"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Create skip summary
        if: steps.check.outputs.should_run != 'true'
        run: |
          echo "## Stage-2 Orchestrator - Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Stage-1 Validation did not succeed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Stage-1 Conclusion** | \`${{ github.event.workflow_run.conclusion }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deploy Type** | \`${{ steps.check.outputs.deploy_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow Run** | \`${{ github.event.workflow_run.id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Head SHA** | \`${{ github.event.workflow_run.head_sha }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STORY 7: PRODUCTION APPROVAL GATE
  # ============================================================================
  # Requires manual approval before production Stage-2 tests can run.
  # Uses GitHub Environment protection rules for the "production" environment.
  #
  # Setup Required (GitHub Settings):
  #   1. Go to Settings > Environments
  #   2. Create environment named "production"
  #   3. Enable "Required reviewers" and add approvers
  #   4. Optionally add deployment branch restrictions (tags only)
  #
  # This gate ensures:
  #   - Production deployments are reviewed before validation
  #   - Accidental production testing is prevented
  #   - Clear audit trail of who approved production validation
  #
  # For staging: This job is skipped (no approval needed)
  # For production: Requires manual approval via GitHub environment
  # ============================================================================
  prod-approval-gate:
    name: ðŸ” Production Approval Gate
    runs-on: ubuntu-latest
    needs: check-stage1
    if: needs.check-stage1.outputs.should_run == 'true' && needs.check-stage1.outputs.is_production == 'true'
    environment:
      name: production
      url: https://www.eventangle.com

    steps:
      - name: Production deployment approved
        run: |
          echo "=============================================="
          echo "STORY 7: PRODUCTION APPROVAL GATE PASSED"
          echo "=============================================="
          echo ""
          echo "Production Stage-2 validation has been approved."
          echo ""
          echo "Environment: production"
          echo "Target URL: https://www.eventangle.com"
          echo "Tag: ${{ github.event.workflow_run.head_branch }}"
          echo ""
          echo "Proceeding with production smoke tests..."
          echo "=============================================="

      - name: Create approval summary
        run: |
          echo "## ðŸ” Production Approval Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… APPROVED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Production Stage-2 validation has been manually approved." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`production\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target URL** | \`https://www.eventangle.com\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag** | \`${{ github.event.workflow_run.head_branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Approver** | \`${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ARTIFACT DOWNLOAD
  # ============================================================================
  # Downloads the appropriate base-url artifact from Stage-1:
  #   - Staging deploy (main push): stg-base-url
  #   - Production deploy (tag push): prod-base-url
  #
  # Story 7: For production, this waits for manual approval first.
  # ============================================================================
  download-artifact:
    name: Download Base URL
    runs-on: ubuntu-latest
    needs: [check-stage1, prod-approval-gate]
    # Run if: staging (approval skipped) OR production (approval passed)
    if: |
      needs.check-stage1.outputs.should_run == 'true' &&
      (needs.check-stage1.outputs.is_production != 'true' || needs.prod-approval-gate.result == 'success')
    outputs:
      base_url: ${{ steps.extract.outputs.base_url }}
      environment: ${{ steps.extract.outputs.environment }}

    steps:
      # Use dawidd6/action-download-artifact for cross-workflow artifact downloads
      # The official actions/download-artifact@v4 does NOT support downloading
      # artifacts from a different workflow run (even with run-id parameter).
      - name: Download staging artifact
        if: needs.check-stage1.outputs.is_production != 'true'
        uses: dawidd6/action-download-artifact@v6
        with:
          name: stg-base-url
          run_id: ${{ github.event.workflow_run.id }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: stage1.yml

      - name: Download production artifact
        if: needs.check-stage1.outputs.is_production == 'true'
        uses: dawidd6/action-download-artifact@v6
        with:
          name: prod-base-url
          run_id: ${{ github.event.workflow_run.id }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: stage1.yml

      - name: Extract and validate BASE_URL
        id: extract
        env:
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
        run: |
          # Determine which file to read based on deploy type
          if [ "$IS_PRODUCTION" == "true" ]; then
            ARTIFACT_FILE="prod-base-url.txt"
            ENV_NAME="production"
          else
            ARTIFACT_FILE="stg-base-url.txt"
            ENV_NAME="staging"
          fi

          if [ ! -f "$ARTIFACT_FILE" ]; then
            echo "::error::$ARTIFACT_FILE not found in artifact"
            exit 1
          fi

          BASE_URL=$(cat "$ARTIFACT_FILE" | tr -d '\n')

          # Validate URL format
          if [[ ! "$BASE_URL" =~ ^https:// ]]; then
            echo "::error::Invalid BASE_URL format: $BASE_URL (must start with https://)"
            exit 1
          fi

          echo "Extracted BASE_URL: $BASE_URL"
          echo "Environment: $ENV_NAME"
          echo "base_url=$BASE_URL" >> $GITHUB_OUTPUT
          echo "environment=$ENV_NAME" >> $GITHUB_OUTPUT

      - name: Create artifact summary
        run: |
          echo "## Stage-2 Artifact Download" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully downloaded ${{ steps.extract.outputs.environment }} URL artifact." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`${{ steps.extract.outputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Base URL** | \`${{ steps.extract.outputs.base_url }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Source Workflow Run** | \`${{ github.event.workflow_run.id }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STORY 6: PRE-FLIGHT HEALTH CHECK
  # ============================================================================
  # Quick health check before running full test suite.
  # Validates that staging/production is reachable and responsive.
  #
  # Story 6 Requirements:
  #   - Hit /api/status first - abort if ok:false
  #   - Hit /events and assert HTTP 200
  #   - Fail cleanly with "staging unavailable" message instead of noisy timeouts
  #
  # This runs BEFORE env-alignment-gate to catch global outages early.
  # ============================================================================
  preflight-health-check:
    name: ðŸ¥ Pre-Flight Health Check (${{ needs.download-artifact.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [check-stage1, download-artifact]
    if: needs.check-stage1.outputs.should_run == 'true'
    outputs:
      health_status: ${{ steps.health-check.outputs.status }}
      api_status_ok: ${{ steps.health-check.outputs.api_status_ok }}
      events_ok: ${{ steps.health-check.outputs.events_ok }}
    env:
      BASE_URL: ${{ needs.download-artifact.outputs.base_url }}
      ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}

    steps:
      - name: Pre-flight health check
        id: health-check
        run: |
          echo "=============================================="
          echo "STORY 6: PRE-FLIGHT HEALTH CHECK"
          echo "=============================================="
          echo "Environment: $ENVIRONMENT"
          echo "BASE_URL: $BASE_URL"
          echo ""

          FAILED=false
          API_STATUS_OK="false"
          EVENTS_OK="false"

          # Step 1: Check /api/status endpoint
          echo ">> Checking /api/status..."
          HTTP_CODE=$(curl -s -o /tmp/api-status.json -w "%{http_code}" \
            --connect-timeout 30 \
            --max-time 60 \
            "$BASE_URL/api/status" 2>&1) || HTTP_CODE="000"

          if [ "$HTTP_CODE" = "000" ]; then
            echo ""
            echo "=============================================="
            echo "âŒ STAGING UNAVAILABLE"
            echo "=============================================="
            echo ""
            echo "Could not connect to $BASE_URL"
            echo "The staging environment appears to be globally down."
            echo ""
            echo "This is NOT a test failure - the environment is unreachable."
            echo ""
            echo "Possible causes:"
            echo "  - Cloudflare Worker is not responding"
            echo "  - DNS resolution failure"
            echo "  - Network connectivity issue"
            echo ""
            echo "Please check:"
            echo "  1. Cloudflare dashboard for Worker status"
            echo "  2. DNS configuration for $ENVIRONMENT"
            echo "  3. Recent deployment logs"
            echo "=============================================="
            echo ""
            echo "status=unavailable" >> $GITHUB_OUTPUT
            echo "api_status_ok=false" >> $GITHUB_OUTPUT
            echo "events_ok=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "  HTTP status: $HTTP_CODE"

          if [ "$HTTP_CODE" = "200" ]; then
            # Check if ok:true in response
            if [ -f /tmp/api-status.json ]; then
              OK_VALUE=$(jq -r '.ok // "null"' /tmp/api-status.json 2>/dev/null || echo "null")
              if [ "$OK_VALUE" = "true" ]; then
                echo "  /api/status: OK (ok: true)"
                API_STATUS_OK="true"
              else
                echo "  /api/status: UNHEALTHY (ok: $OK_VALUE)"
                cat /tmp/api-status.json
                echo ""
                echo "=============================================="
                echo "âŒ HEALTH CHECK FAILED"
                echo "=============================================="
                echo "/api/status returned ok:false"
                echo "The backend (GAS) is not healthy."
                echo ""
                echo "Aborting Stage-2 tests - fix backend first."
                echo "=============================================="
                FAILED=true
              fi
            fi
          elif [ "$HTTP_CODE" = "502" ] || [ "$HTTP_CODE" = "503" ]; then
            echo ""
            echo "=============================================="
            echo "âŒ STAGING UNAVAILABLE (HTTP $HTTP_CODE)"
            echo "=============================================="
            echo ""
            echo "/api/status returned HTTP $HTTP_CODE"
            echo "The staging environment is experiencing issues."
            echo ""
            echo "This indicates a backend (GAS) problem."
            echo "Aborting Stage-2 tests."
            echo "=============================================="
            FAILED=true
          else
            echo "  Unexpected status: $HTTP_CODE"
            FAILED=true
          fi

          # Step 2: Check /events endpoint
          echo ""
          echo ">> Checking /events..."
          EVENTS_CODE=$(curl -s -o /tmp/events.html -w "%{http_code}" \
            --connect-timeout 30 \
            --max-time 60 \
            "$BASE_URL/events" 2>&1) || EVENTS_CODE="000"

          echo "  HTTP status: $EVENTS_CODE"

          if [ "$EVENTS_CODE" = "200" ]; then
            echo "  /events: OK (HTTP 200)"
            EVENTS_OK="true"
          elif [ "$EVENTS_CODE" = "000" ]; then
            echo "  /events: UNAVAILABLE (connection failed)"
            FAILED=true
          else
            echo "  /events: UNEXPECTED (HTTP $EVENTS_CODE)"
            FAILED=true
          fi

          echo ""
          echo "api_status_ok=$API_STATUS_OK" >> $GITHUB_OUTPUT
          echo "events_ok=$EVENTS_OK" >> $GITHUB_OUTPUT

          if [ "$FAILED" = "true" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "status=passed" >> $GITHUB_OUTPUT
            echo ""
            echo "=============================================="
            echo "âœ… PRE-FLIGHT HEALTH CHECK PASSED"
            echo "=============================================="
            echo "  /api/status: OK"
            echo "  /events: OK"
            echo ""
            echo "Proceeding with full Stage-2 test suite..."
            echo "=============================================="
          fi

      - name: Create pre-flight summary
        if: always()
        run: |
          echo "## ðŸ¥ Pre-Flight Health Check ($ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          STATUS="${{ steps.health-check.outputs.status }}"
          API_OK="${{ steps.health-check.outputs.api_status_ok }}"
          EVENTS_OK="${{ steps.health-check.outputs.events_ok }}"

          if [ "$STATUS" = "passed" ]; then
            echo "### âœ… ENVIRONMENT HEALTHY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Pre-flight checks passed. Proceeding with Stage-2 validation." >> $GITHUB_STEP_SUMMARY
          elif [ "$STATUS" = "unavailable" ]; then
            echo "### âŒ STAGING UNAVAILABLE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**The staging environment is globally down.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This is not a test failure - the environment cannot be reached." >> $GITHUB_STEP_SUMMARY
            echo "All downstream Stage-2 tests will be skipped." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Check Cloudflare dashboard for Worker status" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify DNS configuration" >> $GITHUB_STEP_SUMMARY
            echo "3. Review recent deployment logs" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ HEALTH CHECK FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more health checks failed. See details below." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **/api/status** | \`$([ \"$API_OK\" = \"true\" ] && echo 'âœ… OK' || echo 'âŒ FAILED')\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **/events** | \`$([ \"$EVENTS_OK\" = \"true\" ] && echo 'âœ… OK' || echo 'âŒ FAILED')\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`$ENVIRONMENT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target URL** | \`$BASE_URL\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STORY 0.1: BACKEND SMOKE TESTS
  # ============================================================================
  # Tests versioned backend routing on staging.
  # Validates both GAS and Worker backends respond correctly to /api/status.
  #
  # Story 0.1 Requirements:
  #   - Test /api/status?backend=gas returns valid response
  #   - Test /api/status?backend=worker returns valid response
  #   - Both backends return ok: true
  #   - X-Backend header indicates correct backend
  #
  # Note: Only runs on staging (production uses GAS-only for now)
  # ============================================================================
  backend-smoke:
    name: ðŸ”€ Backend Smoke Tests (${{ needs.download-artifact.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [check-stage1, download-artifact, preflight-health-check]
    # Only run on staging (backend switching only implemented on staging)
    if: needs.preflight-health-check.result == 'success' && needs.check-stage1.outputs.is_production != 'true'
    outputs:
      backend_status: ${{ steps.backend-tests.outputs.status }}
      gas_backend_ok: ${{ steps.backend-tests.outputs.gas_ok }}
      worker_backend_ok: ${{ steps.backend-tests.outputs.worker_ok }}
    env:
      BASE_URL: ${{ needs.download-artifact.outputs.base_url }}
      ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
      CI: true

    steps:
      - name: Backend smoke tests (Story 0.1)
        id: backend-tests
        run: |
          echo "=============================================="
          echo "STORY 0.1: BACKEND SMOKE TESTS"
          echo "=============================================="
          echo "Environment: $ENVIRONMENT"
          echo "BASE_URL: $BASE_URL"
          echo ""
          echo "Testing versioned backend routing..."
          echo ""

          GAS_OK="false"
          WORKER_OK="false"
          FAILED=false

          # Test 1: GAS Backend (?backend=gas)
          echo ">> Testing GAS backend (?backend=gas)..."
          GAS_RESPONSE=$(curl -s -w "\n%{http_code}" \
            --connect-timeout 30 \
            --max-time 60 \
            -H "Accept: application/json" \
            "$BASE_URL/api/status?backend=gas" 2>&1)

          GAS_HTTP_CODE=$(echo "$GAS_RESPONSE" | tail -1)
          GAS_BODY=$(echo "$GAS_RESPONSE" | sed '$d')
          GAS_BACKEND=$(echo "$GAS_BODY" | jq -r '.ok // "null"' 2>/dev/null || echo "null")
          GAS_HEADER=$(curl -sI "$BASE_URL/api/status?backend=gas" | grep -i "x-backend:" | tr -d '\r' | cut -d' ' -f2)

          echo "  HTTP Status: $GAS_HTTP_CODE"
          echo "  X-Backend: $GAS_HEADER"
          echo "  ok: $GAS_BACKEND"

          if [ "$GAS_HTTP_CODE" = "200" ] && [ "$GAS_BACKEND" = "true" ]; then
            if [ "$GAS_HEADER" = "gas" ]; then
              echo "  âœ… GAS backend: PASS"
              GAS_OK="true"
            else
              echo "  âš ï¸ GAS backend returned 200 but X-Backend header is '$GAS_HEADER' (expected 'gas')"
              GAS_OK="true"  # Still consider it passing if response is ok
            fi
          else
            echo "  âŒ GAS backend: FAIL"
            FAILED=true
          fi
          echo ""

          # Test 2: Worker Backend (?backend=worker)
          echo ">> Testing Worker backend (?backend=worker)..."
          WORKER_RESPONSE=$(curl -s -w "\n%{http_code}" \
            --connect-timeout 30 \
            --max-time 60 \
            -H "Accept: application/json" \
            "$BASE_URL/api/status?backend=worker" 2>&1)

          WORKER_HTTP_CODE=$(echo "$WORKER_RESPONSE" | tail -1)
          WORKER_BODY=$(echo "$WORKER_RESPONSE" | sed '$d')
          WORKER_OK_VALUE=$(echo "$WORKER_BODY" | jq -r '.ok // "null"' 2>/dev/null || echo "null")
          WORKER_HEADER=$(curl -sI "$BASE_URL/api/status?backend=worker" | grep -i "x-backend:" | tr -d '\r' | cut -d' ' -f2)

          echo "  HTTP Status: $WORKER_HTTP_CODE"
          echo "  X-Backend: $WORKER_HEADER"
          echo "  ok: $WORKER_OK_VALUE"

          if [ "$WORKER_HTTP_CODE" = "200" ] && [ "$WORKER_OK_VALUE" = "true" ]; then
            if [ "$WORKER_HEADER" = "worker" ]; then
              echo "  âœ… Worker backend: PASS"
              WORKER_OK="true"
            else
              echo "  âš ï¸ Worker backend returned 200 but X-Backend header is '$WORKER_HEADER' (expected 'worker')"
              WORKER_OK="true"  # Still consider it passing if response is ok
            fi
          else
            echo "  âŒ Worker backend: FAIL"
            FAILED=true
          fi
          echo ""

          # Output results
          echo "gas_ok=$GAS_OK" >> $GITHUB_OUTPUT
          echo "worker_ok=$WORKER_OK" >> $GITHUB_OUTPUT

          if [ "$FAILED" = "true" ]; then
            echo "=============================================="
            echo "âŒ BACKEND SMOKE TESTS: FAILED"
            echo "=============================================="
            echo "One or more backend tests failed."
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "=============================================="
            echo "âœ… BACKEND SMOKE TESTS: PASSED"
            echo "=============================================="
            echo "Both GAS and Worker backends are operational."
            echo "status=passed" >> $GITHUB_OUTPUT
          fi

      - name: Create backend smoke summary
        if: always()
        run: |
          echo "## ðŸ”€ Backend Smoke Tests ($ENVIRONMENT) - Story 0.1" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          GAS_OK="${{ steps.backend-tests.outputs.gas_ok }}"
          WORKER_OK="${{ steps.backend-tests.outputs.worker_ok }}"
          STATUS="${{ steps.backend-tests.outputs.status }}"

          if [ "$STATUS" == "passed" ]; then
            echo "### âœ… PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Both backend modes are operational." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more backend modes failed." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **GAS** (\`?backend=gas\`) | \`$([ \"$GAS_OK\" = \"true\" ] && echo 'âœ… OK' || echo 'âŒ FAILED')\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Worker** (\`?backend=worker\`) | \`$([ \"$WORKER_OK\" = \"true\" ] && echo 'âœ… OK' || echo 'âŒ FAILED')\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`$ENVIRONMENT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target URL** | \`$BASE_URL\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Story 0.1 Acceptance Criteria:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`/api/status?backend=gas\` - Tests GAS backend" >> $GITHUB_STEP_SUMMARY
          echo "- \`/api/status?backend=worker\` - Tests Worker backend" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ENVIRONMENT ALIGNMENT GATE (Story 4 - Critical First Gate)
  # ============================================================================
  # MUST run FIRST before any other tests. Verifies Worker â†” GAS alignment.
  # This is the critical fail-fast gate that prevents deployment mismatches.
  #
  # Checks performed:
  #   - Worker /env-status returns correct environment (staging/production)
  #   - GAS /whoami returns correct scriptId and deploymentId
  #   - Worker deploymentId matches GAS deploymentId (CRITICAL)
  #   - Script ID matches expected staging/production Script ID
  #   - Account email contains "zeventbook"
  #
  # If ANY check fails:
  #   - Pipeline FAILS IMMEDIATELY
  #   - All downstream tests are SKIPPED
  #   - Promotion to production is BLOCKED
  #
  # @see tests/api/smoke/env-alignment.spec.ts
  # ============================================================================
  env-alignment-gate:
    name: ðŸ” Environment Alignment Gate (${{ needs.download-artifact.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [check-stage1, download-artifact, preflight-health-check]
    # Story 6: Only run if pre-flight health check passed
    if: needs.preflight-health-check.result == 'success'
    outputs:
      alignment_status: ${{ steps.alignment-check.outputs.status }}
      worker_deployment_id: ${{ steps.alignment-check.outputs.worker_deployment_id }}
      gas_deployment_id: ${{ steps.alignment-check.outputs.gas_deployment_id }}
    env:
      BASE_URL: ${{ needs.download-artifact.outputs.base_url }}
      ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
      IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
      CI: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Display alignment check configuration
        run: |
          echo "=============================================="
          echo "ENVIRONMENT ALIGNMENT GATE (Story 4)"
          echo "=============================================="
          echo "Environment: $ENVIRONMENT"
          echo "BASE_URL: $BASE_URL"
          echo "Is Production: $IS_PRODUCTION"
          echo ""
          echo "This gate verifies:"
          echo "  - Worker /env-status and GAS /whoami alignment"
          echo "  - Deployment IDs match between Worker and GAS"
          echo "  - Script ID matches expected for environment"
          echo "  - Environment name is consistent"
          echo ""
          echo "FAILURE = IMMEDIATE PIPELINE ABORT"
          echo "=============================================="

      - name: Run Environment Alignment Tests
        id: alignment-check
        run: |
          echo "Running environment alignment tests against: $BASE_URL"

          # Run alignment tests with verbose output
          set +e
          OUTPUT=$(npx playwright test tests/api/smoke/env-alignment.spec.ts --project=chromium --reporter=list 2>&1)
          EXIT_CODE=$?
          set -e

          echo "$OUTPUT"

          # Extract deployment IDs from test output if available
          WORKER_ID=$(echo "$OUTPUT" | grep -oP 'deploymentId.*?AKfycb[a-zA-Z0-9_-]+' | head -1 | grep -oP 'AKfycb[a-zA-Z0-9_-]+' || echo "unknown")
          GAS_ID=$(echo "$OUTPUT" | grep -oP 'gas.*deploymentId.*?AKfycb[a-zA-Z0-9_-]+' | head -1 | grep -oP 'AKfycb[a-zA-Z0-9_-]+' || echo "unknown")

          echo "worker_deployment_id=$WORKER_ID" >> $GITHUB_OUTPUT
          echo "gas_deployment_id=$GAS_ID" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ… ENVIRONMENT ALIGNMENT: PASS"
            echo "Worker and GAS deployment IDs are aligned."
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo ""
            echo "âŒ ENVIRONMENT ALIGNMENT: FAIL"
            echo "Worker and GAS deployment mismatch detected!"
            echo ""
            echo "This blocks all downstream tests and deployment promotion."
            exit 1
          fi

      - name: Upload alignment test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: env-alignment-results-${{ env.ENVIRONMENT }}
          path: |
            playwright-report-smoke/
            .test-results/smoke-*.json
          retention-days: 7

      - name: Create alignment gate summary
        if: always()
        run: |
          echo "## ðŸ” Environment Alignment Gate ($ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          STATUS="${{ steps.alignment-check.outputs.status }}"
          WORKER_ID="${{ steps.alignment-check.outputs.worker_deployment_id }}"
          GAS_ID="${{ steps.alignment-check.outputs.gas_deployment_id }}"

          if [ "$STATUS" == "passed" ]; then
            echo "### âœ… ALIGNED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Worker â†” GAS deployment alignment verified." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ MISALIGNED - PIPELINE BLOCKED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**CRITICAL:** Worker and GAS deployment mismatch detected!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This indicates the Cloudflare Worker is pointing to the wrong" >> $GITHUB_STEP_SUMMARY
            echo "Google Apps Script deployment. All downstream tests are SKIPPED." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`$ENVIRONMENT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target URL** | \`$BASE_URL\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Worker Deployment ID** | \`$WORKER_ID\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **GAS Deployment ID** | \`$GAS_ID\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **IDs Match** | \`$([ \"$WORKER_ID\" == \"$GAS_ID\" ] && echo 'Yes âœ…' || echo 'No âŒ')\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # API SMOKE TESTS (CRITICAL GATE)
  # ============================================================================
  # Validates API contract compliance against the live environment.
  # Tests: status, events, qr, sharedreport endpoints
  # Uses strict v4.1.2 JSON schema validation.
  #
  # DEPENDS ON: env-alignment-gate (fail-fast - skipped if alignment fails)
  #
  # Story 2.5: Progressive Test Gate
  #   - API smoke tests are the FIRST test gate after env-alignment
  #   - If API tests fail, UI tests are SKIPPED (gated)
  #   - This saves resources and provides immediate feedback
  #
  # Story 6 GAS HTML Guardrails (gas-html-integrity.spec.ts):
  #   - Fetches /events and all HTML routes
  #   - Validates NO GAS HTML markers in response
  #   - Blocks deploy if "Google Apps Script user" message found
  #   - Blocks deploy if warden scripts detected
  #   - Saves HTML artifacts on failure for debugging
  #
  # Story 7 Production Sanity (prod-sanity.spec.ts - production only):
  #   - Additional production-specific validation
  #   - Network request monitoring
  #   - QR code resolution verification
  # ============================================================================
  api-smoke:
    name: ðŸ”¥ API Smoke Tests (${{ needs.download-artifact.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [check-stage1, download-artifact, env-alignment-gate]
    outputs:
      api_test_result: ${{ steps.api-tests.outcome }}
    env:
      BASE_URL: ${{ needs.download-artifact.outputs.base_url }}
      ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
      IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
      CI: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Display test configuration
        run: |
          echo "=============================================="
          echo "API SMOKE TEST CONFIGURATION"
          echo "=============================================="
          echo "Environment: $ENVIRONMENT"
          echo "BASE_URL: $BASE_URL"
          echo "Is Production: $IS_PRODUCTION"
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "=============================================="

      - name: Run API smoke tests
        id: api-tests
        run: |
          echo "Running API smoke tests against: $BASE_URL ($ENVIRONMENT)"
          npm run test:api:smoke
        continue-on-error: true

      - name: Run lightweight production events smoke test (Story 7)
        id: prod-events-smoke
        if: env.IS_PRODUCTION == 'true'
        run: |
          echo "=============================================="
          echo "STORY 7 - LIGHTWEIGHT PRODUCTION EVENTS TEST"
          echo "=============================================="
          echo "Running minimal /events smoke test..."
          echo "Target: $BASE_URL"
          echo "=============================================="

          # Run lightweight events.smoke.prod.spec.ts
          if [ -f "tests/api/smoke/events.smoke.prod.spec.ts" ]; then
            npx playwright test tests/api/smoke/events.smoke.prod.spec.ts --project=chromium --reporter=list
          else
            echo "events.smoke.prod.spec.ts not found"
            echo "Falling back to standard events test"
            npx playwright test tests/api/smoke/events.spec.ts --project=chromium --reporter=list
          fi
        continue-on-error: true

      - name: Run production sanity tests (Story 7)
        id: prod-sanity
        if: env.IS_PRODUCTION == 'true'
        run: |
          echo "=============================================="
          echo "STORY 7 - PRODUCTION SANITY TESTS"
          echo "=============================================="
          echo "Running production-specific validation..."
          echo "Target: $BASE_URL"
          echo "=============================================="

          # Run production sanity tests if they exist
          if [ -f "tests/api/smoke/prod-sanity.spec.ts" ]; then
            npx playwright test tests/api/smoke/prod-sanity.spec.ts --project=chromium --reporter=list
          else
            echo "prod-sanity.spec.ts not found, skipping production sanity tests"
            echo "This is expected for initial Story 7 deployment"
          fi
        continue-on-error: true

      - name: Upload API smoke test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-smoke-results-${{ env.ENVIRONMENT }}
          path: |
            playwright-report-smoke/
            .test-results/smoke-*.json
            .test-results/smoke-*.xml
            .test-results/gas-html-artifacts/
          retention-days: 7

      - name: Check API smoke test result
        if: steps.api-tests.outcome == 'failure'
        run: |
          echo "::error::API smoke tests failed against $BASE_URL ($ENVIRONMENT)"
          echo ""
          echo "Stage-2 API validation failed. This blocks the release."
          echo "Check the API smoke test results artifact for details."
          exit 1

      - name: Check production events smoke result (Story 7)
        if: env.IS_PRODUCTION == 'true' && steps.prod-events-smoke.outcome == 'failure'
        run: |
          echo "::error::Production /events smoke test failed (Story 7)"
          echo ""
          echo "Production /events endpoint is broken. This blocks the release."
          echo "See docs/ROLLBACK.md for recovery procedures."
          exit 1

      - name: Check production sanity result (Story 7)
        if: env.IS_PRODUCTION == 'true' && steps.prod-sanity.outcome == 'failure'
        run: |
          echo "::error::Production sanity tests failed (Story 7)"
          echo ""
          echo "Production validation failed. This blocks the release."
          echo "See docs/ROLLBACK.md for recovery procedures."
          exit 1

      - name: Create API smoke summary
        if: always()
        run: |
          echo "## API Smoke Tests ($ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.api-tests.outcome }}" == "success" ]; then
            echo "### PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All API smoke tests passed against $ENVIRONMENT." >> $GITHUB_STEP_SUMMARY
          else
            echo "### FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "API smoke tests failed. Check test results for details." >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$IS_PRODUCTION" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Story 7 Production Tests:**" >> $GITHUB_STEP_SUMMARY
            echo "- Events Smoke: \`${{ steps.prod-events-smoke.outcome }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Sanity Tests: \`${{ steps.prod-sanity.outcome }}\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`$ENVIRONMENT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target URL** | \`$BASE_URL\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **API Tests** | \`${{ steps.api-tests.outcome }}\` |" >> $GITHUB_STEP_SUMMARY
          if [ "$IS_PRODUCTION" == "true" ]; then
            echo "| **Prod Events Smoke** | \`${{ steps.prod-events-smoke.outcome }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Prod Sanity** | \`${{ steps.prod-sanity.outcome }}\` |" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # UI SMOKE TESTS (GATED BY API TESTS)
  # ============================================================================
  # Validates UI surfaces against the live environment.
  # Tests: Admin, Public, Display, Poster surfaces
  # Principle: "If you show it, it works"
  #
  # DEPENDS ON: api-smoke (fail-fast - SKIPPED if API tests fail)
  #
  # Story 2.5: Progressive Test Gate
  #   - UI smoke tests are GATED by API smoke tests
  #   - If API tests fail, this job is SKIPPED (fail-fast)
  #   - E2E tests don't run when earlier gates failed
  #   - Saves CI resources on doomed deployments
  #
  # Story 7 Production Validation:
  #   - Admin UI visible on /admin
  #   - No GAS blue banner on /events
  #   - QR codes render correctly on Poster
  # ============================================================================
  ui-smoke:
    name: ðŸ–¥ï¸ UI Smoke Tests (${{ needs.download-artifact.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [check-stage1, download-artifact, env-alignment-gate, api-smoke]  # Story 2.5: Depends on API tests
    if: needs.api-smoke.result == 'success'  # Story 2.5: Skip if API tests failed
    env:
      BASE_URL: ${{ needs.download-artifact.outputs.base_url }}
      ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
      IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
      CI: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Display test configuration
        run: |
          echo "=============================================="
          echo "UI SMOKE TEST CONFIGURATION"
          echo "=============================================="
          echo "Environment: $ENVIRONMENT"
          echo "BASE_URL: $BASE_URL"
          echo "Is Production: $IS_PRODUCTION"
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "=============================================="

      - name: Run UI smoke tests
        id: ui-tests
        run: |
          echo "Running UI smoke tests against: $BASE_URL ($ENVIRONMENT)"
          npm run test:ui:smoke
        continue-on-error: true

      - name: Upload UI smoke test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-smoke-results-${{ env.ENVIRONMENT }}
          path: |
            playwright-report-ui-smoke/
            .test-results/ui-smoke-*.json
            .test-results/ui-smoke-*.xml
          retention-days: 7

      - name: Check UI smoke test result
        if: steps.ui-tests.outcome == 'failure'
        run: |
          echo "::error::UI smoke tests failed against $BASE_URL ($ENVIRONMENT)"
          echo ""
          echo "Stage-2 UI validation failed. This blocks the release."
          echo "Check the UI smoke test results artifact for details."
          if [ "$IS_PRODUCTION" == "true" ]; then
            echo "See docs/ROLLBACK.md for recovery procedures."
          fi
          exit 1

      - name: Create UI smoke summary
        if: always()
        run: |
          echo "## UI Smoke Tests ($ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.ui-tests.outcome }}" == "success" ]; then
            echo "### PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All UI smoke tests passed against $ENVIRONMENT." >> $GITHUB_STEP_SUMMARY
          else
            echo "### FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "UI smoke tests failed. Check test results for details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`$ENVIRONMENT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target URL** | \`$BASE_URL\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Result** | \`${{ steps.ui-tests.outcome }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # E2E TESTS - CRITICAL USER JOURNEYS (Story 3.4)
  # ============================================================================
  # Runs the comprehensive end-to-end test suite (Story 3.3) after smoke tests.
  # Tests all 10 critical user journeys organized by event lifecycle:
  #
  # PRE-EVENT (Setup & Configuration):
  #   - Journey 1: Event Creation Flow
  #   - Journey 2: Sponsor Flow
  #   - Journey 3: Poster Surface
  #
  # EVENT (Live Surfaces):
  #   - Journey 4: Display Surface (TV/Kiosk)
  #   - Journey 5: Event Viewing Flow (Public)
  #
  # POST-EVENT (Analytics):
  #   - Journey 6: Shared Report
  #
  # TOOLS (Infrastructure & Validation):
  #   - Journeys 7-10: CRUD, Cross-Surface, Health, Error Handling
  #
  # STAGING ONLY: These tests create/modify data, so only run on staging.
  # Production uses the nightly read-only workflow (e2e-nightly-production.yml)
  #
  # Artifacts captured on failure:
  #   - Screenshots (all tests)
  #   - Videos (on failure)
  #   - Traces (on failure)
  #   - HTML reports
  #
  # @see tests/e2e/story-3.3-critical-user-journeys.spec.js
  # ============================================================================
  e2e-tests:
    name: ðŸ§ª E2E Critical Journeys (${{ needs.download-artifact.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [check-stage1, download-artifact, env-alignment-gate, api-smoke, ui-smoke]
    # Story 3.4: Run E2E tests only on staging (they create/modify data)
    # Also skip if UI smoke tests failed (progressive gates)
    if: |
      needs.ui-smoke.result == 'success' &&
      needs.check-stage1.outputs.is_production != 'true'
    outputs:
      e2e_test_result: ${{ steps.e2e-tests.outcome }}
    env:
      BASE_URL: ${{ needs.download-artifact.outputs.base_url }}
      ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
      IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
      CI: true
      # Admin key for test data setup (create events, sponsors, etc.)
      ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
      BRAND_ID: 'root'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Display E2E test configuration
        run: |
          echo "=============================================="
          echo "E2E CRITICAL USER JOURNEYS (Story 3.4)"
          echo "=============================================="
          echo "Environment: $ENVIRONMENT"
          echo "BASE_URL: $BASE_URL"
          echo "Brand ID: $BRAND_ID"
          echo "Admin Key: ${ADMIN_KEY:+[CONFIGURED]}"
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo ""
          echo "This runs the comprehensive E2E test suite:"
          echo "  - 10 critical user journeys"
          echo "  - Organized by event lifecycle phases"
          echo "  - Self-cleaning test data"
          echo "  - Retries enabled for transient failures"
          echo "=============================================="

      - name: Run E2E critical user journeys
        id: e2e-tests
        run: |
          echo "Running E2E critical user journeys against: $BASE_URL ($ENVIRONMENT)"
          npm run test:story3.3
        continue-on-error: true

      - name: Upload E2E test artifacts (screenshots, videos, traces)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-artifacts-${{ env.ENVIRONMENT }}
          path: |
            playwright-report/
            .test-results/playwright-results.json
            .test-results/junit.xml
            test-results/
          retention-days: 14

      - name: Upload failure artifacts (videos and traces on failure)
        uses: actions/upload-artifact@v4
        if: steps.e2e-tests.outcome == 'failure'
        with:
          name: e2e-failure-debug-${{ env.ENVIRONMENT }}-${{ github.run_number }}
          path: |
            test-results/**/trace.zip
            test-results/**/*.webm
            test-results/**/*.png
            playwright-report/
          retention-days: 30

      - name: Check E2E test result
        if: steps.e2e-tests.outcome == 'failure'
        run: |
          echo "::error::E2E critical user journey tests failed against $BASE_URL ($ENVIRONMENT)"
          echo ""
          echo "=============================================="
          echo "E2E TESTS FAILED"
          echo "=============================================="
          echo ""
          echo "One or more critical user journeys failed."
          echo "Check the 'e2e-test-artifacts' and 'e2e-failure-debug' artifacts for:"
          echo "  - Screenshots (all tests)"
          echo "  - Videos (failed tests)"
          echo "  - Traces (failed tests)"
          echo "  - HTML report with detailed failure info"
          echo ""
          echo "Common causes:"
          echo "  - GAS cold start timeouts (retries should handle)"
          echo "  - Test data conflicts (tests use unique timestamps)"
          echo "  - UI changes not reflected in selectors"
          echo "  - API contract changes"
          echo ""
          echo "See docs/E2E_PLAYWRIGHT_GUIDE.md for debugging tips."
          echo "=============================================="
          exit 1

      - name: Create E2E test summary
        if: always()
        run: |
          echo "## ðŸ§ª E2E Critical User Journeys ($ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.e2e-tests.outcome }}" == "success" ]; then
            echo "### âœ… PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All 10 critical user journeys passed against $ENVIRONMENT." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Journeys Tested:**" >> $GITHUB_STEP_SUMMARY
            echo "- PRE-EVENT: Event Creation, Sponsor Flow, Poster Surface" >> $GITHUB_STEP_SUMMARY
            echo "- EVENT: Display Surface, Event Viewing" >> $GITHUB_STEP_SUMMARY
            echo "- POST-EVENT: Shared Report" >> $GITHUB_STEP_SUMMARY
            echo "- TOOLS: CRUD, Cross-Surface, Health, Error Handling" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "E2E critical user journey tests failed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Debugging Resources:**" >> $GITHUB_STEP_SUMMARY
            echo "- Download 'e2e-test-artifacts' for HTML report" >> $GITHUB_STEP_SUMMARY
            echo "- Download 'e2e-failure-debug' for videos & traces" >> $GITHUB_STEP_SUMMARY
            echo "- See [E2E Playwright Guide](../docs/E2E_PLAYWRIGHT_GUIDE.md)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`$ENVIRONMENT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target URL** | \`$BASE_URL\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Result** | \`${{ steps.e2e-tests.outcome }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Test Suite** | Story 3.3 Critical User Journeys |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STORY 4.2: WORKER CUTOVER VALIDATION (STAGING ONLY)
  # ============================================================================
  # Validates that staging is fully Worker-backed before production cutover.
  # Tests all surfaces (Public, Display, Poster) via Worker v2 API endpoints.
  #
  # Story 4.2 Requirements:
  #   - All stg URLs function: /admin, /public, /display, /poster
  #   - QR codes in staging hit Worker and produce valid pages
  #   - Worker failures show "Temporarily unavailable" not blank pages
  #   - Cross-surface navigation works (public â†’ display â†’ poster)
  #   - Worker v2 API endpoints respond correctly with X-Backend header
  #
  # STAGING ONLY: This validates Worker cutover readiness for production.
  # Production cutover is gated by this test passing.
  #
  # @see tests/e2e/stage-2/staging-worker-cutover.spec.js
  # ============================================================================
  worker-cutover-validation:
    name: ðŸ”„ Worker Cutover Validation (${{ needs.download-artifact.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [check-stage1, download-artifact, env-alignment-gate, api-smoke, ui-smoke]
    # Story 4.2: Only run on staging (validates Worker readiness for prod cutover)
    if: |
      needs.ui-smoke.result == 'success' &&
      needs.check-stage1.outputs.is_production != 'true'
    outputs:
      worker_cutover_result: ${{ steps.worker-cutover-tests.outcome }}
    env:
      BASE_URL: ${{ needs.download-artifact.outputs.base_url }}
      ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
      CI: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Display Worker cutover test configuration
        run: |
          echo "=============================================="
          echo "STORY 4.2: WORKER CUTOVER VALIDATION"
          echo "=============================================="
          echo "Environment: $ENVIRONMENT"
          echo "BASE_URL: $BASE_URL"
          echo "Node version: $(node --version)"
          echo ""
          echo "This validates staging is fully Worker-backed:"
          echo "  - All surfaces served by Worker (not GAS)"
          echo "  - Worker v2 API endpoints functional"
          echo "  - Cross-surface navigation works"
          echo "  - QR codes hit Worker endpoints"
          echo "  - Graceful error handling on Worker failures"
          echo ""
          echo "PASS = Production cutover is safe to proceed"
          echo "FAIL = Block production cutover until fixed"
          echo "=============================================="

      - name: Run Worker cutover validation tests
        id: worker-cutover-tests
        run: |
          echo "Running Worker cutover validation against: $BASE_URL ($ENVIRONMENT)"
          npx playwright test tests/e2e/stage-2/staging-worker-cutover.spec.js --project=chromium --reporter=list
        continue-on-error: true

      - name: Upload Worker cutover test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: worker-cutover-results-${{ env.ENVIRONMENT }}
          path: |
            playwright-report/
            .test-results/
            test-results/
          retention-days: 14

      - name: Check Worker cutover test result
        if: steps.worker-cutover-tests.outcome == 'failure'
        run: |
          echo "::error::Worker cutover validation failed against $BASE_URL ($ENVIRONMENT)"
          echo ""
          echo "=============================================="
          echo "STORY 4.2: WORKER CUTOVER VALIDATION FAILED"
          echo "=============================================="
          echo ""
          echo "Staging is NOT fully Worker-backed."
          echo "Production cutover is BLOCKED until this passes."
          echo ""
          echo "Possible issues:"
          echo "  - Worker v2 API endpoints not responding"
          echo "  - X-Backend header not showing 'worker'"
          echo "  - Cross-surface navigation broken"
          echo "  - Error pages not rendering correctly"
          echo ""
          echo "Check the 'worker-cutover-results' artifact for details."
          echo "=============================================="
          exit 1

      - name: Create Worker cutover summary
        if: always()
        run: |
          echo "## ðŸ”„ Worker Cutover Validation ($ENVIRONMENT) - Story 4.2" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.worker-cutover-tests.outcome }}" == "success" ]; then
            echo "### âœ… STAGING FULLY WORKER-BACKED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All Worker cutover validation tests passed." >> $GITHUB_STEP_SUMMARY
            echo "Production cutover is safe to proceed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Verified:**" >> $GITHUB_STEP_SUMMARY
            echo "- All surfaces (Public, Display, Poster) served by Worker" >> $GITHUB_STEP_SUMMARY
            echo "- Worker v2 API endpoints functional" >> $GITHUB_STEP_SUMMARY
            echo "- Cross-surface navigation works" >> $GITHUB_STEP_SUMMARY
            echo "- QR codes hit Worker endpoints" >> $GITHUB_STEP_SUMMARY
            echo "- Graceful error handling configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ WORKER CUTOVER BLOCKED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Worker cutover validation failed." >> $GITHUB_STEP_SUMMARY
            echo "**Production cutover is BLOCKED.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Debugging:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Download 'worker-cutover-results' artifact" >> $GITHUB_STEP_SUMMARY
            echo "2. Check Worker deployment configuration" >> $GITHUB_STEP_SUMMARY
            echo "3. Verify Worker v2 API routes are deployed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`$ENVIRONMENT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target URL** | \`$BASE_URL\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Result** | \`${{ steps.worker-cutover-tests.outcome }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # FINAL VALIDATION GATE
  # ============================================================================
  # Aggregates results from all Stage-2 tests.
  # This is the authoritative deployment validator.
  # Failure here blocks the release and signals red in GitHub.
  #
  # Story 2.5: Progressive Test Gates
  #   - If API tests fail, UI tests are skipped (result = 'skipped')
  #   - Skipped UI tests due to API failure = overall FAILURE
  #   - This ensures production is blocked when staging tests fail
  #
  # Story 3.4: E2E Critical Journeys (Staging Only)
  #   - Runs after smoke tests pass
  #   - Tests all 10 critical user journeys
  #   - Creates/modifies test data (hence staging only)
  #   - Production uses nightly read-only workflow
  #
  # Story 4 Environment Alignment Gate:
  #   - Worker /env-status and GAS /whoami MUST return matching deploymentIds
  #   - Script ID must match expected staging/production Script ID
  #   - Environment name must be consistent
  #   - If alignment fails, ALL downstream tests are skipped (fail-fast)
  #
  # Story 6 Acceptance Criteria Met:
  #   - Any regression where Worker routes /events back to GAS:
  #     - Fails CI (via api-smoke job)
  #     - Blocks promotion to prod (via this gate)
  #   - CI job artifacts include HTML snippet for debugging
  #
  # Story 7 Acceptance Criteria Met (Production Only):
  #   - No GAS blue banner on /events
  #   - Admin UI visible
  #   - Network calls show /api/* only for data
  #   - All existing QR codes still resolve correctly
  #   - No increase in Worker or GAS error rates
  # ============================================================================
  validation-gate:
    name: ðŸš¦ Stage-2 Validation Gate (${{ needs.download-artifact.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [check-stage1, prod-approval-gate, download-artifact, preflight-health-check, env-alignment-gate, api-smoke, ui-smoke, e2e-tests, worker-cutover-validation]
    # Story 7: For production, requires approval gate to have succeeded or been skipped (staging)
    if: always() && needs.download-artifact.result == 'success'
    outputs:
      validation_status: ${{ steps.evaluate.outputs.status }}
      failure_reason: ${{ steps.evaluate.outputs.failure_reason }}

    steps:
      - name: Evaluate validation results
        id: evaluate
        env:
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
          ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
        run: |
          PREFLIGHT_RESULT="${{ needs.preflight-health-check.result }}"
          ENV_ALIGNMENT_RESULT="${{ needs.env-alignment-gate.result }}"
          API_RESULT="${{ needs.api-smoke.result }}"
          UI_RESULT="${{ needs.ui-smoke.result }}"
          E2E_RESULT="${{ needs.e2e-tests.result }}"
          WORKER_CUTOVER_RESULT="${{ needs.worker-cutover-validation.result }}"

          echo "=============================================="
          echo "STAGE-2 VALIDATION GATE EVALUATION (Story 2.5 + 3.4 + 4.2 + 6)"
          echo "=============================================="
          echo "Environment: $ENVIRONMENT"
          echo "Is Production: $IS_PRODUCTION"
          echo ""
          echo "Gate Results:"
          echo "  ðŸ¥ Pre-Flight Health: $PREFLIGHT_RESULT"
          echo "  ðŸ” Environment Alignment: $ENV_ALIGNMENT_RESULT"
          echo "  ðŸ”¥ API Smoke Tests: $API_RESULT"
          echo "  ðŸ–¥ï¸  UI Smoke Tests: $UI_RESULT"
          echo "  ðŸ§ª E2E Critical Journeys: $E2E_RESULT"
          echo "  ðŸ”„ Worker Cutover (4.2): $WORKER_CUTOVER_RESULT"
          echo "=============================================="

          # Story 6: Check pre-flight health first
          if [ "$PREFLIGHT_RESULT" != "success" ]; then
            echo ""
            echo "âŒ CRITICAL: Pre-flight health check failed!"
            echo "Staging/production environment is unavailable or unhealthy."
            echo "All downstream tests were skipped."
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "failure_reason=preflight_health" >> $GITHUB_OUTPUT

          # Story 2.5: Fail-fast evaluation
          # If alignment failed, mark overall as failed
          elif [ "$ENV_ALIGNMENT_RESULT" != "success" ]; then
            echo ""
            echo "âŒ CRITICAL: Environment alignment check failed!"
            echo "All downstream tests were skipped due to fail-fast."
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "failure_reason=env_alignment" >> $GITHUB_OUTPUT

          # Story 2.5: If API tests failed, UI tests should be skipped
          elif [ "$API_RESULT" != "success" ]; then
            echo ""
            echo "âŒ API smoke tests failed!"
            echo "UI smoke tests were skipped (progressive gate)."
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "failure_reason=api_tests" >> $GITHUB_OUTPUT

          # Story 2.5: If UI tests were skipped (but API passed), something is wrong
          elif [ "$UI_RESULT" == "skipped" ] && [ "$API_RESULT" == "success" ]; then
            echo ""
            echo "âš ï¸ UI tests skipped unexpectedly (API passed)"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "failure_reason=ui_skipped" >> $GITHUB_OUTPUT

          # UI tests failed
          elif [ "$UI_RESULT" != "success" ]; then
            echo ""
            echo "âŒ UI smoke tests failed!"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "failure_reason=ui_tests" >> $GITHUB_OUTPUT

          # Story 3.4: E2E tests failed (staging only)
          elif [ "$E2E_RESULT" == "failure" ]; then
            echo ""
            echo "âŒ E2E critical user journey tests failed!"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "failure_reason=e2e_tests" >> $GITHUB_OUTPUT

          # Story 4.2: Worker cutover validation failed (staging only)
          elif [ "$WORKER_CUTOVER_RESULT" == "failure" ]; then
            echo ""
            echo "âŒ Worker cutover validation failed!"
            echo "Production cutover is BLOCKED."
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "failure_reason=worker_cutover" >> $GITHUB_OUTPUT

          # Success case: All tests passed (E2E/Worker cutover skipped is OK for production)
          elif [ "$API_RESULT" == "success" ] && [ "$UI_RESULT" == "success" ]; then
            # E2E tests are skipped on production (expected), or passed on staging
            # Worker cutover validation is skipped on production (expected), or passed on staging
            if ([ "$E2E_RESULT" == "success" ] || [ "$E2E_RESULT" == "skipped" ]) && \
               ([ "$WORKER_CUTOVER_RESULT" == "success" ] || [ "$WORKER_CUTOVER_RESULT" == "skipped" ]); then
              echo ""
              echo "âœ… Stage-2 validation PASSED"
              if [ "$E2E_RESULT" == "skipped" ]; then
                echo "(E2E tests skipped - production deploy uses nightly workflow)"
              fi
              if [ "$WORKER_CUTOVER_RESULT" == "skipped" ]; then
                echo "(Worker cutover validation skipped - production uses existing Worker)"
              fi
              echo "status=passed" >> $GITHUB_OUTPUT
              echo "failure_reason=" >> $GITHUB_OUTPUT
            else
              echo ""
              echo "âŒ Tests in unexpected state: E2E=$E2E_RESULT, WorkerCutover=$WORKER_CUTOVER_RESULT"
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "failure_reason=unexpected_state" >> $GITHUB_OUTPUT
            fi

          # Catch-all failure
          else
            echo ""
            echo "âŒ Stage-2 validation FAILED (unexpected state)"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "failure_reason=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Create final summary
        env:
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
          ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
        run: |
          BASE_URL="${{ needs.download-artifact.outputs.base_url }}"
          PREFLIGHT_RESULT="${{ needs.preflight-health-check.result }}"
          ENV_ALIGNMENT_RESULT="${{ needs.env-alignment-gate.result }}"
          API_RESULT="${{ needs.api-smoke.result }}"
          UI_RESULT="${{ needs.ui-smoke.result }}"
          E2E_RESULT="${{ needs.e2e-tests.result }}"
          WORKER_CUTOVER_RESULT="${{ needs.worker-cutover-validation.result }}"
          STATUS="${{ steps.evaluate.outputs.status }}"
          FAILURE_REASON="${{ steps.evaluate.outputs.failure_reason }}"

          echo "# Stage-2 Orchestrator Results ($ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$STATUS" == "passed" ]; then
            echo "## âœ… DEPLOYMENT VALIDATED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Stage-2 validation passed. The $ENVIRONMENT deployment is verified." >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Story 6: /events Verified" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- /api/status returns ok:true" >> $GITHUB_STEP_SUMMARY
            echo "- /events returns HTTP 200" >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Story 4 Environment Alignment (Verified)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Worker /env-status and GAS /whoami deployment IDs match" >> $GITHUB_STEP_SUMMARY
            echo "- Script ID matches expected for $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
            echo "- Environment name is consistent" >> $GITHUB_STEP_SUMMARY

            if [ "$IS_PRODUCTION" != "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Story 3.4 E2E Critical Journeys (Verified)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- All 10 critical user journeys passed" >> $GITHUB_STEP_SUMMARY
              echo "- Event lifecycle validated (PRE-EVENT, EVENT, POST-EVENT)" >> $GITHUB_STEP_SUMMARY
              echo "- Test data cleanup successful" >> $GITHUB_STEP_SUMMARY

              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Story 4.2 Worker Cutover Validation (Verified)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- All surfaces (Public, Display, Poster) served by Worker" >> $GITHUB_STEP_SUMMARY
              echo "- Worker v2 API endpoints functional" >> $GITHUB_STEP_SUMMARY
              echo "- Cross-surface navigation works" >> $GITHUB_STEP_SUMMARY
              echo "- Production cutover is safe to proceed" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$IS_PRODUCTION" == "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Story 7 Production Acceptance Criteria" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- No GAS blue banner on /events" >> $GITHUB_STEP_SUMMARY
              echo "- Admin UI visible on /admin" >> $GITHUB_STEP_SUMMARY
              echo "- Worker HTML routing active" >> $GITHUB_STEP_SUMMARY
              echo "- /api/* used for JSON data only" >> $GITHUB_STEP_SUMMARY
              echo "- QR codes resolve correctly" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "â„¹ï¸ **Note:** E2E critical journeys skipped for production (uses nightly workflow)." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âŒ DEPLOYMENT BLOCKED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$FAILURE_REASON" == "preflight_health" ]; then
              echo "### ðŸ¥ STAGING/PRODUCTION UNAVAILABLE" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**The environment is globally down or unhealthy.**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "This is NOT a test failure - the environment cannot be reached" >> $GITHUB_STEP_SUMMARY
              echo "or /api/status returned ok:false." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "All downstream Stage-2 tests were skipped." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
              echo "1. Check Cloudflare dashboard for Worker status" >> $GITHUB_STEP_SUMMARY
              echo "2. Verify DNS configuration for $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
              echo "3. Review recent deployment logs" >> $GITHUB_STEP_SUMMARY
              echo "4. Check GAS backend health" >> $GITHUB_STEP_SUMMARY
            elif [ "$FAILURE_REASON" == "env_alignment" ]; then
              echo "### ðŸš¨ CRITICAL: Environment Alignment Failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**The Cloudflare Worker is pointing to the wrong GAS deployment!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "This is a critical configuration error. All downstream tests were" >> $GITHUB_STEP_SUMMARY
              echo "skipped because the environment is not properly aligned." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
              echo "1. Check Cloudflare Worker deployment configuration" >> $GITHUB_STEP_SUMMARY
              echo "2. Verify STAGING_DEPLOYMENT_ID or PROD_DEPLOYMENT_ID in wrangler.toml" >> $GITHUB_STEP_SUMMARY
              echo "3. Ensure CI deployed the Worker with the correct deployment ID" >> $GITHUB_STEP_SUMMARY
            elif [ "$FAILURE_REASON" == "e2e_tests" ]; then
              echo "### ðŸ§ª E2E Critical Journeys Failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "One or more critical user journeys failed." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Debugging:**" >> $GITHUB_STEP_SUMMARY
              echo "1. Download 'e2e-test-artifacts' for the HTML report" >> $GITHUB_STEP_SUMMARY
              echo "2. Download 'e2e-failure-debug' for videos and traces" >> $GITHUB_STEP_SUMMARY
              echo "3. See [E2E Playwright Guide](../docs/E2E_PLAYWRIGHT_GUIDE.md)" >> $GITHUB_STEP_SUMMARY
            elif [ "$FAILURE_REASON" == "worker_cutover" ]; then
              echo "### ðŸ”„ Worker Cutover Validation Failed (Story 4.2)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Staging is NOT fully Worker-backed. Production cutover is BLOCKED.**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Debugging:**" >> $GITHUB_STEP_SUMMARY
              echo "1. Download 'worker-cutover-results' artifact for details" >> $GITHUB_STEP_SUMMARY
              echo "2. Check Worker deployment configuration" >> $GITHUB_STEP_SUMMARY
              echo "3. Verify Worker v2 API routes are deployed" >> $GITHUB_STEP_SUMMARY
              echo "4. Check X-Backend headers on staging responses" >> $GITHUB_STEP_SUMMARY
            else
              echo "Stage-2 validation failed. Release is blocked until issues are resolved." >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$IS_PRODUCTION" == "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Rollback Required" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Production validation failed. See [docs/ROLLBACK.md](../docs/ROLLBACK.md) for recovery procedures." >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸ¥ Pre-Flight Health** | \`$PREFLIGHT_RESULT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸ” Environment Alignment** | \`$ENV_ALIGNMENT_RESULT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸ“¡ API Smoke Tests** | \`$API_RESULT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸ–¥ï¸ UI Smoke Tests** | \`$UI_RESULT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸ§ª E2E Critical Journeys** | \`$E2E_RESULT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸ”„ Worker Cutover (4.2)** | \`$WORKER_CUTOVER_RESULT\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`$ENVIRONMENT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target URL** | \`$BASE_URL\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Source Commit** | \`${{ github.event.workflow_run.head_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Stage-1 Run ID** | \`${{ github.event.workflow_run.id }}\` |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if validation failed
        if: steps.evaluate.outputs.status == 'failed'
        env:
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
          ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
        run: |
          echo "::error::Stage-2 validation failed for $ENVIRONMENT"
          echo ""
          echo "=============================================="
          echo "STAGE-2 VALIDATION FAILED ($ENVIRONMENT)"
          echo "=============================================="
          echo ""
          echo "One or more smoke test suites failed."
          echo "This blocks the release and signals red in GitHub."
          echo ""
          if [ "$IS_PRODUCTION" == "true" ]; then
            echo "PRODUCTION DEPLOYMENT BLOCKED"
            echo "See docs/ROLLBACK.md for recovery procedures."
          fi
          echo ""
          echo "Please review the test results and fix the issues."
          echo "=============================================="
          exit 1

  # ============================================================================
  # STORY 2.5: FAILURE NOTIFICATION (Stage-2)
  # ============================================================================
  # Sends immediate notification when Stage-2 validation fails.
  # This ensures the team knows immediately when:
  #   - API tests fail (critical - blocks UI tests)
  #   - UI tests fail
  #   - Environment alignment fails
  #   - Production deployment would be blocked
  #
  # Configured via secrets:
  #   - SLACK_WEBHOOK_URL: Slack incoming webhook for #deployments channel
  #   - TEAMS_WEBHOOK_URL: Microsoft Teams webhook (optional)
  # ============================================================================
  notify-stage2-failure:
    name: ðŸ“¢ Notify Stage-2 Failure
    runs-on: ubuntu-latest
    needs: [check-stage1, prod-approval-gate, download-artifact, preflight-health-check, env-alignment-gate, api-smoke, ui-smoke, e2e-tests, worker-cutover-validation, validation-gate]
    # Story 7: Include production approval gate in notification conditions
    # Story 4.2: Include worker-cutover-validation in notification conditions
    if: |
      always() &&
      (needs.download-artifact.result == 'success' || needs.prod-approval-gate.result == 'failure') &&
      (needs.preflight-health-check.result == 'failure' ||
       needs.env-alignment-gate.result == 'failure' ||
       needs.api-smoke.result == 'failure' ||
       needs.ui-smoke.result == 'failure' ||
       needs.e2e-tests.result == 'failure' ||
       needs.worker-cutover-validation.result == 'failure' ||
       needs.validation-gate.result == 'failure' ||
       needs.validation-gate.outputs.validation_status == 'failed' ||
       needs.prod-approval-gate.result == 'failure')

    steps:
      - name: Determine failure details
        id: failure-info
        env:
          ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
        run: |
          # Determine which test(s) failed
          FAILED_TESTS=""
          FAILURE_EMOJI="ðŸ”´"

          # Story 6: Pre-flight health check failure
          if [ "${{ needs.preflight-health-check.result }}" == "failure" ]; then
            FAILED_TESTS="${FAILED_TESTS}Pre-Flight Health (STAGING UNAVAILABLE), "
            FAILURE_EMOJI="ðŸ¥"
          fi
          if [ "${{ needs.env-alignment-gate.result }}" == "failure" ]; then
            FAILED_TESTS="${FAILED_TESTS}Environment Alignment (CRITICAL), "
            FAILURE_EMOJI="ðŸš¨"
          fi
          if [ "${{ needs.api-smoke.result }}" == "failure" ]; then
            FAILED_TESTS="${FAILED_TESTS}API Smoke Tests, "
          fi
          if [ "${{ needs.ui-smoke.result }}" == "failure" ]; then
            FAILED_TESTS="${FAILED_TESTS}UI Smoke Tests, "
          fi
          if [ "${{ needs.ui-smoke.result }}" == "skipped" ] && [ "${{ needs.api-smoke.result }}" != "success" ]; then
            FAILED_TESTS="${FAILED_TESTS}UI Tests SKIPPED (gated by API), "
          fi
          if [ "${{ needs.e2e-tests.result }}" == "failure" ]; then
            FAILED_TESTS="${FAILED_TESTS}E2E Critical Journeys, "
          fi
          if [ "${{ needs.worker-cutover-validation.result }}" == "failure" ]; then
            FAILED_TESTS="${FAILED_TESTS}Worker Cutover (4.2), "
          fi

          # Remove trailing comma and space
          FAILED_TESTS="${FAILED_TESTS%, }"

          # If nothing explicit, check validation-gate failure reason
          if [ -z "$FAILED_TESTS" ]; then
            FAILURE_REASON="${{ needs.validation-gate.outputs.failure_reason }}"
            case "$FAILURE_REASON" in
              env_alignment) FAILED_TESTS="Environment Alignment" ;;
              api_tests) FAILED_TESTS="API Smoke Tests" ;;
              ui_tests) FAILED_TESTS="UI Smoke Tests" ;;
              e2e_tests) FAILED_TESTS="E2E Critical Journeys" ;;
              worker_cutover) FAILED_TESTS="Worker Cutover (4.2)" ;;
              *) FAILED_TESTS="Validation Gate" ;;
            esac
          fi

          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "failure_emoji=$FAILURE_EMOJI" >> $GITHUB_OUTPUT
          echo "run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

          # Production flag for urgency
          if [ "$IS_PRODUCTION" == "true" ]; then
            echo "urgency=PRODUCTION BLOCKED" >> $GITHUB_OUTPUT
          else
            echo "urgency=Staging validation failed" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured, skipping Slack notification"
            exit 0
          fi

          # Determine color based on production vs staging
          if [ "$IS_PRODUCTION" == "true" ]; then
            COLOR="#FF0000"
            TITLE="ðŸš¨ PRODUCTION Stage-2 Validation Failed"
          else
            COLOR="#FFA500"
            TITLE="ðŸ”´ Stage-2 Validation Failed (Staging)"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "attachments": [{
                "color": "'"$COLOR"'",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "'"$TITLE"'",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Failed Test(s):*\n${{ steps.failure-info.outputs.failed_tests }}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Environment:*\n'"$ENVIRONMENT"'"
                      }
                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Target URL:*\n`${{ needs.download-artifact.outputs.base_url }}`"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Status:*\n${{ steps.failure-info.outputs.urgency }}"
                      }
                    ]
                  },
                  {
                    "type": "context",
                    "elements": [
                      {
                        "type": "mrkdwn",
                        "text": "Story 2.5: Progressive test gates - API tests gate UI tests"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow Run"
                        },
                        "style": "danger",
                        "url": "${{ steps.failure-info.outputs.run_url }}"
                      }
                    ]
                  }
                ]
              }]
            }' \
            "$SLACK_WEBHOOK_URL" || echo "Slack notification failed (non-critical)"

      - name: Send Microsoft Teams notification
        if: env.TEAMS_WEBHOOK_URL != ''
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
        run: |
          if [ -z "$TEAMS_WEBHOOK_URL" ]; then
            echo "TEAMS_WEBHOOK_URL not configured, skipping Teams notification"
            exit 0
          fi

          # Determine color based on production vs staging
          if [ "$IS_PRODUCTION" == "true" ]; then
            COLOR="FF0000"
            TITLE="ðŸš¨ PRODUCTION Stage-2 Validation Failed"
          else
            COLOR="FFA500"
            TITLE="ðŸ”´ Stage-2 Validation Failed (Staging)"
          fi

          curl -X POST -H 'Content-Type: application/json' \
            --data '{
              "@type": "MessageCard",
              "@context": "http://schema.org/extensions",
              "themeColor": "'"$COLOR"'",
              "summary": "'"$TITLE"'",
              "sections": [{
                "activityTitle": "'"$TITLE"'",
                "facts": [
                  {"name": "Failed Test(s)", "value": "${{ steps.failure-info.outputs.failed_tests }}"},
                  {"name": "Environment", "value": "'"$ENVIRONMENT"'"},
                  {"name": "Target URL", "value": "${{ needs.download-artifact.outputs.base_url }}"},
                  {"name": "Status", "value": "${{ steps.failure-info.outputs.urgency }}"}
                ],
                "markdown": true
              }],
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "View Workflow Run",
                "targets": [{"os": "default", "uri": "${{ steps.failure-info.outputs.run_url }}"}]
              }]
            }' \
            "$TEAMS_WEBHOOK_URL" || echo "Teams notification failed (non-critical)"

      - name: Create notification summary
        env:
          ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
        run: |
          echo "## ðŸ“¢ Stage-2 Failure Notification Sent (Story 2.5)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$IS_PRODUCTION" == "true" ]; then
            echo "### ðŸš¨ PRODUCTION DEPLOYMENT BLOCKED" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ”´ Staging Validation Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Test(s):** ${{ steps.failure-info.outputs.failed_tests }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Channel | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "| Slack | âœ… Sent |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Slack | âš ï¸ Not configured |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ secrets.TEAMS_WEBHOOK_URL }}" ]; then
            echo "| Teams | âœ… Sent |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Teams | âš ï¸ Not configured |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Story 2.5: Progressive Test Gates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The pipeline uses progressive test gates:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Environment Alignment** - Verifies Worker â†” GAS alignment" >> $GITHUB_STEP_SUMMARY
          echo "2. **API Smoke Tests** - If fails, UI tests are SKIPPED" >> $GITHUB_STEP_SUMMARY
          echo "3. **UI Smoke Tests** - Gated by API tests passing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This ensures immediate feedback and prevents wasted resources." >> $GITHUB_STEP_SUMMARY
