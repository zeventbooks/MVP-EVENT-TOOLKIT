# Stage-2 Orchestrator Workflow
#
# Purpose: Validates live staging AND production environments after Stage-1 deploys.
#          This closes the loop: Stage-1 deploys -> Stage-2 validates.
#
# Trigger: Runs automatically when Stage-1 Validation workflow succeeds.
#
# What it does:
#   - Staging (push to main): Downloads stg-base-url, runs full validation
#   - Production (tag push): Downloads prod-base-url, runs post-deploy sanity
#   - Runs API smoke tests against the live URL
#   - Runs UI smoke tests against the live URL (GATED by API tests)
#   - Validates HTML integrity (Story 6: blocks GAS HTML leaks)
#   - Validates Story 7 acceptance criteria for production
#   - Blocks release on any failure (authoritative deployment validator)
#
# Story 2.5 (DevOps): Progressive Test Gates
#   - API smoke tests run FIRST (critical gate)
#   - If API tests fail, UI tests are SKIPPED (fail-fast)
#   - If any staging test fails, production deployment is NOT successful
#   - Team notification sent immediately on gate failure
#
# Story 6 - GAS HTML Guardrails:
#   API smoke tests include gas-html-integrity.spec.ts which:
#   - Fetches /events and all HTML routes
#   - Validates response does NOT contain GAS HTML markers
#   - Saves HTML artifacts on failure for debugging
#   - Blocks promotion if GAS HTML is detected
#
# Story 7 - Production Promotion & Sanity:
#   Post-deploy production validation includes:
#   - Same HTML integrity checks used for staging
#   - No GAS blue banner on /events
#   - Admin UI visible
#   - Network calls use /api/* for JSON only
#   - QR codes still resolve to correct pages
#
# Contract Boundaries:
#   - Uses strict JSON schema checks from v4.1.2
#   - Validates stable routes only (no dev-only endpoints)
#   - Prevents broken posters, QR codes, events from going live
#   - Prevents GAS HTML shell from leaking to users
#
# System Impacts:
#   - Upstream: Validates deployment integrity from Stage-1
#   - Downstream: Prevents broken features from reaching users
#   - Rollback: If validation fails, see docs/ROLLBACK.md
#
# @see tests/api/smoke/ - API smoke test pack
# @see tests/api/smoke/gas-html-integrity.spec.ts - Story 6 GAS HTML guardrails
# @see tests/api/smoke/prod-sanity.spec.ts - Story 7 production sanity
# @see tests/ui/smoke/ - UI smoke test pack
# @see playwright.smoke.config.ts - API smoke configuration
# @see playwright.ui-smoke.config.ts - UI smoke configuration

name: Stage-2 Orchestrator

on:
  workflow_run:
    workflows:
      - "Stage-1 Validation"
    types:
      - completed

# Environment configuration - Standardized naming convention
# See config/deployment-ids.js for canonical source of truth
env:
  # Staging environment
  STAGING_URL: 'https://stg.eventangle.com'
  # Production environment (standardized naming)
  PROD_URL: 'https://www.eventangle.com'
  # Legacy alias (keeping for backward compatibility)
  PRODUCTION_URL: 'https://www.eventangle.com'

# Prevent duplicate runs for the same deployment
concurrency:
  group: stage2-orchestrator-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # GATE CHECK
  # ============================================================================
  # Only proceed if Stage-1 completed successfully.
  # Determines whether this is a staging (push to main) or production (tag) deploy.
  # This prevents running Stage-2 on failed deployments.
  # ============================================================================
  check-stage1:
    name: Check Stage-1 Status
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      stage1_conclusion: ${{ steps.check.outputs.conclusion }}
      deploy_type: ${{ steps.check.outputs.deploy_type }}
      is_production: ${{ steps.check.outputs.is_production }}

    steps:
      - name: Check Stage-1 conclusion and deploy type
        id: check
        run: |
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"

          echo "Stage-1 Validation conclusion: $CONCLUSION"
          echo "Head branch/tag: $HEAD_BRANCH"
          echo "conclusion=$CONCLUSION" >> $GITHUB_OUTPUT

          # Determine deploy type based on head branch (tag vs main)
          if [[ "$HEAD_BRANCH" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Detected PRODUCTION deployment (tag: $HEAD_BRANCH)"
            echo "deploy_type=production" >> $GITHUB_OUTPUT
            echo "is_production=true" >> $GITHUB_OUTPUT
          else
            echo "Detected STAGING deployment (branch: $HEAD_BRANCH)"
            echo "deploy_type=staging" >> $GITHUB_OUTPUT
            echo "is_production=false" >> $GITHUB_OUTPUT
          fi

          if [ "$CONCLUSION" == "success" ]; then
            echo "Stage-1 succeeded - proceeding with Stage-2 validation"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Stage-1 did not succeed (conclusion: $CONCLUSION)"
            echo "Stage-2 validation skipped - Stage-1 must succeed first"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Create skip summary
        if: steps.check.outputs.should_run != 'true'
        run: |
          echo "## Stage-2 Orchestrator - Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Stage-1 Validation did not succeed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Stage-1 Conclusion** | \`${{ github.event.workflow_run.conclusion }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deploy Type** | \`${{ steps.check.outputs.deploy_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow Run** | \`${{ github.event.workflow_run.id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Head SHA** | \`${{ github.event.workflow_run.head_sha }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ARTIFACT DOWNLOAD
  # ============================================================================
  # Downloads the appropriate base-url artifact from Stage-1:
  #   - Staging deploy (main push): stg-base-url
  #   - Production deploy (tag push): prod-base-url
  # ============================================================================
  download-artifact:
    name: Download Base URL
    runs-on: ubuntu-latest
    needs: check-stage1
    if: needs.check-stage1.outputs.should_run == 'true'
    outputs:
      base_url: ${{ steps.extract.outputs.base_url }}
      environment: ${{ steps.extract.outputs.environment }}

    steps:
      # Use dawidd6/action-download-artifact for cross-workflow artifact downloads
      # The official actions/download-artifact@v4 does NOT support downloading
      # artifacts from a different workflow run (even with run-id parameter).
      - name: Download staging artifact
        if: needs.check-stage1.outputs.is_production != 'true'
        uses: dawidd6/action-download-artifact@v6
        with:
          name: stg-base-url
          run_id: ${{ github.event.workflow_run.id }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: stage1.yml

      - name: Download production artifact
        if: needs.check-stage1.outputs.is_production == 'true'
        uses: dawidd6/action-download-artifact@v6
        with:
          name: prod-base-url
          run_id: ${{ github.event.workflow_run.id }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: stage1.yml

      - name: Extract and validate BASE_URL
        id: extract
        env:
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
        run: |
          # Determine which file to read based on deploy type
          if [ "$IS_PRODUCTION" == "true" ]; then
            ARTIFACT_FILE="prod-base-url.txt"
            ENV_NAME="production"
          else
            ARTIFACT_FILE="stg-base-url.txt"
            ENV_NAME="staging"
          fi

          if [ ! -f "$ARTIFACT_FILE" ]; then
            echo "::error::$ARTIFACT_FILE not found in artifact"
            exit 1
          fi

          BASE_URL=$(cat "$ARTIFACT_FILE" | tr -d '\n')

          # Validate URL format
          if [[ ! "$BASE_URL" =~ ^https:// ]]; then
            echo "::error::Invalid BASE_URL format: $BASE_URL (must start with https://)"
            exit 1
          fi

          echo "Extracted BASE_URL: $BASE_URL"
          echo "Environment: $ENV_NAME"
          echo "base_url=$BASE_URL" >> $GITHUB_OUTPUT
          echo "environment=$ENV_NAME" >> $GITHUB_OUTPUT

      - name: Create artifact summary
        run: |
          echo "## Stage-2 Artifact Download" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully downloaded ${{ steps.extract.outputs.environment }} URL artifact." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`${{ steps.extract.outputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Base URL** | \`${{ steps.extract.outputs.base_url }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Source Workflow Run** | \`${{ github.event.workflow_run.id }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ENVIRONMENT ALIGNMENT GATE (Story 4 - Critical First Gate)
  # ============================================================================
  # MUST run FIRST before any other tests. Verifies Worker â†” GAS alignment.
  # This is the critical fail-fast gate that prevents deployment mismatches.
  #
  # Checks performed:
  #   - Worker /env-status returns correct environment (staging/production)
  #   - GAS /whoami returns correct scriptId and deploymentId
  #   - Worker deploymentId matches GAS deploymentId (CRITICAL)
  #   - Script ID matches expected staging/production Script ID
  #   - Account email contains "zeventbook"
  #
  # If ANY check fails:
  #   - Pipeline FAILS IMMEDIATELY
  #   - All downstream tests are SKIPPED
  #   - Promotion to production is BLOCKED
  #
  # @see tests/api/smoke/env-alignment.spec.ts
  # ============================================================================
  env-alignment-gate:
    name: ðŸ” Environment Alignment Gate (${{ needs.download-artifact.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [check-stage1, download-artifact]
    outputs:
      alignment_status: ${{ steps.alignment-check.outputs.status }}
      worker_deployment_id: ${{ steps.alignment-check.outputs.worker_deployment_id }}
      gas_deployment_id: ${{ steps.alignment-check.outputs.gas_deployment_id }}
    env:
      BASE_URL: ${{ needs.download-artifact.outputs.base_url }}
      ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
      IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
      CI: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Display alignment check configuration
        run: |
          echo "=============================================="
          echo "ENVIRONMENT ALIGNMENT GATE (Story 4)"
          echo "=============================================="
          echo "Environment: $ENVIRONMENT"
          echo "BASE_URL: $BASE_URL"
          echo "Is Production: $IS_PRODUCTION"
          echo ""
          echo "This gate verifies:"
          echo "  - Worker /env-status and GAS /whoami alignment"
          echo "  - Deployment IDs match between Worker and GAS"
          echo "  - Script ID matches expected for environment"
          echo "  - Environment name is consistent"
          echo ""
          echo "FAILURE = IMMEDIATE PIPELINE ABORT"
          echo "=============================================="

      - name: Run Environment Alignment Tests
        id: alignment-check
        run: |
          echo "Running environment alignment tests against: $BASE_URL"

          # Run alignment tests with verbose output
          set +e
          OUTPUT=$(npx playwright test tests/api/smoke/env-alignment.spec.ts --project=chromium --reporter=list 2>&1)
          EXIT_CODE=$?
          set -e

          echo "$OUTPUT"

          # Extract deployment IDs from test output if available
          WORKER_ID=$(echo "$OUTPUT" | grep -oP 'deploymentId.*?AKfycb[a-zA-Z0-9_-]+' | head -1 | grep -oP 'AKfycb[a-zA-Z0-9_-]+' || echo "unknown")
          GAS_ID=$(echo "$OUTPUT" | grep -oP 'gas.*deploymentId.*?AKfycb[a-zA-Z0-9_-]+' | head -1 | grep -oP 'AKfycb[a-zA-Z0-9_-]+' || echo "unknown")

          echo "worker_deployment_id=$WORKER_ID" >> $GITHUB_OUTPUT
          echo "gas_deployment_id=$GAS_ID" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ… ENVIRONMENT ALIGNMENT: PASS"
            echo "Worker and GAS deployment IDs are aligned."
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo ""
            echo "âŒ ENVIRONMENT ALIGNMENT: FAIL"
            echo "Worker and GAS deployment mismatch detected!"
            echo ""
            echo "This blocks all downstream tests and deployment promotion."
            exit 1
          fi

      - name: Upload alignment test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: env-alignment-results-${{ env.ENVIRONMENT }}
          path: |
            playwright-report-smoke/
            .test-results/smoke-*.json
          retention-days: 7

      - name: Create alignment gate summary
        if: always()
        run: |
          echo "## ðŸ” Environment Alignment Gate ($ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          STATUS="${{ steps.alignment-check.outputs.status }}"
          WORKER_ID="${{ steps.alignment-check.outputs.worker_deployment_id }}"
          GAS_ID="${{ steps.alignment-check.outputs.gas_deployment_id }}"

          if [ "$STATUS" == "passed" ]; then
            echo "### âœ… ALIGNED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Worker â†” GAS deployment alignment verified." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ MISALIGNED - PIPELINE BLOCKED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**CRITICAL:** Worker and GAS deployment mismatch detected!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This indicates the Cloudflare Worker is pointing to the wrong" >> $GITHUB_STEP_SUMMARY
            echo "Google Apps Script deployment. All downstream tests are SKIPPED." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`$ENVIRONMENT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target URL** | \`$BASE_URL\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Worker Deployment ID** | \`$WORKER_ID\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **GAS Deployment ID** | \`$GAS_ID\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **IDs Match** | \`$([ \"$WORKER_ID\" == \"$GAS_ID\" ] && echo 'Yes âœ…' || echo 'No âŒ')\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # API SMOKE TESTS (CRITICAL GATE)
  # ============================================================================
  # Validates API contract compliance against the live environment.
  # Tests: status, events, qr, sharedreport endpoints
  # Uses strict v4.1.2 JSON schema validation.
  #
  # DEPENDS ON: env-alignment-gate (fail-fast - skipped if alignment fails)
  #
  # Story 2.5: Progressive Test Gate
  #   - API smoke tests are the FIRST test gate after env-alignment
  #   - If API tests fail, UI tests are SKIPPED (gated)
  #   - This saves resources and provides immediate feedback
  #
  # Story 6 GAS HTML Guardrails (gas-html-integrity.spec.ts):
  #   - Fetches /events and all HTML routes
  #   - Validates NO GAS HTML markers in response
  #   - Blocks deploy if "Google Apps Script user" message found
  #   - Blocks deploy if warden scripts detected
  #   - Saves HTML artifacts on failure for debugging
  #
  # Story 7 Production Sanity (prod-sanity.spec.ts - production only):
  #   - Additional production-specific validation
  #   - Network request monitoring
  #   - QR code resolution verification
  # ============================================================================
  api-smoke:
    name: ðŸ”¥ API Smoke Tests (${{ needs.download-artifact.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [check-stage1, download-artifact, env-alignment-gate]
    outputs:
      api_test_result: ${{ steps.api-tests.outcome }}
    env:
      BASE_URL: ${{ needs.download-artifact.outputs.base_url }}
      ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
      IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
      CI: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Display test configuration
        run: |
          echo "=============================================="
          echo "API SMOKE TEST CONFIGURATION"
          echo "=============================================="
          echo "Environment: $ENVIRONMENT"
          echo "BASE_URL: $BASE_URL"
          echo "Is Production: $IS_PRODUCTION"
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "=============================================="

      - name: Run API smoke tests
        id: api-tests
        run: |
          echo "Running API smoke tests against: $BASE_URL ($ENVIRONMENT)"
          npm run test:api:smoke
        continue-on-error: true

      - name: Run production sanity tests (Story 7)
        id: prod-sanity
        if: env.IS_PRODUCTION == 'true'
        run: |
          echo "=============================================="
          echo "STORY 7 - PRODUCTION SANITY TESTS"
          echo "=============================================="
          echo "Running production-specific validation..."
          echo "Target: $BASE_URL"
          echo "=============================================="

          # Run production sanity tests if they exist
          if [ -f "tests/api/smoke/prod-sanity.spec.ts" ]; then
            npx playwright test tests/api/smoke/prod-sanity.spec.ts --project=chromium --reporter=list
          else
            echo "prod-sanity.spec.ts not found, skipping production sanity tests"
            echo "This is expected for initial Story 7 deployment"
          fi
        continue-on-error: true

      - name: Upload API smoke test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-smoke-results-${{ env.ENVIRONMENT }}
          path: |
            playwright-report-smoke/
            .test-results/smoke-*.json
            .test-results/smoke-*.xml
            .test-results/gas-html-artifacts/
          retention-days: 7

      - name: Check API smoke test result
        if: steps.api-tests.outcome == 'failure'
        run: |
          echo "::error::API smoke tests failed against $BASE_URL ($ENVIRONMENT)"
          echo ""
          echo "Stage-2 API validation failed. This blocks the release."
          echo "Check the API smoke test results artifact for details."
          exit 1

      - name: Check production sanity result (Story 7)
        if: env.IS_PRODUCTION == 'true' && steps.prod-sanity.outcome == 'failure'
        run: |
          echo "::error::Production sanity tests failed (Story 7)"
          echo ""
          echo "Production validation failed. This blocks the release."
          echo "See docs/ROLLBACK.md for recovery procedures."
          exit 1

      - name: Create API smoke summary
        if: always()
        run: |
          echo "## API Smoke Tests ($ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.api-tests.outcome }}" == "success" ]; then
            echo "### PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All API smoke tests passed against $ENVIRONMENT." >> $GITHUB_STEP_SUMMARY
          else
            echo "### FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "API smoke tests failed. Check test results for details." >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$IS_PRODUCTION" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Story 7 Production Sanity:** \`${{ steps.prod-sanity.outcome }}\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`$ENVIRONMENT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target URL** | \`$BASE_URL\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **API Tests** | \`${{ steps.api-tests.outcome }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # UI SMOKE TESTS (GATED BY API TESTS)
  # ============================================================================
  # Validates UI surfaces against the live environment.
  # Tests: Admin, Public, Display, Poster surfaces
  # Principle: "If you show it, it works"
  #
  # DEPENDS ON: api-smoke (fail-fast - SKIPPED if API tests fail)
  #
  # Story 2.5: Progressive Test Gate
  #   - UI smoke tests are GATED by API smoke tests
  #   - If API tests fail, this job is SKIPPED (fail-fast)
  #   - E2E tests don't run when earlier gates failed
  #   - Saves CI resources on doomed deployments
  #
  # Story 7 Production Validation:
  #   - Admin UI visible on /admin
  #   - No GAS blue banner on /events
  #   - QR codes render correctly on Poster
  # ============================================================================
  ui-smoke:
    name: ðŸ–¥ï¸ UI Smoke Tests (${{ needs.download-artifact.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [check-stage1, download-artifact, env-alignment-gate, api-smoke]  # Story 2.5: Depends on API tests
    if: needs.api-smoke.result == 'success'  # Story 2.5: Skip if API tests failed
    env:
      BASE_URL: ${{ needs.download-artifact.outputs.base_url }}
      ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
      IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
      CI: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Display test configuration
        run: |
          echo "=============================================="
          echo "UI SMOKE TEST CONFIGURATION"
          echo "=============================================="
          echo "Environment: $ENVIRONMENT"
          echo "BASE_URL: $BASE_URL"
          echo "Is Production: $IS_PRODUCTION"
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "=============================================="

      - name: Run UI smoke tests
        id: ui-tests
        run: |
          echo "Running UI smoke tests against: $BASE_URL ($ENVIRONMENT)"
          npm run test:ui:smoke
        continue-on-error: true

      - name: Upload UI smoke test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-smoke-results-${{ env.ENVIRONMENT }}
          path: |
            playwright-report-ui-smoke/
            .test-results/ui-smoke-*.json
            .test-results/ui-smoke-*.xml
          retention-days: 7

      - name: Check UI smoke test result
        if: steps.ui-tests.outcome == 'failure'
        run: |
          echo "::error::UI smoke tests failed against $BASE_URL ($ENVIRONMENT)"
          echo ""
          echo "Stage-2 UI validation failed. This blocks the release."
          echo "Check the UI smoke test results artifact for details."
          if [ "$IS_PRODUCTION" == "true" ]; then
            echo "See docs/ROLLBACK.md for recovery procedures."
          fi
          exit 1

      - name: Create UI smoke summary
        if: always()
        run: |
          echo "## UI Smoke Tests ($ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.ui-tests.outcome }}" == "success" ]; then
            echo "### PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All UI smoke tests passed against $ENVIRONMENT." >> $GITHUB_STEP_SUMMARY
          else
            echo "### FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "UI smoke tests failed. Check test results for details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`$ENVIRONMENT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target URL** | \`$BASE_URL\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Result** | \`${{ steps.ui-tests.outcome }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # FINAL VALIDATION GATE
  # ============================================================================
  # Aggregates results from all Stage-2 tests.
  # This is the authoritative deployment validator.
  # Failure here blocks the release and signals red in GitHub.
  #
  # Story 2.5: Progressive Test Gates
  #   - If API tests fail, UI tests are skipped (result = 'skipped')
  #   - Skipped UI tests due to API failure = overall FAILURE
  #   - This ensures production is blocked when staging tests fail
  #
  # Story 4 Environment Alignment Gate:
  #   - Worker /env-status and GAS /whoami MUST return matching deploymentIds
  #   - Script ID must match expected staging/production Script ID
  #   - Environment name must be consistent
  #   - If alignment fails, ALL downstream tests are skipped (fail-fast)
  #
  # Story 6 Acceptance Criteria Met:
  #   - Any regression where Worker routes /events back to GAS:
  #     - Fails CI (via api-smoke job)
  #     - Blocks promotion to prod (via this gate)
  #   - CI job artifacts include HTML snippet for debugging
  #
  # Story 7 Acceptance Criteria Met (Production Only):
  #   - No GAS blue banner on /events
  #   - Admin UI visible
  #   - Network calls show /api/* only for data
  #   - All existing QR codes still resolve correctly
  #   - No increase in Worker or GAS error rates
  # ============================================================================
  validation-gate:
    name: ðŸš¦ Stage-2 Validation Gate (${{ needs.download-artifact.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [check-stage1, download-artifact, env-alignment-gate, api-smoke, ui-smoke]
    if: always() && needs.download-artifact.result == 'success'
    outputs:
      validation_status: ${{ steps.evaluate.outputs.status }}
      failure_reason: ${{ steps.evaluate.outputs.failure_reason }}

    steps:
      - name: Evaluate validation results
        id: evaluate
        env:
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
          ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
        run: |
          ENV_ALIGNMENT_RESULT="${{ needs.env-alignment-gate.result }}"
          API_RESULT="${{ needs.api-smoke.result }}"
          UI_RESULT="${{ needs.ui-smoke.result }}"

          echo "=============================================="
          echo "STAGE-2 VALIDATION GATE EVALUATION (Story 2.5)"
          echo "=============================================="
          echo "Environment: $ENVIRONMENT"
          echo "Is Production: $IS_PRODUCTION"
          echo ""
          echo "Gate Results:"
          echo "  ðŸ” Environment Alignment: $ENV_ALIGNMENT_RESULT"
          echo "  ðŸ”¥ API Smoke Tests: $API_RESULT"
          echo "  ðŸ–¥ï¸  UI Smoke Tests: $UI_RESULT"
          echo "=============================================="

          # Story 2.5: Fail-fast evaluation
          # If alignment failed, mark overall as failed
          if [ "$ENV_ALIGNMENT_RESULT" != "success" ]; then
            echo ""
            echo "âŒ CRITICAL: Environment alignment check failed!"
            echo "All downstream tests were skipped due to fail-fast."
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "failure_reason=env_alignment" >> $GITHUB_OUTPUT

          # Story 2.5: If API tests failed, UI tests should be skipped
          elif [ "$API_RESULT" != "success" ]; then
            echo ""
            echo "âŒ API smoke tests failed!"
            echo "UI smoke tests were skipped (progressive gate)."
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "failure_reason=api_tests" >> $GITHUB_OUTPUT

          # Story 2.5: If UI tests were skipped (but API passed), something is wrong
          elif [ "$UI_RESULT" == "skipped" ] && [ "$API_RESULT" == "success" ]; then
            echo ""
            echo "âš ï¸ UI tests skipped unexpectedly (API passed)"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "failure_reason=ui_skipped" >> $GITHUB_OUTPUT

          # Normal success case: both API and UI passed
          elif [ "$API_RESULT" == "success" ] && [ "$UI_RESULT" == "success" ]; then
            echo ""
            echo "âœ… Stage-2 validation PASSED"
            echo "status=passed" >> $GITHUB_OUTPUT
            echo "failure_reason=" >> $GITHUB_OUTPUT

          # UI tests failed
          elif [ "$UI_RESULT" != "success" ]; then
            echo ""
            echo "âŒ UI smoke tests failed!"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "failure_reason=ui_tests" >> $GITHUB_OUTPUT

          # Catch-all failure
          else
            echo ""
            echo "âŒ Stage-2 validation FAILED (unexpected state)"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "failure_reason=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Create final summary
        env:
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
          ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
        run: |
          BASE_URL="${{ needs.download-artifact.outputs.base_url }}"
          ENV_ALIGNMENT_RESULT="${{ needs.env-alignment-gate.result }}"
          API_RESULT="${{ needs.api-smoke.result }}"
          UI_RESULT="${{ needs.ui-smoke.result }}"
          STATUS="${{ steps.evaluate.outputs.status }}"
          FAILURE_REASON="${{ steps.evaluate.outputs.failure_reason }}"

          echo "# Stage-2 Orchestrator Results ($ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$STATUS" == "passed" ]; then
            echo "## âœ… DEPLOYMENT VALIDATED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Stage-2 validation passed. The $ENVIRONMENT deployment is verified." >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Story 4 Environment Alignment (Verified)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Worker /env-status and GAS /whoami deployment IDs match" >> $GITHUB_STEP_SUMMARY
            echo "- Script ID matches expected for $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
            echo "- Environment name is consistent" >> $GITHUB_STEP_SUMMARY

            if [ "$IS_PRODUCTION" == "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Story 7 Production Acceptance Criteria" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- No GAS blue banner on /events" >> $GITHUB_STEP_SUMMARY
              echo "- Admin UI visible on /admin" >> $GITHUB_STEP_SUMMARY
              echo "- Worker HTML routing active" >> $GITHUB_STEP_SUMMARY
              echo "- /api/* used for JSON data only" >> $GITHUB_STEP_SUMMARY
              echo "- QR codes resolve correctly" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âŒ DEPLOYMENT BLOCKED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$FAILURE_REASON" == "env_alignment" ]; then
              echo "### ðŸš¨ CRITICAL: Environment Alignment Failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**The Cloudflare Worker is pointing to the wrong GAS deployment!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "This is a critical configuration error. All downstream tests were" >> $GITHUB_STEP_SUMMARY
              echo "skipped because the environment is not properly aligned." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
              echo "1. Check Cloudflare Worker deployment configuration" >> $GITHUB_STEP_SUMMARY
              echo "2. Verify STAGING_DEPLOYMENT_ID or PROD_DEPLOYMENT_ID in wrangler.toml" >> $GITHUB_STEP_SUMMARY
              echo "3. Ensure CI deployed the Worker with the correct deployment ID" >> $GITHUB_STEP_SUMMARY
            else
              echo "Stage-2 validation failed. Release is blocked until issues are resolved." >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$IS_PRODUCTION" == "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Rollback Required" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Production validation failed. See [docs/ROLLBACK.md](../docs/ROLLBACK.md) for recovery procedures." >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸ” Environment Alignment** | \`$ENV_ALIGNMENT_RESULT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸ“¡ API Smoke Tests** | \`$API_RESULT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸ–¥ï¸ UI Smoke Tests** | \`$UI_RESULT\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`$ENVIRONMENT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target URL** | \`$BASE_URL\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Source Commit** | \`${{ github.event.workflow_run.head_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Stage-1 Run ID** | \`${{ github.event.workflow_run.id }}\` |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if validation failed
        if: steps.evaluate.outputs.status == 'failed'
        env:
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
          ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
        run: |
          echo "::error::Stage-2 validation failed for $ENVIRONMENT"
          echo ""
          echo "=============================================="
          echo "STAGE-2 VALIDATION FAILED ($ENVIRONMENT)"
          echo "=============================================="
          echo ""
          echo "One or more smoke test suites failed."
          echo "This blocks the release and signals red in GitHub."
          echo ""
          if [ "$IS_PRODUCTION" == "true" ]; then
            echo "PRODUCTION DEPLOYMENT BLOCKED"
            echo "See docs/ROLLBACK.md for recovery procedures."
          fi
          echo ""
          echo "Please review the test results and fix the issues."
          echo "=============================================="
          exit 1

  # ============================================================================
  # STORY 2.5: FAILURE NOTIFICATION (Stage-2)
  # ============================================================================
  # Sends immediate notification when Stage-2 validation fails.
  # This ensures the team knows immediately when:
  #   - API tests fail (critical - blocks UI tests)
  #   - UI tests fail
  #   - Environment alignment fails
  #   - Production deployment would be blocked
  #
  # Configured via secrets:
  #   - SLACK_WEBHOOK_URL: Slack incoming webhook for #deployments channel
  #   - TEAMS_WEBHOOK_URL: Microsoft Teams webhook (optional)
  # ============================================================================
  notify-stage2-failure:
    name: ðŸ“¢ Notify Stage-2 Failure
    runs-on: ubuntu-latest
    needs: [check-stage1, download-artifact, env-alignment-gate, api-smoke, ui-smoke, validation-gate]
    if: |
      always() &&
      needs.download-artifact.result == 'success' &&
      (needs.env-alignment-gate.result == 'failure' ||
       needs.api-smoke.result == 'failure' ||
       needs.ui-smoke.result == 'failure' ||
       needs.validation-gate.result == 'failure' ||
       needs.validation-gate.outputs.validation_status == 'failed')

    steps:
      - name: Determine failure details
        id: failure-info
        env:
          ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
        run: |
          # Determine which test(s) failed
          FAILED_TESTS=""
          FAILURE_EMOJI="ðŸ”´"

          if [ "${{ needs.env-alignment-gate.result }}" == "failure" ]; then
            FAILED_TESTS="${FAILED_TESTS}Environment Alignment (CRITICAL), "
            FAILURE_EMOJI="ðŸš¨"
          fi
          if [ "${{ needs.api-smoke.result }}" == "failure" ]; then
            FAILED_TESTS="${FAILED_TESTS}API Smoke Tests, "
          fi
          if [ "${{ needs.ui-smoke.result }}" == "failure" ]; then
            FAILED_TESTS="${FAILED_TESTS}UI Smoke Tests, "
          fi
          if [ "${{ needs.ui-smoke.result }}" == "skipped" ] && [ "${{ needs.api-smoke.result }}" != "success" ]; then
            FAILED_TESTS="${FAILED_TESTS}UI Tests SKIPPED (gated by API), "
          fi

          # Remove trailing comma and space
          FAILED_TESTS="${FAILED_TESTS%, }"

          # If nothing explicit, check validation-gate failure reason
          if [ -z "$FAILED_TESTS" ]; then
            FAILURE_REASON="${{ needs.validation-gate.outputs.failure_reason }}"
            case "$FAILURE_REASON" in
              env_alignment) FAILED_TESTS="Environment Alignment" ;;
              api_tests) FAILED_TESTS="API Smoke Tests" ;;
              ui_tests) FAILED_TESTS="UI Smoke Tests" ;;
              *) FAILED_TESTS="Validation Gate" ;;
            esac
          fi

          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "failure_emoji=$FAILURE_EMOJI" >> $GITHUB_OUTPUT
          echo "run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

          # Production flag for urgency
          if [ "$IS_PRODUCTION" == "true" ]; then
            echo "urgency=PRODUCTION BLOCKED" >> $GITHUB_OUTPUT
          else
            echo "urgency=Staging validation failed" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured, skipping Slack notification"
            exit 0
          fi

          # Determine color based on production vs staging
          if [ "$IS_PRODUCTION" == "true" ]; then
            COLOR="#FF0000"
            TITLE="ðŸš¨ PRODUCTION Stage-2 Validation Failed"
          else
            COLOR="#FFA500"
            TITLE="ðŸ”´ Stage-2 Validation Failed (Staging)"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "attachments": [{
                "color": "'"$COLOR"'",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "'"$TITLE"'",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Failed Test(s):*\n${{ steps.failure-info.outputs.failed_tests }}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Environment:*\n'"$ENVIRONMENT"'"
                      }
                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Target URL:*\n`${{ needs.download-artifact.outputs.base_url }}`"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Status:*\n${{ steps.failure-info.outputs.urgency }}"
                      }
                    ]
                  },
                  {
                    "type": "context",
                    "elements": [
                      {
                        "type": "mrkdwn",
                        "text": "Story 2.5: Progressive test gates - API tests gate UI tests"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow Run"
                        },
                        "style": "danger",
                        "url": "${{ steps.failure-info.outputs.run_url }}"
                      }
                    ]
                  }
                ]
              }]
            }' \
            "$SLACK_WEBHOOK_URL" || echo "Slack notification failed (non-critical)"

      - name: Send Microsoft Teams notification
        if: env.TEAMS_WEBHOOK_URL != ''
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
        run: |
          if [ -z "$TEAMS_WEBHOOK_URL" ]; then
            echo "TEAMS_WEBHOOK_URL not configured, skipping Teams notification"
            exit 0
          fi

          # Determine color based on production vs staging
          if [ "$IS_PRODUCTION" == "true" ]; then
            COLOR="FF0000"
            TITLE="ðŸš¨ PRODUCTION Stage-2 Validation Failed"
          else
            COLOR="FFA500"
            TITLE="ðŸ”´ Stage-2 Validation Failed (Staging)"
          fi

          curl -X POST -H 'Content-Type: application/json' \
            --data '{
              "@type": "MessageCard",
              "@context": "http://schema.org/extensions",
              "themeColor": "'"$COLOR"'",
              "summary": "'"$TITLE"'",
              "sections": [{
                "activityTitle": "'"$TITLE"'",
                "facts": [
                  {"name": "Failed Test(s)", "value": "${{ steps.failure-info.outputs.failed_tests }}"},
                  {"name": "Environment", "value": "'"$ENVIRONMENT"'"},
                  {"name": "Target URL", "value": "${{ needs.download-artifact.outputs.base_url }}"},
                  {"name": "Status", "value": "${{ steps.failure-info.outputs.urgency }}"}
                ],
                "markdown": true
              }],
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "View Workflow Run",
                "targets": [{"os": "default", "uri": "${{ steps.failure-info.outputs.run_url }}"}]
              }]
            }' \
            "$TEAMS_WEBHOOK_URL" || echo "Teams notification failed (non-critical)"

      - name: Create notification summary
        env:
          ENVIRONMENT: ${{ needs.download-artifact.outputs.environment }}
          IS_PRODUCTION: ${{ needs.check-stage1.outputs.is_production }}
        run: |
          echo "## ðŸ“¢ Stage-2 Failure Notification Sent (Story 2.5)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$IS_PRODUCTION" == "true" ]; then
            echo "### ðŸš¨ PRODUCTION DEPLOYMENT BLOCKED" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ”´ Staging Validation Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Test(s):** ${{ steps.failure-info.outputs.failed_tests }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Channel | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "| Slack | âœ… Sent |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Slack | âš ï¸ Not configured |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ secrets.TEAMS_WEBHOOK_URL }}" ]; then
            echo "| Teams | âœ… Sent |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Teams | âš ï¸ Not configured |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Story 2.5: Progressive Test Gates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The pipeline uses progressive test gates:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Environment Alignment** - Verifies Worker â†” GAS alignment" >> $GITHUB_STEP_SUMMARY
          echo "2. **API Smoke Tests** - If fails, UI tests are SKIPPED" >> $GITHUB_STEP_SUMMARY
          echo "3. **UI Smoke Tests** - Gated by API tests passing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This ensures immediate feedback and prevents wasted resources." >> $GITHUB_STEP_SUMMARY
