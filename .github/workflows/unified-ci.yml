# Unified CI Pipeline - Foolproof Apps Script Deployment & Testing
#
# This workflow eliminates flakiness by:
# 1. Using Apps Script API directly (not regex parsing clasp output)
# 2. Warming up the deployment before ANY tests run
# 3. Using job outputs instead of artifacts (no download failures)
# 4. Running all stages in a single workflow (no workflow_run timing issues)
#
# Stages:
#   1. Validate  - ESLint + Unit Tests + Contract Tests
#   2. Deploy    - Push to Apps Script + Create Deployment
#   3. Warmup    - Hit status endpoints until 200 OK (eliminates cold starts)
#   4. Test      - API Tests â†’ Smoke Tests â†’ Expensive Tests
#   5. Gate      - Final quality validation

name: Unified CI Pipeline

on:
  push:
    branches:
      - main
      - 'release/**'
      - 'release/*'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_deploy:
        description: 'Skip deployment (test existing deployment)'
        type: boolean
        default: false
      deployment_url:
        description: 'Override deployment URL (for testing specific deployments)'
        type: string
        default: ''

# Prevent duplicate runs
concurrency:
  group: unified-ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  # Default to Cloudflare proxy URL for production
  DEFAULT_DEPLOYMENT_URL: 'https://www.eventangle.com'

jobs:
  # ============================================================================
  # STAGE 1: VALIDATE (Code Quality + Unit Tests + Contracts)
  # ============================================================================

  validate:
    name: "1ï¸âƒ£ Validate"
    runs-on: ubuntu-latest
    outputs:
      validation_passed: ${{ steps.validate.outputs.passed }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run validation suite
        id: validate
        run: |
          echo "ğŸ” Running validation suite..."
          echo ""

          # ESLint
          echo "ğŸ“‹ ESLint..."
          npm run lint
          echo ""

          # Unit Tests
          echo "ğŸ§ª Unit Tests..."
          npm run test:unit
          echo ""

          # Contract Tests
          echo "ğŸ“œ Contract Tests..."
          npm run test:contract
          echo ""

          # MVP Guards
          echo "ğŸ›¡ï¸ MVP Guards..."
          node scripts/check-surfaces.js
          node scripts/check-dead-code.js --fail-on-dead
          node scripts/check-v2-files.js
          echo ""

          echo "passed=true" >> $GITHUB_OUTPUT
          echo "âœ… All validations passed!"

  # ============================================================================
  # STAGE 2: DEPLOY (Push to Apps Script + Get Deployment URL)
  # ============================================================================

  deploy:
    name: "2ï¸âƒ£ Deploy"
    runs-on: ubuntu-latest
    needs: validate
    if: |
      needs.validate.outputs.validation_passed == 'true' &&
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')) &&
      inputs.skip_deploy != true
    outputs:
      deployment_url: ${{ steps.deploy.outputs.url }}
      deployment_id: ${{ steps.deploy.outputs.deployment_id }}
      cloudflare_url: ${{ steps.urls.outputs.cloudflare_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate credentials
        env:
          CLASPRC_JSON: ${{ secrets.OAUTH_CREDENTIALS }}
        run: |
          echo "ğŸ” Validating OAuth credentials..."

          if [ -z "$CLASPRC_JSON" ]; then
            echo "âŒ ERROR: OAUTH_CREDENTIALS secret not set"
            exit 1
          fi

          # Validate JSON structure
          if ! echo "$CLASPRC_JSON" | jq -e '.token.refresh_token' > /dev/null 2>&1; then
            echo "âŒ ERROR: Invalid OAUTH_CREDENTIALS - missing refresh_token"
            exit 1
          fi

          echo "âœ… Credentials validated"

      - name: Deploy to Apps Script
        id: deploy
        env:
          CLASPRC_JSON: ${{ secrets.OAUTH_CREDENTIALS }}
          DEPLOYMENT_ID: ${{ secrets.DEPLOYMENT_ID }}
        run: |
          echo "ğŸš€ Deploying to Apps Script..."

          # Setup clasp credentials
          echo "$CLASPRC_JSON" > ~/.clasprc.json
          chmod 600 ~/.clasprc.json

          # Push code
          echo "ğŸ“¤ Pushing code..."
          npx clasp push --force

          # Deploy
          echo "ğŸ“¦ Creating deployment..."
          TIMESTAMP=$(date -Iseconds)

          if [ -n "$DEPLOYMENT_ID" ]; then
            DEPLOY_OUTPUT=$(npx clasp deploy -i "$DEPLOYMENT_ID" -d "CI Deploy $TIMESTAMP" 2>&1)
          else
            DEPLOY_OUTPUT=$(npx clasp deploy -d "CI Deploy $TIMESTAMP" 2>&1)
          fi

          echo "$DEPLOY_OUTPUT"

          # Get deployment URL using our reliable script
          echo ""
          echo "ğŸ“ Getting deployment URL..."
          export CLASPRC_JSON
          SCRIPT_URL=$(node scripts/get-deployment-url.js 2>&1 | tail -1)

          if [[ "$SCRIPT_URL" != https://* ]]; then
            echo "âŒ Failed to get deployment URL"
            echo "Output was: $SCRIPT_URL"
            exit 1
          fi

          echo "url=$SCRIPT_URL" >> $GITHUB_OUTPUT

          # Extract deployment ID
          DEPLOY_ID=$(echo "$SCRIPT_URL" | grep -oP 'AKfycb[a-zA-Z0-9_-]+' || echo "")
          echo "deployment_id=$DEPLOY_ID" >> $GITHUB_OUTPUT

          echo ""
          echo "âœ… Deployment complete!"
          echo "   URL: $SCRIPT_URL"

      - name: Update Cloudflare Worker
        if: success()
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DEPLOYMENT_ID: ${{ steps.deploy.outputs.deployment_id }}
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ] || [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "â„¹ï¸ Cloudflare not configured - skipping worker update"
            exit 0
          fi

          echo "â˜ï¸ Updating Cloudflare Worker..."

          # Update wrangler.toml
          sed -i "s/DEPLOYMENT_ID = \"[^\"]*\"/DEPLOYMENT_ID = \"${DEPLOYMENT_ID}\"/" cloudflare-proxy/wrangler.toml

          # Update worker.js default
          sed -i "s/const DEFAULT_DEPLOYMENT_ID = '[^']*'/const DEFAULT_DEPLOYMENT_ID = '${DEPLOYMENT_ID}'/" cloudflare-proxy/worker.js

          # Deploy worker
          npm install -g wrangler
          cd cloudflare-proxy
          wrangler deploy

          echo "âœ… Cloudflare Worker updated"

      - name: Set final URLs
        id: urls
        run: |
          # Use Cloudflare URL for testing (faster, more reliable)
          echo "cloudflare_url=https://www.eventangle.com" >> $GITHUB_OUTPUT

  # ============================================================================
  # STAGE 3: WARMUP (Eliminate Cold Start Flakiness)
  # ============================================================================

  warmup:
    name: "3ï¸âƒ£ Warmup"
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: |
      always() &&
      needs.validate.outputs.validation_passed == 'true' &&
      (needs.deploy.result == 'success' || needs.deploy.result == 'skipped')
    outputs:
      deployment_url: ${{ steps.url.outputs.url }}
      warmup_success: ${{ steps.warmup.outputs.success }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Determine deployment URL
        id: url
        run: |
          # Priority: workflow input > deploy output > default
          if [ -n "${{ inputs.deployment_url }}" ]; then
            URL="${{ inputs.deployment_url }}"
          elif [ -n "${{ needs.deploy.outputs.cloudflare_url }}" ]; then
            URL="${{ needs.deploy.outputs.cloudflare_url }}"
          else
            URL="${{ env.DEFAULT_DEPLOYMENT_URL }}"
          fi

          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "ğŸ“ Deployment URL: $URL"

      - name: Warmup deployment
        id: warmup
        continue-on-error: true
        env:
          BASE_URL: ${{ steps.url.outputs.url }}
          WARMUP_MAX_ATTEMPTS: 5
          WARMUP_TIMEOUT: 60000
        run: |
          echo "ğŸ”¥ Warming up deployment..."
          echo "   This ensures GAS instances are ready before tests run"
          echo ""

          if node scripts/warmup-deployment.js; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âš ï¸ Warmup failed - tests will still run but may experience cold start delays"
          fi

  # ============================================================================
  # STAGE 4A: API TESTS (Always Run First)
  # ============================================================================

  api-tests:
    name: "4ï¸âƒ£ API Tests"
    runs-on: ubuntu-latest
    needs: [validate, warmup]
    # Run if validation passed AND warmup succeeded (or warmup ran but we want to try anyway)
    if: |
      needs.validate.outputs.validation_passed == 'true' &&
      needs.warmup.result == 'success'
    outputs:
      result: ${{ steps.test.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium webkit

      - name: Run API tests
        id: test
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.warmup.outputs.deployment_url }}
          CI: true
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "ğŸ§ª Running API tests..."
          echo "   BASE_URL: $BASE_URL"
          npm run test:api
          if [ $? -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # STAGE 4B: SMOKE TESTS (Only if API passed)
  # ============================================================================

  smoke-tests:
    name: "4ï¸âƒ£ Smoke Tests"
    runs-on: ubuntu-latest
    needs: [warmup, api-tests]
    if: needs.api-tests.outputs.result == 'success'
    outputs:
      result: ${{ steps.test.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium webkit

      - name: Run Smoke tests
        id: test
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.warmup.outputs.deployment_url }}
          CI: true
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "ğŸ§ª Running Smoke tests..."
          echo "   BASE_URL: $BASE_URL"
          npm run test:smoke
          if [ $? -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # STAGE 4C: EXPENSIVE TESTS (Only if Smoke passed)
  # ============================================================================

  expensive-tests:
    name: "4ï¸âƒ£ Expensive - ${{ matrix.suite }}"
    runs-on: ubuntu-latest
    needs: [warmup, smoke-tests]
    if: needs.smoke-tests.outputs.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        suite: [flows, pages]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium webkit

      - name: Run ${{ matrix.suite }} tests
        env:
          BASE_URL: ${{ needs.warmup.outputs.deployment_url }}
          CI: true
          ADMIN_KEY: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ROOT: ${{ secrets.ADMIN_KEY_ROOT }}
          ADMIN_KEY_ABC: ${{ secrets.ADMIN_KEY_ABC }}
          ADMIN_KEY_CBC: ${{ secrets.ADMIN_KEY_CBC }}
          ADMIN_KEY_CBL: ${{ secrets.ADMIN_KEY_CBL }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SPREADSHEET_ID_ROOT: ${{ secrets.SPREADSHEET_ID_ROOT }}
          SPREADSHEET_ID_ABC: ${{ secrets.SPREADSHEET_ID_ABC }}
          SPREADSHEET_ID_CBC: ${{ secrets.SPREADSHEET_ID_CBC }}
          SPREADSHEET_ID_CBL: ${{ secrets.SPREADSHEET_ID_CBL }}
        run: |
          echo "ğŸ§ª Running ${{ matrix.suite }} tests..."
          npm run test:${{ matrix.suite }}

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.suite }}-test-report
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # STAGE 5: QUALITY GATE
  # ============================================================================

  quality-gate:
    name: "5ï¸âƒ£ Quality Gate"
    runs-on: ubuntu-latest
    needs: [validate, warmup, api-tests, smoke-tests, expensive-tests]
    if: always()
    steps:
      - name: Evaluate results
        run: |
          echo "ğŸ“Š Quality Gate Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Job Results:"
          echo "  Validate:       ${{ needs.validate.result }}"
          echo "  Warmup:         ${{ needs.warmup.result }}"
          echo "  API Tests:      ${{ needs.api-tests.result }}"
          echo "  Smoke Tests:    ${{ needs.smoke-tests.result }}"
          echo "  Expensive:      ${{ needs.expensive-tests.result }}"
          echo ""
          echo "Test Outputs:"
          echo "  Validation:     ${{ needs.validate.outputs.validation_passed }}"
          echo "  Warmup Success: ${{ needs.warmup.outputs.warmup_success }}"
          echo "  API Result:     ${{ needs.api-tests.outputs.result }}"
          echo "  Smoke Result:   ${{ needs.smoke-tests.outputs.result }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Track failures
          FAILED=false

          # 1. Validation must pass
          if [[ "${{ needs.validate.result }}" != "success" ]]; then
            echo "âŒ FAILED: Validation job failed"
            FAILED=true
          fi

          # 2. Warmup job must complete (even if warmup itself failed, we still run tests)
          if [[ "${{ needs.warmup.result }}" != "success" ]]; then
            echo "âŒ FAILED: Warmup job failed"
            FAILED=true
          fi

          # 3. API tests must pass (if they ran)
          API_RESULT="${{ needs.api-tests.result }}"
          if [[ "$API_RESULT" == "failure" ]]; then
            echo "âŒ FAILED: API tests failed"
            FAILED=true
          elif [[ "$API_RESULT" == "skipped" ]]; then
            echo "â­ï¸ SKIPPED: API tests were skipped"
            # Skipped is OK if validation failed (expected cascade)
            if [[ "${{ needs.validate.result }}" == "success" && "${{ needs.warmup.result }}" == "success" ]]; then
              echo "âŒ FAILED: API tests were unexpectedly skipped"
              FAILED=true
            fi
          fi

          # 4. Smoke tests must pass (if they ran)
          SMOKE_RESULT="${{ needs.smoke-tests.result }}"
          if [[ "$SMOKE_RESULT" == "failure" ]]; then
            echo "âŒ FAILED: Smoke tests failed"
            FAILED=true
          fi

          # 5. Expensive tests must pass (if they ran)
          EXPENSIVE_RESULT="${{ needs.expensive-tests.result }}"
          if [[ "$EXPENSIVE_RESULT" == "failure" ]]; then
            echo "âŒ FAILED: Expensive tests failed"
            FAILED=true
          fi

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [[ "$FAILED" == "true" ]]; then
            echo "âŒ QUALITY GATE FAILED"
            exit 1
          fi

          echo "âœ… QUALITY GATE PASSED!"
          echo ""
          echo "Deployment URL: ${{ needs.warmup.outputs.deployment_url }}"
